name: ğŸ“‹ GitHub Projects ìë™í™”

on:
  issues:
    types: [opened, closed, reopened]
  pull_request:
    types: [opened, closed, review_requested]
  issue_comment:
    types: [created]
  schedule:
    - cron: '0 9 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ

jobs:
  # ì´ìŠˆ ìƒì„± ì‹œ í”„ë¡œì íŠ¸ì— ìë™ ì¶”ê°€
  add-to-project:
    name: ğŸ“Œ í”„ë¡œì íŠ¸ì— ì¶”ê°€
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    
    steps:
    - name: ğŸ“‹ ì´ìŠˆë¥¼ í”„ë¡œì íŠ¸ì— ì¶”ê°€
      uses: actions/add-to-project@v0.4.0
      with:
        project-url: https://github.com/orgs/Salesforce-Sales-B2B-Socar/projects/1
        github-token: ${{ secrets.GITHUB_TOKEN }}

  # PR ìƒíƒœì— ë”°ë¥¸ ìë™ ì´ë™
  update-pr-status:
    name: ğŸ”„ PR ìƒíƒœ ì—…ë°ì´íŠ¸
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“ PR ìƒì„± ì‹œ "In Review"ë¡œ ì´ë™
      if: github.event.action == 'opened'
      uses: alex-page/github-project-automation-plus@v0.8.3
      with:
        project: https://github.com/orgs/Salesforce-Sales-B2B-Socar/projects/1
        column: In Review
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: âœ… PR ë¨¸ì§€ ì‹œ "Done"ìœ¼ë¡œ ì´ë™
      if: github.event.action == 'closed' && github.event.pull_request.merged == true
      uses: alex-page/github-project-automation-plus@v0.8.3
      with:
        project: https://github.com/orgs/Salesforce-Sales-B2B-Socar/projects/1
        column: Done
        repo-token: ${{ secrets.GITHUB_TOKEN }}

  # ì´ìŠˆ ë¼ë²¨ì— ë”°ë¥¸ ìë™ ë¶„ë¥˜
  auto-triage:
    name: ğŸ·ï¸ ìë™ ë¼ë²¨ë§
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' && github.event_name == 'issues'
    
    steps:
    - name: ğŸ¤– Agentforce ê´€ë ¨ ì´ìŠˆ ë¼ë²¨ë§
      if: contains(github.event.issue.title, '[AGENTFORCE]') || contains(github.event.issue.body, 'agentforce') || contains(github.event.issue.body, 'Agentforce')
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['component: agentforce', 'area: ai']
          })
          
    - name: ğŸ› ë²„ê·¸ ì´ìŠˆ ìš°ì„ ìˆœìœ„ ì„¤ì •
      if: contains(github.event.issue.title, '[BUG]')
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['priority: high']
          })

  # ì˜¤ë˜ëœ ì´ìŠˆ ì •ë¦¬
  stale-issues:
    name: ğŸ§¹ ì˜¤ë˜ëœ ì´ìŠˆ ì •ë¦¬
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: ğŸ·ï¸ ì˜¤ë˜ëœ ì´ìŠˆì— stale ë¼ë²¨ ì¶”ê°€
      uses: actions/stale@v8
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        stale-issue-message: |
          ğŸ• ì´ ì´ìŠˆê°€ 30ì¼ ë™ì•ˆ í™œë™ì´ ì—†ì—ˆìŠµë‹ˆë‹¤. 
          
          ì—¬ì „íˆ ìœ íš¨í•œ ì´ìŠˆë¼ë©´ ëŒ“ê¸€ì„ ë‹¬ì•„ ì£¼ì„¸ìš”. 
          7ì¼ í›„ì—ë„ í™œë™ì´ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.
          
          **Vibe Coding Tip**: ë•Œë¡œëŠ” ì ì‹œ ì‰¬ì–´ê°€ëŠ” ê²ƒë„ ì¢‹ì€ ì „ëµì…ë‹ˆë‹¤! ğŸŒ±
        close-issue-message: |
          ğŸ”’ í™œë™ì´ ì—†ì–´ì„œ ì´ ì´ìŠˆë¥¼ ìë™ìœ¼ë¡œ ë‹«ìŠµë‹ˆë‹¤.
          
          í•„ìš”í•˜ë‹¤ë©´ ì–¸ì œë“ ì§€ ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”!
        stale-issue-label: 'status: stale'
        days-before-stale: 30
        days-before-close: 7
        exempt-issue-labels: 'priority: critical,type: bug,status: blocked'

  # ì£¼ê°„ í”„ë¡œì íŠ¸ ìƒíƒœ ë¦¬í¬íŠ¸
  weekly-report:
    name: ğŸ“Š ì£¼ê°„ ìƒíƒœ ë¦¬í¬íŠ¸
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: ğŸ“ˆ í”„ë¡œì íŠ¸ í†µê³„ ìƒì„±
      uses: actions/github-script@v6
      with:
        script: |
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'all',
            since: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
          });
          
          const stats = {
            created: issues.filter(i => new Date(i.created_at) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)).length,
            closed: issues.filter(i => i.state === 'closed' && new Date(i.closed_at) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)).length,
            bugs: issues.filter(i => i.labels.some(l => l.name === 'type: bug')).length,
            features: issues.filter(i => i.labels.some(l => l.name === 'type: feature')).length,
            agentforce: issues.filter(i => i.labels.some(l => l.name === 'type: agentforce')).length
          };
          
          console.log('ğŸ“Š ì£¼ê°„ SOCAR B2B í”„ë¡œì íŠ¸ í˜„í™©:');
          console.log(`ğŸ†• ìƒˆë¡œìš´ ì´ìŠˆ: ${stats.created}ê°œ`);
          console.log(`âœ… ì™„ë£Œëœ ì´ìŠˆ: ${stats.closed}ê°œ`);
          console.log(`ğŸ› ë²„ê·¸ ì´ìŠˆ: ${stats.bugs}ê°œ`);
          console.log(`ğŸ†• ê¸°ëŠ¥ ìš”ì²­: ${stats.features}ê°œ`);
          console.log(`ğŸ¤– Agentforce ê´€ë ¨: ${stats.agentforce}ê°œ`);
