/**
 * Draft ìƒíƒœì´ì§€ë§Œ Order Productsê°€ ìˆëŠ” Orderë“¤ì„ ì¼ê´„ í™œì„±í™”í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸
 * Developer Console > Debug > Open Execute Anonymous Windowì—ì„œ ì‹¤í–‰
 */

System.debug('ğŸš€ =====Draft Order ì¼ê´„ í™œì„±í™” ì‹œì‘=====');

try {
    // 1. Draft ìƒíƒœì´ì§€ë§Œ Order Productsê°€ ìˆëŠ” Order ì¡°íšŒ
    List<Order> draftOrdersWithProducts = [
        SELECT Id, OrderNumber, TotalAmount, Status
        FROM Order 
        WHERE Status = 'Draft'
        AND TotalAmount > 0
        AND Id IN (SELECT OrderId FROM OrderItem WHERE OrderId != null)
    ];
    
    System.debug('ğŸ“Š í™œì„±í™” ëŒ€ìƒ Order ê°œìˆ˜: ' + draftOrdersWithProducts.size());
    
    if (draftOrdersWithProducts.isEmpty()) {
        System.debug('âœ… í™œì„±í™”ê°€ í•„ìš”í•œ Draft Orderê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ìƒì„¸ í˜„í™© ì¶œë ¥
    System.debug('ğŸ“‹ í™œì„±í™” ëŒ€ìƒ Order ëª©ë¡:');
    for (Order ord : draftOrdersWithProducts) {
        System.debug('   - ' + ord.OrderNumber + ' (Amount: â‚©' + ord.TotalAmount + ')');
    }
    
    // 2. Order ìƒíƒœë¥¼ Draft â†’ Activatedë¡œ ë³€ê²½
    System.debug('');
    System.debug('ğŸ”„ Order ìƒíƒœ ë³€ê²½ ì¤‘...');
    
    List<Order> ordersToUpdate = new List<Order>();
    
    for (Order ord : draftOrdersWithProducts) {
        Order orderToUpdate = new Order();
        orderToUpdate.Id = ord.Id;
        orderToUpdate.Status = 'Activated';
        ordersToUpdate.add(orderToUpdate);
    }
    
    // ì¼ê´„ ì—…ë°ì´íŠ¸ ì‹¤í–‰
    update ordersToUpdate;
    
    System.debug('âœ… Order ìƒíƒœ ë³€ê²½ ì™„ë£Œ: ' + ordersToUpdate.size() + 'ê°œ');
    
    // 3. ë³€ê²½ ê²°ê³¼ í™•ì¸
    List<Order> updatedOrders = [
        SELECT Id, OrderNumber, Status, TotalAmount
        FROM Order 
        WHERE Id IN :ordersToUpdate
    ];
    
    System.debug('');
    System.debug('ğŸ“‹ ë³€ê²½ ê²°ê³¼:');
    for (Order ord : updatedOrders) {
        System.debug('   âœ… ' + ord.OrderNumber + ': ' + ord.Status + ' (â‚©' + ord.TotalAmount + ')');
    }
    
    // 4. ì „ì²´ í˜„í™© í™•ì¸
    List<Order> remainingDraftOrders = [
        SELECT Id, OrderNumber
        FROM Order 
        WHERE Status = 'Draft'
        AND TotalAmount > 0
        AND Id IN (SELECT OrderId FROM OrderItem WHERE OrderId != null)
    ];
    
    System.debug('');
    System.debug('ğŸ“Š ìµœì¢… í˜„í™©:');
    System.debug('   í™œì„±í™” ì™„ë£Œ: ' + ordersToUpdate.size() + 'ê°œ');
    System.debug('   ë‚¨ì€ Draft Order: ' + remainingDraftOrders.size() + 'ê°œ');
    
    if (remainingDraftOrders.isEmpty()) {
        System.debug('âœ… ëª¨ë“  í•´ë‹¹ Orderê°€ ì„±ê³µì ìœ¼ë¡œ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
        System.debug('âš ï¸ ì¼ë¶€ Orderê°€ ì—¬ì „íˆ Draft ìƒíƒœì…ë‹ˆë‹¤:');
        for (Order ord : remainingDraftOrders) {
            System.debug('   - ' + ord.OrderNumber);
        }
    }
    
    System.debug('');
    System.debug('ğŸ” í™•ì¸ì‚¬í•­:');
    System.debug('1. ê° Order í˜ì´ì§€ì—ì„œ Statusê°€ Activatedë¡œ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸');
    System.debug('2. ë‚©ë¶€ ì¼ì • íƒ€ì„ë¼ì¸ì´ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸');
    System.debug('3. PaymentStatus ê´€ë ¨ ìë™í™”ê°€ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸');
    
} catch (Exception e) {
    System.debug('âŒ ì¼ê´„ í™œì„±í™” ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}

System.debug('ğŸš€ =====Draft Order ì¼ê´„ í™œì„±í™” ì™„ë£Œ=====');
