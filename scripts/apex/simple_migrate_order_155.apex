/**
 * Order 00000155 ê°„ì†Œí™” ë§ˆì´ê·¸ë ˆì´ì…˜ (ì˜¤ë¥˜ ì—†ëŠ” ë²„ì „)
 * í‘œì¤€ ì˜¤ë¸Œì íŠ¸ë§Œ ì‚¬ìš©í•˜ì—¬ ì•ˆì „í•œ ë°°í¬
 */

System.debug('=== ğŸš€ Order 00000155 ê°„ì†Œí™” ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘ ===');

try {
    // 1. Order ì •ë³´ ì¡°íšŒ
    List<Order> orders = [
        SELECT Id, Name, OrderNumber, Status, OwnerId, AccountId
        FROM Order 
        WHERE OrderNumber = '00000155'
        LIMIT 1
    ];
    
    if(orders.isEmpty()) {
        System.debug('âŒ Order 00000155ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Order order155 = orders[0];
    System.debug('ğŸ“‹ Order ì •ë³´: ' + order155.OrderNumber + ' (ID: ' + order155.Id + ')');
    
    // 2. ê¸°ì¡´ Salesforce ì±„ë„ í™•ì¸
    List<CollaborationGroup> existingChannels = [
        SELECT Id, Name, Description, MemberCount, CreatedDate
        FROM CollaborationGroup 
        WHERE Name LIKE '%00000155%'
    ];
    
    System.debug('=== ğŸ” ê¸°ì¡´ ì±„ë„ í™•ì¸ ===');
    System.debug('ë°œê²¬ëœ ì±„ë„ ìˆ˜: ' + existingChannels.size());
    
    String channelId;
    String channelName = 'Order-00000155-Channel';
    
    if(!existingChannels.isEmpty()) {
        channelId = existingChannels[0].Id;
        System.debug('âœ… ê¸°ì¡´ ì±„ë„ ì‚¬ìš©: ' + existingChannels[0].Name + ' (ID: ' + channelId + ')');
    } else {
        // 3. ìƒˆ ì±„ë„ ìƒì„±
        System.debug('=== ğŸ—ï¸ ìƒˆ ì±„ë„ ìƒì„± ===');
        
        CollaborationGroup newChannel = new CollaborationGroup();
        newChannel.Name = channelName;
        newChannel.Description = 'Order 00000155 ì „ìš© í˜‘ì—… ì±„ë„\n' +
                               'ìƒì„±ì¼: ' + System.now().format('yyyy-MM-dd HH:mm') + '\n' +
                               'Order ID: ' + order155.Id + '\n' +
                               'ìƒíƒœ: Slackì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ';
        newChannel.CollaborationType = 'Private';
        newChannel.IsArchived = false;
        newChannel.CanHaveGuests = false;
        
        insert newChannel;
        channelId = newChannel.Id;
        
        System.debug('âœ… ìƒˆ ì±„ë„ ìƒì„± ì™„ë£Œ: ' + channelId);
        
        // 4. ë©¤ë²„ ì¶”ê°€
        List<CollaborationGroupMember> members = new List<CollaborationGroupMember>();
        
        // Order Owner ì¶”ê°€
        CollaborationGroupMember ownerMember = new CollaborationGroupMember();
        ownerMember.CollaborationGroupId = channelId;
        ownerMember.MemberId = order155.OwnerId;
        ownerMember.CollaborationRole = 'Admin';
        members.add(ownerMember);
        
        // í˜„ì¬ ì‚¬ìš©ì ì¶”ê°€ (ë‹¤ë¥¸ ì‚¬ìš©ìì¸ ê²½ìš°)
        if(UserInfo.getUserId() != order155.OwnerId) {
            CollaborationGroupMember currentUserMember = new CollaborationGroupMember();
            currentUserMember.CollaborationGroupId = channelId;
            currentUserMember.MemberId = UserInfo.getUserId();
            currentUserMember.CollaborationRole = 'Standard';
            members.add(currentUserMember);
        }
        
        insert members;
        System.debug('âœ… ë©¤ë²„ ì¶”ê°€ ì™„ë£Œ: ' + members.size() + 'ëª…');
    }
    
    // 5. ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ ë©”ì‹œì§€
    String migrationMessage = 'ğŸ‰ Order 00000155 Salesforce ì±„ë„ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!\n\n';
    migrationMessage += 'ğŸ“… ì™„ë£Œ ë‚ ì§œ: ' + System.now().format('yyyy-MM-dd HH:mm') + '\n';
    migrationMessage += 'ğŸ“‹ Order: ' + order155.OrderNumber + '\n';
    migrationMessage += 'ğŸ†” Order ID: ' + order155.Id + '\n\n';
    migrationMessage += 'âœ¨ ìƒˆë¡œìš´ Salesforce ì±„ë„ ê¸°ëŠ¥:\n';
    migrationMessage += 'â€¢ ğŸ“± ëª¨ë°”ì¼ ì•±ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥\n';
    migrationMessage += 'â€¢ ğŸ”” ì‹¤ì‹œê°„ @ë©˜ì…˜ ì•Œë¦¼\n';
    migrationMessage += 'â€¢ ğŸ“„ íŒŒì¼ ê³µìœ  ë° í˜‘ì—…\n';
    migrationMessage += 'â€¢ ğŸ¤– Order ì—…ë°ì´íŠ¸ ìë™ ì—°ë™\n';
    migrationMessage += 'â€¢ ğŸš€ ì™¸ë¶€ ì˜ì¡´ì„± ì—†ëŠ” ì•ˆì „í•œ í˜‘ì—…\n\n';
    migrationMessage += 'ğŸ”— Order ë°”ë¡œê°€ê¸°: ' + System.URL.getOrgDomainUrl().toExternalForm() + 
                       '/lightning/r/Order/' + order155.Id + '/view\n\n';
    migrationMessage += '#ë§ˆì´ê·¸ë ˆì´ì…˜ì™„ë£Œ #Order00000155 #SalesforceChannels #ì•ˆì „í•œí˜‘ì—…';
    
    FeedItem migrationPost = new FeedItem();
    migrationPost.ParentId = channelId;
    migrationPost.Body = migrationMessage;
    migrationPost.Type = 'TextPost';
    
    insert migrationPost;
    System.debug('âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ ë©”ì‹œì§€ ê²Œì‹œ');
    
    // 6. Task ìƒì„± (ì•Œë¦¼ í…ŒìŠ¤íŠ¸ìš©)
    Task migrationTask = new Task();
    migrationTask.Subject = 'ì±„ë„ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ í™•ì¸';
    migrationTask.Description = 'Order 00000155ì˜ Salesforce ì±„ë„ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. íŒ€ì›ë“¤ì—ê²Œ ìƒˆ ì±„ë„ ì‚¬ìš© ë°©ë²•ì„ ì•ˆë‚´í•˜ì„¸ìš”.';
    migrationTask.WhatId = order155.Id;
    migrationTask.OwnerId = order155.OwnerId;
    migrationTask.Priority = 'High';
    migrationTask.Status = 'Not Started';
    migrationTask.ActivityDate = Date.today().addDays(1);
    
    insert migrationTask;
    System.debug('âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ í™•ì¸ Task ìƒì„±: ' + migrationTask.Id);
    
    // 7. ì±„ë„ ì•Œë¦¼ í…ŒìŠ¤íŠ¸
    try {
        ChannelNotificationService.processTaskNotification(migrationTask);
    } catch(Exception notificationError) {
        System.debug('âš ï¸ ì±„ë„ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ìŠ¤í‚µ (ChannelNotificationService ë°°í¬ í•„ìš”): ' + notificationError.getMessage());
    }
    
    // 8. ìµœì¢… ê²°ê³¼
    System.debug('=== ğŸ‰ ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µ! ===');
    System.debug('Order: 00000155');
    System.debug('Salesforce ì±„ë„: ' + channelName);
    System.debug('ì±„ë„ ID: ' + channelId);
    System.debug('ìƒíƒœ: ì™„ì „ ì „í™˜ ì™„ë£Œ');
    
    System.debug('\n=== ğŸ“± Sales ì•±ì—ì„œ í™•ì¸í•˜ê¸° ===');
    System.debug('1. Sales ì•± â†’ Chatter â†’ ê·¸ë£¹');
    System.debug('2. ê²€ìƒ‰: "' + channelName + '"');
    System.debug('3. ì§ì ‘ URL: /lightning/r/CollaborationGroup/' + channelId + '/view');
    System.debug('4. Order ë ˆì½”ë“œ â†’ Related â†’ Chatter í™•ì¸');
    
    System.debug('\n=== ğŸ”¥ ë‹¤ìŒ ë‹¨ê³„ ===');
    System.debug('1. íŒ€ì›ë“¤ì„ ì±„ë„ì— ì´ˆëŒ€');
    System.debug('2. ì±„ë„ì—ì„œ @ë©˜ì…˜ í…ŒìŠ¤íŠ¸');
    System.debug('3. íŒŒì¼ ê³µìœ  ê¸°ëŠ¥ í™•ì¸');
    System.debug('4. ëª¨ë°”ì¼ ì•±ì—ì„œ ì ‘ê·¼ í…ŒìŠ¤íŠ¸');
    
} catch(Exception e) {
    System.debug('âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
    
    System.debug('\n=== ğŸ”§ ë¬¸ì œ í•´ê²° ===');
    System.debug('1. Order 00000155 ì¡´ì¬ í™•ì¸');
    System.debug('2. Chatter ê¶Œí•œ í™•ì¸');
    System.debug('3. CollaborationGroup ìƒì„± ê¶Œí•œ í™•ì¸');
}

System.debug('\n=== âœ… ê°„ì†Œí™” ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ ===');
