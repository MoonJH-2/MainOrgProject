// Order 00000151 Sales ì•± ì•Œë¦¼ ë¬¸ì œ ë¶„ì„ ìŠ¤í¬ë¦½íŠ¸
System.debug('ğŸ” =====Order 00000151 ì•Œë¦¼ ë¬¸ì œ ë¶„ì„=====');

try {
    // 1. Order 00000151 ìƒì„¸ ì •ë³´ ì¡°íšŒ
    List<Order> orders = [
        SELECT Id, OrderNumber, Status, TotalAmount, EffectiveDate,
               AccountId, Account.Name, OwnerId, Owner.Name, Owner.Email,
               Slack_Channel_Name__c, Slack_Notification_Status__c,
               CreatedDate, CreatedById, CreatedBy.Name,
               LastModifiedDate, LastModifiedById, LastModifiedBy.Name,
               ActivatedDate, ActivatedById, ActivatedBy.Name
        FROM Order 
        WHERE OrderNumber = '00000151'
        LIMIT 1
    ];
    
    if (orders.isEmpty()) {
        System.debug('âŒ Order 00000151ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Order order = orders[0];
    System.debug('');
    System.debug('ğŸ“‹ Order 00000151 ê¸°ë³¸ ì •ë³´:');
    System.debug('   ID: ' + order.Id);
    System.debug('   OrderNumber: ' + order.OrderNumber);
    System.debug('   Status: ' + order.Status);
    System.debug('   Account: ' + order.Account.Name);
    System.debug('   Owner: ' + order.Owner.Name);
    System.debug('   Total Amount: â‚©' + order.TotalAmount.format());
    System.debug('   Created: ' + order.CreatedDate + ' by ' + order.CreatedBy.Name);
    System.debug('   Activated: ' + order.ActivatedDate + ' by ' + order.ActivatedBy.Name);
    System.debug('   Slack Channel: ' + order.Slack_Channel_Name__c);
    System.debug('   Slack Status: ' + order.Slack_Notification_Status__c);
    
    // 2. CustomNotificationType ì„¤ì • í™•ì¸
    System.debug('');
    System.debug('ğŸ”§ CustomNotificationType ì„¤ì • í™•ì¸:');
    
    List<CustomNotificationType> salesTypes = [
        SELECT Id, DeveloperName, MasterLabel, Description
        FROM CustomNotificationType
        WHERE DeveloperName = 'Sales_Order_Notification'
        LIMIT 1
    ];
    
    if (salesTypes.isEmpty()) {
        System.debug('âŒ Sales_Order_Notificationì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
        System.debug('   ì´ê²ƒì´ ì•Œë¦¼ì´ ì˜¤ì§€ ì•ŠëŠ” ì£¼ìš” ì›ì¸ì…ë‹ˆë‹¤.');
        System.debug('   Setup > Custom Notification Typesì—ì„œ ìƒì„± í•„ìš”');
        
        // ì¦‰ì‹œ í•´ê²°ì„ ìœ„í•œ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë°œì†¡ ì‹œë„
        System.debug('');
        System.debug('ğŸ§ª ëŒ€ì•ˆ: ê¸°ì¡´ CustomNotificationTypeìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë°œì†¡');
        
        List<CustomNotificationType> existingTypes = [
            SELECT Id, DeveloperName, MasterLabel
            FROM CustomNotificationType
            LIMIT 5
        ];
        
        System.debug('   ì‚¬ìš© ê°€ëŠ¥í•œ CustomNotificationType: ' + existingTypes.size() + 'ê°œ');
        for (CustomNotificationType type : existingTypes) {
            System.debug('     â€¢ ' + type.MasterLabel + ' (' + type.DeveloperName + ')');
        }
        
        return;
    }
    
    CustomNotificationType salesType = salesTypes[0];
    System.debug('âœ… Sales_Order_Notification ì„¤ì •ë¨: ' + salesType.MasterLabel);
    
    // 3. OrderTriggerHandler ë™ì‘ í™•ì¸
    System.debug('');
    System.debug('ğŸ”„ OrderTriggerHandler ë™ì‘ ë¶„ì„:');
    
    // Order ìƒì„± ì‹œì ê³¼ í™œì„±í™” ì‹œì  í™•ì¸
    Datetime createdTime = order.CreatedDate;
    Datetime activatedTime = order.ActivatedDate;
    
    System.debug('   ìƒì„± ì‹œê°„: ' + createdTime.format());
    System.debug('   í™œì„±í™” ì‹œê°„: ' + activatedTime.format());
    
    Long timeDiff = activatedTime.getTime() - createdTime.getTime();
    Long secondsDiff = timeDiff / 1000;
    
    System.debug('   ìƒì„±â†’í™œì„±í™” ê°„ê²©: ' + secondsDiff + 'ì´ˆ');
    
    if (secondsDiff < 5) {
        System.debug('   âš ï¸ ìƒì„±ê³¼ í™œì„±í™”ê°€ ê±°ì˜ ë™ì‹œì— ë°œìƒ (íŠ¸ë¦¬ê±° ì¤‘ë³µ ê°€ëŠ¥ì„±)');
    }
    
    // 4. ì•Œë¦¼ ìˆ˜ì‹ ì í™•ì¸
    System.debug('');
    System.debug('ğŸ‘¥ ì•Œë¦¼ ìˆ˜ì‹ ì ë¶„ì„:');
    
    User currentUser = [
        SELECT Id, Name, Email, ManagerId, Manager.Name, Manager.Email
        FROM User 
        WHERE Id = :UserInfo.getUserId()
    ];
    
    Set<String> expectedRecipients = new Set<String>();
    expectedRecipients.add(order.OwnerId);
    expectedRecipients.add(order.CreatedById);
    expectedRecipients.add(UserInfo.getUserId());
    
    if (currentUser.ManagerId != null) {
        expectedRecipients.add(currentUser.ManagerId);
    }
    
    System.debug('   Order Owner: ' + order.Owner.Name + ' (' + order.Owner.Email + ')');
    System.debug('   Order Creator: ' + order.CreatedBy.Name);
    System.debug('   í˜„ì¬ ì‚¬ìš©ì: ' + currentUser.Name);
    if (currentUser.ManagerId != null) {
        System.debug('   Manager: ' + currentUser.Manager.Name);
    }
    System.debug('   ì˜ˆìƒ ìˆ˜ì‹ ì ìˆ˜: ' + expectedRecipients.size() + 'ëª…');
    
    // 5. PaymentStatus ì—°ì²´ ìƒí™© í™•ì¸
    System.debug('');
    System.debug('ğŸ’° PaymentStatus ì—°ì²´ ìƒí™©:');
    
    List<PaymentStatus__c> payments = [
        SELECT Id, InstallmentNumber__c, Amount__c, DueDate__c, Status__c,
               CreatedDate, LastModifiedDate
        FROM PaymentStatus__c 
        WHERE Order__c = :order.Id
        ORDER BY InstallmentNumber__c ASC
    ];
    
    Integer overdueCount = 0;
    for (PaymentStatus__c payment : payments) {
        String statusIcon = payment.Status__c == 'ì—°ì²´' ? 'ğŸš¨' : 
                           payment.Status__c == 'ì™„ë‚©' ? 'âœ…' : 'â³';
        
        System.debug('   ' + statusIcon + ' ' + payment.InstallmentNumber__c + 'ì°¨: ' + 
                    payment.Status__c + ' (due: ' + payment.DueDate__c.format() + ')');
        
        if (payment.Status__c == 'ì—°ì²´') {
            overdueCount++;
        }
    }
    
    System.debug('   ğŸ“Š í˜„ì¬ ì—°ì²´ ê±´ìˆ˜: ' + overdueCount + 'ê±´');
    
    // 6. ì‹¤ì œ ì•Œë¦¼ ë°œì†¡ í…ŒìŠ¤íŠ¸
    System.debug('');
    System.debug('ğŸš€ ì‹¤ì œ ì•Œë¦¼ ë°œì†¡ í…ŒìŠ¤íŠ¸:');
    
    try {
        // Order ìƒì„± ì•Œë¦¼ ìˆ˜ë™ ë°œì†¡
        String title = 'ğŸ‰ ìƒˆ ì£¼ë¬¸ ìƒì„± (ìˆ˜ë™ í…ŒìŠ¤íŠ¸)';
        String body = order.Account.Name + ' - Order ' + order.OrderNumber + 
                     ' (â‚©' + order.TotalAmount.format() + ')';
        
        Messaging.CustomNotification notification = new Messaging.CustomNotification();
        notification.setTitle(title);
        notification.setBody(body);
        notification.setNotificationTypeId(salesType.Id);
        notification.setTargetId(order.Id);
        notification.send(expectedRecipients);
        
        System.debug('âœ… ìˆ˜ë™ ì•Œë¦¼ ë°œì†¡ ì„±ê³µ');
        System.debug('   ì œëª©: ' + title);
        System.debug('   ë‚´ìš©: ' + body);
        System.debug('   ìˆ˜ì‹ ì: ' + expectedRecipients.size() + 'ëª…');
        
    } catch (Exception notifEx) {
        System.debug('âŒ ìˆ˜ë™ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨: ' + notifEx.getMessage());
    }
    
    // 7. OrderTriggerHandler ìˆ˜ë™ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
    System.debug('');
    System.debug('ğŸ”„ OrderTriggerHandler ìˆ˜ë™ í…ŒìŠ¤íŠ¸:');
    
    try {
        List<Order> testOrderList = new List<Order>{order};
        OrderNotificationService.notifyOrderCreated(testOrderList);
        System.debug('âœ… OrderNotificationService.notifyOrderCreated() ìˆ˜ë™ ì‹¤í–‰ ì™„ë£Œ');
        
    } catch (Exception triggerEx) {
        System.debug('âŒ OrderTriggerHandler ìˆ˜ë™ ì‹¤í–‰ ì‹¤íŒ¨: ' + triggerEx.getMessage());
    }
    
    // 8. Slack ì±„ë„ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ (í•´ë‹¹ë˜ëŠ” ê²½ìš°)
    if (String.isNotBlank(order.Slack_Channel_Name__c)) {
        System.debug('');
        System.debug('ğŸ“¢ Slack ì±„ë„ ì•Œë¦¼ í…ŒìŠ¤íŠ¸:');
        
        try {
            // Slack_Notification_Status__cë¥¼ 'Created'ë¡œ ì„¤ì •
            Order updateOrder = new Order(Id = order.Id);
            updateOrder.Slack_Notification_Status__c = 'Created';
            update updateOrder;
            
            System.debug('âœ… Slack_Notification_Status__cë¥¼ Createdë¡œ ì—…ë°ì´íŠ¸');
            
            List<Order> slackTestList = new List<Order>{updateOrder};
            OrderNotificationService.notifySlackChannelCreated(slackTestList);
            System.debug('âœ… Slack ì±„ë„ ìƒì„± ì•Œë¦¼ ìˆ˜ë™ ì‹¤í–‰ ì™„ë£Œ');
            
        } catch (Exception slackEx) {
            System.debug('âŒ Slack ì±„ë„ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + slackEx.getMessage());
        }
    }
    
    // 9. ë¬¸ì œ ì§„ë‹¨ ë° í•´ê²°ë°©ì•ˆ
    System.debug('');
    System.debug('ğŸ” ë¬¸ì œ ì§„ë‹¨ ê²°ê³¼:');
    
    if (salesTypes.isEmpty()) {
        System.debug('âŒ ì£¼ìš” ë¬¸ì œ: CustomNotificationType ë¯¸ì„¤ì •');
        System.debug('   í•´ê²°ë°©ì•ˆ: Setupì—ì„œ Sales_Order_Notification ìƒì„±');
    } else if (secondsDiff < 5) {
        System.debug('âš ï¸ ì˜ì‹¬ ë¬¸ì œ: ìƒì„±ê³¼ í™œì„±í™”ê°€ ê±°ì˜ ë™ì‹œ ë°œìƒ');
        System.debug('   í•´ê²°ë°©ì•ˆ: íŠ¸ë¦¬ê±° ë¡œì§ ê°œì„  í•„ìš”');
    } else {
        System.debug('âœ… ê¸°ë³¸ ì„¤ì •ì€ ì •ìƒì ì„');
        System.debug('   ì¶”ê°€ í™•ì¸: ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ, ì‚¬ìš©ì ê¶Œí•œ');
    }
    
    // 10. ì¦‰ì‹œ í™•ì¸ ë°©ë²•
    System.debug('');
    System.debug('ğŸ”” ì§€ê¸ˆ ì¦‰ì‹œ í™•ì¸:');
    System.debug('1. Salesforce ìƒë‹¨ ğŸ”” ë²¨ ì•„ì´ì½˜ í´ë¦­');
    System.debug('2. ë°©ê¸ˆ ë°œì†¡ëœ "ğŸ‰ ìƒˆ ì£¼ë¬¸ ìƒì„± (ìˆ˜ë™ í…ŒìŠ¤íŠ¸)" ì•Œë¦¼ í™•ì¸');
    System.debug('3. ì•Œë¦¼ì´ ë³´ì´ë©´ ì‹œìŠ¤í…œì€ ì •ìƒ, íŠ¸ë¦¬ê±° ë¬¸ì œ');
    System.debug('4. ì•Œë¦¼ì´ ì•ˆ ë³´ì´ë©´ CustomNotificationType ì„¤ì • ë¬¸ì œ');
    
} catch (Exception e) {
    System.debug('âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('   íƒ€ì…: ' + e.getTypeName());
    System.debug('   ë¼ì¸: ' + e.getLineNumber());
    System.debug('   ìŠ¤íƒ: ' + e.getStackTraceString());
}

System.debug('');
System.debug('âœ… =====Order 00000151 ì•Œë¦¼ ë¬¸ì œ ë¶„ì„ ì™„ë£Œ=====');
