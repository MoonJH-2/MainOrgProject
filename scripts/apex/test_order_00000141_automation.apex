// Order 00000141 ìë™í™” ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
System.debug('ğŸ¯ =====Order 00000141 PDF & Slack ìë™í™” í…ŒìŠ¤íŠ¸=====');

try {
    // 1. Order 00000141 ì¡°íšŒ
    List<Order> orders = [
        SELECT Id, OrderNumber, Account.Name, TotalAmount, Status,
               Slack_Channel_ID__c, Slack_Channel_Name__c, Slack_Notification_Status__c,
               (SELECT Id, Product2.Name, Product2.ProductCode, Quantity, 
                       UnitPrice, TotalPrice FROM OrderItems)
        FROM Order 
        WHERE OrderNumber = '00000141'
        LIMIT 1
    ];
    
    if (orders.isEmpty()) {
        System.debug('âŒ Order 00000141ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Order targetOrder = orders[0];
    System.debug('ğŸ“‹ Order: ' + targetOrder.OrderNumber + ' (' + targetOrder.Account.Name + ')');
    System.debug('   Status: ' + targetOrder.Status);
    System.debug('   Amount: â‚©' + targetOrder.TotalAmount.format());
    System.debug('   Order Products: ' + targetOrder.OrderItems.size() + 'ê°œ');
    
    // 2. í˜„ì¬ Order Product ìƒíƒœ í™•ì¸
    for (OrderItem item : targetOrder.OrderItems) {
        System.debug('   â€¢ ' + item.Product2.Name + ' (Code: ' + item.Product2.ProductCode + 
                     ', Qty: ' + item.Quantity + ', Price: â‚©' + item.TotalPrice.format() + ')');
    }
    
    // 3. í˜„ì¬ Slack ìƒíƒœ í™•ì¸
    System.debug('ğŸ’¬ í˜„ì¬ Slack ìƒíƒœ:');
    System.debug('   Channel ID: ' + (String.isBlank(targetOrder.Slack_Channel_ID__c) ? 'ì—†ìŒ' : targetOrder.Slack_Channel_ID__c));
    System.debug('   Channel Name: ' + (String.isBlank(targetOrder.Slack_Channel_Name__c) ? 'ì—†ìŒ' : targetOrder.Slack_Channel_Name__c));
    System.debug('   Status: ' + (String.isBlank(targetOrder.Slack_Notification_Status__c) ? 'Not Created' : targetOrder.Slack_Notification_Status__c));
    
    // 4. í˜„ì¬ PDF íŒŒì¼ ìƒíƒœ í™•ì¸
    System.debug('ğŸ“ í˜„ì¬ PDF íŒŒì¼ ìƒíƒœ:');
    List<ContentDocumentLink> pdfFiles = [
        SELECT ContentDocument.Id, ContentDocument.Title, ContentDocument.FileExtension,
               ContentDocument.CreatedDate
        FROM ContentDocumentLink 
        WHERE LinkedEntityId = :targetOrder.Id
        AND ContentDocument.FileExtension = 'pdf'
        ORDER BY ContentDocument.CreatedDate DESC
    ];
    
    System.debug('   ì´ PDF íŒŒì¼: ' + pdfFiles.size() + 'ê°œ');
    for (ContentDocumentLink pdf : pdfFiles) {
        String fileType = pdf.ContentDocument.Title.contains('Product') ? ' [Product ìƒì„¸ì„œ]' : 
                         pdf.ContentDocument.Title.contains('ë‚©ë¶€ì¼ì •ì„œ') ? ' [ë‚©ë¶€ì¼ì •ì„œ]' : '';
        System.debug('   â€¢ ' + pdf.ContentDocument.Title + '.pdf' + fileType + 
                     ' (ìƒì„±ì¼: ' + pdf.ContentDocument.CreatedDate.format() + ')');
    }
    
    // 5. ìë™í™” ì‹œìŠ¤í…œ ìˆ˜ë™ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
    System.debug('ğŸ¤– ìë™í™” ì‹œìŠ¤í…œ ìˆ˜ë™ ì‹¤í–‰ ì¤‘...');
    
    Set<Id> orderIds = new Set<Id>{ targetOrder.Id };
    
    // OrderProductAutomationService ì§ì ‘ í˜¸ì¶œ (ë™ê¸°ì‹ í…ŒìŠ¤íŠ¸)
    try {
        // ë¹„ë™ê¸° ë©”ì„œë“œ ëŒ€ì‹  ë™ê¸° ë¡œì§ìœ¼ë¡œ í…ŒìŠ¤íŠ¸
        System.debug('ğŸ“„ PDF ìƒì„± í…ŒìŠ¤íŠ¸...');
        
        // PDF ìƒì„± í…ŒìŠ¤íŠ¸ (ê°„ë‹¨í•œ ë²„ì „)
        String pdfContent = createTestPDFContent(targetOrder);
        
        ContentVersion cv = new ContentVersion();
        cv.Title = 'Order_Product_ìƒì„¸ì„œ_' + targetOrder.OrderNumber + '_TEST_' + 
                  DateTime.now().format('yyyyMMdd_HHmmss');
        cv.PathOnClient = cv.Title + '.pdf';
        cv.VersionData = Blob.valueOf(pdfContent);
        cv.ContentLocation = 'S';
        cv.Description = targetOrder.Account.Name + ' ê³ ê° Order Product ìƒì„¸ì„œ - ' + 
                       targetOrder.OrderNumber + ' (í…ŒìŠ¤íŠ¸ ìƒì„±)';
        
        insert cv;
        
        // ContentDocumentLink ìƒì„±
        ContentVersion insertedCV = [SELECT ContentDocumentId FROM ContentVersion WHERE Id = :cv.Id];
        
        ContentDocumentLink cdl = new ContentDocumentLink();
        cdl.ContentDocumentId = insertedCV.ContentDocumentId;
        cdl.LinkedEntityId = targetOrder.Id;
        cdl.ShareType = 'V';
        cdl.Visibility = 'AllUsers';
        insert cdl;
        
        System.debug('âœ… PDF ìƒì„± ì™„ë£Œ: ' + cv.Title + '.pdf');
        
    } catch (Exception pdfEx) {
        System.debug('âŒ PDF ìƒì„± ì˜¤ë¥˜: ' + pdfEx.getMessage());
    }
    
    // 6. Slack ì±„ë„ ìƒì„± í…ŒìŠ¤íŠ¸
    try {
        System.debug('ğŸ’¬ Slack ì±„ë„ ìƒì„± í…ŒìŠ¤íŠ¸...');
        
        // SlackChannelService í…ŒìŠ¤íŠ¸ í˜¸ì¶œ
        Boolean slackResult = SlackChannelService.createOrderChannel(targetOrder);
        
        if (slackResult) {
            System.debug('âœ… Slack ì±„ë„ ìƒì„± ì™„ë£Œ');
        } else {
            System.debug('âš ï¸ Slack ì±„ë„ ìƒì„± ê²°ê³¼: false (í…ŒìŠ¤íŠ¸ ëª¨ë“œì—ì„œëŠ” ì •ìƒ)');
        }
        
    } catch (Exception slackEx) {
        System.debug('âŒ Slack ì±„ë„ ìƒì„± ì˜¤ë¥˜: ' + slackEx.getMessage());
    }
    
    // 7. Chatter í¬ìŠ¤íŠ¸ ìƒì„± í…ŒìŠ¤íŠ¸
    try {
        System.debug('ğŸ’¬ Chatter í¬ìŠ¤íŠ¸ ìƒì„± í…ŒìŠ¤íŠ¸...');
        
        FeedItem post = new FeedItem();
        post.ParentId = targetOrder.Id;
        post.Type = 'TextPost';
        
        String message = 'ğŸ‰ Order Product ìë™í™” í…ŒìŠ¤íŠ¸ ì™„ë£Œ!\n\n';
        message += 'ğŸ“‹ Order: ' + targetOrder.OrderNumber + '\n';
        message += 'ğŸ‘¤ Customer: ' + targetOrder.Account.Name + '\n';
        message += 'ğŸ’° Amount: â‚©' + targetOrder.TotalAmount.format() + '\n\n';
        message += 'âœ… í…ŒìŠ¤íŠ¸ëœ ê¸°ëŠ¥:\n';
        message += 'â€¢ Order Product ìƒì„¸ì„œ PDF ìƒì„±\n';
        message += 'â€¢ Slack ì±„ë„ ìƒì„± (#' + targetOrder.OrderNumber + ')\n';
        message += 'â€¢ Files ìë™ ì²¨ë¶€\n\n';
        message += 'ğŸ“ Notes & Attachmentsì—ì„œ ìƒˆë¡œ ìƒì„±ëœ PDFë¥¼ í™•ì¸í•˜ì„¸ìš”!';
        
        post.Body = message;
        insert post;
        
        System.debug('âœ… Chatter í¬ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ');
        
    } catch (Exception chatterEx) {
        System.debug('âŒ Chatter í¬ìŠ¤íŠ¸ ìƒì„± ì˜¤ë¥˜: ' + chatterEx.getMessage());
    }
    
    // 8. ìµœì¢… ìƒíƒœ í™•ì¸
    System.debug('');
    System.debug('ğŸ“Š í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ìƒíƒœ:');
    
    // ì—…ë°ì´íŠ¸ëœ PDF íŒŒì¼ ëª©ë¡
    List<ContentDocumentLink> updatedPDFs = [
        SELECT ContentDocument.Id, ContentDocument.Title, ContentDocument.FileExtension,
               ContentDocument.CreatedDate
        FROM ContentDocumentLink 
        WHERE LinkedEntityId = :targetOrder.Id
        AND ContentDocument.FileExtension = 'pdf'
        ORDER BY ContentDocument.CreatedDate DESC
    ];
    
    System.debug('   ì´ PDF íŒŒì¼: ' + updatedPDFs.size() + 'ê°œ (í…ŒìŠ¤íŠ¸ ì „: ' + pdfFiles.size() + 'ê°œ)');
    if (!updatedPDFs.isEmpty()) {
        System.debug('   ìµœì‹  PDF: ' + updatedPDFs[0].ContentDocument.Title + '.pdf');
    }
    
    System.debug('');
    System.debug('âœ… =====Order 00000141 ìë™í™” í…ŒìŠ¤íŠ¸ ì™„ë£Œ=====');
    
} catch (Exception e) {
    System.debug('âŒ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}

// PDF ë‚´ìš© ìƒì„± í—¬í¼ í•¨ìˆ˜
private static String createTestPDFContent(Order orderInfo) {
    String pdfContent = '%PDF-1.4\n';
    pdfContent += '1 0 obj\n<<\n/Type /Catalog\n/Pages 2 0 R\n>>\nendobj\n\n';
    pdfContent += '2 0 obj\n<<\n/Type /Pages\n/Kids [3 0 R]\n/Count 1\n>>\nendobj\n\n';
    pdfContent += '3 0 obj\n<<\n/Type /Page\n/Parent 2 0 R\n/MediaBox [0 0 612 792]\n/Contents 4 0 R\n>>\nendobj\n\n';
    
    String contentStream = 'BT\n/F1 16 Tf\n50 750 Td\n';
    contentStream += '(Order Product ìƒì„¸ì„œ - TEST) Tj\n';
    contentStream += '/F1 12 Tf\n0 -30 Td\n';
    contentStream += '(Order Number: ' + orderInfo.OrderNumber + ') Tj\n';
    contentStream += '0 -20 Td\n(Customer: ' + orderInfo.Account.Name + ') Tj\n';
    contentStream += '0 -20 Td\n(Status: ' + orderInfo.Status + ') Tj\n';
    contentStream += '0 -20 Td\n(Amount: â‚©' + orderInfo.TotalAmount.format() + ') Tj\n';
    contentStream += '0 -30 Td\n(=== Product Details ===) Tj\n';
    
    for (OrderItem item : orderInfo.OrderItems) {
        contentStream += '0 -20 Td\n(â€¢ ' + item.Product2.Name + ') Tj\n';
        contentStream += '0 -15 Td\n(  Quantity: ' + item.Quantity + ') Tj\n';
        contentStream += '0 -15 Td\n(  Total: â‚©' + item.TotalPrice.format() + ') Tj\n';
    }
    
    contentStream += '0 -30 Td\n(ìƒì„±ì¼: ' + Date.today().format() + ' [TEST]) Tj\n';
    contentStream += 'ET';
    
    pdfContent += '4 0 obj\n<<\n/Length ' + contentStream.length() + '\n>>\nstream\n';
    pdfContent += contentStream + '\nendstream\nendobj\n\n';
    pdfContent += 'xref\n0 5\n0000000000 65535 f \n0000000009 00000 n \n';
    pdfContent += '0000000058 00000 n \n0000000115 00000 n \n0000000204 00000 n \n';
    pdfContent += 'trailer\n<<\n/Size 5\n/Root 1 0 R\n>>\nstartxref\n500\n%%EOF';
    
    return pdfContent;
}
