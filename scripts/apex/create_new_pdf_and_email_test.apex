// Order 00000115 ìƒˆ ë‚©ë¶€ì¼ì •ì„œ PDF ìƒì„± ë° ì´ë©”ì¼ í…ŒìŠ¤íŠ¸
System.debug('ğŸ“„ =====Order 00000115 ìƒˆ ë‚©ë¶€ì¼ì •ì„œ ìƒì„± ë° ì´ë©”ì¼ í…ŒìŠ¤íŠ¸=====');

try {
    // 1. Order 00000115 ì¡°íšŒ
    List<Order> orders = [
        SELECT Id, OrderNumber, Account.Name, Account.Id
        FROM Order 
        WHERE OrderNumber = '00000115'
        LIMIT 1
    ];
    
    if (orders.isEmpty()) {
        System.debug('âŒ Order 00000115ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Order targetOrder = orders[0];
    System.debug('ğŸ“‹ Order: ' + targetOrder.OrderNumber + ' (' + targetOrder.Account.Name + ')');
    
    // 2. PaymentStatus ëª©ë¡ ì¡°íšŒ
    List<PaymentStatus__c> paymentList = [
        SELECT InstallmentNumber__c, Amount__c, DueDate__c, Status__c
        FROM PaymentStatus__c 
        WHERE Order__c = :targetOrder.Id
        ORDER BY InstallmentNumber__c ASC
    ];
    
    System.debug('ğŸ’° PaymentStatus: ' + paymentList.size() + 'ê±´');
    
    // 3. ìƒˆë¡œìš´ ë‚©ë¶€ì¼ì •ì„œ PDF ìƒì„±
    System.debug('ğŸ“ ìƒˆ ë‚©ë¶€ì¼ì •ì„œ PDF ìƒì„± ì¤‘...');
    
    // ì‹¤ì œ PDF ë‚´ìš© ìƒì„± (ë” ìƒì„¸í•˜ê²Œ)
    String pdfContent = '%PDF-1.4\n';
    pdfContent += '1 0 obj\n<<\n/Type /Catalog\n/Pages 2 0 R\n>>\nendobj\n\n';
    pdfContent += '2 0 obj\n<<\n/Type /Pages\n/Kids [3 0 R]\n/Count 1\n>>\nendobj\n\n';
    pdfContent += '3 0 obj\n<<\n/Type /Page\n/Parent 2 0 R\n/MediaBox [0 0 612 792]\n/Contents 4 0 R\n/Resources << /Font << /F1 5 0 R >> >>\n>>\nendobj\n\n';
    
    // ë‚´ìš© ìŠ¤íŠ¸ë¦¼ ìƒì„±
    String contentStream = 'BT\n';
    contentStream += '/F1 16 Tf\n';
    contentStream += '100 720 Td\n';
    contentStream += '(ë‚©ë¶€ì¼ì •ì„œ) Tj\n';
    contentStream += '0 -30 Td\n';
    contentStream += '/F1 12 Tf\n';
    contentStream += '(Order Number: ' + targetOrder.OrderNumber + ') Tj\n';
    contentStream += '0 -20 Td\n';
    contentStream += '(ê³ ê°ëª…: ' + targetOrder.Account.Name + ') Tj\n';
    contentStream += '0 -20 Td\n';
    contentStream += '(ìƒì„±ì¼: ' + Date.today().format() + ') Tj\n';
    contentStream += '0 -40 Td\n';
    contentStream += '(ë‚©ë¶€ ì¼ì •) Tj\n';
    contentStream += '0 -30 Td\n';
    
    // ê° ë‚©ë¶€ í•­ëª© ì¶”ê°€
    for (PaymentStatus__c payment : paymentList) {
        String statusText = payment.Status__c == 'ì™„ë‚©' ? 'ì™„ë‚©' : 
                           (payment.DueDate__c < Date.today() ? 'ì—°ì²´' : 'ì˜ˆì •');
        String paymentLine = '(' + payment.InstallmentNumber__c + 'ì°¨: â‚©' + 
                           String.valueOf(payment.Amount__c.format()) + ' - ' + 
                           payment.DueDate__c.format() + ' [' + statusText + ']) Tj';
        contentStream += paymentLine + '\n';
        contentStream += '0 -20 Td\n';
    }
    
    contentStream += 'ET\n';
    
    // PDF êµ¬ì¡° ì™„ì„±
    Integer contentLength = contentStream.length();
    pdfContent += '4 0 obj\n<<\n/Length ' + contentLength + '\n>>\nstream\n';
    pdfContent += contentStream;
    pdfContent += 'endstream\nendobj\n\n';
    
    pdfContent += '5 0 obj\n<<\n/Type /Font\n/Subtype /Type1\n/BaseFont /Helvetica\n>>\nendobj\n\n';
    
    pdfContent += 'xref\n0 6\n';
    pdfContent += '0000000000 65535 f \n';
    pdfContent += '0000000009 00000 n \n';
    pdfContent += '0000000058 00000 n \n';
    pdfContent += '0000000115 00000 n \n';
    pdfContent += '0000000300 00000 n \n';
    pdfContent += '0000000400 00000 n \n';
    pdfContent += 'trailer\n<<\n/Size 6\n/Root 1 0 R\n>>\n';
    pdfContent += 'startxref\n500\n%%EOF';
    
    // ContentVersion ìƒì„±
    ContentVersion cv = new ContentVersion();
    cv.Title = 'ë‚©ë¶€ì¼ì •ì„œ_' + targetOrder.OrderNumber + '_' + DateTime.now().format('yyyyMMdd_HHmmss');
    cv.PathOnClient = cv.Title + '.pdf';
    cv.VersionData = Blob.valueOf(pdfContent);
    cv.ContentLocation = 'S';
    cv.Description = targetOrder.Account.Name + ' ê³ ê° ë‚©ë¶€ì¼ì •ì„œ - ' + targetOrder.OrderNumber + ' (ìë™ìƒì„±)';
    
    insert cv;
    
    // ContentDocument ID ì¡°íšŒ
    ContentVersion insertedCV = [SELECT ContentDocumentId FROM ContentVersion WHERE Id = :cv.Id];
    
    // ContentDocumentLink ìƒì„± (Orderì— ì—°ê²°)
    ContentDocumentLink cdl = new ContentDocumentLink();
    cdl.ContentDocumentId = insertedCV.ContentDocumentId;
    cdl.LinkedEntityId = targetOrder.Id;
    cdl.ShareType = 'V';
    cdl.Visibility = 'AllUsers';
    insert cdl;
    
    System.debug('âœ… ìƒˆ ë‚©ë¶€ì¼ì •ì„œ PDF ìƒì„± ì™„ë£Œ');
    System.debug('   íŒŒì¼ëª…: ' + cv.Title + '.pdf');
    System.debug('   í¬ê¸°: ' + (cv.VersionData.size() / 1024) + 'KB');
    System.debug('   ContentVersion ID: ' + cv.Id);
    System.debug('   ContentDocument ID: ' + insertedCV.ContentDocumentId);
    
    // 4. ì—°ì²´ ì•Œë¦¼ ìƒì„± ë° ì´ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸
    System.debug('ğŸ“§ ì´ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸ ì¤‘...');
    
    // ì—°ì²´ PaymentStatus ì°¾ê¸° ë˜ëŠ” ì„ì‹œ ìƒì„±
    List<PaymentStatus__c> overduePayments = [
        SELECT Id, InstallmentNumber__c
        FROM PaymentStatus__c 
        WHERE Order__c = :targetOrder.Id
        AND DueDate__c < TODAY 
        AND Status__c != 'ì™„ë‚©'
        LIMIT 1
    ];
    
    PaymentStatus__c testPayment;
    if (overduePayments.isEmpty()) {
        // ì„ì‹œë¡œ 2ì°¨ ë‚©ë¶€ë¥¼ ì—°ì²´ ìƒíƒœë¡œ ë§Œë“¤ê¸°
        List<PaymentStatus__c> secondPayments = [
            SELECT Id, DueDate__c, Status__c
            FROM PaymentStatus__c 
            WHERE Order__c = :targetOrder.Id
            AND InstallmentNumber__c = 2
            LIMIT 1
        ];
        
        if (!secondPayments.isEmpty()) {
            testPayment = secondPayments[0];
            testPayment.DueDate__c = Date.today().addDays(-2);
            testPayment.Status__c = 'ë¯¸ë‚©';
            update testPayment;
            System.debug('   2ì°¨ ë‚©ë¶€ë¥¼ ì„ì‹œ ì—°ì²´ ìƒíƒœë¡œ ë³€ê²½');
        }
    } else {
        testPayment = overduePayments[0];
    }
    
    if (testPayment != null) {
        // Payment_Notification__c ìƒì„±
        Payment_Notification__c notification = new Payment_Notification__c();
        notification.PaymentStatus__c = testPayment.Id;
        notification.NotificationType__c = 'ì—°ì²´ ì•Œë¦¼';
        notification.NotificationChannel__c = 'Email';
        notification.NotificationStatus__c = 'Pending';
        notification.ScheduledDateTime__c = DateTime.now();
        
        insert notification;
        
        // ê´€ê³„ í•„ë“œì™€ í•¨ê»˜ ì¡°íšŒ
        Payment_Notification__c fullNotification = [
            SELECT Id, PaymentStatus__c, PaymentStatus__r.Order__c,
                   PaymentStatus__r.Order__r.Account.Name, PaymentStatus__r.Order__r.Account.Id,
                   PaymentStatus__r.Order__r.OrderNumber, PaymentStatus__r.InstallmentNumber__c,
                   PaymentStatus__r.Amount__c, PaymentStatus__r.DueDate__c, PaymentStatus__r.Status__c,
                   NotificationType__c, NotificationChannel__c
            FROM Payment_Notification__c 
            WHERE Id = :notification.Id
        ];
        
        // ì´ë©”ì¼ ë°œì†¡
        Boolean emailResult = PaymentNotificationService.sendEmailNotification(fullNotification);
        System.debug('   ì´ë©”ì¼ ë°œì†¡ ê²°ê³¼: ' + (emailResult ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'));
        
        if (emailResult) {
            System.debug('');
            System.debug('ğŸ“§ ë°œì†¡ ì™„ë£Œ ì •ë³´:');
            System.debug('â€¢ ì œëª©: [ì—°ì²´ ì•Œë¦¼] ' + fullNotification.PaymentStatus__r.InstallmentNumber__c + 'ì°¨ ë‚©ë¶€ ì—°ì²´ ì•ˆë‚´');
            System.debug('â€¢ PDF ì²¨ë¶€: ' + cv.Title + '.pdf (' + (cv.VersionData.size() / 1024) + 'KB)');
            System.debug('â€¢ ê³ ê°: ' + targetOrder.Account.Name);
            System.debug('â€¢ ê´€ë¦¬ì: ì‹œìŠ¤í…œ ê´€ë¦¬ì ë° Order Owner');
        }
        
        // í…ŒìŠ¤íŠ¸ ì •ë¦¬
        testPayment.DueDate__c = Date.newInstance(2025, 8, 14);
        testPayment.Status__c = 'ì˜ˆì •';
        update testPayment;
        System.debug('âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ');
    }
    
    System.debug('âœ… =====Order 00000115 ìƒˆ ë‚©ë¶€ì¼ì •ì„œ ìƒì„± ë° ì´ë©”ì¼ í…ŒìŠ¤íŠ¸ ì™„ë£Œ=====');
    
} catch (Exception e) {
    System.debug('âŒ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}
