/**
 * PaymentStatus ì™„ë‚© ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸
 * ì‹¤ì œ PaymentStatusë¥¼ ì™„ë‚©ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ Asset ìë™ ìƒì„± í…ŒìŠ¤íŠ¸
 */

System.debug('=== PaymentStatus ì™„ë‚© ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ ===');

// 1. ëª¨ë“  Assetì˜ SerialNumber ê°€ì ¸ì˜¤ê¸°
Set<String> existingAssetSerialNumbers = new Set<String>();
for (Asset ast : [SELECT SerialNumber FROM Asset WHERE SerialNumber != null]) {
    existingAssetSerialNumbers.add(ast.SerialNumber);
}

// 2. Assetì´ ì—†ëŠ” Order ì°¾ê¸°
List<Order> candidateOrders = [
    SELECT Id, OrderNumber, AccountId, Account.Name, Account.Key_Account__c,
           Account.CustomerPriority__c, TotalAmount
    FROM Order 
    WHERE AccountId != null
    LIMIT 10
];

List<Order> ordersWithoutAssets = new List<Order>();
for (Order ord : candidateOrders) {
    if (!existingAssetSerialNumbers.contains(ord.OrderNumber)) {
        ordersWithoutAssets.add(ord);
    }
}

System.debug('Assetì´ ì—†ëŠ” Order ê°œìˆ˜: ' + ordersWithoutAssets.size());

Order targetOrder = null;
List<PaymentStatus__c> targetPayments = null;

// ë¯¸ì™„ë‚© PaymentStatusê°€ ìˆëŠ” Order ì°¾ê¸°
for (Order ord : ordersWithoutAssets) {
    List<PaymentStatus__c> payments = [
        SELECT Id, InstallmentNumber__c, Amount__c, Status__c, DueDate__c
        FROM PaymentStatus__c 
        WHERE Order__c = :ord.Id
        AND Status__c != 'ì™„ë‚©'
        ORDER BY InstallmentNumber__c
    ];
    
    if (!payments.isEmpty()) {
        targetOrder = ord;
        targetPayments = payments;
        System.debug('í…ŒìŠ¤íŠ¸ ëŒ€ìƒ Order ì„ ì •: ' + ord.OrderNumber + ' (' + ord.Account.Name + ')');
        System.debug('ë¯¸ì™„ë‚© PaymentStatus: ' + payments.size() + 'ê°œ');
        break;
    }
}

if (targetOrder == null) {
    System.debug('âŒ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆëŠ” ë¯¸ì™„ë‚© Orderê°€ ì—†ìŠµë‹ˆë‹¤.');
    
    // ìƒˆë¡œìš´ PaymentStatus ìƒì„± ì˜µì…˜ ì œì‹œ
    if (!candidateOrders.isEmpty()) {
        Order sampleOrder = candidateOrders[0];
        System.debug('\n=== í…ŒìŠ¤íŠ¸ìš© PaymentStatus ìƒì„± ê°€ì´ë“œ ===');
        System.debug('Order ID: ' + sampleOrder.Id);
        System.debug('Order Number: ' + sampleOrder.OrderNumber);
        System.debug('Account: ' + sampleOrder.Account.Name);
        System.debug('\në‹¤ìŒ ì½”ë“œë¡œ PaymentStatusë¥¼ ìƒì„±í•˜ê³  ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”:');
        System.debug('PaymentStatus__c ps = new PaymentStatus__c();');
        System.debug('ps.Order__c = \'' + sampleOrder.Id + '\';');
        System.debug('ps.InstallmentNumber__c = 1;');
        System.debug('ps.Amount__c = ' + (sampleOrder.TotalAmount != null ? sampleOrder.TotalAmount : 1000000) + ';');
        System.debug('ps.Status__c = \'ë¯¸ë‚©\';');
        System.debug('ps.DueDate__c = Date.today().addDays(30);');
        System.debug('insert ps;');
    }
} else {
    System.debug('\n=== ì„ ì •ëœ Order ì •ë³´ ===');
    System.debug('Order: ' + targetOrder.OrderNumber);
    System.debug('ê³ ê°: ' + targetOrder.Account.Name);
    System.debug('Key Account: ' + (targetOrder.Account.Key_Account__c ? 'Yes' : 'No'));
    System.debug('ìš°ì„ ìˆœìœ„: ' + (targetOrder.Account.CustomerPriority__c ?? 'ì¼ë°˜'));
    System.debug('Order ê¸ˆì•¡: ' + (targetOrder.TotalAmount != null ? targetOrder.TotalAmount.format() : '0') + 'ì›');
    
    // í˜„ì¬ PaymentStatus í˜„í™©
    List<PaymentStatus__c> allPayments = [
        SELECT Id, InstallmentNumber__c, Amount__c, Status__c, DueDate__c
        FROM PaymentStatus__c 
        WHERE Order__c = :targetOrder.Id
        ORDER BY InstallmentNumber__c
    ];
    
    System.debug('\n=== í˜„ì¬ PaymentStatus í˜„í™© ===');
    for (PaymentStatus__c ps : allPayments) {
        System.debug(ps.InstallmentNumber__c + 'ì°¨: ' + 
                    (ps.Amount__c != null ? ps.Amount__c.format() : '0') + 'ì› - ' + ps.Status__c);
    }
    
    // ì™„ë‚© ìƒíƒœ í™•ì¸
    // Note: AccountBasedAssetServiceëŠ” OrderAssetCreationServiceë¥¼ ë‚´ë¶€ì ìœ¼ë¡œ ì‚¬ìš©í•˜ë¯€ë¡œ ì§ì ‘ í˜¸ì¶œ
    List<PaymentStatus__c> allPaymentsForCheck = [
        SELECT Status__c 
        FROM PaymentStatus__c 
        WHERE Order__c = :targetOrder.Id
    ];
    
    Boolean isCurrentlyFullyPaid = true;
    for (PaymentStatus__c ps : allPaymentsForCheck) {
        if (ps.Status__c != 'ì™„ë‚©') {
            isCurrentlyFullyPaid = false;
            break;
        }
    }
    System.debug('í˜„ì¬ ì™„ë‚© ìƒíƒœ: ' + isCurrentlyFullyPaid);
    
    if (!isCurrentlyFullyPaid) {
        System.debug('\n=== PaymentStatus ì™„ë‚© ì²˜ë¦¬ ì‹œì‘ ===');
        
        try {
            // ëª¨ë“  PaymentStatusë¥¼ ì™„ë‚©ìœ¼ë¡œ ë³€ê²½
            List<PaymentStatus__c> toUpdate = new List<PaymentStatus__c>();
            
            for (PaymentStatus__c ps : allPayments) {
                if (ps.Status__c != 'ì™„ë‚©') {
                    ps.Status__c = 'ì™„ë‚©';
                    // ps.PaidDate__c = Date.today(); // í•„ë“œ ì¡´ì¬ ì‹œ í™œì„±í™”
                    toUpdate.add(ps);
                }
            }
            
            if (!toUpdate.isEmpty()) {
                System.debug('ì™„ë‚©ìœ¼ë¡œ ë³€ê²½í•  PaymentStatus: ' + toUpdate.size() + 'ê°œ');
                
                // PaymentStatus ì—…ë°ì´íŠ¸ (íŠ¸ë¦¬ê±° ì‹¤í–‰ë¨)
                update toUpdate;
                
                System.debug('âœ… PaymentStatus ì™„ë‚© ì²˜ë¦¬ ì™„ë£Œ!');
                System.debug('PaymentStatusAssetTriggerê°€ ì‹¤í–‰ë˜ì–´ Asset ìë™ ìƒì„±ì´ ì‹œì‘ë©ë‹ˆë‹¤...');
                
                // ì ì‹œ í›„ ê²°ê³¼ í™•ì¸
                System.debug('\n=== Asset ìƒì„± ê²°ê³¼ í™•ì¸ ===');
                
                // ì™„ë‚© ìƒíƒœ ì¬í™•ì¸
                List<PaymentStatus__c> updatedPayments = [
                    SELECT Status__c 
                    FROM PaymentStatus__c 
                    WHERE Order__c = :targetOrder.Id
                ];
                
                Boolean newIsFullyPaid = true;
                for (PaymentStatus__c ps : updatedPayments) {
                    if (ps.Status__c != 'ì™„ë‚©') {
                        newIsFullyPaid = false;
                        break;
                    }
                }
                System.debug('ì—…ë°ì´íŠ¸ í›„ ì™„ë‚© ìƒíƒœ: ' + newIsFullyPaid);
                
                // ìƒì„±ëœ Asset í™•ì¸
                List<Asset> newAssets = [
                    SELECT Id, Name, SerialNumber, AccountId, Account.Name,
                           Status, Price, PurchaseDate, InstallDate, 
                           LifecycleStartDate, LifecycleEndDate, CreatedDate
                    FROM Asset 
                    WHERE SerialNumber = :targetOrder.OrderNumber
                    ORDER BY CreatedDate DESC
                ];
                
                if (!newAssets.isEmpty()) {
                    Asset createdAsset = newAssets[0];
                    System.debug('ğŸ‰ Asset ìë™ ìƒì„± ì„±ê³µ!');
                    System.debug('- Asset ID: ' + createdAsset.Id);
                    System.debug('- Asset Name: ' + createdAsset.Name);
                    System.debug('- Account: ' + createdAsset.Account.Name);
                    System.debug('- Status: ' + createdAsset.Status);
                    System.debug('- Price: ' + (createdAsset.Price != null ? createdAsset.Price.format() : '0') + 'ì›');
                    System.debug('- Purchase Date: ' + (createdAsset.PurchaseDate != null ? createdAsset.PurchaseDate.format() : 'ì—†ìŒ'));
                    System.debug('- Lifecycle Start: ' + (createdAsset.LifecycleStartDate != null ? createdAsset.LifecycleStartDate.format() : 'ì—†ìŒ'));
                    System.debug('- Lifecycle End: ' + (createdAsset.LifecycleEndDate != null ? createdAsset.LifecycleEndDate.format() : 'ì—†ìŒ'));
                    System.debug('- Created: ' + createdAsset.CreatedDate.format());
                    
                    // ìƒì„±ëœ Task í™•ì¸
                    List<Task> createdTasks = [
                        SELECT Id, Subject, Priority, Status, ActivityDate, 
                               Owner.Name, Description
                        FROM Task 
                        WHERE WhatId = :createdAsset.Id
                        ORDER BY CreatedDate DESC
                    ];
                    
                    if (!createdTasks.isEmpty()) {
                        System.debug('\n--- ìë™ ìƒì„±ëœ í›„ì† Task ---');
                        for (Task t : createdTasks) {
                            System.debug('ğŸ“‹ ' + t.Subject);
                            System.debug('   ë‹´ë‹¹ì: ' + t.Owner.Name);
                            System.debug('   ìš°ì„ ìˆœìœ„: ' + t.Priority);
                            System.debug('   ì˜ˆì •ì¼: ' + (t.ActivityDate != null ? t.ActivityDate.format() : 'ë¯¸ì •'));
                            
                            // Description ë¯¸ë¦¬ë³´ê¸°
                            if (String.isNotBlank(t.Description)) {
                                String descPreview = t.Description.length() > 200 ? 
                                    t.Description.substring(0, 200) + '...' : t.Description;
                                System.debug('   ë‚´ìš©: ' + descPreview.replace('\n', ' '));
                            }
                            System.debug('');
                        }
                    } else {
                        System.debug('ìƒì„±ëœ í›„ì† Taskê°€ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    
                } else {
                    System.debug('âš ï¸ Assetì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
                
            } else {
                System.debug('ì´ë¯¸ ëª¨ë“  PaymentStatusê°€ ì™„ë‚© ìƒíƒœì…ë‹ˆë‹¤.');
            }
            
        } catch (Exception e) {
            System.debug('âŒ PaymentStatus ì™„ë‚© ì²˜ë¦¬ ì˜¤ë¥˜: ' + e.getMessage());
            System.debug('Stack Trace: ' + e.getStackTraceString());
        }
        
    } else {
        System.debug('âš ï¸ ì´ë¯¸ ì™„ë‚©ëœ Orderì…ë‹ˆë‹¤.');
    }
}

System.debug('\n=== PaymentStatus ì™„ë‚© ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');

// ì‹œìŠ¤í…œ ë™ì‘ ìš”ì•½
System.debug('\n=== ìë™í™” ì‹œìŠ¤í…œ ë™ì‘ ìš”ì•½ ===');
System.debug('1. PaymentStatus.Status__c â†’ "ì™„ë‚©" ë³€ê²½');
System.debug('2. PaymentStatusAssetTrigger.trigger ì‹¤í–‰');
System.debug('3. PaymentStatusAssetTriggerHandler.handleAfterUpdate() í˜¸ì¶œ');
System.debug('4. PaymentStatus ì™„ë‚© í™•ì¸');
System.debug('5. AccountBasedAssetService.createAssetWithAccountAnalysis() Asset ìƒì„±');
System.debug('6. Account ì •ë³´ ê¸°ë°˜ Lifecycle, ìš°ì„ ìˆœìœ„, í›„ì† ì•¡ì…˜ ì„¤ì •');
System.debug('7. Account Manager, Key Account, ê³ ìš°ì„ ìˆœìœ„ë³„ ë§ì¶¤ Task ìë™ ìƒì„±');
