// ì‹ ê·œ Order ìƒì„± ì‹œ ìë™í™” ì‹œìŠ¤í…œ ì „ì²´ í…ŒìŠ¤íŠ¸
System.debug('ğŸ†• =====ì‹ ê·œ Order ìƒì„± ìë™í™” ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸=====');

try {
    // 1. í…ŒìŠ¤íŠ¸ìš© Account ì¡°íšŒ ë˜ëŠ” ìƒì„±
    List<Account> testAccounts = [
        SELECT Id, Name FROM Account 
        WHERE Name = 'ìë™í™”í…ŒìŠ¤íŠ¸ê³ ê°' 
        LIMIT 1
    ];
    
    Account testAccount;
    if (testAccounts.isEmpty()) {
        testAccount = new Account();
        testAccount.Name = 'ìë™í™”í…ŒìŠ¤íŠ¸ê³ ê°';
        testAccount.Type = 'Customer';
        insert testAccount;
        System.debug('âœ… í…ŒìŠ¤íŠ¸ Account ìƒì„±: ' + testAccount.Name);
    } else {
        testAccount = testAccounts[0];
        System.debug('ğŸ“‹ ê¸°ì¡´ í…ŒìŠ¤íŠ¸ Account ì‚¬ìš©: ' + testAccount.Name);
    }
    
    // 2. í…ŒìŠ¤íŠ¸ìš© Product ì¡°íšŒ
    List<Product2> testProducts = [
        SELECT Id, Name, ProductCode FROM Product2 
        WHERE ProductCode = 'CAR-PLT'
        LIMIT 1
    ];
    
    if (testProducts.isEmpty()) {
        System.debug('âŒ í…ŒìŠ¤íŠ¸ìš© Product (CAR-PLT)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Product2 testProduct = testProducts[0];
    System.debug('ğŸ“¦ í…ŒìŠ¤íŠ¸ Product: ' + testProduct.Name + ' (' + testProduct.ProductCode + ')');
    
    // 3. PricebookEntry ì¡°íšŒ
    List<PricebookEntry> pricebookEntries = [
        SELECT Id, UnitPrice FROM PricebookEntry 
        WHERE Product2Id = :testProduct.Id 
        AND Pricebook2Id = :Test.getStandardPricebookId()
        AND IsActive = true
        LIMIT 1
    ];
    
    if (pricebookEntries.isEmpty()) {
        System.debug('âŒ í…ŒìŠ¤íŠ¸ìš© PricebookEntryë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    PricebookEntry pbe = pricebookEntries[0];
    System.debug('ğŸ’° Unit Price: â‚©' + pbe.UnitPrice.format());
    
    // 4. ì‹ ê·œ Order ìƒì„±
    Order newOrder = new Order();
    newOrder.AccountId = testAccount.Id;
    newOrder.EffectiveDate = Date.today();
    newOrder.Status = 'Draft';
    newOrder.Payment_Method__c = 'ì›”ë³„';
    newOrder.Pricebook2Id = Test.getStandardPricebookId();
    
    insert newOrder;
    
    System.debug('âœ… ì‹ ê·œ Order ìƒì„±: ' + newOrder.Id);
    
    // Order Number ì¡°íšŒ
    Order insertedOrder = [SELECT OrderNumber FROM Order WHERE Id = :newOrder.Id];
    System.debug('   Order Number: ' + insertedOrder.OrderNumber);
    
    // 5. OrderItem ìƒì„± (ì´ ì‹œì ì—ì„œ ìë™í™” íŠ¸ë¦¬ê±°ë¨)
    System.debug('');
    System.debug('ğŸ›’ OrderItem ìƒì„± ì¤‘... (ìë™í™” íŠ¸ë¦¬ê±° ì˜ˆìƒ)');
    
    OrderItem newOrderItem = new OrderItem();
    newOrderItem.OrderId = newOrder.Id;
    newOrderItem.Product2Id = testProduct.Id;
    newOrderItem.PricebookEntryId = pbe.Id;
    newOrderItem.Quantity = 50;
    newOrderItem.UnitPrice = pbe.UnitPrice;
    
    insert newOrderItem;
    
    System.debug('âœ… OrderItem ìƒì„± ì™„ë£Œ');
    System.debug('   Product: ' + testProduct.Name);
    System.debug('   Quantity: 50');
    System.debug('   Total: â‚©' + (pbe.UnitPrice * 50).format());
    
    // 6. Order ìƒíƒœ í™•ì¸ (TotalAmount ì—…ë°ì´íŠ¸ í™•ì¸)
    Order updatedOrder = [
        SELECT Id, OrderNumber, TotalAmount, Status, 
               Slack_Channel_ID__c, Slack_Channel_Name__c, Slack_Notification_Status__c
        FROM Order 
        WHERE Id = :newOrder.Id
    ];
    
    System.debug('');
    System.debug('ğŸ“Š OrderItem ìƒì„± í›„ Order ìƒíƒœ:');
    System.debug('   Order Number: ' + updatedOrder.OrderNumber);
    System.debug('   Total Amount: â‚©' + updatedOrder.TotalAmount.format());
    System.debug('   Status: ' + updatedOrder.Status);
    
    // 7. Orderê°€ Draft ìƒíƒœë©´ Activatedë¡œ ë³€ê²½ (ìë™í™” íŠ¸ë¦¬ê±°)
    if (updatedOrder.Status == 'Draft') {
        System.debug('');
        System.debug('ğŸ”„ Orderë¥¼ Activatedë¡œ ë³€ê²½ ì¤‘... (ìë™í™” íŠ¸ë¦¬ê±° ì˜ˆìƒ)');
        
        Order orderToActivate = new Order();
        orderToActivate.Id = updatedOrder.Id;
        orderToActivate.Status = 'Activated';
        
        update orderToActivate;
        
        System.debug('âœ… Order Status ë³€ê²½: Draft â†’ Activated');
    }
    
    // 8. ìë™í™” ê²°ê³¼ í™•ì¸ (ì•½ê°„ì˜ ì§€ì—° í›„)
    System.debug('');
    System.debug('â° ìë™í™” ì‹œìŠ¤í…œ ì²˜ë¦¬ ëŒ€ê¸° ì¤‘... (ë¹„ë™ê¸° ì²˜ë¦¬)');
    
    // ìµœì¢… Order ìƒíƒœ ì¡°íšŒ
    Order finalOrder = [
        SELECT Id, OrderNumber, TotalAmount, Status, 
               Slack_Channel_ID__c, Slack_Channel_Name__c, Slack_Notification_Status__c
        FROM Order 
        WHERE Id = :newOrder.Id
    ];
    
    System.debug('');
    System.debug('ğŸ“‹ ìµœì¢… Order ìƒíƒœ:');
    System.debug('   Order Number: ' + finalOrder.OrderNumber);
    System.debug('   Status: ' + finalOrder.Status);
    System.debug('   Total Amount: â‚©' + finalOrder.TotalAmount.format());
    System.debug('   Slack Status: ' + 
                 (String.isBlank(finalOrder.Slack_Notification_Status__c) ? 
                  'Processing...' : finalOrder.Slack_Notification_Status__c));
    
    // 9. ì˜ˆìƒ ê²°ê³¼ ì•ˆë‚´
    System.debug('');
    System.debug('ğŸ¯ ì˜ˆìƒë˜ëŠ” ìë™í™” ê²°ê³¼:');
    System.debug('   1. PaymentStatus ìë™ ìƒì„± (ì›”ë³„ ë¶„í• )');
    System.debug('   2. Order Product ìƒì„¸ì„œ PDF ìë™ ìƒì„±');
    System.debug('   3. Slack ì±„ë„ ìë™ ìƒì„± (#' + finalOrder.OrderNumber + ')');
    System.debug('   4. PDFê°€ Notes & Attachmentsì— ìë™ ì²¨ë¶€');
    System.debug('   5. Chatterì— ì™„ë£Œ ì•Œë¦¼ í¬ìŠ¤íŠ¸');
    
    System.debug('');
    System.debug('ğŸ“ í™•ì¸ ë°©ë²•:');
    System.debug('   â€¢ Order ' + finalOrder.OrderNumber + ' ìƒì„¸ í˜ì´ì§€ ì ‘ì†');
    System.debug('   â€¢ Notes & Attachments ì„¹ì…˜ì—ì„œ ìƒˆ PDF í™•ì¸');
    System.debug('   â€¢ Chatterì—ì„œ ìë™í™” ì™„ë£Œ ë©”ì‹œì§€ í™•ì¸');
    System.debug('   â€¢ PaymentStatus Related List í™•ì¸');
    
    System.debug('');
    System.debug('âœ… =====ì‹ ê·œ Order ìë™í™” í…ŒìŠ¤íŠ¸ ì™„ë£Œ=====');
    System.debug('ğŸ“ ìƒì„±ëœ Order Number: ' + finalOrder.OrderNumber);
    
} catch (Exception e) {
    System.debug('âŒ ì‹ ê·œ Order ìë™í™” í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}
