/**
 * Order 00000155ì˜ ì±„ë„ ìƒíƒœ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸
 * ëª©ì : Slack ì±„ë„ì—ì„œ Salesforce ì±„ë„ë¡œ ì „í™˜ í™•ì¸
 */

// 1. Order 00000155 ì •ë³´ í™•ì¸
System.debug('=== ğŸ“‹ Order 00000155 ìƒì„¸ ì •ë³´ ===');
List<Order> orders = [
    SELECT Id, Name, OrderNumber, Status, 
           Slack_Channel_ID__c, Slack_Channel_Name__c, Slack_Webhook_URL__c, Slack_Notification_Status__c
    FROM Order 
    WHERE OrderNumber = '00000155'
    LIMIT 1
];

if(!orders.isEmpty()) {
    Order order155 = orders[0];
    System.debug('Order ID: ' + order155.Id);
    System.debug('Order Name: ' + order155.Name);
    System.debug('Order Number: ' + order155.OrderNumber);
    System.debug('Status: ' + order155.Status);
    System.debug('Slack Channel ID: ' + order155.Slack_Channel_ID__c);
    System.debug('Slack Channel Name: ' + order155.Slack_Channel_Name__c);
    System.debug('Slack Notification Status: ' + order155.Slack_Notification_Status__c);
    
    // 2. í•´ë‹¹ Orderì˜ Salesforce ì±„ë„(Chatter ê·¸ë£¹) í™•ì¸
    System.debug('\n=== ğŸ” Salesforce ì±„ë„ í™•ì¸ ===');
    List<CollaborationGroup> salesforceChannels = [
        SELECT Id, Name, Description, MemberCount, CreatedDate, LastReferencedDate
        FROM CollaborationGroup 
        WHERE Name LIKE '%00000155%' OR Name LIKE '%Order-155%' OR Name LIKE '%Order-00000155%'
    ];
    
    if(!salesforceChannels.isEmpty()) {
        System.debug('âœ… Salesforce ì±„ë„ ë°œê²¬!');
        for(CollaborationGroup channel : salesforceChannels) {
            System.debug('ì±„ë„ëª…: ' + channel.Name);
            System.debug('ì±„ë„ ID: ' + channel.Id);
            System.debug('ë©¤ë²„ ìˆ˜: ' + channel.MemberCount);
            System.debug('ìƒì„±ì¼: ' + channel.CreatedDate);
            System.debug('ìµœê·¼ í™œë™: ' + channel.LastReferencedDate);
        }
    } else {
        System.debug('âŒ Salesforce ì±„ë„ì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        
        // 3. Salesforce ì±„ë„ ìˆ˜ë™ ìƒì„±
        System.debug('\n=== ğŸš€ Salesforce ì±„ë„ ìˆ˜ë™ ìƒì„± ===');
        try {
            SalesforceChannelService channelService = new SalesforceChannelService();
            String newChannelId = channelService.createOrderChannel(order155.Id);
            
            if(newChannelId != null) {
                System.debug('âœ… ìƒˆ Salesforce ì±„ë„ ìƒì„± ì„±ê³µ!');
                System.debug('ìƒˆ ì±„ë„ ID: ' + newChannelId);
                
                // í˜„ì¬ ì‚¬ìš©ì ì¶”ê°€
                channelService.addUserToChannel(newChannelId, UserInfo.getUserId());
                
                // í™˜ì˜ ë©”ì‹œì§€
                channelService.postWelcomeMessage(newChannelId, order155.Id, order155.OrderNumber);
                
                System.debug('ğŸ“± Sales ì•±ì—ì„œ í™•ì¸:');
                System.debug('Chatter â†’ ê·¸ë£¹ â†’ "' + order155.OrderNumber + '" ê²€ìƒ‰');
                System.debug('ë˜ëŠ” URL: /lightning/r/CollaborationGroup/' + newChannelId + '/view');
            }
        } catch(Exception e) {
            System.debug('âŒ ì±„ë„ ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
} else {
    System.debug('âŒ Order 00000155ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
}

// 4. ì „ì²´ Order ì±„ë„ í˜„í™©
System.debug('\n=== ğŸ“Š ì „ì²´ Order ì±„ë„ í˜„í™© ===');
List<CollaborationGroup> allOrderChannels = [
    SELECT Id, Name, MemberCount, CreatedDate
    FROM CollaborationGroup 
    WHERE Name LIKE 'Order-%' OR Name LIKE '%00000%'
    ORDER BY CreatedDate DESC
    LIMIT 10
];

System.debug('ì´ ' + allOrderChannels.size() + 'ê°œì˜ Order ê´€ë ¨ ì±„ë„ ë°œê²¬:');
for(CollaborationGroup channel : allOrderChannels) {
    System.debug('- ' + channel.Name + ' (ë©¤ë²„: ' + channel.MemberCount + ', ìƒì„±: ' + channel.CreatedDate.format('MM/dd HH:mm') + ')');
}

// 5. ë‹¤ìŒ ë‹¨ê³„ ì•ˆë‚´
System.debug('\n=== ğŸ¯ ë‹¤ìŒ í™•ì¸ ë‹¨ê³„ ===');
System.debug('1. Sales ì•± â†’ Chatter â†’ ê·¸ë£¹ì—ì„œ Order-00000155 í™•ì¸');
System.debug('2. Order ë ˆì½”ë“œì—ì„œ Salesforce Channel ê´€ë ¨ í•„ë“œ ì¶”ê°€ í•„ìš”');
System.debug('3. Slack ì±„ë„ì—ì„œ Salesforce ì±„ë„ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ê³ ë ¤');
System.debug('4. PaymentNotificationDashboardì—ì„œ ì±„ë„ í†µê³„ í™•ì¸');

System.debug('\n=== âœ… ë¶„ì„ ì™„ë£Œ ===');
