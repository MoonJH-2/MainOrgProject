/**
 * ì˜ì—…ì‚¬ì› ì¤‘ì‹¬ Assets ê´€ë¦¬ ì‹œìŠ¤í…œ
 * ì‹¤ì œ êµ¬í˜„ ê°€ëŠ¥í•œ í•µì‹¬ ë¡œì§
 */

// ==========================================
// 1. ì˜ì—…ì‚¬ì› ìš°ì„ ìˆœìœ„ ê³ ê° ìë™ ë¶„ì„
// ==========================================

System.debug('=== ì˜ì—…ì‚¬ì› ì¤‘ì‹¬ Assets ìš°ì„ ìˆœìœ„ ë¶„ì„ ===');

// í˜„ì¬ ì‚¬ìš©ì (ì˜ì—…ì‚¬ì›) ID í™•ì¸
Id currentUserId = UserInfo.getUserId();
System.debug('ë¶„ì„ ëŒ€ìƒ ì˜ì—…ì‚¬ì›: ' + UserInfo.getName());

// ë‹´ë‹¹ Assets ì¡°íšŒ ë° ìš°ì„ ìˆœìœ„ ê³„ì‚°
List<Asset> myAssets = [
    SELECT Id, Name, AccountId, Account.Name, Account.Phone, Account.Industry,
           Status, InstallDate, Price, SerialNumber, Product2.Name,
           Account.OwnerId, LastModifiedDate
    FROM Asset 
    WHERE Account.OwnerId = :currentUserId
    AND Status IN ('Installed', 'Registered', 'Shipped')
    ORDER BY LastModifiedDate DESC
];

System.debug('ë‹´ë‹¹ Assets ì´ ' + myAssets.size() + 'ê°œ ë°œê²¬');

// ìš°ì„ ìˆœìœ„ ë¶„ì„ ë§µ
Map<Id, Decimal> priorityScores = new Map<Id, Decimal>();
Map<Id, String> actionRecommendations = new Map<Id, String>();

for (Asset asset : myAssets) {
    Decimal score = 0;
    String recommendation = '';
    
    // 1. ê°±ì‹  ì„ë°•ë„ ì ìˆ˜ (ìµœëŒ€ 40ì )
    if (asset.InstallDate != null) {
        Integer daysFromInstall = asset.InstallDate.daysBetween(Date.today());
        System.debug('Asset ' + asset.Name + ' ì‚¬ìš© ê¸°ê°„: ' + daysFromInstall + 'ì¼');
        
        if (daysFromInstall >= 300 && daysFromInstall <= 400) {
            score += 40;
            recommendation = 'ğŸ”¥ ê°±ì‹  ì ê¸° - ì¦‰ì‹œ ì—°ë½ í•„ìš”';
        } else if (daysFromInstall >= 250 && daysFromInstall < 300) {
            score += 30;
            recommendation = 'â° ê°±ì‹  ì¤€ë¹„ - 2ì£¼ ë‚´ ì ‘ì´‰';
        } else if (daysFromInstall >= 200 && daysFromInstall < 250) {
            score += 20;
            recommendation = 'ğŸ“… ê°±ì‹  ì˜ˆë¹„ - 1ê°œì›” ë‚´ ê´€ê³„ ê°•í™”';
        }
    } else {
        recommendation = 'ğŸ“‹ ì •ë³´ ì—…ë°ì´íŠ¸ í•„ìš”';
    }
    
    // 2. ë§¤ì¶œ ê·œëª¨ ì ìˆ˜ (ìµœëŒ€ 30ì )
    if (asset.Price != null) {
        if (asset.Price >= 10000000) {
            score += 30;
            System.debug('ê³ ì•¡ Asset: â‚©' + asset.Price.format());
        } else if (asset.Price >= 5000000) {
            score += 20;
        } else if (asset.Price >= 1000000) {
            score += 10;
        }
    }
    
    // 3. ê³ ê° í™œë™ì„± ì ìˆ˜ (ìµœëŒ€ 30ì )
    List<Task> recentTasks = [
        SELECT Id FROM Task 
        WHERE WhatId = :asset.AccountId 
        AND CreatedDate = LAST_N_DAYS:30
        LIMIT 10
    ];
    
    if (recentTasks.size() >= 5) {
        score += 30; // í™œë°œí•œ ì†Œí†µ
    } else if (recentTasks.size() >= 2) {
        score += 15; // ë³´í†µ ì†Œí†µ
    } else {
        score += 0; // ì†Œí†µ ë¶€ì¡±
        if (recommendation.length() < 20) {
            recommendation = 'ğŸ“ ê´€ê³„ íšŒë³µ í•„ìš” - ì•ˆë¶€ ì—°ë½';
        }
    }
    
    priorityScores.put(asset.Id, score);
    actionRecommendations.put(asset.Id, recommendation);
}

// ìš°ì„ ìˆœìœ„ TOP 5 ì¶œë ¥
System.debug('');
System.debug('ğŸ¯ TODAY\'S TOP 5 ìš°ì„ ìˆœìœ„ ê³ ê°:');
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

List<Asset> sortedAssets = new List<Asset>(myAssets);
// ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (ê°„ë‹¨í•œ ë²„ë¸” ì •ë ¬)
for (Integer i = 0; i < sortedAssets.size() - 1; i++) {
    for (Integer j = 0; j < sortedAssets.size() - 1 - i; j++) {
        Decimal score1 = priorityScores.get(sortedAssets[j].Id);
        Decimal score2 = priorityScores.get(sortedAssets[j + 1].Id);
        if (score1 < score2) {
            Asset temp = sortedAssets[j];
            sortedAssets[j] = sortedAssets[j + 1];
            sortedAssets[j + 1] = temp;
        }
    }
}

for (Integer i = 0; i < Math.min(5, sortedAssets.size()); i++) {
    Asset asset = sortedAssets[i];
    Decimal score = priorityScores.get(asset.Id);
    String action = actionRecommendations.get(asset.Id);
    
    System.debug((i + 1) + 'ìœ„. ' + asset.Account.Name + ' (' + score.format() + 'ì )');
    System.debug('    Asset: ' + asset.Name);
    System.debug('    ì „í™”: ' + (asset.Account.Phone != null ? asset.Account.Phone : 'N/A'));
    System.debug('    ê°€ì¹˜: â‚©' + (asset.Price != null ? asset.Price.format() : 'N/A'));
    System.debug('    ì•¡ì…˜: ' + action);
    System.debug('');
}

// ==========================================
// 2. ì¼ì¼ ë§¤ì¶œ ê¸°íšŒ ìë™ ê³„ì‚°
// ==========================================

System.debug('ğŸ“Š ì˜¤ëŠ˜ì˜ ë§¤ì¶œ ê¸°íšŒ ë¶„ì„:');
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

Decimal todaysPotential = 0;
Integer highPriorityActions = 0;

for (Asset asset : sortedAssets) {
    Decimal score = priorityScores.get(asset.Id);
    
    if (score >= 70) { // ê³ ìš°ì„ ìˆœìœ„
        highPriorityActions++;
        if (asset.Price != null) {
            // ê°±ì‹  í™•ë¥  ì ìš© (ë†’ì€ ìš°ì„ ìˆœìœ„ì¼ìˆ˜ë¡ ë†’ì€ í™•ë¥ )
            Decimal renewalProbability = score > 80 ? 0.8 : 0.6;
            todaysPotential += asset.Price * renewalProbability;
        }
    }
}

System.debug('ğŸ’° ì˜¤ëŠ˜ ì˜ˆìƒ ë§¤ì¶œ: â‚©' + todaysPotential.format());
System.debug('ğŸ¯ ê³ ìš°ì„ ìˆœìœ„ ì•¡ì…˜: ' + highPriorityActions + 'ê±´');
System.debug('â° ì˜ˆìƒ ì†Œìš”ì‹œê°„: ' + (highPriorityActions * 15) + 'ë¶„');

// ==========================================
// 3. ìë™ ì—…ë¬´ ìƒì„± ì‹œë®¬ë ˆì´ì…˜
// ==========================================

System.debug('');
System.debug('ğŸ¤– ìë™ ì—…ë¬´ ìƒì„± ì‹œë®¬ë ˆì´ì…˜:');
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

Integer tasksCreated = 0;
Integer opportunitiesRecommended = 0;

for (Integer i = 0; i < Math.min(3, sortedAssets.size()); i++) {
    Asset asset = sortedAssets[i];
    Decimal score = priorityScores.get(asset.Id);
    
    if (score >= 60) {
        System.debug('âœ… ' + asset.Account.Name + ' ëŒ€ìƒ ìë™ ìƒì„±:');
        
        // Task ìƒì„± ì‹œë®¬ë ˆì´ì…˜
        System.debug('  ğŸ“‹ Task: "' + asset.Account.Name + ' ê°±ì‹  ë…¼ì˜ í†µí™”"');
        System.debug('      - ìš°ì„ ìˆœìœ„: High');
        System.debug('      - ì˜ˆì •ì¼: ' + Date.today().addDays(1).format());
        System.debug('      - ì˜ˆìƒ ë§¤ì¶œ: â‚©' + (asset.Price != null ? asset.Price.format() : 'N/A'));
        tasksCreated++;
        
        // Opportunity ì¶”ì²œ ì‹œë®¬ë ˆì´ì…˜
        if (score >= 80) {
            System.debug('  ğŸ¯ Opportunity ì¶”ì²œ: "' + asset.Account.Name + ' - ' + asset.Product2?.Name + ' ê°±ì‹ "');
            System.debug('      - í™•ë¥ : 80%');
            System.debug('      - ì˜ˆìƒ Close: ' + Date.today().addDays(30).format());
            opportunitiesRecommended++;
        }
        
        System.debug('');
    }
}

System.debug('ğŸ“‹ ìƒì„± ì˜ˆì • Tasks: ' + tasksCreated + 'ê±´');
System.debug('ğŸ¯ ì¶”ì²œ Opportunities: ' + opportunitiesRecommended + 'ê±´');

// ==========================================
// 4. ì˜ì—…ì‚¬ì› ì„±ê³¼ ì˜ˆì¸¡
// ==========================================

System.debug('');
System.debug('ğŸ“ˆ ì´ë²ˆ ë‹¬ ì„±ê³¼ ì˜ˆì¸¡:');
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

// ì´ë²ˆ ë‹¬ ê¸°ì¡´ ì„±ê³¼ ì¡°íšŒ
List<Opportunity> thisMonthWins = [
    SELECT Id, Amount, CloseDate 
    FROM Opportunity 
    WHERE OwnerId = :currentUserId 
    AND StageName = 'Closed Won'
    AND CloseDate = THIS_MONTH
];

Decimal currentMonthRevenue = 0;
for (Opportunity opp : thisMonthWins) {
    currentMonthRevenue += opp.Amount != null ? opp.Amount : 0;
}

System.debug('ğŸ’° ì´ë²ˆ ë‹¬ ê¸°ë‹¬ì„± ë§¤ì¶œ: â‚©' + currentMonthRevenue.format());
System.debug('ğŸ¯ Assets ê¸°ë°˜ ì¶”ê°€ ì˜ˆìƒ: â‚©' + todaysPotential.format());
System.debug('ğŸ“Š ì›”ë§ ì˜ˆìƒ ì´ ë§¤ì¶œ: â‚©' + (currentMonthRevenue + todaysPotential).format());

// ì„±ê³¼ ë“±ê¸‰ ê³„ì‚°
String performanceGrade;
Decimal totalExpected = currentMonthRevenue + todaysPotential;

if (totalExpected >= 100000000) {
    performanceGrade = 'ğŸ‘‘ LEGEND (1ì–µì› ì´ìƒ)';
} else if (totalExpected >= 50000000) {
    performanceGrade = 'ğŸ’ DIAMOND (5ì²œë§Œì› ì´ìƒ)';
} else if (totalExpected >= 25000000) {
    performanceGrade = 'ğŸ¥‡ GOLD (2ì²œ5ë°±ë§Œì› ì´ìƒ)';
} else if (totalExpected >= 10000000) {
    performanceGrade = 'ğŸ¥ˆ SILVER (1ì²œë§Œì› ì´ìƒ)';
} else {
    performanceGrade = 'ğŸ¥‰ BRONZE (1ì²œë§Œì› ë¯¸ë§Œ)';
}

System.debug('ğŸ† ì˜ˆìƒ ì„±ê³¼ ë“±ê¸‰: ' + performanceGrade);

// ==========================================
// 5. ì‹¤í–‰ ê³„íš ìš”ì•½
// ==========================================

System.debug('');
System.debug('ğŸ¯ ì˜¤ëŠ˜ì˜ ì‹¤í–‰ ê³„íš:');
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

System.debug('â° ì˜¤ì „ (30ë¶„):');
System.debug('  1. TOP ' + Math.min(3, highPriorityActions) + ' ê³ ê° ìš°ì„  ì—°ë½');
System.debug('  2. ê°±ì‹  ê´€ë ¨ ' + tasksCreated + 'ê±´ Task ì²˜ë¦¬');
System.debug('  3. ì˜ˆìƒ ë§¤ì¶œ: â‚©' + (todaysPotential * 0.3).format() + ' (30% í™•ë¥ )');

System.debug('');
System.debug('ğŸƒ ì˜¤í›„ (60ë¶„):');
System.debug('  1. ' + opportunitiesRecommended + 'ê±´ Opportunity ìƒì„±/ê´€ë¦¬');
System.debug('  2. ê´€ê³„ ê°•í™” í™œë™ (ë§Œì¡±ë„ ë†’ì€ ê³ ê°)');
System.debug('  3. ë‹¤ìŒì£¼ ê³„íš ìˆ˜ë¦½');

System.debug('');
System.debug('ğŸŒ™ ë§ˆë¬´ë¦¬ (30ë¶„):');
System.debug('  1. Assets ì •ë³´ ì—…ë°ì´íŠ¸');
System.debug('  2. ë‚´ì¼ ìš°ì„ ìˆœìœ„ ê³ ê° í™•ì¸');
System.debug('  3. ì„±ê³¼ ë¶„ì„ ë° ê°œì„ ì  íŒŒì•…');

System.debug('');
System.debug('âœ… Assets ê¸°ë°˜ ìŠ¤ë§ˆíŠ¸ ì˜ì—… ì‹œìŠ¤í…œ ë¶„ì„ ì™„ë£Œ!');
System.debug('ğŸ’¡ ' + UserInfo.getName() + 'ë‹˜ì˜ ì˜¤ëŠ˜ ì˜ˆìƒ ì„±ê³¼: â‚©' + todaysPotential.format());
System.debug('ğŸš€ íš¨ìœ¨ì ì¸ ì˜ì—… í™œë™ìœ¼ë¡œ ëª©í‘œ ë‹¬ì„±í•˜ì„¸ìš”!');
