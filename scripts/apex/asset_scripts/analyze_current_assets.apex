/**
 * í˜„ì¬ Asset ìƒíƒœ ë¶„ì„ ë° 300ì¼ ì¡°ê±´ í™•ì¸
 * ëª©ì : ì™œ ëŒ€ì‹œë³´ë“œì— ë°ì´í„°ê°€ í‘œì‹œë˜ì§€ ì•ŠëŠ”ì§€ ì›ì¸ íŒŒì•…
 */

System.debug('ğŸ” === Asset ìƒíƒœ ë¶„ì„ ì‹œì‘ ===');

try {
    // 1. í˜„ì¬ ìƒì„±ëœ ëª¨ë“  Asset í™•ì¸
    List<Asset> allAssets = [
        SELECT Id, Name, AccountId, Account.Name, Status, Price, InstallDate, UsageEndDate, 
               CreatedDate, LastModifiedDate
        FROM Asset 
        WHERE Account.Name LIKE '%í…ŒìŠ¤íŠ¸%' OR Account.Name LIKE '%ìš°ìˆ˜%' OR Account.Name LIKE '%ì£¼ì˜%'
        ORDER BY CreatedDate DESC
    ];
    
    System.debug('ğŸ“Š ì´ Asset ìˆ˜: ' + allAssets.size());
    
    for(Asset a : allAssets) {
        Integer daysSinceInstall = a.InstallDate != null ? a.InstallDate.daysBetween(Date.today()) : 0;
        Integer daysUntilExpiry = a.UsageEndDate != null ? Date.today().daysBetween(a.UsageEndDate) : 0;
        
        System.debug('Asset: ' + a.Name);
        System.debug('  - Account: ' + a.Account?.Name);
        System.debug('  - Status: ' + a.Status);
        System.debug('  - Price: ' + a.Price);
        System.debug('  - InstallDate: ' + a.InstallDate);
        System.debug('  - UsageEndDate: ' + a.UsageEndDate);
        System.debug('  - ì„¤ì¹˜ í›„ ê²½ê³¼ì¼: ' + daysSinceInstall + 'ì¼');
        System.debug('  - ë§Œë£Œê¹Œì§€: ' + daysUntilExpiry + 'ì¼');
        System.debug('  - 300ì¼ ì´ìƒ?: ' + (daysSinceInstall >= 300));
        System.debug('');
    }
    
    // 2. ìš°ì„ ìˆœìœ„ ê³„ì‚° ë¡œì§ í…ŒìŠ¤íŠ¸ (í˜„ì¬ ì¡°ê±´)
    System.debug('ğŸ” í˜„ì¬ ìš°ì„ ìˆœìœ„ ë¡œì§ í…ŒìŠ¤íŠ¸ (300ì¼ ì¡°ê±´)');
    List<Asset> currentPriorityAssets = [
        SELECT Id, Name, AccountId, Account.Name, Price, InstallDate, UsageEndDate, Status
        FROM Asset 
        WHERE Status = 'Installed' 
        AND InstallDate != null
        AND UsageEndDate != null
        AND InstallDate <= :Date.today().addDays(-300)  // 300ì¼ ì¡°ê±´
        ORDER BY Price DESC
    ];
    System.debug('300ì¼ ì¡°ê±´ Asset ìˆ˜: ' + currentPriorityAssets.size());
    
    // 3. ì›í´ë¦­ ê°±ì‹  ë¡œì§ í…ŒìŠ¤íŠ¸ (í˜„ì¬ ì¡°ê±´)
    System.debug('ğŸ” í˜„ì¬ ì›í´ë¦­ ê°±ì‹  ë¡œì§ í…ŒìŠ¤íŠ¸ (300ì¼ ì¡°ê±´)');
    List<Asset> currentRenewalAssets = [
        SELECT Id, Name, AccountId, Account.Name, Price, InstallDate, UsageEndDate, Status
        FROM Asset 
        WHERE Status = 'Installed'
        AND InstallDate <= :Date.today().addDays(-300)  // 300ì¼ ì¡°ê±´
        AND UsageEndDate >= :Date.today()
    ];
    System.debug('300ì¼ ì¡°ê±´ ê°±ì‹  ê°€ëŠ¥ Asset ìˆ˜: ' + currentRenewalAssets.size());
    
    // 4. ìƒˆë¡œìš´ ì¡°ê±´ í…ŒìŠ¤íŠ¸ (1ì¼ ì¡°ê±´)
    System.debug('ğŸ” ìƒˆë¡œìš´ ìš°ì„ ìˆœìœ„ ë¡œì§ í…ŒìŠ¤íŠ¸ (1ì¼ ì¡°ê±´)');
    List<Asset> newPriorityAssets = [
        SELECT Id, Name, AccountId, Account.Name, Price, InstallDate, UsageEndDate, Status
        FROM Asset 
        WHERE Status = 'Installed' 
        AND InstallDate != null
        AND UsageEndDate != null
        AND InstallDate <= :Date.today().addDays(-1)  // 1ì¼ ì¡°ê±´ìœ¼ë¡œ ë³€ê²½
        ORDER BY Price DESC
    ];
    System.debug('1ì¼ ì¡°ê±´ Asset ìˆ˜: ' + newPriorityAssets.size());
    
    // 5. ìƒˆë¡œìš´ ì›í´ë¦­ ê°±ì‹  ë¡œì§ í…ŒìŠ¤íŠ¸ (1ì¼ ì¡°ê±´)
    System.debug('ğŸ” ìƒˆë¡œìš´ ì›í´ë¦­ ê°±ì‹  ë¡œì§ í…ŒìŠ¤íŠ¸ (1ì¼ ì¡°ê±´)');
    List<Asset> newRenewalAssets = [
        SELECT Id, Name, AccountId, Account.Name, Price, InstallDate, UsageEndDate, Status
        FROM Asset 
        WHERE Status = 'Installed'
        AND InstallDate <= :Date.today().addDays(-1)  // 1ì¼ ì¡°ê±´ìœ¼ë¡œ ë³€ê²½
        AND UsageEndDate >= :Date.today()
    ];
    System.debug('1ì¼ ì¡°ê±´ ê°±ì‹  ê°€ëŠ¥ Asset ìˆ˜: ' + newRenewalAssets.size());
    
    // 6. ê´€ë ¨ Opportunity í™•ì¸
    System.debug('ğŸ” ê´€ë ¨ Opportunity í™•ì¸');
    List<Opportunity> relatedOpps = [
        SELECT Id, Name, AccountId, Account.Name, StageName, CloseDate, Amount, Type, CreatedDate
        FROM Opportunity 
        WHERE Account.Name LIKE '%í…ŒìŠ¤íŠ¸%' OR Account.Name LIKE '%ìš°ìˆ˜%' OR Account.Name LIKE '%ì£¼ì˜%'
        ORDER BY CreatedDate DESC
    ];
    System.debug('ê´€ë ¨ Opportunity ìˆ˜: ' + relatedOpps.size());
    
    for(Opportunity opp : relatedOpps) {
        System.debug('Opportunity: ' + opp.Name);
        System.debug('  - Account: ' + opp.Account?.Name);
        System.debug('  - Stage: ' + opp.StageName);
        System.debug('  - Amount: ' + opp.Amount);
        System.debug('  - Type: ' + opp.Type);
        System.debug('  - CloseDate: ' + opp.CloseDate);
        System.debug('');
    }
    
} catch(Exception e) {
    System.debug('âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('âŒ ìŠ¤íƒ: ' + e.getStackTraceString());
}

System.debug('ğŸ” === Asset ìƒíƒœ ë¶„ì„ ì™„ë£Œ ===');
