/**
 * Account ê¸°ë°˜ Asset ìë™ ìƒì„± ì‹œìŠ¤í…œ ì¢…í•© í…ŒìŠ¤íŠ¸
 * PaymentStatus ì™„ë‚© â†’ Account ë¶„ì„ â†’ Asset ìƒì„± â†’ í›„ì† ì•¡ì…˜
 */

System.debug('=== Account ê¸°ë°˜ Asset ìë™ ìƒì„± ì‹œìŠ¤í…œ ì¢…í•© í…ŒìŠ¤íŠ¸ ===');

// 1. Orderì™€ Account ì •ë³´ ì¡°íšŒ
List<Order> testOrders = [
    SELECT Id, OrderNumber, AccountId, Account.Name, Account.Industry,
           Account.NumberOfEmployees, Account.AnnualRevenue, Account.Key_Account__c,
           Account.CustomerPriority__c, Account.Manager__c,
           TotalAmount, Status, EffectiveDate, EndDate, Contact__c, OwnerId
    FROM Order 
    WHERE AccountId != null
    ORDER BY CreatedDate DESC
    LIMIT 5
];

System.debug('í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•œ Order ê°œìˆ˜: ' + testOrders.size());

for (Order ord : testOrders) {
    System.debug('\n=== Order: ' + ord.OrderNumber + ' ===');
    System.debug('ê³ ê°: ' + ord.Account.Name);
    System.debug('ì‚°ì—…êµ°: ' + (ord.Account.Industry ?? 'ë¯¸ë¶„ë¥˜'));
    System.debug('ì§ì›ìˆ˜: ' + (ord.Account.NumberOfEmployees != null ? ord.Account.NumberOfEmployees.format() : 'ë¯¸í™•ì¸') + 'ëª…');
    System.debug('ì—°ë§¤ì¶œ: ' + (ord.Account.AnnualRevenue != null ? ord.Account.AnnualRevenue.format() : 'ë¯¸í™•ì¸') + 'ì›');
    System.debug('Key Account: ' + (ord.Account.Key_Account__c ? 'Yes' : 'No'));
    System.debug('ìš°ì„ ìˆœìœ„: ' + (ord.Account.CustomerPriority__c ?? 'ì¼ë°˜'));
    // System.debug('Einstein Tier: ' + (ord.Account.Tier ?? 'ë¯¸ë¶„ë¥˜'));
    System.debug('Account Manager: ' + (ord.Account.Manager__c != null ? 'Assigned' : 'None'));
    System.debug('Order ê¸ˆì•¡: ' + (ord.TotalAmount != null ? ord.TotalAmount.format() : '0') + 'ì›');
    
    // PaymentStatus í˜„í™© í™•ì¸
    List<PaymentStatus__c> payments = [
        SELECT Id, InstallmentNumber__c, Amount__c, Status__c, DueDate__c
        FROM PaymentStatus__c 
        WHERE Order__c = :ord.Id
        ORDER BY InstallmentNumber__c
    ];
    
    System.debug('PaymentStatus ê°œìˆ˜: ' + payments.size());
    
    if (!payments.isEmpty()) {
        Integer totalPayments = payments.size();
        Integer completedPayments = 0;
        Decimal totalAmount = 0;
        Decimal paidAmount = 0;
        
        for (PaymentStatus__c ps : payments) {
            if (ps.Amount__c != null) {
                totalAmount += ps.Amount__c;
            }
            
            String statusInfo = '  ' + ps.InstallmentNumber__c + 'ì°¨: ';
            statusInfo += (ps.Amount__c != null ? ps.Amount__c.format() : '0') + 'ì›';
            statusInfo += ' [' + ps.Status__c + ']';
            
            if (ps.DueDate__c != null) {
                statusInfo += ' ì˜ˆì •: ' + ps.DueDate__c.format();
            }
            // if (ps.PaidDate__c != null) {
            //     statusInfo += ' ë‚©ë¶€: ' + ps.PaidDate__c.format();
            // }
            
            System.debug(statusInfo);
            
            if (ps.Status__c == 'ì™„ë‚©') {
                completedPayments++;
                if (ps.Amount__c != null) {
                    paidAmount += ps.Amount__c;
                }
            }
        }
        
        Boolean isFullyPaid = (totalPayments > 0 && totalPayments == completedPayments);
        System.debug('ë‚©ë¶€ í˜„í™©: ' + completedPayments + '/' + totalPayments + ' ì™„ë‚©');
        System.debug('ê¸ˆì•¡ í˜„í™©: ' + paidAmount.format() + '/' + totalAmount.format() + 'ì›');
        System.debug('ì™„ë‚© ìƒíƒœ: ' + isFullyPaid);
        
        // ê¸°ì¡´ Asset í™•ì¸
        List<Asset> existingAssets = [
            SELECT Id, Name, Status, CreatedDate
            FROM Asset 
            WHERE SerialNumber = :ord.OrderNumber
        ];
        
        if (!existingAssets.isEmpty()) {
            System.debug('ê¸°ì¡´ Asset ì¡´ì¬: ' + existingAssets[0].Name + ' (' + existingAssets[0].Status + ')');
        } else {
            System.debug('ê¸°ì¡´ Asset ì—†ìŒ');
            
            if (isFullyPaid) {
                System.debug('\nğŸ¯ ì™„ë‚© Order ë°œê²¬! Account ê¸°ë°˜ Asset ìƒì„± í…ŒìŠ¤íŠ¸...');
                
                try {
                    // Account ê¸°ë°˜ Asset ìƒì„± í…ŒìŠ¤íŠ¸
                    Asset newAsset = AccountBasedAssetService.createAssetWithAccountAnalysis(ord.Id);
                    
                    if (newAsset != null) {
                        System.debug('âœ… Account ê¸°ë°˜ Asset ìƒì„± ì„±ê³µ!');
                        System.debug('- Asset ID: ' + newAsset.Id);
                        System.debug('- Asset Name: ' + newAsset.Name);
                        System.debug('- Serial Number: ' + newAsset.SerialNumber);
                        System.debug('- Price: ' + (newAsset.Price != null ? newAsset.Price.format() : '0') + 'ì›');
                        
                        // ìƒì„±ëœ Asset ìƒì„¸ ì¡°íšŒ
                        Asset assetDetail = [
                            SELECT Id, Name, SerialNumber, AccountId, Account.Name,
                                   ContactId, PurchaseDate, InstallDate, LifecycleEndDate,
                                   LifecycleStartDate, Status, Price, Description
                            FROM Asset 
                            WHERE Id = :newAsset.Id
                        ];
                        
                        System.debug('\n--- Account ê¸°ë°˜ Asset ìƒì„¸ ì •ë³´ ---');
                        System.debug('ê³ ê°: ' + assetDetail.Account.Name);
                        System.debug('êµ¬ë§¤ì¼: ' + (assetDetail.PurchaseDate != null ? assetDetail.PurchaseDate.format() : 'ì—†ìŒ'));
                        System.debug('ì„¤ì¹˜ì¼: ' + (assetDetail.InstallDate != null ? assetDetail.InstallDate.format() : 'ì—†ìŒ'));
                        System.debug('Lifecycle ì‹œì‘: ' + (assetDetail.LifecycleStartDate != null ? assetDetail.LifecycleStartDate.format() : 'ì—†ìŒ'));
                        System.debug('Lifecycle ì¢…ë£Œ: ' + (assetDetail.LifecycleEndDate != null ? assetDetail.LifecycleEndDate.format() : 'ì—†ìŒ'));
                        System.debug('ìƒíƒœ: ' + assetDetail.Status);
                        
                        // Description ë¯¸ë¦¬ë³´ê¸° (ì²˜ìŒ 500ì)
                        if (String.isNotBlank(assetDetail.Description)) {
                            String descPreview = assetDetail.Description.length() > 500 ? 
                                assetDetail.Description.substring(0, 500) + '...' : 
                                assetDetail.Description;
                            System.debug('\nDescription ë¯¸ë¦¬ë³´ê¸°:\n' + descPreview);
                        }
                        
                        // ìƒì„±ëœ Task í™•ì¸
                        List<Task> relatedTasks = [
                            SELECT Id, Subject, Priority, Status, ActivityDate, Owner.Name
                            FROM Task 
                            WHERE WhatId = :newAsset.Id
                            ORDER BY CreatedDate DESC
                        ];
                        
                        if (!relatedTasks.isEmpty()) {
                            System.debug('\n--- ìƒì„±ëœ í›„ì† Task ---');
                            for (Task t : relatedTasks) {
                                System.debug('- ' + t.Subject + ' (' + t.Priority + ') â†’ ' + t.Owner.Name);
                                System.debug('  ì˜ˆì •ì¼: ' + (t.ActivityDate != null ? t.ActivityDate.format() : 'ë¯¸ì •'));
                            }
                        }
                        
                        break; // ì²« ë²ˆì§¸ ì„±ê³µ í›„ ì¢…ë£Œ
                    }
                    
                } catch (Exception e) {
                    System.debug('âŒ Account ê¸°ë°˜ Asset ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
                    System.debug('Stack Trace: ' + e.getStackTraceString());
                }
            } else {
                System.debug('âš ï¸ ì•„ì§ ì™„ë‚©ë˜ì§€ ì•Šì€ Orderì…ë‹ˆë‹¤.');
            }
        }
    } else {
        System.debug('PaymentStatusê°€ ì—†ëŠ” Orderì…ë‹ˆë‹¤.');
    }
}

// ì „ì²´ ì‹œìŠ¤í…œ ìƒíƒœ ìš”ì•½
System.debug('\n=== ì „ì²´ Asset ì‹œìŠ¤í…œ í˜„í™© ===');

// Asset ì´ ê°œìˆ˜
Integer totalAssets = [SELECT COUNT() FROM Asset];
System.debug('ì „ì²´ Asset ê°œìˆ˜: ' + totalAssets);

// ì˜¤ëŠ˜ ìƒì„±ëœ Asset
List<Asset> todayAssets = [
    SELECT Id, Name, SerialNumber, Account.Name, Price, CreatedDate
    FROM Asset 
    WHERE CreatedDate = TODAY
    ORDER BY CreatedDate DESC
    LIMIT 5
];

System.debug('ì˜¤ëŠ˜ ìƒì„±ëœ Asset: ' + todayAssets.size() + 'ê°œ');
for (Asset asset : todayAssets) {
    System.debug('- ' + asset.Name + ' (' + asset.Account.Name + ') ' + 
                (asset.Price != null ? asset.Price.format() : '0') + 'ì›');
}

// ìµœê·¼ Task í™•ì¸
List<Task> recentAssetTasks = [
    SELECT Id, Subject, Priority, Status, Owner.Name, What.Name
    FROM Task 
    WHERE What.Type = 'Asset'
    AND CreatedDate = TODAY
    ORDER BY CreatedDate DESC
    LIMIT 5
];

System.debug('ì˜¤ëŠ˜ ìƒì„±ëœ Asset ê´€ë ¨ Task: ' + recentAssetTasks.size() + 'ê°œ');
for (Task task : recentAssetTasks) {
    System.debug('- ' + task.Subject + ' (' + task.Priority + ') â†’ ' + task.Owner.Name);
}

System.debug('\n=== Account ê¸°ë°˜ Asset ìë™ ìƒì„± ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');

// PaymentStatus íŠ¸ë¦¬ê±° í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ
System.debug('\n=== PaymentStatus íŠ¸ë¦¬ê±° í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ ===');
System.debug('1. PaymentStatusì˜ Status__cë¥¼ "ì™„ë‚©"ìœ¼ë¡œ ë³€ê²½');
System.debug('2. PaymentStatusAssetTriggerê°€ ìë™ ì‹¤í–‰');
System.debug('3. AccountBasedAssetService.createAssetWithAccountAnalysis() í˜¸ì¶œ');
System.debug('4. Account ë¶„ì„ ê¸°ë°˜ Asset ìƒì„± ë° í›„ì† ì•¡ì…˜ ìˆ˜í–‰');
System.debug('5. Account Manager, Key Account, ê³ ìš°ì„ ìˆœìœ„ ê³ ê°ë³„ ë§ì¶¤ Task ìƒì„±');
