/**
 * Salesforce Assets ì‹¤ì œ í™œìš© ì‹œì—°
 * Order 00000153 ê¸°ë°˜ Asset ë¼ì´í”„ì‚¬ì´í´ ê´€ë¦¬ ì˜ˆì‹œ
 */

System.debug('=== Salesforce Assets í™œìš© ì‹œì—° ===');
System.debug('Order 00000153 -> Asset ìƒì„± -> ë¼ì´í”„ì‚¬ì´í´ ê´€ë¦¬');
System.debug('');

// ==========================================
// 1ë‹¨ê³„: Orderì—ì„œ Asset ìë™ ìƒì„± ì‹œì—°
// ==========================================
System.debug('ğŸ“ 1ë‹¨ê³„: Order ê¸°ë°˜ Asset ìƒì„±');
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

// Order 00000153 ì¡°íšŒ
List<Order> testOrders = [
    SELECT Id, OrderNumber, AccountId, Account.Name, Account.Industry,
           TotalAmount, Status, EffectiveDate, CreatedDate
    FROM Order 
    WHERE OrderNumber = '00000153'
    LIMIT 1
];

if (testOrders.isEmpty()) {
    System.debug('âš ï¸ Order 00000153ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
}

Order testOrder = testOrders[0];
System.debug('ğŸ¯ Order ì •ë³´:');
System.debug('  - Order Number: ' + testOrder.OrderNumber);
System.debug('  - Account: ' + testOrder.Account.Name);
System.debug('  - Total Amount: ' + testOrder.TotalAmount?.format());
System.debug('  - Status: ' + testOrder.Status);
System.debug('  - Created Date: ' + testOrder.CreatedDate.format());

// ì—°ê²°ëœ Asset ì¡°íšŒ
List<Asset> existingAssets = [
    SELECT Id, Name, Status, SerialNumber, PurchaseDate, InstallDate,
           Price, Account.Name, Product2.Name
    FROM Asset 
    WHERE SerialNumber = :testOrder.OrderNumber
    OR Name LIKE '%' + testOrder.OrderNumber + '%'
];

System.debug('');
System.debug('ğŸ­ ì—°ê²°ëœ Assets:');
if (existingAssets.isEmpty()) {
    System.debug('  - ì—°ê²°ëœ Assetì´ ì—†ìŠµë‹ˆë‹¤.');
} else {
    for (Asset asset : existingAssets) {
        System.debug('  âœ… Asset: ' + asset.Name);
        System.debug('    - Serial Number: ' + asset.SerialNumber);
        System.debug('    - Status: ' + asset.Status);
        System.debug('    - Purchase Date: ' + (asset.PurchaseDate != null ? asset.PurchaseDate.format() : 'N/A'));
        System.debug('    - Install Date: ' + (asset.InstallDate != null ? asset.InstallDate.format() : 'N/A'));
        System.debug('    - Price: ' + (asset.Price != null ? asset.Price.format() : 'N/A'));
    }
}

System.debug('');

// ==========================================
// 2ë‹¨ê³„: Asset Health Score ê³„ì‚°
// ==========================================
System.debug('ğŸ“ 2ë‹¨ê³„: Asset Health Score ë¶„ì„');
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

for (Asset asset : existingAssets) {
    System.debug('ğŸ¥ Asset Health ë¶„ì„: ' + asset.Name);
    
    // ê¸°ë³¸ ê±´ê°•ë„ ì ìˆ˜ (100ì  ë§Œì )
    Decimal healthScore = 100;
    
    // 1. ì‚¬ìš© ê¸°ê°„ ë¶„ì„
    if (asset.InstallDate != null) {
        Integer daysUsed = asset.InstallDate.daysBetween(Date.today());
        System.debug('  ğŸ“… ì‚¬ìš© ê¸°ê°„: ' + daysUsed + 'ì¼');
        
        if (daysUsed > 365) {
            healthScore -= 10; // 1ë…„ ì´ìƒ ì‚¬ìš© ì‹œ ë…¸í›„í™” ì ìˆ˜ ê°ì†Œ
            System.debug('  âš ï¸ ì¥ê¸° ì‚¬ìš©: -10ì  (ë…¸í›„í™”)');
        }
    }
    
    // 2. Support Case ë¶„ì„
    List<Case> recentCases = [
        SELECT Id, Subject, Status, Priority, CreatedDate
        FROM Case 
        WHERE AssetId = :asset.Id 
        AND CreatedDate = LAST_N_DAYS:30
    ];
    
    System.debug('  ğŸ« ìµœê·¼ 30ì¼ Support Cases: ' + recentCases.size() + 'ê±´');
    if (recentCases.size() > 0) {
        healthScore -= (recentCases.size() * 5); // ì¼€ì´ìŠ¤ 1ê±´ë‹¹ 5ì ì”© ê°ì†Œ
        System.debug('  âš ï¸ Support Cases: -' + (recentCases.size() * 5) + 'ì ');
        
        for (Case c : recentCases) {
            System.debug('    - ' + c.Subject + ' (' + c.Status + ', ' + c.Priority + ')');
        }
    }
    
    // 3. ìµœì¢… ê±´ê°•ë„ ì ìˆ˜
    healthScore = Math.max(0, Math.min(100, healthScore));
    System.debug('  ğŸ¯ ìµœì¢… Health Score: ' + healthScore.format() + '/100');
    
    // ê±´ê°•ë„ ë“±ê¸‰ ë¶„ë¥˜
    String healthGrade;
    String healthColor;
    
    if (healthScore >= 90) {
        healthGrade = 'A+ (Excellent)';
        healthColor = 'ğŸŸ¢';
    } else if (healthScore >= 80) {
        healthGrade = 'A (Very Good)';
        healthColor = 'ğŸŸ¢';
    } else if (healthScore >= 70) {
        healthGrade = 'B (Good)';
        healthColor = 'ğŸŸ¡';
    } else if (healthScore >= 60) {
        healthGrade = 'C (Fair)';
        healthColor = 'ğŸŸ¡';
    } else if (healthScore >= 50) {
        healthGrade = 'D (Poor)';
        healthColor = 'ğŸŸ ';
    } else {
        healthGrade = 'F (Critical)';
        healthColor = 'ğŸ”´';
    }
    
    System.debug('  ' + healthColor + ' ê±´ê°•ë„ ë“±ê¸‰: ' + healthGrade);
    System.debug('');
}

// ==========================================
// 3ë‹¨ê³„: ê°±ì‹  ê¸°íšŒ ë¶„ì„
// ==========================================
System.debug('ğŸ“ 3ë‹¨ê³„: ê°±ì‹  ë° í™•ì¥ ê¸°íšŒ ë¶„ì„');
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

for (Asset asset : existingAssets) {
    System.debug('ğŸ’° ê°±ì‹  ë¶„ì„: ' + asset.Name);
    
    // ê°±ì‹  í™•ë¥  ê³„ì‚° (ë‹¨ìˆœ ì˜ˆì‹œ)
    Decimal renewalProbability = 50; // ê¸°ë³¸ 50%
    
    // 1. ì‚¬ìš© ê¸°ê°„ ê¸°ë°˜ ì¡°ì •
    if (asset.InstallDate != null) {
        Integer daysUsed = asset.InstallDate.daysBetween(Date.today());
        if (daysUsed > 180) { // 6ê°œì›” ì´ìƒ ì‚¬ìš©
            renewalProbability += 20;
            System.debug('  âœ… ì•ˆì •ì  ì‚¬ìš© ê¸°ê°„: +20% (í˜„ì¬ ' + renewalProbability + '%)');
        }
    }
    
    // 2. Support ì´ë ¥ ê¸°ë°˜ ì¡°ì •
    Integer totalCases = [
        SELECT COUNT() 
        FROM Case 
        WHERE AssetId = :asset.Id
    ];
    
    if (totalCases == 0) {
        renewalProbability += 15;
        System.debug('  âœ… ë¬¸ì œ ì—†ëŠ” ì‚¬ìš©: +15% (í˜„ì¬ ' + renewalProbability + '%)');
    } else if (totalCases <= 2) {
        renewalProbability += 5;
        System.debug('  âœ… ìµœì†Œí•œì˜ ë¬¸ì œ: +5% (í˜„ì¬ ' + renewalProbability + '%)');
    } else {
        renewalProbability -= 10;
        System.debug('  âš ï¸ ë‹¤ìˆ˜ ë¬¸ì œ ë°œìƒ: -10% (í˜„ì¬ ' + renewalProbability + '%)');
    }
    
    // 3. Account ê´€ê³„ ê¸°ë°˜ ì¡°ì • (Order ì™„ë‚© ì—¬ë¶€)
    List<PaymentStatus__c> payments = [
        SELECT Status__c 
        FROM PaymentStatus__c 
        WHERE Order__c = :testOrder.Id
    ];
    
    Boolean isFullyPaid = true;
    for (PaymentStatus__c payment : payments) {
        if (payment.Status__c != 'ì™„ë‚©') {
            isFullyPaid = false;
            break;
        }
    }
    
    if (isFullyPaid) {
        renewalProbability += 25;
        System.debug('  âœ… ì™„ë²½í•œ ê²°ì œ ì´ë ¥: +25% (í˜„ì¬ ' + renewalProbability + '%)');
    }
    
    // ìµœì¢… ê°±ì‹  í™•ë¥ 
    renewalProbability = Math.max(0, Math.min(100, renewalProbability));
    System.debug('  ğŸ¯ ìµœì¢… ê°±ì‹  í™•ë¥ : ' + renewalProbability.format() + '%');
    
    // ì¶”ì²œ ì•¡ì…˜
    System.debug('  ğŸ“‹ ì¶”ì²œ ì•¡ì…˜:');
    if (renewalProbability >= 80) {
        System.debug('    ğŸŸ¢ HIGH: ì ê·¹ì  ê°±ì‹  ì œì•ˆ, ì—…ê·¸ë ˆì´ë“œ ì˜µì…˜ ì œì‹œ');
        System.debug('    ğŸ’¡ ê°±ì‹  4ì£¼ ì „ ì ‘ì´‰ ì‹œì‘');
        System.debug('    ğŸ ì–¼ë¦¬ë²„ë“œ í• ì¸ ì œì•ˆ');
    } else if (renewalProbability >= 60) {
        System.debug('    ğŸŸ¡ MEDIUM: ê°€ì¹˜ ì œì•ˆ ê°•í™”, ì„±ê³µ ì‚¬ë¡€ ê³µìœ ');
        System.debug('    ğŸ’¡ ê°±ì‹  8ì£¼ ì „ ê´€ê³„ ê°•í™” ì‹œì‘');
        System.debug('    ğŸ“Š ROI ë¦¬í¬íŠ¸ ì œê³µ');
    } else {
        System.debug('    ğŸ”´ LOW: ìœ„í—˜ ê³ ê° ê´€ë¦¬, ë¬¸ì œì  í•´ê²° ìš°ì„ ');
        System.debug('    ğŸ’¡ ê°±ì‹  12ì£¼ ì „ë¶€í„° ì§‘ì¤‘ ê´€ë¦¬');
        System.debug('    ğŸ› ï¸ ì¶”ê°€ ì§€ì› ì„œë¹„ìŠ¤ ì œê³µ');
    }
    
    System.debug('');
}

// ==========================================
// 4ë‹¨ê³„: Upsell/Cross-sell ê¸°íšŒ ë¶„ì„
// ==========================================
System.debug('ğŸ“ 4ë‹¨ê³„: í™•ì¥ ë§¤ì¶œ ê¸°íšŒ ë¶„ì„');
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

// Accountì˜ ëª¨ë“  Asset ì¡°íšŒ (í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„)
List<Asset> allAccountAssets = [
    SELECT Id, Name, Product2.Name, Product2.Product_Family__c, 
           Price, Status, InstallDate
    FROM Asset 
    WHERE AccountId = :testOrder.AccountId
    AND Status = 'Installed'
];

System.debug('ğŸ¢ ' + testOrder.Account.Name + ' Asset í¬íŠ¸í´ë¦¬ì˜¤:');
Map<String, Integer> productFamilyCount = new Map<String, Integer>();
Decimal totalAssetValue = 0;

for (Asset asset : allAccountAssets) {
    System.debug('  - ' + asset.Name + ' (' + (asset.Product2?.Name ?? 'N/A') + ')');
    
    // Product Familyë³„ ì§‘ê³„
    String family = asset.Product2?.Product_Family__c ?? 'Unknown';
    productFamilyCount.put(family, productFamilyCount.get(family) != null ? 
                          productFamilyCount.get(family) + 1 : 1);
    
    // ì´ Asset ê°€ì¹˜ ê³„ì‚°
    if (asset.Price != null) {
        totalAssetValue += asset.Price;
    }
}

System.debug('');
System.debug('ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„:');
System.debug('  - ì´ Asset ìˆ˜: ' + allAccountAssets.size() + 'ê°œ');
System.debug('  - ì´ Asset ê°€ì¹˜: â‚©' + totalAssetValue.format());
System.debug('  - Product Family ë¶„í¬:');
for (String family : productFamilyCount.keySet()) {
    System.debug('    * ' + family + ': ' + productFamilyCount.get(family) + 'ê°œ');
}

// Cross-sell ê¸°íšŒ ë¶„ì„
System.debug('');
System.debug('ğŸš€ í™•ì¥ ë§¤ì¶œ ê¸°íšŒ:');

// 1. ë¯¸ë³´ìœ  Product Family ì‹ë³„
List<Product2> allProducts = [
    SELECT Id, Name, Product_Family__c, ListPrice
    FROM Product2 
    WHERE IsActive = true
    AND Product_Family__c != null
];

Set<String> ownedFamilies = productFamilyCount.keySet();
Map<String, List<Product2>> missingFamilies = new Map<String, List<Product2>>();

for (Product2 product : allProducts) {
    if (!ownedFamilies.contains(product.Product_Family__c)) {
        if (!missingFamilies.containsKey(product.Product_Family__c)) {
            missingFamilies.put(product.Product_Family__c, new List<Product2>());
        }
        missingFamilies.get(product.Product_Family__c).add(product);
    }
}

System.debug('  ğŸ’¡ Cross-sell ê¸°íšŒ (' + missingFamilies.size() + 'ê°œ Product Family):');
for (String family : missingFamilies.keySet()) {
    List<Product2> products = missingFamilies.get(family);
    System.debug('    ğŸ¯ ' + family + ' (' + products.size() + 'ê°œ ì œí’ˆ)');
    
    // ê°€ì¥ ì¸ê¸°ìˆëŠ” ì œí’ˆ ì¶”ì²œ
    if (!products.isEmpty()) {
        Product2 recommendedProduct = products[0]; // ë‹¨ìˆœí™”
        System.debug('      ì¶”ì²œ: ' + recommendedProduct.Name + 
                    ' (â‚©' + (recommendedProduct.ListPrice != null ? 
                    recommendedProduct.ListPrice.format() : 'N/A') + ')');
    }
}

// 2. Upsell ê¸°íšŒ (ê¸°ì¡´ ì œí’ˆ ì—…ê·¸ë ˆì´ë“œ)
System.debug('');
System.debug('  â¬†ï¸ Upsell ê¸°íšŒ:');
for (Asset asset : existingAssets) {
    if (asset.InstallDate != null) {
        Integer daysUsed = asset.InstallDate.daysBetween(Date.today());
        if (daysUsed > 180) { // 6ê°œì›” ì´ìƒ ì‚¬ìš© ì‹œ ì—…ê·¸ë ˆì´ë“œ ì œì•ˆ
            System.debug('    ğŸ¯ ' + asset.Name);
            System.debug('      - ì‚¬ìš© ê¸°ê°„: ' + daysUsed + 'ì¼ (ì—…ê·¸ë ˆì´ë“œ ì ê¸°)');
            System.debug('      - í˜„ì¬ ê°€ì¹˜: â‚©' + (asset.Price != null ? asset.Price.format() : 'N/A'));
            System.debug('      - ì—…ê·¸ë ˆì´ë“œ ì˜ˆìƒ ê°€ì¹˜: â‚©' + 
                        (asset.Price != null ? (asset.Price * 1.5).format() : 'N/A'));
        }
    }
}

// ==========================================
// 5ë‹¨ê³„: Asset ê¸°ë°˜ Next Best Action ì¶”ì²œ
// ==========================================
System.debug('');
System.debug('ğŸ“ 5ë‹¨ê³„: ì˜ì—…íŒ€ ì•¡ì…˜ í”Œëœ');
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

System.debug('ğŸ“‹ ' + testOrder.Account.Name + ' ëŒ€ìƒ ì¶”ì²œ ì•¡ì…˜:');
System.debug('');

// ìš°ì„ ìˆœìœ„ë³„ ì•¡ì…˜ ì•„ì´í…œ
System.debug('ğŸ”¥ HIGH Priority (ì¦‰ì‹œ ì‹¤í–‰):');
System.debug('  1. ê°±ì‹  ì¤€ë¹„ ë¯¸íŒ… ìŠ¤ì¼€ì¤„ë§ (2ì£¼ ë‚´)');
System.debug('  2. í˜„ì¬ ë§Œì¡±ë„ ì¡°ì‚¬ ì‹¤ì‹œ');
System.debug('  3. ì‚¬ìš© í˜„í™© ë° ROI ë¦¬í¬íŠ¸ ì¤€ë¹„');

System.debug('');
System.debug('ğŸŸ¡ MEDIUM Priority (1ê°œì›” ë‚´):');
System.debug('  1. Cross-sell ì œí’ˆ ë°ëª¨ ì œì•ˆ');
System.debug('  2. ì—…ê³„ ë²¤ì¹˜ë§ˆí‚¹ ìë£Œ ì œê³µ');
System.debug('  3. ê³ ê° ì„±ê³µ ì‚¬ë¡€ ê³µìœ ');

System.debug('');
System.debug('ğŸŸ¢ LOW Priority (3ê°œì›” ë‚´):');
System.debug('  1. ì¥ê¸° ë¡œë“œë§µ ë…¼ì˜');
System.debug('  2. ì „ëµì  íŒŒíŠ¸ë„ˆì‹­ ì œì•ˆ');
System.debug('  3. ì°¨ì„¸ëŒ€ ì†”ë£¨ì…˜ ë¡œë“œë§µ ê³µìœ ');

// ==========================================
// ê²°ë¡  ë° ìš”ì•½
// ==========================================
System.debug('');
System.debug('ğŸ“ ì‹œì—° ê²°ê³¼ ìš”ì•½');
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

System.debug('âœ… Salesforce Assets í™œìš© ì„±ê³¼:');
System.debug('  ğŸ¯ Order 00000153ì—ì„œ Assetìœ¼ë¡œ ì™„ë²½í•œ ë°ì´í„° ì—°ê²°');
System.debug('  ğŸ“Š ìë™í™”ëœ ê±´ê°•ë„ ë¶„ì„ìœ¼ë¡œ ê³ ê° ìƒíƒœ ê°€ì‹œí™”');
System.debug('  ğŸ’° ê°±ì‹  í™•ë¥  ë° í™•ì¥ ë§¤ì¶œ ê¸°íšŒ ì •ëŸ‰í™”');
System.debug('  ğŸ“‹ ë°ì´í„° ê¸°ë°˜ ì˜ì—… ì•¡ì…˜ í”Œëœ ìë™ ìƒì„±');
System.debug('  ğŸ”„ Order â†’ Asset â†’ Opportunity ë¼ì´í”„ì‚¬ì´í´ ì™„ì„±');

System.debug('');
System.debug('ğŸš€ í•µì‹¬ ê°€ì¹˜:');
System.debug('  â€¢ ê³ ê° ê´€ê³„ì˜ ì—°ì†ì„± í™•ë³´');
System.debug('  â€¢ ì˜ˆì¸¡ ê°€ëŠ¥í•œ ë§¤ì¶œ íŒŒì´í”„ë¼ì¸');
System.debug('  â€¢ ë°ì´í„° ê¸°ë°˜ ì˜ì‚¬ê²°ì • ì§€ì›');
System.debug('  â€¢ ìë™í™”ëœ ê¸°íšŒ ë°œêµ´');
System.debug('  â€¢ ì „ëµì  ê³ ê° ê´€ë¦¬ ì‹¤í˜„');

System.debug('');
System.debug('ğŸ’¡ Order 00000153ê³¼ ê°™ì€ ì„±ê³µ ì¼€ì´ìŠ¤ë¥¼ Assetsë¡œ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ì—¬');
System.debug('   ì§€ì†ì ì¸ ê³ ê° ê°€ì¹˜ ì°½ì¶œê³¼ ë§¤ì¶œ ì„±ì¥ì„ ë‹¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!');

System.debug('');
System.debug('âœ… Salesforce Assets í™œìš© ì‹œì—° ì™„ë£Œ! ğŸ‰');
