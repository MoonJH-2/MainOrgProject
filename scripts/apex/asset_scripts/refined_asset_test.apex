/**
 * ì •ì œëœ Asset ìƒì„± í…ŒìŠ¤íŠ¸ - ì‹¤ì œ í•„ë“œ êµ¬ì¡° ê¸°ë°˜
 */

System.debug('=== ì •ì œëœ Asset ìƒì„± í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');

// 1. Orderì™€ PaymentStatus í™•ì¸
List<Order> testOrders = [
    SELECT Id, OrderNumber, AccountId, Account.Name, TotalAmount, Status,
           EffectiveDate, EndDate, Contact__c, Contact.Name, OwnerId, Owner.Name
    FROM Order 
    WHERE AccountId != null
    LIMIT 3
];

System.debug('í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•œ Order ê°œìˆ˜: ' + testOrders.size());

for (Order ord : testOrders) {
    System.debug('\n--- Order: ' + ord.OrderNumber + ' ---');
    System.debug('ê³ ê°: ' + ord.Account.Name);
    System.debug('ì´ ê¸ˆì•¡: ' + (ord.TotalAmount != null ? ord.TotalAmount.format() : '0') + 'ì›');
    System.debug('ì‹œì‘ì¼: ' + (ord.EffectiveDate != null ? ord.EffectiveDate.format() : 'ë¯¸ì„¤ì •'));
    System.debug('ì¢…ë£Œì¼: ' + (ord.EndDate != null ? ord.EndDate.format() : 'ë¬´ê¸°í•œ'));
    System.debug('ì—°ë½ì²˜: ' + (ord.Contact.Name != null ? ord.Contact.Name : 'ë¯¸ì„¤ì •'));
    
    // PaymentStatus í™•ì¸
    List<PaymentStatus__c> payments = [
        SELECT Id, InstallmentNumber__c, Amount__c, Status__c, DueDate__c, PaidDate__c
        FROM PaymentStatus__c 
        WHERE Order__c = :ord.Id
        ORDER BY InstallmentNumber__c
    ];
    
    System.debug('PaymentStatus ê°œìˆ˜: ' + payments.size());
    
    if (!payments.isEmpty()) {
        Integer totalPayments = payments.size();
        Integer completedPayments = 0;
        
        for (PaymentStatus__c ps : payments) {
            System.debug('  ' + ps.InstallmentNumber__c + 'ì°¨: ' + 
                        (ps.Amount__c != null ? ps.Amount__c.format() : '0') + 'ì›, ' +
                        'ìƒíƒœ: ' + ps.Status__c + 
                        (ps.PaidDate__c != null ? ', ë‚©ë¶€ì¼: ' + ps.PaidDate__c.format() : ''));
            
            if (ps.Status__c == 'ì™„ë‚©') {
                completedPayments++;
            }
        }
        
        Boolean isFullyPaid = (totalPayments > 0 && totalPayments == completedPayments);
        System.debug('ì™„ë‚© ìƒíƒœ: ' + isFullyPaid + ' (' + completedPayments + '/' + totalPayments + ')');
        
        // ì™„ë‚© í™•ì¸ ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸
        Boolean serviceCheck = OrderAssetCreationService.isOrderFullyPaid(ord.Id);
        System.debug('ì„œë¹„ìŠ¤ ì™„ë‚© í™•ì¸: ' + serviceCheck);
        
        if (isFullyPaid) {
            System.debug('ğŸ¯ ì™„ë‚© Order ë°œê²¬! Asset ìƒì„± í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            try {
                // ê¸°ì¡´ Asset í™•ì¸
                List<Asset> existingAssets = [
                    SELECT Id, Name FROM Asset 
                    WHERE SerialNumber = :ord.OrderNumber
                ];
                
                if (!existingAssets.isEmpty()) {
                    System.debug('âš ï¸ ì´ë¯¸ Assetì´ ì¡´ì¬í•©ë‹ˆë‹¤: ' + existingAssets[0].Name);
                } else {
                    // Asset ìƒì„± í…ŒìŠ¤íŠ¸
                    Asset newAsset = OrderAssetCreationService.createAssetFromCompletedOrder(ord.Id);
                    
                    if (newAsset != null) {
                        System.debug('âœ… Asset ìƒì„± ì„±ê³µ!');
                        System.debug('- Asset ID: ' + newAsset.Id);
                        System.debug('- Asset Name: ' + newAsset.Name);
                        System.debug('- Serial Number: ' + newAsset.SerialNumber);
                        System.debug('- Contact: ' + (newAsset.ContactId != null ? 'Connected' : 'Not Connected'));
                        System.debug('- Purchase Date: ' + (newAsset.PurchaseDate != null ? newAsset.PurchaseDate.format() : 'Not Set'));
                        System.debug('- Lifecycle End: ' + (newAsset.LifecycleEndDate != null ? newAsset.LifecycleEndDate.format() : 'Not Set'));
                        
                        // ìƒì„±ëœ Asset ìƒì„¸ ì¡°íšŒ
                        Asset createdAssetDetail = [
                            SELECT Id, Name, SerialNumber, AccountId, Account.Name,
                                   ContactId, Contact.Name, PurchaseDate, InstallDate,
                                   LifecycleEndDate, Status, Price, Description
                            FROM Asset 
                            WHERE Id = :newAsset.Id
                        ];
                        
                        System.debug('\n--- ìƒì„±ëœ Asset ìƒì„¸ ì •ë³´ ---');
                        System.debug('ê³ ê°: ' + createdAssetDetail.Account.Name);
                        System.debug('ì—°ë½ì²˜: ' + (createdAssetDetail.Contact?.Name ?? 'ì—†ìŒ'));
                        System.debug('êµ¬ë§¤ì¼: ' + (createdAssetDetail.PurchaseDate?.format() ?? 'ì—†ìŒ'));
                        System.debug('ì„¤ì¹˜ì¼: ' + (createdAssetDetail.InstallDate?.format() ?? 'ì—†ìŒ'));
                        System.debug('ì¢…ë£Œì¼: ' + (createdAssetDetail.LifecycleEndDate?.format() ?? 'ì—†ìŒ'));
                        System.debug('ê°€ê²©: ' + (createdAssetDetail.Price?.format() ?? '0') + 'ì›');
                        System.debug('ìƒíƒœ: ' + createdAssetDetail.Status);
                        
                        break; // ì²« ë²ˆì§¸ ì„±ê³µ í›„ ì¢…ë£Œ
                    }
                }
                
            } catch (Exception e) {
                System.debug('âŒ Asset ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
                System.debug('Stack Trace: ' + e.getStackTraceString());
            }
        }
    } else {
        System.debug('PaymentStatusê°€ ì—†ìŠµë‹ˆë‹¤.');
    }
}

// ì „ì²´ Asset í˜„í™© í™•ì¸
System.debug('\n=== Asset í˜„í™© ===');
Integer totalAssets = [SELECT COUNT() FROM Asset];
System.debug('ì „ì²´ Asset ê°œìˆ˜: ' + totalAssets);

if (totalAssets > 0) {
    List<Asset> recentAssets = [
        SELECT Id, Name, SerialNumber, Account.Name, CreatedDate, Status
        FROM Asset 
        ORDER BY CreatedDate DESC 
        LIMIT 3
    ];
    
    System.debug('ìµœê·¼ Asset:');
    for (Asset asset : recentAssets) {
        System.debug('- ' + asset.Name + ' (' + asset.Account.Name + ') - ' + asset.Status);
    }
}

System.debug('\n=== ì •ì œëœ Asset ìƒì„± í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');
