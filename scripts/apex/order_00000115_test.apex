// Order 00000115 ì „ìš© í…ŒìŠ¤íŠ¸
System.debug('ğŸ¯ =====Order 00000115 ì „ìš© í…ŒìŠ¤íŠ¸ ì‹œì‘=====');

try {
    // 1. Order 00000115 ì¡°íšŒ
    List<Order> orders = [
        SELECT Id, OrderNumber, Account.Name, Account.Id, Owner.Name, Owner.Email, Status
        FROM Order 
        WHERE OrderNumber = '00000115'
        LIMIT 1
    ];
    
    if (orders.isEmpty()) {
        System.debug('âŒ Order 00000115ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Order targetOrder = orders[0];
    System.debug('ğŸ“‹ Order ì •ë³´:');
    System.debug('   â€¢ Order Number: ' + targetOrder.OrderNumber);
    System.debug('   â€¢ Account: ' + targetOrder.Account.Name);
    System.debug('   â€¢ Owner: ' + targetOrder.Owner.Name + ' (' + targetOrder.Owner.Email + ')');
    System.debug('   â€¢ Status: ' + targetOrder.Status);
    System.debug('   â€¢ Order ID: ' + targetOrder.Id);
    
    // 2. í•´ë‹¹ Orderì˜ PaymentStatus ì¡°íšŒ
    List<PaymentStatus__c> paymentStatuses = [
        SELECT Id, Order__c, InstallmentNumber__c, Amount__c, DueDate__c, Status__c
        FROM PaymentStatus__c 
        WHERE Order__c = :targetOrder.Id
        ORDER BY InstallmentNumber__c ASC
    ];
    
    System.debug('ğŸ’° PaymentStatus í˜„í™©: ' + paymentStatuses.size() + 'ê±´');
    for (PaymentStatus__c payment : paymentStatuses) {
        Boolean isOverdue = payment.DueDate__c < Date.today() && payment.Status__c != 'ì™„ë‚©';
        String status = isOverdue ? 'ğŸ”´ ì—°ì²´' : (payment.Status__c == 'ì™„ë‚©' ? 'âœ… ì™„ë‚©' : 'â³ ì˜ˆì •');
        System.debug('   â€¢ ' + payment.InstallmentNumber__c + 'ì°¨: â‚©' + payment.Amount__c.format() + 
                     ' (ì˜ˆì •ì¼: ' + payment.DueDate__c.format() + ') ' + status);
    }
    
    // 3. ì—°ì²´ëœ PaymentStatus ì°¾ê¸°
    List<PaymentStatus__c> overduePayments = new List<PaymentStatus__c>();
    for (PaymentStatus__c payment : paymentStatuses) {
        if (payment.DueDate__c < Date.today() && payment.Status__c != 'ì™„ë‚©') {
            overduePayments.add(payment);
        }
    }
    
    System.debug('ğŸš¨ ì—°ì²´ ê±´ìˆ˜: ' + overduePayments.size() + 'ê±´');
    
    if (overduePayments.isEmpty()) {
        System.debug('   ëª¨ë“  ë‚©ë¶€ê°€ ì •ìƒ ìƒíƒœì…ë‹ˆë‹¤.');
    } else {
        // 4. ì—°ì²´ ê±´ì— ëŒ€í•œ ì•Œë¦¼ ë ˆì½”ë“œ ìƒì„± ë° í…ŒìŠ¤íŠ¸
        for (PaymentStatus__c overduePayment : overduePayments) {
            System.debug('ğŸš¨ ì—°ì²´ ì²˜ë¦¬ ì¤‘: ' + overduePayment.InstallmentNumber__c + 'ì°¨');
            
            // Payment_Notification__c ë ˆì½”ë“œ ìƒì„±
            Payment_Notification__c notification = new Payment_Notification__c();
            notification.PaymentStatus__c = overduePayment.Id;
            notification.NotificationType__c = 'ì—°ì²´ ì•Œë¦¼';
            notification.NotificationChannel__c = 'Salesforce';
            notification.NotificationStatus__c = 'Pending';
            notification.ScheduledDateTime__c = DateTime.now();
            
            insert notification;
            System.debug('   âœ… ì•Œë¦¼ ë ˆì½”ë“œ ìƒì„±: ' + notification.Id);
            
            // ê´€ê³„ í•„ë“œì™€ í•¨ê»˜ ë‹¤ì‹œ ì¡°íšŒ
            Payment_Notification__c fullNotification = [
                SELECT Id, PaymentStatus__c, PaymentStatus__r.Order__c,
                       PaymentStatus__r.Order__r.Account.Name, PaymentStatus__r.Order__r.Account.Id,
                       PaymentStatus__r.Order__r.OrderNumber, PaymentStatus__r.InstallmentNumber__c,
                       PaymentStatus__r.Amount__c, PaymentStatus__r.DueDate__c, PaymentStatus__r.Status__c,
                       NotificationType__c, NotificationChannel__c
                FROM Payment_Notification__c 
                WHERE Id = :notification.Id
            ];
            
            // Salesforce ì•Œë¦¼ ë°œì†¡
            System.debug('   ğŸ”” ì•Œë¦¼ ë°œì†¡ ì¤‘...');
            Boolean result = PaymentNotificationService.sendSalesforceNotification(fullNotification);
            System.debug('   ğŸ“Š ë°œì†¡ ê²°ê³¼: ' + (result ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'));
        }
    }
    
    // 5. Order 00000115ì— ì—°ê²°ëœ ëª¨ë“  Task ì¡°íšŒ
    System.debug('ğŸ“ Order 00000115 ì—°ê²° Task ì¡°íšŒ:');
    List<Task> relatedTasks = [
        SELECT Id, Subject, Priority, Status, ActivityDate, CreatedDate, Description
        FROM Task 
        WHERE WhatId = :targetOrder.Id
        ORDER BY CreatedDate DESC
        LIMIT 10
    ];
    
    System.debug('   ì´ Task ìˆ˜: ' + relatedTasks.size() + 'ê°œ');
    for (Task task : relatedTasks) {
        String createdToday = task.CreatedDate.date() == Date.today() ? ' [ì˜¤ëŠ˜ ìƒì„±]' : '';
        System.debug('   â€¢ ' + task.Subject + ' (' + task.Priority + ', ' + task.Status + ')' + createdToday);
        System.debug('     í™œë™ì¼: ' + (task.ActivityDate != null ? task.ActivityDate.format() : 'ë¯¸ì„¤ì •'));
    }
    
    // 6. Chatter í¬ìŠ¤íŠ¸ í™•ì¸
    System.debug('ğŸ’¬ Order 00000115 Chatter í¬ìŠ¤íŠ¸:');
    List<FeedItem> chatterPosts = [
        SELECT Id, Body, CreatedDate, CreatedBy.Name
        FROM FeedItem 
        WHERE ParentId = :targetOrder.Id
        ORDER BY CreatedDate DESC
        LIMIT 5
    ];
    
    System.debug('   ì´ Chatter í¬ìŠ¤íŠ¸: ' + chatterPosts.size() + 'ê°œ');
    for (FeedItem post : chatterPosts) {
        String createdToday = post.CreatedDate.date() == Date.today() ? ' [ì˜¤ëŠ˜]' : '';
        System.debug('   â€¢ ' + post.CreatedBy.Name + ': ' + 
                     post.Body.substring(0, Math.min(50, post.Body.length())) + '...' + createdToday);
    }
    
    // 7. PDF íŒŒì¼ í™•ì¸
    System.debug('ğŸ“ Order 00000115 ì²¨ë¶€ íŒŒì¼:');
    List<ContentDocumentLink> attachments = [
        SELECT ContentDocument.Id, ContentDocument.Title, ContentDocument.FileExtension, 
               ContentDocument.CreatedDate
        FROM ContentDocumentLink 
        WHERE LinkedEntityId = :targetOrder.Id
        ORDER BY ContentDocument.CreatedDate DESC
        LIMIT 5
    ];
    
    System.debug('   ì´ ì²¨ë¶€ íŒŒì¼: ' + attachments.size() + 'ê°œ');
    for (ContentDocumentLink attachment : attachments) {
        System.debug('   â€¢ ' + attachment.ContentDocument.Title + 
                     '.' + attachment.ContentDocument.FileExtension +
                     ' (ìƒì„±ì¼: ' + attachment.ContentDocument.CreatedDate.format() + ')');
    }
    
    // 8. ê³ ê° ì •ë³´ í™•ì¸
    System.debug('ğŸ‘¤ ê³ ê° ì •ë³´:');
    List<Contact> customerContacts = [
        SELECT Id, Name, Email, Phone
        FROM Contact 
        WHERE AccountId = :targetOrder.Account.Id
        ORDER BY CreatedDate ASC
        LIMIT 3
    ];
    
    System.debug('   ì—°ê´€ëœ ì—°ë½ì²˜: ' + customerContacts.size() + 'ê°œ');
    for (Contact contact : customerContacts) {
        System.debug('   â€¢ ' + contact.Name + ' (' + contact.Email + ', ' + contact.Phone + ')');
    }
    
    // 9. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
    System.debug('');
    System.debug('ğŸ“Š =====Order 00000115 í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½=====');
    System.debug('â€¢ Order ìƒíƒœ: âœ… ' + targetOrder.Status);
    System.debug('â€¢ PaymentStatus: ' + paymentStatuses.size() + 'ê±´ (ì—°ì²´: ' + overduePayments.size() + 'ê±´)');
    System.debug('â€¢ ìƒì„±ëœ Task: ' + relatedTasks.size() + 'ê°œ');
    System.debug('â€¢ Chatter í¬ìŠ¤íŠ¸: ' + chatterPosts.size() + 'ê°œ');
    System.debug('â€¢ ì²¨ë¶€ íŒŒì¼: ' + attachments.size() + 'ê°œ');
    System.debug('â€¢ ê³ ê° ì—°ë½ì²˜: ' + customerContacts.size() + 'ê°œ');
    
    // 10. Activity Timeline í™•ì¸ ì•ˆë‚´
    System.debug('');
    System.debug('ğŸ¯ í™•ì¸í•´ì•¼ í•  ì‚¬í•­:');
    System.debug('1. Order 00000115 í˜ì´ì§€ì˜ Activity Timelineì—ì„œ Task í™•ì¸');
    System.debug('2. Upcoming & Overdue ì„¹ì…˜ì—ì„œ ì—°ì²´ ì•Œë¦¼ Task í™•ì¸');
    System.debug('3. ê´€ë ¨ëœ ì´ë©”ì¼ ìˆ˜ì‹  í™•ì¸ (ê³ ê° ë° ê´€ë¦¬ì)');
    System.debug('4. Salesforce ìƒë‹¨ ë²¨ ì•„ì´ì½˜ ì•Œë¦¼ í™•ì¸');
    
    System.debug('âœ… =====Order 00000115 í…ŒìŠ¤íŠ¸ ì™„ë£Œ=====');
    
} catch (Exception e) {
    System.debug('âŒ Order 00000115 í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}
