// Order 00000149ì˜ 1ì°¨ ë‚©ë¶€ë¥¼ ì—°ì²´ë¡œ ì—…ë°ì´íŠ¸í•˜ì—¬ ì‹¤ì œ Sales ì•± ì•Œë¦¼ ë°œì†¡
System.debug('âš¡ =====ì‹¤ì‹œê°„ ì—°ì²´ ì•Œë¦¼ í…ŒìŠ¤íŠ¸=====');

try {
    // 1. Order 00000149ì˜ PaymentStatus ì¡°íšŒ
    List<PaymentStatus__c> payments = [
        SELECT Id, InstallmentNumber__c, Amount__c, DueDate__c, Status__c,
               Order__c, Order__r.Account.Name, Order__r.OrderNumber
        FROM PaymentStatus__c 
        WHERE Order__r.OrderNumber = '00000149'
        AND InstallmentNumber__c = 1
        LIMIT 1
    ];
    
    if (payments.isEmpty()) {
        System.debug('âŒ Order 00000149ì˜ 1ì°¨ PaymentStatusë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    PaymentStatus__c payment = payments[0];
    String oldStatus = payment.Status__c;
    
    System.debug('ğŸ“‹ í˜„ì¬ ìƒíƒœ:');
    System.debug('   Order: ' + payment.Order__r.OrderNumber);
    System.debug('   íšŒì°¨: ' + payment.InstallmentNumber__c + 'ì°¨');
    System.debug('   ê¸ˆì•¡: â‚©' + payment.Amount__c.format());
    System.debug('   ë‚©ê¸°ì¼: ' + payment.DueDate__c.format());
    System.debug('   í˜„ì¬ ìƒíƒœ: ' + oldStatus);
    
    // 2. CustomNotificationType ì„¤ì • í™•ì¸
    List<CustomNotificationType> salesTypes = [
        SELECT Id FROM CustomNotificationType
        WHERE DeveloperName = 'Sales_Order_Notification'
        LIMIT 1
    ];
    
    if (salesTypes.isEmpty()) {
        System.debug('âŒ Sales_Order_Notificationì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
        System.debug('   Setupì—ì„œ CustomNotificationTypeì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    System.debug('âœ… Sales_Order_Notification ì„¤ì • í™•ì¸ë¨');
    
    // 3. ìƒíƒœë¥¼ ì—°ì²´ë¡œ ì—…ë°ì´íŠ¸ (ì‹¤ì œ íŠ¸ë¦¬ê±° ë°œë™)
    System.debug('');
    System.debug('ğŸš¨ PaymentStatusë¥¼ ì—°ì²´ë¡œ ì—…ë°ì´íŠ¸ ì¤‘...');
    
    payment.Status__c = 'ì—°ì²´';
    
    // ì‹¤ì œ ì—…ë°ì´íŠ¸ ì‹¤í–‰ - ì´ë•Œ PaymentStatusTriggerHandlerê°€ ì‘ë™í•¨
    update payment;
    
    System.debug('âœ… PaymentStatus ì—…ë°ì´íŠ¸ ì™„ë£Œ: ' + oldStatus + ' â†’ ì—°ì²´');
    System.debug('   ğŸ“¡ PaymentStatusTriggerHandler.afterUpdate() íŠ¸ë¦¬ê±°ë¨');
    System.debug('   ğŸ”” OrderNotificationService.notifyOverduePayments() í˜¸ì¶œë¨');
    
    // 4. ì—…ë°ì´íŠ¸ëœ ìƒíƒœ í™•ì¸
    PaymentStatus__c updatedPayment = [
        SELECT Id, Status__c, LastModifiedDate, LastModifiedBy.Name
        FROM PaymentStatus__c 
        WHERE Id = :payment.Id
    ];
    
    System.debug('');
    System.debug('ğŸ“Š ì—…ë°ì´íŠ¸ ê²°ê³¼:');
    System.debug('   ìƒˆ ìƒíƒœ: ' + updatedPayment.Status__c);
    System.debug('   ìˆ˜ì •ì¼ì‹œ: ' + updatedPayment.LastModifiedDate);
    System.debug('   ìˆ˜ì •ì: ' + updatedPayment.LastModifiedBy.Name);
    
    // 5. ì—°ì²´ ì¼ìˆ˜ ê³„ì‚° ë° í‘œì‹œ
    Integer overdueDays = payment.DueDate__c.daysBetween(Date.today());
    System.debug('   ì—°ì²´ ì¼ìˆ˜: ' + overdueDays + 'ì¼');
    
    // 6. ìˆ˜ì‹ ì í™•ì¸
    System.debug('');
    System.debug('ğŸ‘¥ ì•Œë¦¼ ìˆ˜ì‹ ì:');
    
    User currentUser = [
        SELECT Id, Name, Email, ManagerId, Manager.Name
        FROM User 
        WHERE Id = :UserInfo.getUserId()
    ];
    
    Order order = [
        SELECT Id, OwnerId, Owner.Name, Owner.Email
        FROM Order 
        WHERE Id = :payment.Order__c
    ];
    
    System.debug('   ğŸ“§ í˜„ì¬ ì‚¬ìš©ì: ' + currentUser.Name);
    System.debug('   ğŸ‘¤ Order Owner: ' + order.Owner.Name);
    if (currentUser.ManagerId != null) {
        System.debug('   ğŸ‘” Manager: ' + currentUser.Manager.Name);
    }
    
    // 7. ì¦‰ì‹œ í™•ì¸ ë°©ë²• ì•ˆë‚´
    System.debug('');
    System.debug('ğŸ”” ì¦‰ì‹œ í™•ì¸ ë°©ë²•:');
    System.debug('1. Salesforce ìƒë‹¨ì˜ ğŸ”” ë²¨ ì•„ì´ì½˜ í´ë¦­');
    System.debug('2. "ğŸš¨ ë‚©ë¶€ ì—°ì²´ ë°œìƒ" ì•Œë¦¼ì´ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸');
    System.debug('3. ì•Œë¦¼ ë‚´ìš©: "' + payment.Order__r.Account.Name + ' - 1ì°¨ ë‚©ë¶€ ì—°ì²´ (' + overdueDays + 'ì¼)"');
    System.debug('4. ì•Œë¦¼ í´ë¦­ ì‹œ Order ë ˆì½”ë“œë¡œ ì´ë™í•˜ëŠ”ì§€ í™•ì¸');
    
    System.debug('');
    System.debug('ğŸ“± Mobile ì•±ì—ì„œë„ í™•ì¸:');
    System.debug('1. Mobile Salesforce ì•±ì—ì„œ í‘¸ì‹œ ì•Œë¦¼ ìˆ˜ì‹  í™•ì¸');
    System.debug('2. ì•Œë¦¼ í„°ì¹˜ ì‹œ Order ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ í™•ì¸');
    
    // 8. ì¶”ê°€ í…ŒìŠ¤íŠ¸ ì˜µì…˜
    System.debug('');
    System.debug('ğŸ§ª ì¶”ê°€ í…ŒìŠ¤íŠ¸ ì˜µì…˜:');
    System.debug('1. ë‹¤ë¥¸ íšŒì°¨ë„ ì—°ì²´ë¡œ ë³€ê²½í•˜ì—¬ ì¶”ê°€ ì•Œë¦¼ í…ŒìŠ¤íŠ¸');
    System.debug('2. ì—°ì²´ ìƒíƒœë¥¼ "ì™„ë‚©"ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ì•Œë¦¼ ì¤‘ë‹¨ í…ŒìŠ¤íŠ¸');
    System.debug('3. ìƒˆ Order ìƒì„±í•˜ì—¬ ìƒì„± ì•Œë¦¼ í…ŒìŠ¤íŠ¸');
    
    // 9. ë¡¤ë°± ì•ˆë‚´ (í•„ìš”ì‹œ)
    System.debug('');
    System.debug('ğŸ”„ ìƒíƒœ ë¡¤ë°± (í•„ìš”ì‹œ):');
    System.debug('   Status__cë¥¼ ë‹¤ì‹œ "ë¯¸ë‚©"ìœ¼ë¡œ ë³€ê²½í•˜ë©´ ì—°ì²´ ìƒíƒœ í•´ì œ');
    
} catch (DmlException dmlEx) {
    System.debug('âŒ PaymentStatus ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:');
    for (Integer i = 0; i < dmlEx.getNumDml(); i++) {
        System.debug('   â€¢ ' + dmlEx.getDmlMessage(i));
        System.debug('   â€¢ í•„ë“œ: ' + dmlEx.getDmlFieldNames(i));
    }
} catch (Exception e) {
    System.debug('âŒ ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('   íƒ€ì…: ' + e.getTypeName());
    System.debug('   ë¼ì¸: ' + e.getLineNumber());
}

System.debug('');
System.debug('ğŸ¯ =====ì‹¤ì‹œê°„ ì—°ì²´ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ì™„ë£Œ=====');
System.debug('ğŸ“¢ ì§€ê¸ˆ ë°”ë¡œ ìƒë‹¨ ë²¨ ì•„ì´ì½˜ì„ í™•ì¸í•´ë³´ì„¸ìš”!');
