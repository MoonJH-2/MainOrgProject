// Order 00000151 ê°œì„ ëœ ì•Œë¦¼ ì‹œìŠ¤í…œ ì¢…í•© í…ŒìŠ¤íŠ¸
System.debug('ğŸ¯ =====ê°œì„ ëœ ì•Œë¦¼ ì‹œìŠ¤í…œ ì¢…í•© í…ŒìŠ¤íŠ¸=====');

try {
    // 1. Order 00000151 ì •ë³´ ì¡°íšŒ
    System.debug('');
    System.debug('ğŸ“‹ 1ë‹¨ê³„: Order 00000151 ì •ë³´ í™•ì¸');
    
    List<Order> orders = [
        SELECT Id, OrderNumber, Status, TotalAmount, EffectiveDate,
               AccountId, Account.Name, OwnerId, Owner.Name, Owner.Email,
               Slack_Channel_Name__c, Slack_Notification_Status__c,
               CreatedDate, CreatedBy.Name, ActivatedDate, ActivatedBy.Name
        FROM Order 
        WHERE OrderNumber = '00000151'
        LIMIT 1
    ];
    
    if (orders.isEmpty()) {
        System.debug('âŒ Order 00000151ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Order order = orders[0];
    System.debug('âœ… Order ì •ë³´ í™•ì¸ ì™„ë£Œ:');
    System.debug('   - OrderNumber: ' + order.OrderNumber);
    System.debug('   - Account: ' + order.Account.Name);
    System.debug('   - Amount: â‚©' + order.TotalAmount.format());
    System.debug('   - Status: ' + order.Status);
    System.debug('   - Owner: ' + order.Owner.Name);
    System.debug('   - Created: ' + order.CreatedDate.format());
    System.debug('   - Activated: ' + order.ActivatedDate.format());
    
    // 2. CustomNotificationType ì„¤ì • í™•ì¸
    System.debug('');
    System.debug('ğŸ”§ 2ë‹¨ê³„: CustomNotificationType ì„¤ì • í™•ì¸');
    
    List<CustomNotificationType> salesTypes = [
        SELECT Id, DeveloperName, MasterLabel, Description
        FROM CustomNotificationType
        WHERE DeveloperName = 'Sales_Order_Notification'
        LIMIT 1
    ];
    
    if (salesTypes.isEmpty()) {
        System.debug('âŒ Sales_Order_Notificationì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
        
        // ëŒ€ì•ˆìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” CustomNotificationType ì°¾ê¸°
        List<CustomNotificationType> availableTypes = [
            SELECT Id, DeveloperName, MasterLabel
            FROM CustomNotificationType
            LIMIT 3
        ];
        
        if (!availableTypes.isEmpty()) {
            System.debug('ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ëŒ€ì•ˆ CustomNotificationType:');
            for (CustomNotificationType type : availableTypes) {
                System.debug('   â€¢ ' + type.MasterLabel + ' (' + type.DeveloperName + ')');
            }
            
            // ì²« ë²ˆì§¸ íƒ€ì…ìœ¼ë¡œ ì„ì‹œ í…ŒìŠ¤íŠ¸
            CustomNotificationType tempType = availableTypes[0];
            System.debug('âš ï¸ ì„ì‹œë¡œ ' + tempType.MasterLabel + ' ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸');
            
            try {
                Set<String> recipients = new Set<String>();
                recipients.add(UserInfo.getUserId());
                recipients.add(order.OwnerId);
                
                String title = 'ğŸ§ª ì„ì‹œ í…ŒìŠ¤íŠ¸ ì•Œë¦¼';
                String body = 'Order ' + order.OrderNumber + ' ì•Œë¦¼ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸';
                
                Messaging.CustomNotification notification = new Messaging.CustomNotification();
                notification.setTitle(title);
                notification.setBody(body);
                notification.setNotificationTypeId(tempType.Id);
                notification.setTargetId(order.Id);
                notification.send(recipients);
                
                System.debug('âœ… ì„ì‹œ ì•Œë¦¼ ë°œì†¡ ì„±ê³µ');
                
            } catch (Exception tempEx) {
                System.debug('âŒ ì„ì‹œ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨: ' + tempEx.getMessage());
            }
        }
        
        System.debug('');
        System.debug('ğŸ“ í•´ê²° ë°©ë²•:');
        System.debug('Setup > Custom Notification Typesì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ìƒì„±:');
        System.debug('- Name: Sales Order Notification');
        System.debug('- API Name: Sales_Order_Notification');
        System.debug('- Description: Order ìƒì„±, ì—°ì²´, Slack ì±„ë„ ì•Œë¦¼');
        System.debug('- Channel: Desktop and Mobile');
        
        return;
    }
    
    CustomNotificationType salesType = salesTypes[0];
    System.debug('âœ… CustomNotificationType ì„¤ì • í™•ì¸: ' + salesType.MasterLabel);
    
    // 3. ê°œì„ ëœ Order ìƒì„± ì•Œë¦¼ í…ŒìŠ¤íŠ¸
    System.debug('');
    System.debug('ğŸ‰ 3ë‹¨ê³„: ê°œì„ ëœ Order ìƒì„± ì•Œë¦¼ í…ŒìŠ¤íŠ¸');
    
    try {
        List<Order> orderList = new List<Order>{order};
        OrderNotificationService.notifyOrderCreated(orderList);
        System.debug('âœ… OrderNotificationService.notifyOrderCreated() ì‹¤í–‰ ì™„ë£Œ');
        
    } catch (Exception orderEx) {
        System.debug('âŒ Order ìƒì„± ì•Œë¦¼ ì‹¤íŒ¨: ' + orderEx.getMessage());
        System.debug('âŒ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + orderEx.getStackTraceString());
    }
    
    // 4. ì—°ì²´ PaymentStatus í™•ì¸ ë° ì•Œë¦¼ í…ŒìŠ¤íŠ¸
    System.debug('');
    System.debug('ğŸš¨ 4ë‹¨ê³„: ì—°ì²´ ì•Œë¦¼ í…ŒìŠ¤íŠ¸');
    
    List<PaymentStatus__c> overduePayments = [
        SELECT Id, InstallmentNumber__c, Amount__c, DueDate__c, Status__c,
               Order__c, Order__r.Account.Name, Order__r.OrderNumber
        FROM PaymentStatus__c 
        WHERE Order__c = :order.Id
        AND Status__c = 'ì—°ì²´'
    ];
    
    System.debug('ğŸ“Š ì—°ì²´ ê±´ìˆ˜: ' + overduePayments.size() + 'ê±´');
    
    if (!overduePayments.isEmpty()) {
        try {
            OrderNotificationService.notifyOverduePayments(overduePayments);
            System.debug('âœ… ì—°ì²´ ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ');
            
            for (PaymentStatus__c payment : overduePayments) {
                Integer overdueDays = payment.DueDate__c.daysBetween(Date.today());
                System.debug('   ğŸš¨ ' + payment.InstallmentNumber__c + 'ì°¨: ì—°ì²´ ' + overdueDays + 'ì¼');
            }
            
        } catch (Exception overdueEx) {
            System.debug('âŒ ì—°ì²´ ì•Œë¦¼ ì‹¤íŒ¨: ' + overdueEx.getMessage());
        }
    } else {
        System.debug('â„¹ï¸ í˜„ì¬ ì—°ì²´ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.');
        
        // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ 1ì°¨ PaymentStatusë¥¼ ì—°ì²´ë¡œ ë³€ê²½
        List<PaymentStatus__c> firstPayments = [
            SELECT Id, Status__c, InstallmentNumber__c
            FROM PaymentStatus__c 
            WHERE Order__c = :order.Id
            AND InstallmentNumber__c = 1
            LIMIT 1
        ];
        
        if (!firstPayments.isEmpty() && firstPayments[0].Status__c != 'ì—°ì²´') {
            System.debug('ğŸ§ª í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ 1ì°¨ ë‚©ë¶€ë¥¼ ì—°ì²´ë¡œ ë³€ê²½');
            
            PaymentStatus__c firstPayment = firstPayments[0];
            String oldStatus = firstPayment.Status__c;
            firstPayment.Status__c = 'ì—°ì²´';
            
            try {
                update firstPayment;
                System.debug('âœ… PaymentStatus ì—…ë°ì´íŠ¸: ' + oldStatus + ' â†’ ì—°ì²´');
                System.debug('   ğŸ“¡ PaymentStatusTriggerHandlerê°€ ìë™ìœ¼ë¡œ ì—°ì²´ ì•Œë¦¼ ë°œì†¡');
                
            } catch (Exception updateEx) {
                System.debug('âŒ PaymentStatus ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + updateEx.getMessage());
            }
        }
    }
    
    // 5. Slack ì±„ë„ ìƒì„± ì•Œë¦¼ í…ŒìŠ¤íŠ¸
    System.debug('');
    System.debug('ğŸ“¢ 5ë‹¨ê³„: Slack ì±„ë„ ìƒì„± ì•Œë¦¼ í…ŒìŠ¤íŠ¸');
    
    if (String.isNotBlank(order.Slack_Channel_Name__c)) {
        try {
            // Slack_Notification_Status__c ì—…ë°ì´íŠ¸
            Order updateOrder = new Order(Id = order.Id);
            updateOrder.Slack_Notification_Status__c = 'Created';
            update updateOrder;
            
            System.debug('âœ… Slack_Notification_Status__c ì—…ë°ì´íŠ¸: Created');
            
            // Slack ì±„ë„ ìƒì„± ì•Œë¦¼ ë°œì†¡
            Order updatedOrder = [
                SELECT Id, OrderNumber, Slack_Channel_Name__c, Slack_Notification_Status__c
                FROM Order 
                WHERE Id = :order.Id
            ];
            
            List<Order> slackOrders = new List<Order>{updatedOrder};
            OrderNotificationService.notifySlackChannelCreated(slackOrders);
            
            System.debug('âœ… Slack ì±„ë„ ìƒì„± ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ');
            System.debug('   ğŸ“¢ ì±„ë„ëª…: #' + order.Slack_Channel_Name__c);
            
        } catch (Exception slackEx) {
            System.debug('âŒ Slack ì±„ë„ ì•Œë¦¼ ì‹¤íŒ¨: ' + slackEx.getMessage());
        }
    } else {
        System.debug('â„¹ï¸ Slack ì±„ë„ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }
    
    // 6. ìˆ˜ì‹ ì ì •ë³´ í™•ì¸
    System.debug('');
    System.debug('ğŸ‘¥ 6ë‹¨ê³„: ì•Œë¦¼ ìˆ˜ì‹ ì ì •ë³´');
    
    User currentUser = [
        SELECT Id, Name, Email, ManagerId, Manager.Name, Manager.Email
        FROM User 
        WHERE Id = :UserInfo.getUserId()
    ];
    
    System.debug('ğŸ“§ ì•Œë¦¼ ìˆ˜ì‹ ì ëª©ë¡:');
    System.debug('   1. í˜„ì¬ ì‚¬ìš©ì: ' + currentUser.Name + ' (' + currentUser.Email + ')');
    System.debug('   2. Order Owner: ' + order.Owner.Name + ' (' + order.Owner.Email + ')');
    
    if (currentUser.ManagerId != null) {
        System.debug('   3. Manager: ' + currentUser.Manager.Name + ' (' + currentUser.Manager.Email + ')');
    }
    
    // ì‹œìŠ¤í…œ ê´€ë¦¬ì í™•ì¸
    List<User> adminUsers = [
        SELECT Id, Name, Email
        FROM User 
        WHERE Profile.Name IN ('ì‹œìŠ¤í…œ ê´€ë¦¬ì', 'System Administrator') 
        AND IsActive = true
        LIMIT 3
    ];
    
    System.debug('   4. ì‹œìŠ¤í…œ ê´€ë¦¬ì: ' + adminUsers.size() + 'ëª…');
    for (User admin : adminUsers) {
        System.debug('      â€¢ ' + admin.Name + ' (' + admin.Email + ')');
    }
    
    // 7. ìµœì¢… í™•ì¸ ë°©ë²•
    System.debug('');
    System.debug('ğŸ”” 7ë‹¨ê³„: ìµœì¢… í™•ì¸ ë°©ë²•');
    System.debug('');
    System.debug('ì¦‰ì‹œ í™•ì¸:');
    System.debug('1. Salesforce ìƒë‹¨ ğŸ”” ë²¨ ì•„ì´ì½˜ í´ë¦­');
    System.debug('2. ë‹¤ìŒ ì•Œë¦¼ë“¤ì´ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸:');
    System.debug('   â€¢ ğŸ‰ ìƒˆ ì£¼ë¬¸ ìƒì„±: ' + order.Account.Name + ' - Order ' + order.OrderNumber);
    System.debug('   â€¢ ğŸš¨ ë‚©ë¶€ ì—°ì²´ ë°œìƒ: (ì—°ì²´ ê±´ì´ ìˆëŠ” ê²½ìš°)');
    System.debug('   â€¢ ğŸ“¢ Slack ì±„ë„ ìƒì„± ì™„ë£Œ: (Slack ì±„ë„ì´ ìˆëŠ” ê²½ìš°)');
    System.debug('3. ì•Œë¦¼ í´ë¦­ ì‹œ Order 00000151ë¡œ ì´ë™í•˜ëŠ”ì§€ í™•ì¸');
    System.debug('');
    System.debug('Mobile í™•ì¸:');
    System.debug('1. Mobile Salesforce ì•±ì—ì„œ í‘¸ì‹œ ì•Œë¦¼ í™•ì¸');
    System.debug('2. ì•Œë¦¼ í„°ì¹˜ ì‹œ Order ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ í™•ì¸');
    
    // 8. ë¬¸ì œ í•´ê²° ê°€ì´ë“œ
    System.debug('');
    System.debug('ğŸ› ï¸ 8ë‹¨ê³„: ë¬¸ì œ í•´ê²° ê°€ì´ë“œ');
    System.debug('');
    System.debug('ì•Œë¦¼ì´ ë³´ì´ì§€ ì•ŠëŠ” ê²½ìš°:');
    System.debug('1. ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ í™•ì¸ (Chrome: ì„¤ì • > ê°œì¸ì •ë³´ ë° ë³´ì•ˆ > ì‚¬ì´íŠ¸ ì„¤ì • > ì•Œë¦¼)');
    System.debug('2. Salesforce ë„ë©”ì¸ ì•Œë¦¼ í—ˆìš© í™•ì¸');
    System.debug('3. CustomNotificationType ì„¤ì • ì¬í™•ì¸');
    System.debug('4. ì‚¬ìš©ì Profileì˜ Custom Notification ê¶Œí•œ í™•ì¸');
    
} catch (Exception e) {
    System.debug('âŒ ì¢…í•© í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('   íƒ€ì…: ' + e.getTypeName());
    System.debug('   ë¼ì¸: ' + e.getLineNumber());
    System.debug('   ìŠ¤íƒ: ' + e.getStackTraceString());
}

System.debug('');
System.debug('ğŸ¯ =====ê°œì„ ëœ ì•Œë¦¼ ì‹œìŠ¤í…œ ì¢…í•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ=====');
System.debug('ğŸ“¢ ì§€ê¸ˆ ë°”ë¡œ ìƒë‹¨ ë²¨ ì•„ì´ì½˜ì„ í™•ì¸í•´ë³´ì„¸ìš”!');
