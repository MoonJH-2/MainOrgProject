// Order 00000149 ì•Œë¦¼ ì‹œìŠ¤í…œ ê²€í†  ìŠ¤í¬ë¦½íŠ¸
System.debug('ğŸ“Š =====Order 00000149 ì•Œë¦¼ ì‹œìŠ¤í…œ ê²€í† =====');

try {
    // 1. Order 00000149 ìƒì„¸ ì •ë³´ ì¡°íšŒ
    List<Order> orders = [
        SELECT Id, OrderNumber, Status, TotalAmount, EffectiveDate,
               AccountId, Account.Name, OwnerId, Owner.Name,
               Slack_Channel_Name__c, Slack_Notification_Status__c,
               CreatedDate, CreatedById, LastModifiedDate, LastModifiedById
        FROM Order 
        WHERE OrderNumber = '00000149'
        LIMIT 1
    ];
    
    if (orders.isEmpty()) {
        System.debug('âŒ Order 00000149ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Order order = orders[0];
    System.debug('');
    System.debug('ğŸ“‹ Order ê¸°ë³¸ ì •ë³´:');
    System.debug('   ID: ' + order.Id);
    System.debug('   OrderNumber: ' + order.OrderNumber);
    System.debug('   Status: ' + order.Status);
    System.debug('   TotalAmount: â‚©' + order.TotalAmount.format());
    System.debug('   Account: ' + order.Account.Name);
    System.debug('   Owner: ' + order.Owner.Name);
    System.debug('   Slack Channel: ' + order.Slack_Channel_Name__c);
    System.debug('   Slack Status: ' + order.Slack_Notification_Status__c);
    System.debug('   Created: ' + order.CreatedDate + ' by ' + order.CreatedById);
    System.debug('   Modified: ' + order.LastModifiedDate);
    
    // 2. PaymentStatus ì¡°íšŒ (ë‚©ë¶€ ì¼ì •)
    List<PaymentStatus__c> payments = [
        SELECT Id, InstallmentNumber__c, Amount__c, DueDate__c, Status__c,
               Order__c, Order__r.OrderNumber, Order__r.Account.Name,
               CreatedDate, LastModifiedDate
        FROM PaymentStatus__c 
        WHERE Order__c = :order.Id
        ORDER BY InstallmentNumber__c ASC
    ];
    
    System.debug('');
    System.debug('ğŸ’° ë‚©ë¶€ ì¼ì • (' + payments.size() + 'ê°œ):');
    Integer overdueCount = 0;
    for (PaymentStatus__c payment : payments) {
        String status = payment.Status__c;
        String statusIcon = '';
        
        if (status == 'ì™„ë‚©') statusIcon = 'âœ…';
        else if (status == 'ì—°ì²´') {
            statusIcon = 'ğŸš¨';
            overdueCount++;
        }
        else if (status == 'ë¯¸ë‚©') statusIcon = 'â³';
        
        System.debug('   ' + statusIcon + ' ' + payment.InstallmentNumber__c + 'ì°¨: â‚©' + 
                    payment.Amount__c.format() + ' (due: ' + payment.DueDate__c.format() + ') - ' + status);
    }
    
    System.debug('   ğŸ“Š ì—°ì²´ ê±´ìˆ˜: ' + overdueCount + 'ê±´');
    
    // 3. ì•Œë¦¼ ì‹œìŠ¤í…œ ë™ì‘ ê²€ì¦
    System.debug('');
    System.debug('ğŸ”” ì•Œë¦¼ ì‹œìŠ¤í…œ ë™ì‘ ê²€ì¦:');
    
    // 3-1. Order ìƒì„± ì•Œë¦¼ í™•ì¸
    System.debug('');
    System.debug('1ï¸âƒ£ Order ìƒì„± ì•Œë¦¼ í…ŒìŠ¤íŠ¸:');
    try {
        // Order ìƒì„± ì•Œë¦¼ ì‹œë®¬ë ˆì´ì…˜
        List<Order> testOrderList = new List<Order>{order};
        OrderNotificationService.notifyOrderCreated(testOrderList);
        System.debug('   âœ… Order ìƒì„± ì•Œë¦¼ ë¡œì§ ì‹¤í–‰ ì™„ë£Œ');
        
    } catch (Exception e) {
        System.debug('   âŒ Order ìƒì„± ì•Œë¦¼ ì˜¤ë¥˜: ' + e.getMessage());
    }
    
    // 3-2. Slack ì±„ë„ ìƒì„± ì•Œë¦¼ í™•ì¸
    System.debug('');
    System.debug('2ï¸âƒ£ Slack ì±„ë„ ìƒì„± ì•Œë¦¼ í…ŒìŠ¤íŠ¸:');
    if (String.isNotBlank(order.Slack_Channel_Name__c)) {
        try {
            List<Order> testSlackList = new List<Order>{order};
            OrderNotificationService.notifySlackChannelCreated(testSlackList);
            System.debug('   âœ… Slack ì±„ë„ ìƒì„± ì•Œë¦¼ ë¡œì§ ì‹¤í–‰ ì™„ë£Œ');
            
        } catch (Exception e) {
            System.debug('   âŒ Slack ì±„ë„ ìƒì„± ì•Œë¦¼ ì˜¤ë¥˜: ' + e.getMessage());
        }
    } else {
        System.debug('   âš ï¸ Slack ì±„ë„ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }
    
    // 3-3. ì—°ì²´ ì•Œë¦¼ í™•ì¸
    System.debug('');
    System.debug('3ï¸âƒ£ ì—°ì²´ ì•Œë¦¼ í…ŒìŠ¤íŠ¸:');
    if (overdueCount > 0) {
        try {
            List<PaymentStatus__c> overduePayments = new List<PaymentStatus__c>();
            for (PaymentStatus__c payment : payments) {
                if (payment.Status__c == 'ì—°ì²´') {
                    overduePayments.add(payment);
                }
            }
            
            OrderNotificationService.notifyOverduePayments(overduePayments);
            System.debug('   âœ… ì—°ì²´ ì•Œë¦¼ ë¡œì§ ì‹¤í–‰ ì™„ë£Œ (' + overduePayments.size() + 'ê±´)');
            
        } catch (Exception e) {
            System.debug('   âŒ ì—°ì²´ ì•Œë¦¼ ì˜¤ë¥˜: ' + e.getMessage());
        }
    } else {
        System.debug('   â„¹ï¸ í˜„ì¬ ì—°ì²´ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    // 4. CustomNotificationType ì„¤ì • í™•ì¸
    System.debug('');
    System.debug('âš™ï¸ CustomNotificationType ì„¤ì • í™•ì¸:');
    
    List<CustomNotificationType> salesNotificationTypes = [
        SELECT Id, DeveloperName, MasterLabel, Description
        FROM CustomNotificationType
        WHERE DeveloperName = 'Sales_Order_Notification'
        LIMIT 1
    ];
    
    if (salesNotificationTypes.isEmpty()) {
        System.debug('   âŒ Sales_Order_Notification CustomNotificationTypeì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        System.debug('   ğŸ“‹ Setupì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ìƒì„±ì´ í•„ìš”í•©ë‹ˆë‹¤:');
        System.debug('      - Name: Sales Order Notification');
        System.debug('      - API Name: Sales_Order_Notification');
        System.debug('      - Description: Order ìƒì„± ë° ì—°ì²´ ì•Œë¦¼');
    } else {
        CustomNotificationType notifType = salesNotificationTypes[0];
        System.debug('   âœ… Sales_Order_Notificationì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤:');
        System.debug('      - ID: ' + notifType.Id);
        System.debug('      - Label: ' + notifType.MasterLabel);
        System.debug('      - API Name: ' + notifType.DeveloperName);
        System.debug('      - Description: ' + notifType.Description);
    }
    
    // 5. ê²°ë¡  ë° ê¶Œì¥ì‚¬í•­
    System.debug('');
    System.debug('ğŸ“ ê²€í†  ê²°ê³¼ ë° ê¶Œì¥ì‚¬í•­:');
    System.debug('');
    
    if (order.Status == 'Activated') {
        System.debug('âœ… Orderê°€ ì •ìƒì ìœ¼ë¡œ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
    } else {
        System.debug('âš ï¸ Order ìƒíƒœê°€ ' + order.Status + 'ì…ë‹ˆë‹¤. Activated ìƒíƒœ í™•ì¸ í•„ìš”.');
    }
    
    if (overdueCount > 0) {
        System.debug('ğŸš¨ ì—°ì²´ ê±´ ' + overdueCount + 'ê°œ ë°œê²¬ - Sales ì•± ì•Œë¦¼ì´ ë°œì†¡ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.');
    } else {
        System.debug('âœ… í˜„ì¬ ì—°ì²´ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    if (String.isNotBlank(order.Slack_Channel_Name__c)) {
        System.debug('âœ… Slack ì±„ë„ì´ ìƒì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤: #' + order.Slack_Channel_Name__c);
    } else {
        System.debug('âš ï¸ Slack ì±„ë„ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }
    
    System.debug('');
    System.debug('ğŸ”§ ë¡œì§ ë™ì‘ í™•ì¸:');
    System.debug('1. OrderTriggerHandler.afterInsert() â†’ OrderNotificationService.notifyOrderCreated()');
    System.debug('2. OrderTriggerHandler.afterUpdate() â†’ OrderNotificationService.notifySlackChannelCreated()');
    System.debug('3. PaymentStatusTriggerHandler â†’ OrderNotificationService.notifyOverduePayments()');
    
} catch (Exception e) {
    System.debug('âŒ ê²€í†  ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('   íƒ€ì…: ' + e.getTypeName());
    System.debug('   ë¼ì¸: ' + e.getLineNumber());
    System.debug('   ìŠ¤íƒ: ' + e.getStackTraceString());
}

System.debug('');
System.debug('âœ… =====Order 00000149 ì•Œë¦¼ ì‹œìŠ¤í…œ ê²€í†  ì™„ë£Œ=====');
