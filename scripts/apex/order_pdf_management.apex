// Order 00000115 PDF íŒŒì¼ í™•ì¸ ë° í…ŒìŠ¤íŠ¸ PDF ìƒì„±
System.debug('ğŸ“ =====Order 00000115 PDF íŒŒì¼ ê´€ë¦¬=====');

try {
    // 1. Order 00000115 ì¡°íšŒ
    List<Order> orders = [
        SELECT Id, OrderNumber, Account.Name
        FROM Order 
        WHERE OrderNumber = '00000115'
        LIMIT 1
    ];
    
    if (orders.isEmpty()) {
        System.debug('âŒ Order 00000115ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Order targetOrder = orders[0];
    System.debug('ğŸ“‹ Order: ' + targetOrder.OrderNumber + ' (' + targetOrder.Account.Name + ')');
    System.debug('   Order ID: ' + targetOrder.Id);
    
    // 2. í˜„ì¬ ì²¨ë¶€ëœ ëª¨ë“  íŒŒì¼ í™•ì¸
    List<ContentDocumentLink> allFiles = [
        SELECT ContentDocument.Id, ContentDocument.Title, ContentDocument.FileExtension, 
               ContentDocument.CreatedDate, ContentDocument.ContentSize
        FROM ContentDocumentLink 
        WHERE LinkedEntityId = :targetOrder.Id
        ORDER BY ContentDocument.CreatedDate DESC
    ];
    
    System.debug('ğŸ“ ì´ ì²¨ë¶€ íŒŒì¼: ' + allFiles.size() + 'ê°œ');
    for (ContentDocumentLink file : allFiles) {
        System.debug('   â€¢ ' + file.ContentDocument.Title + '.' + file.ContentDocument.FileExtension + 
                     ' (í¬ê¸°: ' + (file.ContentDocument.ContentSize / 1024) + 'KB, ìƒì„±ì¼: ' + 
                     file.ContentDocument.CreatedDate.format() + ')');
    }
    
    // 3. PDF íŒŒì¼ë§Œ í•„í„°ë§
    List<ContentDocumentLink> pdfFiles = [
        SELECT ContentDocument.Id, ContentDocument.Title, ContentDocument.FileExtension, 
               ContentDocument.CreatedDate
        FROM ContentDocumentLink 
        WHERE LinkedEntityId = :targetOrder.Id
        AND ContentDocument.FileExtension = 'pdf'
        ORDER BY ContentDocument.CreatedDate DESC
    ];
    
    System.debug('ğŸ“„ PDF íŒŒì¼: ' + pdfFiles.size() + 'ê°œ');
    for (ContentDocumentLink pdf : pdfFiles) {
        System.debug('   â€¢ ' + pdf.ContentDocument.Title + '.pdf (ìƒì„±ì¼: ' + pdf.ContentDocument.CreatedDate.format() + ')');
    }
    
    // 4. PDF íŒŒì¼ì´ ì—†ìœ¼ë©´ í…ŒìŠ¤íŠ¸ìš© ë‚©ë¶€ì¼ì •ì„œ PDF ìƒì„±
    if (pdfFiles.isEmpty()) {
        System.debug('ğŸ“ í…ŒìŠ¤íŠ¸ìš© ë‚©ë¶€ì¼ì •ì„œ PDF ìƒì„± ì¤‘...');
        
        // ë‚©ë¶€ì¼ì •ì„œ PDF ë‚´ìš© ìƒì„±
        String pdfContent = createPaymentSchedulePDF(targetOrder);
        
        // ContentVersion ìƒì„±
        ContentVersion cv = new ContentVersion();
        cv.Title = 'ë‚©ë¶€ì¼ì •ì„œ_' + targetOrder.OrderNumber + '_' + Date.today().format();
        cv.PathOnClient = cv.Title + '.pdf';
        cv.VersionData = Blob.valueOf(pdfContent);
        cv.ContentLocation = 'S';
        cv.Description = '0714TEST ê³ ê° ë‚©ë¶€ì¼ì •ì„œ - ' + targetOrder.OrderNumber;
        insert cv;
        
        // ContentDocument ID ì¡°íšŒ
        ContentVersion insertedCV = [SELECT ContentDocumentId FROM ContentVersion WHERE Id = :cv.Id];
        
        // ContentDocumentLink ìƒì„± (Orderì— ì—°ê²°)
        ContentDocumentLink cdl = new ContentDocumentLink();
        cdl.ContentDocumentId = insertedCV.ContentDocumentId;
        cdl.LinkedEntityId = targetOrder.Id;
        cdl.ShareType = 'V';
        cdl.Visibility = 'AllUsers';
        insert cdl;
        
        System.debug('âœ… ë‚©ë¶€ì¼ì •ì„œ PDF ìƒì„± ì™„ë£Œ: ' + cv.Title + '.pdf');
        System.debug('   ContentVersion ID: ' + cv.Id);
        System.debug('   ContentDocument ID: ' + insertedCV.ContentDocumentId);
        
        // ìƒì„±ëœ PDF íŒŒì¼ ëª©ë¡ ë‹¤ì‹œ ì¡°íšŒ
        pdfFiles = [
            SELECT ContentDocument.Id, ContentDocument.Title, ContentDocument.FileExtension, 
                   ContentDocument.CreatedDate
            FROM ContentDocumentLink 
            WHERE LinkedEntityId = :targetOrder.Id
            AND ContentDocument.FileExtension = 'pdf'
            ORDER BY ContentDocument.CreatedDate DESC
        ];
        
        System.debug('ğŸ“„ ìƒì„± í›„ PDF íŒŒì¼: ' + pdfFiles.size() + 'ê°œ');
    }
    
    // 5. ìµœì‹  PDF íŒŒì¼ í™•ì¸
    if (!pdfFiles.isEmpty()) {
        ContentDocumentLink latestPDF = pdfFiles[0];
        System.debug('ğŸ“ ìµœì‹  PDF: ' + latestPDF.ContentDocument.Title + '.pdf');
        System.debug('   ìƒì„±ì¼: ' + latestPDF.ContentDocument.CreatedDate.format());
        System.debug('   ContentDocument ID: ' + latestPDF.ContentDocument.Id);
        
        // ContentVersion ìƒì„¸ ì •ë³´ ì¡°íšŒ
        List<ContentVersion> cvDetails = [
            SELECT Id, Title, VersionData, ContentSize, Description
            FROM ContentVersion 
            WHERE ContentDocumentId = :latestPDF.ContentDocument.Id
            AND IsLatest = true
            LIMIT 1
        ];
        
        if (!cvDetails.isEmpty()) {
            ContentVersion cv = cvDetails[0];
            System.debug('   íŒŒì¼ í¬ê¸°: ' + (cv.ContentSize / 1024) + 'KB');
            System.debug('   ì„¤ëª…: ' + cv.Description);
            System.debug('   ë°ì´í„° í¬ê¸°: ' + (cv.VersionData != null ? (cv.VersionData.size() / 1024) + 'KB' : 'ì—†ìŒ'));
        }
    }
    
    System.debug('âœ… =====Order 00000115 PDF íŒŒì¼ ê´€ë¦¬ ì™„ë£Œ=====');
    
} catch (Exception e) {
    System.debug('âŒ PDF íŒŒì¼ ê´€ë¦¬ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}

// ë‚©ë¶€ì¼ì •ì„œ PDF ë‚´ìš© ìƒì„± í•¨ìˆ˜
private static String createPaymentSchedulePDF(Order orderInfo) {
    // ì‹¤ì œ PDFëŠ” ë³µì¡í•˜ì§€ë§Œ, í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ê°„ë‹¨í•œ PDF êµ¬ì¡° ìƒì„±
    String pdfContent = '%PDF-1.4\n';
    pdfContent += '1 0 obj\n<<\n/Type /Catalog\n/Pages 2 0 R\n>>\nendobj\n\n';
    pdfContent += '2 0 obj\n<<\n/Type /Pages\n/Kids [3 0 R]\n/Count 1\n>>\nendobj\n\n';
    pdfContent += '3 0 obj\n<<\n/Type /Page\n/Parent 2 0 R\n/MediaBox [0 0 612 792]\n/Contents 4 0 R\n>>\nendobj\n\n';
    pdfContent += '4 0 obj\n<<\n/Length 200\n>>\nstream\n';
    pdfContent += 'BT\n/F1 12 Tf\n100 700 Td\n';
    pdfContent += '(ë‚©ë¶€ì¼ì •ì„œ - Order: ' + orderInfo.OrderNumber + ') Tj\n';
    pdfContent += '0 -20 Td\n(ê³ ê°ëª…: ' + orderInfo.Account.Name + ') Tj\n';
    pdfContent += '0 -20 Td\n(ìƒì„±ì¼: ' + Date.today().format() + ') Tj\n';
    pdfContent += '0 -40 Td\n(1ì°¨: 8,333,333ì› - 2025.07.14 ì™„ë‚©) Tj\n';
    pdfContent += '0 -20 Td\n(2ì°¨: 8,333,333ì› - 2025.08.14 ì˜ˆì •) Tj\n';
    pdfContent += '0 -20 Td\n(3ì°¨: 8,333,333ì› - 2025.09.14 ì˜ˆì •) Tj\n';
    pdfContent += 'ET\nendstream\nendobj\n\n';
    pdfContent += 'xref\n0 5\n0000000000 65535 f \n0000000009 00000 n \n0000000058 00000 n \n';
    pdfContent += '0000000115 00000 n \n0000000204 00000 n \ntrailer\n<<\n/Size 5\n/Root 1 0 R\n>>\n';
    pdfContent += 'startxref\n456\n%%EOF';
    
    return pdfContent;
}
