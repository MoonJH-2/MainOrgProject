// ì‹¤ì œ Sales ì•± ì•Œë¦¼ ë™ì‘ì„ ìœ„í•œ ì„¤ì • í™•ì¸ ë° ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
System.debug('ğŸš€ =====ì‹¤ì œ Sales ì•± ì•Œë¦¼ ë™ì‘ í™•ì¸=====');

try {
    // 1. CustomNotificationType ì„¤ì • ìƒíƒœ í™•ì¸
    System.debug('');
    System.debug('ğŸ”§ 1ë‹¨ê³„: CustomNotificationType ì„¤ì • í™•ì¸');
    
    List<CustomNotificationType> salesNotificationTypes = [
        SELECT Id, DeveloperName, MasterLabel, Description
        FROM CustomNotificationType
        WHERE DeveloperName = 'Sales_Order_Notification'
        LIMIT 1
    ];
    
    if (salesNotificationTypes.isEmpty()) {
        System.debug('âŒ Sales_Order_Notificationì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
        System.debug('ğŸ“‹ ë¨¼ì € Setupì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ìƒì„±í•´ì£¼ì„¸ìš”:');
        System.debug('   - Name: Sales Order Notification');
        System.debug('   - API Name: Sales_Order_Notification');
        System.debug('   - Description: Order ê´€ë ¨ ì‹¤ì‹œê°„ ì•Œë¦¼');
        System.debug('   - Channel: Desktop and Mobile');
        System.debug('âš ï¸ ì´ ì„¤ì • ì—†ì´ëŠ” ì‹¤ì œ ì•Œë¦¼ì´ ë°œì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }
    
    CustomNotificationType salesType = salesNotificationTypes[0];
    System.debug('âœ… Sales_Order_Notification ì„¤ì •ë¨: ' + salesType.MasterLabel);
    
    // 2. Order 00000149 ì‹¤ì œ ìƒíƒœ í™•ì¸
    System.debug('');
    System.debug('ğŸ“Š 2ë‹¨ê³„: Order 00000149 ì‹¤ì œ ìƒíƒœ í™•ì¸');
    
    List<Order> orders = [
        SELECT Id, OrderNumber, Status, TotalAmount, AccountId, Account.Name,
               OwnerId, Owner.Name, Owner.Email, Owner.ManagerId,
               Slack_Channel_Name__c, Slack_Notification_Status__c,
               CreatedDate, LastModifiedDate
        FROM Order 
        WHERE OrderNumber = '00000149'
        LIMIT 1
    ];
    
    if (orders.isEmpty()) {
        System.debug('âŒ Order 00000149ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Order order = orders[0];
    System.debug('âœ… Order ì •ë³´:');
    System.debug('   - ID: ' + order.Id);
    System.debug('   - Status: ' + order.Status);
    System.debug('   - Account: ' + order.Account.Name);
    System.debug('   - Owner: ' + order.Owner.Name);
    System.debug('   - Slack Channel: ' + order.Slack_Channel_Name__c);
    
    // 3. ì—°ì²´ ìƒíƒœ PaymentStatus í™•ì¸
    System.debug('');
    System.debug('ğŸ’° 3ë‹¨ê³„: ì—°ì²´ PaymentStatus í™•ì¸');
    
    List<PaymentStatus__c> overduePayments = [
        SELECT Id, InstallmentNumber__c, Amount__c, DueDate__c, Status__c,
               Order__c, Order__r.Account.Name, Order__r.OrderNumber
        FROM PaymentStatus__c 
        WHERE Order__c = :order.Id
        AND Status__c = 'ì—°ì²´'
        ORDER BY InstallmentNumber__c ASC
    ];
    
    System.debug('ğŸ“‹ ì—°ì²´ ê±´ìˆ˜: ' + overduePayments.size() + 'ê±´');
    for (PaymentStatus__c payment : overduePayments) {
        Integer overdueDays = payment.DueDate__c.daysBetween(Date.today());
        System.debug('   ğŸš¨ ' + payment.InstallmentNumber__c + 'ì°¨: â‚©' + 
                    payment.Amount__c.format() + ' (ì—°ì²´ ' + overdueDays + 'ì¼)');
    }
    
    // 4. ì‹¤ì œ ì•Œë¦¼ ìˆ˜ì‹ ì í™•ì¸
    System.debug('');
    System.debug('ğŸ‘¥ 4ë‹¨ê³„: ì‹¤ì œ ì•Œë¦¼ ìˆ˜ì‹ ì í™•ì¸');
    
    Set<String> recipients = new Set<String>();
    
    // í˜„ì¬ ì‚¬ìš©ì
    User currentUser = [
        SELECT Id, Name, Email, ManagerId, Manager.Name
        FROM User 
        WHERE Id = :UserInfo.getUserId()
    ];
    recipients.add(currentUser.Id);
    System.debug('   ğŸ“§ í˜„ì¬ ì‚¬ìš©ì: ' + currentUser.Name + ' (' + currentUser.Email + ')');
    
    // Order Owner
    recipients.add(order.OwnerId);
    System.debug('   ğŸ‘¤ Order Owner: ' + order.Owner.Name + ' (' + order.Owner.Email + ')');
    
    // Managerë“¤
    if (currentUser.ManagerId != null) {
        recipients.add(currentUser.ManagerId);
        System.debug('   ğŸ‘” í˜„ì¬ ì‚¬ìš©ì Manager: ' + currentUser.Manager.Name);
    }
    
    if (order.Owner.ManagerId != null) {
        recipients.add(order.Owner.ManagerId);
        System.debug('   ğŸ‘” Order Owner Manager í¬í•¨');
    }
    
    // ì‹œìŠ¤í…œ ê´€ë¦¬ì
    List<User> adminUsers = [
        SELECT Id, Name, Email
        FROM User 
        WHERE Profile.Name IN ('ì‹œìŠ¤í…œ ê´€ë¦¬ì', 'System Administrator') 
        AND IsActive = true
        LIMIT 3
    ];
    
    for (User admin : adminUsers) {
        recipients.add(admin.Id);
        System.debug('   ğŸ” ì‹œìŠ¤í…œ ê´€ë¦¬ì: ' + admin.Name);
    }
    
    System.debug('ğŸ“Š ì´ ìˆ˜ì‹ ì: ' + recipients.size() + 'ëª…');
    
    // 5. ì‹¤ì œ Sales ì•± ì•Œë¦¼ ë°œì†¡
    System.debug('');
    System.debug('ğŸš€ 5ë‹¨ê³„: ì‹¤ì œ Sales ì•± ì•Œë¦¼ ë°œì†¡');
    
    if (!overduePayments.isEmpty()) {
        System.debug('');
        System.debug('ğŸš¨ ì—°ì²´ ì•Œë¦¼ ë°œì†¡ ì¤‘...');
        
        try {
            // ì‹¤ì œ ì—°ì²´ ì•Œë¦¼ ë°œì†¡
            OrderNotificationService.notifyOverduePayments(overduePayments);
            
            // ì¶”ê°€ë¡œ ì§ì ‘ ì•Œë¦¼ë„ ë°œì†¡
            for (PaymentStatus__c payment : overduePayments) {
                Integer overdueDays = payment.DueDate__c.daysBetween(Date.today());
                
                String title = 'ğŸš¨ ë‚©ë¶€ ì—°ì²´ ë°œìƒ';
                String body = payment.Order__r.Account.Name + ' - ' + 
                             payment.InstallmentNumber__c + 'ì°¨ ë‚©ë¶€ ì—°ì²´ (' + 
                             overdueDays + 'ì¼)';
                
                Messaging.CustomNotification notification = new Messaging.CustomNotification();
                notification.setTitle(title);
                notification.setBody(body);
                notification.setNotificationTypeId(salesType.Id);
                notification.setTargetId(payment.Order__c);
                notification.send(recipients);
                
                System.debug('âœ… ì—°ì²´ ì•Œë¦¼ ë°œì†¡: ' + title);
                System.debug('   ğŸ“± ë‚´ìš©: ' + body);
                System.debug('   ğŸ‘¥ ìˆ˜ì‹ ì: ' + recipients.size() + 'ëª…');
            }
            
        } catch (Exception notifEx) {
            System.debug('âŒ ì—°ì²´ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨: ' + notifEx.getMessage());
        }
    }
    
    // 6. Order ìƒì„± ì•Œë¦¼ ì¬ë°œì†¡ (ì°¸ê³ ìš©)
    System.debug('');
    System.debug('ğŸ‰ Order ìƒì„± ì•Œë¦¼ ì¬ë°œì†¡ (ì°¸ê³ ìš©)');
    
    try {
        String title = 'ğŸ‰ ìƒˆ ì£¼ë¬¸ ìƒì„±';
        String body = order.Account.Name + ' - Order ' + order.OrderNumber + 
                     ' (â‚©' + order.TotalAmount.format() + ')';
        
        Messaging.CustomNotification orderNotification = new Messaging.CustomNotification();
        orderNotification.setTitle(title);
        orderNotification.setBody(body);
        orderNotification.setNotificationTypeId(salesType.Id);
        orderNotification.setTargetId(order.Id);
        orderNotification.send(recipients);
        
        System.debug('âœ… Order ìƒì„± ì•Œë¦¼ ë°œì†¡: ' + title);
        System.debug('   ğŸ“± ë‚´ìš©: ' + body);
        
    } catch (Exception orderEx) {
        System.debug('âŒ Order ìƒì„± ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨: ' + orderEx.getMessage());
    }
    
    // 7. Slack ì±„ë„ ìƒì„± ì•Œë¦¼ (í•´ë‹¹ë˜ëŠ” ê²½ìš°)
    if (String.isNotBlank(order.Slack_Channel_Name__c)) {
        System.debug('');
        System.debug('ğŸ“¢ Slack ì±„ë„ ìƒì„± ì•Œë¦¼ ë°œì†¡');
        
        try {
            String title = 'ğŸ“¢ Slack ì±„ë„ ìƒì„± ì™„ë£Œ';
            String body = 'Order ' + order.OrderNumber + ' Salesforce ì—°ë™ ì±„ë„ ìƒì„± (#' + 
                         order.Slack_Channel_Name__c + ')';
            
            Messaging.CustomNotification slackNotification = new Messaging.CustomNotification();
            slackNotification.setTitle(title);
            slackNotification.setBody(body);
            slackNotification.setNotificationTypeId(salesType.Id);
            slackNotification.setTargetId(order.Id);
            slackNotification.send(recipients);
            
            System.debug('âœ… Slack ì±„ë„ ì•Œë¦¼ ë°œì†¡: ' + title);
            System.debug('   ğŸ“± ë‚´ìš©: ' + body);
            
        } catch (Exception slackEx) {
            System.debug('âŒ Slack ì±„ë„ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨: ' + slackEx.getMessage());
        }
    }
    
    // 8. ì‹¤ì œ í™•ì¸ ë°©ë²• ì•ˆë‚´
    System.debug('');
    System.debug('ğŸ”” ì‹¤ì œ Sales ì•± ì•Œë¦¼ í™•ì¸ ë°©ë²•:');
    System.debug('1. Salesforce ìƒë‹¨ì˜ ğŸ”” ë²¨ ì•„ì´ì½˜ í´ë¦­');
    System.debug('2. ë°©ê¸ˆ ë°œì†¡ëœ ì•Œë¦¼ë“¤ì´ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸');
    System.debug('3. ì•Œë¦¼ í´ë¦­ ì‹œ í•´ë‹¹ Order ë ˆì½”ë“œë¡œ ì´ë™í•˜ëŠ”ì§€ í™•ì¸');
    System.debug('4. Mobile Salesforce ì•±ì—ì„œë„ í‘¸ì‹œ ì•Œë¦¼ í™•ì¸ ê°€ëŠ¥');
    
    System.debug('');
    System.debug('ğŸ“± Mobile ì•± ì•Œë¦¼ í™•ì¸:');
    System.debug('1. Mobile Salesforce ì•± ë¡œê·¸ì¸');
    System.debug('2. ì•± ì•Œë¦¼ ì„¤ì • í™œì„±í™” í™•ì¸');
    System.debug('3. í‘¸ì‹œ ì•Œë¦¼ìœ¼ë¡œ ìˆ˜ì‹ ë˜ëŠ”ì§€ í™•ì¸');
    
    System.debug('');
    System.debug('âš¡ ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸ ë°©ë²•:');
    System.debug('1. PaymentStatus ë ˆì½”ë“œì˜ Statusë¥¼ "ë¯¸ë‚©"ì—ì„œ "ì—°ì²´"ë¡œ ë³€ê²½');
    System.debug('2. ì¦‰ì‹œ Sales ì•± ì•Œë¦¼ì´ ë°œì†¡ë˜ëŠ”ì§€ í™•ì¸');
    System.debug('3. ìƒˆ Order ìƒì„± ì‹œ ì•Œë¦¼ ë°œì†¡ í™•ì¸');
    
} catch (Exception e) {
    System.debug('âŒ ì‹¤ì œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('   íƒ€ì…: ' + e.getTypeName());
    System.debug('   ë¼ì¸: ' + e.getLineNumber());
    System.debug('   ìŠ¤íƒ: ' + e.getStackTraceString());
}

System.debug('');
System.debug('ğŸ¯ =====ì‹¤ì œ Sales ì•± ì•Œë¦¼ í™•ì¸ ì™„ë£Œ=====');
System.debug('ğŸ“¢ ìƒë‹¨ ë²¨ ì•„ì´ì½˜ì„ ì§€ê¸ˆ í™•ì¸í•´ë³´ì„¸ìš”!');
