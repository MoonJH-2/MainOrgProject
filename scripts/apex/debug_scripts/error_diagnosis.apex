/**
 * ì˜¤ë¥˜ ì§„ë‹¨ ë° ë””ë²„ê¹… ìŠ¤í¬ë¦½íŠ¸
 * ëª©ì : "Argument cannot be null" ì˜¤ë¥˜ì˜ ì •í™•í•œ ì›ì¸ íŒŒì•…
 */

System.debug('ğŸ” === ì˜¤ë¥˜ ì§„ë‹¨ ì‹œì‘ ===');

try {
    // 1. ìƒì„±ëœ ë°ì´í„° í™•ì¸
    List<Account> accounts = [SELECT Id, Name FROM Account WHERE Name = 'í…ŒìŠ¤íŠ¸ê¸°ì—…'];
    System.debug('âœ… Account ë°ì´í„°: ' + accounts.size() + 'ê°œ');
    
    List<Asset> assets = [SELECT Id, Name, AccountId, Account.Name, Price, InstallDate, UsageEndDate, Status FROM Asset WHERE Account.Name = 'í…ŒìŠ¤íŠ¸ê¸°ì—…'];
    System.debug('âœ… Asset ë°ì´í„°: ' + assets.size() + 'ê°œ');
    
    if(!assets.isEmpty()) {
        Asset testAsset = assets[0];
        System.debug('Asset ìƒì„¸:');
        System.debug('  - Name: ' + testAsset.Name);
        System.debug('  - AccountId: ' + testAsset.AccountId);
        System.debug('  - Account.Name: ' + testAsset.Account?.Name);
        System.debug('  - Price: ' + testAsset.Price);
        System.debug('  - InstallDate: ' + testAsset.InstallDate);
        System.debug('  - UsageEndDate: ' + testAsset.UsageEndDate);
        System.debug('  - Status: ' + testAsset.Status);
    }
    
    List<Opportunity> opportunities = [SELECT Id, Name, AccountId, StageName, CloseDate, Amount, Type FROM Opportunity WHERE Account.Name = 'í…ŒìŠ¤íŠ¸ê¸°ì—…'];
    System.debug('âœ… Opportunity ë°ì´í„°: ' + opportunities.size() + 'ê°œ');
    
    // 2. ì„±ê³¼ ì¶”ì  ë¡œì§ì—ì„œ ì‚¬ìš©í•˜ëŠ” ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸
    System.debug('');
    System.debug('ğŸ” === ì„±ê³¼ ì¶”ì  ë¡œì§ í…ŒìŠ¤íŠ¸ ===');
    
    // ì˜¤ëŠ˜ì˜ ì˜ˆìƒ ë§¤ì¶œ ê³„ì‚° í…ŒìŠ¤íŠ¸
    List<Asset> todayAssets = [
        SELECT Id, Name, AccountId, Account.Name, Price, InstallDate, UsageEndDate, Status
        FROM Asset 
        WHERE Status = 'Installed' 
        AND InstallDate != null
        AND UsageEndDate != null
        AND InstallDate <= :Date.today().addDays(-300)
        ORDER BY Price DESC
    ];
    System.debug('ì˜¤ëŠ˜ ì˜ˆìƒ ë§¤ì¶œìš© Asset: ' + todayAssets.size() + 'ê°œ');
    
    // ì›”ê°„ ê°±ì‹  í˜„í™© í…ŒìŠ¤íŠ¸
    Date thisMonthStart = Date.today().toStartOfMonth();
    List<Opportunity> completedOpps = [
        SELECT Id, Name, Amount, CloseDate, StageName, Type
        FROM Opportunity 
        WHERE Type = 'Renewal'
        AND StageName = 'Closed Won'
        AND CloseDate >= :thisMonthStart
        AND CloseDate <= :Date.today()
    ];
    System.debug('ì´ë²ˆ ë‹¬ ì™„ë£Œëœ ê°±ì‹ : ' + completedOpps.size() + 'ê°œ');
    
    List<Opportunity> inProgressOpps = [
        SELECT Id, Name, Amount, CloseDate, StageName, Type
        FROM Opportunity 
        WHERE Type = 'Renewal'
        AND StageName != 'Closed Won'
        AND StageName != 'Closed Lost'
        AND CloseDate >= :Date.today()
    ];
    System.debug('ì§„í–‰ ì¤‘ì¸ ê°±ì‹ : ' + inProgressOpps.size() + 'ê°œ');
    
    // 3. Null ê°’ ê²€ì¦ (ì˜¤ë¥˜ ì›ì¸ ê°€ëŠ¥ì„±)
    System.debug('');
    System.debug('ğŸ” === Null ê°’ ê²€ì¦ ===');
    
    for(Asset a : todayAssets) {
        if(a.AccountId == null) System.debug('âŒ Asset AccountIdê°€ null: ' + a.Name);
        if(a.Account?.Name == null) System.debug('âŒ Account Nameì´ null: ' + a.Name);
        if(a.Price == null) System.debug('âŒ Asset Priceê°€ null: ' + a.Name);
        if(a.InstallDate == null) System.debug('âŒ InstallDateê°€ null: ' + a.Name);
        if(a.UsageEndDate == null) System.debug('âŒ UsageEndDateê°€ null: ' + a.Name);
    }
    
    // 4. ì›í´ë¦­ ê°±ì‹  ë¡œì§ í…ŒìŠ¤íŠ¸ (300ì¼ ì´ìƒ ê²½ê³¼ ì¡°ê±´)
    System.debug('');
    System.debug('ğŸ” === ì›í´ë¦­ ê°±ì‹  ì¡°ê±´ í…ŒìŠ¤íŠ¸ ===');
    
    List<Asset> renewalAssets = [
        SELECT Id, Name, AccountId, Account.Name, Price, InstallDate, UsageEndDate, Status
        FROM Asset 
        WHERE Status = 'Installed'
        AND InstallDate <= :Date.today().addDays(-300)
        AND UsageEndDate >= :Date.today()
    ];
    System.debug('ê°±ì‹  ê°€ëŠ¥í•œ Asset: ' + renewalAssets.size() + 'ê°œ');
    
    for(Asset a : renewalAssets) {
        Integer daysSinceInstall = Date.today().daysBetween(a.InstallDate);
        Integer daysUntilExpiry = Date.today().daysBetween(a.UsageEndDate);
        System.debug('Asset: ' + a.Name + ' | ì„¤ì¹˜ í›„: ' + daysSinceInstall + 'ì¼ | ë§Œë£Œê¹Œì§€: ' + daysUntilExpiry + 'ì¼');
    }
    
    // 5. ì‚¬ìš©ì ê¶Œí•œ í™•ì¸
    System.debug('');
    System.debug('ğŸ” === ì‚¬ìš©ì ê¶Œí•œ í™•ì¸ ===');
    System.debug('í˜„ì¬ ì‚¬ìš©ì: ' + UserInfo.getName());
    System.debug('Profile: ' + [SELECT Name FROM Profile WHERE Id = :UserInfo.getProfileId()].Name);
    System.debug('Asset ì ‘ê·¼: ' + Schema.sObjectType.Asset.isAccessible());
    System.debug('Opportunity ì ‘ê·¼: ' + Schema.sObjectType.Opportunity.isAccessible());
    System.debug('Account ì ‘ê·¼: ' + Schema.sObjectType.Account.isAccessible());
    
} catch(Exception e) {
    System.debug('âŒ ì§„ë‹¨ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage());
    System.debug('âŒ ì˜¤ë¥˜ íƒ€ì…: ' + e.getTypeName());
    System.debug('âŒ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
    System.debug('âŒ ë¼ì¸ ë²ˆí˜¸: ' + e.getLineNumber());
}

System.debug('ğŸ” === ì˜¤ë¥˜ ì§„ë‹¨ ì™„ë£Œ ===');
