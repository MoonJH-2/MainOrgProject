// ì „ì²´ ì•Œë¦¼ ì‹œìŠ¤í…œ ì¢…í•© í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
// ì‹¤ì œ ë©”ì¼ ë°œì†¡, Custom Notification, PDF ì²¨ë¶€ ë“± ëª¨ë“  ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸

System.debug('ğŸš€ =====ì „ì²´ ì•Œë¦¼ ì‹œìŠ¤í…œ ì¢…í•© í…ŒìŠ¤íŠ¸ ì‹œì‘=====');

try {
    // 1. ì—°ì²´ëœ PaymentStatus ì¡°íšŒ
    List<PaymentStatus__c> overduePayments = [
        SELECT Id, Order__c, Order__r.Account.Name, Order__r.OrderNumber, 
               InstallmentNumber__c, Amount__c, DueDate__c, Status__c
        FROM PaymentStatus__c 
        WHERE Status__c != 'ì™„ë‚©' 
        AND DueDate__c < TODAY
        ORDER BY DueDate__c ASC
        LIMIT 3
    ];
    
    System.debug('ğŸ“Š ì—°ì²´ ë‚©ë¶€ í˜„í™©: ' + overduePayments.size() + 'ê±´');
    
    if (overduePayments.isEmpty()) {
        System.debug('âŒ í…ŒìŠ¤íŠ¸í•  ì—°ì²´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // 2. Custom Notification Type í™•ì¸/ìƒì„±
    List<CustomNotificationType> notificationTypes = [
        SELECT Id, DeveloperName FROM CustomNotificationType 
        WHERE DeveloperName = 'Payment_Notification'
    ];
    
    if (notificationTypes.isEmpty()) {
        System.debug('âš ï¸ CustomNotificationType "Payment_Notification"ì´ ì—†ìŠµë‹ˆë‹¤.');
        System.debug('ğŸ’¡ Setup > Custom Notificationsì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ìƒì„±í•´ì£¼ì„¸ìš”:');
        System.debug('   - Label: Payment Notification');
        System.debug('   - Name: Payment_Notification');
        System.debug('   - Description: ë‚©ë¶€ ê´€ë ¨ ì•Œë¦¼');
    } else {
        System.debug('âœ… CustomNotificationType í™•ì¸ë¨: ' + notificationTypes[0].Id);
    }
    
    // 3. ê° ì—°ì²´ ê±´ì— ëŒ€í•´ ì¢…í•© ì•Œë¦¼ í…ŒìŠ¤íŠ¸
    List<Payment_Notification__c> testNotifications = new List<Payment_Notification__c>();
    
    for (PaymentStatus__c payment : overduePayments) {
        Payment_Notification__c notification = new Payment_Notification__c();
        notification.PaymentStatus__c = payment.Id;
        notification.NotificationType__c = 'ì—°ì²´ ì•Œë¦¼';
        notification.NotificationChannel__c = 'Salesforce'; // ì¼ë‹¨ Salesforceë§Œ í…ŒìŠ¤íŠ¸
        notification.NotificationStatus__c = 'Pending';
        notification.ScheduledDateTime__c = DateTime.now();
        // notification.RecipientEmail__c = 'test@example.com'; // í•„ë“œ í™•ì¸ í›„ ì¶”ê°€
        
        testNotifications.add(notification);
    }
    
    insert testNotifications;
    System.debug('âœ… í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë ˆì½”ë“œ ìƒì„± ì™„ë£Œ: ' + testNotifications.size() + 'ê±´');
    
    // 4. ê° ì±„ë„ë³„ ì•Œë¦¼ ë°œì†¡ í…ŒìŠ¤íŠ¸
    for (Payment_Notification__c notification : testNotifications) {
        // ê´€ê³„ í•„ë“œ ì¬ì¡°íšŒ
        Payment_Notification__c fullNotification = [
            SELECT Id, PaymentStatus__c, PaymentStatus__r.Order__c,
                   PaymentStatus__r.Order__r.Account.Name, PaymentStatus__r.Order__r.Account.Id,
                   PaymentStatus__r.Order__r.OrderNumber, PaymentStatus__r.InstallmentNumber__c,
                   PaymentStatus__r.Amount__c, PaymentStatus__r.DueDate__c, PaymentStatus__r.Status__c,
                   NotificationType__c, NotificationChannel__c
            FROM Payment_Notification__c 
            WHERE Id = :notification.Id
        ];
        
        System.debug('ğŸ“§ í…ŒìŠ¤íŠ¸ ëŒ€ìƒ: ' + fullNotification.PaymentStatus__r.Order__r.Account.Name + 
                    ' ' + fullNotification.PaymentStatus__r.InstallmentNumber__c + 'ì°¨');
        
        // 4-1. Salesforce ë‚´ë¶€ ì•Œë¦¼ í…ŒìŠ¤íŠ¸
        System.debug('ğŸ”” Salesforce ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ì¤‘...');
        Boolean salesforceResult = PaymentNotificationService.sendSalesforceNotification(fullNotification);
        System.debug('   ê²°ê³¼: ' + (salesforceResult ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'));
        
        // 4-2. ì´ë©”ì¼ ì•Œë¦¼ í…ŒìŠ¤íŠ¸
        System.debug('ğŸ“§ ì´ë©”ì¼ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ì¤‘...');
        Boolean emailResult = PaymentNotificationService.sendEmailNotification(fullNotification);
        System.debug('   ê²°ê³¼: ' + (emailResult ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'));
        
        // 4-3. ìŠ¬ë™ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ (ì˜µì…˜)
        System.debug('ğŸ’¬ ìŠ¬ë™ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ì¤‘...');
        Boolean slackResult = PaymentNotificationService.sendSlackNotification(fullNotification);
        System.debug('   ê²°ê³¼: ' + (slackResult ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'));
        
        System.debug('---');
    }
    
    // 5. Order í˜ì´ì§€ì—ì„œ ìƒì„±ëœ Task í™•ì¸
    System.debug('ğŸ“‹ ìƒì„±ëœ Task í™•ì¸ ì¤‘...');
    
    // Order ID ìˆ˜ì§‘
    Set<Id> orderIds = new Set<Id>();
    for (Payment_Notification__c notif : testNotifications) {
        // ê´€ê³„ í•„ë“œë¥¼ ë‹¤ì‹œ ì¿¼ë¦¬
        Payment_Notification__c temp = [
            SELECT PaymentStatus__r.Order__c 
            FROM Payment_Notification__c 
            WHERE Id = :notif.Id
        ];
        orderIds.add(temp.PaymentStatus__r.Order__c);
    }
    
    List<Task> createdTasks = [
        SELECT Id, Subject, WhatId, Priority, Status, ActivityDate, Description
        FROM Task 
        WHERE WhatId IN :orderIds
        AND CreatedDate = TODAY
        ORDER BY CreatedDate DESC
    ];
    
    System.debug('ğŸ“ ìƒì„±ëœ Task ìˆ˜: ' + createdTasks.size() + 'ê°œ');
    for (Task task : createdTasks) {
        System.debug('   â€¢ ' + task.Subject + ' (Order ID: ' + task.WhatId + ', ìš°ì„ ìˆœìœ„: ' + task.Priority + ')');
    }
    
    // 6. ìƒì„±ëœ Chatter í¬ìŠ¤íŠ¸ í™•ì¸
    System.debug('ğŸ’¬ ìƒì„±ëœ Chatter í¬ìŠ¤íŠ¸ í™•ì¸ ì¤‘...');
    List<FeedItem> chatterPosts = [
        SELECT Id, Body, ParentId, CreatedDate
        FROM FeedItem 
        WHERE ParentId IN :orderIds
        AND CreatedDate = TODAY
        ORDER BY CreatedDate DESC
    ];
    
    System.debug('ğŸ“„ ìƒì„±ëœ Chatter í¬ìŠ¤íŠ¸ ìˆ˜: ' + chatterPosts.size() + 'ê°œ');
    for (FeedItem post : chatterPosts) {
        System.debug('   â€¢ Order ID: ' + post.ParentId + ' - ' + post.Body.substring(0, Math.min(50, post.Body.length())) + '...');
    }
    
    // 7. Notes & Attachments PDF íŒŒì¼ í™•ì¸
    System.debug('ğŸ“ PDF ì²¨ë¶€íŒŒì¼ í™•ì¸ ì¤‘...');
    List<ContentDocumentLink> pdfFiles = [
        SELECT ContentDocument.Id, ContentDocument.Title, ContentDocument.FileExtension, LinkedEntityId
        FROM ContentDocumentLink 
        WHERE LinkedEntityId IN :orderIds
        AND ContentDocument.FileExtension = 'pdf'
        ORDER BY ContentDocument.CreatedDate DESC
    ];
    
    System.debug('ğŸ“ ë°œê²¬ëœ PDF íŒŒì¼ ìˆ˜: ' + pdfFiles.size() + 'ê°œ');
    for (ContentDocumentLink pdf : pdfFiles) {
        System.debug('   â€¢ ' + pdf.ContentDocument.Title + '.pdf (Order ID: ' + pdf.LinkedEntityId + ')');
    }
    
    // 8. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
    System.debug('');
    System.debug('ğŸ“Š =====í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½=====');
    System.debug('â€¢ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ìˆ˜: ' + testNotifications.size() + 'ê±´');
    System.debug('â€¢ ìƒì„±ëœ Task: ' + createdTasks.size() + 'ê°œ');
    System.debug('â€¢ ìƒì„±ëœ Chatter í¬ìŠ¤íŠ¸: ' + chatterPosts.size() + 'ê°œ');
    System.debug('â€¢ ì‚¬ìš© ê°€ëŠ¥í•œ PDF íŒŒì¼: ' + pdfFiles.size() + 'ê°œ');
    System.debug('â€¢ CustomNotificationType ìƒíƒœ: ' + (notificationTypes.isEmpty() ? 'âŒ ë¯¸ìƒì„±' : 'âœ… ìƒì„±ë¨'));
    
    System.debug('');
    System.debug('ğŸ¯ í™•ì¸ì‚¬í•­:');
    System.debug('1. Order í˜ì´ì§€ Activity Timelineì—ì„œ Task í™•ì¸');
    System.debug('2. Salesforce ìƒë‹¨ ë²¨ ì•„ì´ì½˜ì—ì„œ ì•Œë¦¼ í™•ì¸');
    System.debug('3. ì´ë©”ì¼ ìˆ˜ì‹ í•¨ì—ì„œ ê³ ê°/ê´€ë¦¬ì ë©”ì¼ í™•ì¸');
    System.debug('4. Order Chatterì—ì„œ ìë™ í¬ìŠ¤íŠ¸ í™•ì¸');
    
    System.debug('âœ… =====ì „ì²´ ì•Œë¦¼ ì‹œìŠ¤í…œ ì¢…í•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ=====');
    
} catch (Exception e) {
    System.debug('âŒ í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}
