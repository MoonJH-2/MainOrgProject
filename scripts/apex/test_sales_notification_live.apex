/**
 * Sales ì•± ì•Œë¦¼ ì‹œìŠ¤í…œ ì‹¤ì œ ë™ì‘ í…ŒìŠ¤íŠ¸
 * ìƒì„±: 2025-07-21
 * ëª©ì : OrderNotificationServiceì˜ ê° ê¸°ëŠ¥ë³„ ì‹¤ì œ ì•Œë¦¼ ë°œì†¡ í…ŒìŠ¤íŠ¸
 */

System.debug('ğŸ§ª Sales ì•± ì•Œë¦¼ ì‹œìŠ¤í…œ ì‹¤ì œ ë™ì‘ í…ŒìŠ¤íŠ¸ ì‹œì‘');

try {
    // 1. Order ë°ì´í„° ì¤€ë¹„ ë° ìƒì„± ì•Œë¦¼ í…ŒìŠ¤íŠ¸
    System.debug('ğŸ“‹ Step 1: Order ìƒì„± ì•Œë¦¼ í…ŒìŠ¤íŠ¸');
    
    List<Order> recentOrders = [
        SELECT Id, OrderNumber, TotalAmount, Account.Name, Status,
               Slack_Channel_Name__c, Slack_Notification_Status__c,
               CreatedDate
        FROM Order 
        WHERE CreatedDate = LAST_N_DAYS:7
        AND TotalAmount > 0
        ORDER BY CreatedDate DESC
        LIMIT 1
    ];
    
    if (!recentOrders.isEmpty()) {
        Order testOrder = recentOrders[0];
        System.debug('ğŸ“¦ í…ŒìŠ¤íŠ¸ Order: ' + testOrder.OrderNumber + ' (' + testOrder.Account.Name + ')');
        
        // ì‹¤ì œ ì•Œë¦¼ ë°œì†¡ í…ŒìŠ¤íŠ¸
        List<Order> testOrderList = new List<Order>{testOrder};
        OrderNotificationService.notifyOrderCreated(testOrderList);
        
        System.debug('âœ… Order ìƒì„± ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ - Sales ì•±ì—ì„œ ë²¨ ì•„ì´ì½˜ í™•ì¸í•˜ì„¸ìš”!');
    } else {
        System.debug('âš ï¸ í…ŒìŠ¤íŠ¸í•  Orderê°€ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    // 2. ì—°ì²´ PaymentStatus ìƒì„± ë° ì•Œë¦¼ í…ŒìŠ¤íŠ¸
    System.debug('ğŸ“‹ Step 2: ì—°ì²´ ì•Œë¦¼ í…ŒìŠ¤íŠ¸');
    
    // ê¸°ì¡´ ì—°ì²´ PaymentStatus ì¡°íšŒ
    List<PaymentStatus__c> existingOverduePayments = [
        SELECT Id, Order__c, Order__r.Account.Name, Order__r.OrderNumber,
               InstallmentNumber__c, Amount__c, DueDate__c, Status__c
        FROM PaymentStatus__c 
        WHERE Status__c = 'ì—°ì²´'
        AND DueDate__c < TODAY
        ORDER BY DueDate__c DESC
        LIMIT 1
    ];
    
    if (!existingOverduePayments.isEmpty()) {
        PaymentStatus__c testPayment = existingOverduePayments[0];
        Integer overdueDays = Date.today().daysBetween(testPayment.DueDate__c);
        
        System.debug('ğŸ’¸ í…ŒìŠ¤íŠ¸ ì—°ì²´: ' + testPayment.Order__r.OrderNumber + 
                     ' (' + testPayment.InstallmentNumber__c + 'ì°¨) - ' + 
                     Math.abs(overdueDays) + 'ì¼ ì—°ì²´');
        
        // ì‹¤ì œ ì—°ì²´ ì•Œë¦¼ ë°œì†¡ í…ŒìŠ¤íŠ¸
        List<PaymentStatus__c> testPaymentList = new List<PaymentStatus__c>{testPayment};
        OrderNotificationService.notifyOverduePayments(testPaymentList);
        
        System.debug('âœ… ì—°ì²´ ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ - Sales ì•±ì—ì„œ ë²¨ ì•„ì´ì½˜ í™•ì¸í•˜ì„¸ìš”!');
    } else {
        System.debug('â„¹ï¸ í˜„ì¬ ì—°ì²´ëœ PaymentStatusê°€ ì—†ìŠµë‹ˆë‹¤.');
        
        // í…ŒìŠ¤íŠ¸ìš© ì—°ì²´ ìƒí™© ì‹œë®¬ë ˆì´ì…˜
        List<PaymentStatus__c> allPayments = [
            SELECT Id, Order__c, Order__r.Account.Name, Order__r.OrderNumber,
                   InstallmentNumber__c, Amount__c, DueDate__c, Status__c
            FROM PaymentStatus__c 
            WHERE Status__c = 'ë¯¸ë‚©'
            AND DueDate__c < TODAY
            LIMIT 1
        ];
        
        if (!allPayments.isEmpty()) {
            PaymentStatus__c simulationPayment = allPayments[0];
            simulationPayment.Status__c = 'ì—°ì²´'; // ì‹œë®¬ë ˆì´ì…˜
            
            System.debug('ğŸ”¬ ì—°ì²´ ì‹œë®¬ë ˆì´ì…˜: ' + simulationPayment.Order__r.OrderNumber);
            
            List<PaymentStatus__c> simulationList = new List<PaymentStatus__c>{simulationPayment};
            OrderNotificationService.notifyOverduePayments(simulationList);
            
            System.debug('âœ… ì—°ì²´ ì‹œë®¬ë ˆì´ì…˜ ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ!');
        } else {
            System.debug('â„¹ï¸ ì‹œë®¬ë ˆì´ì…˜í•  PaymentStatusë„ ì—†ìŠµë‹ˆë‹¤.');
        }
    }
    
    // 3. Slack ì±„ë„ ìƒì„± ì•Œë¦¼ í…ŒìŠ¤íŠ¸
    System.debug('ğŸ“‹ Step 3: Slack ì±„ë„ ìƒì„± ì•Œë¦¼ í…ŒìŠ¤íŠ¸');
    
    List<Order> ordersWithSlack = [
        SELECT Id, OrderNumber, Slack_Channel_Name__c, Slack_Notification_Status__c
        FROM Order 
        WHERE Slack_Channel_Name__c != null
        AND Slack_Notification_Status__c = 'Created'
        ORDER BY CreatedDate DESC
        LIMIT 1
    ];
    
    if (!ordersWithSlack.isEmpty()) {
        Order testSlackOrder = ordersWithSlack[0];
        System.debug('ğŸ”— í…ŒìŠ¤íŠ¸ Slack ì±„ë„: ' + testSlackOrder.OrderNumber + ' â†’ #' + testSlackOrder.Slack_Channel_Name__c);
        
        // ì‹¤ì œ Slack ì±„ë„ ìƒì„± ì•Œë¦¼ ë°œì†¡ í…ŒìŠ¤íŠ¸
        List<Order> testSlackList = new List<Order>{testSlackOrder};
        OrderNotificationService.notifySlackChannelCreated(testSlackList);
        
        System.debug('âœ… Slack ì±„ë„ ìƒì„± ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ - Sales ì•±ì—ì„œ ë²¨ ì•„ì´ì½˜ í™•ì¸í•˜ì„¸ìš”!');
    } else {
        System.debug('â„¹ï¸ Slack ì±„ë„ì´ ìƒì„±ëœ Orderê°€ ì—†ìŠµë‹ˆë‹¤.');
        
        // í…ŒìŠ¤íŠ¸ìš© Slack ì±„ë„ ì‹œë®¬ë ˆì´ì…˜
        if (!recentOrders.isEmpty()) {
            Order simulationSlackOrder = recentOrders[0];
            simulationSlackOrder.Slack_Channel_Name__c = simulationSlackOrder.OrderNumber; // ì‹œë®¬ë ˆì´ì…˜
            simulationSlackOrder.Slack_Notification_Status__c = 'Created'; // ì‹œë®¬ë ˆì´ì…˜
            
            System.debug('ğŸ”¬ Slack ì±„ë„ ì‹œë®¬ë ˆì´ì…˜: #' + simulationSlackOrder.Slack_Channel_Name__c);
            
            List<Order> simulationSlackList = new List<Order>{simulationSlackOrder};
            OrderNotificationService.notifySlackChannelCreated(simulationSlackList);
            
            System.debug('âœ… Slack ì±„ë„ ì‹œë®¬ë ˆì´ì…˜ ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ!');
        }
    }
    
    // 4. ì•Œë¦¼ ìˆ˜ì‹ ì í™•ì¸
    System.debug('ğŸ“‹ Step 4: ì•Œë¦¼ ìˆ˜ì‹ ì ì •ë³´ í™•ì¸');
    
    User currentUser = [
        SELECT Id, Name, Email, ManagerId, Manager.Name, Manager.Email
        FROM User
        WHERE Id = :UserInfo.getUserId()
        LIMIT 1
    ];
    
    System.debug('ğŸ‘¤ í˜„ì¬ ì‚¬ìš©ì: ' + currentUser.Name + ' (' + currentUser.Email + ')');
    if (currentUser.Manager != null) {
        System.debug('ğŸ‘¥ Manager: ' + currentUser.Manager.Name + ' (' + currentUser.Manager.Email + ')');
        System.debug('   â†’ Managerë„ ì•Œë¦¼ì„ ë°›ê²Œ ë©ë‹ˆë‹¤.');
    } else {
        System.debug('ğŸ‘¥ Managerê°€ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    // 5. CustomNotificationType ìµœì¢… í™•ì¸
    System.debug('ğŸ“‹ Step 5: CustomNotificationType ìµœì¢… í™•ì¸');
    
    List<CustomNotificationType> salesNotificationTypes = [
        SELECT Id, DeveloperName, MasterLabel
        FROM CustomNotificationType
        WHERE DeveloperName = 'Sales_Order_Notification'
        LIMIT 1
    ];
    
    if (!salesNotificationTypes.isEmpty()) {
        System.debug('âœ… CustomNotificationType í™•ì¸: ' + salesNotificationTypes[0].MasterLabel);
        System.debug('   ID: ' + salesNotificationTypes[0].Id);
    }
    
    // 6. ë¸Œë¼ìš°ì € ì•Œë¦¼ ì„¤ì • ì•ˆë‚´
    System.debug('ğŸ“‹ Step 6: ì‚¬ìš©ì ë¸Œë¼ìš°ì € ì„¤ì • í™•ì¸ í•„ìš”');
    System.debug('=====================================');
    System.debug('ğŸ“± Sales ì•± ì•Œë¦¼ í™•ì¸ ë°©ë²•:');
    System.debug('=====================================');
    System.debug('1. ğŸ”” Lightning Experience ìƒë‹¨ ë²¨ ì•„ì´ì½˜ í´ë¦­');
    System.debug('2. ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸');
    System.debug('3. ì•Œë¦¼ì´ íŒì—…ìœ¼ë¡œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸');
    System.debug('4. Mobile Salesforce ì•±ì—ì„œë„ í‘¸ì‹œ ì•Œë¦¼ í™•ì¸');
    System.debug('=====================================');
    
    System.debug('ğŸ¯ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½:');
    System.debug('âœ… OrderNotificationService.notifyOrderCreated() ì‹¤í–‰ë¨');
    System.debug('âœ… OrderNotificationService.notifyOverduePayments() ì‹¤í–‰ë¨');
    System.debug('âœ… OrderNotificationService.notifySlackChannelCreated() ì‹¤í–‰ë¨');
    System.debug('âœ… CustomNotificationType ì„¤ì • í™•ì¸ë¨');
    System.debug('');
    System.debug('ğŸ” ë‹¤ìŒ í™•ì¸ì‚¬í•­:');
    System.debug('- Lightning Experienceì—ì„œ ë²¨ ì•„ì´ì½˜ ì•Œë¦¼ í™•ì¸');
    System.debug('- ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ì„¤ì • í™•ì¸');
    System.debug('- Trigger ìë™ ì‹¤í–‰ ì‹œ ì•Œë¦¼ ë°œì†¡ í™•ì¸');
    
    System.debug('ğŸ§ª Sales ì•± ì•Œë¦¼ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!');
    
} catch (Exception e) {
    System.debug('âŒ Sales ì•± ì•Œë¦¼ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('âŒ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
}
