/**
 * Order 00000156 ìˆ˜ë™ Salesforce ì±„ë„ ìƒì„± ìŠ¤í¬ë¦½íŠ¸
 * ëª©ì : ê¸°ì¡´ Orderì— ëŒ€í•´ ì¦‰ì‹œ ì±„ë„ ìƒì„±
 */

System.debug('=== ğŸš€ Order 00000156 Salesforce ì±„ë„ ìƒì„± ===');

try {
    // 1. Order ì •ë³´ ì¡°íšŒ
    List<Order> orders = [
        SELECT Id, Name, OrderNumber, Status, OwnerId, AccountId
        FROM Order 
        WHERE OrderNumber = '00000156'
        LIMIT 1
    ];
    
    if(orders.isEmpty()) {
        System.debug('âŒ Order 00000156ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Order order156 = orders[0];
    System.debug('ğŸ“‹ Order ì •ë³´: ' + order156.OrderNumber + ' (ìƒíƒœ: ' + order156.Status + ')');
    
    // 2. ê¸°ì¡´ ì±„ë„ í™•ì¸
    List<CollaborationGroup> existingChannels = [
        SELECT Id, Name, MemberCount 
        FROM CollaborationGroup 
        WHERE Name LIKE '%00000156%'
    ];
    
    if(!existingChannels.isEmpty()) {
        System.debug('âš ï¸ ì´ë¯¸ ì±„ë„ì´ ì¡´ì¬í•©ë‹ˆë‹¤:');
        for(CollaborationGroup channel : existingChannels) {
            System.debug('- ' + channel.Name + ' (ID: ' + channel.Id + ')');
        }
        
        // ê¸°ì¡´ ì±„ë„ì— í™˜ì˜ ë©”ì‹œì§€ ì¶”ê°€
        String updateMessage = 'ğŸ”„ Order 00000156 ì±„ë„ ì—…ë°ì´íŠ¸\n\n';
        updateMessage += 'ì´ ì±„ë„ì´ Order 00000156ì˜ ê³µì‹ Salesforce ì±„ë„ë¡œ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n';
        updateMessage += 'ğŸ“… ì—…ë°ì´íŠ¸ ë‚ ì§œ: ' + System.now().format('yyyy-MM-dd HH:mm') + '\n';
        updateMessage += 'ğŸ¯ ìƒíƒœ: Activated\n';
        updateMessage += 'ğŸ’° ì´ ê¸ˆì•¡: â‚©990,000\n';
        updateMessage += 'ğŸ“‹ ë‚©ë¶€ ë°©ì‹: ë¶„ê¸°ë³„\n\n';
        updateMessage += 'âœ¨ í™œìš© ê°€ëŠ¥í•œ ê¸°ëŠ¥:\n';
        updateMessage += 'â€¢ ğŸ”” ì‹¤ì‹œê°„ @ë©˜ì…˜ ì•Œë¦¼\n';
        updateMessage += 'â€¢ ğŸ“„ íŒŒì¼ ê³µìœ  ë° í˜‘ì—…\n';
        updateMessage += 'â€¢ ğŸ’³ Payment ì•Œë¦¼ ìë™ ìˆ˜ì‹ \n';
        updateMessage += 'â€¢ ğŸ“± ëª¨ë°”ì¼ ì•± ì™„ë²½ ì§€ì›\n\n';
        updateMessage += 'ğŸ”— Order ë°”ë¡œê°€ê¸°: ' + System.URL.getOrgDomainUrl().toExternalForm() + 
                        '/lightning/r/Order/' + order156.Id + '/view\n\n';
        updateMessage += '#Order00000156 #ì±„ë„í™œì„±í™” #íŒ€í˜‘ì—…';
        
        SimpleSalesforceChannelService.sendChannelMessage(existingChannels[0].Id, updateMessage);
        System.debug('âœ… ê¸°ì¡´ ì±„ë„ì— ì—…ë°ì´íŠ¸ ë©”ì‹œì§€ ê²Œì‹œ ì™„ë£Œ');
        
        return;
    }
    
    // 3. ìƒˆ ì±„ë„ ìƒì„±
    System.debug('=== ğŸ—ï¸ ìƒˆ Salesforce ì±„ë„ ìƒì„± ===');
    
    String channelId = SimpleSalesforceChannelService.createOrderChannel(order156.Id);
    
    if(channelId != null) {
        System.debug('âœ… ì±„ë„ ìƒì„± ì„±ê³µ: ' + channelId);
        
        // 4. ë©¤ë²„ ì¶”ê°€
        System.debug('=== ğŸ‘¥ ë©¤ë²„ ì¶”ê°€ ===');
        
        // Order Owner ì¶”ê°€
        Boolean ownerAdded = SimpleSalesforceChannelService.addUserToChannel(channelId, order156.OwnerId);
        System.debug('Order Owner ì¶”ê°€: ' + (ownerAdded ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'));
        
        // í˜„ì¬ ì‚¬ìš©ì ì¶”ê°€ (Order Ownerì™€ ë‹¤ë¥¸ ê²½ìš°)
        if(UserInfo.getUserId() != order156.OwnerId) {
            Boolean currentUserAdded = SimpleSalesforceChannelService.addUserToChannel(channelId, UserInfo.getUserId());
            System.debug('í˜„ì¬ ì‚¬ìš©ì ì¶”ê°€: ' + (currentUserAdded ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'));
        }
        
        // 5. í™˜ì˜ ë©”ì‹œì§€
        System.debug('=== ğŸ’¬ í™˜ì˜ ë©”ì‹œì§€ ê²Œì‹œ ===');
        
        Boolean welcomePosted = SimpleSalesforceChannelService.postWelcomeMessage(channelId, order156.Id, order156.OrderNumber);
        System.debug('í™˜ì˜ ë©”ì‹œì§€ ê²Œì‹œ: ' + (welcomePosted ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'));
        
        // 6. ì¶”ê°€ ì •ë³´ ë©”ì‹œì§€
        String infoMessage = 'ğŸ“Š Order 00000156 ìƒì„¸ ì •ë³´\n\n';
        infoMessage += 'ğŸ¢ Account: (ì£¼)ê·¸ë¦°íŒŒì›Œí…\n';
        infoMessage += 'ğŸ’° ì´ ê¸ˆì•¡: â‚©990,000\n';
        infoMessage += 'ğŸ“… ì‹œì‘ì¼: 2025-07-20\n';
        infoMessage += 'ğŸ“… ì¢…ë£Œì¼: 2026-07-13\n';
        infoMessage += 'ğŸ’³ ë‚©ë¶€ ë°©ì‹: ë¶„ê¸°ë³„\n';
        infoMessage += 'ğŸ“‹ ê³„ì•½ ë²ˆí˜¸: 00000115\n';
        infoMessage += 'âš¡ ìƒíƒœ: Activated\n\n';
        infoMessage += 'ğŸ’¡ ì´ ì±„ë„ì—ì„œ Order ê´€ë ¨ ëª¨ë“  ì†Œí†µê³¼ í˜‘ì—…ì„ ì§„í–‰í•˜ì„¸ìš”!\n';
        infoMessage += 'ğŸ”” Payment ì•Œë¦¼ë„ ì´ ì±„ë„ì—ì„œ ìë™ìœ¼ë¡œ ìˆ˜ì‹ ë©ë‹ˆë‹¤.\n\n';
        infoMessage += '#Orderì •ë³´ #íŒ€í˜‘ì—… #ìë™í™”';
        
        SimpleSalesforceChannelService.sendChannelMessage(channelId, infoMessage);
        System.debug('âœ… ì¶”ê°€ ì •ë³´ ë©”ì‹œì§€ ê²Œì‹œ ì™„ë£Œ');
        
        // 7. ìµœì¢… ê²°ê³¼
        System.debug('\n=== ğŸ‰ Order 00000156 ì±„ë„ ìƒì„± ì™„ë£Œ! ===');
        System.debug('ì±„ë„ ID: ' + channelId);
        System.debug('ì±„ë„ëª…: Order-00000156');
        
        System.debug('\n=== ğŸ“± Sales ì•±ì—ì„œ í™•ì¸í•˜ê¸° ===');
        System.debug('1. Sales ì•± â†’ Chatter â†’ ê·¸ë£¹');
        System.debug('2. ê²€ìƒ‰: "Order-00000156" ë˜ëŠ” "00000156"');
        System.debug('3. ì§ì ‘ URL: /lightning/r/CollaborationGroup/' + channelId + '/view');
        
        System.debug('\n=== ğŸ”¥ ë‹¤ìŒ ë‹¨ê³„ ===');
        System.debug('1. íŒ€ì›ë“¤ì„ ì±„ë„ì— ì´ˆëŒ€');
        System.debug('2. @ë©˜ì…˜ìœ¼ë¡œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸');
        System.debug('3. íŒŒì¼ ê³µìœ  ê¸°ëŠ¥ í™œìš©');
        System.debug('4. Payment ì•Œë¦¼ ìë™ ìˆ˜ì‹  í™•ì¸');
        
    } else {
        System.debug('âŒ ì±„ë„ ìƒì„± ì‹¤íŒ¨');
    }
    
} catch(Exception e) {
    System.debug('âŒ ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage());
    System.debug('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
}

System.debug('\n=== âœ… Order 00000156 ì±„ë„ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì™„ë£Œ ===');
