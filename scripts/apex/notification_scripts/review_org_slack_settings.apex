// Salesforce Org ë‚´ Slack ì—°ë™ ì„¤ì • ê²€í†  ìŠ¤í¬ë¦½íŠ¸
// Order 00000158 Slack Channel í™œì„±í™”ë¥¼ ìœ„í•œ ì¡°ì§ ë ˆë²¨ ì„¤ì • ë¶„ì„

try {
    System.debug('=== Salesforce Org Slack ì—°ë™ ì„¤ì • ê²€í†  ===');
    
    // 1. Order 00000158 í˜„ì¬ ìƒíƒœ ì¬í™•ì¸
    List<Order> orders = [
        SELECT Id, OrderNumber, Slack_Channel_ID__c, Slack_Channel_Name__c, 
               Slack_Notification_Status__c, Slack_Webhook_URL__c
        FROM Order 
        WHERE OrderNumber = '00000158'
        LIMIT 1
    ];
    
    if (!orders.isEmpty()) {
        Order order = orders[0];
        System.debug('ğŸ“‹ Order 00000158 í˜„ì¬ ìƒíƒœ:');
        System.debug('- Slack Channel ID: ' + order.Slack_Channel_ID__c);
        System.debug('- Slack Channel Name: ' + order.Slack_Channel_Name__c);
        System.debug('- Slack Notification Status: ' + order.Slack_Notification_Status__c);
        System.debug('- Slack Webhook URL: ' + order.Slack_Webhook_URL__c);
    }
    
    // 2. Slack ê´€ë ¨ Custom Setting í™•ì¸
    System.debug('\n=== Custom Settings í™•ì¸ ===');
    
    // ê°€ëŠ¥í•œ Slack ì„¤ì •ë“¤ í™•ì¸
    try {
        // Organization-wide Default ì„¤ì •ì´ ìˆëŠ”ì§€ í™•ì¸
        Map<String, Schema.SObjectType> globalDescribe = Schema.getGlobalDescribe();
        
        List<String> possibleSlackSettings = new List<String>{
            'SlackSettings__c',
            'Slack_Configuration__c', 
            'Integration_Settings__c',
            'Channel_Settings__c'
        };
        
        for (String settingName : possibleSlackSettings) {
            if (globalDescribe.containsKey(settingName)) {
                System.debug('âœ… ë°œê²¬ëœ Custom Setting: ' + settingName);
            } else {
                System.debug('âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì„¤ì •: ' + settingName);
            }
        }
        
    } catch (Exception e) {
        System.debug('Custom Settings í™•ì¸ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
    }
    
    // 3. Slack App ì—°ê²° ìƒíƒœ í™•ì¸
    System.debug('\n=== Slack App ì—°ê²° ìƒíƒœ í™•ì¸ ===');
    
    // ConnectedApplication í™•ì¸ (Slack App)
    List<ConnectedApplication> slackApps = [
        SELECT Id, Name, CreatedDate, LastModifiedDate
        FROM ConnectedApplication 
        WHERE Name LIKE '%Slack%' 
        OR Name LIKE '%slack%'
        LIMIT 5
    ];
    
    if (slackApps.isEmpty()) {
        System.debug('âŒ Slack Connected Applicationì´ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ');
        System.debug('ğŸ’¡ í•´ê²°ì±…: AppExchangeì—ì„œ Slack for Salesforce ì„¤ì¹˜ í•„ìš”');
    } else {
        System.debug('âœ… Slack Connected Applications ë°œê²¬: ' + slackApps.size() + 'ê°œ');
        for (ConnectedApplication app : slackApps) {
            System.debug('- App Name: ' + app.Name);
            System.debug('- Created: ' + app.CreatedDate);
        }
    }
    
    // 4. Permission Set í™•ì¸
    System.debug('\n=== Permission Set í™•ì¸ ===');
    
    List<PermissionSet> slackPermSets = [
        SELECT Id, Name, Label, Description
        FROM PermissionSet 
        WHERE Name LIKE '%Slack%' 
        OR Label LIKE '%Slack%'
        OR Description LIKE '%Slack%'
        LIMIT 5
    ];
    
    if (slackPermSets.isEmpty()) {
        System.debug('âŒ Slack ê´€ë ¨ Permission Set ì—†ìŒ');
        System.debug('ğŸ’¡ í•´ê²°ì±…: Slack ê´€ë ¨ ê¶Œí•œ ì„¤ì • í•„ìš”');
    } else {
        System.debug('âœ… Slack Permission Sets ë°œê²¬: ' + slackPermSets.size() + 'ê°œ');
        for (PermissionSet ps : slackPermSets) {
            System.debug('- Permission Set: ' + ps.Name + ' (' + ps.Label + ')');
        }
    }
    
    // 5. Current Userì˜ Slack ê¶Œí•œ í™•ì¸
    System.debug('\n=== í˜„ì¬ ì‚¬ìš©ì Slack ê¶Œí•œ í™•ì¸ ===');
    
    User currentUser = [
        SELECT Id, Name, Profile.Name, UserPermissionsSlackUser
        FROM User 
        WHERE Id = :UserInfo.getUserId()
        LIMIT 1
    ];
    
    System.debug('í˜„ì¬ ì‚¬ìš©ì: ' + currentUser.Name);
    System.debug('í”„ë¡œí•„: ' + currentUser.Profile.Name);
    System.debug('Slack User ê¶Œí•œ: ' + currentUser.UserPermissionsSlackUser);
    
    if (!currentUser.UserPermissionsSlackUser) {
        System.debug('âŒ í˜„ì¬ ì‚¬ìš©ìì—ê²Œ Slack User ê¶Œí•œ ì—†ìŒ');
        System.debug('ğŸ’¡ í•´ê²°ì±…: ì‚¬ìš©ì í”„ë¡œí•„ ë˜ëŠ” Permission Setì—ì„œ Slack ê¶Œí•œ í™œì„±í™” í•„ìš”');
    }
    
    // 6. Chatter ì„¤ì • í™•ì¸
    System.debug('\n=== Chatter ì„¤ì • í™•ì¸ ===');
    
    Organization orgInfo = [
        SELECT Id, IsSandbox, InstanceName, OrganizationType
        FROM Organization
        LIMIT 1
    ];
    
    System.debug('ì¡°ì§ ìœ í˜•: ' + orgInfo.OrganizationType);
    System.debug('Sandbox ì—¬ë¶€: ' + orgInfo.IsSandbox);
    System.debug('ì¸ìŠ¤í„´ìŠ¤: ' + orgInfo.InstanceName);
    
    // 7. í•„ìˆ˜ ì„¤ì • ê²€í†  ê²°ê³¼
    System.debug('\n=== í•„ìˆ˜ ì„¤ì • ê²€í†  ê²°ê³¼ ===');
    
    List<String> requiredActions = new List<String>();
    
    if (slackApps.isEmpty()) {
        requiredActions.add('1. AppExchangeì—ì„œ "Slack for Salesforce" ì•± ì„¤ì¹˜');
    }
    
    if (!currentUser.UserPermissionsSlackUser) {
        requiredActions.add('2. ì‚¬ìš©ì í”„ë¡œí•„ì—ì„œ "Slack User" ê¶Œí•œ í™œì„±í™”');
    }
    
    if (slackPermSets.isEmpty()) {
        requiredActions.add('3. Slack ê´€ë ¨ Permission Set í• ë‹¹');
    }
    
    // Webhook URLì´ ë¹„ì–´ìˆëŠ” ê²½ìš°
    if (!orders.isEmpty() && String.isBlank(orders[0].Slack_Webhook_URL__c)) {
        requiredActions.add('4. Orderì— Slack Webhook URL ì„¤ì •');
    }
    
    if (requiredActions.isEmpty()) {
        System.debug('âœ… ëª¨ë“  í•„ìˆ˜ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        System.debug('ğŸ’¡ Orderì˜ Slack_Notification_Status__cë§Œ "Created"ë¡œ ì—…ë°ì´íŠ¸í•˜ë©´ ë©ë‹ˆë‹¤.');
    } else {
        System.debug('ğŸ”§ ë‹¤ìŒ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤:');
        for (String action : requiredActions) {
            System.debug('   ' + action);
        }
    }
    
} catch (Exception e) {
    System.debug('âŒ ì„¤ì • ê²€í†  ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
}
