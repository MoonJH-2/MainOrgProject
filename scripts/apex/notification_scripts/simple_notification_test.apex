// κ°„λ‹¨ν• μ•λ¦Ό μ‹μ¤ν… ν…μ¤νΈ
System.debug('π€ =====κ°„λ‹¨ μ•λ¦Ό ν…μ¤νΈ μ‹μ‘=====');

try {
    // 1. μ—°μ²΄λ PaymentStatus μ΅°ν
    List<PaymentStatus__c> overduePayments = [
        SELECT Id, Order__c, Order__r.Account.Name, Order__r.OrderNumber, 
               InstallmentNumber__c, Amount__c, DueDate__c, Status__c
        FROM PaymentStatus__c 
        WHERE Status__c != 'μ™„λ‚©' 
        AND DueDate__c < TODAY
        ORDER BY DueDate__c ASC
        LIMIT 1
    ];
    
    if (overduePayments.isEmpty()) {
        System.debug('β ν…μ¤νΈν•  μ—°μ²΄ λ°μ΄ν„°κ°€ μ—†μµλ‹λ‹¤.');
        return;
    }
    
    PaymentStatus__c payment = overduePayments[0];
    System.debug('π“ ν…μ¤νΈ λ€μƒ: ' + payment.Order__r.Account.Name + ' ' + payment.InstallmentNumber__c + 'μ°¨');
    
    // 2. Payment_Notification__c λ μ½”λ“ μƒμ„±
    Payment_Notification__c notification = new Payment_Notification__c();
    notification.PaymentStatus__c = payment.Id;
    notification.NotificationType__c = 'μ—°μ²΄ μ•λ¦Ό';
    notification.NotificationChannel__c = 'Salesforce';
    notification.NotificationStatus__c = 'Pending';
    notification.ScheduledDateTime__c = DateTime.now();
    
    insert notification;
    System.debug('β… μ•λ¦Ό λ μ½”λ“ μƒμ„±: ' + notification.Id);
    
    // 3. κ΄€κ³„ ν•„λ“μ™€ ν•¨κ» λ‹¤μ‹ μ΅°ν
    Payment_Notification__c fullNotification = [
        SELECT Id, PaymentStatus__c, PaymentStatus__r.Order__c,
               PaymentStatus__r.Order__r.Account.Name, PaymentStatus__r.Order__r.Account.Id,
               PaymentStatus__r.Order__r.OrderNumber, PaymentStatus__r.InstallmentNumber__c,
               PaymentStatus__r.Amount__c, PaymentStatus__r.DueDate__c, PaymentStatus__r.Status__c,
               NotificationType__c, NotificationChannel__c
        FROM Payment_Notification__c 
        WHERE Id = :notification.Id
    ];
    
    // 4. Salesforce μ•λ¦Ό ν…μ¤νΈ
    System.debug('π”” Salesforce μ•λ¦Ό λ°μ†΅ μ¤‘...');
    Boolean result = PaymentNotificationService.sendSalesforceNotification(fullNotification);
    System.debug('   κ²°κ³Ό: ' + (result ? 'β… μ„±κ³µ' : 'β μ‹¤ν¨'));
    
    // 5. μƒμ„±λ Task ν™•μΈ
    List<Task> createdTasks = [
        SELECT Id, Subject, WhatId, Priority, Status, ActivityDate
        FROM Task 
        WHERE WhatId = :payment.Order__c
        AND CreatedDate = TODAY
        ORDER BY CreatedDate DESC
        LIMIT 5
    ];
    
    System.debug('π“ μƒμ„±λ Task: ' + createdTasks.size() + 'κ°');
    for (Task task : createdTasks) {
        System.debug('   β€Ά ' + task.Subject + ' (μ°μ„ μμ„: ' + task.Priority + ')');
    }
    
    // 6. Chatter ν¬μ¤νΈ ν™•μΈ
    List<FeedItem> posts = [
        SELECT Id, Body
        FROM FeedItem 
        WHERE ParentId = :payment.Order__c
        AND CreatedDate = TODAY
        ORDER BY CreatedDate DESC
        LIMIT 3
    ];
    
    System.debug('π’¬ μƒμ„±λ Chatter ν¬μ¤νΈ: ' + posts.size() + 'κ°');
    for (FeedItem post : posts) {
        System.debug('   β€Ά ' + post.Body.substring(0, Math.min(50, post.Body.length())) + '...');
    }
    
    System.debug('β… =====κ°„λ‹¨ μ•λ¦Ό ν…μ¤νΈ μ™„λ£=====');
    
} catch (Exception e) {
    System.debug('β ν…μ¤νΈ μ¤λ¥: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}
