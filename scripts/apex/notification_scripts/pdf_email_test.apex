// PDF íŒŒì¼ ì—…ë¡œë“œ ë° ì´ë©”ì¼ ì¬í…ŒìŠ¤íŠ¸
System.debug('ğŸ“ =====PDF ì²¨ë¶€ ë° ì´ë©”ì¼ ì¬í…ŒìŠ¤íŠ¸=====');

try {
    // ìµœê·¼ ì•Œë¦¼ ë ˆì½”ë“œ ì¡°íšŒ
    List<Payment_Notification__c> notifications = [
        SELECT Id, PaymentStatus__c, PaymentStatus__r.Order__c,
               PaymentStatus__r.Order__r.Account.Name, PaymentStatus__r.Order__r.Account.Id,
               PaymentStatus__r.Order__r.OrderNumber, PaymentStatus__r.InstallmentNumber__c,
               PaymentStatus__r.Amount__c, PaymentStatus__r.DueDate__c, PaymentStatus__r.Status__c,
               NotificationType__c, NotificationChannel__c
        FROM Payment_Notification__c 
        WHERE CreatedDate = TODAY
        ORDER BY CreatedDate DESC
        LIMIT 1
    ];
    
    if (notifications.isEmpty()) {
        System.debug('âŒ í…ŒìŠ¤íŠ¸í•  ì•Œë¦¼ ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Payment_Notification__c notification = notifications[0];
    Id orderId = notification.PaymentStatus__r.Order__c;
    
    System.debug('ğŸ“Š í…ŒìŠ¤íŠ¸ Order: ' + notification.PaymentStatus__r.Order__r.OrderNumber);
    
    // í…ŒìŠ¤íŠ¸ìš© PDF íŒŒì¼ ìƒì„± ë° ì—…ë¡œë“œ
    String pdfContent = '%PDF-1.4\n1 0 obj\n<<\n/Type /Catalog\n/Pages 2 0 R\n>>\nendobj\n\n2 0 obj\n<<\n/Type /Pages\n/Kids [3 0 R]\n/Count 1\n>>\nendobj\n\n3 0 obj\n<<\n/Type /Page\n/Parent 2 0 R\n/MediaBox [0 0 612 792]\n/Contents 4 0 R\n>>\nendobj\n\n4 0 obj\n<<\n/Length 44\n>>\nstream\nBT\n/F1 12 Tf\n100 700 Td\n(Test PDF Document) Tj\nET\nendstream\nendobj\n\nxref\n0 5\n0000000000 65535 f \n0000000009 00000 n \n0000000058 00000 n \n0000000115 00000 n \n0000000204 00000 n \ntrailer\n<<\n/Size 5\n/Root 1 0 R\n>>\nstartxref\n298\n%%EOF';
    
    // ContentVersion ìƒì„±
    ContentVersion cv = new ContentVersion();
    cv.Title = 'ë‚©ë¶€ì„œ_' + notification.PaymentStatus__r.Order__r.OrderNumber;
    cv.PathOnClient = cv.Title + '.pdf';
    cv.VersionData = Blob.valueOf(pdfContent);
    cv.ContentLocation = 'S';
    insert cv;
    
    // ContentDocument ID ì¡°íšŒ
    ContentVersion insertedCV = [SELECT ContentDocumentId FROM ContentVersion WHERE Id = :cv.Id];
    
    // ContentDocumentLink ìƒì„± (Orderì— ì—°ê²°)
    ContentDocumentLink cdl = new ContentDocumentLink();
    cdl.ContentDocumentId = insertedCV.ContentDocumentId;
    cdl.LinkedEntityId = orderId;
    cdl.ShareType = 'V';
    cdl.Visibility = 'AllUsers';
    insert cdl;
    
    System.debug('âœ… í…ŒìŠ¤íŠ¸ PDF íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ: ' + cv.Title + '.pdf');
    
    // PDF íŒŒì¼ ì¬í™•ì¸
    List<ContentDocumentLink> pdfFiles = [
        SELECT ContentDocument.Id, ContentDocument.Title, ContentDocument.FileExtension
        FROM ContentDocumentLink 
        WHERE LinkedEntityId = :orderId
        AND ContentDocument.FileExtension = 'pdf'
        ORDER BY ContentDocument.CreatedDate DESC
    ];
    
    System.debug('ğŸ“ ì—°ê²°ëœ PDF íŒŒì¼ ìˆ˜: ' + pdfFiles.size() + 'ê°œ');
    for (ContentDocumentLink pdf : pdfFiles) {
        System.debug('   â€¢ ' + pdf.ContentDocument.Title + '.pdf');
    }
    
    // ì´ë©”ì¼ ë°œì†¡ ì¬í…ŒìŠ¤íŠ¸
    System.debug('ğŸ“® ì´ë©”ì¼ ë°œì†¡ ì¬í…ŒìŠ¤íŠ¸ ì¤‘...');
    Boolean emailResult = PaymentNotificationService.sendEmailNotification(notification);
    System.debug('   ì´ë©”ì¼ ë°œì†¡ ê²°ê³¼: ' + (emailResult ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'));
    
    if (emailResult) {
        System.debug('ğŸ“§ ë°œì†¡ëœ ì´ë©”ì¼:');
        System.debug('   â€¢ ê³ ê°: mail@gmail.com');
        System.debug('   â€¢ ê´€ë¦¬ì: eetd0000@gmail.com, hyowonhong.dsic@gmail.com, rm.chloe.kim@gmail.com');
        System.debug('   â€¢ PDF ì²¨ë¶€: ' + (pdfFiles.size() > 0 ? cv.Title + '.pdf' : 'ì—†ìŒ'));
    }
    
    System.debug('âœ… =====PDF ì²¨ë¶€ ë° ì´ë©”ì¼ ì¬í…ŒìŠ¤íŠ¸ ì™„ë£Œ=====');
    
} catch (Exception e) {
    System.debug('âŒ PDF ì²¨ë¶€ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}
