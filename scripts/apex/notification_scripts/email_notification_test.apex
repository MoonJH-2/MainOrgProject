// ì´ë©”ì¼ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ (PDF ì²¨ë¶€ í¬í•¨)
System.debug('ğŸ“§ =====ì´ë©”ì¼ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ì‹œì‘=====');

try {
    // ê¸°ì¡´ ì•Œë¦¼ ë ˆì½”ë“œ ì¡°íšŒ (ê°€ì¥ ìµœê·¼ ê²ƒ)
    List<Payment_Notification__c> notifications = [
        SELECT Id, PaymentStatus__c, PaymentStatus__r.Order__c,
               PaymentStatus__r.Order__r.Account.Name, PaymentStatus__r.Order__r.Account.Id,
               PaymentStatus__r.Order__r.OrderNumber, PaymentStatus__r.InstallmentNumber__c,
               PaymentStatus__r.Amount__c, PaymentStatus__r.DueDate__c, PaymentStatus__r.Status__c,
               NotificationType__c, NotificationChannel__c
        FROM Payment_Notification__c 
        WHERE CreatedDate = TODAY
        ORDER BY CreatedDate DESC
        LIMIT 1
    ];
    
    if (notifications.isEmpty()) {
        System.debug('âŒ í…ŒìŠ¤íŠ¸í•  ì•Œë¦¼ ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Payment_Notification__c notification = notifications[0];
    System.debug('ğŸ“Š í…ŒìŠ¤íŠ¸ ëŒ€ìƒ: ' + notification.PaymentStatus__r.Order__r.Account.Name + 
                 ' ' + notification.PaymentStatus__r.InstallmentNumber__c + 'ì°¨');
    
    // PDF íŒŒì¼ í™•ì¸
    List<ContentDocumentLink> pdfFiles = [
        SELECT ContentDocument.Id, ContentDocument.Title, ContentDocument.FileExtension
        FROM ContentDocumentLink 
        WHERE LinkedEntityId = :notification.PaymentStatus__r.Order__c
        AND ContentDocument.FileExtension = 'pdf'
        ORDER BY ContentDocument.CreatedDate DESC
        LIMIT 1
    ];
    
    System.debug('ğŸ“ PDF íŒŒì¼ ìˆ˜: ' + pdfFiles.size() + 'ê°œ');
    if (!pdfFiles.isEmpty()) {
        System.debug('   â€¢ ' + pdfFiles[0].ContentDocument.Title + '.pdf');
    }
    
    // ê´€ë¦¬ì ì´ë©”ì¼ ì¡°íšŒ í…ŒìŠ¤íŠ¸
    System.debug('ğŸ‘¥ ê´€ë¦¬ì ì´ë©”ì¼ ì¡°íšŒ ì¤‘...');
    List<User> adminUsers = [
        SELECT Id, Name, Email 
        FROM User 
        WHERE Profile.Name IN ('ì‹œìŠ¤í…œ ê´€ë¦¬ì', 'System Administrator') 
        AND IsActive = true 
        AND Email != null
        LIMIT 3
    ];
    
    System.debug('ğŸ“§ ê´€ë¦¬ì ìˆ˜: ' + adminUsers.size() + 'ëª…');
    for (User admin : adminUsers) {
        System.debug('   â€¢ ' + admin.Name + ' (' + admin.Email + ')');
    }
    
    // ê³ ê° ì´ë©”ì¼ ì¡°íšŒ í…ŒìŠ¤íŠ¸
    System.debug('ğŸ‘¤ ê³ ê° ì´ë©”ì¼ ì¡°íšŒ ì¤‘...');
    List<Contact> customerContacts = [
        SELECT Id, Name, Email 
        FROM Contact 
        WHERE AccountId = :notification.PaymentStatus__r.Order__r.Account.Id
        AND Email != null
        ORDER BY CreatedDate ASC
        LIMIT 1
    ];
    
    System.debug('ğŸ“§ ê³ ê° ì—°ë½ì²˜ ìˆ˜: ' + customerContacts.size() + 'ëª…');
    for (Contact contact : customerContacts) {
        System.debug('   â€¢ ' + contact.Name + ' (' + contact.Email + ')');
    }
    
    // ì‹¤ì œ ì´ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸
    System.debug('ğŸ“® ì´ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸ ì¤‘...');
    Boolean emailResult = PaymentNotificationService.sendEmailNotification(notification);
    System.debug('   ì´ë©”ì¼ ë°œì†¡ ê²°ê³¼: ' + (emailResult ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'));
    
    // Order Owner í™•ì¸
    List<Order> orders = [
        SELECT Id, OrderNumber, OwnerId, Owner.Name, Owner.Email
        FROM Order 
        WHERE Id = :notification.PaymentStatus__r.Order__c
    ];
    
    if (!orders.isEmpty()) {
        Order order = orders[0];
        System.debug('ğŸ‘” Order Owner: ' + order.Owner.Name + ' (' + order.Owner.Email + ')');
    }
    
    System.debug('âœ… =====ì´ë©”ì¼ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ì™„ë£Œ=====');
    
} catch (Exception e) {
    System.debug('âŒ ì´ë©”ì¼ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}
