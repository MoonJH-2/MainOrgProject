/**
 * Order 00000138 Opportunity Product ìë™ ë“±ë¡ ìŠ¤í¬ë¦½íŠ¸
 * Developer Console > Debug > Open Execute Anonymous Windowì—ì„œ ì‹¤í–‰
 * 
 * ëª©í‘œ:
 * - Opportunity Product â†’ Order Product ë“±ë¡
 * - Order Amount: â‚©0 â†’ â‚©10,176,000
 * - PaymentStatus ìƒì„± (ë°˜ê¸°ë³„ 2íšŒ)
 */

System.debug('ğŸ¯ =====Order 00000138 Opportunity Product ë“±ë¡ ì‹œì‘=====');

try {
    // 1. Order 00000138 ì¡°íšŒ
    Order targetOrder = [
        SELECT Id, OrderNumber, OpportunityId, TotalAmount, AccountId, 
               Status, Payment_Method__c, EffectiveDate, Pricebook2Id
        FROM Order 
        WHERE OrderNumber = '00000138' 
        LIMIT 1
    ];
    
    System.debug('ğŸ“‹ Order ì •ë³´:');
    System.debug('   OrderNumber: ' + targetOrder.OrderNumber);
    System.debug('   í˜„ì¬ TotalAmount: ' + targetOrder.TotalAmount);
    System.debug('   Status: ' + targetOrder.Status);
    System.debug('   Payment_Method: ' + targetOrder.Payment_Method__c);
    System.debug('   OpportunityId: ' + targetOrder.OpportunityId);
    
    if (targetOrder.OpportunityId == null) {
        System.debug('âŒ Orderì— ì—°ê²°ëœ Opportunityê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // 2. ì—°ê´€ëœ Opportunity Product ì¡°íšŒ
    List<OpportunityLineItem> oppProducts = [
        SELECT Id, OpportunityId, Product2Id, Quantity, UnitPrice, TotalPrice,
               Product2.Name, Product2.ProductCode
        FROM OpportunityLineItem 
        WHERE OpportunityId = :targetOrder.OpportunityId
    ];
    
    System.debug('');
    System.debug('ğŸ“¦ Opportunity Products:');
    System.debug('   ê°œìˆ˜: ' + oppProducts.size());
    
    if (oppProducts.isEmpty()) {
        System.debug('âŒ ì—°ê²°ëœ Opportunity Productê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Decimal expectedTotalAmount = 0;
    for (OpportunityLineItem item : oppProducts) {
        expectedTotalAmount += item.TotalPrice;
        System.debug('   - ' + item.Product2.Name + ' (' + item.Product2.ProductCode + ')');
        System.debug('     ìˆ˜ëŸ‰: ' + item.Quantity + ', ë‹¨ê°€: â‚©' + item.UnitPrice + ', ì´ì•¡: â‚©' + item.TotalPrice);
    }
    
    System.debug('   ì˜ˆìƒ Order ì´ì•¡: â‚©' + expectedTotalAmount);
    
    // 3. ê¸°ì¡´ Order Products í™•ì¸
    List<OrderItem> existingOrderProducts = [
        SELECT Id FROM OrderItem WHERE OrderId = :targetOrder.Id
    ];
    
    if (!existingOrderProducts.isEmpty()) {
        System.debug('âš ï¸ ì´ë¯¸ Order Productsê°€ ì¡´ì¬í•©ë‹ˆë‹¤ (' + existingOrderProducts.size() + 'ê°œ)');
        System.debug('   ê¸°ì¡´ Order Productsë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.');
        delete existingOrderProducts;
    }
    
    // 4. Standard Pricebook ì„¤ì •
    Pricebook2 standardPricebook = [SELECT Id FROM Pricebook2 WHERE IsStandard = true LIMIT 1];
    
    if (targetOrder.Pricebook2Id == null) {
        targetOrder.Pricebook2Id = standardPricebook.Id;
        update targetOrder;
        System.debug('âœ… Orderì— Standard Pricebook ì„¤ì • ì™„ë£Œ');
    }
    
    // 5. Order Products ìƒì„±
    System.debug('');
    System.debug('ğŸ”¨ Order Products ìƒì„± ì¤‘...');
    
    List<OrderItem> orderItemsToInsert = new List<OrderItem>();
    
    for (OpportunityLineItem oppItem : oppProducts) {
        // PricebookEntry ì¡°íšŒ/ìƒì„±
        List<PricebookEntry> pbeList = [
            SELECT Id FROM PricebookEntry 
            WHERE Product2Id = :oppItem.Product2Id 
            AND Pricebook2Id = :standardPricebook.Id
            LIMIT 1
        ];
        
        Id pricebookEntryId;
        if (pbeList.isEmpty()) {
            // PricebookEntry ìƒì„±
            PricebookEntry newPbe = new PricebookEntry();
            newPbe.Product2Id = oppItem.Product2Id;
            newPbe.Pricebook2Id = standardPricebook.Id;
            newPbe.UnitPrice = oppItem.UnitPrice;
            newPbe.IsActive = true;
            insert newPbe;
            pricebookEntryId = newPbe.Id;
            System.debug('   âœ… ìƒˆ PricebookEntry ìƒì„±: ' + oppItem.Product2.Name);
        } else {
            pricebookEntryId = pbeList[0].Id;
            System.debug('   âœ… ê¸°ì¡´ PricebookEntry ì‚¬ìš©: ' + oppItem.Product2.Name);
        }
        
        // OrderItem ìƒì„±
        OrderItem orderItem = new OrderItem();
        orderItem.OrderId = targetOrder.Id;
        orderItem.Product2Id = oppItem.Product2Id;
        orderItem.PricebookEntryId = pricebookEntryId;
        orderItem.Quantity = oppItem.Quantity;
        orderItem.UnitPrice = oppItem.UnitPrice;
        
        orderItemsToInsert.add(orderItem);
    }
    
    // Order Products ìƒì„± ì‹¤í–‰
    if (!orderItemsToInsert.isEmpty()) {
        insert orderItemsToInsert;
        System.debug('âœ… Order Products ìƒì„± ì™„ë£Œ: ' + orderItemsToInsert.size() + 'ê°œ');
    }
    
    // 6. Order TotalAmount í™•ì¸ (Order Products ìƒì„± í›„ ìë™ ê³„ì‚°)
    Order updatedOrder = [SELECT Id, TotalAmount, Status FROM Order WHERE Id = :targetOrder.Id];
    System.debug('');
    System.debug('ğŸ’° Order ê¸ˆì•¡ í™•ì¸:');
    System.debug('   ì´ì „ TotalAmount: â‚©' + targetOrder.TotalAmount);
    System.debug('   í˜„ì¬ TotalAmount: â‚©' + updatedOrder.TotalAmount);
    
    // 7. Order í™œì„±í™” (í•„ìš”í•œ ê²½ìš°)
    if (updatedOrder.Status == 'Draft') {
        updatedOrder.Status = 'Activated';
        update updatedOrder;
        System.debug('âœ… Order Status: Draft â†’ Activated');
    }
    
    // 8. PaymentStatus ìƒì„±
    System.debug('');
    System.debug('ğŸ“… PaymentStatus ìƒì„± ì¤‘...');
    
    // ê¸°ì¡´ PaymentStatus ì •ë¦¬
    List<PaymentStatus__c> existingPayments = [
        SELECT Id FROM PaymentStatus__c WHERE Order__c = :targetOrder.Id
    ];
    
    if (!existingPayments.isEmpty()) {
        delete existingPayments;
        System.debug('   ê¸°ì¡´ PaymentStatus ì‚­ì œ: ' + existingPayments.size() + 'ê°œ');
    }
    
    // ìµœì¢… Order ì •ë³´ë¡œ PaymentStatus ìƒì„±
    Order finalOrder = [
        SELECT Id, TotalAmount, Payment_Method__c, EffectiveDate 
        FROM Order WHERE Id = :targetOrder.Id
    ];
    
    if (finalOrder.TotalAmount != null && finalOrder.TotalAmount > 0) {
        try {
            PaymentScheduleService.createPaymentSchedule(finalOrder.Id, finalOrder.TotalAmount);
            System.debug('âœ… PaymentStatus ìƒì„± ì™„ë£Œ (Payment Method: ' + finalOrder.Payment_Method__c + ')');
            
            // ìƒì„±ëœ PaymentStatus í™•ì¸
            List<PaymentStatus__c> newPayments = [
                SELECT InstallmentNumber__c, Amount__c, DueDate__c, Status__c
                FROM PaymentStatus__c 
                WHERE Order__c = :targetOrder.Id
                ORDER BY InstallmentNumber__c
            ];
            
            System.debug('   ìƒì„±ëœ PaymentStatus:');
            for (PaymentStatus__c ps : newPayments) {
                System.debug('   - ' + ps.InstallmentNumber__c + 'ì°¨: â‚©' + ps.Amount__c + ' (due: ' + ps.DueDate__c + ')');
            }
            
        } catch (Exception e) {
            System.debug('âŒ PaymentStatus ìƒì„± ì‹¤íŒ¨: ' + e.getMessage());
        }
    }
    
    // 9. ìµœì¢… ê²°ê³¼ ìš”ì•½
    System.debug('');
    System.debug('ğŸ¯ =====Order 00000138 ë“±ë¡ ì™„ë£Œ=====');
    System.debug('âœ… Order Products: ' + orderItemsToInsert.size() + 'ê°œ ìƒì„±');
    System.debug('âœ… Order Amount: â‚©' + finalOrder.TotalAmount);
    System.debug('âœ… Order Status: ' + (updatedOrder.Status == 'Activated' ? 'Activated' : updatedOrder.Status));
    System.debug('âœ… PaymentStatus: ìƒì„± ì™„ë£Œ');
    System.debug('');
    System.debug('ğŸ” í™•ì¸ì‚¬í•­:');
    System.debug('1. Order 00000138 í˜ì´ì§€ì—ì„œ Order Products ì„¹ì…˜ í™•ì¸');
    System.debug('2. ë‚©ë¶€ ì¼ì • íƒ€ì„ë¼ì¸ì—ì„œ PaymentStatus í™•ì¸');
    System.debug('3. Order Amountê°€ â‚©10,176,000ìœ¼ë¡œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸');
    
} catch (Exception e) {
    System.debug('âŒ ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}

System.debug('ğŸ¯ =====ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì™„ë£Œ=====');
