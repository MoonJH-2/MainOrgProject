/**
 * Order 00000139 ìƒíƒœ í™œì„±í™” ìŠ¤í¬ë¦½íŠ¸
 * Developer Console > Debug > Open Execute Anonymous Windowì—ì„œ ì‹¤í–‰
 * 
 * ëª©í‘œ: Order Productê°€ ë“±ë¡ëœ Orderì˜ Statusë¥¼ Draft â†’ Activatedë¡œ ë³€ê²½
 */

System.debug('ğŸ¯ =====Order 00000139 ìƒíƒœ í™œì„±í™” ì‹œì‘=====');

try {
    // 1. Order 00000139 ì¡°íšŒ
    Order targetOrder = [
        SELECT Id, OrderNumber, Status, TotalAmount, OpportunityId
        FROM Order 
        WHERE OrderNumber = '00000139' 
        LIMIT 1
    ];
    
    System.debug('ğŸ“‹ Order ì •ë³´:');
    System.debug('   OrderNumber: ' + targetOrder.OrderNumber);
    System.debug('   í˜„ì¬ Status: ' + targetOrder.Status);
    System.debug('   TotalAmount: â‚©' + targetOrder.TotalAmount);
    
    // 2. Order Products í™•ì¸
    List<OrderItem> orderProducts = [
        SELECT Id, Product2.Name, Quantity, UnitPrice
        FROM OrderItem 
        WHERE OrderId = :targetOrder.Id
    ];
    
    System.debug('');
    System.debug('ğŸ“¦ Order Products í˜„í™©:');
    System.debug('   ê°œìˆ˜: ' + orderProducts.size());
    
    for (OrderItem item : orderProducts) {
        System.debug('   - ' + item.Product2.Name + ' x ' + item.Quantity + ' (â‚©' + item.UnitPrice + ')');
    }
    
    // 3. PaymentStatus í™•ì¸
    List<PaymentStatus__c> paymentStatuses = [
        SELECT Id, InstallmentNumber__c, Amount__c, DueDate__c, Status__c
        FROM PaymentStatus__c 
        WHERE Order__c = :targetOrder.Id
        ORDER BY InstallmentNumber__c
    ];
    
    System.debug('');
    System.debug('ğŸ’° PaymentStatus í˜„í™©:');
    System.debug('   ê°œìˆ˜: ' + paymentStatuses.size());
    
    for (PaymentStatus__c ps : paymentStatuses) {
        System.debug('   - ' + ps.InstallmentNumber__c + 'ì°¨: â‚©' + ps.Amount__c + ' (' + ps.Status__c + ', due: ' + ps.DueDate__c + ')');
    }
    
    // 4. Order ìƒíƒœ í™•ì¸ ë° ë³€ê²½
    if (targetOrder.Status == 'Draft' && !orderProducts.isEmpty()) {
        System.debug('');
        System.debug('ğŸ”„ Order ìƒíƒœ ë³€ê²½ ì¤‘...');
        
        targetOrder.Status = 'Activated';
        update targetOrder;
        
        System.debug('âœ… Order ìƒíƒœ ë³€ê²½ ì™„ë£Œ: Draft â†’ Activated');
        
        // 5. PaymentStatus ì²« ë²ˆì§¸ ê±´ì„ ì—°ì²´ ìƒíƒœë¡œ ë³€ê²½ (í™”ë©´ê³¼ ì¼ì¹˜ì‹œí‚¤ê¸° ìœ„í•´)
        if (!paymentStatuses.isEmpty()) {
            PaymentStatus__c firstPayment = paymentStatuses[0];
            if (firstPayment.Status__c == 'ë¯¸ë‚©') {
                firstPayment.Status__c = 'ì—°ì²´';
                update firstPayment;
                System.debug('âœ… 1ì°¨ PaymentStatus ìƒíƒœ ë³€ê²½: ë¯¸ë‚© â†’ ì—°ì²´');
            }
        }
        
    } else if (targetOrder.Status == 'Activated') {
        System.debug('');
        System.debug('â„¹ï¸ OrderëŠ” ì´ë¯¸ Activated ìƒíƒœì…ë‹ˆë‹¤.');
    } else if (orderProducts.isEmpty()) {
        System.debug('');
        System.debug('âŒ Order Productsê°€ ì—†ì–´ì„œ í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        
        // Order Products ìë™ ë“±ë¡ ì‹œë„
        if (targetOrder.OpportunityId != null) {
            System.debug('ğŸ”§ Opportunity Product ìë™ ë“±ë¡ ì‹œë„...');
            OrderProductAutoRegistrationService.registerOpportunityProducts(targetOrder.Id);
            System.debug('âœ… Opportunity Product ìë™ ë“±ë¡ ì™„ë£Œ');
        }
    }
    
    // 6. ìµœì¢… ìƒíƒœ í™•ì¸
    Order finalOrder = [
        SELECT Id, OrderNumber, Status, TotalAmount
        FROM Order 
        WHERE Id = :targetOrder.Id
    ];
    
    List<OrderItem> finalProducts = [
        SELECT Id FROM OrderItem WHERE OrderId = :targetOrder.Id
    ];
    
    List<PaymentStatus__c> finalPayments = [
        SELECT Id, Status__c FROM PaymentStatus__c WHERE Order__c = :targetOrder.Id
    ];
    
    System.debug('');
    System.debug('ğŸ¯ =====ìµœì¢… ê²°ê³¼=====');
    System.debug('âœ… Order Number: ' + finalOrder.OrderNumber);
    System.debug('âœ… Status: ' + finalOrder.Status);
    System.debug('âœ… TotalAmount: â‚©' + finalOrder.TotalAmount);
    System.debug('âœ… Order Products: ' + finalProducts.size() + 'ê°œ');
    System.debug('âœ… PaymentStatus: ' + finalPayments.size() + 'ê°œ');
    
    // ì—°ì²´ ìƒíƒœ í™•ì¸
    Integer overdueCount = 0;
    for (PaymentStatus__c ps : finalPayments) {
        if (ps.Status__c == 'ì—°ì²´') {
            overdueCount++;
        }
    }
    System.debug('âœ… ì—°ì²´ ê±´ìˆ˜: ' + overdueCount + 'ê°œ');
    
    System.debug('');
    System.debug('ğŸ” í™•ì¸ì‚¬í•­:');
    System.debug('1. Order 00000139 í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨');
    System.debug('2. Order Statusê°€ Activatedë¡œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸');
    System.debug('3. ë‚©ë¶€ ì¼ì • íƒ€ì„ë¼ì¸ì—ì„œ 1ì°¨ê°€ ì—°ì²´ë¡œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸');
    
} catch (Exception e) {
    System.debug('âŒ ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}

System.debug('ğŸ¯ =====ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì™„ë£Œ=====');
