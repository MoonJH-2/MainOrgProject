// ğŸš— ì˜ì¹´ B2B ê¸°ì—… ê³ ê° ë° êµ¬ë… Assets ìƒì„± ìŠ¤í¬ë¦½íŠ¸
// ì‹¤ì œ í•œêµ­ ê¸°ì—…ë“¤ì˜ ì°¨ëŸ‰ êµ¬ë… ì„œë¹„ìŠ¤ ì‹œë‚˜ë¦¬ì˜¤

System.debug('=== ì˜ì¹´ B2B ê¸°ì—… ê³ ê° ë° êµ¬ë… ì„œë¹„ìŠ¤ ë°ì´í„° ìƒì„± ===');

// 1. í•œêµ­ ëŒ€ê¸°ì—… ê³ ê° ìƒì„±
List<Account> corporateCustomers = new List<Account>();

// ëŒ€ê¸°ì—… ê³ ê°ë“¤
corporateCustomers.add(new Account(
    Name = 'ì‚¼ì„±ì „ì',
    Type = 'Customer',
    Industry = 'ì „ìì œí’ˆ',
    Phone = '02-2255-0114',
    BillingStreet = 'ê²½ê¸°ë„ ìˆ˜ì›ì‹œ ì˜í†µêµ¬ ì‚¼ì„±ë¡œ 129',
    BillingCity = 'ìˆ˜ì›ì‹œ',
    BillingState = 'ê²½ê¸°ë„', 
    BillingCountry = 'ëŒ€í•œë¯¼êµ­',
    AnnualRevenue = 2500000000000.00,
    NumberOfEmployees = 267937,
    Description = 'ê¸€ë¡œë²Œ ì „ìì œí’ˆ ì œì¡°ì—…ì²´ - ì„ì§ì› í†µê·¼ ë° ì—…ë¬´ìš© ì°¨ëŸ‰ í•„ìš”'
));

corporateCustomers.add(new Account(
    Name = 'LGì „ì',
    Type = 'Customer',
    Industry = 'ì „ìì œí’ˆ', 
    Phone = '02-3777-1114',
    BillingStreet = 'ì„œìš¸íŠ¹ë³„ì‹œ ì˜ë“±í¬êµ¬ ì—¬ì˜ëŒ€ë¡œ 128',
    BillingCity = 'ì„œìš¸íŠ¹ë³„ì‹œ',
    BillingState = 'ì„œìš¸íŠ¹ë³„ì‹œ',
    BillingCountry = 'ëŒ€í•œë¯¼êµ­',
    AnnualRevenue = 750000000000.00,
    NumberOfEmployees = 75000,
    Description = 'ê°€ì „ì œí’ˆ ë° ì „ìë¶€í’ˆ ì œì¡° - ì˜ì—…íŒ€ ì°¨ëŸ‰ ë° ë¬¼ë¥˜ ì°¨ëŸ‰ ìš´ì˜'
));

corporateCustomers.add(new Account(
    Name = 'ë„¤ì´ë²„',
    Type = 'Customer',
    Industry = 'IT ì„œë¹„ìŠ¤',
    Phone = '1588-3820',
    BillingStreet = 'ê²½ê¸°ë„ ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬ ë¶ˆì •ë¡œ 6',
    BillingCity = 'ì„±ë‚¨ì‹œ',
    BillingState = 'ê²½ê¸°ë„',
    BillingCountry = 'ëŒ€í•œë¯¼êµ­', 
    AnnualRevenue = 56000000000.00,
    NumberOfEmployees = 3500,
    Description = 'IT ì„œë¹„ìŠ¤ ë° í”Œë«í¼ ìš´ì˜ - ì§ì› ì…”í‹€ ë° ë°°ì†¡ ì„œë¹„ìŠ¤ ì°¨ëŸ‰'
));

corporateCustomers.add(new Account(
    Name = 'ì¹´ì¹´ì˜¤',
    Type = 'Customer',
    Industry = 'IT ì„œë¹„ìŠ¤',
    Phone = '1577-3754', 
    BillingStreet = 'ì œì£¼íŠ¹ë³„ìì¹˜ë„ ì œì£¼ì‹œ ì²¨ë‹¨ë¡œ 242',
    BillingCity = 'ì œì£¼ì‹œ',
    BillingState = 'ì œì£¼íŠ¹ë³„ìì¹˜ë„',
    BillingCountry = 'ëŒ€í•œë¯¼êµ­',
    AnnualRevenue = 65000000000.00,
    NumberOfEmployees = 4500,
    Description = 'ëª¨ë°”ì¼ í”Œë«í¼ ë° ì½˜í…ì¸  ì„œë¹„ìŠ¤ - ì„ì§ì› í†µê·¼ ì§€ì› ì°¨ëŸ‰'
));

corporateCustomers.add(new Account(
    Name = 'í˜„ëŒ€ìë™ì°¨',
    Type = 'Customer',
    Industry = 'ìë™ì°¨',
    Phone = '02-3464-1114',
    BillingStreet = 'ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬ í—Œë¦‰ë¡œ 12', 
    BillingCity = 'ì„œìš¸íŠ¹ë³„ì‹œ',
    BillingState = 'ì„œìš¸íŠ¹ë³„ì‹œ',
    BillingCountry = 'ëŒ€í•œë¯¼êµ­',
    AnnualRevenue = 1200000000000.00,
    NumberOfEmployees = 120000,
    Description = 'ìë™ì°¨ ì œì¡°ì—…ì²´ - ì‹œìŠ¹ ì°¨ëŸ‰ ë° ì„ì§ì› ì—…ë¬´ìš© ì°¨ëŸ‰'
));

// ì¤‘ê²¬ê¸°ì—… ê³ ê°ë“¤
corporateCustomers.add(new Account(
    Name = 'í•œí™”ì‹œìŠ¤í…œ',
    Type = 'Customer',
    Industry = 'í•­ê³µìš°ì£¼/ë°©ì‚°',
    Phone = '02-729-3114',
    BillingStreet = 'ì„œìš¸íŠ¹ë³„ì‹œ ì¢…ë¡œêµ¬ ì²­ê³„ì²œë¡œ 86',
    BillingCity = 'ì„œìš¸íŠ¹ë³„ì‹œ', 
    BillingState = 'ì„œìš¸íŠ¹ë³„ì‹œ',
    BillingCountry = 'ëŒ€í•œë¯¼êµ­',
    AnnualRevenue = 25000000000.00,
    NumberOfEmployees = 2500,
    Description = 'í•­ê³µìš°ì£¼ ë° ë°©ì‚°ì—…ì²´ - ë³´ì•ˆ ìš´ì†¡ ë° ì„ì§ì› ì°¨ëŸ‰'
));

corporateCustomers.add(new Account(
    Name = 'ì‹ ì„¸ê³„ë°±í™”ì ',
    Type = 'Customer', 
    Industry = 'ìœ í†µì—…',
    Phone = '02-1234-1234',
    BillingStreet = 'ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬ ì†Œê³µë¡œ 63',
    BillingCity = 'ì„œìš¸íŠ¹ë³„ì‹œ',
    BillingState = 'ì„œìš¸íŠ¹ë³„ì‹œ',
    BillingCountry = 'ëŒ€í•œë¯¼êµ­',
    AnnualRevenue = 180000000000.00,
    NumberOfEmployees = 8000,
    Description = 'ë°±í™”ì  ë° ìœ í†µì—… - ê³ ê° ì„œë¹„ìŠ¤ ë° ë¬¼ë¥˜ ë°°ì†¡ ì°¨ëŸ‰'
));

corporateCustomers.add(new Account(
    Name = 'ìš°ì•„í•œí˜•ì œë“¤',
    Type = 'Customer',
    Industry = 'ë°°ë‹¬ í”Œë«í¼',
    Phone = '1588-8008',
    BillingStreet = 'ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬ ìœ„ë¡€ì„±ëŒ€ë¡œ 2',
    BillingCity = 'ì„œìš¸íŠ¹ë³„ì‹œ',
    BillingState = 'ì„œìš¸íŠ¹ë³„ì‹œ', 
    BillingCountry = 'ëŒ€í•œë¯¼êµ­',
    AnnualRevenue = 8000000000.00,
    NumberOfEmployees = 1200,
    Description = 'ë°°ë‹¬ í”Œë«í¼ ì„œë¹„ìŠ¤ - ë°°ë‹¬ ì°¨ëŸ‰ ë° ì„ì§ì› ì´ë™ ì°¨ëŸ‰'
));

try {
    insert corporateCustomers;
    System.debug('âœ… ê¸°ì—… ê³ ê° ' + corporateCustomers.size() + 'ê°œ ìƒì„± ì™„ë£Œ'); 
} catch (Exception e) {
    System.debug('âŒ ê¸°ì—… ê³ ê° ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
    return;
}

// 2. ì˜ì¹´ B2B ì œí’ˆ ì¡°íšŒ (ì´ë¯¸ ìƒì„±ë˜ì–´ ìˆë‹¤ê³  ê°€ì •)
List<Product2> socarProducts = [
    SELECT Id, Name, ProductCode, Family
    FROM Product2 
    WHERE ProductCode LIKE 'SOCAR_%'
    AND IsActive = true
];

if (socarProducts.isEmpty()) {
    System.debug('âŒ ì˜ì¹´ B2B ì œí’ˆì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¨¼ì € socar_b2b_products_setup.apexë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
    return;
}

System.debug('âœ… ì˜ì¹´ B2B ì œí’ˆ ' + socarProducts.size() + 'ê°œ í™•ì¸');

// 3. êµ¬ë… Assets ìƒì„± (ì¦‰ì‹œ ê°±ì‹  ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •)
List<Asset> subscriptionAssets = new List<Asset>();
Date installDate = Date.today().addDays(-15); // 15ì¼ ì „ ì„¤ì¹˜
Date usageEndDate = Date.today().addDays(45);  // 45ì¼ í›„ ë§Œë£Œ (ê°±ì‹  ëŒ€ìƒ)

// ê° ê¸°ì—…ë³„ êµ¬ë… ì„œë¹„ìŠ¤ ì‹œë‚˜ë¦¬ì˜¤
Map<String, List<String>> companySubscriptions = new Map<String, List<String>>{
    'ì‚¼ì„±ì „ì' => new List<String>{'SOCAR_BIZ_ENT', 'SOCAR_GREEN_BIZ', 'SOCAR_API_SERVICE'},
    'LGì „ì' => new List<String>{'SOCAR_BIZ_PRO', 'SOCAR_LONG_24M', 'SOCAR_DRIVER_MATCH'},
    'ë„¤ì´ë²„' => new List<String>{'SOCAR_BIZ_PRO', 'SOCAR_CARSHARE_BIZ', 'SOCAR_API_SERVICE'},
    'ì¹´ì¹´ì˜¤' => new List<String>{'SOCAR_BIZ_BASIC', 'SOCAR_CARSHARE_BIZ', 'SOCAR_GREEN_BIZ'},
    'í˜„ëŒ€ìë™ì°¨' => new List<String>{'SOCAR_BIZ_ENT', 'SOCAR_LONG_36M'},
    'í•œí™”ì‹œìŠ¤í…œ' => new List<String>{'SOCAR_BIZ_BASIC', 'SOCAR_DRIVER_MATCH'},
    'ì‹ ì„¸ê³„ë°±í™”ì ' => new List<String>{'SOCAR_BIZ_PRO', 'SOCAR_LONG_12M'},
    'ìš°ì•„í•œí˜•ì œë“¤' => new List<String>{'SOCAR_CARSHARE_BIZ', 'SOCAR_GREEN_BIZ'}
};

// ì œí’ˆ ê°€ê²© ë§¤í•‘
Map<String, Decimal> productPrices = new Map<String, Decimal>{
    'SOCAR_BIZ_BASIC' => 980000,
    'SOCAR_BIZ_PRO' => 2450000, 
    'SOCAR_BIZ_ENT' => 4900000,
    'SOCAR_LONG_12M' => 650000,
    'SOCAR_LONG_24M' => 580000,
    'SOCAR_LONG_36M' => 520000,
    'SOCAR_CARSHARE_BIZ' => 1200000,
    'SOCAR_GREEN_BIZ' => 1450000,
    'SOCAR_DRIVER_MATCH' => 350000,
    'SOCAR_API_SERVICE' => 150000
};

Integer assetCounter = 1;
for (Account company : corporateCustomers) {
    List<String> subscriptionCodes = companySubscriptions.get(company.Name);
    
    if (subscriptionCodes != null) {
        for (String productCode : subscriptionCodes) {
            // í•´ë‹¹ ì œí’ˆ ì°¾ê¸°
            Product2 product = null;
            for (Product2 p : socarProducts) {
                if (p.ProductCode == productCode) {
                    product = p;
                    break;
                }
            }
            
            if (product != null) {
                // íšŒì‚¬ ê·œëª¨ì— ë”°ë¥¸ ì°¨ëŸ‰ ìˆ˜ëŸ‰ ê²°ì •
                Integer quantity = 1;
                if (company.NumberOfEmployees > 100000) quantity = 5;
                else if (company.NumberOfEmployees > 10000) quantity = 3; 
                else if (company.NumberOfEmployees > 1000) quantity = 2;
                
                Asset subscriptionAsset = new Asset(
                    Name = company.Name + ' - ' + product.Name,
                    AccountId = company.Id,
                    Product2Id = product.Id,
                    Status = 'Installed',
                    InstallDate = installDate.addDays(-(Math.mod(assetCounter, 30))), // ì„¤ì¹˜ì¼ ë¶„ì‚°
                    PurchaseDate = installDate.addDays(-(Math.mod(assetCounter, 30))),
                    UsageEndDate = usageEndDate.addDays(Math.mod(assetCounter, 60)), // ë§Œë£Œì¼ ë¶„ì‚°
                    Price = productPrices.get(productCode),
                    Quantity = quantity,
                    Description = company.Name + 'ì˜ ' + product.Family + ' êµ¬ë… ì„œë¹„ìŠ¤ - ' + 
                                 quantity + 'ëŒ€ ì°¨ëŸ‰ í¬í•¨, ì›”ê°„ ê´€ë¦¬ë¹„ í¬í•¨'
                );
                
                subscriptionAssets.add(subscriptionAsset);
                assetCounter++;
            }
        }
    }
}

try {
    insert subscriptionAssets;
    System.debug('âœ… êµ¬ë… Assets ' + subscriptionAssets.size() + 'ê°œ ìƒì„± ì™„ë£Œ');
} catch (Exception e) {
    System.debug('âŒ êµ¬ë… Assets ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
    return;
}

// 4. ìƒì„± ê²°ê³¼ ìš”ì•½
Decimal totalMonthlyRevenue = 0;
Integer totalVehicles = 0;
Map<String, Integer> serviceTypeCount = new Map<String, Integer>();

for (Asset asset : subscriptionAssets) {
    totalMonthlyRevenue += (asset.Price != null ? asset.Price : 0) * (asset.Quantity != null ? asset.Quantity : 1);
    totalVehicles += (asset.Quantity != null ? asset.Quantity : 1);
    
    String serviceType = asset.Name.split(' - ')[1];
    Integer count = serviceTypeCount.get(serviceType);
    serviceTypeCount.put(serviceType, (count != null ? count : 0) + 1);
}

System.debug('ğŸ‰ ì˜ì¹´ B2B êµ¬ë… ì„œë¹„ìŠ¤ ë°ì´í„° ìƒì„± ì™„ë£Œ!');
System.debug('ğŸ“Š ìƒì„± ì™„ë£Œ ìš”ì•½:');
System.debug('- ê¸°ì—… ê³ ê°: ' + corporateCustomers.size() + 'ê°œ');
System.debug('- êµ¬ë… ì„œë¹„ìŠ¤: ' + subscriptionAssets.size() + 'ê°œ');
System.debug('- ì´ ì°¨ëŸ‰ ìˆ˜: ' + totalVehicles + 'ëŒ€');
System.debug('- ì´ ì›”ê°„ ìˆ˜ìµ: â‚©' + String.valueOf(totalMonthlyRevenue.longValue()) + 'ì›');

System.debug('ğŸ“ˆ ì„œë¹„ìŠ¤ë³„ êµ¬ë… í˜„í™©:');
for (String serviceType : serviceTypeCount.keySet()) {
    System.debug('- ' + serviceType + ': ' + serviceTypeCount.get(serviceType) + 'ê°œ');
}

// 5. ê°±ì‹  ëŒ€ìƒ í™•ì¸
List<Asset> renewalTargets = [
    SELECT Id, Name, Account.Name, UsageEndDate, Price
    FROM Asset 
    WHERE UsageEndDate <= :Date.today().addDays(60)
    AND Status = 'Installed'
    ORDER BY UsageEndDate ASC
];

System.debug('ğŸ”„ 60ì¼ ë‚´ ê°±ì‹  ëŒ€ìƒ: ' + renewalTargets.size() + 'ê°œ');
for (Asset target : renewalTargets) {
    Integer daysToExpiry = Date.today().daysBetween(target.UsageEndDate);
    System.debug('- ' + target.Account.Name + ': ' + target.Name + 
                ' (ë§Œë£Œ: ' + daysToExpiry + 'ì¼ í›„, ìˆ˜ìµ: â‚©' + 
                String.valueOf(target.Price.longValue()) + ')');
}

System.debug('ğŸš— ì˜ì¹´ B2B êµ¬ë… ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ!');
