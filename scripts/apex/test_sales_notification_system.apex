/**
 * Sales ì•± ì•Œë¦¼ ì‹œìŠ¤í…œ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
 * ìƒì„±: 2025-07-21
 * ëª©ì : OrderNotificationServiceì™€ PaymentStatusTriggerHandlerë¥¼ í†µí•œ Sales ì•± ì•Œë¦¼ í…ŒìŠ¤íŠ¸
 */

System.debug('ğŸš€ Sales ì•± ì•Œë¦¼ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹œì‘');

try {
    // 1. CustomNotificationType í™•ì¸
    System.debug('ğŸ“‹ Step 1: CustomNotificationType í™•ì¸');
    
    List<CustomNotificationType> salesNotificationTypes = [
        SELECT Id, DeveloperName, MasterLabel
        FROM CustomNotificationType
        WHERE DeveloperName = 'Sales_Order_Notification'
        LIMIT 1
    ];
    
    if (salesNotificationTypes.isEmpty()) {
        System.debug('âš ï¸ CustomNotificationType "Sales_Order_Notification"ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        System.debug('   Setup > Process Automation > Custom Notification Typesì—ì„œ ìƒì„±í•˜ì„¸ìš”:');
        System.debug('   - Developer Name: Sales_Order_Notification');
        System.debug('   - Master Label: Sales Order Notification');
        System.debug('   - Description: Order ìƒì„±, ì—°ì²´, Slack ì±„ë„ ìƒì„± ì•Œë¦¼');
        System.debug('   - Supported Channels: Desktop, Mobile');
    } else {
        System.debug('âœ… CustomNotificationType í™•ì¸ ì™„ë£Œ: ' + salesNotificationTypes[0].MasterLabel);
    }
    
    // 2. ìµœê·¼ Order ì¡°íšŒ ë° ì•Œë¦¼ í…ŒìŠ¤íŠ¸
    System.debug('ğŸ“‹ Step 2: ìµœê·¼ Order ì¡°íšŒ');
    
    List<Order> recentOrders = [
        SELECT Id, OrderNumber, TotalAmount, Account.Name, Status,
               Slack_Channel_Name__c, Slack_Notification_Status__c,
               CreatedDate
        FROM Order 
        WHERE CreatedDate = LAST_N_DAYS:7
        AND TotalAmount > 0
        ORDER BY CreatedDate DESC
        LIMIT 3
    ];
    
    System.debug('ğŸ“Š ìµœê·¼ 7ì¼ ë‚´ Order ìˆ˜: ' + recentOrders.size());
    
    for (Order ord : recentOrders) {
        System.debug('ğŸ“¦ Order: ' + ord.OrderNumber + ' (' + ord.Account.Name + ') - â‚©' + ord.TotalAmount.format());
        System.debug('   Status: ' + ord.Status + ', Slack: ' + ord.Slack_Channel_Name__c);
    }
    
    // 3. Order ìƒì„± ì•Œë¦¼ í…ŒìŠ¤íŠ¸ (ìµœê·¼ Order ì¤‘ 1ê°œ ì„ íƒ)
    if (!recentOrders.isEmpty()) {
        System.debug('ğŸ“‹ Step 3: Order ìƒì„± ì•Œë¦¼ í…ŒìŠ¤íŠ¸');
        
        Order testOrder = recentOrders[0];
        List<Order> testOrders = new List<Order>{testOrder};
        
        if (!salesNotificationTypes.isEmpty()) {
            OrderNotificationService.notifyOrderCreated(testOrders);
            System.debug('âœ… Order ìƒì„± ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ' + testOrder.OrderNumber);
        } else {
            System.debug('âš ï¸ CustomNotificationTypeì´ ì—†ì–´ Order ìƒì„± ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
        }
    }
    
    // 4. ì—°ì²´ PaymentStatus ì¡°íšŒ ë° ì•Œë¦¼ í…ŒìŠ¤íŠ¸
    System.debug('ğŸ“‹ Step 4: ì—°ì²´ PaymentStatus ì¡°íšŒ');
    
    List<PaymentStatus__c> overduePayments = [
        SELECT Id, Order__c, Order__r.Account.Name, Order__r.OrderNumber,
               InstallmentNumber__c, Amount__c, DueDate__c, Status__c
        FROM PaymentStatus__c 
        WHERE Status__c = 'ì—°ì²´'
        AND DueDate__c < TODAY
        ORDER BY DueDate__c DESC
        LIMIT 3
    ];
    
    System.debug('ğŸš¨ í˜„ì¬ ì—°ì²´ PaymentStatus ìˆ˜: ' + overduePayments.size());
    
    for (PaymentStatus__c payment : overduePayments) {
        Integer overdueDays = Date.today().daysBetween(payment.DueDate__c);
        System.debug('ğŸ’¸ ì—°ì²´: ' + payment.Order__r.OrderNumber + 
                     ' (' + payment.InstallmentNumber__c + 'ì°¨) - ' + 
                     Math.abs(overdueDays) + 'ì¼ ì—°ì²´');
    }
    
    // 5. ì—°ì²´ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ (ì—°ì²´ PaymentStatus ì¤‘ 1ê°œ ì„ íƒ)
    if (!overduePayments.isEmpty() && !salesNotificationTypes.isEmpty()) {
        System.debug('ğŸ“‹ Step 5: ì—°ì²´ ì•Œë¦¼ í…ŒìŠ¤íŠ¸');
        
        PaymentStatus__c testPayment = overduePayments[0];
        List<PaymentStatus__c> testPayments = new List<PaymentStatus__c>{testPayment};
        
        OrderNotificationService.notifyOverduePayments(testPayments);
        System.debug('âœ… ì—°ì²´ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ' + testPayment.Order__r.OrderNumber);
    }
    
    // 6. Slack ì±„ë„ì´ ìˆëŠ” Order ì¡°íšŒ ë° ì•Œë¦¼ í…ŒìŠ¤íŠ¸
    System.debug('ğŸ“‹ Step 6: Slack ì±„ë„ ì•Œë¦¼ í…ŒìŠ¤íŠ¸');
    
    List<Order> ordersWithSlack = [
        SELECT Id, OrderNumber, Slack_Channel_Name__c, Slack_Notification_Status__c
        FROM Order 
        WHERE Slack_Channel_Name__c != null
        AND Slack_Notification_Status__c = 'Created'
        ORDER BY CreatedDate DESC
        LIMIT 3
    ];
    
    System.debug('ğŸ“¢ Slack ì±„ë„ì´ ìˆëŠ” Order ìˆ˜: ' + ordersWithSlack.size());
    
    for (Order ord : ordersWithSlack) {
        System.debug('ğŸ”— Slack ì±„ë„: ' + ord.OrderNumber + ' â†’ #' + ord.Slack_Channel_Name__c);
    }
    
    if (!ordersWithSlack.isEmpty() && !salesNotificationTypes.isEmpty()) {
        Order testSlackOrder = ordersWithSlack[0];
        List<Order> testSlackOrders = new List<Order>{testSlackOrder};
        
        OrderNotificationService.notifySlackChannelCreated(testSlackOrders);
        System.debug('âœ… Slack ì±„ë„ ìƒì„± ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ' + testSlackOrder.OrderNumber);
    }
    
    // 7. ì•Œë¦¼ ìˆ˜ì‹ ì í™•ì¸
    System.debug('ğŸ“‹ Step 7: ì•Œë¦¼ ìˆ˜ì‹ ì í™•ì¸');
    
    User currentUser = [
        SELECT Id, Name, Email, ManagerId, Manager.Name, Manager.Email
        FROM User
        WHERE Id = :UserInfo.getUserId()
        LIMIT 1
    ];
    
    System.debug('ğŸ‘¤ í˜„ì¬ ì‚¬ìš©ì: ' + currentUser.Name + ' (' + currentUser.Email + ')');
    if (currentUser.Manager != null) {
        System.debug('ğŸ‘¥ Manager: ' + currentUser.Manager.Name + ' (' + currentUser.Manager.Email + ')');
    }
    
    // 8. ì‹œìŠ¤í…œ ìƒíƒœ ìš”ì•½
    System.debug('ğŸ“‹ Step 8: ì‹œìŠ¤í…œ ìƒíƒœ ìš”ì•½');
    System.debug('=====================================');
    System.debug('ğŸ“± Sales ì•± ì•Œë¦¼ ì‹œìŠ¤í…œ ìƒíƒœ');
    System.debug('=====================================');
    System.debug('âœ… OrderNotificationService.cls ë°°í¬ë¨');
    System.debug('âœ… PaymentStatusTriggerHandler.cls ë°°í¬ë¨');
    System.debug('âœ… OrderTriggerHandler.cls ì—…ë°ì´íŠ¸ë¨');
    System.debug('âœ… PaymentStatusTrigger.trigger ì—…ë°ì´íŠ¸ë¨');
    
    if (!salesNotificationTypes.isEmpty()) {
        System.debug('âœ… CustomNotificationType ì„¤ì • ì™„ë£Œ');
    } else {
        System.debug('âš ï¸ CustomNotificationType ì„¤ì • í•„ìš”');
    }
    
    System.debug('=====================================');
    System.debug('ğŸ¯ ì•Œë¦¼ ì´ë²¤íŠ¸ ìœ í˜•:');
    System.debug('   1. Order ìƒì„± ì‹œ â†’ Sales ì•± ë²¨ ì•Œë¦¼');
    System.debug('   2. PaymentStatus ì—°ì²´ ì‹œ â†’ Sales ì•± ë²¨ ì•Œë¦¼');
    System.debug('   3. Slack ì±„ë„ ìƒì„± ì‹œ â†’ Sales ì•± ë²¨ ì•Œë¦¼');
    System.debug('=====================================');
    
    System.debug('ğŸš€ Sales ì•± ì•Œë¦¼ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
    
} catch (Exception e) {
    System.debug('âŒ Sales ì•± ì•Œë¦¼ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('âŒ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
}
