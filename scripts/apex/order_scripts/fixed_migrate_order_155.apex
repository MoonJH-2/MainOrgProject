/**
 * Order 00000155 ì¦‰ì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ (ì˜¤ë¥˜ ìˆ˜ì • ë²„ì „)
 */

System.debug('=== ğŸš€ Order 00000155 Salesforce ì±„ë„ ì „í™˜ ì‹œì‘ ===');

try {
    // 1. Order ì •ë³´ ì¡°íšŒ
    List<Order> orders = [
        SELECT Id, Name, OrderNumber, Status, OwnerId, AccountId,
               Slack_Channel_ID__c, Slack_Channel_Name__c, Slack_Notification_Status__c
        FROM Order 
        WHERE OrderNumber = '00000155'
        LIMIT 1
    ];
    
    if(orders.isEmpty()) {
        System.debug('âŒ Order 00000155ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Order order155 = orders[0];
    System.debug('ğŸ“‹ Order ì •ë³´: ' + order155.OrderNumber + ' (ID: ' + order155.Id + ')');
    System.debug('í˜„ì¬ Slack ìƒíƒœ: ' + order155.Slack_Notification_Status__c);
    
    // 2. ê¸°ì¡´ Salesforce ì±„ë„ í™•ì¸
    List<CollaborationGroup> existingChannels = [
        SELECT Id, Name, Description, MemberCount, CreatedDate
        FROM CollaborationGroup 
        WHERE Name LIKE '%00000155%' OR Name LIKE '%Order-155%'
    ];
    
    System.debug('=== ğŸ” ê¸°ì¡´ ì±„ë„ í™•ì¸ ===');
    System.debug('ë°œê²¬ëœ ì±„ë„ ìˆ˜: ' + existingChannels.size());
    
    String channelId;
    
    if(!existingChannels.isEmpty()) {
        channelId = existingChannels[0].Id;
        System.debug('âœ… ê¸°ì¡´ ì±„ë„ ì‚¬ìš©: ' + existingChannels[0].Name + ' (ID: ' + channelId + ')');
    } else {
        // 3. ìƒˆ ì±„ë„ ìƒì„±
        System.debug('=== ğŸ—ï¸ ìƒˆ ì±„ë„ ìƒì„± ===');
        
        CollaborationGroup newChannel = new CollaborationGroup();
        newChannel.Name = 'Order-00000155';
        newChannel.Description = 'Order 00000155 ì „ìš© í˜‘ì—… ì±„ë„ (Slackì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜)\n' +
                               'ë§ˆì´ê·¸ë ˆì´ì…˜ ë‚ ì§œ: ' + System.now().format('yyyy-MM-dd HH:mm') + '\n' +
                               'ì´ì „ Slack ì±„ë„: ' + order155.Slack_Channel_ID__c;
        newChannel.CollaborationType = 'Private';
        newChannel.IsArchived = false;
        newChannel.CanHaveGuests = false;
        
        insert newChannel;
        channelId = newChannel.Id;
        
        System.debug('âœ… ìƒˆ ì±„ë„ ìƒì„± ì™„ë£Œ: ' + channelId);
        
        // 4. ë©¤ë²„ ì¶”ê°€
        List<CollaborationGroupMember> members = new List<CollaborationGroupMember>();
        
        // Order Owner ì¶”ê°€
        CollaborationGroupMember ownerMember = new CollaborationGroupMember();
        ownerMember.CollaborationGroupId = channelId;
        ownerMember.MemberId = order155.OwnerId;
        ownerMember.CollaborationRole = 'Admin';
        members.add(ownerMember);
        
        // í˜„ì¬ ì‚¬ìš©ì ì¶”ê°€ (ë‹¤ë¥¸ ì‚¬ìš©ìì¸ ê²½ìš°)
        if(UserInfo.getUserId() != order155.OwnerId) {
            CollaborationGroupMember currentUserMember = new CollaborationGroupMember();
            currentUserMember.CollaborationGroupId = channelId;
            currentUserMember.MemberId = UserInfo.getUserId();
            currentUserMember.CollaborationRole = 'Standard';
            members.add(currentUserMember);
        }
        
        insert members;
        System.debug('âœ… ë©¤ë²„ ì¶”ê°€ ì™„ë£Œ: ' + members.size() + 'ëª…');
    }
    
    // 5. ë§ˆì´ê·¸ë ˆì´ì…˜ í™˜ì˜ ë©”ì‹œì§€
    String migrationMessage = 'ğŸ‰ Order 00000155ê°€ Slackì—ì„œ Salesforce ì±„ë„ë¡œ ì„±ê³µì ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n';
    migrationMessage += 'ğŸ“… ë§ˆì´ê·¸ë ˆì´ì…˜ ë‚ ì§œ: ' + System.now().format('yyyy-MM-dd HH:mm') + '\n';
    migrationMessage += 'ğŸ”— ì´ì „ Slack ì±„ë„ ID: ' + order155.Slack_Channel_ID__c + '\n';
    migrationMessage += 'ğŸ“‹ Order ë²ˆí˜¸: ' + order155.OrderNumber + '\n\n';
    migrationMessage += 'âœ¨ ìƒˆë¡œìš´ ê¸°ëŠ¥ë“¤:\n';
    migrationMessage += 'â€¢ ğŸ“± Salesforce Mobile ì•±ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥\n';
    migrationMessage += 'â€¢ ğŸ”” ì‹¤ì‹œê°„ @ë©˜ì…˜ ì•Œë¦¼\n';
    migrationMessage += 'â€¢ ğŸ“„ íŒŒì¼ ê³µìœ  ë° ë¬¸ì„œ í˜‘ì—…\n';
    migrationMessage += 'â€¢ ğŸ¤– Order ìë™ ì—…ë°ì´íŠ¸ ì—°ë™\n\n';
    migrationMessage += 'ğŸš€ Order ë°”ë¡œê°€ê¸°: ' + System.URL.getOrgDomainUrl().toExternalForm() + 
                       '/lightning/r/Order/' + order155.Id + '/view\n\n';
    migrationMessage += '#ë§ˆì´ê·¸ë ˆì´ì…˜ì™„ë£Œ #Order00000155 #SalesforceChannels';
    
    FeedItem migrationPost = new FeedItem();
    migrationPost.ParentId = channelId;
    migrationPost.Body = migrationMessage;
    migrationPost.Type = 'TextPost';
    
    insert migrationPost;
    System.debug('âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ í™˜ì˜ ë©”ì‹œì§€ ê²Œì‹œ ì™„ë£Œ');
    
    // 6. Order ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ (ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ)
    Order updateOrder = new Order(Id = order155.Id);
    updateOrder.Slack_Notification_Status__c = 'Migrated to Salesforce Channel';
    
    String migrationNote = '\n=== ë§ˆì´ê·¸ë ˆì´ì…˜ ê¸°ë¡ ===\n';
    migrationNote += 'ë‚ ì§œ: ' + System.now().format('yyyy-MM-dd HH:mm:ss') + '\n';
    migrationNote += 'Salesforce Channel ID: ' + channelId + '\n';
    migrationNote += 'ì´ì „ Slack Channel: ' + order155.Slack_Channel_ID__c + '\n';
    migrationNote += 'ìƒíƒœ: ì™„ì „ ì „í™˜ ì™„ë£Œ';
    
    updateOrder.Description = (order155.Description != null ? order155.Description : '') + migrationNote;
    
    update updateOrder;
    System.debug('âœ… Order ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    
    // 7. ìµœì¢… ê²°ê³¼
    System.debug('=== ğŸ‰ ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µ! ===');
    System.debug('Order: 00000155');
    System.debug('Salesforce ì±„ë„ ID: ' + channelId);
    System.debug('ìƒíƒœ: ì™„ì „ ì „í™˜ ì™„ë£Œ');
    
    System.debug('\n=== ğŸ“± Sales ì•±ì—ì„œ í™•ì¸í•˜ê¸° ===');
    System.debug('1. Sales ì•± â†’ Chatter â†’ ê·¸ë£¹');
    System.debug('2. ê²€ìƒ‰: "Order-00000155" ë˜ëŠ” "00000155"');
    System.debug('3. ì§ì ‘ URL: /lightning/r/CollaborationGroup/' + channelId + '/view');
    System.debug('4. Order ë ˆì½”ë“œ â†’ Related â†’ Chatter í™•ì¸');
    
} catch(Exception e) {
    System.debug('âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
    
    System.debug('\n=== ğŸ”§ ë¬¸ì œ í•´ê²° ë°©ë²• ===');
    System.debug('1. Order 00000155ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸');
    System.debug('2. í˜„ì¬ ì‚¬ìš©ìì˜ Chatter ê¶Œí•œ í™•ì¸');
    System.debug('3. CollaborationGroup ìƒì„± ê¶Œí•œ í™•ì¸');
    System.debug('4. Order ë ˆì½”ë“œ í¸ì§‘ ê¶Œí•œ í™•ì¸');
}

System.debug('\n=== âœ… Order 00000155 ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì™„ë£Œ ===');
