// Order 00000158 Asset ìƒì„± í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
// ì™„ë‚© ì™„ë£Œëœ Orderì— ëŒ€í•´ Asset ìë™ ìƒì„± ì‹¤í–‰

try {
    System.debug('=== Order 00000158 Asset ìƒì„± í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
    
    // 1. Order 00000158 ì¡°íšŒ
    List<Order> orders = [
        SELECT Id, OrderNumber, AccountId, Account.Name, Contact__c, 
               TotalAmount, ActivatedDate, OrderStartDate, OrderEndDate,
               Payment_Method__c, OwnerId, Owner.Name, Status
        FROM Order 
        WHERE OrderNumber = '00000158'
        LIMIT 1
    ];
    
    if (orders.isEmpty()) {
        System.debug('âŒ Order 00000158ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Order order = orders[0];
    System.debug('ğŸ“‹ Order ì •ë³´:');
    System.debug('- Order Number: ' + order.OrderNumber);
    System.debug('- Account: ' + order.Account.Name);
    System.debug('- Total Amount: â‚©' + order.TotalAmount);
    System.debug('- Owner: ' + order.Owner.Name);
    System.debug('- Status: ' + order.Status);
    
    // 2. Payment Schedule ìƒíƒœ í™•ì¸
    List<Payment_Schedule__c> schedules = [
        SELECT Id, Name, Payment_Status__c, Amount__c, Due_Date__c
        FROM Payment_Schedule__c 
        WHERE Order__c = :order.Id
        ORDER BY Due_Date__c
    ];
    
    System.debug('\nğŸ“… Payment Schedule í˜„í™©:');
    Integer totalSchedules = schedules.size();
    Integer completedSchedules = 0;
    
    for (Payment_Schedule__c schedule : schedules) {
        System.debug('- ' + schedule.Name + ': ' + schedule.Payment_Status__c + ' (â‚©' + schedule.Amount__c + ')');
        if (schedule.Payment_Status__c == 'ì™„ë‚©') {
            completedSchedules++;
        }
    }
    
    System.debug('ì™„ë‚© ì§„í–‰ë¥ : ' + completedSchedules + '/' + totalSchedules + ' (' + 
                (totalSchedules > 0 ? (completedSchedules * 100 / totalSchedules) : 0) + '%)');
    
    // 3. ê¸°ì¡´ Asset í™•ì¸
    List<Asset> existingAssets = [
        SELECT Id, Name, Status, PurchaseDate, UsageEndDate
        FROM Asset 
        WHERE AccountId = :order.AccountId 
        AND Name LIKE '%00000158%'
    ];
    
    System.debug('\nğŸ·ï¸ ê¸°ì¡´ Asset í™•ì¸:');
    if (existingAssets.isEmpty()) {
        System.debug('- ê¸°ì¡´ Asset ì—†ìŒ');
    } else {
        for (Asset asset : existingAssets) {
            System.debug('- Asset: ' + asset.Name + ' (Status: ' + asset.Status + ')');
        }
    }
    
    // 4. Asset ìƒì„± ì‹¤í–‰
    System.debug('\nğŸš€ Asset ìƒì„± ì‹¤í–‰...');
    Asset createdAsset = OrderAssetCreationService.createAssetForOrder(order.Id);
    
    if (createdAsset != null) {
        System.debug('âœ… Asset ìƒì„± ì„±ê³µ!');
        System.debug('ğŸ“‹ ìƒì„±ëœ Asset ì •ë³´:');
        
        // ìƒì„±ëœ Asset ì¬ì¡°íšŒ (ID í¬í•¨)
        List<Asset> newAssets = [
            SELECT Id, Name, AccountId, ContactId, Product2Id, Status,
                   PurchaseDate, InstallDate, UsageEndDate, Price, Quantity, Description
            FROM Asset 
            WHERE Id = :createdAsset.Id
        ];
        
        if (!newAssets.isEmpty()) {
            Asset asset = newAssets[0];
            System.debug('- Asset ID: ' + asset.Id);
            System.debug('- Asset Name: ' + asset.Name);
            System.debug('- Account ID: ' + asset.AccountId);
            System.debug('- Contact ID: ' + asset.ContactId);
            System.debug('- Product ID: ' + asset.Product2Id);
            System.debug('- Status: ' + asset.Status);
            System.debug('- Purchase Date: ' + asset.PurchaseDate);
            System.debug('- Install Date: ' + asset.InstallDate);
            System.debug('- Usage End Date: ' + asset.UsageEndDate);
            System.debug('- Price: â‚©' + asset.Price);
            System.debug('- Quantity: ' + asset.Quantity);
            System.debug('- Description: ' + asset.Description);
        }
        
        // 5. ìƒì„±ëœ Task í™•ì¸
        System.debug('\nğŸ“‹ ìƒì„±ëœ Task í™•ì¸:');
        List<Task> relatedTasks = [
            SELECT Id, Subject, Description, ActivityDate, Priority, Status, OwnerId
            FROM Task 
            WHERE WhatId = :createdAsset.Id
            ORDER BY CreatedDate DESC
            LIMIT 5
        ];
        
        if (relatedTasks.isEmpty()) {
            System.debug('- ê´€ë ¨ Task ì—†ìŒ');
        } else {
            for (Task task : relatedTasks) {
                System.debug('- Task: ' + task.Subject + ' (Due: ' + task.ActivityDate + ', Priority: ' + task.Priority + ')');
            }
        }
        
        // 6. Salesforce ì±„ë„ ì•Œë¦¼ í™•ì¸
        System.debug('\nğŸ’¬ Salesforce ì±„ë„ ì•Œë¦¼ í™•ì¸:');
        List<CollaborationGroup> channels = [
            SELECT Id, Name FROM CollaborationGroup 
            WHERE Name LIKE '%00000158%'
            LIMIT 1
        ];
        
        if (!channels.isEmpty()) {
            System.debug('- ì±„ë„ ë°œê²¬: ' + channels[0].Name);
            System.debug('- Asset ìƒì„± ì•Œë¦¼ì´ ì±„ë„ì— ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            System.debug('- ê´€ë ¨ ì±„ë„ ì—†ìŒ');
        }
        
    } else {
        System.debug('âŒ Asset ìƒì„± ì‹¤íŒ¨ ë˜ëŠ” ì´ë¯¸ ì¡´ì¬í•¨');
        
        // ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
        if (completedSchedules < totalSchedules) {
            System.debug('ğŸ’¡ ì‹¤íŒ¨ ì›ì¸: ì•„ì§ ì™„ë‚©ì´ ì™„ë£Œë˜ì§€ ì•ŠìŒ (' + completedSchedules + '/' + totalSchedules + ')');
        }
        
        if (!existingAssets.isEmpty()) {
            System.debug('ğŸ’¡ ì‹¤íŒ¨ ì›ì¸: ì´ë¯¸ Assetì´ ì¡´ì¬í•¨');
        }
    }
    
    System.debug('\n=== Order 00000158 Asset ìƒì„± í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');
    
} catch (Exception e) {
    System.debug('âŒ Asset ìƒì„± í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
}
