/**
 * Order 00000155ë¥¼ ìœ„í•œ ì™„ì „ ì „í™˜ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
 * ëª©ì : Slack ì±„ë„ì—ì„œ Salesforce ì±„ë„ë¡œ ì¦‰ì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜
 */

System.debug('=== ğŸš€ Order 00000155 ì™„ì „ ì „í™˜ ì‹œì‘ ===');

// 1. Order 00000155 ìƒì„¸ ì •ë³´ í™•ì¸
List<Order> targetOrders = [
    SELECT Id, Name, OrderNumber, Status, AccountId, OwnerId,
           Slack_Channel_ID__c, Slack_Channel_Name__c, 
           Slack_Webhook_URL__c, Slack_Notification_Status__c, Description
    FROM Order 
    WHERE OrderNumber = '00000155'
    LIMIT 1
];

if(targetOrders.isEmpty()) {
    System.debug('âŒ Order 00000155ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
} else {
    Order order155 = targetOrders[0];
    
    System.debug('ğŸ“‹ Order ì •ë³´:');
    System.debug('- ID: ' + order155.Id);
    System.debug('- ë²ˆí˜¸: ' + order155.OrderNumber);
    System.debug('- ìƒíƒœ: ' + order155.Status);
    System.debug('- Slack ì±„ë„ ID: ' + order155.Slack_Channel_ID__c);
    System.debug('- Slack ìƒíƒœ: ' + order155.Slack_Notification_Status__c);
    
    // 2. ê¸°ì¡´ Salesforce ì±„ë„ í™•ì¸
    List<CollaborationGroup> existingChannels = [
        SELECT Id, Name, Description, MemberCount, CreatedDate
        FROM CollaborationGroup 
        WHERE Name LIKE '%00000155%' OR Name LIKE '%Order-155%'
    ];
    
    System.debug('\n=== ğŸ” ê¸°ì¡´ Salesforce ì±„ë„ í™•ì¸ ===');
    if(!existingChannels.isEmpty()) {
        System.debug('âœ… ë°œê²¬ëœ Salesforce ì±„ë„: ' + existingChannels.size() + 'ê°œ');
        for(CollaborationGroup channel : existingChannels) {
            System.debug('- ' + channel.Name + ' (ID: ' + channel.Id + ', ë©¤ë²„: ' + channel.MemberCount + ')');
        }
    } else {
        System.debug('âŒ Salesforce ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.');
    }
    
    // 3. ì™„ì „ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
    System.debug('\n=== ğŸ¯ ì™„ì „ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ===');
    try {
        String salesforceChannelId;
        
        if(existingChannels.isEmpty()) {
            // ìƒˆ Salesforce ì±„ë„ ìƒì„±
            SalesforceChannelService channelService = new SalesforceChannelService();
            salesforceChannelId = channelService.createOrderChannel(order155.Id);
            
            if(salesforceChannelId != null) {
                System.debug('âœ… ìƒˆ Salesforce ì±„ë„ ìƒì„±: ' + salesforceChannelId);
                
                // Order Owner ì¶”ê°€
                channelService.addUserToChannel(salesforceChannelId, order155.OwnerId);
                
                // í˜„ì¬ ì‚¬ìš©ìë„ ì¶”ê°€
                channelService.addUserToChannel(salesforceChannelId, UserInfo.getUserId());
                
                // ë§ˆì´ê·¸ë ˆì´ì…˜ í™˜ì˜ ë©”ì‹œì§€
                String migrationMessage = 'ğŸ‰ Order 00000155ê°€ Slackì—ì„œ Salesforce ì±„ë„ë¡œ ì„±ê³µì ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n';
                migrationMessage += 'ğŸ“… ë§ˆì´ê·¸ë ˆì´ì…˜ ë‚ ì§œ: ' + System.now().format('yyyy-MM-dd HH:mm') + '\n';
                migrationMessage += 'ğŸ”— ì´ì „ Slack ì±„ë„ ID: ' + order155.Slack_Channel_ID__c + '\n\n';
                migrationMessage += 'âœ¨ ì´ì œ Salesforceì—ì„œ ëª¨ë“  í˜‘ì—…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤:\n';
                migrationMessage += 'â€¢ ì‹¤ì‹œê°„ ì•Œë¦¼ ë° @ë©˜ì…˜\n';
                migrationMessage += 'â€¢ íŒŒì¼ ê³µìœ  ë° ë¬¸ì„œ í˜‘ì—…\n';
                migrationMessage += 'â€¢ Order ìë™ ì—…ë°ì´íŠ¸\n';
                migrationMessage += 'â€¢ ëª¨ë°”ì¼ ì•± ì ‘ê·¼\n\n';
                migrationMessage += '#ë§ˆì´ê·¸ë ˆì´ì…˜ì™„ë£Œ #Order00000155';
                
                FeedItem migrationPost = new FeedItem(
                    ParentId = salesforceChannelId,
                    Body = migrationMessage,
                    Type = 'TextPost'
                );
                insert migrationPost;
                
                System.debug('âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ í™˜ì˜ ë©”ì‹œì§€ ê²Œì‹œ ì™„ë£Œ');
                
            } else {
                System.debug('âŒ Salesforce ì±„ë„ ìƒì„± ì‹¤íŒ¨');
            }
        } else {
            salesforceChannelId = existingChannels[0].Id;
            System.debug('âœ… ê¸°ì¡´ Salesforce ì±„ë„ ì‚¬ìš©: ' + salesforceChannelId);
        }
        
        // 4. Order ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ (ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ ê¸°ë¡)
        if(salesforceChannelId != null) {
            Order updateOrder = new Order(Id = order155.Id);
            updateOrder.Slack_Notification_Status__c = 'Migrated to Salesforce';
            
            String migrationNote = '\n--- ë§ˆì´ê·¸ë ˆì´ì…˜ ê¸°ë¡ ---\n';
            migrationNote += 'ë‚ ì§œ: ' + System.now().format('yyyy-MM-dd HH:mm:ss') + '\n';
            migrationNote += 'Salesforce Channel ID: ' + salesforceChannelId + '\n';
            migrationNote += 'ì´ì „ Slack Channel: ' + order155.Slack_Channel_ID__c + '\n';
            migrationNote += 'ìƒíƒœ: ì™„ì „ ì „í™˜ ì™„ë£Œ';
            
            updateOrder.Description = (order155.Description != null ? order155.Description : '') + migrationNote;
            update updateOrder;
            
            System.debug('âœ… Order ë ˆì½”ë“œ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        }
        
        // 5. Slack ì±„ë„ ë¹„í™œì„±í™”
        Order deactivateOrder = new Order(Id = order155.Id);
        deactivateOrder.Slack_Notification_Status__c = 'Deactivated - Migrated to Salesforce';
        
        if(order155.Slack_Webhook_URL__c != null && !order155.Slack_Webhook_URL__c.startsWith('DISABLED_')) {
            deactivateOrder.Slack_Webhook_URL__c = 'DISABLED_' + order155.Slack_Webhook_URL__c;
        }
        
        update deactivateOrder;
        System.debug('âœ… Slack ì±„ë„ ë¹„í™œì„±í™” ì™„ë£Œ');
        
        // 6. ìµœì¢… í™•ì¸ ë° ê²°ê³¼
        System.debug('\n=== ğŸ‰ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ ê²°ê³¼ ===');
        System.debug('Order: 00000155');
        System.debug('Salesforce ì±„ë„ ID: ' + salesforceChannelId);
        System.debug('ìƒíƒœ: ì™„ì „ ì „í™˜ ì™„ë£Œ');
        
        System.debug('\n=== ğŸ“± Sales ì•±ì—ì„œ í™•ì¸ ë°©ë²• ===');
        System.debug('1. Sales ì•± â†’ Chatter â†’ ê·¸ë£¹');
        System.debug('2. ê²€ìƒ‰: "00000155" ë˜ëŠ” "Order-155"');
        System.debug('3. ì§ì ‘ URL: /lightning/r/CollaborationGroup/' + salesforceChannelId + '/view');
        System.debug('4. Order ë ˆì½”ë“œ â†’ Related â†’ Chatter ì„¹ì…˜ í™•ì¸');
        
        System.debug('\n=== âš ï¸ ë‹¤ìŒ ë‹¨ê³„ ===');
        System.debug('1. íŒ€ì›ë“¤ì—ê²Œ Salesforce ì±„ë„ ì‚¬ìš© ì•ˆë‚´');
        System.debug('2. Slack ì±„ë„ ì•„ì¹´ì´ë¸Œ ì²˜ë¦¬');
        System.debug('3. ì•Œë¦¼ ì„¤ì • Salesforceë¡œ ë³€ê²½');
        System.debug('4. ëª¨ë°”ì¼ ì•±ì—ì„œ ì ‘ê·¼ í…ŒìŠ¤íŠ¸');
        
    } catch(Exception e) {
        System.debug('âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜: ' + e.getMessage());
        System.debug('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
    }
}

System.debug('\n=== âœ… Order 00000155 ì™„ì „ ì „í™˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì™„ë£Œ ===');
