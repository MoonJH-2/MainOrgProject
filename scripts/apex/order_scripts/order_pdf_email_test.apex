// Order 00000115 PDF ì²¨ë¶€ ì´ë©”ì¼ í…ŒìŠ¤íŠ¸
System.debug('ğŸ“§ =====Order 00000115 PDF ì²¨ë¶€ ì´ë©”ì¼ í…ŒìŠ¤íŠ¸=====');

try {
    // 1. Order 00000115ì˜ ì—°ì²´ PaymentStatus ì¡°íšŒ ë˜ëŠ” ìƒì„±
    List<Order> orders = [
        SELECT Id, OrderNumber, Account.Name
        FROM Order 
        WHERE OrderNumber = '00000115'
        LIMIT 1
    ];
    
    if (orders.isEmpty()) {
        System.debug('âŒ Order 00000115ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Order targetOrder = orders[0];
    System.debug('ğŸ“‹ Order: ' + targetOrder.OrderNumber + ' (' + targetOrder.Account.Name + ')');
    
    // 2. ì—°ì²´ PaymentStatus í™•ì¸
    List<PaymentStatus__c> overduePayments = [
        SELECT Id, InstallmentNumber__c, Amount__c, DueDate__c, Status__c
        FROM PaymentStatus__c 
        WHERE Order__c = :targetOrder.Id
        AND DueDate__c < TODAY 
        AND Status__c != 'ì™„ë‚©'
        ORDER BY InstallmentNumber__c ASC
        LIMIT 1
    ];
    
    if (overduePayments.isEmpty()) {
        System.debug('âš ï¸ ì—°ì²´ëœ PaymentStatusê°€ ì—†ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.');
        
        // í…ŒìŠ¤íŠ¸ìš© ì—°ì²´ PaymentStatus ìƒì„± ë˜ëŠ” ê¸°ì¡´ ê²ƒ ì‚¬ìš©
        List<PaymentStatus__c> allPayments = [
            SELECT Id, InstallmentNumber__c, DueDate__c, Status__c
            FROM PaymentStatus__c 
            WHERE Order__c = :targetOrder.Id
            ORDER BY InstallmentNumber__c ASC
            LIMIT 1
        ];
        
        if (!allPayments.isEmpty()) {
            PaymentStatus__c testPayment = allPayments[0];
            testPayment.DueDate__c = Date.today().addDays(-3); // 3ì¼ ì „ìœ¼ë¡œ ì„¤ì •
            testPayment.Status__c = 'ë¯¸ë‚©';
            update testPayment;
            overduePayments.add(testPayment);
            System.debug('âœ… í…ŒìŠ¤íŠ¸ìš© ì—°ì²´ ìƒí™© ìƒì„±: ' + testPayment.InstallmentNumber__c + 'ì°¨');
        }
    }
    
    if (overduePayments.isEmpty()) {
        System.debug('âŒ í…ŒìŠ¤íŠ¸í•  PaymentStatusë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    PaymentStatus__c overduePayment = overduePayments[0];
    
    // 3. Payment_Notification__c ë ˆì½”ë“œ ìƒì„±
    Payment_Notification__c notification = new Payment_Notification__c();
    notification.PaymentStatus__c = overduePayment.Id;
    notification.NotificationType__c = 'ì—°ì²´ ì•Œë¦¼';
    notification.NotificationChannel__c = 'Email';
    notification.NotificationStatus__c = 'Pending';
    notification.ScheduledDateTime__c = DateTime.now();
    
    insert notification;
    System.debug('âœ… ì•Œë¦¼ ë ˆì½”ë“œ ìƒì„±: ' + notification.Id);
    
    // 4. ê´€ê³„ í•„ë“œì™€ í•¨ê»˜ ë‹¤ì‹œ ì¡°íšŒ
    Payment_Notification__c fullNotification = [
        SELECT Id, PaymentStatus__c, PaymentStatus__r.Order__c,
               PaymentStatus__r.Order__r.Account.Name, PaymentStatus__r.Order__r.Account.Id,
               PaymentStatus__r.Order__r.OrderNumber, PaymentStatus__r.InstallmentNumber__c,
               PaymentStatus__r.Amount__c, PaymentStatus__r.DueDate__c, PaymentStatus__r.Status__c,
               NotificationType__c, NotificationChannel__c
        FROM Payment_Notification__c 
        WHERE Id = :notification.Id
    ];
    
    // 5. í˜„ì¬ PDF íŒŒì¼ ìƒíƒœ í™•ì¸
    System.debug('ğŸ“ í˜„ì¬ PDF íŒŒì¼ ìƒíƒœ í™•ì¸:');
    List<ContentDocumentLink> currentPDFs = [
        SELECT ContentDocument.Id, ContentDocument.Title, ContentDocument.FileExtension,
               ContentDocument.CreatedDate
        FROM ContentDocumentLink 
        WHERE LinkedEntityId = :targetOrder.Id
        AND ContentDocument.FileExtension = 'pdf'
        ORDER BY ContentDocument.CreatedDate DESC
    ];
    
    System.debug('   ì´ PDF íŒŒì¼: ' + currentPDFs.size() + 'ê°œ');
    for (ContentDocumentLink pdf : currentPDFs) {
        String isPaymentSchedule = pdf.ContentDocument.Title.contains('ë‚©ë¶€ì¼ì •ì„œ') ? ' [ë‚©ë¶€ì¼ì •ì„œ]' : '';
        System.debug('   â€¢ ' + pdf.ContentDocument.Title + '.pdf' + isPaymentSchedule + 
                     ' (ìƒì„±ì¼: ' + pdf.ContentDocument.CreatedDate.format() + ')');
    }
    
    // 6. ì´ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸ (PDF ì²¨ë¶€ í¬í•¨)
    System.debug('ğŸ“® PDF ì²¨ë¶€ ì´ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸ ì¤‘...');
    Boolean emailResult = PaymentNotificationService.sendEmailNotification(fullNotification);
    System.debug('   ì´ë©”ì¼ ë°œì†¡ ê²°ê³¼: ' + (emailResult ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'));
    
    // 7. ë°œì†¡ëœ ì´ë©”ì¼ ì •ë³´ ìš”ì•½
    if (emailResult) {
        System.debug('');
        System.debug('ğŸ“§ ë°œì†¡ëœ ì´ë©”ì¼ ì •ë³´:');
        System.debug('â€¢ ì œëª©: [ì—°ì²´ ì•Œë¦¼] ' + fullNotification.PaymentStatus__r.InstallmentNumber__c + 'ì°¨ ë‚©ë¶€ ì—°ì²´ ì•ˆë‚´');
        System.debug('â€¢ ê³ ê° ìˆ˜ì‹ ì: 0714TEST ê´€ë ¨ ì—°ë½ì²˜');
        System.debug('â€¢ ê´€ë¦¬ì ìˆ˜ì‹ ì: ì‹œìŠ¤í…œ ê´€ë¦¬ìë“¤ + Order Owner');
        System.debug('â€¢ PDF ì²¨ë¶€: Order 00000115 ìµœì‹  ë‚©ë¶€ì¼ì •ì„œ');
        System.debug('â€¢ ì—°ì²´ ì •ë³´: ' + fullNotification.PaymentStatus__r.InstallmentNumber__c + 
                     'ì°¨ â‚©' + fullNotification.PaymentStatus__r.Amount__c.format() + 
                     ' (ì˜ˆì •ì¼: ' + fullNotification.PaymentStatus__r.DueDate__c.format() + ')');
    }
    
    // 8. ì´ë©”ì¼ ì²¨ë¶€ íŒŒì¼ í™•ì¸ (ë””ë²„ê·¸ìš©)
    System.debug('');
    System.debug('ğŸ” ì²¨ë¶€ íŒŒì¼ ì²˜ë¦¬ ìƒì„¸ ë¡œê·¸:');
    // getPDFAttachments ë©”ì„œë“œê°€ ì‹¤í–‰ë  ë•Œì˜ ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
    
    // 9. í…ŒìŠ¤íŠ¸ ì •ë¦¬ (ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬)
    if (overduePayment.DueDate__c < Date.today()) {
        System.debug('ğŸ”„ í…ŒìŠ¤íŠ¸ ì •ë¦¬ ì¤‘...');
        overduePayment.DueDate__c = Date.newInstance(2025, 8, 14); // ì›ë˜ ë‚ ì§œë¡œ ë³µêµ¬
        overduePayment.Status__c = 'ì˜ˆì •'; // ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬
        update overduePayment;
        System.debug('âœ… PaymentStatus ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬ ì™„ë£Œ');
    }
    
    System.debug('');
    System.debug('âœ… =====Order 00000115 PDF ì²¨ë¶€ ì´ë©”ì¼ í…ŒìŠ¤íŠ¸ ì™„ë£Œ=====');
    
} catch (Exception e) {
    System.debug('âŒ PDF ì²¨ë¶€ ì´ë©”ì¼ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}
