// ìƒˆ Order ìƒì„±ìœ¼ë¡œ ì‹¤ì œ Sales ì•± ìƒì„± ì•Œë¦¼ í…ŒìŠ¤íŠ¸
System.debug('ğŸ‰ =====ì‹¤ì œ Order ìƒì„± ì•Œë¦¼ í…ŒìŠ¤íŠ¸=====');

try {
    // 1. í…ŒìŠ¤íŠ¸ìš© Account í™•ì¸/ìƒì„±
    List<Account> testAccounts = [
        SELECT Id, Name 
        FROM Account 
        WHERE Name = 'Test Notification Account'
        LIMIT 1
    ];
    
    Account testAccount;
    if (testAccounts.isEmpty()) {
        // í…ŒìŠ¤íŠ¸ìš© Account ìƒì„±
        testAccount = new Account();
        testAccount.Name = 'Test Notification Account';
        testAccount.Type = 'Customer';
        insert testAccount;
        System.debug('âœ… í…ŒìŠ¤íŠ¸ìš© Account ìƒì„±: ' + testAccount.Name);
    } else {
        testAccount = testAccounts[0];
        System.debug('âœ… ê¸°ì¡´ í…ŒìŠ¤íŠ¸ìš© Account ì‚¬ìš©: ' + testAccount.Name);
    }
    
    // 2. CustomNotificationType ì„¤ì • í™•ì¸
    List<CustomNotificationType> salesTypes = [
        SELECT Id FROM CustomNotificationType
        WHERE DeveloperName = 'Sales_Order_Notification'
        LIMIT 1
    ];
    
    if (salesTypes.isEmpty()) {
        System.debug('âŒ Sales_Order_Notificationì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
        System.debug('   Setupì—ì„œ CustomNotificationTypeì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    System.debug('âœ… Sales_Order_Notification ì„¤ì • í™•ì¸ë¨');
    
    // 3. í‘œì¤€ Pricebook ì¡°íšŒ
    List<Pricebook2> standardPricebooks = [
        SELECT Id, Name 
        FROM Pricebook2 
        WHERE IsStandard = true 
        LIMIT 1
    ];
    
    if (standardPricebooks.isEmpty()) {
        System.debug('âŒ Standard Pricebookì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // 4. ìƒˆ Order ìƒì„± (ì‹¤ì œ íŠ¸ë¦¬ê±° ë°œë™)
    System.debug('');
    System.debug('ğŸ“ ìƒˆ Order ìƒì„± ì¤‘...');
    
    Order newOrder = new Order();
    newOrder.AccountId = testAccount.Id;
    newOrder.EffectiveDate = Date.today();
    newOrder.Status = 'Draft';
    newOrder.Pricebook2Id = standardPricebooks[0].Id;
    newOrder.TotalAmount = 5000000; // 5ë°±ë§Œì›
    newOrder.Payment_Method__c = 'ë¶„ê¸°ë³„';
    
    // ì‹¤ì œ Order ìƒì„± - ì´ë•Œ OrderTriggerHandlerê°€ ì‘ë™í•¨
    insert newOrder;
    
    System.debug('âœ… ìƒˆ Order ìƒì„± ì™„ë£Œ:');
    System.debug('   Order ID: ' + newOrder.Id);
    System.debug('   ğŸ“¡ OrderTriggerHandler.afterInsert() íŠ¸ë¦¬ê±°ë¨');
    System.debug('   ğŸ”” OrderNotificationService.notifyOrderCreated() í˜¸ì¶œë¨');
    
    // 5. ìƒì„±ëœ Order ì •ë³´ ë‹¤ì‹œ ì¡°íšŒ
    Order createdOrder = [
        SELECT Id, OrderNumber, Status, TotalAmount, Account.Name,
               Owner.Name, Owner.Email, CreatedDate, CreatedBy.Name
        FROM Order 
        WHERE Id = :newOrder.Id
    ];
    
    System.debug('');
    System.debug('ğŸ“‹ ìƒì„±ëœ Order ì •ë³´:');
    System.debug('   Order Number: ' + createdOrder.OrderNumber);
    System.debug('   Status: ' + createdOrder.Status);
    System.debug('   Account: ' + createdOrder.Account.Name);
    System.debug('   Total Amount: â‚©' + createdOrder.TotalAmount.format());
    System.debug('   Owner: ' + createdOrder.Owner.Name);
    System.debug('   Created: ' + createdOrder.CreatedDate);
    System.debug('   Created By: ' + createdOrder.CreatedBy.Name);
    
    // 6. Orderë¥¼ Activated ìƒíƒœë¡œ ë³€ê²½ (ì¶”ê°€ íŠ¸ë¦¬ê±° í…ŒìŠ¤íŠ¸)
    System.debug('');
    System.debug('âš¡ Orderë¥¼ Activated ìƒíƒœë¡œ ë³€ê²½ ì¤‘...');
    
    createdOrder.Status = 'Activated';
    update createdOrder;
    
    System.debug('âœ… Order í™œì„±í™” ì™„ë£Œ');
    System.debug('   ğŸ“¡ OrderTriggerHandler.afterUpdate() íŠ¸ë¦¬ê±°ë¨');
    
    // 7. PaymentStatus ìë™ ìƒì„± í™•ì¸
    List<PaymentStatus__c> generatedPayments = [
        SELECT Id, InstallmentNumber__c, Amount__c, DueDate__c, Status__c
        FROM PaymentStatus__c 
        WHERE Order__c = :createdOrder.Id
        ORDER BY InstallmentNumber__c ASC
    ];
    
    System.debug('');
    System.debug('ğŸ’° ìë™ ìƒì„±ëœ PaymentStatus: ' + generatedPayments.size() + 'ê°œ');
    for (PaymentStatus__c payment : generatedPayments) {
        System.debug('   ' + payment.InstallmentNumber__c + 'ì°¨: â‚©' + 
                    payment.Amount__c.format() + ' (due: ' + payment.DueDate__c.format() + ')');
    }
    
    // 8. ìˆ˜ì‹ ì ì •ë³´ í™•ì¸
    System.debug('');
    System.debug('ğŸ‘¥ ì•Œë¦¼ ìˆ˜ì‹ ì:');
    
    User currentUser = [
        SELECT Id, Name, Email, ManagerId, Manager.Name
        FROM User 
        WHERE Id = :UserInfo.getUserId()
    ];
    
    System.debug('   ğŸ“§ í˜„ì¬ ì‚¬ìš©ì (Order ìƒì„±ì): ' + currentUser.Name);
    System.debug('   ğŸ‘¤ Order Owner: ' + createdOrder.Owner.Name);
    if (currentUser.ManagerId != null) {
        System.debug('   ğŸ‘” Manager: ' + currentUser.Manager.Name);
    }
    
    // 9. ì¦‰ì‹œ í™•ì¸ ë°©ë²• ì•ˆë‚´
    System.debug('');
    System.debug('ğŸ”” ì¦‰ì‹œ í™•ì¸ ë°©ë²•:');
    System.debug('1. Salesforce ìƒë‹¨ì˜ ğŸ”” ë²¨ ì•„ì´ì½˜ í´ë¦­');
    System.debug('2. "ğŸ‰ ìƒˆ ì£¼ë¬¸ ìƒì„±" ì•Œë¦¼ì´ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸');
    System.debug('3. ì•Œë¦¼ ë‚´ìš©: "' + createdOrder.Account.Name + ' - Order ' + createdOrder.OrderNumber + ' (â‚©' + createdOrder.TotalAmount.format() + ')"');
    System.debug('4. ì•Œë¦¼ í´ë¦­ ì‹œ ìƒˆë¡œ ìƒì„±ëœ Order ë ˆì½”ë“œë¡œ ì´ë™í•˜ëŠ”ì§€ í™•ì¸');
    
    System.debug('');
    System.debug('ğŸ“± Mobile ì•±ì—ì„œë„ í™•ì¸:');
    System.debug('1. Mobile Salesforce ì•±ì—ì„œ í‘¸ì‹œ ì•Œë¦¼ ìˆ˜ì‹  í™•ì¸');
    System.debug('2. ì•Œë¦¼ í„°ì¹˜ ì‹œ Order ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ í™•ì¸');
    
    // 10. ì—°ì²´ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì¤€ë¹„
    if (!generatedPayments.isEmpty()) {
        System.debug('');
        System.debug('ğŸ§ª ì¶”ê°€ ì—°ì²´ í…ŒìŠ¤íŠ¸ ì¤€ë¹„:');
        System.debug('ìƒì„±ëœ PaymentStatus ì¤‘ í•˜ë‚˜ë¥¼ ì—°ì²´ë¡œ ë³€ê²½í•˜ì—¬ ì—°ì²´ ì•Œë¦¼ë„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:');
        System.debug('');
        System.debug('PaymentStatus__c testPayment = [SELECT Id FROM PaymentStatus__c WHERE Order__c = \'' + createdOrder.Id + '\' LIMIT 1];');
        System.debug('testPayment.Status__c = \'ì—°ì²´\';');
        System.debug('update testPayment;');
    }
    
    // 11. ì •ë¦¬ ì•ˆë‚´
    System.debug('');
    System.debug('ğŸ—‘ï¸ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ (í•„ìš”ì‹œ):');
    System.debug('ìƒì„±ëœ í…ŒìŠ¤íŠ¸ Orderë¥¼ ì‚­ì œí•˜ë ¤ë©´:');
    System.debug('delete [SELECT Id FROM Order WHERE Id = \'' + createdOrder.Id + '\'];');
    
} catch (DmlException dmlEx) {
    System.debug('âŒ Order ìƒì„± ì‹¤íŒ¨:');
    for (Integer i = 0; i < dmlEx.getNumDml(); i++) {
        System.debug('   â€¢ ' + dmlEx.getDmlMessage(i));
        System.debug('   â€¢ í•„ë“œ: ' + dmlEx.getDmlFieldNames(i));
    }
} catch (Exception e) {
    System.debug('âŒ Order ìƒì„± í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('   íƒ€ì…: ' + e.getTypeName());
    System.debug('   ë¼ì¸: ' + e.getLineNumber());
}

System.debug('');
System.debug('ğŸ¯ =====Order ìƒì„± ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ì™„ë£Œ=====');
System.debug('ğŸ“¢ ì§€ê¸ˆ ë°”ë¡œ ìƒë‹¨ ë²¨ ì•„ì´ì½˜ì„ í™•ì¸í•´ë³´ì„¸ìš”!');
