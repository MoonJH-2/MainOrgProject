/**
 * Order 00000156 ìƒíƒœ ë¶„ì„ ë° ì±„ë„ ìë™ ìƒì„± í…ŒìŠ¤íŠ¸
 */

System.debug('=== ğŸ“Š Order 00000156 ìë™ ì±„ë„ ìƒì„± ë¶„ì„ ===');

// 1. Order 00000156 ì •ë³´ í™•ì¸
List<Order> orders = [
    SELECT Id, Name, OrderNumber, Status, OwnerId, AccountId, 
           Payment_Method__c, OpportunityId,
           Slack_Channel_ID__c, Slack_Channel_Name__c, Slack_Notification_Status__c
    FROM Order 
    WHERE OrderNumber = '00000156'
    LIMIT 1
];

if(orders.isEmpty()) {
    System.debug('âŒ Order 00000156ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
}

Order order156 = orders[0];

System.debug('ğŸ“‹ Order 00000156 ìƒì„¸ ì •ë³´:');
System.debug('- ID: ' + order156.Id);
System.debug('- ë²ˆí˜¸: ' + order156.OrderNumber);
System.debug('- ìƒíƒœ: ' + order156.Status);
System.debug('- Payment Method: ' + order156.Payment_Method__c);
System.debug('- Opportunity ID: ' + order156.OpportunityId);
System.debug('- Slack Channel ID: ' + order156.Slack_Channel_ID__c);
System.debug('- Slack Notification Status: ' + order156.Slack_Notification_Status__c);

// 2. ìë™ ì±„ë„ ìƒì„± ì¡°ê±´ í™•ì¸
System.debug('\n=== ğŸ” ìë™ ì±„ë„ ìƒì„± ì¡°ê±´ ë¶„ì„ ===');

boolean hasPaymentMethod = String.isNotBlank(order156.Payment_Method__c);
boolean hasOpportunity = order156.OpportunityId != null;
boolean isActivated = order156.Status == 'Activated';

System.debug('âœ… Payment Method ì¡´ì¬: ' + hasPaymentMethod);
System.debug('âœ… Opportunity ì—°ê²°: ' + hasOpportunity);
System.debug('âœ… Activated ìƒíƒœ: ' + isActivated);

// 3. ê¸°ì¡´ Salesforce ì±„ë„ í™•ì¸
List<CollaborationGroup> existingChannels = [
    SELECT Id, Name, Description, MemberCount, CreatedDate
    FROM CollaborationGroup 
    WHERE Name LIKE '%00000156%'
];

System.debug('\n=== ğŸ“± ê¸°ì¡´ Salesforce ì±„ë„ í˜„í™© ===');
System.debug('ë°œê²¬ëœ ì±„ë„ ìˆ˜: ' + existingChannels.size());
for(CollaborationGroup channel : existingChannels) {
    System.debug('- ' + channel.Name + ' (ID: ' + channel.Id + ', ë©¤ë²„: ' + channel.MemberCount + ')');
}

// 4. ìë™ ì±„ë„ ìƒì„± ì‹œë®¬ë ˆì´ì…˜
if(existingChannels.isEmpty()) {
    System.debug('\n=== ğŸš€ Order 00000156 ìë™ ì±„ë„ ìƒì„± ===');
    
    try {
        String channelId = SimpleSalesforceChannelService.createOrderChannel(order156.Id);
        
        if(channelId != null) {
            System.debug('âœ… ì±„ë„ ìƒì„± ì„±ê³µ: ' + channelId);
            
            // ë©¤ë²„ ìë™ ì¶”ê°€
            SimpleSalesforceChannelService.addUserToChannel(channelId, order156.OwnerId);
            SimpleSalesforceChannelService.addUserToChannel(channelId, UserInfo.getUserId());
            
            // í™˜ì˜ ë©”ì‹œì§€
            SimpleSalesforceChannelService.postWelcomeMessage(channelId, order156.Id, order156.OrderNumber);
            
            System.debug('ğŸ‰ Order 00000156 ìë™ ì±„ë„ ìƒì„± ì™„ë£Œ!');
            System.debug('ğŸ“± í™•ì¸ ë°©ë²•: Sales ì•± â†’ Chatter â†’ ê·¸ë£¹ â†’ "Order-00000156" ê²€ìƒ‰');
            
        } else {
            System.debug('âŒ ì±„ë„ ìƒì„± ì‹¤íŒ¨');
        }
        
    } catch(Exception e) {
        System.debug('âŒ ì±„ë„ ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
    }
    
} else {
    System.debug('âš ï¸ ì´ë¯¸ ì±„ë„ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ìƒˆë¡œ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
}

// 5. íŠ¸ë¦¬ê±° ë¡œì§ ë¶„ì„
System.debug('\n=== ğŸ”§ í˜„ì¬ íŠ¸ë¦¬ê±° ë¡œì§ ë¶„ì„ ===');

if(hasPaymentMethod) {
    System.debug('âœ… Payment Method ì¡°ê±´ ë§Œì¡± â†’ orderIdsToProcessì— í¬í•¨ë  ê²ƒ');
} else {
    System.debug('âŒ Payment Method ì—†ìŒ â†’ orderIdsToProcessì—ì„œ ì œì™¸');
}

if(hasOpportunity) {
    System.debug('âœ… Opportunity ì¡°ê±´ ë§Œì¡± â†’ orderIdsForAutomationì— í¬í•¨ë  ê²ƒ');
} else {
    System.debug('âŒ Opportunity ì—†ìŒ â†’ orderIdsForAutomationì—ì„œ ì œì™¸');
}

// 6. ë¬¸ì œì  ë° í•´ê²°ë°©ì•ˆ
System.debug('\n=== ğŸ’¡ ë¬¸ì œì  ë° í•´ê²°ë°©ì•ˆ ===');

if(!hasOpportunity) {
    System.debug('ğŸš¨ ì£¼ìš” ë¬¸ì œ: Opportunityê°€ ì—°ê²°ë˜ì§€ ì•Šì•„ ìë™í™” íŠ¸ë¦¬ê±°ì—ì„œ ì œì™¸ë¨');
    System.debug('ğŸ“ í•´ê²°ë°©ì•ˆ:');
    System.debug('   1. Orderì— Opportunityë¥¼ ì—°ê²°');
    System.debug('   2. íŠ¸ë¦¬ê±° ë¡œì§ì„ ëª¨ë“  Orderì— ì ìš©í•˜ë„ë¡ ìˆ˜ì •');
    System.debug('   3. ë³„ë„ì˜ ì±„ë„ ìƒì„± íŠ¸ë¦¬ê±° ì¶”ê°€');
}

if(order156.Slack_Notification_Status__c == 'Not Created') {
    System.debug('âš ï¸ Slack ì±„ë„ ìƒíƒœê°€ "Not Created"ë¡œ ì„¤ì •ë¨');
    System.debug('ğŸ“ Salesforce ì±„ë„ë¡œ ì „í™˜ í•„ìš”');
}

// 7. ì¦‰ì‹œ í•´ê²° ì•¡ì…˜
System.debug('\n=== âš¡ ì¦‰ì‹œ í•´ê²° ì•¡ì…˜ ===');
System.debug('1. í˜„ì¬ ìŠ¤í¬ë¦½íŠ¸ë¡œ ìˆ˜ë™ ì±„ë„ ìƒì„± (ìœ„ì—ì„œ ì‹¤í–‰ë¨)');
System.debug('2. íŠ¸ë¦¬ê±° ë¡œì§ ê°œì„  (ëª¨ë“  Orderì— ì ìš©)');
System.debug('3. Order ìƒì„± ì‹œ ì¦‰ì‹œ ì±„ë„ ìƒì„±ë˜ë„ë¡ beforeInsert ì¶”ê°€');

System.debug('\n=== âœ… Order 00000156 ë¶„ì„ ì™„ë£Œ ===');
