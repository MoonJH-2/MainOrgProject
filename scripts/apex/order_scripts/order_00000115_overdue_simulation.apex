// Order 00000115 ì—°ì²´ ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸
System.debug('ğŸš¨ =====Order 00000115 ì—°ì²´ ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸=====');

try {
    // 1. Order 00000115 ì¡°íšŒ
    List<Order> orders = [
        SELECT Id, OrderNumber, Account.Name
        FROM Order 
        WHERE OrderNumber = '00000115'
        LIMIT 1
    ];
    
    if (orders.isEmpty()) {
        System.debug('âŒ Order 00000115ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Order targetOrder = orders[0];
    System.debug('ğŸ“‹ í…ŒìŠ¤íŠ¸ ëŒ€ìƒ: ' + targetOrder.OrderNumber + ' (' + targetOrder.Account.Name + ')');
    
    // 2. 2ì°¨ ë‚©ë¶€ë¥¼ ê³¼ê±° ë‚ ì§œë¡œ ë³€ê²½í•˜ì—¬ ì—°ì²´ ìƒí™© ì‹œë®¬ë ˆì´ì…˜
    List<PaymentStatus__c> secondPayments = [
        SELECT Id, InstallmentNumber__c, DueDate__c, Status__c, Amount__c
        FROM PaymentStatus__c 
        WHERE Order__c = :targetOrder.Id
        AND InstallmentNumber__c = 2
        LIMIT 1
    ];
    
    if (secondPayments.isEmpty()) {
        System.debug('âŒ 2ì°¨ ë‚©ë¶€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    PaymentStatus__c secondPayment = secondPayments[0];
    System.debug('ğŸ“Š 2ì°¨ ë‚©ë¶€ ì›ë˜ ì •ë³´:');
    System.debug('   â€¢ ì˜ˆì •ì¼: ' + secondPayment.DueDate__c.format());
    System.debug('   â€¢ ìƒíƒœ: ' + secondPayment.Status__c);
    System.debug('   â€¢ ê¸ˆì•¡: â‚©' + secondPayment.Amount__c.format());
    
    // 2ì°¨ ë‚©ë¶€ë¥¼ 3ì¼ ì „ìœ¼ë¡œ ë³€ê²½ (ì—°ì²´ ìƒí™© ë§Œë“¤ê¸°)
    Date pastDueDate = Date.today().addDays(-3);
    secondPayment.DueDate__c = pastDueDate;
    secondPayment.Status__c = 'ë¯¸ë‚©'; // ì—°ì²´ ìƒíƒœë¡œ ë³€ê²½
    
    update secondPayment;
    System.debug('âœ… 2ì°¨ ë‚©ë¶€ë¥¼ ì—°ì²´ ìƒíƒœë¡œ ë³€ê²½ ì™„ë£Œ');
    System.debug('   â€¢ ìƒˆ ì˜ˆì •ì¼: ' + pastDueDate.format() + ' (3ì¼ ì „)');
    System.debug('   â€¢ ìƒˆ ìƒíƒœ: ë¯¸ë‚©');
    
    // 3. ì—°ì²´ ì•Œë¦¼ ìƒì„± ë° ë°œì†¡ í…ŒìŠ¤íŠ¸
    System.debug('ğŸ”” ì—°ì²´ ì•Œë¦¼ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì¤‘...');
    
    Payment_Notification__c notification = new Payment_Notification__c();
    notification.PaymentStatus__c = secondPayment.Id;
    notification.NotificationType__c = 'ì—°ì²´ ì•Œë¦¼';
    notification.NotificationChannel__c = 'Salesforce';
    notification.NotificationStatus__c = 'Pending';
    notification.ScheduledDateTime__c = DateTime.now();
    
    insert notification;
    System.debug('âœ… ì—°ì²´ ì•Œë¦¼ ë ˆì½”ë“œ ìƒì„±: ' + notification.Id);
    
    // ê´€ê³„ í•„ë“œì™€ í•¨ê»˜ ë‹¤ì‹œ ì¡°íšŒ
    Payment_Notification__c fullNotification = [
        SELECT Id, PaymentStatus__c, PaymentStatus__r.Order__c,
               PaymentStatus__r.Order__r.Account.Name, PaymentStatus__r.Order__r.Account.Id,
               PaymentStatus__r.Order__r.OrderNumber, PaymentStatus__r.InstallmentNumber__c,
               PaymentStatus__r.Amount__c, PaymentStatus__r.DueDate__c, PaymentStatus__r.Status__c,
               NotificationType__c, NotificationChannel__c
        FROM Payment_Notification__c 
        WHERE Id = :notification.Id
    ];
    
    // 4. ì•Œë¦¼ ë°œì†¡ í…ŒìŠ¤íŠ¸
    System.debug('ğŸ“® ë‹¤ì¤‘ ì±„ë„ ì•Œë¦¼ ë°œì†¡ í…ŒìŠ¤íŠ¸...');
    
    // 4-1. Salesforce ì•Œë¦¼ (Task + Chatter + Custom Notification)
    Boolean salesforceResult = PaymentNotificationService.sendSalesforceNotification(fullNotification);
    System.debug('   ğŸ”” Salesforce ì•Œë¦¼: ' + (salesforceResult ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'));
    
    // 4-2. ì´ë©”ì¼ ì•Œë¦¼ (ê³ ê° + ê´€ë¦¬ì)
    Boolean emailResult = PaymentNotificationService.sendEmailNotification(fullNotification);
    System.debug('   ğŸ“§ ì´ë©”ì¼ ì•Œë¦¼: ' + (emailResult ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'));
    
    // 5. ìƒì„±ëœ Task í™•ì¸
    System.debug('ğŸ“ ìƒˆë¡œ ìƒì„±ëœ Task í™•ì¸:');
    List<Task> newTasks = [
        SELECT Id, Subject, Priority, Status, ActivityDate, CreatedDate
        FROM Task 
        WHERE WhatId = :targetOrder.Id
        AND CreatedDate = TODAY
        AND Subject LIKE '%2ì°¨%'
        ORDER BY CreatedDate DESC
        LIMIT 3
    ];
    
    System.debug('   2ì°¨ ê´€ë ¨ ìƒˆ Task ìˆ˜: ' + newTasks.size() + 'ê°œ');
    for (Task task : newTasks) {
        System.debug('   â€¢ ' + task.Subject + ' (ìš°ì„ ìˆœìœ„: ' + task.Priority + ', ìƒíƒœ: ' + task.Status + ')');
        System.debug('     í™œë™ì¼: ' + (task.ActivityDate != null ? task.ActivityDate.format() : 'ë¯¸ì„¤ì •'));
    }
    
    // 6. ì „ì²´ Task í˜„í™© í™•ì¸
    List<Task> allTasks = [
        SELECT Id, Subject, Priority, Status, ActivityDate, CreatedDate
        FROM Task 
        WHERE WhatId = :targetOrder.Id
        ORDER BY CreatedDate DESC
        LIMIT 10
    ];
    
    System.debug('ğŸ“‹ Order 00000115 ì „ì²´ Task í˜„í™©: ' + allTasks.size() + 'ê°œ');
    for (Task task : allTasks) {
        String createdToday = task.CreatedDate.date() == Date.today() ? ' [ì˜¤ëŠ˜]' : '';
        System.debug('   â€¢ ' + task.Subject + ' (' + task.Priority + ')' + createdToday);
    }
    
    // 7. í…ŒìŠ¤íŠ¸ ì •ë¦¬ - ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬
    System.debug('ğŸ”„ í…ŒìŠ¤íŠ¸ ì •ë¦¬ ì¤‘...');
    secondPayment.DueDate__c = Date.newInstance(2025, 8, 14); // ì›ë˜ ë‚ ì§œë¡œ ë³µêµ¬
    secondPayment.Status__c = 'ì˜ˆì •'; // ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬
    update secondPayment;
    System.debug('âœ… 2ì°¨ ë‚©ë¶€ ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬ ì™„ë£Œ');
    
    // 8. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
    System.debug('');
    System.debug('ğŸ“Š =====ì—°ì²´ ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ ê²°ê³¼=====');
    System.debug('â€¢ ì—°ì²´ ìƒí™© ìƒì„±: âœ… ì„±ê³µ (2ì°¨ ë‚©ë¶€ 3ì¼ ì—°ì²´)');
    System.debug('â€¢ ì•Œë¦¼ ë ˆì½”ë“œ ìƒì„±: âœ… ì„±ê³µ');
    System.debug('â€¢ Salesforce ì•Œë¦¼: ' + (salesforceResult ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'));
    System.debug('â€¢ ì´ë©”ì¼ ì•Œë¦¼: ' + (emailResult ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'));
    System.debug('â€¢ Task ìƒì„±: ' + newTasks.size() + 'ê°œ ìƒì„±');
    System.debug('â€¢ í…ŒìŠ¤íŠ¸ ì •ë¦¬: âœ… ì™„ë£Œ');
    
    System.debug('');
    System.debug('ğŸ¯ Order 00000115 Activity Timeline í™•ì¸ í•­ëª©:');
    System.debug('1. "ì—°ì²´ ì•Œë¦¼ - 0714TEST 2ì°¨" Task í™•ì¸');
    System.debug('2. ìš°ì„ ìˆœìœ„ Highë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸');
    System.debug('3. Upcoming & Overdue ì„¹ì…˜ì— í‘œì‹œë˜ëŠ”ì§€ í™•ì¸');
    System.debug('4. Task ì„¤ëª…ì— ì—°ì²´ ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸');
    
    System.debug('âœ… =====Order 00000115 ì—°ì²´ ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ=====');
    
} catch (Exception e) {
    System.debug('âŒ ì—°ì²´ ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}
