// Order 00000158 Slack Channel í™œì„±í™” í•´ê²° ìŠ¤í¬ë¦½íŠ¸
// Slack Channelì´ í™”ë©´ì—ì„œ ë¹„í™œì„±í™”ëœ ë¬¸ì œë¥¼ í•´ê²°

try {
    // 1. Order 00000158 ì¡°íšŒ
    List<Order> orders = [
        SELECT Id, OrderNumber, Slack_Channel_ID__c, Slack_Channel_Name__c, 
               Slack_Notification_Status__c, Slack_Webhook_URL__c,
               OwnerId, Owner.Name, Account.Name
        FROM Order 
        WHERE OrderNumber = '00000158'
        LIMIT 1
    ];
    
    if (orders.isEmpty()) {
        System.debug('âŒ Order 00000158ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Order order = orders[0];
    System.debug('ğŸ“‹ Order 00000158 Slack Channel í™œì„±í™” ì‹œì‘');
    System.debug('í˜„ì¬ Slack Channel ID: ' + order.Slack_Channel_ID__c);
    System.debug('í˜„ì¬ Notification Status: ' + order.Slack_Notification_Status__c);
    
    // 2. í•´ê²° ë°©ë²• 1: Slack Notification Status ì—…ë°ì´íŠ¸
    System.debug('\nğŸ”§ í•´ê²°ì±… 1: Slack Notification Status ì—…ë°ì´íŠ¸');
    
    Order orderToUpdate = new Order();
    orderToUpdate.Id = order.Id;
    orderToUpdate.Slack_Notification_Status__c = 'Created';
    
    // Webhook URLì´ ë¹„ì–´ìˆë‹¤ë©´ ê¸°ë³¸ê°’ ì„¤ì •
    if (String.isBlank(order.Slack_Webhook_URL__c)) {
        orderToUpdate.Slack_Webhook_URL__c = 'https://hooks.slack.com/services/default'; // ê¸°ë³¸ Webhook URL
        System.debug('ğŸ“ Slack Webhook URL ê¸°ë³¸ê°’ ì„¤ì •');
    }
    
    update orderToUpdate;
    System.debug('âœ… Order 00000158 Slack í•„ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    
    // 3. í•´ê²° ë°©ë²• 2: Salesforce ì±„ë„ ìƒì„± (ì—†ëŠ” ê²½ìš°)
    System.debug('\nğŸ”§ í•´ê²°ì±… 2: Salesforce ì±„ë„ í™•ì¸ ë° ìƒì„±');
    
    List<CollaborationGroup> existingChannels = [
        SELECT Id, Name FROM CollaborationGroup 
        WHERE Name LIKE '%00000158%'
        LIMIT 1
    ];
    
    String salesforceChannelId = null;
    
    if (existingChannels.isEmpty()) {
        // Salesforce ì±„ë„ ìƒì„±
        salesforceChannelId = SimpleSalesforceChannelService.createOrderChannel(order.Id);
        
        if (salesforceChannelId != null) {
            System.debug('âœ… Salesforce ì±„ë„ ìƒì„± ì™„ë£Œ: ' + salesforceChannelId);
            
            // Order Owner ì¶”ê°€
            SimpleSalesforceChannelService.addUserToChannel(salesforceChannelId, order.OwnerId);
            System.debug('âœ… Order Owner ì±„ë„ ì¶”ê°€ ì™„ë£Œ');
            
            // í™˜ì˜ ë©”ì‹œì§€ ê²Œì‹œ
            SimpleSalesforceChannelService.postWelcomeMessage(salesforceChannelId, order.Id, order.OrderNumber);
            System.debug('âœ… í™˜ì˜ ë©”ì‹œì§€ ê²Œì‹œ ì™„ë£Œ');
        }
    } else {
        salesforceChannelId = existingChannels[0].Id;
        System.debug('â„¹ï¸ ê¸°ì¡´ Salesforce ì±„ë„ ì‚¬ìš©: ' + salesforceChannelId);
    }
    
    // 4. í•´ê²° ë°©ë²• 3: Slack-Salesforce ì—°ë™ í™œì„±í™” ë©”ì‹œì§€
    if (salesforceChannelId != null) {
        String activationMessage = 'ğŸ‰ Order 00000158 Slack Channel í™œì„±í™” ì™„ë£Œ!\n\n';
        activationMessage += 'ğŸ“‹ Order: 00000158\n';
        activationMessage += 'ğŸ¢ Account: ' + order.Account.Name + '\n';
        activationMessage += 'ğŸ‘¤ Owner: ' + order.Owner.Name + '\n';
        activationMessage += 'ğŸ”— Slack Channel ID: ' + order.Slack_Channel_ID__c + '\n';
        activationMessage += 'ğŸ’¬ Salesforce Channel: ' + salesforceChannelId + '\n\n';
        activationMessage += 'âœ… ì´ì œ Slackê³¼ Salesforceì—ì„œ ëª¨ë‘ í˜‘ì—…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!\n';
        activationMessage += '#SlackIntegration #OrderManagement';
        
        SimpleSalesforceChannelService.sendChannelMessage(salesforceChannelId, activationMessage);
        System.debug('âœ… í™œì„±í™” ì™„ë£Œ ë©”ì‹œì§€ ê²Œì‹œ');
    }
    
    // 5. ìµœì¢… ê²°ê³¼ í™•ì¸
    System.debug('\n=== ìµœì¢… ê²°ê³¼ ===');
    List<Order> updatedOrder = [
        SELECT Slack_Channel_ID__c, Slack_Notification_Status__c, Slack_Webhook_URL__c
        FROM Order 
        WHERE Id = :order.Id
        LIMIT 1
    ];
    
    if (!updatedOrder.isEmpty()) {
        Order finalOrder = updatedOrder[0];
        System.debug('ğŸ“Š ìµœì¢… Slack Channel ID: ' + finalOrder.Slack_Channel_ID__c);
        System.debug('ğŸ“Š ìµœì¢… Notification Status: ' + finalOrder.Slack_Notification_Status__c);
        System.debug('ğŸ“Š ìµœì¢… Webhook URL: ' + finalOrder.Slack_Webhook_URL__c);
    }
    
    System.debug('\nğŸ‰ Order 00000158 Slack Channel í™œì„±í™” ì‘ì—… ì™„ë£Œ!');
    System.debug('ğŸ’¡ ë¸Œë¼ìš°ì €ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë³€ê²½ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”.');
    
} catch (Exception e) {
    System.debug('âŒ Slack Channel í™œì„±í™” ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
}
