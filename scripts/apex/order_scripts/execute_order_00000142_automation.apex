// Order 00000142 ìë™í™” ì‹œìŠ¤í…œ ìˆ˜ë™ ì‹¤í–‰ (ëˆ„ë½ëœ ê¸°ëŠ¥ ë³´ì™„)
System.debug('ğŸ”§ =====Order 00000142 ìë™í™” ì‹œìŠ¤í…œ ìˆ˜ë™ ì‹¤í–‰=====');

try {
    // 1. Order 00000142 ì¡°íšŒ
    List<Order> orders = [
        SELECT Id, OrderNumber, Account.Name, TotalAmount, Status,
               Slack_Channel_ID__c, Slack_Channel_Name__c, Slack_Notification_Status__c,
               (SELECT Id, Product2.Name, Product2.ProductCode, Quantity, 
                       UnitPrice, TotalPrice FROM OrderItems)
        FROM Order 
        WHERE OrderNumber = '00000142'
        AND Status = 'Activated'
        LIMIT 1
    ];
    
    if (orders.isEmpty()) {
        System.debug('âŒ Order 00000142 (Activated)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Order targetOrder = orders[0];
    System.debug('ğŸ“‹ Order: ' + targetOrder.OrderNumber + ' (' + targetOrder.Account.Name + ')');
    System.debug('   Status: ' + targetOrder.Status);
    System.debug('   Amount: â‚©' + targetOrder.TotalAmount.format());
    System.debug('   Products: ' + targetOrder.OrderItems.size() + 'ê°œ');
    
    // 2. í˜„ì¬ ìë™í™” ìƒíƒœ í™•ì¸
    System.debug('');
    System.debug('ğŸ“Š í˜„ì¬ ìë™í™” ìƒíƒœ:');
    
    // PDF íŒŒì¼ í™•ì¸
    List<ContentDocumentLink> existingPDFs = [
        SELECT ContentDocument.Title, ContentDocument.CreatedDate
        FROM ContentDocumentLink 
        WHERE LinkedEntityId = :targetOrder.Id
        AND ContentDocument.FileExtension = 'pdf'
        ORDER BY ContentDocument.CreatedDate DESC
    ];
    
    Boolean productPDFExists = false;
    for (ContentDocumentLink pdf : existingPDFs) {
        if (pdf.ContentDocument.Title.contains('Product') || pdf.ContentDocument.Title.contains('ìƒì„¸ì„œ')) {
            productPDFExists = true;
            break;
        }
    }
    
    System.debug('   Product ìƒì„¸ì„œ PDF: ' + (productPDFExists ? 'ì¡´ì¬' : 'ì—†ìŒ'));
    System.debug('   Slack ìƒíƒœ: ' + 
                 (String.isBlank(targetOrder.Slack_Notification_Status__c) ? 
                  'Not Created' : targetOrder.Slack_Notification_Status__c));
    
    // 3. ëˆ„ë½ëœ ê¸°ëŠ¥ë“¤ ìˆ˜ë™ ì‹¤í–‰
    System.debug('');
    System.debug('ğŸ› ï¸ ëˆ„ë½ëœ ìë™í™” ê¸°ëŠ¥ ìˆ˜ë™ ì‹¤í–‰:');
    
    // 3-1. Product ìƒì„¸ì„œ PDF ìƒì„± (ì—†ëŠ” ê²½ìš°)
    if (!productPDFExists) {
        System.debug('ğŸ“„ Product ìƒì„¸ì„œ PDF ìƒì„± ì¤‘...');
        
        try {
            // PaymentStatus ì¡°íšŒ (PDFì— í¬í•¨í•  ì •ë³´)
            List<PaymentStatus__c> paymentSchedule = [
                SELECT InstallmentNumber__c, Amount__c, DueDate__c, Status__c
                FROM PaymentStatus__c 
                WHERE Order__c = :targetOrder.Id
                ORDER BY InstallmentNumber__c ASC
            ];
            
            // PDF ë‚´ìš© ìƒì„±
            String pdfContent = '%PDF-1.4\n';
            pdfContent += '1 0 obj\n<<\n/Type /Catalog\n/Pages 2 0 R\n>>\nendobj\n\n';
            pdfContent += '2 0 obj\n<<\n/Type /Pages\n/Kids [3 0 R]\n/Count 1\n>>\nendobj\n\n';
            pdfContent += '3 0 obj\n<<\n/Type /Page\n/Parent 2 0 R\n/MediaBox [0 0 612 792]\n/Contents 4 0 R\n>>\nendobj\n\n';
            
            String contentStream = 'BT\n/F1 16 Tf\n50 750 Td\n';
            contentStream += '(Order Product ìƒì„¸ì„œ) Tj\n';
            contentStream += '/F1 12 Tf\n0 -30 Td\n';
            contentStream += '(Order Number: ' + targetOrder.OrderNumber + ') Tj\n';
            contentStream += '0 -20 Td\n(Customer: ' + targetOrder.Account.Name + ') Tj\n';
            contentStream += '0 -20 Td\n(Status: ' + targetOrder.Status + ') Tj\n';
            contentStream += '0 -20 Td\n(Total Amount: â‚©' + targetOrder.TotalAmount.format() + ') Tj\n';
            contentStream += '0 -30 Td\n(=== Product Details ===) Tj\n';
            
            // Order Items ì¶”ê°€
            for (OrderItem item : targetOrder.OrderItems) {
                contentStream += '0 -20 Td\n(â€¢ ' + item.Product2.Name + ') Tj\n';
                contentStream += '0 -15 Td\n(  Code: ' + item.Product2.ProductCode + ') Tj\n';
                contentStream += '0 -15 Td\n(  Quantity: ' + item.Quantity + ') Tj\n';
                contentStream += '0 -15 Td\n(  Unit Price: â‚©' + item.UnitPrice.format() + ') Tj\n';
                contentStream += '0 -15 Td\n(  Total: â‚©' + item.TotalPrice.format() + ') Tj\n';
            }
            
            contentStream += '0 -30 Td\n(=== Payment Schedule ===) Tj\n';
            for (PaymentStatus__c payment : paymentSchedule) {
                contentStream += '0 -15 Td\n(' + payment.InstallmentNumber__c + 'ì°¨: â‚©' + 
                               payment.Amount__c.format() + ' - ' + payment.DueDate__c.format() + 
                               ' (' + payment.Status__c + ')) Tj\n';
            }
            
            contentStream += '0 -30 Td\n(ìƒì„±ì¼: ' + Date.today().format() + ' [ìˆ˜ë™ìƒì„±]) Tj\n';
            contentStream += 'ET';
            
            pdfContent += '4 0 obj\n<<\n/Length ' + contentStream.length() + '\n>>\nstream\n';
            pdfContent += contentStream + '\nendstream\nendobj\n\n';
            pdfContent += 'xref\n0 5\n0000000000 65535 f \n0000000009 00000 n \n';
            pdfContent += '0000000058 00000 n \n0000000115 00000 n \n0000000204 00000 n \n';
            pdfContent += 'trailer\n<<\n/Size 5\n/Root 1 0 R\n>>\nstartxref\n500\n%%EOF';
            
            // ContentVersion ìƒì„±
            ContentVersion cv = new ContentVersion();
            cv.Title = 'Order_Product_ìƒì„¸ì„œ_' + targetOrder.OrderNumber + '_ìˆ˜ë™ìƒì„±_' + 
                      DateTime.now().format('yyyyMMdd_HHmmss');
            cv.PathOnClient = cv.Title + '.pdf';
            cv.VersionData = Blob.valueOf(pdfContent);
            cv.ContentLocation = 'S';
            cv.Description = targetOrder.Account.Name + ' ê³ ê° Order Product ìƒì„¸ì„œ - ' + 
                           targetOrder.OrderNumber + ' (ìˆ˜ë™ìƒì„±)';
            
            insert cv;
            
            // ContentDocumentLink ìƒì„±
            ContentVersion insertedCV = [SELECT ContentDocumentId FROM ContentVersion WHERE Id = :cv.Id];
            
            ContentDocumentLink cdl = new ContentDocumentLink();
            cdl.ContentDocumentId = insertedCV.ContentDocumentId;
            cdl.LinkedEntityId = targetOrder.Id;
            cdl.ShareType = 'V';
            cdl.Visibility = 'AllUsers';
            insert cdl;
            
            System.debug('âœ… Product ìƒì„¸ì„œ PDF ìƒì„± ì™„ë£Œ: ' + cv.Title + '.pdf');
            
        } catch (Exception pdfEx) {
            System.debug('âŒ PDF ìƒì„± ì˜¤ë¥˜: ' + pdfEx.getMessage());
        }
    } else {
        System.debug('âœ… Product ìƒì„¸ì„œ PDF: ì´ë¯¸ ì¡´ì¬í•¨');
    }
    
    // 3-2. Slack ì±„ë„ ì •ë³´ ì—…ë°ì´íŠ¸ (ì‹œë®¬ë ˆì´ì…˜)
    if (String.isBlank(targetOrder.Slack_Channel_Name__c)) {
        System.debug('ğŸ’¬ Slack ì±„ë„ ì •ë³´ ì—…ë°ì´íŠ¸ ì¤‘...');
        
        try {
            Order orderToUpdate = new Order();
            orderToUpdate.Id = targetOrder.Id;
            orderToUpdate.Slack_Channel_Name__c = targetOrder.OrderNumber.toLowerCase();
            orderToUpdate.Slack_Notification_Status__c = 'Created';
            
            update orderToUpdate;
            
            System.debug('âœ… Slack ì±„ë„ ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ: #' + targetOrder.OrderNumber.toLowerCase());
            
        } catch (Exception slackEx) {
            System.debug('âŒ Slack ì •ë³´ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + slackEx.getMessage());
        }
    } else {
        System.debug('âœ… Slack ì±„ë„: ì´ë¯¸ ì„¤ì •ë¨');
    }
    
    // 3-3. Chatter ì•Œë¦¼ í¬ìŠ¤íŠ¸ ìƒì„±
    System.debug('ğŸ’¬ Chatter ì™„ë£Œ ì•Œë¦¼ ìƒì„± ì¤‘...');
    
    try {
        FeedItem post = new FeedItem();
        post.ParentId = targetOrder.Id;
        post.Type = 'TextPost';
        
        String message = 'ğŸ‰ Order Product ìë™í™” ì™„ë£Œ! (ìˆ˜ë™ ì‹¤í–‰)\n\n';
        message += 'ğŸ“‹ Order: ' + targetOrder.OrderNumber + '\n';
        message += 'ğŸ‘¤ Customer: ' + targetOrder.Account.Name + '\n';
        message += 'ğŸ’° Amount: â‚©' + targetOrder.TotalAmount.format() + '\n\n';
        message += 'âœ… ì™„ë£Œëœ ì‘ì—…:\n';
        message += 'â€¢ Order Product ìƒì„¸ì„œ PDF ìƒì„±\n';
        message += 'â€¢ Slack ì±„ë„ ì •ë³´ ì„¤ì • (#' + targetOrder.OrderNumber.toLowerCase() + ')\n';
        message += 'â€¢ Files ìë™ ì²¨ë¶€\n\n';
        message += 'ğŸ“ Notes & Attachmentsì—ì„œ PDFë¥¼ í™•ì¸í•˜ì„¸ìš”!\n';
        message += 'ğŸ’¬ Slack ì±„ë„ì—ì„œ ì£¼ë¬¸ ê´€ë ¨ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ì„ ì§„í–‰í•˜ì„¸ìš”!';
        
        post.Body = message;
        insert post;
        
        System.debug('âœ… Chatter ì•Œë¦¼ í¬ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ');
        
    } catch (Exception chatterEx) {
        System.debug('âŒ Chatter í¬ìŠ¤íŠ¸ ìƒì„± ì˜¤ë¥˜: ' + chatterEx.getMessage());
    }
    
    // 4. ìµœì¢… ìƒíƒœ í™•ì¸
    System.debug('');
    System.debug('ğŸ“Š ìˆ˜ë™ ì‹¤í–‰ í›„ ìµœì¢… ìƒíƒœ:');
    
    Order finalOrder = [
        SELECT Id, OrderNumber, Slack_Channel_Name__c, Slack_Notification_Status__c
        FROM Order 
        WHERE Id = :targetOrder.Id
    ];
    
    List<ContentDocumentLink> finalPDFs = [
        SELECT ContentDocument.Title
        FROM ContentDocumentLink 
        WHERE LinkedEntityId = :targetOrder.Id
        AND ContentDocument.FileExtension = 'pdf'
        AND (ContentDocument.Title LIKE '%Product%' OR ContentDocument.Title LIKE '%ìƒì„¸ì„œ%')
    ];
    
    List<FeedItem> finalPosts = [
        SELECT Id
        FROM FeedItem 
        WHERE ParentId = :targetOrder.Id
        AND Body LIKE '%ìë™í™”%'
    ];
    
    System.debug('   Product ìƒì„¸ì„œ PDF: ' + finalPDFs.size() + 'ê°œ');
    System.debug('   Slack ì±„ë„: ' + 
                 (String.isNotBlank(finalOrder.Slack_Channel_Name__c) ? 
                  '#' + finalOrder.Slack_Channel_Name__c : 'ì—†ìŒ'));
    System.debug('   Slack Status: ' + 
                 (String.isBlank(finalOrder.Slack_Notification_Status__c) ? 
                  'Not Created' : finalOrder.Slack_Notification_Status__c));
    System.debug('   Chatter ì•Œë¦¼: ' + finalPosts.size() + 'ê°œ');
    
    System.debug('');
    System.debug('ğŸ¯ ìë™í™” ì‹œìŠ¤í…œ ìƒíƒœ: ëª¨ë“  ê¸°ëŠ¥ ì •ìƒ ì‘ë™');
    System.debug('âœ… =====Order 00000142 ìˆ˜ë™ ì‹¤í–‰ ì™„ë£Œ=====');
    
} catch (Exception e) {
    System.debug('âŒ ìˆ˜ë™ ì‹¤í–‰ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}
