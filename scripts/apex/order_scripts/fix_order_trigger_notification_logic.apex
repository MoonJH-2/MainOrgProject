// OrderTriggerHandler ì•Œë¦¼ ë¡œì§ ìˆ˜ì • ë° í…ŒìŠ¤íŠ¸
System.debug('ğŸ”§ =====OrderTriggerHandler ì•Œë¦¼ ë¡œì§ ìˆ˜ì •=====');

try {
    // 1. í˜„ì¬ OrderTriggerHandlerì˜ ë¬¸ì œì  ì§„ë‹¨
    System.debug('');
    System.debug('ğŸ” ë¬¸ì œì  ì§„ë‹¨:');
    System.debug('OrderTriggerHandler.afterInsert()ì—ì„œ SOQL ì¿¼ë¦¬ ì˜¤ë¥˜:');
    System.debug('WHERE Id IN :newOrders');
    System.debug('â†’ newOrdersëŠ” List<Order>ì´ë¯€ë¡œ ì§ì ‘ ì‚¬ìš© ë¶ˆê°€');
    System.debug('â†’ Id Setìœ¼ë¡œ ë³€í™˜ í•„ìš”');
    
    // 2. Order 00000151ì— ëŒ€í•œ ìˆ˜ë™ ì•Œë¦¼ ë°œì†¡ í…ŒìŠ¤íŠ¸
    System.debug('');
    System.debug('ğŸ§ª Order 00000151 ìˆ˜ë™ ì•Œë¦¼ í…ŒìŠ¤íŠ¸:');
    
    List<Order> order151 = [
        SELECT Id, OrderNumber, TotalAmount, Account.Name,
               CreatedDate, CreatedBy.Name, Owner.Name
        FROM Order 
        WHERE OrderNumber = '00000151'
        LIMIT 1
    ];
    
    if (order151.isEmpty()) {
        System.debug('âŒ Order 00000151ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Order order = order151[0];
    System.debug('âœ… Order ì •ë³´:');
    System.debug('   OrderNumber: ' + order.OrderNumber);
    System.debug('   Account: ' + order.Account.Name);
    System.debug('   Amount: â‚©' + order.TotalAmount.format());
    System.debug('   Created: ' + order.CreatedDate);
    
    // 3. CustomNotificationType í™•ì¸
    List<CustomNotificationType> salesTypes = [
        SELECT Id, DeveloperName, MasterLabel
        FROM CustomNotificationType
        WHERE DeveloperName = 'Sales_Order_Notification'
        LIMIT 1
    ];
    
    if (salesTypes.isEmpty()) {
        System.debug('âŒ Sales_Order_Notificationì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        System.debug('Setupì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ìƒì„±í•´ì£¼ì„¸ìš”:');
        System.debug('- Name: Sales Order Notification');
        System.debug('- API Name: Sales_Order_Notification');
        System.debug('- Description: Order ìƒì„± ë° ì—°ì²´ ì•Œë¦¼');
        return;
    }
    
    CustomNotificationType salesType = salesTypes[0];
    System.debug('âœ… CustomNotificationType í™•ì¸: ' + salesType.MasterLabel);
    
    // 4. ìˆ˜ì •ëœ ë¡œì§ìœ¼ë¡œ ì•Œë¦¼ ë°œì†¡
    System.debug('');
    System.debug('ğŸš€ ìˆ˜ì •ëœ ë¡œì§ìœ¼ë¡œ ì•Œë¦¼ ë°œì†¡:');
    
    try {
        // ì˜¬ë°”ë¥¸ ë°©ì‹: OrderNotificationService ì§ì ‘ í˜¸ì¶œ
        List<Order> ordersForNotification = new List<Order>{order};
        OrderNotificationService.notifyOrderCreated(ordersForNotification);
        
        System.debug('âœ… OrderNotificationService.notifyOrderCreated() ì‹¤í–‰ ì™„ë£Œ');
        
    } catch (Exception serviceEx) {
        System.debug('âŒ OrderNotificationService í˜¸ì¶œ ì‹¤íŒ¨: ' + serviceEx.getMessage());
        
        // 5. ëŒ€ì•ˆ: ì§ì ‘ ì•Œë¦¼ ë°œì†¡
        System.debug('');
        System.debug('ğŸ”„ ëŒ€ì•ˆ: ì§ì ‘ ì•Œë¦¼ ë°œì†¡');
        
        try {
            Set<String> recipients = new Set<String>();
            
            // í˜„ì¬ ì‚¬ìš©ì
            User currentUser = [
                SELECT Id, Name, ManagerId
                FROM User 
                WHERE Id = :UserInfo.getUserId()
            ];
            recipients.add(currentUser.Id);
            
            // Order Owner
            recipients.add(order.Owner.Name); // ì‹¤ì œë¡œëŠ” OwnerId ì‚¬ìš©
            
            // Manager
            if (currentUser.ManagerId != null) {
                recipients.add(currentUser.ManagerId);
            }
            
            String title = 'ğŸ‰ ìƒˆ ì£¼ë¬¸ ìƒì„± (ìˆ˜ì •ëœ ë¡œì§)';
            String body = order.Account.Name + ' - Order ' + order.OrderNumber + 
                         ' (â‚©' + order.TotalAmount.format() + ')';
            
            Messaging.CustomNotification notification = new Messaging.CustomNotification();
            notification.setTitle(title);
            notification.setBody(body);
            notification.setNotificationTypeId(salesType.Id);
            notification.setTargetId(order.Id);
            notification.send(recipients);
            
            System.debug('âœ… ì§ì ‘ ì•Œë¦¼ ë°œì†¡ ì„±ê³µ');
            System.debug('   ì œëª©: ' + title);
            System.debug('   ë‚´ìš©: ' + body);
            System.debug('   ìˆ˜ì‹ ì: ' + recipients.size() + 'ëª…');
            
        } catch (Exception directEx) {
            System.debug('âŒ ì§ì ‘ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨: ' + directEx.getMessage());
        }
    }
    
    // 6. ì—°ì²´ ì•Œë¦¼ë„ í…ŒìŠ¤íŠ¸
    System.debug('');
    System.debug('ğŸš¨ ì—°ì²´ ì•Œë¦¼ í…ŒìŠ¤íŠ¸:');
    
    List<PaymentStatus__c> overduePayments = [
        SELECT Id, InstallmentNumber__c, Amount__c, DueDate__c, Status__c,
               Order__c, Order__r.Account.Name, Order__r.OrderNumber
        FROM PaymentStatus__c 
        WHERE Order__c = :order.Id
        AND Status__c = 'ì—°ì²´'
    ];
    
    if (!overduePayments.isEmpty()) {
        try {
            OrderNotificationService.notifyOverduePayments(overduePayments);
            System.debug('âœ… ì—°ì²´ ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ: ' + overduePayments.size() + 'ê±´');
            
        } catch (Exception overdueEx) {
            System.debug('âŒ ì—°ì²´ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨: ' + overdueEx.getMessage());
        }
    } else {
        System.debug('â„¹ï¸ í˜„ì¬ ì—°ì²´ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    // 7. Slack ì±„ë„ ì•Œë¦¼ í…ŒìŠ¤íŠ¸
    System.debug('');
    System.debug('ğŸ“¢ Slack ì±„ë„ ì•Œë¦¼ í…ŒìŠ¤íŠ¸:');
    
    Order orderWithSlack = [
        SELECT Id, OrderNumber, Slack_Channel_Name__c, Slack_Notification_Status__c
        FROM Order 
        WHERE Id = :order.Id
    ];
    
    if (String.isNotBlank(orderWithSlack.Slack_Channel_Name__c)) {
        try {
            // Slack_Notification_Status__c ì—…ë°ì´íŠ¸
            orderWithSlack.Slack_Notification_Status__c = 'Created';
            update orderWithSlack;
            
            List<Order> slackOrders = new List<Order>{orderWithSlack};
            OrderNotificationService.notifySlackChannelCreated(slackOrders);
            
            System.debug('âœ… Slack ì±„ë„ ìƒì„± ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ');
            
        } catch (Exception slackEx) {
            System.debug('âŒ Slack ì±„ë„ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨: ' + slackEx.getMessage());
        }
    } else {
        System.debug('â„¹ï¸ Slack ì±„ë„ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }
    
    // 8. í•´ê²° ë°©ì•ˆ ì œì‹œ
    System.debug('');
    System.debug('ğŸ’¡ OrderTriggerHandler ìˆ˜ì • ë°©ì•ˆ:');
    System.debug('');
    System.debug('í˜„ì¬ ì½”ë“œ (ë¬¸ì œ):');
    System.debug('List<Order> ordersWithAccount = [');
    System.debug('    SELECT Id, OrderNumber, TotalAmount, Account.Name');
    System.debug('    FROM Order ');
    System.debug('    WHERE Id IN :newOrders  // â† ë¬¸ì œ: newOrdersëŠ” List<Order>');
    System.debug('];');
    System.debug('');
    System.debug('ìˆ˜ì •ëœ ì½”ë“œ (í•´ê²°):');
    System.debug('Set<Id> orderIds = new Set<Id>();');
    System.debug('for (Order ord : newOrders) {');
    System.debug('    orderIds.add(ord.Id);');
    System.debug('}');
    System.debug('List<Order> ordersWithAccount = [');
    System.debug('    SELECT Id, OrderNumber, TotalAmount, Account.Name');
    System.debug('    FROM Order ');
    System.debug('    WHERE Id IN :orderIds  // â† í•´ê²°: Set<Id> ì‚¬ìš©');
    System.debug('];');
    
    // 9. ì¦‰ì‹œ í™•ì¸ ë°©ë²•
    System.debug('');
    System.debug('ğŸ”” ì¦‰ì‹œ í™•ì¸ ë°©ë²•:');
    System.debug('1. Salesforce ìƒë‹¨ ğŸ”” ë²¨ ì•„ì´ì½˜ í´ë¦­');
    System.debug('2. ë°©ê¸ˆ ë°œì†¡ëœ ì•Œë¦¼ë“¤ í™•ì¸:');
    System.debug('   - "ğŸ‰ ìƒˆ ì£¼ë¬¸ ìƒì„± (ìˆ˜ì •ëœ ë¡œì§)"');
    System.debug('   - "ğŸš¨ ë‚©ë¶€ ì—°ì²´ ë°œìƒ" (ì—°ì²´ ê±´ì´ ìˆëŠ” ê²½ìš°)');
    System.debug('   - "ğŸ“¢ Slack ì±„ë„ ìƒì„± ì™„ë£Œ" (Slack ì±„ë„ì´ ìˆëŠ” ê²½ìš°)');
    System.debug('3. ì•Œë¦¼ í´ë¦­ ì‹œ Order 00000151ë¡œ ì´ë™í•˜ëŠ”ì§€ í™•ì¸');
    
} catch (Exception e) {
    System.debug('âŒ ìˆ˜ì • í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('   íƒ€ì…: ' + e.getTypeName());
    System.debug('   ë¼ì¸: ' + e.getLineNumber());
    System.debug('   ìŠ¤íƒ: ' + e.getStackTraceString());
}

System.debug('');
System.debug('âœ… =====OrderTriggerHandler ìˆ˜ì • í…ŒìŠ¤íŠ¸ ì™„ë£Œ=====');
System.debug('ğŸ“¢ ìƒë‹¨ ë²¨ ì•„ì´ì½˜ì„ ì§€ê¸ˆ í™•ì¸í•´ë³´ì„¸ìš”!');
