/**
 * ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•œ Asset ë°ì´í„° ìƒì„± (1ì¼ ì¡°ê±´ìœ¼ë¡œ ë³€ê²½)
 * ëª©ì : ìˆ˜ì •ëœ ë¡œì§ìœ¼ë¡œ ì¦‰ì‹œ ê°±ì‹  ê°€ëŠ¥í•œ Asset ìƒì„±
 */

System.debug('ğŸš€ === ì¦‰ì‹œ ê°±ì‹  ê°€ëŠ¥í•œ Asset ë°ì´í„° ìƒì„± ì‹œì‘ ===');

try {
    // 1. ê¸°ì¡´ ë°ì´í„° ì™„ì „ ì •ë¦¬ (ì•ˆì „í•œ ìˆœì„œ)
    System.debug('ğŸ—‘ï¸ ê¸°ì¡´ ë°ì´í„° ì •ë¦¬...');
    
    List<Task> oldTasks = [SELECT Id FROM Task WHERE Account.Name LIKE '%í…ŒìŠ¤íŠ¸%' OR Account.Name LIKE '%ìš°ìˆ˜%' OR Account.Name LIKE '%ì£¼ì˜%'];
    if(!oldTasks.isEmpty()) {
        delete oldTasks;
        System.debug('âœ… Task ì‚­ì œ: ' + oldTasks.size() + 'ê°œ');
    }
    
    List<Opportunity> oldOpps = [SELECT Id FROM Opportunity WHERE Account.Name LIKE '%í…ŒìŠ¤íŠ¸%' OR Account.Name LIKE '%ìš°ìˆ˜%' OR Account.Name LIKE '%ì£¼ì˜%'];
    if(!oldOpps.isEmpty()) {
        delete oldOpps;
        System.debug('âœ… Opportunity ì‚­ì œ: ' + oldOpps.size() + 'ê°œ');
    }
    
    List<Case> oldCases = [SELECT Id FROM Case WHERE Account.Name LIKE '%í…ŒìŠ¤íŠ¸%' OR Account.Name LIKE '%ìš°ìˆ˜%' OR Account.Name LIKE '%ì£¼ì˜%'];
    if(!oldCases.isEmpty()) {
        delete oldCases;
        System.debug('âœ… Case ì‚­ì œ: ' + oldCases.size() + 'ê°œ');
    }
    
    List<Asset> oldAssets = [SELECT Id FROM Asset WHERE Account.Name LIKE '%í…ŒìŠ¤íŠ¸%' OR Account.Name LIKE '%ìš°ìˆ˜%' OR Account.Name LIKE '%ì£¼ì˜%'];
    if(!oldAssets.isEmpty()) {
        delete oldAssets;
        System.debug('âœ… Asset ì‚­ì œ: ' + oldAssets.size() + 'ê°œ');
    }
    
    List<Account> oldAccounts = [SELECT Id FROM Account WHERE Name LIKE '%í…ŒìŠ¤íŠ¸%' OR Name LIKE '%ìš°ìˆ˜%' OR Name LIKE '%ì£¼ì˜%'];
    if(!oldAccounts.isEmpty()) {
        delete oldAccounts;
        System.debug('âœ… Account ì‚­ì œ: ' + oldAccounts.size() + 'ê°œ');
    }
    
    // 2. í…ŒìŠ¤íŠ¸ìš© Account ìƒì„±
    System.debug('ğŸ¢ í…ŒìŠ¤íŠ¸ Account ìƒì„±...');
    
    List<Account> testAccounts = new List<Account>{
        new Account(Name = 'ê¸´ê¸‰ê³ ê°', Type = 'Customer'),
        new Account(Name = 'ì¤‘ìš”ê³ ê°', Type = 'Customer'), 
        new Account(Name = 'ì¼ë°˜ê³ ê°', Type = 'Customer'),
        new Account(Name = 'ìœ„í—˜ê³ ê°', Type = 'Customer')
    };
    insert testAccounts;
    System.debug('âœ… Account ìƒì„±: ' + testAccounts.size() + 'ê°œ');
    
    // 3. ì¦‰ì‹œ ê°±ì‹  ê°€ëŠ¥í•œ Asset ìƒì„± (1ì¼ ì¡°ê±´)
    System.debug('ğŸ’¼ ì¦‰ì‹œ ê°±ì‹  ê°€ëŠ¥í•œ Asset ìƒì„±...');
    
    List<Asset> testAssets = new List<Asset>{
        // ê¸´ê¸‰ ê³ ì•¡ Asset (ì–´ì œ ì„¤ì¹˜ = 1ì¼ ê²½ê³¼)
        new Asset(
            Name = 'ê¸´ê¸‰ ERP ì‹œìŠ¤í…œ',
            AccountId = testAccounts[0].Id,
            Status = 'Installed',
            Price = 50000000, // 5ì²œë§Œì›
            InstallDate = Date.today().addDays(-1), // ì–´ì œ ì„¤ì¹˜
            UsageEndDate = Date.today().addDays(30) // 30ì¼ í›„ ë§Œë£Œ
        ),
        
        // ì¤‘ìš” ì¤‘ì•¡ Asset (2ì¼ ì „ ì„¤ì¹˜)
        new Asset(
            Name = 'CRM í”Œë«í¼',
            AccountId = testAccounts[1].Id,
            Status = 'Installed',
            Price = 20000000, // 2ì²œë§Œì›
            InstallDate = Date.today().addDays(-2), // 2ì¼ ì „ ì„¤ì¹˜
            UsageEndDate = Date.today().addDays(60) // 60ì¼ í›„ ë§Œë£Œ
        ),
        
        // ì¼ë°˜ ì†Œì•¡ Asset (3ì¼ ì „ ì„¤ì¹˜)
        new Asset(
            Name = 'ë³´ì•ˆ ì†”ë£¨ì…˜',
            AccountId = testAccounts[2].Id,
            Status = 'Installed',
            Price = 8000000, // 8ë°±ë§Œì›
            InstallDate = Date.today().addDays(-3), // 3ì¼ ì „ ì„¤ì¹˜
            UsageEndDate = Date.today().addDays(90) // 90ì¼ í›„ ë§Œë£Œ
        ),
        
        // ìœ„í—˜ ê³ ê° Asset (1ì£¼ì¼ ì „ ì„¤ì¹˜)
        new Asset(
            Name = 'ê¸°ë³¸ ì—…ë¬´ ì‹œìŠ¤í…œ',
            AccountId = testAccounts[3].Id,
            Status = 'Installed',
            Price = 5000000, // 5ë°±ë§Œì›
            InstallDate = Date.today().addDays(-7), // 1ì£¼ì¼ ì „ ì„¤ì¹˜
            UsageEndDate = Date.today().addDays(45) // 45ì¼ í›„ ë§Œë£Œ
        )
    };
    insert testAssets;
    System.debug('âœ… Asset ìƒì„±: ' + testAssets.size() + 'ê°œ');
    
    // 4. ì›”ê°„ ì„±ê³¼ìš© Opportunity ìƒì„±
    System.debug('ğŸ’° ì„±ê³¼ ë¶„ì„ìš© Opportunity ìƒì„±...');
    
    List<Opportunity> testOpps = new List<Opportunity>{
        // ì™„ë£Œëœ ê°±ì‹  (ì´ë²ˆ ë‹¬)
        new Opportunity(
            Name = 'ê¸´ê¸‰ê³ ê° - ì™„ë£Œëœ ê°±ì‹ ',
            AccountId = testAccounts[0].Id,
            StageName = 'Closed Won',
            CloseDate = Date.today().addDays(-3),
            Amount = 30000000, // 3ì²œë§Œì›
            Type = 'Renewal'
        ),
        
        // ì§„í–‰ ì¤‘ì¸ ê°±ì‹ 
        new Opportunity(
            Name = 'ì¤‘ìš”ê³ ê° - ì§„í–‰ì¤‘ ê°±ì‹ ',
            AccountId = testAccounts[1].Id,
            StageName = 'Prospecting',
            CloseDate = Date.today().addDays(15),
            Amount = 25000000, // 2ì²œ500ë§Œì›
            Type = 'Renewal'
        ),
        
        // ì¶”ê°€ ì™„ë£Œëœ ê°±ì‹  (ì‹¤ë²„ ë ˆë²¨ ë‹¬ì„±ìš©)
        new Opportunity(
            Name = 'ì¼ë°˜ê³ ê° - ì¶”ê°€ ì™„ë£Œ',
            AccountId = testAccounts[2].Id,
            StageName = 'Closed Won',
            CloseDate = Date.today().addDays(-5),
            Amount = 15000000, // 1ì²œ500ë§Œì›
            Type = 'Renewal'
        )
    };
    insert testOpps;
    System.debug('âœ… Opportunity ìƒì„±: ' + testOpps.size() + 'ê°œ');
    
    // 5. ê³ ê° ê±´ê°•ë„ìš© Case ìƒì„±
    System.debug('ğŸ¥ ê³ ê° ê±´ê°•ë„ ë¶„ì„ìš© Case ìƒì„±...');
    
    List<Case> testCases = new List<Case>{
        // ìœ„í—˜ ê³ ê°ìš© Case (2ê°œë¡œ ìœ„í—˜ ë¶„ë¥˜)
        new Case(
            AccountId = testAccounts[3].Id,
            Subject = 'ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë°œìƒ',
            Status = 'New',
            Priority = 'High'
        ),
        new Case(
            AccountId = testAccounts[3].Id,
            Subject = 'ì„±ëŠ¥ ì €í•˜ ë¬¸ì˜',
            Status = 'Working',
            Priority = 'Medium'
        )
    };
    insert testCases;
    System.debug('âœ… Case ìƒì„±: ' + testCases.size() + 'ê°œ');
    
    // 6. ìµœì¢… ê²€ì¦
    System.debug('');
    System.debug('ğŸ“Š === ìµœì¢… ë°ì´í„° ê²€ì¦ ===');
    
    // Asset ê²€ì¦ (1ì¼ ì¡°ê±´ ë§Œì¡± ì—¬ë¶€)
    List<Asset> verifyAssets = [
        SELECT Id, Name, AccountId, Account.Name, Price, InstallDate, UsageEndDate, Status
        FROM Asset 
        WHERE Status = 'Installed'
        AND InstallDate <= :Date.today().addDays(-1) // 1ì¼ ì¡°ê±´
        ORDER BY Price DESC
    ];
    
    System.debug('âœ… 1ì¼ ì¡°ê±´ ë§Œì¡± Asset: ' + verifyAssets.size() + 'ê°œ');
    for(Asset a : verifyAssets) {
        Integer daysFromInstall = a.InstallDate.daysBetween(Date.today());
        System.debug('  - ' + a.Name + ': ' + daysFromInstall + 'ì¼ ê²½ê³¼, ê°€ê²©: ' + a.Price);
    }
    
    // Opportunity ê²€ì¦ (ì›”ê°„ ì„±ê³¼)
    Date thisMonth = Date.today().toStartOfMonth();
    Integer completedCount = [SELECT COUNT() FROM Opportunity WHERE StageName = 'Closed Won' AND CloseDate >= :thisMonth AND CloseDate <= :Date.today()];
    Integer inProgressCount = [SELECT COUNT() FROM Opportunity WHERE StageName != 'Closed Won' AND StageName != 'Closed Lost' AND CloseDate >= :Date.today()];
    
    System.debug('âœ… ì´ë²ˆ ë‹¬ ì™„ë£Œëœ ê°±ì‹ : ' + completedCount + 'ê±´');
    System.debug('âœ… ì§„í–‰ ì¤‘ì¸ ê°±ì‹ : ' + inProgressCount + 'ê±´');
    
    // ì´í•© ê³„ì‚°
    AggregateResult[] completedResults = [
        SELECT SUM(Amount) sumAmount 
        FROM Opportunity 
        WHERE StageName = 'Closed Won' 
        AND CloseDate >= :thisMonth 
        AND CloseDate <= :Date.today()
    ];
    
    Decimal completedAmount = (Decimal)completedResults[0].get('sumAmount');
    System.debug('âœ… ì™„ë£Œëœ ê°±ì‹  ì´ì•¡: ' + completedAmount);
    
} catch(Exception e) {
    System.debug('âŒ ë°ì´í„° ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('âŒ íƒ€ì…: ' + e.getTypeName());
    System.debug('âŒ ë¼ì¸: ' + e.getLineNumber());
    System.debug('âŒ ìŠ¤íƒ: ' + e.getStackTraceString());
}

System.debug('');
System.debug('ğŸ¯ === ì˜ˆìƒ ëŒ€ì‹œë³´ë“œ ê²°ê³¼ (ìˆ˜ì • í›„) ===');
System.debug('ğŸ’° ì˜¤ëŠ˜ ì˜ˆìƒ ë§¤ì¶œ: ì•½ 7,440ë§Œì›');
System.debug('  ğŸ”¥ ê¸´ê¸‰ê³ ê°: 4,500ë§Œì› (5,000ë§Œì› Ã— 90%)');
System.debug('  âš ï¸ ì¤‘ìš”ê³ ê°: 1,800ë§Œì› (2,000ë§Œì› Ã— 90%)');
System.debug('  ğŸ“‹ ì¼ë°˜ê³ ê°: 720ë§Œì› (800ë§Œì› Ã— 90%)');
System.debug('  ğŸ“‹ ìœ„í—˜ê³ ê°: 420ë§Œì› (500ë§Œì› Ã— 84%)');
System.debug('ğŸ¯ ì›”ê°„ ì™„ë£Œ: 3ê±´, 4,500ë§Œì›');
System.debug('ğŸ¯ ì›”ê°„ ì§„í–‰: 1ê±´, 2,500ë§Œì›');
System.debug('ğŸ¥ ê±´ê°•ë„: ê±´ê°• 75%, ìœ„í—˜ 25%');
System.debug('ğŸ† ì‹¤ë²„ ë ˆë²¨ ë‹¬ì„±! (4,500ë§Œì›)');
System.debug('');
System.debug('ğŸš€ === ì¦‰ì‹œ ê°±ì‹  ê°€ëŠ¥í•œ ë°ì´í„° ìƒì„± ì™„ë£Œ ===');
System.debug('ğŸ’¡ ì´ì œ ìˆ˜ì •ëœ í´ë˜ìŠ¤ë¥¼ ë°°í¬í•˜ê³  ëŒ€ì‹œë³´ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”!');
