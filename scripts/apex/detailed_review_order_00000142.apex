// Order 00000142 ë‹¨ê³„ë³„ ìë™í™” ì‹œìŠ¤í…œ ê²€í† 
System.debug('ğŸ” =====Order 00000142 ë‹¨ê³„ë³„ ìë™í™” ê²€í† =====');

try {
    // 1. ê¸°ë³¸ Order ì •ë³´ í™•ì¸
    List<Order> orders = [
        SELECT Id, OrderNumber, Account.Name, TotalAmount, Status, EffectiveDate,
               Payment_Method__c, CreatedDate, LastModifiedDate,
               Slack_Channel_ID__c, Slack_Channel_Name__c, Slack_Notification_Status__c,
               (SELECT Id, Product2.Name, Product2.ProductCode, Quantity, 
                       UnitPrice, TotalPrice FROM OrderItems)
        FROM Order 
        WHERE OrderNumber = '00000142'
        LIMIT 1
    ];
    
    if (orders.isEmpty()) {
        System.debug('âŒ Order 00000142ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    Order targetOrder = orders[0];
    
    System.debug('ğŸ“‹ STEP 1: ê¸°ë³¸ Order ì •ë³´ ê²€í† ');
    System.debug('   Order Number: ' + targetOrder.OrderNumber);
    System.debug('   Customer: ' + targetOrder.Account.Name);
    System.debug('   Status: ' + targetOrder.Status + ' âœ…');
    System.debug('   Amount: â‚©' + targetOrder.TotalAmount.format() + ' âœ…');
    System.debug('   Payment Method: ' + targetOrder.Payment_Method__c + ' (ë¶„ê¸°ë³„) âœ…');
    System.debug('   Created: ' + targetOrder.CreatedDate.format());
    System.debug('   Last Modified: ' + targetOrder.LastModifiedDate.format());
    
    // 2. Order Products ê²€í† 
    System.debug('');
    System.debug('ğŸ›’ STEP 2: Order Products ê²€í† ');
    System.debug('   ì´ Products: ' + targetOrder.OrderItems.size() + 'ê°œ');
    
    if (targetOrder.OrderItems.size() > 0) {
        System.debug('   âœ… Order Products ì¡´ì¬í•¨');
        for (OrderItem item : targetOrder.OrderItems) {
            System.debug('   â€¢ ' + item.Product2.Name + ' (' + item.Product2.ProductCode + ')');
            System.debug('     Quantity: ' + item.Quantity + ', Unit Price: â‚©' + item.UnitPrice.format());
            System.debug('     Total: â‚©' + item.TotalPrice.format());
        }
    } else {
        System.debug('   âŒ Order Products ì—†ìŒ');
    }
    
    // 3. PaymentStatus ìë™ ìƒì„± ê²€í† 
    System.debug('');
    System.debug('ğŸ’° STEP 3: PaymentStatus ìë™ ìƒì„± ê²€í† ');
    List<PaymentStatus__c> paymentStatuses = [
        SELECT Id, InstallmentNumber__c, Amount__c, DueDate__c, Status__c
        FROM PaymentStatus__c 
        WHERE Order__c = :targetOrder.Id
        ORDER BY InstallmentNumber__c ASC
    ];
    
    System.debug('   ì´ PaymentStatus: ' + paymentStatuses.size() + 'ê°œ');
    
    Boolean paymentScheduleCorrect = true;
    Decimal expectedAmount = targetOrder.TotalAmount / 4; // ë¶„ê¸°ë³„ì´ë¯€ë¡œ 4ë¶„í• 
    
    for (PaymentStatus__c payment : paymentStatuses) {
        String statusIcon = payment.Status__c == 'ë¯¸ë‚©' ? 'â³' : 'âœ…';
        System.debug('   ' + statusIcon + ' ' + payment.InstallmentNumber__c + 'ì°¨: â‚©' + payment.Amount__c.format() + 
                     ' (ì˜ˆì •ì¼: ' + payment.DueDate__c.format() + ', ìƒíƒœ: ' + payment.Status__c + ')');
        
        // ê¸ˆì•¡ ê²€ì¦
        if (Math.abs(payment.Amount__c - expectedAmount) > 1) {
            paymentScheduleCorrect = false;
        }
    }
    
    if (paymentStatuses.size() == 4 && paymentScheduleCorrect) {
        System.debug('   âœ… PaymentStatus ìë™ ìƒì„±: ì •ìƒ (ë¶„ê¸°ë³„ 4íšŒ, ê° â‚©' + expectedAmount.format() + ')');
    } else {
        System.debug('   âŒ PaymentStatus ìë™ ìƒì„±: ë¬¸ì œ ìˆìŒ');
    }
    
    // 4. Slack ì±„ë„ ì •ë³´ ê²€í† 
    System.debug('');
    System.debug('ğŸ’¬ STEP 4: Slack ì±„ë„ ì •ë³´ ê²€í† ');
    System.debug('   Slack Channel ID: ' + (String.isBlank(targetOrder.Slack_Channel_ID__c) ? 'ì—†ìŒ' : targetOrder.Slack_Channel_ID__c));
    System.debug('   Slack Channel Name: ' + (String.isBlank(targetOrder.Slack_Channel_Name__c) ? 'ì—†ìŒ' : targetOrder.Slack_Channel_Name__c));
    System.debug('   Slack Notification Status: ' + (String.isBlank(targetOrder.Slack_Notification_Status__c) ? 'Not Created' : targetOrder.Slack_Notification_Status__c));
    
    // í™”ë©´ì—ì„œ ë³´ì´ëŠ” ì •ë³´ì™€ ë¹„êµ
    Boolean slackChannelIdExists = String.isNotBlank(targetOrder.Slack_Channel_ID__c);
    Boolean slackChannelNameExists = String.isNotBlank(targetOrder.Slack_Channel_Name__c);
    String slackStatus = targetOrder.Slack_Notification_Status__c;
    
    if (slackChannelIdExists && slackChannelNameExists) {
        if (slackStatus == 'Created') {
            System.debug('   âœ… Slack ì±„ë„: ì™„ì „íˆ ìƒì„±ë¨');
        } else if (slackStatus == 'Not Created') {
            System.debug('   âš ï¸ Slack ì±„ë„: ì •ë³´ëŠ” ìˆì§€ë§Œ Statusê°€ "Not Created" (ë¶ˆì¼ì¹˜)');
        } else {
            System.debug('   ğŸ”„ Slack ì±„ë„: ì²˜ë¦¬ ì¤‘');
        }
    } else if (slackChannelNameExists) {
        System.debug('   âš ï¸ Slack ì±„ë„: ì´ë¦„ë§Œ ìˆìŒ (ID ëˆ„ë½)');
    } else {
        System.debug('   âŒ Slack ì±„ë„: ìƒì„±ë˜ì§€ ì•ŠìŒ');
    }
    
    // 5. PDF íŒŒì¼ ìƒì„± ê²€í† 
    System.debug('');
    System.debug('ğŸ“„ STEP 5: PDF íŒŒì¼ ìƒì„± ê²€í† ');
    List<ContentDocumentLink> pdfFiles = [
        SELECT ContentDocument.Id, ContentDocument.Title, ContentDocument.FileExtension,
               ContentDocument.CreatedDate, ContentDocument.ContentSize, ContentDocument.Description
        FROM ContentDocumentLink 
        WHERE LinkedEntityId = :targetOrder.Id
        AND ContentDocument.FileExtension = 'pdf'
        ORDER BY ContentDocument.CreatedDate DESC
    ];
    
    System.debug('   ì´ PDF íŒŒì¼: ' + pdfFiles.size() + 'ê°œ');
    
    if (pdfFiles.size() == 0) {
        System.debug('   âŒ PDF íŒŒì¼: ì—†ìŒ (Notes & Attachments ë¹„ì–´ìˆìŒ)');
    } else {
        Boolean productPDFExists = false;
        Boolean paymentPDFExists = false;
        
        for (ContentDocumentLink pdf : pdfFiles) {
            String fileType = '';
            if (pdf.ContentDocument.Title.contains('Product') || pdf.ContentDocument.Title.contains('ìƒì„¸ì„œ')) {
                fileType = ' [Product ìƒì„¸ì„œ]';
                productPDFExists = true;
            } else if (pdf.ContentDocument.Title.contains('ë‚©ë¶€ì¼ì •ì„œ') || pdf.ContentDocument.Title.contains('payment')) {
                fileType = ' [ë‚©ë¶€ì¼ì •ì„œ]';
                paymentPDFExists = true;
            }
            
            System.debug('   âœ… ' + pdf.ContentDocument.Title + '.pdf' + fileType);
            System.debug('     ìƒì„±ì¼: ' + pdf.ContentDocument.CreatedDate.format() + 
                         ', í¬ê¸°: ' + (pdf.ContentDocument.ContentSize / 1024) + 'KB');
            if (String.isNotBlank(pdf.ContentDocument.Description)) {
                System.debug('     ì„¤ëª…: ' + pdf.ContentDocument.Description);
            }
        }
        
        if (productPDFExists) {
            System.debug('   âœ… Order Product ìƒì„¸ì„œ PDF: ì¡´ì¬');
        } else {
            System.debug('   âŒ Order Product ìƒì„¸ì„œ PDF: ëˆ„ë½');
        }
    }
    
    // 6. Activity Timeline ê²€í† 
    System.debug('');
    System.debug('ğŸ’¬ STEP 6: Activity Timeline (Chatter) ê²€í† ');
    List<FeedItem> chatterPosts = [
        SELECT Id, Body, CreatedDate, CreatedBy.Name, Type
        FROM FeedItem 
        WHERE ParentId = :targetOrder.Id
        ORDER BY CreatedDate DESC
        LIMIT 10
    ];
    
    System.debug('   ì´ Chatter í¬ìŠ¤íŠ¸: ' + chatterPosts.size() + 'ê°œ');
    
    if (chatterPosts.size() == 0) {
        System.debug('   âŒ Activity Timeline: ë¹„ì–´ìˆìŒ (No activities to show)');
    } else {
        Boolean automationPostExists = false;
        for (FeedItem post : chatterPosts) {
            String bodyPreview = post.Body.length() > 50 ? post.Body.substring(0, 50) + '...' : post.Body;
            System.debug('   â€¢ ' + post.CreatedDate.format() + ' by ' + post.CreatedBy.Name + ': ' + bodyPreview);
            
            if (post.Body.contains('ìë™í™”') || post.Body.contains('automation')) {
                automationPostExists = true;
            }
        }
        
        if (automationPostExists) {
            System.debug('   âœ… ìë™í™” ê´€ë ¨ í¬ìŠ¤íŠ¸: ì¡´ì¬');
        } else {
            System.debug('   âš ï¸ ìë™í™” ê´€ë ¨ í¬ìŠ¤íŠ¸: ì—†ìŒ');
        }
    }
    
    // 7. ì „ì²´ ìë™í™” ì‹œìŠ¤í…œ ìƒíƒœ í‰ê°€
    System.debug('');
    System.debug('ğŸ“Š STEP 7: ì „ì²´ ìë™í™” ì‹œìŠ¤í…œ ìƒíƒœ í‰ê°€');
    
    int successCount = 0;
    int totalChecks = 6;
    
    // ì²´í¬ 1: Order ê¸°ë³¸ ìƒíƒœ
    if (targetOrder.Status == 'Activated' && targetOrder.TotalAmount > 0) {
        System.debug('   âœ… Order ê¸°ë³¸ ìƒíƒœ: ì •ìƒ');
        successCount++;
    } else {
        System.debug('   âŒ Order ê¸°ë³¸ ìƒíƒœ: ë¬¸ì œ');
    }
    
    // ì²´í¬ 2: Order Products
    if (!targetOrder.OrderItems.isEmpty()) {
        System.debug('   âœ… Order Products: ì •ìƒ (' + targetOrder.OrderItems.size() + 'ê°œ)');
        successCount++;
    } else {
        System.debug('   âŒ Order Products: ì—†ìŒ');
    }
    
    // ì²´í¬ 3: PaymentStatus ìë™ ìƒì„±
    if (paymentStatuses.size() == 4 && paymentScheduleCorrect) {
        System.debug('   âœ… PaymentStatus ìë™ ìƒì„±: ì •ìƒ');
        successCount++;
    } else {
        System.debug('   âŒ PaymentStatus ìë™ ìƒì„±: ë¬¸ì œ');
    }
    
    // ì²´í¬ 4: Slack ì±„ë„ ì •ë³´
    if (slackChannelNameExists && slackChannelIdExists) {
        System.debug('   âœ… Slack ì±„ë„ ì •ë³´: ì •ìƒ');
        successCount++;
    } else if (slackChannelNameExists) {
        System.debug('   âš ï¸ Slack ì±„ë„ ì •ë³´: ë¶€ë¶„ ì •ìƒ (ì´ë¦„ë§Œ ìˆìŒ)');
        successCount += 0.5;
    } else {
        System.debug('   âŒ Slack ì±„ë„ ì •ë³´: ëˆ„ë½');
    }
    
    // ì²´í¬ 5: PDF íŒŒì¼ ìƒì„±
    if (pdfFiles.size() > 0) {
        System.debug('   âœ… PDF íŒŒì¼ ìƒì„±: ì •ìƒ');
        successCount++;
    } else {
        System.debug('   âŒ PDF íŒŒì¼ ìƒì„±: ëˆ„ë½');
    }
    
    // ì²´í¬ 6: Chatter ì•Œë¦¼
    if (chatterPosts.size() > 0) {
        System.debug('   âœ… Chatter ì•Œë¦¼: ì •ìƒ');
        successCount++;
    } else {
        System.debug('   âŒ Chatter ì•Œë¦¼: ëˆ„ë½');
    }
    
    Double successRate = (Double)successCount / totalChecks * 100;
    System.debug('');
    System.debug('ğŸ¯ ì „ì²´ ìë™í™” ì„±ê³µë¥ : ' + successRate.intValue() + '% (' + successCount + '/' + totalChecks + ')');
    
    // 8. í˜„ì¬ ìƒíƒœ ê¸°ë°˜ ì§„ë‹¨
    System.debug('');
    System.debug('ğŸ”¬ STEP 8: í˜„ì¬ ìƒíƒœ ê¸°ë°˜ ì§„ë‹¨');
    
    if (slackChannelIdExists && slackChannelNameExists && pdfFiles.size() == 0 && chatterPosts.size() == 0) {
        System.debug('   ğŸ“ ì§„ë‹¨: Slack ì •ë³´ëŠ” ì—…ë°ì´íŠ¸ë˜ì—ˆì§€ë§Œ PDFì™€ ChatterëŠ” ëˆ„ë½');
        System.debug('   ğŸ’¡ ì¶”ì •: ìë™í™” ì‹œìŠ¤í…œì´ ë¶€ë¶„ì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìœ¼ë‚˜ ì™„ë£Œë˜ì§€ ì•ŠìŒ');
        System.debug('   ğŸ”§ í•´ê²°: ìˆ˜ë™ ì™„ë£Œ ì‹¤í–‰ í•„ìš”');
    } else if (successRate >= 80) {
        System.debug('   ğŸ“ ì§„ë‹¨: ìë™í™” ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™');
    } else if (successRate >= 60) {
        System.debug('   ğŸ“ ì§„ë‹¨: ìë™í™” ì‹œìŠ¤í…œ ë¶€ë¶„ ì‘ë™');
    } else {
        System.debug('   ğŸ“ ì§„ë‹¨: ìë™í™” ì‹œìŠ¤í…œ ë¬¸ì œ ìˆìŒ');
    }
    
    // 9. ì¦‰ì‹œ ì¡°ì¹˜ ë°©ì•ˆ
    System.debug('');
    System.debug('âš¡ STEP 9: ì¦‰ì‹œ ì¡°ì¹˜ ë°©ì•ˆ');
    
    if (pdfFiles.size() == 0) {
        System.debug('   ğŸ”§ PDF ìƒì„± í•„ìš”: scripts/apex/execute_order_00000142_automation.apex ì‹¤í–‰');
    }
    
    if (chatterPosts.size() == 0) {
        System.debug('   ğŸ”§ Chatter ì•Œë¦¼ í•„ìš”: ìˆ˜ë™ í¬ìŠ¤íŠ¸ ìƒì„± ë˜ëŠ” ìë™í™” ì¬ì‹¤í–‰');
    }
    
    if (targetOrder.Slack_Notification_Status__c == 'Not Created' && slackChannelNameExists) {
        System.debug('   ğŸ”§ Slack Status ì—…ë°ì´íŠ¸ í•„ìš”: Statusë¥¼ "Created"ë¡œ ë³€ê²½');
    }
    
    System.debug('');
    System.debug('âœ… =====Order 00000142 ë‹¨ê³„ë³„ ê²€í†  ì™„ë£Œ=====');
    
} catch (Exception e) {
    System.debug('âŒ ê²€í†  ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}
