// ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ìŠ¤í¬ë¦½íŠ¸ - ì •ê¸°ì ìœ¼ë¡œ ì‹¤í–‰í•˜ì—¬ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸

System.debug('=== ì•Œë¦¼ ì‹œìŠ¤í…œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ===');

// 1. ì˜¤ëŠ˜ ìƒì„±ëœ ì•Œë¦¼ í†µê³„
Date today = Date.today();
List<AggregateResult> todayStats = [
    SELECT NotificationType__c, NotificationChannel__c, NotificationStatus__c,
           COUNT(Id) cnt
    FROM Payment_Notification__c 
    WHERE CreatedDate = TODAY
    GROUP BY NotificationType__c, NotificationChannel__c, NotificationStatus__c
];

System.debug('ğŸ“Š ì˜¤ëŠ˜ ì•Œë¦¼ í†µê³„:');
for (AggregateResult stat : todayStats) {
    System.debug(String.format('  {0} | {1} | {2}: {3}ê±´', 
        new List<String>{
            String.valueOf(stat.get('NotificationType__c')),
            String.valueOf(stat.get('NotificationChannel__c')),
            String.valueOf(stat.get('NotificationStatus__c')),
            String.valueOf(stat.get('cnt'))
        }));
}

// 2. ëŒ€ê¸° ì¤‘ì¸ ì•Œë¦¼ ìˆ˜
Integer pendingCount = [
    SELECT COUNT() 
    FROM Payment_Notification__c 
    WHERE NotificationStatus__c = 'Pending'
    AND ScheduledDateTime__c <= :DateTime.now()
];
System.debug('â³ ì²˜ë¦¬ ëŒ€ê¸° ì¤‘ì¸ ì•Œë¦¼: ' + pendingCount + 'ê±´');

// 3. ì‹¤íŒ¨í•œ ì•Œë¦¼ ìˆ˜
Integer failedCount = [
    SELECT COUNT() 
    FROM Payment_Notification__c 
    WHERE NotificationStatus__c = 'Failed'
    AND CreatedDate = TODAY
];
System.debug('âŒ ì˜¤ëŠ˜ ì‹¤íŒ¨í•œ ì•Œë¦¼: ' + failedCount + 'ê±´');

// 4. ì„±ê³µë¥  ê³„ì‚°
Integer totalSent = [
    SELECT COUNT() 
    FROM Payment_Notification__c 
    WHERE SentDateTime__c != null
    AND CreatedDate = TODAY
];

Integer successfulSent = [
    SELECT COUNT() 
    FROM Payment_Notification__c 
    WHERE NotificationStatus__c = 'Sent'
    AND CreatedDate = TODAY
];

if (totalSent > 0) {
    Decimal successRate = (Decimal.valueOf(successfulSent) / Decimal.valueOf(totalSent)) * 100;
    System.debug('âœ… ì˜¤ëŠ˜ ì„±ê³µë¥ : ' + successRate.setScale(1) + '%');
} else {
    System.debug('ğŸ“Š ì˜¤ëŠ˜ ë°œì†¡ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.');
}

// 5. ë‹¤ìŒ ìŠ¤ì¼€ì¤„ëœ ì‘ì—… í™•ì¸
List<CronTrigger> nextJobs = [
    SELECT CronJobDetail.Name, NextFireTime
    FROM CronTrigger 
    WHERE CronJobDetail.Name LIKE '%Payment%'
    AND State = 'WAITING'
    ORDER BY NextFireTime ASC
    LIMIT 3
];

System.debug('â° ë‹¤ìŒ ì˜ˆì •ëœ ì‘ì—…:');
for (CronTrigger job : nextJobs) {
    System.debug('  ' + job.CronJobDetail.Name + ': ' + job.NextFireTime);
}

System.debug('=== ëª¨ë‹ˆí„°ë§ ì™„ë£Œ ===');
