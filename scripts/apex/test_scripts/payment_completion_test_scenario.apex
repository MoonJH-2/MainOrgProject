/**
 * ì™„ë‚© ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
 * Developer Console > Debug > Open Execute Anonymous Windowì—ì„œ ì‹¤í–‰
 * 
 * í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤:
 * 1. íŠ¹ì • Orderì˜ í˜„ì¬ ë‚©ë¶€ ìƒíƒœ í™•ì¸
 * 2. ëª¨ë“  PaymentStatusë¥¼ ì™„ë‚©ìœ¼ë¡œ ë³€ê²½
 * 3. ë‚©ë¶€ ì¼ì • íƒ€ì„ë¼ì¸ ìë™ ì™„ë‚© ìƒíƒœ ë°˜ì˜ í™•ì¸
 * 4. ë‚©ë¶€í™•ì¸ì„œ + ì„¸ê¸ˆê³„ì‚°ì„œ PDF ìƒì„± í…ŒìŠ¤íŠ¸
 */

System.debug('ğŸ¯ =====ì™„ë‚© ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘=====');

try {
    // 1. í…ŒìŠ¤íŠ¸í•  Order ì„ íƒ (ê°€ì¥ ìµœê·¼ì˜ PaymentStatusê°€ ìˆëŠ” Order)
    List<Order> testOrders = [
        SELECT Id, OrderNumber, TotalAmount, Account.Name,
               (SELECT Id FROM PaymentStatus__c WHERE Status__c != 'ì™„ë‚©' LIMIT 1)
        FROM Order 
        WHERE Id IN (SELECT Order__c FROM PaymentStatus__c WHERE Status__c != 'ì™„ë‚©')
        ORDER BY CreatedDate DESC
        LIMIT 1
    ];
    
    if (testOrders.isEmpty()) {
        System.debug('âŒ ë¯¸ë‚© ìƒíƒœì˜ PaymentStatusê°€ ìˆëŠ” Orderë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        System.debug('ğŸ“ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }
    
    Order testOrder = testOrders[0];
    System.debug('ğŸ“‹ í…ŒìŠ¤íŠ¸ ëŒ€ìƒ Order: ' + testOrder.OrderNumber);
    System.debug('   ê³ ê°ëª…: ' + testOrder.Account.Name);
    System.debug('   ì£¼ë¬¸ ê¸ˆì•¡: â‚©' + testOrder.TotalAmount?.format());
    
    // 2. ì™„ë‚© ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    String testResult = PaymentCompletionTestService.executePaymentCompletionTest(testOrder.Id);
    
    // 3. ê²°ê³¼ ì¶œë ¥
    System.debug('');
    System.debug(testResult);
    
    // 4. ì¶”ê°€ ê²€ì¦: íƒ€ì„ë¼ì¸ ë°ì´í„° í™•ì¸
    System.debug('');
    System.debug('ğŸ” =====íƒ€ì„ë¼ì¸ ë°ì´í„° ìµœì¢… ê²€ì¦=====');
    
    PaymentStatusTimelineController.PaymentTimelineWrapper timelineData = 
        PaymentStatusTimelineController.getPaymentTimeline(testOrder.Id);
    
    System.debug('íƒ€ì„ë¼ì¸ ì§„í–‰ë¥ : ' + timelineData.progressPercentage + '%');
    System.debug('ì™„ë‚© í•­ëª©: ' + timelineData.completedInstallments + '/' + timelineData.totalInstallments);
    System.debug('ì—°ì²´ í•­ëª©: ' + timelineData.overdueInstallments + 'ê°œ');
    
    if (timelineData.progressPercentage == 100) {
        System.debug('âœ… íƒ€ì„ë¼ì¸ì—ì„œ 100% ì™„ë‚© ìƒíƒœ í™•ì¸ë¨');
    } else {
        System.debug('âš ï¸ íƒ€ì„ë¼ì¸ ì™„ë‚©ë¥ : ' + timelineData.progressPercentage + '%');
    }
    
    // 5. ìƒì„±ëœ PDF íŒŒì¼ í™•ì¸
    System.debug('');
    System.debug('ğŸ“„ =====ìƒì„±ëœ PDF íŒŒì¼ í™•ì¸=====');
    List<ContentVersion> todayPDFs = [
        SELECT Id, Title, ContentSize, CreatedDate
        FROM ContentVersion
        WHERE FirstPublishLocationId = :testOrder.Id
        AND CreatedDate = TODAY
        ORDER BY CreatedDate DESC
    ];
    
    if (todayPDFs.isEmpty()) {
        System.debug('âš ï¸ ì˜¤ëŠ˜ ìƒì„±ëœ PDF íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
    } else {
        System.debug('ğŸ“„ ì˜¤ëŠ˜ ìƒì„±ëœ PDF íŒŒì¼: ' + todayPDFs.size() + 'ê°œ');
        
        Integer paymentPdfCount = 0;
        Integer taxPdfCount = 0;
        
        for (ContentVersion pdf : todayPDFs) {
            String fileType = '';
            if (pdf.Title.contains('ë‚©ë¶€í™•ì¸ì„œ')) {
                fileType = '[ë‚©ë¶€í™•ì¸ì„œ]';
                paymentPdfCount++;
            } else if (pdf.Title.contains('ì„¸ê¸ˆê³„ì‚°ì„œ')) {
                fileType = '[ì„¸ê¸ˆê³„ì‚°ì„œ]';
                taxPdfCount++;
            }
            
            System.debug('   â€¢ ' + pdf.Title + ' ' + fileType);
            System.debug('     í¬ê¸°: ' + (pdf.ContentSize/1024) + 'KB, ìƒì„±: ' + pdf.CreatedDate.format());
        }
        
        // PDF ìƒì„± ê²°ê³¼ ê²€ì¦
        if (paymentPdfCount > 0 && taxPdfCount > 0) {
            System.debug('âœ… ë‚©ë¶€í™•ì¸ì„œ + ì„¸ê¸ˆê³„ì‚°ì„œ ëª¨ë‘ ìƒì„±ë¨');
        } else if (paymentPdfCount > 0) {
            System.debug('âš ï¸ ë‚©ë¶€í™•ì¸ì„œë§Œ ìƒì„±ë¨ (ì„¸ê¸ˆê³„ì‚°ì„œ ëˆ„ë½)');
        } else {
            System.debug('âŒ PDF ìƒì„± ì‹¤íŒ¨');
        }
    }
    
    System.debug('');
    System.debug('ğŸ¯ =====ì™„ë‚© ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì™„ë£Œ=====');
    System.debug('');
    System.debug('ğŸ“‹ í™•ì¸ì‚¬í•­:');
    System.debug('1. Order ' + testOrder.OrderNumber + ' í˜ì´ì§€ì—ì„œ ë‚©ë¶€ ì¼ì • íƒ€ì„ë¼ì¸ í™•ì¸');
    System.debug('2. Files ì„¹ì…˜ì—ì„œ ë‚©ë¶€í™•ì¸ì„œ + ì„¸ê¸ˆê³„ì‚°ì„œ PDF ë‹¤ìš´ë¡œë“œ í™•ì¸');
    System.debug('3. Activity Timelineì—ì„œ ì™„ë‚© Task ìƒì„± í™•ì¸');
    
} catch (Exception e) {
    System.debug('âŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}

System.debug('ğŸ¯ =====ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì™„ë£Œ=====');
