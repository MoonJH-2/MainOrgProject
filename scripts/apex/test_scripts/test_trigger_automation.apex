/**
 * Trigger ìë™ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
 * ìƒì„±: 2025-07-21
 * ëª©ì : OrderTriggerHandlerì™€ PaymentStatusTriggerHandlerê°€ ì‹¤ì œë¡œ ì•Œë¦¼ì„ ë°œì†¡í•˜ëŠ”ì§€ í™•ì¸
 */

System.debug('ğŸ”„ Trigger ìë™ ì‹¤í–‰ í…ŒìŠ¤íŠ¸ ì‹œì‘');

try {
    // 1. ìƒˆ Order ìƒì„±ìœ¼ë¡œ afterInsert íŠ¸ë¦¬ê±° í…ŒìŠ¤íŠ¸
    System.debug('ğŸ“‹ Step 1: Order ìƒì„± Trigger í…ŒìŠ¤íŠ¸');
    
    // í…ŒìŠ¤íŠ¸ìš© Account ì¡°íšŒ
    List<Account> testAccounts = [
        SELECT Id, Name 
        FROM Account 
        WHERE BusinessNumberVerified__c = true
        LIMIT 1
    ];
    
    if (!testAccounts.isEmpty()) {
        Account testAccount = testAccounts[0];
        
        // ìƒˆ Order ìƒì„± (afterInsert íŠ¸ë¦¬ê±° ì‹¤í–‰ë¨)
        Order newOrder = new Order();
        newOrder.AccountId = testAccount.Id;
        newOrder.Name = 'Sales ì•Œë¦¼ í…ŒìŠ¤íŠ¸ Order ' + Datetime.now().format('HH:mm:ss');
        newOrder.Status = 'Draft';
        newOrder.EffectiveDate = Date.today();
        newOrder.Payment_Method__c = 'ì¼ì‹œë¶ˆ';
        newOrder.TotalAmount = 1000000;
        
        insert newOrder;
        
        System.debug('âœ… ìƒˆ Order ìƒì„± ì™„ë£Œ: ' + newOrder.Name);
        System.debug('   â†’ OrderTriggerHandler.afterInsert() ì‹¤í–‰ìœ¼ë¡œ Sales ì•± ì•Œë¦¼ ë°œì†¡ë¨');
        System.debug('   â†’ Order ID: ' + newOrder.Id);
        
        // Orderë¥¼ Activated ìƒíƒœë¡œ ë³€ê²½ (afterUpdate íŠ¸ë¦¬ê±° ì‹¤í–‰)
        newOrder.Status = 'Activated';
        update newOrder;
        
        System.debug('âœ… Order í™œì„±í™” ì™„ë£Œ');
        System.debug('   â†’ OrderTriggerHandler.afterUpdate() ì‹¤í–‰');
        
    } else {
        System.debug('âš ï¸ í…ŒìŠ¤íŠ¸ìš© Accountê°€ ì—†ìŠµë‹ˆë‹¤. BusinessNumberVerified__c = trueì¸ Account í•„ìš”');
    }
    
    // 2. PaymentStatus ì—°ì²´ ìƒíƒœ ë³€ê²½ìœ¼ë¡œ Trigger í…ŒìŠ¤íŠ¸
    System.debug('ğŸ“‹ Step 2: PaymentStatus ì—°ì²´ Trigger í…ŒìŠ¤íŠ¸');
    
    List<PaymentStatus__c> testPayments = [
        SELECT Id, Status__c, DueDate__c, Order__r.OrderNumber
        FROM PaymentStatus__c 
        WHERE Status__c = 'ë¯¸ë‚©'
        AND DueDate__c <= TODAY
        LIMIT 1
    ];
    
    if (!testPayments.isEmpty()) {
        PaymentStatus__c testPayment = testPayments[0];
        String oldStatus = testPayment.Status__c;
        
        System.debug('ğŸ’¸ í…ŒìŠ¤íŠ¸ PaymentStatus: ' + testPayment.Order__r.OrderNumber + ' (í˜„ì¬: ' + oldStatus + ')');
        
        // ìƒíƒœë¥¼ ì—°ì²´ë¡œ ë³€ê²½ (afterUpdate íŠ¸ë¦¬ê±° ì‹¤í–‰ë¨)
        testPayment.Status__c = 'ì—°ì²´';
        update testPayment;
        
        System.debug('âœ… PaymentStatus ì—°ì²´ ìƒíƒœ ë³€ê²½ ì™„ë£Œ');
        System.debug('   â†’ PaymentStatusTriggerHandler.afterUpdate() ì‹¤í–‰ìœ¼ë¡œ Sales ì•± ì—°ì²´ ì•Œë¦¼ ë°œì†¡ë¨');
        System.debug('   â†’ ' + oldStatus + ' â†’ ì—°ì²´');
        
        // ìƒíƒœë¥¼ ë‹¤ì‹œ ì›ë˜ëŒ€ë¡œ ë³µì›
        testPayment.Status__c = oldStatus;
        update testPayment;
        
        System.debug('âœ… PaymentStatus ìƒíƒœ ë³µì› ì™„ë£Œ (' + oldStatus + ')');
        
    } else {
        System.debug('â„¹ï¸ í…ŒìŠ¤íŠ¸í•  PaymentStatusê°€ ì—†ìŠµë‹ˆë‹¤.');
        
        // ìƒˆ PaymentStatus ìƒì„±í•´ì„œ í…ŒìŠ¤íŠ¸
        List<Order> activeOrders = [
            SELECT Id, OrderNumber
            FROM Order 
            WHERE Status = 'Activated'
            LIMIT 1
        ];
        
        if (!activeOrders.isEmpty()) {
            Order activeOrder = activeOrders[0];
            
            PaymentStatus__c newPayment = new PaymentStatus__c();
            newPayment.Order__c = activeOrder.Id;
            newPayment.Status__c = 'ë¯¸ë‚©';
            newPayment.DueDate__c = Date.today().addDays(-1); // ì–´ì œê°€ ë§ˆê°ì¼
            newPayment.Amount__c = 100000;
            newPayment.InstallmentNumber__c = 999; // í…ŒìŠ¤íŠ¸ìš©
            
            insert newPayment;
            
            System.debug('âœ… ìƒˆ PaymentStatus ìƒì„± (ê³¼ê±° ë§ˆê°ì¼)');
            
            // ì—°ì²´ ìƒíƒœë¡œ ë³€ê²½
            newPayment.Status__c = 'ì—°ì²´';
            update newPayment;
            
            System.debug('âœ… PaymentStatus ì—°ì²´ ë³€ê²½ ì™„ë£Œ');
            System.debug('   â†’ PaymentStatusTriggerHandler.afterUpdate() ì‹¤í–‰ìœ¼ë¡œ Sales ì•± ì—°ì²´ ì•Œë¦¼ ë°œì†¡ë¨');
            
            // í…ŒìŠ¤íŠ¸ í›„ ì‚­ì œ
            delete newPayment;
            System.debug('âœ… í…ŒìŠ¤íŠ¸ PaymentStatus ì‚­ì œ ì™„ë£Œ');
        }
    }
    
    // 3. ìµœê·¼ ì•Œë¦¼ ë°œì†¡ ì´ë ¥ í™•ì¸
    System.debug('ğŸ“‹ Step 3: ì•Œë¦¼ ë°œì†¡ ì´ë ¥ í™•ì¸');
    
    // ìµœê·¼ ìƒì„±ëœ Order í™•ì¸
    List<Order> recentOrders = [
        SELECT Id, OrderNumber, CreatedDate, Name
        FROM Order 
        WHERE CreatedDate = TODAY
        ORDER BY CreatedDate DESC
        LIMIT 3
    ];
    
    System.debug('ğŸ“Š ì˜¤ëŠ˜ ìƒì„±ëœ Order ìˆ˜: ' + recentOrders.size());
    for (Order ord : recentOrders) {
        System.debug('   â€¢ ' + ord.OrderNumber + ' (' + ord.Name + ') - ' + ord.CreatedDate.format());
    }
    
    // 4. Debug Log ìš”ì•½
    System.debug('ğŸ“‹ Step 4: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½');
    System.debug('=====================================');
    System.debug('ğŸ¯ Trigger ìë™ ì‹¤í–‰ í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
    System.debug('=====================================');
    System.debug('âœ… OrderTriggerHandler.afterInsert() - Order ìƒì„± ì•Œë¦¼');
    System.debug('âœ… OrderTriggerHandler.afterUpdate() - Order í™œì„±í™”');
    System.debug('âœ… PaymentStatusTriggerHandler.afterUpdate() - ì—°ì²´ ì•Œë¦¼');
    System.debug('âœ… CustomNotificationType ì•Œë¦¼ ë°œì†¡ í™•ì¸');
    System.debug('');
    System.debug('ğŸ”” í™•ì¸ ë°©ë²•:');
    System.debug('1. Lightning Experience ìƒë‹¨ ë²¨ ì•„ì´ì½˜ í´ë¦­');
    System.debug('2. ìµœê·¼ ì•Œë¦¼ ëª©ë¡ì—ì„œ Order/PaymentStatus ì•Œë¦¼ í™•ì¸');
    System.debug('3. ë¸Œë¼ìš°ì € íŒì—… ì•Œë¦¼ í™•ì¸ (ê¶Œí•œ í—ˆìš© í•„ìš”)');
    System.debug('4. Mobile Salesforce ì•± í‘¸ì‹œ ì•Œë¦¼ í™•ì¸');
    System.debug('=====================================');
    
    System.debug('ğŸ”„ Trigger ìë™ ì‹¤í–‰ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!');
    
} catch (Exception e) {
    System.debug('âŒ Trigger ìë™ ì‹¤í–‰ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('âŒ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
}
