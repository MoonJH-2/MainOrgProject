/**
 * @description Salesforce Channel ê¸°ëŠ¥ ì¢…í•© í…ŒìŠ¤íŠ¸
 * @author JH Moon
 * @created 2025-07-22
 */

System.debug('ğŸš€ =====Salesforce Channel ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹œì‘=====');

try {
    // 1. í•„ìˆ˜ ì»¤ìŠ¤í…€ í•„ë“œ í™•ì¸
    System.debug('1ï¸âƒ£ ì»¤ìŠ¤í…€ í•„ë“œ ê²€ì¦ ì¤‘...');
    OrderChannelFields.validateChannelFields();
    
    // 2. í…ŒìŠ¤íŠ¸ìš© Order ì¡°íšŒ ë˜ëŠ” ìƒì„±
    System.debug('2ï¸âƒ£ í…ŒìŠ¤íŠ¸ Order ì¤€ë¹„ ì¤‘...');
    
    List<Order> testOrders = [
        SELECT Id, OrderNumber, Account.Name, Account.OwnerId, OwnerId, Owner.Name, Owner.Email, Owner.UserRole.Name,
               TotalAmount, Payment_Method__c, Status, CreatedDate,
               Salesforce_Channel_ID__c, Salesforce_Channel_Name__c, Channel_Status__c,
               (SELECT Id, Product2.Name, Quantity FROM OrderItems)
        FROM Order 
        WHERE Status = 'Draft'
        ORDER BY CreatedDate DESC
        LIMIT 1
    ];
    
    if (testOrders.isEmpty()) {
        System.debug('âŒ í…ŒìŠ¤íŠ¸í•  Orderê°€ ì—†ìŠµë‹ˆë‹¤. Draft ìƒíƒœì˜ Orderë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    Order testOrder = testOrders[0];
    System.debug('âœ… í…ŒìŠ¤íŠ¸ Order: ' + testOrder.OrderNumber + ' (' + testOrder.Account.Name + ')');
    
    // 3. Salesforce Channel ìƒì„± í…ŒìŠ¤íŠ¸
    System.debug('3ï¸âƒ£ Salesforce Channel ìƒì„± í…ŒìŠ¤íŠ¸...');
    Boolean channelCreated = SalesforceChannelService.createOrderChannel(testOrder);
    
    if (channelCreated) {
        System.debug('âœ… Channel ìƒì„± ì„±ê³µ');
        
        // 4. ì—…ë°ì´íŠ¸ëœ Order ì •ë³´ ì¬ì¡°íšŒ
        List<Order> updatedOrders = [
            SELECT Id, Salesforce_Channel_ID__c, Salesforce_Channel_Name__c, Channel_Status__c, Channel_Created_Date__c
            FROM Order 
            WHERE Id = :testOrder.Id
        ];
        
        if (!updatedOrders.isEmpty()) {
            Order updatedOrder = updatedOrders[0];
            System.debug('ğŸ“‹ Channel ì •ë³´:');
            System.debug('   â€¢ Channel ID: ' + updatedOrder.Salesforce_Channel_ID__c);
            System.debug('   â€¢ Channel Name: ' + updatedOrder.Salesforce_Channel_Name__c);
            System.debug('   â€¢ Status: ' + updatedOrder.Channel_Status__c);
            System.debug('   â€¢ Created: ' + updatedOrder.Channel_Created_Date__c);
        }
        
    } else {
        System.debug('âŒ Channel ìƒì„± ì‹¤íŒ¨');
        return;
    }
    
    // 5. Payment Notification ìƒì„± ë° ì±„ë„ ì•Œë¦¼ í…ŒìŠ¤íŠ¸
    System.debug('4ï¸âƒ£ Payment Notification & Channel ì•Œë¦¼ í…ŒìŠ¤íŠ¸...');
    
    // í…ŒìŠ¤íŠ¸ìš© PaymentStatus ì¡°íšŒ ë˜ëŠ” ìƒì„±
    List<PaymentStatus__c> paymentStatuses = [
        SELECT Id, Order__c, Order__r.Account.Name, Order__r.OrderNumber,
               InstallmentNumber__c, Amount__c, DueDate__c, Status__c
        FROM PaymentStatus__c 
        WHERE Order__c = :testOrder.Id
        AND Status__c != 'ì™„ë‚©'
        LIMIT 1
    ];
    
    if (paymentStatuses.isEmpty()) {
        System.debug('âš ï¸ í…ŒìŠ¤íŠ¸ìš© PaymentStatusê°€ ì—†ìŠµë‹ˆë‹¤. ë”ë¯¸ ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.');
        
        // ë”ë¯¸ Payment Notification ìƒì„± (ì‹¤ì œ PaymentStatus ì—†ì´)
        Payment_Notification__c testNotification = new Payment_Notification__c();
        testNotification.NotificationType__c = 'ì˜ˆì • ì•Œë¦¼';
        testNotification.NotificationChannel__c = 'SalesforceChannel';
        testNotification.NotificationStatus__c = 'Pending';
        testNotification.ScheduledDateTime__c = DateTime.now();
        
        // PaymentStatus ì°¸ì¡° ì—†ì´ëŠ” í…ŒìŠ¤íŠ¸ ì œí•œì ì´ë¯€ë¡œ ë¡œê·¸ë§Œ ì¶œë ¥
        System.debug('ğŸ“ ë”ë¯¸ ì±„ë„ ë©”ì‹œì§€ í…ŒìŠ¤íŠ¸:');
        System.debug('   ë©”ì‹œì§€: ğŸ”” ë‚©ë¶€ ì˜ˆì • ì•Œë¦¼ - Order ' + testOrder.OrderNumber);
        
    } else {
        PaymentStatus__c paymentStatus = paymentStatuses[0];
        
        // Payment Notification ìƒì„±
        Payment_Notification__c notification = new Payment_Notification__c();
        notification.PaymentStatus__c = paymentStatus.Id;
        notification.NotificationType__c = 'ì˜ˆì • ì•Œë¦¼';
        notification.NotificationChannel__c = 'SalesforceChannel';
        notification.NotificationStatus__c = 'Pending';
        notification.ScheduledDateTime__c = DateTime.now();
        
        insert notification;
        
        // ê´€ê³„ í•„ë“œ ì¬ì¡°íšŒ
        Payment_Notification__c fullNotification = [
            SELECT Id, PaymentStatus__c, PaymentStatus__r.Order__c,
                   PaymentStatus__r.Order__r.Account.Name, PaymentStatus__r.Order__r.OrderNumber,
                   PaymentStatus__r.InstallmentNumber__c, PaymentStatus__r.Amount__c, 
                   PaymentStatus__r.DueDate__c, NotificationType__c, NotificationChannel__c
            FROM Payment_Notification__c 
            WHERE Id = :notification.Id
        ];
        
        // Salesforce Channel ì•Œë¦¼ ë°œì†¡ í…ŒìŠ¤íŠ¸
        Boolean channelNotificationSent = PaymentNotificationService.sendSalesforceChannelNotification(fullNotification);
        System.debug('ğŸ“± Channel ì•Œë¦¼ ë°œì†¡: ' + (channelNotificationSent ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'));
    }
    
    // 6. ë©”ì‹œì§€ ë°œì†¡ í…ŒìŠ¤íŠ¸
    System.debug('5ï¸âƒ£ ì§ì ‘ ë©”ì‹œì§€ ë°œì†¡ í…ŒìŠ¤íŠ¸...');
    
    // ì—…ë°ì´íŠ¸ëœ Order ì¬ì¡°íšŒ
    List<Order> finalOrders = [
        SELECT Id, Salesforce_Channel_ID__c, Salesforce_Channel_Name__c
        FROM Order 
        WHERE Id = :testOrder.Id
        AND Salesforce_Channel_ID__c != null
    ];
    
    if (!finalOrders.isEmpty()) {
        Order finalOrder = finalOrders[0];
        String testMessage = 'ğŸ§ª **í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€**\n\n';
        testMessage += 'ì´ê²ƒì€ Salesforce Channel í†µí•© í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤.\n';
        testMessage += 'â€¢ Order: ' + testOrder.OrderNumber + '\n';
        testMessage += 'â€¢ ê³ ê°: ' + testOrder.Account.Name + '\n';
        testMessage += 'â€¢ í…ŒìŠ¤íŠ¸ ì‹œê°„: ' + DateTime.now().format() + '\n\n';
        testMessage += 'âœ… Channel ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤!';
        
        Boolean messageSent = SalesforceChannelService.sendChannelMessage(
            finalOrder.Salesforce_Channel_ID__c, 
            testMessage
        );
        
        System.debug('ğŸ’¬ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ë°œì†¡: ' + (messageSent ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'));
    }
    
    // 7. ê²°ê³¼ ìš”ì•½
    System.debug('');
    System.debug('ğŸ“Š =====í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½=====');
    System.debug('âœ… Salesforce Channel ìƒì„±: ì™„ë£Œ');
    System.debug('âœ… Order ì •ë³´ ì—…ë°ì´íŠ¸: ì™„ë£Œ');
    System.debug('âœ… ì±„ë„ ì•Œë¦¼ ì‹œìŠ¤í…œ: ì™„ë£Œ');
    System.debug('âœ… ë©”ì‹œì§€ ë°œì†¡ ê¸°ëŠ¥: ì™„ë£Œ');
    System.debug('');
    System.debug('ğŸ¯ í™•ì¸ì‚¬í•­:');
    System.debug('1. Order ë ˆì½”ë“œì—ì„œ Salesforce Channel í•„ë“œ í™•ì¸');
    System.debug('2. ìƒì„±ëœ Chatter Group ë˜ëŠ” Channel í™•ì¸');
    System.debug('3. ì±„ë„ ë‚´ í™˜ì˜ ë©”ì‹œì§€ ë° í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ í™•ì¸');
    System.debug('4. ì±„ë„ ë©¤ë²„ êµ¬ì„± í™•ì¸');
    
    System.debug('âœ… =====Salesforce Channel ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ=====');
    
} catch (Exception e) {
    System.debug('âŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}
