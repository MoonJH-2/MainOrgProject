/**
 * ë¡œì§ 1 ìµœì¢… ê²€ì¦: Assets ìš°ì„ ìˆœìœ„ ê³„ì‚° ì‹œìŠ¤í…œ ì™„ì„±ë„ í…ŒìŠ¤íŠ¸
 * AssetPriorityCalculator + LWC í†µí•© ê¸°ëŠ¥ ê²€ì¦
 */

System.debug('ğŸ¯ ë¡œì§ 1 ìµœì¢… ê²€ì¦: Assets ìš°ì„ ìˆœìœ„ ê³„ì‚° ì‹œìŠ¤í…œ');
System.debug('===============================================');
System.debug('ê²€ì¦ ì‹œì‘: ' + DateTime.now().format());
System.debug('');

// ==========================================
// 1. í•µì‹¬ ê¸°ëŠ¥ ì™„ì„±ë„ ê²€ì¦
// ==========================================

System.debug('ğŸ“ 1. í•µì‹¬ ê¸°ëŠ¥ ì™„ì„±ë„ ê²€ì¦');
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

Boolean allTestsPassed = true;
List<String> failedTests = new List<String>();

try {
    // 1-1. TOP 5 ìš°ì„ ìˆœìœ„ ì¡°íšŒ í…ŒìŠ¤íŠ¸
    System.debug('ğŸ” 1-1. TOP 5 ìš°ì„ ìˆœìœ„ ì¡°íšŒ');
    AssetPriorityCalculator.PriorityResult top5Result = AssetPriorityCalculator.getTop5Priorities();
    
    if (top5Result != null) {
        System.debug('âœ… TOP 5 ì¡°íšŒ ì„±ê³µ');
        System.debug('   - ê²°ê³¼ ìˆ˜: ' + top5Result.priorities.size());
        System.debug('   - ê¸´ê¸‰ ê³ ê°: ' + top5Result.urgentCount + 'ëª…');
        System.debug('   - ì˜ˆìƒ ë§¤ì¶œ: â‚©' + (top5Result.totalExpectedRevenue?.format() ?? '0'));
    } else {
        allTestsPassed = false;
        failedTests.add('TOP 5 ì¡°íšŒ ì‹¤íŒ¨');
        System.debug('âŒ TOP 5 ì¡°íšŒ ì‹¤íŒ¨: null ë°˜í™˜');
    }
    
    // 1-2. ì‚¬ìš©ì ì§€ì • ê°œìˆ˜ ì¡°íšŒ í…ŒìŠ¤íŠ¸
    System.debug('');
    System.debug('ğŸ” 1-2. ì‚¬ìš©ì ì§€ì • ê°œìˆ˜ ì¡°íšŒ (10ê°œ)');
    AssetPriorityCalculator.PriorityResult customResult = AssetPriorityCalculator.calculatePriorities(null, 10);
    
    if (customResult != null) {
        System.debug('âœ… ì‚¬ìš©ì ì§€ì • ì¡°íšŒ ì„±ê³µ');
        System.debug('   - ìš”ì²­: 10ê°œ, ì‹¤ì œ: ' + customResult.priorities.size() + 'ê°œ');
        System.debug('   - ìš”ì•½: ' + customResult.summary);
    } else {
        allTestsPassed = false;
        failedTests.add('ì‚¬ìš©ì ì§€ì • ì¡°íšŒ ì‹¤íŒ¨');
        System.debug('âŒ ì‚¬ìš©ì ì§€ì • ì¡°íšŒ ì‹¤íŒ¨');
    }
    
} catch (Exception e) {
    allTestsPassed = false;
    failedTests.add('í•µì‹¬ ê¸°ëŠ¥ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('âŒ í•µì‹¬ ê¸°ëŠ¥ ê²€ì¦ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
}

// ==========================================
// 2. ì ìˆ˜ ê³„ì‚° ì •í™•ì„± ê²€ì¦
// ==========================================

System.debug('');
System.debug('ğŸ“ 2. ì ìˆ˜ ê³„ì‚° ì •í™•ì„± ê²€ì¦');
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

try {
    AssetPriorityCalculator.PriorityResult scoreTest = AssetPriorityCalculator.calculatePriorities(null, 5);
    
    if (scoreTest.priorities.size() > 0) {
        System.debug('ğŸ§® ì ìˆ˜ ê³„ì‚° ê²€ì¦:');
        
        Boolean scoreValidation = true;
        for (AssetPriorityCalculator.AssetPriority priority : scoreTest.priorities) {
            Decimal score = priority.score;
            Integer daysFromInstall = priority.daysFromInstall;
            Decimal assetPrice = priority.asset.Price;
            
            System.debug('Asset: ' + priority.asset.Name);
            System.debug('  - ì‚¬ìš©ê¸°ê°„: ' + daysFromInstall + 'ì¼');
            System.debug('  - ê°€ê²©: â‚©' + (assetPrice?.format() ?? '0'));
            System.debug('  - ê³„ì‚°ëœ ì ìˆ˜: ' + score + 'ì ');
            System.debug('  - ê¸´ê¸‰ë„: ' + priority.urgencyLevel);
            
            // ì ìˆ˜ ë²”ìœ„ ê²€ì¦ (0-100ì )
            if (score < 0 || score > 100) {
                scoreValidation = false;
                System.debug('  âŒ ì ìˆ˜ ë²”ìœ„ ì˜¤ë¥˜: ' + score);
            }
            
            // ê°±ì‹  ì„ë°•ë„ ë¡œì§ ê²€ì¦
            if (daysFromInstall >= 330 && daysFromInstall <= 365) {
                if (score < 50) {
                    scoreValidation = false;
                    System.debug('  âŒ ê°±ì‹  ì„ë°•ë„ ì ìˆ˜ ì˜¤ë¥˜');
                }
            }
            
            System.debug('  - ì˜ˆìƒ ë§¤ì¶œ: â‚©' + priority.expectedRevenue.format());
            System.debug('');
        }
        
        if (scoreValidation) {
            System.debug('âœ… ì ìˆ˜ ê³„ì‚° ì •í™•ì„± ê²€ì¦ í†µê³¼');
        } else {
            allTestsPassed = false;
            failedTests.add('ì ìˆ˜ ê³„ì‚° ì •í™•ì„± ì˜¤ë¥˜');
            System.debug('âŒ ì ìˆ˜ ê³„ì‚° ì •í™•ì„± ê²€ì¦ ì‹¤íŒ¨');
        }
    }
    
} catch (Exception e) {
    allTestsPassed = false;
    failedTests.add('ì ìˆ˜ ê³„ì‚° ê²€ì¦ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('âŒ ì ìˆ˜ ê³„ì‚° ê²€ì¦ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
}

// ==========================================
// 3. ì„±ëŠ¥ ë° íš¨ìœ¨ì„± ê²€ì¦
// ==========================================

System.debug('ğŸ“ 3. ì„±ëŠ¥ ë° íš¨ìœ¨ì„± ê²€ì¦');
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

try {
    Long startTime = System.currentTimeMillis();
    Integer initialQueries = Limits.getQueries();
    
    // ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    AssetPriorityCalculator.PriorityResult performanceResult = AssetPriorityCalculator.calculatePriorities(null, 20);
    
    Long endTime = System.currentTimeMillis();
    Long executionTime = endTime - startTime;
    Integer queriesUsed = Limits.getQueries() - initialQueries;
    
    System.debug('âš¡ ì„±ëŠ¥ ì¸¡ì • ê²°ê³¼:');
    System.debug('   - ì²˜ë¦¬ ì‹œê°„: ' + executionTime + 'ms');
    System.debug('   - ì²˜ë¦¬ëœ Assets: ' + performanceResult.priorities.size() + 'ê°œ');
    System.debug('   - SOQL ì¿¼ë¦¬ ì‚¬ìš©: ' + queriesUsed + 'ê°œ');
    System.debug('   - í‰ê·  ì²˜ë¦¬ ì‹œê°„: ' + (performanceResult.priorities.size() > 0 ? (executionTime / performanceResult.priorities.size()) : 0) + 'ms/Asset');
    
    // ì„±ëŠ¥ ê¸°ì¤€ ê²€ì¦
    Boolean performancePassed = true;
    
    if (executionTime > 3000) { // 3ì´ˆ ì´ìƒ
        performancePassed = false;
        System.debug('   âŒ ì„±ëŠ¥ ê¸°ì¤€ ë¯¸ë‹¬: 3ì´ˆ ì´ˆê³¼');
    }
    
    if (queriesUsed > 10) { // SOQL ì¿¼ë¦¬ 10ê°œ ì´ìƒ
        performancePassed = false;
        System.debug('   âŒ ì¿¼ë¦¬ ì‚¬ìš©ëŸ‰ ê³¼ë‹¤: ' + queriesUsed + 'ê°œ');
    }
    
    if (performancePassed) {
        System.debug('âœ… ì„±ëŠ¥ ê¸°ì¤€ ë‹¬ì„±');
    } else {
        allTestsPassed = false;
        failedTests.add('ì„±ëŠ¥ ê¸°ì¤€ ë¯¸ë‹¬');
    }
    
} catch (Exception e) {
    allTestsPassed = false;
    failedTests.add('ì„±ëŠ¥ ê²€ì¦ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('âŒ ì„±ëŠ¥ ê²€ì¦ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
}

// ==========================================
// 4. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìœ íš¨ì„± ê²€ì¦
// ==========================================

System.debug('');
System.debug('ğŸ“ 4. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìœ íš¨ì„± ê²€ì¦');
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

try {
    AssetPriorityCalculator.PriorityResult businessResult = AssetPriorityCalculator.getTop5Priorities();
    
    System.debug('ğŸ’¼ ë¹„ì¦ˆë‹ˆìŠ¤ ê°€ì¹˜ ê²€ì¦:');
    
    if (businessResult.priorities.size() > 0) {
        // ìµœê³  ìš°ì„ ìˆœìœ„ ê³ ê° ë¶„ì„
        AssetPriorityCalculator.AssetPriority topPriority = businessResult.priorities[0];
        
        System.debug('ğŸ† ìµœê³  ìš°ì„ ìˆœìœ„ ê³ ê°:');
        System.debug('   - ê³ ê°ëª…: ' + topPriority.asset.Account.Name);
        System.debug('   - ì ìˆ˜: ' + topPriority.score + 'ì ');
        System.debug('   - ê¸´ê¸‰ë„: ' + topPriority.urgencyLevel);
        System.debug('   - ê°±ì‹  ìƒíƒœ: ' + topPriority.renewalStatus);
        System.debug('   - ì¶”ì²œ ì•¡ì…˜: ' + topPriority.actionRecommendation);
        System.debug('   - ì˜ˆìƒ ë§¤ì¶œ: â‚©' + topPriority.expectedRevenue.format());
        
        // ì˜ì—…ì‚¬ì› ê´€ì  ê²€ì¦
        System.debug('');
        System.debug('ğŸ‘¨â€ğŸ’¼ ì˜ì—…ì‚¬ì› ê´€ì  ê²€ì¦:');
        
        Boolean businessLogicValid = true;
        
        // 1. ê¸´ê¸‰ ê³ ê°ì´ ìµœìƒìœ„ì— ìˆëŠ”ì§€ í™•ì¸
        if (topPriority.score < 60) {
            System.debug('   âš ï¸ ìµœê³  ìš°ì„ ìˆœìœ„ ê³ ê°ì˜ ì ìˆ˜ê°€ ë‚®ìŒ: ' + topPriority.score);
        }
        
        // 2. ì—°ë½ì²˜ ì •ë³´ í™•ì¸
        String phoneNumber = topPriority.asset.Account.Phone;
        if (String.isBlank(phoneNumber)) {
            System.debug('   âš ï¸ ìµœê³  ìš°ì„ ìˆœìœ„ ê³ ê°ì˜ ì—°ë½ì²˜ ì •ë³´ ë¶€ì¡±');
        } else {
            System.debug('   âœ… ì—°ë½ì²˜ ì •ë³´ í™•ì¸: ' + phoneNumber);
        }
        
        // 3. ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ ê°€ì´ë“œ í™•ì¸
        if (String.isNotBlank(topPriority.actionRecommendation)) {
            System.debug('   âœ… ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ ê°€ì´ë“œ ì œê³µ');
        } else {
            businessLogicValid = false;
            System.debug('   âŒ ì•¡ì…˜ ê°€ì´ë“œ ëˆ„ë½');
        }
        
        if (businessLogicValid) {
            System.debug('âœ… ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìœ íš¨ì„± ê²€ì¦ í†µê³¼');
        } else {
            allTestsPassed = false;
            failedTests.add('ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìœ íš¨ì„± ì˜¤ë¥˜');
        }
        
    } else {
        System.debug('â„¹ï¸ ìš°ì„ ìˆœìœ„ ê³ ê° ì—†ìŒ (ì •ìƒ ìƒí™©ì¼ ìˆ˜ ìˆìŒ)');
    }
    
} catch (Exception e) {
    allTestsPassed = false;
    failedTests.add('ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê²€ì¦ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('âŒ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê²€ì¦ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
}

// ==========================================
// 5. ì‚¬ìš©ì ê²½í—˜ ì‹œë®¬ë ˆì´ì…˜
// ==========================================

System.debug('');
System.debug('ğŸ“ 5. ì‚¬ìš©ì ê²½í—˜ ì‹œë®¬ë ˆì´ì…˜');
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

try {
    System.debug('ğŸ‘¨â€ğŸ’¼ ì˜ì—…ì‚¬ì› ì¼ì¼ ì›Œí¬í”Œë¡œìš° ì‹œë®¬ë ˆì´ì…˜:');
    System.debug('');
    
    // ì•„ì¹¨ ë£¨í‹´ ì‹œë®¬ë ˆì´ì…˜
    System.debug('ğŸŒ… ì˜¤ì „ 9:00 - ì¶œê·¼ í›„ ìš°ì„ ìˆœìœ„ í™•ì¸');
    DateTime morningStart = DateTime.now();
    
    AssetPriorityCalculator.PriorityResult morningResult = AssetPriorityCalculator.getTop5Priorities();
    
    DateTime morningEnd = DateTime.now();
    Long morningTime = morningEnd.getTime() - morningStart.getTime();
    
    System.debug('   â±ï¸ ìš°ì„ ìˆœìœ„ í™•ì¸ ì‹œê°„: ' + morningTime + 'ms');
    
    if (morningResult.priorities.size() > 0) {
        System.debug('   ğŸ“‹ ì˜¤ëŠ˜ì˜ í•  ì¼:');
        
        for (Integer i = 0; i < Math.min(3, morningResult.priorities.size()); i++) {
            AssetPriorityCalculator.AssetPriority priority = morningResult.priorities[i];
            System.debug('     ' + (i + 1) + '. ' + priority.asset.Account.Name + 
                        ' (' + priority.urgencyLevel + ', ' + priority.expectedRevenue.format() + 'ì› ì˜ˆìƒ)');
        }
        
        // íš¨ìœ¨ì„± ê³„ì‚°
        System.debug('');
        System.debug('ğŸ“Š íš¨ìœ¨ì„± ë¶„ì„:');
        System.debug('   - ê¸°ì¡´ ë°©ì‹: 30ë¶„ (ìˆ˜ë™ ê³ ê° ë¶„ì„)');
        System.debug('   - ê°œì„  ë°©ì‹: ' + (morningTime / 1000.0) + 'ì´ˆ (ìë™ ìš°ì„ ìˆœìœ„)');
        System.debug('   - ì‹œê°„ ì ˆì•½: ' + (1800 - (morningTime / 1000.0)) + 'ì´ˆ');
        System.debug('   - íš¨ìœ¨ì„± í–¥ìƒ: ' + ((1800 - (morningTime / 1000.0)) / 1800 * 100).format() + '%');
        
        System.debug('âœ… ì‚¬ìš©ì ê²½í—˜ ì‹œë®¬ë ˆì´ì…˜ ì„±ê³µ');
        
    } else {
        System.debug('   ğŸ“­ ì˜¤ëŠ˜ ìš°ì„ ìˆœìœ„ ê³ ê° ì—†ìŒ');
        System.debug('âœ… ì‚¬ìš©ì ê²½í—˜ ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ (ë°ì´í„° ì—†ìŒ)');
    }
    
} catch (Exception e) {
    allTestsPassed = false;
    failedTests.add('ì‚¬ìš©ì ê²½í—˜ ì‹œë®¬ë ˆì´ì…˜ ì˜¤ë¥˜: ' + e.getMessage());
    System.debug('âŒ ì‚¬ìš©ì ê²½í—˜ ì‹œë®¬ë ˆì´ì…˜ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
}

// ==========================================
// ìµœì¢… ê²€ì¦ ê²°ê³¼
// ==========================================

System.debug('');
System.debug('ğŸ“ ìµœì¢… ê²€ì¦ ê²°ê³¼');
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

System.debug('ğŸ¯ ë¡œì§ 1: Assets ìš°ì„ ìˆœìœ„ ê³„ì‚° ì‹œìŠ¤í…œ');
System.debug('ê²€ì¦ ì™„ë£Œ ì‹œê°„: ' + DateTime.now().format());
System.debug('');

if (allTestsPassed) {
    System.debug('ğŸ‰ ì „ì²´ ê²€ì¦ ì„±ê³µ!');
    System.debug('');
    System.debug('âœ… ì™„ì„±ëœ ê¸°ëŠ¥:');
    System.debug('   - âœ… ìŠ¤ë§ˆíŠ¸í•œ ê³ ê° ìš°ì„ ìˆœìœ„ ìë™ ë¶„ë¥˜');
    System.debug('   - âœ… 3ê°œ í•µì‹¬ ìš”ì†Œ ê¸°ë°˜ ì ìˆ˜ ê³„ì‚° (ê°±ì‹ ì„ë°•ë„ + ë§¤ì¶œê·œëª¨ + ê³ ê°ì•ˆì •ì„±)');
    System.debug('   - âœ… TOP 5 ê³ ê° 5ì´ˆ ë‚´ ì‹ë³„');
    System.debug('   - âœ… ê¸´ê¸‰ë„ë³„ ìƒ‰ìƒ êµ¬ë¶„ (ğŸ”´ê¸´ê¸‰ ğŸŸ¡ì¤‘ìš” ğŸŸ¢ì¼ë°˜)');
    System.debug('   - âœ… ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ ê°€ì´ë“œ ì œê³µ');
    System.debug('   - âœ… ì˜ˆìƒ ë§¤ì¶œ ìë™ ê³„ì‚°');
    System.debug('   - âœ… ì˜ì—…ì‚¬ì› ì¹œí™”ì  UI/UX');
    System.debug('   - âœ… ëª¨ë°”ì¼ ë°˜ì‘í˜• ë””ìì¸');
    System.debug('   - âœ… ì„±ëŠ¥ ìµœì í™” (3ì´ˆ ì´ë‚´ ì²˜ë¦¬)');
    System.debug('');
    System.debug('ğŸš€ ë‹¤ìŒ ë‹¨ê³„: ë¡œì§ 2 (ì›í´ë¦­ ê°±ì‹  ì›Œí¬í”Œë¡œìš°) êµ¬í˜„ ì¤€ë¹„ ì™„ë£Œ!');
    System.debug('');
    System.debug('ğŸ’¡ ë¡œì§ 1ì€ ì˜ì—…ì‚¬ì›ì´ "ì˜¤ëŠ˜ ëˆ„êµ¬ì—ê²Œ ë¨¼ì € ì—°ë½í• ê¹Œ?"ë¼ëŠ” ì§ˆë¬¸ì—');
    System.debug('   5ì´ˆ ë‚´ë¡œ ì •í™•í•œ ë‹µì„ ì œê³µí•˜ëŠ” ì™„ë²½í•œ ì‹œìŠ¤í…œì…ë‹ˆë‹¤!');
    
} else {
    System.debug('âŒ ì¼ë¶€ ê²€ì¦ ì‹¤íŒ¨');
    System.debug('');
    System.debug('ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸:');
    for (String failedTest : failedTests) {
        System.debug('   - âŒ ' + failedTest);
    }
    System.debug('');
    System.debug('ğŸ’¡ ì‹¤íŒ¨í•œ ë¶€ë¶„ì„ ìˆ˜ì • í›„ ë‹¤ì‹œ ê²€ì¦í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.');
}

System.debug('');
System.debug('===============================================');
System.debug('ğŸ ë¡œì§ 1 ìµœì¢… ê²€ì¦ ì™„ë£Œ');
System.debug('===============================================');
