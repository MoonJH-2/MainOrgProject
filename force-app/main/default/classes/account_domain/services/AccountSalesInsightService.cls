/**
 * @description Account ì˜ì—… íš¨ìœ¨ì„±ì„ ìœ„í•œ í†µí•© ì¸ì‚¬ì´íŠ¸ ì„œë¹„ìŠ¤
 * @author JH Moon
 * @created 2025-07-23
 */
public with sharing class AccountSalesInsightService {
    
    /**
     * Account ì˜ì—… ìš”ì•½ ì •ë³´ ì¡°íšŒ
     */
    @AuraEnabled(cacheable=true)
    public static AccountSalesData getAccountSalesInsight(Id accountId) {
        try {
            // Account ê¸°ë³¸ ì •ë³´ ì¡°íšŒ
            Account acc = [
                SELECT Id, Name, Key_Account__c, Industry, Phone, Website, 
                       AnnualRevenue, NumberOfEmployees, Type, AccountSource,
                       ShippingCity, ShippingCountry, Description
                FROM Account 
                WHERE Id = :accountId
                LIMIT 1
            ];
            
            // ê´€ë ¨ ë°ì´í„° ê°œë³„ ì¡°íšŒ (COUNTëŠ” ë³„ë„ ì¿¼ë¦¬ë¡œ)
            Integer opportunityCount = [SELECT COUNT() FROM Opportunity WHERE AccountId = :accountId AND StageName != 'Closed Lost'];
            Integer caseCount = [SELECT COUNT() FROM Case WHERE AccountId = :accountId AND Status != 'Closed'];
            Integer orderCount = [SELECT COUNT() FROM Order WHERE AccountId = :accountId AND Status = 'Activated'];
            Integer contactCount = [SELECT COUNT() FROM Contact WHERE AccountId = :accountId];
            
            AccountSalesData data = new AccountSalesData();
            data.account = acc;
            data.opportunityCount = opportunityCount;
            data.caseCount = caseCount;
            data.orderCount = orderCount;
            data.contactCount = contactCount;
            data.priorityLevel = calculatePriority(acc);
            data.recentRevenue = calculateRecentRevenue(accountId);
            data.recommendedActions = generateRecommendedActions(acc, opportunityCount, contactCount);
            data.salesInsights = generateSalesInsights(acc, opportunityCount, orderCount);
            data.alertSettings = getAlertSettings(accountId);
            data.opportunityForecast = predictOpportunityValue(acc);
            
            return data;
            
        } catch (Exception e) {
            System.debug('Account Sales Insight ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage());
            throw new AuraHandledException('Account ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    /**
     * ê³ ê° ìš°ì„ ìˆœìœ„ ê³„ì‚°
     */
    private static String calculatePriority(Account acc) {
        Integer score = 0;
        
        // Key Account ì—¬ë¶€ (ê°€ì¥ ë†’ì€ ê°€ì¤‘ì¹˜)
        if (acc.Key_Account__c) score += 50;
        
        // ì—°ê°„ ë§¤ì¶œì•¡
        if (acc.AnnualRevenue != null) {
            if (acc.AnnualRevenue >= 1000000000) score += 30; // 10ì–µ ì´ìƒ
            else if (acc.AnnualRevenue >= 500000000) score += 20; // 5ì–µ ì´ìƒ
            else if (acc.AnnualRevenue >= 100000000) score += 10; // 1ì–µ ì´ìƒ
        }
        
        // ì§ì› ìˆ˜
        if (acc.NumberOfEmployees != null) {
            if (acc.NumberOfEmployees >= 1000) score += 20;
            else if (acc.NumberOfEmployees >= 100) score += 10;
            else if (acc.NumberOfEmployees >= 50) score += 5;
        }
        
        // ìš°ì„ ìˆœìœ„ ë“±ê¸‰ ê²°ì •
        if (score >= 70) return 'ìµœìš°ì„ ';
        else if (score >= 50) return 'ë†’ìŒ';
        else if (score >= 30) return 'ì¤‘ê°„';
        else return 'ë³´í†µ';
    }
    
    /**
     * ìµœê·¼ ë§¤ì¶œ ê³„ì‚°
     */
    private static Decimal calculateRecentRevenue(Id accountId) {
        try {
            AggregateResult result = [
                SELECT SUM(TotalAmount) totalRevenue
                FROM Order 
                WHERE AccountId = :accountId 
                AND Status = 'Activated'
                AND EffectiveDate >= :Date.today().addYears(-1)
            ];
            
            return (Decimal)result.get('totalRevenue') ?? 0;
            
        } catch (Exception e) {
            System.debug('ë§¤ì¶œ ê³„ì‚° ì˜¤ë¥˜: ' + e.getMessage());
            return 0;
        }
    }
    
    /**
     * ì¶”ì²œ ì•¡ì…˜ ìƒì„±
     */
    private static List<RecommendedAction> generateRecommendedActions(Account acc, Integer opportunityCount, Integer contactCount) {
        List<RecommendedAction> actions = new List<RecommendedAction>();
        
        // Key Account ì „ìš© ì•¡ì…˜
        if (acc.Key_Account__c) {
            actions.add(new RecommendedAction(
                'ğŸ¯', 
                'Key Account ì •ê¸° ë¯¸íŒ… ì¼ì •', 
                'Key Accountì´ë¯€ë¡œ ë¶„ê¸°ë³„ ì •ê¸° ë¯¸íŒ… í•„ìš”',
                'High',
                'createTask'
            ));
        }
        
        // ì›¹ì‚¬ì´íŠ¸ ë¶„ì„ ì•¡ì…˜
        if (String.isNotBlank(acc.Website)) {
            actions.add(new RecommendedAction(
                'ğŸŒ', 
                'ì›¹ì‚¬ì´íŠ¸ ë™í–¥ ë¶„ì„', 
                'ê³ ê° ì›¹ì‚¬ì´íŠ¸ ë°©ë¬¸í•˜ì—¬ ìµœì‹  ë¹„ì¦ˆë‹ˆìŠ¤ ë™í–¥ íŒŒì•…',
                'Medium',
                'visitWebsite'
            ));
        }
        
        // ì—°ë½ì²˜ ë¶€ì¡± ì‹œ ì•¡ì…˜
        if (contactCount == 0) {
            actions.add(new RecommendedAction(
                'ğŸ‘¥', 
                'ì˜ì‚¬ê²°ì •ì ì—°ë½ì²˜ í™•ë³´', 
                'ì˜ì—… ì§„í–‰ì„ ìœ„í•œ í•µì‹¬ ì—°ë½ì²˜ ì •ë³´ ìˆ˜ì§‘ í•„ìš”',
                'High',
                'addContact'
            ));
        }
        
        // Opportunity ë¶€ì¡± ì‹œ ì•¡ì…˜
        if (opportunityCount == 0) {
            actions.add(new RecommendedAction(
                'ğŸ’°', 
                'ì‹ ê·œ ì˜ì—… ê¸°íšŒ ìƒì„±', 
                'í™œì„± ì˜ì—… ê¸°íšŒê°€ ì—†ì–´ ì‹ ê·œ ê¸°íšŒ ë°œêµ´ í•„ìš”',
                'High',
                'createOpportunity'
            ));
        }
        
        // ì—…ì¢…ë³„ ë§ì¶¤ ì•¡ì…˜
        if (String.isNotBlank(acc.Industry)) {
            if (acc.Industry.containsIgnoreCase('Technology') || 
                (acc.Website != null && acc.Website.containsIgnoreCase('ai'))) {
                actions.add(new RecommendedAction(
                    'ğŸ¤–', 
                    'AI/ê¸°ìˆ  ì†”ë£¨ì…˜ ì œì•ˆ', 
                    'ê¸°ìˆ  ê¸°ì—… íŠ¹ì„±ìƒ í˜ì‹ ì  ì†”ë£¨ì…˜ ì œì•ˆ ê¸°íšŒ',
                    'Medium',
                    'prepareProposal'
                ));
            }
        }
        
        return actions;
    }
    
    /**
     * ì˜ì—… ì¸ì‚¬ì´íŠ¸ ìƒì„±
     */
    private static List<String> generateSalesInsights(Account acc, Integer opportunityCount, Integer orderCount) {
        List<String> insights = new List<String>();
        
        // Key Account ì¸ì‚¬ì´íŠ¸
        if (acc.Key_Account__c) {
            insights.add('â­ Key Accountë¡œ ìµœìš°ì„  ê´€ë¦¬ ëŒ€ìƒì…ë‹ˆë‹¤');
            insights.add('ğŸ“ˆ ì¥ê¸°ì  íŒŒíŠ¸ë„ˆì‹­ êµ¬ì¶• ë° í™•ì¥ ê¸°íšŒ ê²€í†  í•„ìš”');
        }
        
        // ë§¤ì¶œ ê·œëª¨ ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸
        if (acc.AnnualRevenue != null) {
            if (acc.AnnualRevenue >= 1000000000) {
                insights.add('ğŸ’¼ ëŒ€ê¸°ì—… ê³ ê°ìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤');
            } else if (acc.AnnualRevenue >= 100000000) {
                insights.add('ğŸ¢ ì¤‘ê²¬ê¸°ì—…ìœ¼ë¡œ ì„±ì¥ ë‹¨ê³„ë³„ ì†”ë£¨ì…˜ í™•ì¥ ê°€ëŠ¥');
            } else {
                insights.add('ğŸš€ ì¤‘ì†Œê¸°ì—…ìœ¼ë¡œ íš¨ìœ¨ì„± ì¤‘ì‹¬ ì œì•ˆ í•„ìš”');
            }
        }
        
        // ì§ì› ìˆ˜ ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸
        if (acc.NumberOfEmployees != null) {
            if (acc.NumberOfEmployees >= 1000) {
                insights.add('ğŸ‘¥ ëŒ€ê·œëª¨ ì¡°ì§ìœ¼ë¡œ ë¶€ì„œë³„ í™•ì‚° ê¸°íšŒ ì¡´ì¬');
            } else if (acc.NumberOfEmployees >= 100) {
                insights.add('ğŸ‘¥ ì¤‘ê°„ ê·œëª¨ ì¡°ì§ìœ¼ë¡œ ë‹¨ê³„ì  ë„ì… ì „ëµ í•„ìš”');
            }
        }
        
        // í™œë™ ë¶€ì¡± ê²½ê³ 
        if (opportunityCount == 0 && orderCount == 0) {
            insights.add('âš ï¸ ìµœê·¼ ì˜ì—… í™œë™ì´ ë¶€ì¡±í•©ë‹ˆë‹¤ - ì¦‰ì‹œ ì ‘ì´‰ í•„ìš”');
        }
        
        // ì›¹ì‚¬ì´íŠ¸ ê¸°ë°˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„
        if (String.isNotBlank(acc.Website)) {
            if (acc.Website.containsIgnoreCase('coach') || acc.Website.containsIgnoreCase('golf')) {
                insights.add('â›³ ìŠ¤í¬ì¸ /ë ˆì € ì—…ì¢…ìœ¼ë¡œ B2B ì†”ë£¨ì…˜ í™•ì¥ ê¸°íšŒ');
            }
        }
        
        return insights;
    }
    
    /**
     * ê¸°íšŒ ì˜ˆì¸¡ ê°’ ê³„ì‚°
     */
    private static OpportunityForecast predictOpportunityValue(Account acc) {
        OpportunityForecast forecast = new OpportunityForecast();
        
        // ê¸°ë³¸ ì˜ˆì¸¡ ê¸ˆì•¡ ê³„ì‚°
        Decimal baseAmount = 50000000; // 5ì²œë§Œì› ê¸°ë³¸
        
        // Key Account ë³´ì •
        if (acc.Key_Account__c) {
            baseAmount *= 2;
            forecast.probability = 80;
        } else {
            forecast.probability = 60;
        }
        
        // ì—°ê°„ ë§¤ì¶œ ê¸°ë°˜ ë³´ì •
        if (acc.AnnualRevenue != null) {
            if (acc.AnnualRevenue >= 1000000000) {
                baseAmount *= 1.5;
                forecast.probability += 10;
            } else if (acc.AnnualRevenue >= 500000000) {
                baseAmount *= 1.2;
                forecast.probability += 5;
            }
        }
        
        // ê¸°ì¡´ Order ì¡´ì¬ ì‹œ ë³´ì • (ë³„ë„ ì¡°íšŒ í•„ìš”ì‹œ)
        // ì„±ëŠ¥ì„ ìœ„í•´ ì¼ë‹¨ ìƒëµí•˜ê³  ê¸°ë³¸ ë¡œì§ë§Œ ì ìš©
        
        forecast.expectedAmount = baseAmount;
        forecast.timeframe = acc.Key_Account__c ? '2-3ê°œì›”' : '3-4ê°œì›”';
        
        return forecast;
    }
    
    /**
     * ì•Œë¦¼ ì„¤ì • ì¡°íšŒ
     */
    private static AlertSettings getAlertSettings(Id accountId) {
        AlertSettings settings = new AlertSettings();
        
        // ê¸°ì¡´ ì•Œë¦¼ Task ì¡°íšŒ
        List<Task> alerts = [
            SELECT Id, Subject, ActivityDate 
            FROM Task 
            WHERE WhatId = :accountId 
            AND Subject LIKE '%ì²´í¬ì¸%'
            AND ActivityDate >= :Date.today()
            LIMIT 5
        ];
        
        settings.hasActiveAlerts = !alerts.isEmpty();
        settings.nextAlertDate = alerts.isEmpty() ? null : alerts[0].ActivityDate;
        
        return settings;
    }
    
    /**
     * ì¦‰ì‹œ ì•¡ì…˜ ì‹¤í–‰
     */
    @AuraEnabled
    public static String executeAction(Id accountId, String actionType, String actionData) {
        try {
            switch on actionType {
                when 'createTask' {
                    return createFollowUpTask(accountId, actionData);
                }
                when 'createOpportunity' {
                    return createNewOpportunity(accountId);
                }
                when 'addContact' {
                    return prepareContactForm(accountId);
                }
                when 'visitWebsite' {
                    return getWebsiteUrl(accountId);
                }
                when 'prepareProposal' {
                    return prepareProposalTemplate(accountId);
                }
                when else {
                    return 'ì•Œ ìˆ˜ ì—†ëŠ” ì•¡ì…˜ì…ë‹ˆë‹¤.';
                }
            }
        } catch (Exception e) {
            System.debug('ì•¡ì…˜ ì‹¤í–‰ ì˜¤ë¥˜: ' + e.getMessage());
            throw new AuraHandledException('ì•¡ì…˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    /**
     * í›„ì† Task ìƒì„±
     */
    private static String createFollowUpTask(Id accountId, String actionData) {
        Task newTask = new Task();
        newTask.WhatId = accountId;
        newTask.Subject = 'Account í›„ì† ì¡°ì¹˜: ' + actionData;
        newTask.ActivityDate = Date.today().addDays(7);
        newTask.Priority = 'High';
        newTask.Description = 'ì˜ì—… íš¨ìœ¨ì„± ì‹œìŠ¤í…œì—ì„œ ìë™ ìƒì„±ëœ í›„ì† ì¡°ì¹˜ Task';
        newTask.Status = 'Open';
        
        insert newTask;
        
        return 'Taskê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (ID: ' + newTask.Id + ')';
    }
    
    /**
     * ì‹ ê·œ Opportunity ìƒì„±
     */
    private static String createNewOpportunity(Id accountId) {
        Opportunity newOpp = new Opportunity();
        newOpp.AccountId = accountId;
        newOpp.Name = 'ì‹ ê·œ ì˜ì—… ê¸°íšŒ';
        newOpp.StageName = 'Prospecting';
        newOpp.CloseDate = Date.today().addDays(90);
        newOpp.Amount = 50000000;
        newOpp.Description = 'ì˜ì—… íš¨ìœ¨ì„± ì‹œìŠ¤í…œì—ì„œ ìë™ ìƒì„±ëœ ê¸°íšŒ';
        
        insert newOpp;
        
        return 'Opportunityê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (ID: ' + newOpp.Id + ')';
    }
    
    /**
     * ì›¹ì‚¬ì´íŠ¸ URL ë°˜í™˜
     */
    private static String getWebsiteUrl(Id accountId) {
        Account acc = [SELECT Website FROM Account WHERE Id = :accountId LIMIT 1];
        return acc.Website;
    }
    
    /**
     * ì œì•ˆì„œ í…œí”Œë¦¿ ì¤€ë¹„
     */
    private static String prepareProposalTemplate(Id accountId) {
        return 'proposal_template_' + accountId;
    }
    
    /**
     * ì—°ë½ì²˜ í¼ ì¤€ë¹„
     */
    private static String prepareContactForm(Id accountId) {
        return '/lightning/o/Contact/new?defaultFieldValues=AccountId=' + accountId;
    }
    
    // Inner Classes
    public class AccountSalesData {
        @AuraEnabled public Account account;
        @AuraEnabled public String priorityLevel;
        @AuraEnabled public Decimal recentRevenue;
        @AuraEnabled public Integer opportunityCount;
        @AuraEnabled public Integer caseCount;
        @AuraEnabled public Integer orderCount;
        @AuraEnabled public Integer contactCount;
        @AuraEnabled public List<RecommendedAction> recommendedActions;
        @AuraEnabled public List<String> salesInsights;
        @AuraEnabled public AlertSettings alertSettings;
        @AuraEnabled public OpportunityForecast opportunityForecast;
    }
    
    public class RecommendedAction {
        @AuraEnabled public String icon;
        @AuraEnabled public String title;
        @AuraEnabled public String description;
        @AuraEnabled public String priority;
        @AuraEnabled public String actionType;
        
        public RecommendedAction(String icon, String title, String description, String priority, String actionType) {
            this.icon = icon;
            this.title = title;
            this.description = description;
            this.priority = priority;
            this.actionType = actionType;
        }
    }
    
    public class AlertSettings {
        @AuraEnabled public Boolean hasActiveAlerts;
        @AuraEnabled public Date nextAlertDate;
    }
    
    public class OpportunityForecast {
        @AuraEnabled public Decimal expectedAmount;
        @AuraEnabled public Integer probability;
        @AuraEnabled public String timeframe;
    }
}
