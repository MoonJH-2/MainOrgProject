/**
 * @description ë‹¤ì¤‘ ì±„ë„ ë‚©ë¶€ ì•Œë¦¼ ì„œë¹„ìŠ¤
 * @author JH Moon
 * @date 2025-07-15
 */
public with sharing class PaymentNotificationService {
    
    /**
     * Salesforce ë‚´ë¶€ ì•Œë¦¼ ë°œì†¡
     */
    public static Boolean sendSalesforceNotification(Payment_Notification__c notification) {
        try {
            // 1. Chatter í¬ìŠ¤íŠ¸ ìƒì„±
            createChatterPost(notification);
            
            // 2. Custom Notification ë°œì†¡ (Bell ì•„ì´ì½˜ ì•Œë¦¼)
            sendCustomNotification(notification);
            
            // 3. Task ìƒì„± (ê³ ê° íŒ”ë¡œì—…ìš©)
            createNotificationTask(notification);
            
            return true;
            
        } catch (Exception e) {
            System.debug('Salesforce ì•Œë¦¼ ë°œì†¡ ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
    }
    
    /**
     * ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡ (ê³ ê°ê³¼ ê´€ë¦¬ì ëª¨ë‘)
     */
    public static Boolean sendEmailNotification(Payment_Notification__c notification) {
        try {
            List<Messaging.SingleEmailMessage> emails = new List<Messaging.SingleEmailMessage>();
            
            // 1. ê³ ê° ì´ë©”ì¼
            String customerEmail = getCustomerEmail(notification);
            if (String.isNotBlank(customerEmail)) {
                Messaging.SingleEmailMessage customerEmailMessage = createPaymentEmail(notification, customerEmail, 'Customer');
                emails.add(customerEmailMessage);
            }
            
            // 2. ê´€ë¦¬ì ì´ë©”ì¼ë“¤
            List<String> adminEmails = getAdminEmails(notification);
            for (String adminEmail : adminEmails) {
                Messaging.SingleEmailMessage adminEmailMessage = createPaymentEmail(notification, adminEmail, 'Admin');
                emails.add(adminEmailMessage);
            }
            
            if (emails.isEmpty()) {
                System.debug('ë°œì†¡í•  ì´ë©”ì¼ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            // ì´ë©”ì¼ ë°œì†¡
            Messaging.SendEmailResult[] results = Messaging.sendEmail(emails);
            
            Integer successCount = 0;
            for (Messaging.SendEmailResult result : results) {
                if (result.isSuccess()) {
                    successCount++;
                } else {
                    System.debug('ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: ' + result.getErrors()[0].getMessage());
                }
            }
            
            System.debug('ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ - ì„±ê³µ: ' + successCount + '/' + emails.size());
            return successCount > 0;
            
        } catch (Exception e) {
            System.debug('ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡ ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
    }
    
    /**
     * Salesforce Channel ì•Œë¦¼ ë°œì†¡ (í˜„ì¬ ë¹„í™œì„±í™” - ì»¤ìŠ¤í…€ í•„ë“œ ìƒì„± í›„ í™œì„±í™”)
     */
    public static Boolean sendSalesforceChannelNotification(Payment_Notification__c notification) {
        // TODO: Order ê°ì²´ì— Salesforce_Channel_ID__c ë“± ì»¤ìŠ¤í…€ í•„ë“œ ìƒì„± í›„ í™œì„±í™”
        System.debug('âš ï¸ SalesforceChannel ê¸°ëŠ¥ì€ ì»¤ìŠ¤í…€ í•„ë“œ ìƒì„± í›„ í™œì„±í™” ì˜ˆì •');
        return false;
        
        /*
        try {
            // Orderì— ì—°ê²°ëœ Salesforce Channelì´ ìˆëŠ”ì§€ í™•ì¸
            List<Order> orders = [
                SELECT Id, Salesforce_Channel_ID__c, Salesforce_Channel_Name__c, Channel_Status__c
                FROM Order 
                WHERE Id = :notification.PaymentStatus__r.Order__c
                AND Salesforce_Channel_ID__c != null
                AND Channel_Status__c = 'Active'
                LIMIT 1
            ];
            
            if (orders.isEmpty()) {
                System.debug('âŒ í™œì„±í™”ëœ Salesforce Channelì´ ì—†ìŠµë‹ˆë‹¤: Order ' + notification.PaymentStatus__r.Order__c);
                return false;
            }
            
            Order orderWithChannel = orders[0];
            
            // ì±„ë„ì— ë‚©ë¶€ ì•Œë¦¼ ë©”ì‹œì§€ ë°œì†¡
            String channelMessage = createChannelNotificationMessage(notification);
            Boolean success = SalesforceChannelService.sendChannelMessage(
                orderWithChannel.Salesforce_Channel_ID__c, 
                channelMessage
            );
            
            if (success) {
                System.debug('âœ… Salesforce Channel ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ: ' + orderWithChannel.Salesforce_Channel_Name__c);
                return true;
            } else {
                System.debug('âŒ Salesforce Channel ë©”ì‹œì§€ ë°œì†¡ ì‹¤íŒ¨');
                return false;
            }
            
        } catch (Exception e) {
            System.debug('âŒ Salesforce Channel ì•Œë¦¼ ë°œì†¡ ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
        */
    }
    
    /**
     * ì±„ë„ìš© ì•Œë¦¼ ë©”ì‹œì§€ ìƒì„± (í˜„ì¬ ë¹„í™œì„±í™”)
     */
    private static String createChannelNotificationMessage(Payment_Notification__c notification) {
        // TODO: Salesforce Channel ê¸°ëŠ¥ í™œì„±í™” ì‹œ ì‚¬ìš©
        return 'Channel message placeholder';
        /*
        String message = '';
        
        if (notification.NotificationType__c == 'ì˜ˆì • ì•Œë¦¼') {
            message = 'ğŸ”” **ë‚©ë¶€ ì˜ˆì • ì•Œë¦¼**\n\n';
            message += 'ê³ ê°ë‹˜ì˜ ë‚©ë¶€ ì˜ˆì •ì¼ì´ 3ì¼ í›„ì…ë‹ˆë‹¤.\n\n';
        } else {
            message = 'ğŸš¨ **ë‚©ë¶€ ì—°ì²´ ì•Œë¦¼**\n\n';
            message += 'ê³ ê°ë‹˜ì˜ ë‚©ë¶€ê°€ ì—°ì²´ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n';
        }
        
        message += 'ğŸ“‹ **ë‚©ë¶€ ì •ë³´**\n';
        message += 'â€¢ **ê³ ê°**: ' + notification.PaymentStatus__r.Order__r.Account.Name + '\n';
        message += 'â€¢ **ì£¼ë¬¸ë²ˆí˜¸**: ' + notification.PaymentStatus__r.Order__r.OrderNumber + '\n';
        message += 'â€¢ **ë‚©ë¶€ íšŒì°¨**: ' + notification.PaymentStatus__r.Installment_Number__c + 'ì°¨\n';
        message += 'â€¢ **ë‚©ë¶€ ê¸ˆì•¡**: â‚©' + notification.PaymentStatus__r.Amount__c.format() + '\n';
        message += 'â€¢ **ë‚©ë¶€ ì˜ˆì •ì¼**: ' + notification.PaymentStatus__r.DueDate__c.format() + '\n';
        
        if (notification.NotificationType__c == 'ì—°ì²´ ì•Œë¦¼') {
            Integer overdueDays = Date.today().daysBetween(notification.PaymentStatus__r.DueDate__c);
            message += 'â€¢ **ì—°ì²´ ê¸°ê°„**: ' + overdueDays + 'ì¼\n';
        }
        
        message += '\nğŸ’¡ **ë‹¤ìŒ ë‹¨ê³„**\n';
        if (notification.NotificationType__c == 'ì˜ˆì • ì•Œë¦¼') {
            message += 'â€¢ ê³ ê°ì—ê²Œ ë‚©ë¶€ ì˜ˆì •ì¼ ì‚¬ì „ ì•ˆë‚´\n';
            message += 'â€¢ ë‚©ë¶€ ë°©ë²• ë° ê³„ì¢Œ ì •ë³´ í™•ì¸\n';
            message += 'â€¢ í•„ìš”ì‹œ ë‚©ë¶€ ì¼ì • ì¡°ì • ìƒë‹´\n';
        } else {
            message += 'â€¢ ê³ ê°ì—ê²Œ ì¦‰ì‹œ ì—°ì²´ ì•ˆë‚´ ì—°ë½\n';
            message += 'â€¢ ë‚©ë¶€ ë…ì´‰ ë° ì—°ì²´ë£Œ ì•ˆë‚´\n';
            message += 'â€¢ ë‚©ë¶€ ê³„íš ìˆ˜ë¦½ ì§€ì›\n';
        }
        
        message += '\nğŸ“ ë‹´ë‹¹ìëŠ” ê³ ê°ê³¼ì˜ ì†Œí†µ ê²°ê³¼ë¥¼ ì´ ì±„ë„ì— ê³µìœ í•´ì£¼ì„¸ìš”.';
        
        return message;
        */
    }
    
    /**
     * ìŠ¬ë™ ì•Œë¦¼ ë°œì†¡
     */
    public static Boolean sendSlackNotification(Payment_Notification__c notification) {
        try {
            // ìŠ¬ë™ ì›¹í›… URL (Custom Settingì—ì„œ ê´€ë¦¬)
            String webhookUrl = getSlackWebhookUrl();
            if (String.isBlank(webhookUrl)) {
                System.debug('ìŠ¬ë™ ì›¹í›… URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            // ìŠ¬ë™ ë©”ì‹œì§€ ìƒì„±
            String slackMessage = createSlackMessage(notification);
            
            // HTTP ìš”ì²­ìœ¼ë¡œ ìŠ¬ë™ ë°œì†¡
            Http http = new Http();
            HttpRequest request = new HttpRequest();
            request.setEndpoint(webhookUrl);
            request.setMethod('POST');
            request.setHeader('Content-Type', 'application/json');
            request.setBody(slackMessage);
            
            HttpResponse response = http.send(request);
            
            if (response.getStatusCode() == 200) {
                System.debug('ìŠ¬ë™ ì•Œë¦¼ ë°œì†¡ ì„±ê³µ');
                return true;
            } else {
                System.debug('ìŠ¬ë™ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨: ' + response.getBody());
                return false;
            }
            
        } catch (Exception e) {
            System.debug('ìŠ¬ë™ ì•Œë¦¼ ë°œì†¡ ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
    }
    
    /**
     * Chatter í¬ìŠ¤íŠ¸ ìƒì„±
     */
    private static void createChatterPost(Payment_Notification__c notification) {
        try {
            FeedItem post = new FeedItem();
            // Orderì— ì§ì ‘ í¬ìŠ¤íŒ…
            post.ParentId = notification.PaymentStatus__r.Order__c;
            post.Type = 'TextPost';
            
            String message = '';
            if (notification.NotificationType__c == 'ì˜ˆì • ì•Œë¦¼') {
                message = 'ğŸ”” [ë‚©ë¶€ ì˜ˆì • ì•Œë¦¼] ' + 
                         notification.PaymentStatus__r.Order__r.Account.Name + ' ê³ ê°ë‹˜ì˜ ' +
                         notification.PaymentStatus__r.Installment_Number__c + 'ì°¨ ë‚©ë¶€ ì˜ˆì •ì¼ì´ 3ì¼ í›„ì…ë‹ˆë‹¤.\n' +
                         'ë‚©ë¶€ê¸ˆì•¡: â‚©' + notification.PaymentStatus__r.Amount__c.format() + '\n' +
                         'ë‚©ë¶€ì˜ˆì •ì¼: ' + notification.PaymentStatus__r.DueDate__c.format();
            } else if (notification.NotificationType__c == 'ì—°ì²´ ì•Œë¦¼') {
                Integer overdueDays = Date.today().daysBetween(notification.PaymentStatus__r.DueDate__c);
                message = 'ğŸš¨ [ì—°ì²´ ì•Œë¦¼] ' + 
                         notification.PaymentStatus__r.Order__r.Account.Name + ' ê³ ê°ë‹˜ì˜ ' +
                         notification.PaymentStatus__r.Installment_Number__c + 'ì°¨ ë‚©ë¶€ê°€ ì—°ì²´ë˜ì—ˆìŠµë‹ˆë‹¤.\n' +
                         'ë‚©ë¶€ê¸ˆì•¡: â‚©' + notification.PaymentStatus__r.Amount__c.format() + '\n' +
                         'ë‚©ë¶€ì˜ˆì •ì¼: ' + notification.PaymentStatus__r.DueDate__c.format() + '\n' +
                         'ì—°ì²´ê¸°ê°„: ' + overdueDays + 'ì¼';
            }
            
            post.Body = message;
            insert post;
            System.debug('Chatter í¬ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ: ' + notification.PaymentStatus__r.Order__r.OrderNumber);
            
        } catch (Exception e) {
            System.debug('Chatter í¬ìŠ¤íŠ¸ ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
            // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ì „ì²´ í”„ë¡œì„¸ìŠ¤ëŠ” ê³„ì† ì§„í–‰
        }
    }
    
    /**
     * Custom Notification ë°œì†¡ (ê³ ê°ê³¼ ê´€ë¦¬ì ëª¨ë‘)
     */
    private static void sendCustomNotification(Payment_Notification__c notification) {
        try {
            // Custom Notification íƒ€ì… ì¡°íšŒ ë˜ëŠ” ìƒì„±
            List<CustomNotificationType> notificationTypes = [
                SELECT Id FROM CustomNotificationType 
                WHERE DeveloperName = 'Payment_Notification' 
                LIMIT 1
            ];
            
            Id notificationTypeId;
            if (notificationTypes.isEmpty()) {
                // Custom Notification Typeì´ ì—†ìœ¼ë©´ ìƒì„± ì‹œë„
                notificationTypeId = createCustomNotificationType();
                if (notificationTypeId == null) {
                    System.debug('CustomNotificationType ìƒì„±/ì¡°íšŒ ì‹¤íŒ¨. Bell ì•Œë¦¼ì„ ìƒëµí•©ë‹ˆë‹¤.');
                    return;
                }
            } else {
                notificationTypeId = notificationTypes[0].Id;
            }
            
            // ì•Œë¦¼ ì œëª©ê³¼ ë‚´ìš©
            String title = notification.NotificationType__c == 'ì˜ˆì • ì•Œë¦¼' ? 
                          'ğŸ’° ë‚©ë¶€ ì˜ˆì • ì•Œë¦¼' : 'ğŸš¨ ë‚©ë¶€ ì—°ì²´ ì•Œë¦¼';
            
            String body = notification.PaymentStatus__r.Order__r.Account.Name + ' - ' +
                         notification.PaymentStatus__r.Installment_Number__c + 'ì°¨ â‚©' +
                         notification.PaymentStatus__r.Amount__c.format();
            
            // ìˆ˜ì‹ ì ID ìˆ˜ì§‘ (ê³ ê° ë‹´ë‹¹ì + ê´€ë¦¬ìë“¤)
            Set<String> recipientIds = getNotificationRecipients(notification);
            
            if (!recipientIds.isEmpty()) {
                Messaging.CustomNotification customNotification = new Messaging.CustomNotification();
                customNotification.setTitle(title);
                customNotification.setBody(body);
                customNotification.setTargetId(notification.PaymentStatus__r.Order__c);
                customNotification.setNotificationTypeId(notificationTypeId);
                customNotification.send(recipientIds);
                
                System.debug('Custom Notification ë°œì†¡ ì™„ë£Œ: ' + title + ' (ìˆ˜ì‹ ì: ' + recipientIds.size() + 'ëª…)');
            }
            
        } catch (Exception e) {
            System.debug('Custom Notification ë°œì†¡ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * ì•Œë¦¼ìš© Task ìƒì„±
     */
    private static void createNotificationTask(Payment_Notification__c notification) {
        Task notificationTask = new Task();
        notificationTask.WhatId = notification.PaymentStatus__r.Order__c; // Orderì— ì—°ê²°
        notificationTask.Subject = notification.NotificationType__c + ' - ' + 
                                  notification.PaymentStatus__r.Order__r.Account.Name + ' ' +
                                  notification.PaymentStatus__r.Installment_Number__c + 'ì°¨';
        
        String description = '';
        if (notification.NotificationType__c == 'ì˜ˆì • ì•Œë¦¼') {
            description = 'ê³ ê°ë‹˜ì˜ ë‚©ë¶€ ì˜ˆì •ì¼ì´ 3ì¼ í›„ì…ë‹ˆë‹¤. ì‚¬ì „ ì•ˆë‚´ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.\n\n';
            description += 'ì£¼ë¬¸ë²ˆí˜¸: ' + notification.PaymentStatus__r.Order__r.OrderNumber + '\n';
            description += 'ë‚©ë¶€ íšŒì°¨: ' + notification.PaymentStatus__r.Installment_Number__c + 'ì°¨\n';
            description += 'ë‚©ë¶€ ê¸ˆì•¡: â‚©' + String.valueOf(notification.PaymentStatus__r.Amount__c.format()) + '\n';
            description += 'ë‚©ë¶€ ì˜ˆì •ì¼: ' + notification.PaymentStatus__r.DueDate__c.format();
        } else {
            description = 'ê³ ê°ë‹˜ì˜ ë‚©ë¶€ê°€ ì—°ì²´ë˜ì—ˆìŠµë‹ˆë‹¤. ì—°ì²´ ê´€ë¦¬ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.\n\n';
            description += 'ì£¼ë¬¸ë²ˆí˜¸: ' + notification.PaymentStatus__r.Order__r.OrderNumber + '\n';
            description += 'ë‚©ë¶€ íšŒì°¨: ' + notification.PaymentStatus__r.Installment_Number__c + 'ì°¨\n';
            description += 'ë‚©ë¶€ ê¸ˆì•¡: â‚©' + String.valueOf(notification.PaymentStatus__r.Amount__c.format()) + '\n';
            description += 'ì—°ì²´ì¼: ' + notification.PaymentStatus__r.DueDate__c.format() + '\n';
            description += 'ì—°ì²´ ê¸°ê°„: ' + (Date.today().daysBetween(notification.PaymentStatus__r.DueDate__c)) + 'ì¼';
        }
        
        notificationTask.Description = description;
        notificationTask.Priority = notification.NotificationType__c == 'ì—°ì²´ ì•Œë¦¼' ? 'High' : 'Normal';
        notificationTask.Status = 'Not Started';
        notificationTask.ActivityDate = Date.today().addDays(
            notification.NotificationType__c == 'ì—°ì²´ ì•Œë¦¼' ? 1 : 3
        );
        
        // PaymentStatus ì •ë³´ë¥¼ Taskì— ì—°ê²° (ì»¤ìŠ¤í…€ í•„ë“œê°€ ìˆë‹¤ë©´)
        // notificationTask.PaymentStatus__c = notification.PaymentStatus__c;
        
        insert notificationTask;
    }
    
    /**
     * ê³ ê° ì´ë©”ì¼ ì£¼ì†Œ ì¡°íšŒ
     */
    private static String getCustomerEmail(Payment_Notification__c notification) {
        // ì„¤ì •ëœ ìˆ˜ì‹ ì ì´ë©”ì¼ì´ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš© (null ì²´í¬ ê°•í™”)
        try {
            if (notification.get('RecipientEmail__c') != null && 
                String.isNotBlank(String.valueOf(notification.get('RecipientEmail__c')))) {
                return String.valueOf(notification.get('RecipientEmail__c'));
            }
        } catch (Exception e) {
            System.debug('RecipientEmail__c í•„ë“œ ì ‘ê·¼ ì˜¤ë¥˜ (í•„ë“œê°€ ì¿¼ë¦¬ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŒ): ' + e.getMessage());
        }
        
        // Accountì˜ Contact ì´ë©”ì¼ ì¡°íšŒ
        try {
            List<Contact> contacts = [
                SELECT Email 
                FROM Contact 
                WHERE AccountId = :notification.PaymentStatus__r.Order__r.Account.Id 
                AND Email != null 
                ORDER BY CreatedDate ASC 
                LIMIT 1
            ];
            
            if (!contacts.isEmpty() && String.isNotBlank(contacts[0].Email)) {
                return contacts[0].Email;
            }
        } catch (Exception e) {
            System.debug('ê³ ê° ì´ë©”ì¼ ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage());
        }
        
        return null;
    }
    
    /**
     * ì´ë©”ì¼ ë©”ì‹œì§€ ìƒì„± (ê³ ê°/ê´€ë¦¬ìë³„ êµ¬ë¶„)
     */
    private static Messaging.SingleEmailMessage createPaymentEmail(
        Payment_Notification__c notification, 
        String recipientEmail,
        String recipientType
    ) {
        Messaging.SingleEmailMessage email = new Messaging.SingleEmailMessage();
        email.setToAddresses(new String[]{ recipientEmail });
        
        // ì´ë©”ì¼ ì œëª©
        String subject = '';
        if (notification.NotificationType__c == 'ì˜ˆì • ì•Œë¦¼') {
            subject = '[ë‚©ë¶€ ì˜ˆì •] ' + notification.PaymentStatus__r.Installment_Number__c + 
                     'ì°¨ ë‚©ë¶€ ì˜ˆì •ì¼ ì•ˆë‚´';
        } else {
            subject = '[ë‚©ë¶€ ì—°ì²´] ' + notification.PaymentStatus__r.Installment_Number__c + 
                     'ì°¨ ë‚©ë¶€ ì—°ì²´ ì•ˆë‚´';
        }
        
        if (recipientType == 'Admin') {
            subject = '[ê´€ë¦¬ì] ' + subject;
        }
        
        email.setSubject(subject);
        
        // ì´ë©”ì¼ ë³¸ë¬¸
        String body = createEmailBody(notification, recipientType);
        email.setPlainTextBody(body);
        
        // PDF ì²¨ë¶€íŒŒì¼ ì¶”ê°€
        List<Messaging.EmailFileAttachment> attachments = getPDFAttachments(notification);
        if (!attachments.isEmpty()) {
            email.setFileAttachments(attachments);
        }
        
        return email;
    }
    
    /**
     * ì´ë©”ì¼ ë³¸ë¬¸ ìƒì„± (ê³ ê°/ê´€ë¦¬ìë³„ êµ¬ë¶„)
     */
    private static String createEmailBody(Payment_Notification__c notification, String recipientType) {
        String body = '';
        
        if (recipientType == 'Admin') {
            // ê´€ë¦¬ììš© ì´ë©”ì¼
            body = 'ë‚©ë¶€ ì•Œë¦¼ ì‹œìŠ¤í…œì—ì„œ ìë™ ë°œì†¡ëœ ê´€ë¦¬ì ì•Œë¦¼ì…ë‹ˆë‹¤.\n\n';
            body += 'ğŸ¢ ê³ ê°ì •ë³´\n';
            body += 'â€¢ ê³ ê°ëª…: ' + notification.PaymentStatus__r.Order__r.Account.Name + '\n';
            body += 'â€¢ ì£¼ë¬¸ë²ˆí˜¸: ' + notification.PaymentStatus__r.Order__r.OrderNumber + '\n\n';
            body += 'ğŸ’° ë‚©ë¶€ì •ë³´\n';
            body += 'â€¢ ë‚©ë¶€ íšŒì°¨: ' + notification.PaymentStatus__r.Installment_Number__c + 'ì°¨\n';
            body += 'â€¢ ë‚©ë¶€ ê¸ˆì•¡: â‚©' + notification.PaymentStatus__r.Amount__c.format() + '\n';
            body += 'â€¢ ë‚©ë¶€ ì˜ˆì •ì¼: ' + notification.PaymentStatus__r.DueDate__c.format() + '\n';
            
            if (notification.NotificationType__c == 'ì—°ì²´ ì•Œë¦¼') {
                Integer overdueDays = Date.today().daysBetween(notification.PaymentStatus__r.DueDate__c);
                body += 'â€¢ ì—°ì²´ ê¸°ê°„: ' + overdueDays + 'ì¼\n';
                body += '\nâš ï¸ ì—°ì²´ ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤. ê³ ê°ì—ê²Œ ì—°ë½í•˜ì—¬ ë‚©ë¶€ë¥¼ ì•ˆë‚´í•´ì£¼ì„¸ìš”.\n';
            } else {
                body += '\nğŸ“… 3ì¼ í›„ ë‚©ë¶€ ì˜ˆì •ì…ë‹ˆë‹¤. ê³ ê° ì‚¬ì „ ì•ˆë‚´ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.\n';
            }
            
            body += '\nSalesforceì—ì„œ ìƒì„¸ì •ë³´ë¥¼ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            
        } else {
            // ê³ ê°ìš© ì´ë©”ì¼
            body = 'ì•ˆë…•í•˜ì„¸ìš”, ' + notification.PaymentStatus__r.Order__r.Account.Name + ' ê³ ê°ë‹˜.\n\n';
            
            if (notification.NotificationType__c == 'ì˜ˆì • ì•Œë¦¼') {
                body += 'ë‹¤ê°€ì˜¤ëŠ” ë‚©ë¶€ ì˜ˆì •ì¼ì„ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.\n\n';
                body += 'ğŸ“‹ ë‚©ë¶€ ì •ë³´\n';
                body += 'â€¢ ì£¼ë¬¸ë²ˆí˜¸: ' + notification.PaymentStatus__r.Order__r.OrderNumber + '\n';
                body += 'â€¢ ë‚©ë¶€ íšŒì°¨: ' + notification.PaymentStatus__r.Installment_Number__c + 'ì°¨\n';
                body += 'â€¢ ë‚©ë¶€ ê¸ˆì•¡: â‚©' + notification.PaymentStatus__r.Amount__c.format() + '\n';
                body += 'â€¢ ë‚©ë¶€ ì˜ˆì •ì¼: ' + notification.PaymentStatus__r.DueDate__c.format() + '\n\n';
                body += 'ì›í™œí•œ ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•´ ë‚©ë¶€ ì˜ˆì •ì¼ì— ë§ì¶° ë‚©ë¶€í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.\n\n';
            } else {
                body += 'ë‚©ë¶€ ì—°ì²´ê°€ ë°œìƒí•˜ì—¬ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.\n\n';
                body += 'ğŸ“‹ ì—°ì²´ ì •ë³´\n';
                body += 'â€¢ ì£¼ë¬¸ë²ˆí˜¸: ' + notification.PaymentStatus__r.Order__r.OrderNumber + '\n';
                body += 'â€¢ ë‚©ë¶€ íšŒì°¨: ' + notification.PaymentStatus__r.Installment_Number__c + 'ì°¨\n';
                body += 'â€¢ ë‚©ë¶€ ê¸ˆì•¡: â‚©' + notification.PaymentStatus__r.Amount__c.format() + '\n';
                body += 'â€¢ ë‚©ë¶€ ì˜ˆì •ì¼: ' + notification.PaymentStatus__r.DueDate__c.format() + ' (ì—°ì²´)\n\n';
                body += 'ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ë‚©ë¶€í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.\n\n';
            }
            
            body += 'ğŸ“ ì²¨ë¶€ëœ PDF íŒŒì¼ì—ì„œ ìƒì„¸ ë‚´ì—­ì„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n';
            body += 'ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ê³ ê°ì„¼í„°(1588-0000)ë¡œ ì—°ë½ì£¼ì„¸ìš”.\n\n';
            body += 'ê°ì‚¬í•©ë‹ˆë‹¤.';
        }
        
        return body;
    }
    
    /**
     * ìŠ¬ë™ ë©”ì‹œì§€ ìƒì„±
     */
    private static String createSlackMessage(Payment_Notification__c notification) {
        Map<String, Object> slackPayload = new Map<String, Object>();
        
        String text = '';
        String color = '';
        
        if (notification.NotificationType__c == 'ì˜ˆì • ì•Œë¦¼') {
            text = ':bell: ë‚©ë¶€ ì˜ˆì • ì•Œë¦¼';
            color = '#36a64f'; // ë…¹ìƒ‰
        } else {
            text = ':warning: ë‚©ë¶€ ì—°ì²´ ì•Œë¦¼';
            color = '#ff0000'; // ë¹¨ê°„ìƒ‰
        }
        
        Map<String, Object> attachment = new Map<String, Object>();
        attachment.put('color', color);
        attachment.put('title', notification.PaymentStatus__r.Order__r.Account.Name + ' - ' + 
                              notification.PaymentStatus__r.Installment_Number__c + 'ì°¨');
        attachment.put('text', 'ë‚©ë¶€ê¸ˆì•¡: â‚©' + notification.PaymentStatus__r.Amount__c.format() + '\n' +
                              'ì˜ˆì •ì¼: ' + notification.PaymentStatus__r.DueDate__c.format());
        
        slackPayload.put('text', text);
        slackPayload.put('attachments', new List<Object>{ attachment });
        
        return JSON.serialize(slackPayload);
    }
    
    /**
     * ìŠ¬ë™ ì›¹í›… URL ì¡°íšŒ (Custom Settingì—ì„œ ê´€ë¦¬)
     */
    private static String getSlackWebhookUrl() {
        // Custom Settingì—ì„œ ìŠ¬ë™ ì›¹í›… URL ì¡°íšŒ
        // ì‹¤ì œ êµ¬í˜„ ì‹œ Custom Setting ìƒì„± í•„ìš”
        return 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK';
    }
    
    /**
     * ê´€ë¦¬ì ì´ë©”ì¼ ì£¼ì†Œ ëª©ë¡ ì¡°íšŒ
     */
    private static List<String> getAdminEmails(Payment_Notification__c notification) {
        List<String> adminEmails = new List<String>();
        
        try {
            // 1. Order Ownerì˜ ì´ë©”ì¼
            List<Order> orders = [
                SELECT OwnerId, Owner.Email 
                FROM Order 
                WHERE Id = :notification.PaymentStatus__r.Order__c 
                AND Owner.Email != null
                LIMIT 1
            ];
            
            if (!orders.isEmpty() && String.isNotBlank(orders[0].Owner.Email)) {
                adminEmails.add(orders[0].Owner.Email);
            }
            
            // 2. ì‹œìŠ¤í…œ ê´€ë¦¬ìë“¤ (Profile ê¸°ë°˜)
            List<User> adminUsers = [
                SELECT Email 
                FROM User 
                WHERE Profile.Name IN ('ì‹œìŠ¤í…œ ê´€ë¦¬ì', 'System Administrator') 
                AND IsActive = true 
                AND Email != null
                LIMIT 5
            ];
            
            for (User admin : adminUsers) {
                if (!adminEmails.contains(admin.Email)) {
                    adminEmails.add(admin.Email);
                }
            }
            
            // 3. ê³ ì • ê´€ë¦¬ì ì´ë©”ì¼ (ì„¤ì •ì—ì„œ ê´€ë¦¬)
            String fixedAdminEmail = 'eetd0000@gmail.com';
            if (!adminEmails.contains(fixedAdminEmail)) {
                adminEmails.add(fixedAdminEmail);
            }
            
        } catch (Exception e) {
            System.debug('ê´€ë¦¬ì ì´ë©”ì¼ ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage());
        }
        
        return adminEmails;
    }
    
    /**
     * Custom Notification ìˆ˜ì‹ ì ì¡°íšŒ
     */
    private static Set<String> getNotificationRecipients(Payment_Notification__c notification) {
        Set<String> recipientIds = new Set<String>();
        
        try {
            // 1. í˜„ì¬ ì‚¬ìš©ì
            recipientIds.add(UserInfo.getUserId());
            
            // 2. Order Owner
            List<Order> orders = [
                SELECT OwnerId 
                FROM Order 
                WHERE Id = :notification.PaymentStatus__r.Order__c
                LIMIT 1
            ];
            
            if (!orders.isEmpty()) {
                recipientIds.add(orders[0].OwnerId);
            }
            
            // 3. ì‹œìŠ¤í…œ ê´€ë¦¬ìë“¤
            List<User> adminUsers = [
                SELECT Id 
                FROM User 
                WHERE Profile.Name IN ('ì‹œìŠ¤í…œ ê´€ë¦¬ì', 'System Administrator') 
                AND IsActive = true
                LIMIT 5
            ];
            
            for (User admin : adminUsers) {
                recipientIds.add(admin.Id);
            }
            
        } catch (Exception e) {
            System.debug('Notification ìˆ˜ì‹ ì ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage());
        }
        
        return recipientIds;
    }
    
    /**
     * Custom Notification Type ìƒì„±
     */
    private static Id createCustomNotificationType() {
        try {
            // Custom Notification Typeì€ Setupì—ì„œ ìˆ˜ë™ ìƒì„± í•„ìš”
            // ì—¬ê¸°ì„œëŠ” ì¡°íšŒë§Œ ì¬ì‹œë„
            List<CustomNotificationType> types = [
                SELECT Id FROM CustomNotificationType 
                WHERE DeveloperName = 'Payment_Notification'
                LIMIT 1
            ];
            
            return types.isEmpty() ? null : types[0].Id;
            
        } catch (Exception e) {
            System.debug('CustomNotificationType ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage());
            return null;
        }
    }
    
    /**
     * PDF ì²¨ë¶€íŒŒì¼ ì¡°íšŒ (Notes & Attachmentsì—ì„œ ìµœì‹  ë‚©ë¶€ì¼ì •ì„œ íŒŒì¼)
     */
    private static List<Messaging.EmailFileAttachment> getPDFAttachments(Payment_Notification__c notification) {
        List<Messaging.EmailFileAttachment> attachments = new List<Messaging.EmailFileAttachment>();
        
        try {
            // 1ì°¨: ë‚©ë¶€ì¼ì •ì„œ ìš°ì„  ê²€ìƒ‰
            List<ContentDocumentLink> paymentScheduleDocs = [
                SELECT ContentDocument.Id, ContentDocument.Title, ContentDocument.FileExtension,
                       ContentDocument.CreatedDate
                FROM ContentDocumentLink 
                WHERE LinkedEntityId = :notification.PaymentStatus__r.Order__c
                AND ContentDocument.FileExtension = 'pdf'
                AND (ContentDocument.Title LIKE '%ë‚©ë¶€ì¼ì •ì„œ%' 
                     OR ContentDocument.Title LIKE '%payment%schedule%'
                     OR ContentDocument.Title LIKE '%ì¼ì •%')
                ORDER BY ContentDocument.CreatedDate DESC
                LIMIT 1
            ];
            
            ContentDocumentLink selectedPDF = null;
            
            if (!paymentScheduleDocs.isEmpty()) {
                selectedPDF = paymentScheduleDocs[0];
                System.debug('ğŸ“ ë‚©ë¶€ì¼ì •ì„œ PDF ë°œê²¬: ' + selectedPDF.ContentDocument.Title + '.pdf');
            } else {
                // 2ì°¨: ì¼ë°˜ PDF íŒŒì¼ ê²€ìƒ‰
                List<ContentDocumentLink> generalPDFs = [
                    SELECT ContentDocument.Id, ContentDocument.Title, ContentDocument.FileExtension,
                           ContentDocument.CreatedDate
                    FROM ContentDocumentLink 
                    WHERE LinkedEntityId = :notification.PaymentStatus__r.Order__c
                    AND ContentDocument.FileExtension = 'pdf'
                    ORDER BY ContentDocument.CreatedDate DESC
                    LIMIT 1
                ];
                
                if (!generalPDFs.isEmpty()) {
                    selectedPDF = generalPDFs[0];
                    System.debug('ğŸ“ ì¼ë°˜ PDF ë°œê²¬: ' + selectedPDF.ContentDocument.Title + '.pdf');
                }
            }
            
            if (selectedPDF != null) {
                // ContentVersion ì¡°íšŒ
                List<ContentVersion> contentVersions = [
                    SELECT Title, VersionData, ContentSize, Description
                    FROM ContentVersion 
                    WHERE ContentDocumentId = :selectedPDF.ContentDocument.Id
                    AND IsLatest = true
                    LIMIT 1
                ];
                
                if (!contentVersions.isEmpty()) {
                    ContentVersion cv = contentVersions[0];
                    
                    // íŒŒì¼ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
                    if (cv.VersionData != null && cv.VersionData.size() > 0) {
                        Messaging.EmailFileAttachment attachment = new Messaging.EmailFileAttachment();
                        attachment.setFileName(cv.Title + '.pdf');
                        attachment.setBody(cv.VersionData);
                        attachment.setContentType('application/pdf');
                        attachments.add(attachment);
                        
                        System.debug('âœ… PDF ì²¨ë¶€íŒŒì¼ ì¶”ê°€ ì„±ê³µ: ' + cv.Title + '.pdf');
                        System.debug('   íŒŒì¼ í¬ê¸°: ' + (cv.ContentSize / 1024) + 'KB');
                        System.debug('   ì„¤ëª…: ' + cv.Description);
                    } else {
                        System.debug('âš ï¸ PDF íŒŒì¼ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤: ' + cv.Title);
                        
                        // ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ìƒˆë¡œìš´ ë‚©ë¶€ì¼ì •ì„œ PDF ìƒì„±
                        ContentVersion newPDF = createPaymentSchedulePDF(notification);
                        if (newPDF != null) {
                            Messaging.EmailFileAttachment attachment = new Messaging.EmailFileAttachment();
                            attachment.setFileName(newPDF.Title + '.pdf');
                            attachment.setBody(newPDF.VersionData);
                            attachment.setContentType('application/pdf');
                            attachments.add(attachment);
                            
                            System.debug('âœ… ìƒˆ ë‚©ë¶€ì¼ì •ì„œ PDF ì²¨ë¶€: ' + newPDF.Title + '.pdf');
                        }
                    }
                }
            } else {
                System.debug('ğŸ“„ Orderì— ì—°ê²°ëœ PDF íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ë‚©ë¶€ì¼ì •ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.');
                
                // PDF íŒŒì¼ì´ ì—†ëŠ” ê²½ìš° ìƒˆë¡œìš´ ë‚©ë¶€ì¼ì •ì„œ PDF ìƒì„±
                ContentVersion newPDF = createPaymentSchedulePDF(notification);
                if (newPDF != null) {
                    Messaging.EmailFileAttachment attachment = new Messaging.EmailFileAttachment();
                    attachment.setFileName(newPDF.Title + '.pdf');
                    attachment.setBody(newPDF.VersionData);
                    attachment.setContentType('application/pdf');
                    attachments.add(attachment);
                    
                    System.debug('âœ… ìƒˆ ë‚©ë¶€ì¼ì •ì„œ PDF ìƒì„± ë° ì²¨ë¶€: ' + newPDF.Title + '.pdf');
                }
            }
            
        } catch (Exception e) {
            System.debug('âŒ PDF ì²¨ë¶€íŒŒì¼ ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage());
        }
        
        return attachments;
    }
    
    /**
     * ë‚©ë¶€ì¼ì •ì„œ PDF ìƒì„±
     */
    private static ContentVersion createPaymentSchedulePDF(Payment_Notification__c notification) {
        try {
            // PaymentStatus ëª©ë¡ ì¡°íšŒ
            List<PaymentStatus__c> paymentList = [
                SELECT Installment_Number__c, Amount__c, DueDate__c, Status__c
                FROM PaymentStatus__c 
                WHERE Order__c = :notification.PaymentStatus__r.Order__c
                ORDER BY Installment_Number__c ASC
            ];
            
            // PDF ë‚´ìš© ìƒì„±
            String pdfContent = '%PDF-1.4\n';
            pdfContent += '1 0 obj\n<<\n/Type /Catalog\n/Pages 2 0 R\n>>\nendobj\n\n';
            pdfContent += '2 0 obj\n<<\n/Type /Pages\n/Kids [3 0 R]\n/Count 1\n>>\nendobj\n\n';
            pdfContent += '3 0 obj\n<<\n/Type /Page\n/Parent 2 0 R\n/MediaBox [0 0 612 792]\n/Contents 4 0 R\n>>\nendobj\n\n';
            
            String contentStream = 'BT\n/F1 14 Tf\n100 720 Td\n';
            contentStream += '(ë‚©ë¶€ì¼ì •ì„œ - Order: ' + notification.PaymentStatus__r.Order__r.OrderNumber + ') Tj\n';
            contentStream += '0 -25 Td\n(ê³ ê°ëª…: ' + notification.PaymentStatus__r.Order__r.Account.Name + ') Tj\n';
            contentStream += '0 -20 Td\n(ìƒì„±ì¼: ' + Date.today().format() + ') Tj\n';
            contentStream += '0 -30 Td\n';
            
            // ë‚©ë¶€ ì¼ì • ëª©ë¡ ì¶”ê°€
            Integer yPosition = -20;
            for (PaymentStatus__c payment : paymentList) {
                String statusText = payment.Status__c == 'ì™„ë‚©' ? 'ì™„ë‚©' : 'ì˜ˆì •';
                String paymentLine = '(' + payment.Installment_Number__c + 'ì°¨: â‚©' + 
                                   payment.Amount__c.format() + ' - ' + 
                                   payment.DueDate__c.format() + ' ' + statusText + ') Tj\n';
                contentStream += '0 ' + yPosition + ' Td\n' + paymentLine;
            }
            
            contentStream += 'ET\n';
            
            Integer contentLength = contentStream.length();
            pdfContent += '4 0 obj\n<<\n/Length ' + contentLength + '\n>>\nstream\n';
            pdfContent += contentStream;
            pdfContent += 'endstream\nendobj\n\n';
            pdfContent += 'xref\n0 5\n0000000000 65535 f \n0000000009 00000 n \n0000000058 00000 n \n';
            pdfContent += '0000000115 00000 n \n0000000204 00000 n \ntrailer\n<<\n/Size 5\n/Root 1 0 R\n>>\n';
            pdfContent += 'startxref\n' + (300 + contentLength) + '\n%%EOF';
            
            // ContentVersion ìƒì„± ë° ë°˜í™˜ (ì €ì¥í•˜ì§€ ì•Šê³  ë©”ëª¨ë¦¬ì—ì„œë§Œ ì‚¬ìš©)
            ContentVersion cv = new ContentVersion();
            cv.Title = 'ë‚©ë¶€ì¼ì •ì„œ_' + notification.PaymentStatus__r.Order__r.OrderNumber + '_' + DateTime.now().format('yyyyMMdd_HHmm');
            cv.VersionData = Blob.valueOf(pdfContent);
            
            return cv;
            
        } catch (Exception e) {
            System.debug('âŒ ë‚©ë¶€ì¼ì •ì„œ PDF ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
            return null;
        }
    }
}
