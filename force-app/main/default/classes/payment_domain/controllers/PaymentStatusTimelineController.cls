/**
 * @description       : 
 * @author            : JH Moon
 * @last modified on  : 07-14-2025
 * @last modified by  : JH Moon
**/
public with sharing class PaymentStatusTimelineController {
    
    @AuraEnabled(cacheable=true)
    public static PaymentTimelineWrapper getPaymentTimeline(Id orderId) {
        try {
            // Order ì •ë³´ ì¡°íšŒ
            Order orderInfo = [
                SELECT Id, OrderNumber, TotalAmount, EffectiveDate, Payment_Method__c, Account.Name
                FROM Order 
                WHERE Id = :orderId 
                LIMIT 1
            ];
            
            // PaymentStatus ëª©ë¡ ì¡°íšŒ
            List<PaymentStatus__c> paymentStatuses = [
                SELECT Id, Order__c, Amount__c, DueDate__c, Installment_Number__c, Status__c, PaidDate__c
                FROM PaymentStatus__c 
                WHERE Order__c = :orderId 
                ORDER BY Installment_Number__c ASC
            ];
            
            // ì§„í–‰ë¥  ê³„ì‚°
            Integer totalInstallments = paymentStatuses.size();
            Integer completedInstallments = 0;
            Integer overdueInstallments = 0;
            Date today = Date.today();
            
            for (PaymentStatus__c ps : paymentStatuses) {
                if (ps.Status__c == 'ì™„ë‚©') {
                    completedInstallments++;
                } else if (ps.DueDate__c != null && ps.DueDate__c < today) {
                    overdueInstallments++;
                }
            }
            
            Decimal progressPercentage = totalInstallments > 0 ? 
                (Decimal.valueOf(completedInstallments) / totalInstallments * 100).setScale(1) : 0;
            
            PaymentTimelineWrapper wrapper = new PaymentTimelineWrapper();
            wrapper.orderInfo = orderInfo;
            wrapper.paymentStatuses = paymentStatuses;
            wrapper.totalInstallments = totalInstallments;
            wrapper.completedInstallments = completedInstallments;
            wrapper.overdueInstallments = overdueInstallments;
            wrapper.progressPercentage = progressPercentage;
            
            return wrapper;
            
        } catch (Exception e) {
            throw new AuraHandledException('ë‚©ë¶€ ì¼ì •ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    @AuraEnabled
    public static String updatePaymentStatus(Id paymentStatusId, String newStatus) {
        try {
            PaymentStatus__c ps = new PaymentStatus__c(
                Id = paymentStatusId,
                Status__c = newStatus
            );
            
            // ì™„ë‚© ì²˜ë¦¬ ì‹œ ë‚©ë¶€ì¼ì ì„¤ì •, ë¯¸ë‚© ì²˜ë¦¬ ì‹œ ë‚©ë¶€ì¼ì ì œê±°
            if (newStatus == 'ì™„ë‚©') {
                ps.PaidDate__c = Date.today();
            } else {
                ps.PaidDate__c = null;
            }
            
            update ps;
            
            // íŠ¸ë¦¬ê±°ì—ì„œ Task ìƒì„±ì„ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì œê±°
            // checkOverdueAndCreateTasks(new List<Id>{paymentStatusId});
            
            return 'SUCCESS';
        } catch (Exception e) {
            throw new AuraHandledException('ë‚©ë¶€ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    @AuraEnabled
    public static String updateMultiplePaymentStatus(List<Id> paymentStatusIds, String newStatus) {
        try {
            List<PaymentStatus__c> paymentStatusesToUpdate = new List<PaymentStatus__c>();
            
            for (Id psId : paymentStatusIds) {
                paymentStatusesToUpdate.add(new PaymentStatus__c(
                    Id = psId,
                    Status__c = newStatus
                ));
            }
            
            if (!paymentStatusesToUpdate.isEmpty()) {
                update paymentStatusesToUpdate;
            }
            
            return 'SUCCESS';
        } catch (Exception e) {
            throw new AuraHandledException('ë‚©ë¶€ ìƒíƒœ ì¼ê´„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    @AuraEnabled
    public static String generatePaymentSchedulePDF(Id orderId) {
        try {
            // Order ì •ë³´ ì¡°íšŒ (OrderItem í¬í•¨)
            Order orderInfo = [
                SELECT Id, OrderNumber, Account.Name, AccountId, TotalAmount,
                       (SELECT Id, Product2Id, Product2.Name, Quantity, UnitPrice, TotalPrice 
                        FROM OrderItems)
                FROM Order 
                WHERE Id = :orderId 
                LIMIT 1
            ];
            
            // 1. ë‚©ë¶€í™•ì¸ì„œ PDF ìƒì„±
            PageReference paymentPdfPage = Page.PaymentSchedule_PDF;
            paymentPdfPage.getParameters().put('orderId', orderId);
            Blob paymentPdfBlob = paymentPdfPage.getContentAsPDF();
            
            // ë‚©ë¶€í™•ì¸ì„œ ì²¨ë¶€íŒŒì¼ ìƒì„±
            ContentVersion paymentPdf = new ContentVersion();
            paymentPdf.Title = 'ë‚©ë¶€í™•ì¸ì„œ_' + orderInfo.OrderNumber + '_' + String.valueOf(System.now()).replace(' ', '_').replace(':', '');
            paymentPdf.PathOnClient = paymentPdf.Title + '.pdf';
            paymentPdf.VersionData = paymentPdfBlob;
            paymentPdf.FirstPublishLocationId = orderId;
            paymentPdf.ContentLocation = 'S';
            
            // 2. ì„¸ê¸ˆê³„ì‚°ì„œ PDF ìƒì„±
            ContentVersion taxInvoicePdf = generateTaxInvoicePDF(orderInfo);
            
            // 3. Asset ìƒì„± ë° Order ì—°ê²° (PDF ì €ì¥ ì „ì— ë¨¼ì € ìƒì„±)
            Asset orderAsset = createAssetForOrder(orderInfo);
            
            // PDF íŒŒì¼ë“¤ ì €ì¥
            List<ContentVersion> pdfsToInsert = new List<ContentVersion>{paymentPdf, taxInvoicePdf};
            insert pdfsToInsert;
            
            // 4. Assetì— PDF ì²¨ë¶€ (ì €ì¥ëœ PDFë¥¼ Assetì— ì—°ê²°)
            attachPDFsToAsset(orderAsset.Id, pdfsToInsert);
            
            // PDF ìƒì„± ê´€ë ¨ Task ìƒì„±
            createPDFGenerationTask(orderId, orderInfo.OrderNumber, paymentPdf.Title + ', ' + taxInvoicePdf.Title);
            
            // Asset ìƒì„± ê´€ë ¨ Task ìƒì„±
            createAssetCreationTask(orderId, orderInfo.OrderNumber, orderAsset.Id);
            
            return paymentPdf.Id;
        } catch (Exception e) {
            throw new AuraHandledException('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    /**
     * ì„¸ê¸ˆê³„ì‚°ì„œ PDF ìƒì„± (í•œêµ­ í‘œì¤€ ì–‘ì‹)
     */
    private static ContentVersion generateTaxInvoicePDF(Order orderInfo) {
        try {
            // OrderItem ê¸°ë°˜ ì„¸ê¸ˆ ê³„ì‚°
            Decimal totalAmount = 0;
            Decimal vatAmount = 0;
            Decimal supplyAmount = 0;
            
            if (!orderInfo.OrderItems.isEmpty()) {
                for (OrderItem item : orderInfo.OrderItems) {
                    totalAmount += item.TotalPrice;
                }
                // ë¶€ê°€ì„¸ 10% ê³„ì‚°
                supplyAmount = totalAmount / 1.1;
                vatAmount = totalAmount - supplyAmount;
            } else {
                // OrderItemì´ ì—†ëŠ” ê²½ìš° Order.TotalAmount ì‚¬ìš©
                totalAmount = orderInfo.TotalAmount != null ? orderInfo.TotalAmount : 0;
                supplyAmount = totalAmount / 1.1;
                vatAmount = totalAmount - supplyAmount;
            }
            
            // í•œêµ­ í‘œì¤€ ì„¸ê¸ˆê³„ì‚°ì„œ Visualforce í˜ì´ì§€ ì‚¬ìš©
            PageReference taxInvoicePage = Page.TaxInvoice_PDF;
            taxInvoicePage.getParameters().put('orderId', orderInfo.Id);
            Blob taxInvoiceBlob = taxInvoicePage.getContentAsPDF();
            
            // ContentVersion ìƒì„±
            ContentVersion taxPdf = new ContentVersion();
            taxPdf.Title = 'ì„¸ê¸ˆê³„ì‚°ì„œ_' + orderInfo.OrderNumber + '_' + String.valueOf(System.now()).replace(' ', '_').replace(':', '');
            taxPdf.PathOnClient = taxPdf.Title + '.pdf';
            taxPdf.VersionData = taxInvoiceBlob;
            taxPdf.FirstPublishLocationId = orderInfo.Id;
            taxPdf.ContentLocation = 'S';
            
            return taxPdf;
            
        } catch (Exception e) {
            System.debug('ì„¸ê¸ˆê³„ì‚°ì„œ ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
            // ê¸°ë³¸ ì„¸ê¸ˆê³„ì‚°ì„œ ë°˜í™˜ (fallback)
            ContentVersion defaultTaxPdf = new ContentVersion();
            defaultTaxPdf.Title = 'ì„¸ê¸ˆê³„ì‚°ì„œ_' + orderInfo.OrderNumber + '_' + String.valueOf(System.now()).replace(' ', '_').replace(':', '');
            defaultTaxPdf.PathOnClient = defaultTaxPdf.Title + '.pdf';
            defaultTaxPdf.VersionData = Blob.valueOf('ì„¸ê¸ˆê³„ì‚°ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê³ ê°ì„¼í„°ë¡œ ë¬¸ì˜í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.');
            defaultTaxPdf.FirstPublishLocationId = orderInfo.Id;
            defaultTaxPdf.ContentLocation = 'S';
            return defaultTaxPdf;
        }
    }
    
    /**
     * ì™„ë‚© ì²˜ë¦¬ ë©”ì„œë“œ (í…ŒìŠ¤íŠ¸ìš©)
     */
    @AuraEnabled
    public static String markAllPaymentsAsCompleted(Id orderId) {
        try {
            // í•´ë‹¹ Orderì˜ ëª¨ë“  PaymentStatusë¥¼ ì™„ë‚©ìœ¼ë¡œ ë³€ê²½
            List<PaymentStatus__c> paymentStatuses = [
                SELECT Id, Status__c, Installment_Number__c
                FROM PaymentStatus__c
                WHERE Order__c = :orderId
                AND Status__c != 'ì™„ë‚©'
            ];
            
            if (paymentStatuses.isEmpty()) {
                return 'SUCCESS: ì´ë¯¸ ëª¨ë“  ë‚©ë¶€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            }
            
            for (PaymentStatus__c payment : paymentStatuses) {
                payment.Status__c = 'ì™„ë‚©';
                payment.PaidDate__c = Date.today();
            }
            
            update paymentStatuses;
            
            // ì™„ë‚© ì²˜ë¦¬ Task ìƒì„±
            createCompletedPaymentTasks(paymentStatuses);
            
            return 'SUCCESS: ' + paymentStatuses.size() + 'ê°œì˜ ë‚©ë¶€ í•­ëª©ì´ ì™„ë‚©ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.';
            
        } catch (Exception e) {
            throw new AuraHandledException('ì™„ë‚© ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }

    /**
     * ì™„ë‚© ì²˜ë¦¬ëœ ë‚©ë¶€ì— ëŒ€í•œ Task ìƒì„±
     */
    private static void createCompletedPaymentTasks(List<PaymentStatus__c> completedPayments) {
        try {
            List<Task> tasksToCreate = new List<Task>();
            
            for (PaymentStatus__c payment : completedPayments) {
                Task newTask = new Task(
                    Subject = payment.Installment_Number__c + 'íšŒì°¨ ë‚©ë¶€ ì™„ë£Œ',
                    Status = 'Completed',
                    Priority = 'Normal',
                    WhatId = payment.Id
                );
                tasksToCreate.add(newTask);
            }
            
            if (!tasksToCreate.isEmpty()) {
                insert tasksToCreate;
            }
        } catch (Exception e) {
            throw new AuraHandledException('Task ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }

    @AuraEnabled
    public static String sendPaymentNotificationEmail(Id orderId, String emailAddress) {
        try {
            // Order ì •ë³´ ì¡°íšŒ
            Order orderInfo = [
                SELECT Id, OrderNumber, Account.Name, TotalAmount
                FROM Order 
                WHERE Id = :orderId 
                LIMIT 1
            ];
            
            // PaymentStatus ì¡°íšŒ
            List<PaymentStatus__c> paymentStatuses = [
                SELECT Id, Amount__c, DueDate__c, Installment_Number__c, Status__c
                FROM PaymentStatus__c 
                WHERE Order__c = :orderId AND Status__c = 'ë¯¸ë‚©'
                ORDER BY Installment_Number__c ASC
            ];
            
            // ì´ë©”ì¼ ë°œì†¡
            Messaging.SingleEmailMessage email = new Messaging.SingleEmailMessage();
            email.setToAddresses(new String[] { emailAddress });
            email.setSubject('[' + orderInfo.OrderNumber + '] ë‚©ë¶€ ì¼ì • ì•ˆë‚´');
            
            // HTML ì´ë©”ì¼ ë³¸ë¬¸ ìƒì„±
            String emailBody = generateEmailBody(orderInfo, paymentStatuses);
            email.setHtmlBody(emailBody);
            
            // PDF ì²¨ë¶€
            try {
                PageReference pdfPage = Page.PaymentSchedule_PDF;
                pdfPage.getParameters().put('orderId', orderId);
                Blob pdfBlob = pdfPage.getContentAsPDF();
                
                Messaging.EmailFileAttachment attachment = new Messaging.EmailFileAttachment();
                attachment.setFileName('ë‚©ë¶€ì¼ì •ì„œ.pdf');
                attachment.setBody(pdfBlob);
                attachment.setContentType('application/pdf');
                
                email.setFileAttachments(new Messaging.EmailFileAttachment[] { attachment });
            } catch (Exception pdfEx) {
                System.debug('PDF ì²¨ë¶€ ì‹¤íŒ¨: ' + pdfEx.getMessage());
            }
            
            Messaging.sendEmail(new Messaging.SingleEmailMessage[] { email });
            
            return 'EMAIL_SENT_SUCCESS';
        } catch (Exception e) {
            throw new AuraHandledException('ì´ë©”ì¼ ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    private static String generateEmailBody(Order orderInfo, List<PaymentStatus__c> paymentStatuses) {
        String body = '<html><body>';
        body += '<h2>ë‚©ë¶€ ì¼ì • ì•ˆë‚´</h2>';
        body += '<p>ì•ˆë…•í•˜ì„¸ìš”, ' + orderInfo.Account.Name + ' ê³ ê°ë‹˜</p>';
        body += '<p>ì£¼ë¬¸ë²ˆí˜¸ <strong>' + orderInfo.OrderNumber + '</strong>ì— ëŒ€í•œ ë‚©ë¶€ ì¼ì •ì„ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.</p>';
        
        if (!paymentStatuses.isEmpty()) {
            body += '<h3>ë¯¸ë‚© ë‚´ì—­</h3>';
            body += '<table border="1" style="border-collapse: collapse; width: 100%;">';
            body += '<tr style="background-color: #f0f0f0;"><th>íšŒì°¨</th><th>ë‚©ë¶€ ì˜ˆì •ì¼</th><th>ë‚©ë¶€ ê¸ˆì•¡</th></tr>';
            
            for (PaymentStatus__c ps : paymentStatuses) {
                body += '<tr>';
                body += '<td style="text-align: center;">' + ps.Installment_Number__c + '</td>';
                body += '<td style="text-align: center;">' + ps.DueDate__c + '</td>';
                body += '<td style="text-align: right;">' + String.valueOf(ps.Amount__c) + 'ì›</td>';
                body += '</tr>';
            }
            
            body += '</table>';
        }
        
        body += '<p>ìì„¸í•œ ë‚´ìš©ì€ ì²¨ë¶€ëœ ë‚©ë¶€ì¼ì •ì„œë¥¼ í™•ì¸í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>';
        body += '<p>ê°ì‚¬í•©ë‹ˆë‹¤.</p>';
        body += '</body></html>';
        
        return body;
    }
    
    // ì—°ì²´ ì²´í¬ ë° Task ìƒì„± ë©”ì„œë“œ
    @AuraEnabled
    public static void checkOverdueAndCreateTasks(List<Id> paymentStatusIds) {
        try {
            List<PaymentStatus__c> paymentStatuses = [
                SELECT Id, Order__c, Order__r.OrderNumber, Order__r.Account.Name, 
                       Amount__c, DueDate__c, Installment_Number__c, Status__c, PaidDate__c
                FROM PaymentStatus__c 
                WHERE Id IN :paymentStatusIds
            ];
            
            Date today = Date.today();
            List<Task> tasksToCreate = new List<Task>();
            Set<String> subjectsToCheck = new Set<String>();
            
            // ë¨¼ì € ìƒì„±í•  Task Subjectë“¤ì„ ìˆ˜ì§‘
            for (PaymentStatus__c ps : paymentStatuses) {
                // ì—°ì²´ ìƒí™© ì²´í¬
                if (ps.DueDate__c != null && ps.DueDate__c < today && ps.Status__c == 'ë¯¸ë‚©') {
                    subjectsToCheck.add('ì—°ì²´ ì•Œë¦¼ - ' + ps.Order__r.OrderNumber + ' ' + ps.Installment_Number__c + 'ì°¨');
                }
                
                // ì™„ë‚© ì²˜ë¦¬ ì‹œ ì™„ë£Œ Task ìƒì„±
                if (ps.Status__c == 'ì™„ë‚©' && ps.PaidDate__c == Date.today()) {
                    subjectsToCheck.add('ë‚©ë¶€ ì™„ë£Œ - ' + ps.Order__r.OrderNumber + ' ' + ps.Installment_Number__c + 'ì°¨');
                }
            }
            
            // ì˜¤ëŠ˜ ìƒì„±ëœ ë™ì¼í•œ Subjectì˜ Taskê°€ ìˆëŠ”ì§€ í™•ì¸
            Set<String> existingSubjects = new Set<String>();
            if (!subjectsToCheck.isEmpty()) {
                List<Task> existingTasks = [
                    SELECT Subject FROM Task 
                    WHERE Subject IN :subjectsToCheck 
                    AND CreatedDate = TODAY
                ];
                
                for (Task t : existingTasks) {
                    existingSubjects.add(t.Subject);
                }
            }
            
            // ì¤‘ë³µë˜ì§€ ì•Šì€ Taskë§Œ ìƒì„±
            for (PaymentStatus__c ps : paymentStatuses) {
                // ì—°ì²´ ìƒí™© ì²´í¬ (ë‚©ë¶€ ê¸°ì¼ì´ ì§€ë‚¬ëŠ”ë° ë¯¸ë‚© ìƒíƒœ)
                if (ps.DueDate__c != null && ps.DueDate__c < today && ps.Status__c == 'ë¯¸ë‚©') {
                    String overdueSubject = 'ì—°ì²´ ì•Œë¦¼ - ' + ps.Order__r.OrderNumber + ' ' + ps.Installment_Number__c + 'ì°¨';
                    
                    if (!existingSubjects.contains(overdueSubject)) {
                        Integer overdueDays = today.daysBetween(ps.DueDate__c);
                        
                        Task overdueTask = new Task();
                        overdueTask.Subject = overdueSubject;
                        overdueTask.Description = buildOverdueTaskDescription(ps, overdueDays);
                        overdueTask.WhatId = ps.Order__c; // Orderì™€ ì—°ê²°
                        overdueTask.ActivityDate = Date.today();
                        overdueTask.Priority = 'High';
                        overdueTask.Status = 'Open';
                        overdueTask.Type = 'ì—°ì²´ ê´€ë¦¬';
                        
                        tasksToCreate.add(overdueTask);
                        existingSubjects.add(overdueSubject); // ì¤‘ë³µ ë°©ì§€ìš© ì¶”ê°€
                    }
                }
                
                // ì™„ë‚© ì²˜ë¦¬ ì‹œ ì™„ë£Œ Task ìƒì„±
                if (ps.Status__c == 'ì™„ë‚©' && ps.PaidDate__c == Date.today()) {
                    String completedSubject = 'ë‚©ë¶€ ì™„ë£Œ - ' + ps.Order__r.OrderNumber + ' ' + ps.Installment_Number__c + 'ì°¨';
                    
                    if (!existingSubjects.contains(completedSubject)) {
                        Task completedTask = new Task();
                        completedTask.Subject = completedSubject;
                        completedTask.Description = buildCompletedTaskDescription(ps);
                        completedTask.WhatId = ps.Order__c; // Orderì™€ ì—°ê²°
                        completedTask.ActivityDate = Date.today();
                        completedTask.Priority = 'Normal';
                        completedTask.Status = 'Completed';
                        completedTask.Type = 'ë‚©ë¶€ ê´€ë¦¬';
                        
                        tasksToCreate.add(completedTask);
                        existingSubjects.add(completedSubject); // ì¤‘ë³µ ë°©ì§€ìš© ì¶”ê°€
                    }
                }
            }
            
            if (!tasksToCreate.isEmpty()) {
                insert tasksToCreate;
            }
            
        } catch (Exception e) {
            System.debug('Task ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    // PDF ìƒì„± Task ìƒì„± ë©”ì„œë“œ
    private static void createPDFGenerationTask(Id orderId, String orderNumber, String pdfFileName) {
        try {
            Task pdfTask = new Task();
            pdfTask.Subject = 'PDF ìƒì„± ì™„ë£Œ - ' + orderNumber + ' ë‚©ë¶€í™•ì¸ì„œ';
            pdfTask.Description = buildPDFTaskDescription(orderNumber, pdfFileName);
            pdfTask.WhatId = orderId; // Orderì™€ ì—°ê²°
            pdfTask.ActivityDate = Date.today();
            pdfTask.Priority = 'Normal';
            pdfTask.Status = 'Completed';
            pdfTask.Type = 'ë¬¸ì„œ ê´€ë¦¬';
            
            insert pdfTask;
            
        } catch (Exception e) {
            System.debug('PDF Task ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    // ì—°ì²´ Task ì„¤ëª… ìƒì„±
    private static String buildOverdueTaskDescription(PaymentStatus__c ps, Integer overdueDays) {
        String description = 'ğŸš¨ ì—°ì²´ ì•Œë¦¼\n\n';
        description += 'ğŸ“‹ ì£¼ë¬¸ ì •ë³´:\n';
        description += 'â€¢ ì£¼ë¬¸ë²ˆí˜¸: ' + ps.Order__r.OrderNumber + '\n';
        description += 'â€¢ ê³ ê°ëª…: ' + ps.Order__r.Account.Name + '\n';
        description += 'â€¢ ë‚©ë¶€ íšŒì°¨: ' + ps.Installment_Number__c + 'ì°¨\n\n';
        
        description += 'ğŸ’° ì—°ì²´ ë‚´ì—­:\n';
        description += 'â€¢ ë‚©ë¶€ ì˜ˆì •ì¼: ' + ps.DueDate__c.format() + '\n';
        description += 'â€¢ ë‚©ë¶€ ê¸ˆì•¡: ' + String.valueOf(ps.Amount__c.format()) + 'ì›\n';
        description += 'â€¢ ì—°ì²´ ì¼ìˆ˜: ' + overdueDays + 'ì¼\n';
        description += 'â€¢ í˜„ì¬ ìƒíƒœ: ' + ps.Status__c + '\n\n';
        
        description += 'ğŸ“ í•„ìš” ì¡°ì¹˜:\n';
        description += 'â€¢ ê³ ê° ì—°ë½ ë° ë‚©ë¶€ ë…ì´‰\n';
        description += 'â€¢ ì—°ì²´ë£Œ ì‚°ì • ê²€í† \n';
        description += 'â€¢ ë‚©ë¶€ ê³„íš ì¬í˜‘ì˜ í•„ìš” ì‹œ í˜‘ì˜\n\n';
        
        description += 'â° ìƒì„±ì¼ì‹œ: ' + System.now().format('yyyy-MM-dd HH:mm:ss');
        
        return description;
    }
    
    // ì™„ë‚© Task ì„¤ëª… ìƒì„±
    private static String buildCompletedTaskDescription(PaymentStatus__c ps) {
        String description = 'âœ… ë‚©ë¶€ ì™„ë£Œ\n\n';
        description += 'ğŸ“‹ ì£¼ë¬¸ ì •ë³´:\n';
        description += 'â€¢ ì£¼ë¬¸ë²ˆí˜¸: ' + ps.Order__r.OrderNumber + '\n';
        description += 'â€¢ ê³ ê°ëª…: ' + ps.Order__r.Account.Name + '\n';
        description += 'â€¢ ë‚©ë¶€ íšŒì°¨: ' + ps.Installment_Number__c + 'ì°¨\n\n';
        
        description += 'ğŸ’° ë‚©ë¶€ ë‚´ì—­:\n';
        description += 'â€¢ ë‚©ë¶€ ì˜ˆì •ì¼: ' + ps.DueDate__c.format() + '\n';
        description += 'â€¢ ë‚©ë¶€ ì™„ë£Œì¼: ' + ps.PaidDate__c.format() + '\n';
        description += 'â€¢ ë‚©ë¶€ ê¸ˆì•¡: ' + String.valueOf(ps.Amount__c.format()) + 'ì›\n';
        description += 'â€¢ í˜„ì¬ ìƒíƒœ: ' + ps.Status__c + '\n\n';
        
        description += 'â° ì™„ë£Œì¼ì‹œ: ' + System.now().format('yyyy-MM-dd HH:mm:ss');
        
        return description;
    }
    
    // PDF ìƒì„± Task ì„¤ëª… ìƒì„±
    private static String buildPDFTaskDescription(String orderNumber, String pdfFileName) {
        String description = 'ğŸ“„ ë‚©ë¶€í™•ì¸ì„œ PDF ìƒì„± ì™„ë£Œ\n\n';
        description += 'ğŸ“‹ ìƒì„± ì •ë³´:\n';
        description += 'â€¢ ì£¼ë¬¸ë²ˆí˜¸: ' + orderNumber + '\n';
        description += 'â€¢ íŒŒì¼ëª…: ' + pdfFileName + '\n';
        description += 'â€¢ ìƒì„±ì¼ì‹œ: ' + System.now().format('yyyy-MM-dd HH:mm:ss') + '\n\n';
        
        description += 'ğŸ“ íŒŒì¼ ìœ„ì¹˜:\n';
        description += 'â€¢ Notes & Attachments ì„¹ì…˜ì—ì„œ í™•ì¸ ê°€ëŠ¥\n';
        description += 'â€¢ ê³ ê° ë°œì†¡ìš©ìœ¼ë¡œ í™œìš© ê°€ëŠ¥\n\n';
        
        description += 'ğŸ“ í›„ì† ì¡°ì¹˜:\n';
        description += 'â€¢ í•„ìš” ì‹œ ê³ ê°ì—ê²Œ ì´ë©”ì¼ ë°œì†¡\n';
        description += 'â€¢ ë‚©ë¶€ ì¼ì • ì•ˆë‚´ ë° í™•ì¸\n';
        
        return description;
    }
    
    // ìŠ¤ì¼€ì¤„ëŸ¬ìš© ì—°ì²´ ì²´í¬ ë©”ì„œë“œ (ì¼ì¼ ë°°ì¹˜ ì‹¤í–‰ìš©)
    @AuraEnabled
    public static void checkAllOverduePayments() {
        try {
            Date today = Date.today();
            
            // ì—°ì²´ëœ ëª¨ë“  PaymentStatus ì¡°íšŒ
            List<PaymentStatus__c> overduePayments = [
                SELECT Id, Order__c, Order__r.OrderNumber, Order__r.Account.Name,
                       Amount__c, DueDate__c, Installment_Number__c, Status__c
                FROM PaymentStatus__c 
                WHERE DueDate__c < :today 
                AND Status__c = 'ë¯¸ë‚©'
                ORDER BY DueDate__c ASC
                LIMIT 200
            ];
            
            if (!overduePayments.isEmpty()) {
                // ì˜¤ëŠ˜ ìƒì„±ëœ ì—°ì²´ ì•Œë¦¼ Task ì¡°íšŒ (ì¤‘ë³µ ë°©ì§€)
                Set<String> existingTaskSubjects = new Set<String>();
                List<Task> todayTasks = [
                    SELECT Subject FROM Task 
                    WHERE Subject LIKE '%ì—°ì²´ ì•Œë¦¼%' 
                    AND CreatedDate = TODAY
                ];
                
                for (Task t : todayTasks) {
                    existingTaskSubjects.add(t.Subject);
                }
                
                // ì¤‘ë³µë˜ì§€ ì•Šì€ PaymentStatusë§Œ ì²˜ë¦¬
                List<Id> overdueIds = new List<Id>();
                for (PaymentStatus__c ps : overduePayments) {
                    String expectedSubject = 'ì—°ì²´ ì•Œë¦¼ - ' + ps.Order__r.OrderNumber + ' ' + ps.Installment_Number__c + 'ì°¨';
                    if (!existingTaskSubjects.contains(expectedSubject)) {
                        overdueIds.add(ps.Id);
                    }
                }
                
                if (!overdueIds.isEmpty()) {
                    checkOverdueAndCreateTasks(overdueIds);
                }
            }
            
        } catch (Exception e) {
            System.debug('ì¼ê´„ ì—°ì²´ ì²´í¬ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    // Wrapper í´ë˜ìŠ¤
    public class PaymentTimelineWrapper {
        @AuraEnabled public Order orderInfo { get; set; }
        @AuraEnabled public List<PaymentStatus__c> paymentStatuses { get; set; }
        @AuraEnabled public Integer totalInstallments { get; set; }
        @AuraEnabled public Integer completedInstallments { get; set; }
        @AuraEnabled public Integer overdueInstallments { get; set; }
        @AuraEnabled public Decimal progressPercentage { get; set; }
    }
    
    // Helper method: Asset ìƒì„± ë° Order ì—°ê²°
    private static Asset createAssetForOrder(Order orderInfo) {
        try {
            // ê¸°ì¡´ Asset ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            List<Asset> existingAssets = [
                SELECT Id, Name 
                FROM Asset 
                WHERE Order__c = :orderInfo.Id 
                LIMIT 1
            ];
            
            if (!existingAssets.isEmpty()) {
                return existingAssets[0];
            }
            
            // ìƒˆ Asset ìƒì„±
            Asset orderAsset = new Asset();
            orderAsset.Name = 'Order ' + orderInfo.OrderNumber + ' Documents';
            orderAsset.AccountId = orderInfo.AccountId;
            orderAsset.Order__c = orderInfo.Id;
            orderAsset.Status = 'Installed';
            orderAsset.Description = 'Order ' + orderInfo.OrderNumber + 'ì˜ ìƒì„±ëœ ë¬¸ì„œë“¤ (ë‚©ë¶€í™•ì¸ì„œ, ì„¸ê¸ˆê³„ì‚°ì„œ)';
            orderAsset.SerialNumber = 'DOC-' + orderInfo.OrderNumber + '-' + String.valueOf(System.now().getTime());
            
            insert orderAsset;
            return orderAsset;
            
        } catch (Exception e) {
            System.debug('Asset ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
            throw new AuraHandledException('Asset ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    // Helper method: Assetì— PDF ì²¨ë¶€
    private static void attachPDFsToAsset(Id assetId, List<ContentVersion> pdfFiles) {
        try {
            // ContentVersionì—ì„œ ContentDocumentId ì¡°íšŒ
            List<ContentVersion> insertedPdfs = [
                SELECT Id, ContentDocumentId, Title
                FROM ContentVersion 
                WHERE Id IN :pdfFiles
            ];
            
            // Assetì— ContentDocument ì—°ê²°
            List<ContentDocumentLink> linksToInsert = new List<ContentDocumentLink>();
            
            for (ContentVersion pdf : insertedPdfs) {
                ContentDocumentLink link = new ContentDocumentLink();
                link.LinkedEntityId = assetId;
                link.ContentDocumentId = pdf.ContentDocumentId;
                link.ShareType = 'V';
                link.Visibility = 'AllUsers';
                linksToInsert.add(link);
            }
            
            if (!linksToInsert.isEmpty()) {
                insert linksToInsert;
                System.debug('PDF íŒŒì¼ë“¤ì´ Assetì— ì„±ê³µì ìœ¼ë¡œ ì²¨ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. Asset ID: ' + assetId);
            }
            
        } catch (Exception e) {
            System.debug('PDF Asset ì²¨ë¶€ ì˜¤ë¥˜: ' + e.getMessage());
            throw new AuraHandledException('PDFë¥¼ Assetì— ì²¨ë¶€í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    // Helper method: Asset ê´€ë ¨ Task ìƒì„±
    private static void createAssetCreationTask(Id orderId, String orderNumber, Id assetId) {
        try {
            Task assetTask = new Task();
            assetTask.Subject = 'Asset ìƒì„± ì™„ë£Œ - ' + orderNumber + ' ë¬¸ì„œ ê´€ë¦¬';
            assetTask.Description = buildAssetTaskDescription(orderNumber, assetId);
            assetTask.WhatId = orderId;
            assetTask.ActivityDate = Date.today();
            assetTask.Priority = 'Normal';
            assetTask.Status = 'Completed';
            assetTask.Type = 'Asset ê´€ë¦¬';
            
            insert assetTask;
            
        } catch (Exception e) {
            System.debug('Asset Task ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    // Asset Task ì„¤ëª… ìƒì„±
    private static String buildAssetTaskDescription(String orderNumber, Id assetId) {
        String description = 'ğŸ“¦ Asset ìƒì„± ë° ë¬¸ì„œ ì—°ê²° ì™„ë£Œ\n\n';
        description += 'ğŸ“‹ Asset ì •ë³´:\n';
        description += 'â€¢ ì£¼ë¬¸ë²ˆí˜¸: ' + orderNumber + '\n';
        description += 'â€¢ Asset ID: ' + assetId + '\n';
        description += 'â€¢ ìƒì„±ì¼ì‹œ: ' + System.now().format('yyyy-MM-dd HH:mm:ss') + '\n\n';
        
        description += 'ğŸ“„ ì²¨ë¶€ëœ ë¬¸ì„œ:\n';
        description += 'â€¢ ë‚©ë¶€í™•ì¸ì„œ PDF\n';
        description += 'â€¢ ì„¸ê¸ˆê³„ì‚°ì„œ PDF\n\n';
        
        description += 'ğŸ“ ë¬¸ì„œ ê´€ë¦¬:\n';
        description += 'â€¢ Assetì˜ Notes & Attachmentsì—ì„œ í™•ì¸ ê°€ëŠ¥\n';
        description += 'â€¢ Orderì™€ Assetì´ ì—°ê²°ë˜ì–´ í†µí•© ê´€ë¦¬ ê°€ëŠ¥\n';
        description += 'â€¢ ì¶”ê°€ ë¬¸ì„œ ì—…ë¡œë“œ ì‹œ ë™ì¼ Asset í™œìš©\n\n';
        
        description += 'ğŸ”— ê´€ë ¨ ê°ì²´:\n';
        description += 'â€¢ Order â†’ Asset â†’ ContentDocument êµ¬ì¡°ë¡œ ì—°ê²°\n';
        description += 'â€¢ ê³ ê°ë³„ ë¬¸ì„œ ì´ë ¥ ì¶”ì  ê°€ëŠ¥\n';
        
        return description;
    }

    /**
     * @description Assetê³¼ ì—°ê²°ëœ Payment History ì¡°íšŒ
     * @param assetId Asset ID
     * @return List<PaymentStatus__c> Payment íˆìŠ¤í† ë¦¬ ëª©ë¡
     */
    @AuraEnabled(cacheable=true)
    public static List<PaymentStatus__c> getPaymentHistory(Id assetId) {
        try {
            // Assetì—ì„œ Order ì¡°íšŒ
            Asset assetInfo = [
                SELECT Id, Order__c
                FROM Asset 
                WHERE Id = :assetId 
                LIMIT 1
            ];
            
            if (assetInfo.Order__c == null) {
                return new List<PaymentStatus__c>();
            }
            
            // Orderì™€ ì—°ê²°ëœ PaymentStatus ëª©ë¡ ì¡°íšŒ
            return [
                SELECT Id, Order__c, Amount__c, DueDate__c, Installment_Number__c, 
                       Status__c, PaidDate__c, CreatedDate, LastModifiedDate
                FROM PaymentStatus__c 
                WHERE Order__c = :assetInfo.Order__c 
                ORDER BY Installment_Number__c ASC
            ];
            
        } catch (Exception e) {
            System.debug('PaymentStatusTimelineController.getPaymentHistory Error: ' + e.getMessage());
            throw new AuraHandledException('Payment íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
}
