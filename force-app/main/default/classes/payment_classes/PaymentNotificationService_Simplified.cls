/**
 * Payment ì•Œë¦¼ ì„œë¹„ìŠ¤ (ê°„ì†Œí™” ë²„ì „)
 * Salesforce ì±„ë„ í†µí•©
 */
public with sharing class PaymentNotificationServiceSimplified {
    
    /**
     * Payment ì•Œë¦¼ ì²˜ë¦¬ (ë©”ì¸ ë©”ì„œë“œ)
     */
    public static void processNotification(Payment_Notification__c notification) {
        try {
            System.debug('ğŸ“§ Payment ì•Œë¦¼ ì²˜ë¦¬ ì‹œì‘: ' + notification.Id);
            
            // 1. Salesforce ì±„ë„ ì•Œë¦¼ (ìš°ì„ ìˆœìœ„)
            Boolean salesforceSuccess = sendSalesforceChannelNotification(notification);
            
            // 2. ì´ë©”ì¼ ì•Œë¦¼ (ê¸°ë³¸)
            Boolean emailSuccess = sendEmailNotification(notification);
            
            // 3. Chatter í¬ìŠ¤íŠ¸ (ë³´ì¡°)
            Boolean chatterSuccess = createChatterPost(notification);
            
            System.debug('âœ… ì•Œë¦¼ ì²˜ë¦¬ ì™„ë£Œ - Salesforce: ' + salesforceSuccess + 
                        ', Email: ' + emailSuccess + ', Chatter: ' + chatterSuccess);
            
        } catch(Exception e) {
            System.debug('âŒ Payment ì•Œë¦¼ ì²˜ë¦¬ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * Salesforce ì±„ë„ ì•Œë¦¼ ë°œì†¡
     */
    public static Boolean sendSalesforceChannelNotification(Payment_Notification__c notification) {
        try {
            // Order ì •ë³´ ì¡°íšŒ
            List<Order> orders = [
                SELECT Id, OrderNumber, Name
                FROM Order 
                WHERE Id = :notification.Order__c 
                LIMIT 1
            ];
            
            if(orders.isEmpty()) {
                System.debug('âŒ Orderë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + notification.Order__c);
                return false;
            }
            
            Order order = orders[0];
            
            // Salesforce ì±„ë„ ì°¾ê¸°
            List<CollaborationGroup> channels = [
                SELECT Id, Name FROM CollaborationGroup 
                WHERE Name LIKE :('%' + order.OrderNumber + '%')
                LIMIT 1
            ];
            
            if(channels.isEmpty()) {
                System.debug('âŒ Salesforce ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + order.OrderNumber);
                return false;
            }
            
            // ì±„ë„ì— ì•Œë¦¼ ë©”ì‹œì§€ ë°œì†¡
            String message = createChannelNotificationMessage(notification, order);
            
            SalesforceChannelService channelService = new SalesforceChannelService();
            Boolean success = channelService.sendChannelMessage(channels[0].Id, message);
            
            if(success) {
                System.debug('âœ… Salesforce ì±„ë„ ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ: ' + channels[0].Name);
            }
            
            return success;
            
        } catch(Exception e) {
            System.debug('âŒ Salesforce ì±„ë„ ì•Œë¦¼ ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
    }
    
    /**
     * ì±„ë„ ì•Œë¦¼ ë©”ì‹œì§€ ìƒì„±
     */
    private static String createChannelNotificationMessage(Payment_Notification__c notification, Order order) {
        String message = 'ğŸ’° Payment ì•Œë¦¼\n\n';
        message += 'ğŸ“‹ Order: ' + order.OrderNumber + '\n';
        message += 'ğŸ’³ ì•Œë¦¼ ìœ í˜•: ' + notification.Notification_Type__c + '\n';
        message += 'ğŸ’µ ê¸ˆì•¡: â‚©' + String.valueOf(notification.Amount__c?.setScale(0).format()) + '\n';
        message += 'ğŸ“… ì˜ˆì •ì¼: ' + (notification.Due_Date__c != null ? notification.Due_Date__c.format() : 'N/A') + '\n';
        message += 'âš ï¸ ìƒíƒœ: ' + notification.Status__c + '\n\n';
        
        if(notification.Notification_Type__c == 'Overdue') {
            message += 'ğŸš¨ ì—°ì²´ ì•Œë¦¼! ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\n';
        } else if(notification.Notification_Type__c == 'Reminder') {
            message += 'â° ë‚©ë¶€ ì˜ˆì •ì¼ì´ ë‹¤ê°€ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.\n';
        }
        
        message += '\nğŸ”— Order í™•ì¸: ' + System.URL.getOrgDomainUrl().toExternalForm() + 
                  '/lightning/r/Order/' + order.Id + '/view\n';
        message += 'ğŸ•’ ' + System.now().format('yyyy-MM-dd HH:mm:ss') + '\n\n';
        message += '#PaymentAlert #ê¸´ê¸‰í™•ì¸í•„ìš”';
        
        return message;
    }
    
    /**
     * ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡
     */
    public static Boolean sendEmailNotification(Payment_Notification__c notification) {
        try {
            // ê°„ì†Œí™”ëœ ì´ë©”ì¼ ë°œì†¡
            String customerEmail = getCustomerEmail(notification);
            
            if(String.isBlank(customerEmail)) {
                System.debug('âŒ ê³ ê° ì´ë©”ì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return false;
            }
            
            Messaging.SingleEmailMessage email = new Messaging.SingleEmailMessage();
            email.setToAddresses(new String[]{customerEmail});
            email.setSubject('Payment ì•Œë¦¼ - ' + notification.Notification_Type__c);
            email.setPlainTextBody('Payment ì•Œë¦¼ì…ë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ Salesforceì—ì„œ í™•ì¸í•˜ì„¸ìš”.');
            
            Messaging.sendEmail(new Messaging.SingleEmailMessage[]{email});
            
            System.debug('âœ… ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ: ' + customerEmail);
            return true;
            
        } catch(Exception e) {
            System.debug('âŒ ì´ë©”ì¼ ë°œì†¡ ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
    }
    
    /**
     * Chatter í¬ìŠ¤íŠ¸ ìƒì„±
     */
    public static Boolean createChatterPost(Payment_Notification__c notification) {
        try {
            FeedItem post = new FeedItem();
            post.ParentId = notification.Order__c;
            post.Body = 'ğŸ’° Payment ì•Œë¦¼: ' + notification.Notification_Type__c + 
                       ' (ê¸ˆì•¡: â‚©' + String.valueOf(notification.Amount__c?.setScale(0).format()) + ')';
            post.Type = 'TextPost';
            
            insert post;
            
            System.debug('âœ… Chatter í¬ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ');
            return true;
            
        } catch(Exception e) {
            System.debug('âŒ Chatter í¬ìŠ¤íŠ¸ ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
    }
    
    /**
     * ê³ ê° ì´ë©”ì¼ ì¡°íšŒ
     */
    private static String getCustomerEmail(Payment_Notification__c notification) {
        try {
            List<Order> orders = [
                SELECT Id, Account.PersonEmail, Contact.Email
                FROM Order 
                WHERE Id = :notification.Order__c 
                LIMIT 1
            ];
            
            if(!orders.isEmpty()) {
                Order order = orders[0];
                if(String.isNotBlank(order.Account.PersonEmail)) {
                    return order.Account.PersonEmail;
                } else if(String.isNotBlank(order.Contact.Email)) {
                    return order.Contact.Email;
                }
            }
            
            return null;
            
        } catch(Exception e) {
            System.debug('âŒ ê³ ê° ì´ë©”ì¼ ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage());
            return null;
        }
    }
}
