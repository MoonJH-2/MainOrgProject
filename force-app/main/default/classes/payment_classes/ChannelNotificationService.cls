/**
 * ê°„ì†Œí™”ëœ ì±„ë„ ì•Œë¦¼ ì„œë¹„ìŠ¤ (í‘œì¤€ ì˜¤ë¸Œì íŠ¸ë§Œ ì‚¬ìš©)
 * Task ì˜¤ë¸Œì íŠ¸ë¥¼ í™œìš©í•œ ì•Œë¦¼ ì‹œìŠ¤í…œ
 */
public with sharing class ChannelNotificationService {
    
    /**
     * Task ê¸°ë°˜ ì•Œë¦¼ ì²˜ë¦¬
     */
    public static void processTaskNotification(Task notificationTask) {
        try {
            System.debug('ğŸ“§ Task ì•Œë¦¼ ì²˜ë¦¬ ì‹œì‘: ' + notificationTask.Id);
            
            // 1. Salesforce ì±„ë„ ì•Œë¦¼ (ìš°ì„ ìˆœìœ„)
            Boolean salesforceSuccess = sendSalesforceChannelNotification(notificationTask);
            
            // 2. Chatter í¬ìŠ¤íŠ¸ (ê¸°ë³¸)
            Boolean chatterSuccess = createChatterPost(notificationTask);
            
            System.debug('âœ… ì•Œë¦¼ ì²˜ë¦¬ ì™„ë£Œ - Salesforce: ' + salesforceSuccess + 
                        ', Chatter: ' + chatterSuccess);
            
        } catch(Exception e) {
            System.debug('âŒ Task ì•Œë¦¼ ì²˜ë¦¬ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * Salesforce ì±„ë„ ì•Œë¦¼ ë°œì†¡ (Task ê¸°ë°˜)
     */
    public static Boolean sendSalesforceChannelNotification(Task notificationTask) {
        try {
            if(notificationTask.WhatId == null) {
                System.debug('âŒ Taskì— ê´€ë ¨ ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤');
                return false;
            }
            
            // Order ì •ë³´ ì¡°íšŒ
            List<Order> orders = [
                SELECT Id, OrderNumber, Name
                FROM Order 
                WHERE Id = :notificationTask.WhatId 
                LIMIT 1
            ];
            
            if(orders.isEmpty()) {
                System.debug('âŒ ê´€ë ¨ Orderë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + notificationTask.WhatId);
                return false;
            }
            
            Order order = orders[0];
            
            // Salesforce ì±„ë„ ì°¾ê¸°
            List<CollaborationGroup> channels = [
                SELECT Id, Name FROM CollaborationGroup 
                WHERE Name LIKE :('%' + order.OrderNumber + '%')
                LIMIT 1
            ];
            
            if(channels.isEmpty()) {
                System.debug('âŒ Salesforce ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + order.OrderNumber);
                return false;
            }
            
            // ì±„ë„ì— ì•Œë¦¼ ë©”ì‹œì§€ ë°œì†¡
            String message = createChannelNotificationMessage(notificationTask, order);
            
            // SimpleSalesforceChannelServiceì˜ static ë©”ì„œë“œ ì‚¬ìš©
            Boolean success = SimpleSalesforceChannelService.sendChannelMessage(channels[0].Id, message);
            
            if(success) {
                System.debug('âœ… Salesforce ì±„ë„ ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ: ' + channels[0].Name);
            }
            
            return success;
            
        } catch(Exception e) {
            System.debug('âŒ Salesforce ì±„ë„ ì•Œë¦¼ ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
    }
    
    /**
     * ì±„ë„ ì•Œë¦¼ ë©”ì‹œì§€ ìƒì„± (Task ê¸°ë°˜)
     */
    private static String createChannelNotificationMessage(Task notificationTask, Order order) {
        String message = 'ğŸ“‹ Task ì•Œë¦¼\n\n';
        message += 'ğŸ“‹ Order: ' + order.OrderNumber + '\n';
        message += 'ğŸ“ ì œëª©: ' + notificationTask.Subject + '\n';
        message += 'ğŸ“… ê¸°í•œ: ' + (notificationTask.ActivityDate != null ? notificationTask.ActivityDate.format() : 'N/A') + '\n';
        message += 'âš ï¸ ìš°ì„ ìˆœìœ„: ' + notificationTask.Priority + '\n';
        message += 'ğŸ“„ ì„¤ëª…: ' + (notificationTask.Description != null ? notificationTask.Description : '') + '\n\n';
        
        if(notificationTask.Subject?.contains('ì—°ì²´')) {
            message += 'ğŸš¨ ì—°ì²´ ì•Œë¦¼! ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\n';
        } else if(notificationTask.Subject?.contains('ì•Œë¦¼')) {
            message += 'â° ì¤‘ìš”í•œ ì•Œë¦¼ì´ ìˆìŠµë‹ˆë‹¤.\n';
        }
        
        message += '\nğŸ”— Order í™•ì¸: ' + System.URL.getOrgDomainUrl().toExternalForm() + 
                  '/lightning/r/Order/' + order.Id + '/view\n';
        message += 'ğŸ”— Task í™•ì¸: ' + System.URL.getOrgDomainUrl().toExternalForm() + 
                  '/lightning/r/Task/' + notificationTask.Id + '/view\n';
        message += 'ğŸ•’ ' + System.now().format('yyyy-MM-dd HH:mm:ss') + '\n\n';
        message += '#TaskAlert #ê¸´ê¸‰í™•ì¸í•„ìš”';
        
        return message;
    }
    
    /**
     * Chatter í¬ìŠ¤íŠ¸ ìƒì„± (Task ê¸°ë°˜)
     */
    public static Boolean createChatterPost(Task notificationTask) {
        try {
            if(notificationTask.WhatId == null) {
                System.debug('âŒ Taskì— ê´€ë ¨ ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤');
                return false;
            }
            
            FeedItem post = new FeedItem();
            post.ParentId = notificationTask.WhatId; // Orderì— í¬ìŠ¤íŠ¸
            post.Body = 'ğŸ“‹ Task ì•Œë¦¼: ' + notificationTask.Subject + 
                       ' (ê¸°í•œ: ' + (notificationTask.ActivityDate != null ? 
                       notificationTask.ActivityDate.format() : 'N/A') + ')';
            post.Type = 'TextPost';
            
            insert post;
            
            System.debug('âœ… Chatter í¬ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ');
            return true;
            
        } catch(Exception e) {
            System.debug('âŒ Chatter í¬ìŠ¤íŠ¸ ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
    }
}
