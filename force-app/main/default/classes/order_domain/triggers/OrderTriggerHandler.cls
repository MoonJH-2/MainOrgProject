/**
 * @description       : 
 * @author            : JH Moon
 * @last modified on  : 07-12-2025
 * @last modified by  : Hyowon Hong
**/
public with sharing class OrderTriggerHandler extends TriggerHandler {
    /** 
     * í˜„ì¬ í•¸ë“¤ëŸ¬ ì´ë¦„ ë°˜í™˜ 
     * isFirstRun() ë° ë°”ì´íŒ¨ìŠ¤ ê¸°ëŠ¥(bypass, clearBypass)ì´ ê° í•¸ë“¤ëŸ¬ë¥¼ ê³ ìœ í•˜ê²Œ ì‹ë³„í•˜ê¸° ìœ„í•´ í•„ìš”
    **/
    protected override String getHandlerName() {
        return 'OrderTriggerHandler';
    }

    protected override void beforeInsert(List<SObject> news) {
        System.debug('Order Trigger Before Insert Start');
        
        List<Order> newOrders = (List<Order>) news;

        Set<Id> accountId = new Set<Id>();
        for (Order ord : newOrders) {
            if(ord.AccountId != null){
                accountId.add(ord.AccountId);
            }
        }
        
        if(!accountId.isEmpty()){
            // Map<Id, Account> convertAccMap = new Map<Id,Account>();
            Id activeRecordType = Schema.SObjectType.Account.getRecordTypeInfosByDeveloperName().get('ActiveCustomer').getRecordTypeId();

            Map<Id, Account> accMap = new Map<Id, Account>();
            List<Account> accList = [
                SELECT  Id
                        , BusinessNumberVerified__c
                        , RecordTypeId
                FROM Account
                WHERE Id IN :accountId
            ];

            for(Account acc : accList) {
                accMap.put(acc.Id, acc);
            }

            List<Account> updateAccRecordType = new List<Account>();
            for(Order ord : newOrders) {
                if(ord.AccountId != null){
                    Account relatedAcc = accMap.get(ord.AccountId);
                    if(relatedAcc != null) {
                        if(relatedAcc != null && !relatedAcc.BusinessNumberVerified__c) {
                            ord.addError('ì‚¬ì—…ì ë²ˆí˜¸ê°€ ê²€ì¦ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì£¼ë¬¸ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        } else if (relatedAcc.RecordTypeId != activeRecordType){
                            relatedAcc.RecordTypeId = activeRecordType;
                            updateAccRecordType.add(relatedAcc);
                        }
                    }
                }
            }

            if(!updateAccRecordType.isEmpty()){
                update updateAccRecordType;
            }
        }

        System.debug('Order Trigger Before Insert Finish');
    }
    
    // after insert ë¡œì§
    protected override void afterInsert(List<SObject> news, Map<Id, SObject> newMap) {
        Set<Id> orderIdsToProcess = new Set<Id>();
        List<Id> orderIdsForProductRegistration = new List<Id>();
        List<Order> newOrders = (List<Order>)news;
        
        // ğŸš€ ëª¨ë“  ìƒˆ Orderì— ëŒ€í•´ Salesforce ì±„ë„ ìë™ ìƒì„±
        List<Id> allNewOrderIds = new List<Id>();
        
        for (Order ord : newOrders) {
            // ëª¨ë“  Order ID ìˆ˜ì§‘ (ì±„ë„ ìƒì„±ìš©)
            allNewOrderIds.add(ord.Id);
            
            // ë‚©ë¶€ ë°©ì‹ì´ ì§€ì •ëœ ê²½ìš°ì—ë§Œ ì²˜ë¦¬ ëŒ€ìƒì— ì¶”ê°€
            if (String.isNotBlank(ord.Payment_Method__c)) {
                orderIdsToProcess.add(ord.Id);
            }
            
            // Opportunity Product ìë™ ë“±ë¡ ëŒ€ìƒ (Opportunityê°€ ì—°ê²°ë˜ì–´ ìˆëŠ” ê²½ìš°)
            if (ord.OpportunityId != null) {
                orderIdsForProductRegistration.add(ord.Id);
            }
        }
        
        // ğŸ¯ ëª¨ë“  ìƒˆ Orderì— ëŒ€í•´ Salesforce ì±„ë„ ìƒì„± (ìµœìš°ì„  ì‹¤í–‰)
        if (!allNewOrderIds.isEmpty()) {
            try {
                System.debug('ğŸš€ ëª¨ë“  ìƒˆ Orderì— ëŒ€í•´ Salesforce ì±„ë„ ìë™ ìƒì„±: ' + allNewOrderIds.size() + 'ê°œ');
                
                for(Id orderId : allNewOrderIds) {
                    try {
                        String channelId = SimpleSalesforceChannelService.createOrderChannel(orderId);
                        
                        if(channelId != null) {
                            System.debug('âœ… Order ' + orderId + ' Salesforce ì±„ë„ ìë™ ìƒì„± ì™„ë£Œ: ' + channelId);
                            
                            // Order Ownerë¥¼ ì±„ë„ì— ìë™ ì¶”ê°€ ë° í™˜ì˜ ë©”ì‹œì§€
                            List<Order> orderForOwner = [SELECT OwnerId, OrderNumber FROM Order WHERE Id = :orderId LIMIT 1];
                            if(!orderForOwner.isEmpty()) {
                                SimpleSalesforceChannelService.addUserToChannel(channelId, orderForOwner[0].OwnerId);
                                SimpleSalesforceChannelService.postWelcomeMessage(channelId, orderId, orderForOwner[0].OrderNumber);
                            }
                        }
                    } catch(Exception channelError) {
                        System.debug('âŒ Order ' + orderId + ' ì±„ë„ ìƒì„± ì˜¤ë¥˜: ' + channelError.getMessage());
                    }
                }
                
            } catch (Exception e) {
                System.debug('âŒ Salesforce ì±„ë„ ìë™ ìƒì„± ì‹¤íŒ¨: ' + e.getMessage());
            }
        }
        
        // ì„œë¹„ìŠ¤ í˜¸ì¶œ
        if (!orderIdsToProcess.isEmpty()) {
            PaymentScheduleService.createSchedules(orderIdsToProcess);
        }
        
        // Opportunity Product ìë™ ë“±ë¡
        if (!orderIdsForProductRegistration.isEmpty()) {
            try {
                OrderProductAutoRegistrationService.batchRegisterOpportunityProducts(orderIdsForProductRegistration);
                System.debug('Opportunity Product ìë™ ë“±ë¡ ì™„ë£Œ: ' + orderIdsForProductRegistration.size() + 'ê°œ Order');
            } catch (Exception e) {
                System.debug('Opportunity Product ìë™ ë“±ë¡ ì‹¤íŒ¨: ' + e.getMessage());
            }
        }
        
        // Sales ì•± Order ìƒì„± ì•Œë¦¼ ë°œì†¡
        try {
            // Order ID Set ìƒì„±
            Set<Id> orderIds = new Set<Id>();
            for (Order ord : newOrders) {
                orderIds.add(ord.Id);
            }
            
            // Account ì •ë³´ í¬í•¨í•´ì„œ ì¡°íšŒ
            List<Order> ordersWithAccount = [
                SELECT Id, OrderNumber, TotalAmount, Account.Name
                FROM Order 
                WHERE Id IN :orderIds
            ];
            
            if (!ordersWithAccount.isEmpty()) {
                System.debug('ğŸ‰ Order ìƒì„± ì•Œë¦¼ ë°œì†¡ ì¤‘: ' + ordersWithAccount.size() + 'ê°œ');
                OrderNotificationService.notifyOrderCreated(ordersWithAccount);
                System.debug('âœ… Order ìƒì„± ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ');
            }
        } catch (Exception e) {
            System.debug('âŒ Order ìƒì„± ì•Œë¦¼ ì‹¤íŒ¨: ' + e.getMessage());
            System.debug('âŒ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
        }
    }

    // after update ë¡œì§
    protected override void afterUpdate(List<SObject> news, List<SObject> olds, Map<Id, SObject> newMap, Map<Id, SObject> oldMap) {
        Set<Id> orderIdsToProcess = new Set<Id>();
        List<Id> orderIdsForActivation = new List<Id>();
        Set<Id> orderIdsForAutomation = new Set<Id>();
        List<Id> orderIdsForChannelCreation = new List<Id>(); // ğŸ†• ì±„ë„ ìƒì„± ëŒ€ìƒ
        Map<Id, Order> oldOrderMap = (Map<Id, Order>)oldMap;

        for (Order newOrd : (List<Order>)news) {
            Order oldOrd = oldOrderMap.get(newOrd.Id);

            // ë‚©ë¶€ ë°©ì‹ ë˜ëŠ” ì´ì•¡ì´ ë³€ê²½ëœ ê²½ìš° ì²˜ë¦¬ ëŒ€ìƒì— ì¶”ê°€
            if (newOrd.Payment_Method__c != oldOrd.Payment_Method__c || newOrd.TotalAmount != oldOrd.TotalAmount) {
                orderIdsToProcess.add(newOrd.Id);
            }
            
            // Order Productsê°€ ì¶”ê°€ë˜ì–´ TotalAmountê°€ 0ì—ì„œ ì–‘ìˆ˜ë¡œ ë³€ê²½ë˜ê³  
            // Statusê°€ ì—¬ì „íˆ Draftì¸ ê²½ìš° í™œì„±í™” ëŒ€ìƒ
            if (oldOrd.TotalAmount == 0 && newOrd.TotalAmount > 0 && newOrd.Status == 'Draft') {
                orderIdsForActivation.add(newOrd.Id);
            }
            
            // Order Product ìë™í™” ì²˜ë¦¬ ëŒ€ìƒ
            // 1. Order Productsê°€ ìƒˆë¡œ ë“±ë¡ëœ ê²½ìš° (TotalAmount 0 â†’ ì–‘ìˆ˜)
            // 2. Statusê°€ Draft â†’ Activatedë¡œ ë³€ê²½ëœ ê²½ìš°
            if ((oldOrd.TotalAmount == 0 && newOrd.TotalAmount > 0) || 
                (oldOrd.Status != 'Activated' && newOrd.Status == 'Activated')) {
                orderIdsForAutomation.add(newOrd.Id);
            }
            
            // ğŸ†• Slack Channel IDê°€ ì§€ì—°ë˜ì–´ ì—…ë°ì´íŠ¸ëœ ê²½ìš° Salesforce ì±„ë„ ìƒì„±
            // Slack í•„ë“œê°€ ìƒˆë¡œ ì…ë ¥ë˜ì—ˆê³  Notification Statusê°€ "Not Created"ì¸ ê²½ìš°
            if (String.isBlank(oldOrd.Slack_Channel_ID__c) && 
                String.isNotBlank(newOrd.Slack_Channel_ID__c) &&
                (newOrd.Slack_Notification_Status__c == 'Not Created' || String.isBlank(newOrd.Slack_Notification_Status__c))) {
                orderIdsForChannelCreation.add(newOrd.Id);
                System.debug('ğŸ¯ Slack Channel ID ì§€ì—° ì—…ë°ì´íŠ¸ ê°ì§€ - Order: ' + newOrd.OrderNumber);
            }
            
            // ğŸ”§ Slack Channel í™œì„±í™” ì¡°ê±´ í™•ì¸ ë° ìë™ ìˆ˜ì •
            // Slack Channel IDëŠ” ìˆì§€ë§Œ Notification Statusê°€ "Not Created"ì¸ ê²½ìš°
            if (String.isNotBlank(newOrd.Slack_Channel_ID__c) && 
                newOrd.Slack_Notification_Status__c == 'Not Created') {
                
                // Notification Statusë¥¼ "Created"ë¡œ ì—…ë°ì´íŠ¸í•˜ì—¬ Slack Channel í™œì„±í™”
                Order orderToActivate = new Order();
                orderToActivate.Id = newOrd.Id;
                orderToActivate.Slack_Notification_Status__c = 'Created';
                
                // Webhook URLì´ ë¹„ì–´ìˆë‹¤ë©´ ê¸°ë³¸ê°’ ì„¤ì •
                if (String.isBlank(newOrd.Slack_Webhook_URL__c)) {
                    orderToActivate.Slack_Webhook_URL__c = 'https://hooks.slack.com/services/default';
                }
                
                try {
                    update orderToActivate;
                    System.debug('âœ… Order ' + newOrd.OrderNumber + ' Slack Channel ìë™ í™œì„±í™” ì™„ë£Œ');
                } catch (Exception activationError) {
                    System.debug('âŒ Slack Channel í™œì„±í™” ì˜¤ë¥˜: ' + activationError.getMessage());
                }
            }
        }

        // ì„œë¹„ìŠ¤ í˜¸ì¶œ
        if (!orderIdsToProcess.isEmpty()) {
            PaymentScheduleService.createSchedules(orderIdsToProcess);
        }
        
        // Order ìë™ í™œì„±í™”
        if (!orderIdsForActivation.isEmpty()) {
            try {
                List<Order> ordersToActivate = new List<Order>();
                for (Id orderId : orderIdsForActivation) {
                    // Order Productsê°€ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                    List<OrderItem> orderProducts = [
                        SELECT Id FROM OrderItem WHERE OrderId = :orderId LIMIT 1
                    ];
                    
                    if (!orderProducts.isEmpty()) {
                        Order orderToUpdate = new Order();
                        orderToUpdate.Id = orderId;
                        orderToUpdate.Status = 'Activated';
                        ordersToActivate.add(orderToUpdate);
                    }
                }
                
                if (!ordersToActivate.isEmpty()) {
                    update ordersToActivate;
                    System.debug('Order ìë™ í™œì„±í™” ì™„ë£Œ: ' + ordersToActivate.size() + 'ê°œ');
                }
                
            } catch (Exception e) {
                System.debug('Order ìë™ í™œì„±í™” ì‹¤íŒ¨: ' + e.getMessage());
            }
        }
        
        // Order Product ìë™í™” ì²˜ë¦¬ (PDF ìƒì„± + Salesforce ì±„ë„ ìƒì„±)
        if (!orderIdsForAutomation.isEmpty()) {
            try {
                System.debug('ğŸ¤– Order Product ìë™í™” íŠ¸ë¦¬ê±°: ' + orderIdsForAutomation.size() + 'ê°œ Order');
                OrderProductAutomationService.processOrderProductAutomation(orderIdsForAutomation);
                
                // Salesforce ì±„ë„ ìƒì„±
                for(String orderId : orderIdsForAutomation) {
                    try {
                        String channelId = SimpleSalesforceChannelService.createOrderChannel(orderId);
                        
                        if(channelId != null) {
                            System.debug('âœ… Salesforce ì±„ë„ ìƒì„± ì™„ë£Œ: ' + channelId);
                        }
                    } catch(Exception channelError) {
                        System.debug('âŒ Salesforce ì±„ë„ ìƒì„± ì˜¤ë¥˜: ' + channelError.getMessage());
                    }
                }
                
            } catch (Exception e) {
                System.debug('âŒ Order Product ìë™í™” ì‹¤íŒ¨: ' + e.getMessage());
            }
        }
        
        // ğŸ†• Slack Channel ID ì§€ì—° ì—…ë°ì´íŠ¸ë¡œ ì¸í•œ Salesforce ì±„ë„ ìƒì„±
        if (!orderIdsForChannelCreation.isEmpty()) {
            try {
                System.debug('ğŸš€ Slack ì§€ì—° ì—…ë°ì´íŠ¸ ê°ì§€ - Salesforce ì±„ë„ ìƒì„±: ' + orderIdsForChannelCreation.size() + 'ê°œ');
                
                for(Id orderId : orderIdsForChannelCreation) {
                    try {
                        // ê¸°ì¡´ ì±„ë„ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                        List<Order> orderInfo = [SELECT OrderNumber FROM Order WHERE Id = :orderId LIMIT 1];
                        if(!orderInfo.isEmpty()) {
                            String orderNumber = orderInfo[0].OrderNumber;
                            
                            List<CollaborationGroup> existingChannels = [
                                SELECT Id FROM CollaborationGroup 
                                WHERE Name LIKE :('%' + orderNumber + '%')
                                LIMIT 1
                            ];
                            
                            if(existingChannels.isEmpty()) {
                                String channelId = SimpleSalesforceChannelService.createOrderChannel(orderId);
                                
                                if(channelId != null) {
                                    System.debug('âœ… ì§€ì—° ì—…ë°ì´íŠ¸ Salesforce ì±„ë„ ìƒì„± ì™„ë£Œ - Order: ' + orderNumber + ', Channel: ' + channelId);
                                    
                                    // Order Ownerë¥¼ ì±„ë„ì— ìë™ ì¶”ê°€
                                    List<Order> orderForOwner = [SELECT OwnerId FROM Order WHERE Id = :orderId LIMIT 1];
                                    if(!orderForOwner.isEmpty()) {
                                        SimpleSalesforceChannelService.addUserToChannel(channelId, orderForOwner[0].OwnerId);
                                        System.debug('âœ… Order Owner ì±„ë„ ì¶”ê°€ ì™„ë£Œ');
                                    }
                                    
                                    // í™˜ì˜ ë©”ì‹œì§€ ê²Œì‹œ (orderNumber íŒŒë¼ë¯¸í„° ì¶”ê°€)
                                    SimpleSalesforceChannelService.postWelcomeMessage(channelId, orderId, orderNumber);
                                }
                            } else {
                                System.debug('â„¹ï¸ Salesforce ì±„ë„ì´ ì´ë¯¸ ì¡´ì¬í•¨ - Order: ' + orderNumber);
                            }
                        }
                    } catch(Exception channelError) {
                        System.debug('âŒ ì§€ì—° ì—…ë°ì´íŠ¸ ì±„ë„ ìƒì„± ì˜¤ë¥˜: ' + channelError.getMessage());
                    }
                }
                
            } catch (Exception e) {
                System.debug('âŒ ì§€ì—° ì—…ë°ì´íŠ¸ Salesforce ì±„ë„ ìƒì„± ì‹¤íŒ¨: ' + e.getMessage());
            }
        }
    }

}