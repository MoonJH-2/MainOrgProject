/**
 * @description Order Product ë“±ë¡ ì‹œ ìë™í™” ì„œë¹„ìŠ¤
 * - PDF ìë™ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
 * - Slack ì±„ë„ ìë™ ìƒì„±
 * - ì•Œë¦¼ ë°œì†¡
 * @author JH Moon
 * @last modified on 07-21-2025
 * @last modified by JH Moon
 */
public with sharing class OrderProductAutomationService {
    
    /**
     * Order Product ë“±ë¡ ì‹œ ìë™í™” ì²˜ë¦¬ (ë¹„ë™ê¸°)
     */
    @future(callout=true)
    public static void processOrderProductAutomation(Set<Id> orderIds) {
        try {
            System.debug('ğŸ¤– Order Product ìë™í™” ì‹œì‘: ' + orderIds.size() + 'ê°œ Order');
            
            // 1. Order ì •ë³´ ì¡°íšŒ (OrderItem í¬í•¨)
            List<Order> ordersWithProducts = [
                SELECT Id, OrderNumber, Account.Name, Account.Id, TotalAmount, 
                       Payment_Method__c, Status, EffectiveDate, OwnerId, Owner.Email,
                       Slack_Channel_ID__c, Slack_Channel_Name__c, Slack_Notification_Status__c,
                       (SELECT Id, Product2.Name, Product2.ProductCode, Quantity, 
                               UnitPrice, TotalPrice FROM OrderItems)
                FROM Order 
                WHERE Id IN :orderIds 
                AND Status = 'Activated'
            ];
            
            if (ordersWithProducts.isEmpty()) {
                System.debug('âŒ ì²˜ë¦¬í•  Activated Orderê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            System.debug('ğŸ“‹ ì²˜ë¦¬ ëŒ€ìƒ Order: ' + ordersWithProducts.size() + 'ê°œ');
            
            // 2. PDF ìë™ ìƒì„± ë° ì²¨ë¶€
            generateOrderProductPDFs(ordersWithProducts);
            
            // 3. Slack ì±„ë„ ìë™ ìƒì„±
            createSlackChannels(ordersWithProducts);
            
            // 4. ì™„ë£Œ ì•Œë¦¼ ë°œì†¡
            sendCompletionNotifications(ordersWithProducts);
            
            System.debug('âœ… Order Product ìë™í™” ì™„ë£Œ');
            
        } catch (Exception e) {
            System.debug('âŒ Order Product ìë™í™” ì˜¤ë¥˜: ' + e.getMessage());
            System.debug('Stack Trace: ' + e.getStackTraceString());
        }
    }
    
    /**
     * Order Product ìƒì„¸ PDF ìƒì„± ë° ì²¨ë¶€
     */
    private static void generateOrderProductPDFs(List<Order> orders) {
        List<ContentVersion> pdfVersionsToInsert = new List<ContentVersion>();
        List<ContentDocumentLink> cdlsToInsert = new List<ContentDocumentLink>();
        
        for (Order orderInfo : orders) {
            try {
                // OrderItemì´ ì—†ëŠ” ê²½ìš° ê±´ë„ˆë›°ê¸°
                if (orderInfo.OrderItems.isEmpty()) {
                    System.debug('âš ï¸ Order ' + orderInfo.OrderNumber + 'ì— OrderItemì´ ì—†ìŠµë‹ˆë‹¤.');
                    continue;
                }
                
                System.debug('ğŸ“„ PDF ìƒì„± ì¤‘: Order ' + orderInfo.OrderNumber);
                
                // PDF ë‚´ìš© ìƒì„±
                String pdfContent = createOrderProductPDFContent(orderInfo);
                
                // ContentVersion ìƒì„±
                ContentVersion cv = new ContentVersion();
                cv.Title = 'Order_Product_ìƒì„¸ì„œ_' + orderInfo.OrderNumber + '_' + 
                          DateTime.now().format('yyyyMMdd_HHmmss');
                cv.PathOnClient = cv.Title + '.pdf';
                cv.VersionData = Blob.valueOf(pdfContent);
                cv.ContentLocation = 'S';
                cv.Description = orderInfo.Account.Name + ' ê³ ê° Order Product ìƒì„¸ì„œ - ' + 
                               orderInfo.OrderNumber + ' (ìë™ìƒì„±)';
                
                pdfVersionsToInsert.add(cv);
                
            } catch (Exception e) {
                System.debug('âŒ PDF ìƒì„± ì˜¤ë¥˜ (Order: ' + orderInfo.OrderNumber + '): ' + e.getMessage());
            }
        }
        
        // ContentVersion ì¼ê´„ ìƒì„±
        if (!pdfVersionsToInsert.isEmpty()) {
            insert pdfVersionsToInsert;
            
            // ContentDocumentLink ìƒì„±ì„ ìœ„í•´ ContentDocument ID ì¡°íšŒ
            Map<String, Id> contentDocumentMap = new Map<String, Id>();
            for (ContentVersion cv : [SELECT Id, ContentDocumentId, Title FROM ContentVersion WHERE Id IN :pdfVersionsToInsert]) {
                contentDocumentMap.put(cv.Title, cv.ContentDocumentId);
            }
            
            // ContentDocumentLink ìƒì„± (Orderì— ì—°ê²°)
            Integer index = 0;
            for (Order orderInfo : orders) {
                if (index < pdfVersionsToInsert.size() && !orderInfo.OrderItems.isEmpty()) {
                    ContentVersion cv = pdfVersionsToInsert[index];
                    Id contentDocumentId = contentDocumentMap.get(cv.Title);
                    
                    if (contentDocumentId != null) {
                        ContentDocumentLink cdl = new ContentDocumentLink();
                        cdl.ContentDocumentId = contentDocumentId;
                        cdl.LinkedEntityId = orderInfo.Id;
                        cdl.ShareType = 'V';
                        cdl.Visibility = 'AllUsers';
                        cdlsToInsert.add(cdl);
                    }
                    index++;
                }
            }
            
            if (!cdlsToInsert.isEmpty()) {
                insert cdlsToInsert;
                System.debug('âœ… PDF ìƒì„± ë° ì²¨ë¶€ ì™„ë£Œ: ' + cdlsToInsert.size() + 'ê°œ');
            }
        }
    }
    
    /**
     * PDF ë‚´ìš© ìƒì„±
     */
    private static String createOrderProductPDFContent(Order orderInfo) {
        // ë‚©ë¶€ ì¼ì • ì¡°íšŒ
        List<PaymentStatus__c> paymentSchedule = [
            SELECT Installment_Number__c, Amount__c, DueDate__c, Status__c
            FROM PaymentStatus__c 
            WHERE Order__c = :orderInfo.Id
            ORDER BY Installment_Number__c ASC
        ];
        
        // PDF ë‚´ìš© ìƒì„± (ê°„ë‹¨í•œ PDF êµ¬ì¡°)
        String pdfContent = '%PDF-1.4\n';
        pdfContent += '1 0 obj\n<<\n/Type /Catalog\n/Pages 2 0 R\n>>\nendobj\n\n';
        pdfContent += '2 0 obj\n<<\n/Type /Pages\n/Kids [3 0 R]\n/Count 1\n>>\nendobj\n\n';
        pdfContent += '3 0 obj\n<<\n/Type /Page\n/Parent 2 0 R\n/MediaBox [0 0 612 792]\n/Contents 4 0 R\n>>\nendobj\n\n';
        
        // PDF ë³¸ë¬¸ ë‚´ìš©
        String contentStream = 'BT\n/F1 16 Tf\n50 750 Td\n';
        contentStream += '(Order Product ìƒì„¸ì„œ) Tj\n';
        contentStream += '/F1 12 Tf\n0 -30 Td\n';
        contentStream += '(Order Number: ' + orderInfo.OrderNumber + ') Tj\n';
        contentStream += '0 -20 Td\n(Customer: ' + orderInfo.Account.Name + ') Tj\n';
        contentStream += '0 -20 Td\n(Order Date: ' + orderInfo.EffectiveDate?.format() + ') Tj\n';
        contentStream += '0 -20 Td\n(Status: ' + orderInfo.Status + ') Tj\n';
        contentStream += '0 -30 Td\n(=== Product Details ===) Tj\n';
        
        // Order Items ì¶”ê°€
        for (OrderItem item : orderInfo.OrderItems) {
            contentStream += '0 -20 Td\n(â€¢ ' + item.Product2.Name + ') Tj\n';
            contentStream += '0 -15 Td\n(  Code: ' + item.Product2.ProductCode + ') Tj\n';
            contentStream += '0 -15 Td\n(  Quantity: ' + item.Quantity + ') Tj\n';
            contentStream += '0 -15 Td\n(  Unit Price: â‚©' + String.valueOf(item.UnitPrice.format()) + ') Tj\n';
            contentStream += '0 -15 Td\n(  Total: â‚©' + String.valueOf(item.TotalPrice.format()) + ') Tj\n';
        }
        
        contentStream += '0 -30 Td\n(=== Payment Information ===) Tj\n';
        contentStream += '0 -20 Td\n(Method: ' + orderInfo.Payment_Method__c + ') Tj\n';
        contentStream += '0 -20 Td\n(Total Amount: â‚©' + String.valueOf(orderInfo.TotalAmount.format()) + ') Tj\n';
        
        // ë‚©ë¶€ ì¼ì • ì¶”ê°€
        if (!paymentSchedule.isEmpty()) {
            contentStream += '0 -20 Td\n(Payment Schedule:) Tj\n';
            for (PaymentStatus__c payment : paymentSchedule) {
                contentStream += '0 -15 Td\n(  ' + payment.Installment_Number__c + 'ì°¨: â‚©' + 
                               payment.Amount__c.format() + ' - ' + payment.DueDate__c.format() + 
                               ' (' + payment.Status__c + ')) Tj\n';
            }
        }
        
        contentStream += '0 -30 Td\n(ìƒì„±ì¼: ' + Date.today().format() + ') Tj\n';
        contentStream += 'ET';
        
        pdfContent += '4 0 obj\n<<\n/Length ' + contentStream.length() + '\n>>\nstream\n';
        pdfContent += contentStream + '\nendstream\nendobj\n\n';
        pdfContent += 'xref\n0 5\n0000000000 65535 f \n0000000009 00000 n \n';
        pdfContent += '0000000058 00000 n \n0000000115 00000 n \n0000000204 00000 n \n';
        pdfContent += 'trailer\n<<\n/Size 5\n/Root 1 0 R\n>>\nstartxref\n' + 
                     (pdfContent.length() + 100) + '\n%%EOF';
        
        return pdfContent;
    }
    
    /**
     * Slack ì±„ë„ ìë™ ìƒì„±
     */
    private static void createSlackChannels(List<Order> orders) {
        List<Order> ordersToUpdate = new List<Order>();
        
        for (Order orderInfo : orders) {
            try {
                // ì´ë¯¸ Slack ì±„ë„ì´ ìƒì„±ëœ ê²½ìš° ê±´ë„ˆë›°ê¸°
                if (String.isNotBlank(orderInfo.Slack_Channel_ID__c)) {
                    System.debug('âš ï¸ Order ' + orderInfo.OrderNumber + 'ëŠ” ì´ë¯¸ Slack ì±„ë„ì´ ìˆìŠµë‹ˆë‹¤.');
                    continue;
                }
                
                System.debug('ğŸ’¬ Slack ì±„ë„ ìƒì„± ì¤‘: Order ' + orderInfo.OrderNumber);
                
                // Slack API í˜¸ì¶œ
                Boolean channelCreated = SlackChannelService.createOrderChannel(orderInfo);
                
                if (channelCreated) {
                    // Order ì—…ë°ì´íŠ¸ (Slack ì •ë³´)
                    Order orderToUpdate = new Order();
                    orderToUpdate.Id = orderInfo.Id;
                    orderToUpdate.Slack_Channel_Name__c = orderInfo.OrderNumber;
                    orderToUpdate.Slack_Notification_Status__c = 'Created';
                    ordersToUpdate.add(orderToUpdate);
                    
                    System.debug('âœ… Slack ì±„ë„ ìƒì„± ì™„ë£Œ: #' + orderInfo.OrderNumber);
                } else {
                    System.debug('âŒ Slack ì±„ë„ ìƒì„± ì‹¤íŒ¨: Order ' + orderInfo.OrderNumber);
                }
                
            } catch (Exception e) {
                System.debug('âŒ Slack ì±„ë„ ìƒì„± ì˜¤ë¥˜ (Order: ' + orderInfo.OrderNumber + '): ' + e.getMessage());
            }
        }
        
        // Order ì¼ê´„ ì—…ë°ì´íŠ¸
        if (!ordersToUpdate.isEmpty()) {
            update ordersToUpdate;
            System.debug('âœ… Order Slack ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ' + ordersToUpdate.size() + 'ê°œ');
        }
    }
    
    /**
     * ì™„ë£Œ ì•Œë¦¼ ë°œì†¡ (Chatter)
     */
    private static void sendCompletionNotifications(List<Order> orders) {
        List<FeedItem> chatterPosts = new List<FeedItem>();
        
        for (Order orderInfo : orders) {
            try {
                // Chatter í¬ìŠ¤íŠ¸ ìƒì„±
                FeedItem post = new FeedItem();
                post.ParentId = orderInfo.Id;
                post.Type = 'TextPost';
                
                String message = 'ğŸ‰ Order Product ìë™í™” ì™„ë£Œ!\n\n';
                message += 'ğŸ“‹ Order: ' + orderInfo.OrderNumber + '\n';
                message += 'ğŸ‘¤ Customer: ' + orderInfo.Account.Name + '\n';
                message += 'ğŸ’° Amount: â‚©' + orderInfo.TotalAmount.format() + '\n\n';
                message += 'âœ… ì™„ë£Œëœ ì‘ì—…:\n';
                message += 'â€¢ Order Product ìƒì„¸ì„œ PDF ìƒì„±\n';
                message += 'â€¢ Slack ì±„ë„ ìƒì„± (#' + orderInfo.OrderNumber + ')\n';
                message += 'â€¢ Files ìë™ ì²¨ë¶€\n\n';
                message += 'ğŸ“ Notes & Attachmentsì—ì„œ PDFë¥¼ í™•ì¸í•˜ì„¸ìš”!';
                
                post.Body = message;
                chatterPosts.add(post);
                
            } catch (Exception e) {
                System.debug('âŒ Chatter í¬ìŠ¤íŠ¸ ìƒì„± ì˜¤ë¥˜ (Order: ' + orderInfo.OrderNumber + '): ' + e.getMessage());
            }
        }
        
        // Chatter í¬ìŠ¤íŠ¸ ì¼ê´„ ìƒì„±
        if (!chatterPosts.isEmpty()) {
            insert chatterPosts;
            System.debug('âœ… Chatter ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ: ' + chatterPosts.size() + 'ê°œ');
        }
    }
}
