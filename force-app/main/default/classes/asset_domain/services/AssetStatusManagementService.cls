/**
 * @description Asset ìƒíƒœ ìë™ ê´€ë¦¬ ì„œë¹„ìŠ¤
 * @author AI Assistant
 * @created 2025-07-24
 */
public with sharing class AssetStatusManagementService {
    
    /**
     * Asset ìƒíƒœë¥¼ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ëŠ” ë©”ì¸ ë©”ì„œë“œ
     */
    public static void updateAssetStatuses() {
        try {
            // 1. ìƒˆë¡œ ìƒì„±ëœ Assetì„ Activeë¡œ ë³€ê²½
            activateNewAssets();
            
            // 2. ë§Œë£Œëœ Assetì„ Obsoleteë¡œ ë³€ê²½
            deactivateExpiredAssets();
            
            // 3. ê°±ì‹  ì˜ˆì • Assetì— ëŒ€í•œ ì•Œë¦¼ ìƒì„±
            createRenewalNotifications();
            
            // 4. Asset ìƒíƒœ ë³€ê²½ ë¡œê·¸ ìƒì„±
            logAssetStatusChanges();
            
        } catch(Exception e) {
            System.debug('AssetStatusManagementService Error: ' + e.getMessage());
        }
    }
    
    /**
     * ìƒˆë¡œ ìƒì„±ëœ Assetì„ Active ìƒíƒœë¡œ ë³€ê²½
     */
    private static void activateNewAssets() {
        List<Asset> newAssets = [
            SELECT Id, Name, Status, InstallDate, UsageEndDate
            FROM Asset 
            WHERE Status = 'Purchased' 
            AND InstallDate <= :Date.today()
            AND (UsageEndDate = null OR UsageEndDate > :Date.today())
        ];
        
        if(!newAssets.isEmpty()) {
            for(Asset asset : newAssets) {
                asset.Status = 'Installed';
                
                // Usage End Dateê°€ ì—†ìœ¼ë©´ 1ë…„ í›„ë¡œ ì„¤ì •
                if(asset.UsageEndDate == null) {
                    asset.UsageEndDate = Date.today().addYears(1);
                }
            }
            
            update newAssets;
            System.debug('âœ… ' + newAssets.size() + 'ê°œ Assetì´ Active ìƒíƒœë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    /**
     * ë§Œë£Œëœ Assetì„ Obsolete ìƒíƒœë¡œ ë³€ê²½
     */
    private static void deactivateExpiredAssets() {
        List<Asset> expiredAssets = [
            SELECT Id, Name, Status, UsageEndDate, Account.Name
            FROM Asset 
            WHERE Status IN ('Purchased', 'Installed')
            AND UsageEndDate < :Date.today()
        ];
        
        if(!expiredAssets.isEmpty()) {
            for(Asset asset : expiredAssets) {
                asset.Status = 'Obsolete';
            }
            
            update expiredAssets;
            
            // ë§Œë£Œ ì•Œë¦¼ ìƒì„±
            createExpirationTasks(expiredAssets);
            System.debug('âš ï¸ ' + expiredAssets.size() + 'ê°œ Assetì´ ë§Œë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    /**
     * ê°±ì‹  ì˜ˆì • Assetì— ëŒ€í•œ ì•Œë¦¼ ìƒì„± (90ì¼, 60ì¼, 30ì¼ ì „)
     */
    private static void createRenewalNotifications() {
        // 90ì¼ ì „ ì•Œë¦¼
        Date date90 = Date.today().addDays(90);
        createRenewalTasksForDate(date90, '90ì¼ ì „');
        
        // 60ì¼ ì „ ì•Œë¦¼
        Date date60 = Date.today().addDays(60);
        createRenewalTasksForDate(date60, '60ì¼ ì „');
        
        // 30ì¼ ì „ ì•Œë¦¼
        Date date30 = Date.today().addDays(30);
        createRenewalTasksForDate(date30, '30ì¼ ì „');
    }
    
    /**
     * íŠ¹ì • ë‚ ì§œì˜ ê°±ì‹  ì˜ˆì • Assetì— ëŒ€í•œ Task ìƒì„±
     */
    private static void createRenewalTasksForDate(Date targetDate, String timeFrame) {
        List<Asset> renewalAssets = [
            SELECT Id, Name, Account.Name, Account.OwnerId, UsageEndDate, Price, 
                   Contact.Name, Contact.Email, Account.Key_Account__c
            FROM Asset 
            WHERE UsageEndDate = :targetDate
            AND Status IN ('Purchased', 'Installed')
        ];
        
        if(!renewalAssets.isEmpty()) {
            List<Task> renewalTasks = new List<Task>();
            
            for(Asset asset : renewalAssets) {
                Task renewalTask = new Task();
                renewalTask.Subject = '[ê°±ì‹  ' + timeFrame + '] ' + asset.Name + ' - ê°±ì‹  ì˜ì—… ì‹œì‘';
                renewalTask.Description = buildRenewalTaskDescription(asset, timeFrame);
                renewalTask.Priority = asset.Account.Key_Account__c ? 'High' : 'Normal';
                renewalTask.Status = 'Not Started';
                renewalTask.ActivityDate = Date.today().addDays(7);
                renewalTask.OwnerId = asset.Account.OwnerId;
                renewalTask.WhatId = asset.Id;
                
                renewalTasks.add(renewalTask);
            }
            
            insert renewalTasks;
            System.debug('ğŸ“… ' + timeFrame + ' ê°±ì‹  ì•Œë¦¼ ' + renewalTasks.size() + 'ê°œ ìƒì„±');
        }
    }
    
    /**
     * ê°±ì‹  Task ì„¤ëª… ìƒì„±
     */
    private static String buildRenewalTaskDescription(Asset asset, String timeFrame) {
        String description = 'ğŸ”” Asset ê°±ì‹  ì˜ˆì • ì•Œë¦¼\n\n';
        description += 'ğŸ“‹ Asset: ' + asset.Name + '\n';
        description += 'ğŸ¢ ê³ ê°: ' + asset.Account.Name + '\n';
        description += 'ğŸ“… ë§Œë£Œì¼: ' + asset.UsageEndDate.format() + '\n';
        description += 'ğŸ’° ê¸°ì¡´ ê°€ê²©: â‚©' + (asset.Price != null ? asset.Price.format() : '0') + '\n';
        description += 'ğŸ‘¤ ë‹´ë‹¹ì: ' + (asset.Contact?.Name ?? 'ë¯¸ì§€ì •') + '\n\n';
        
        description += 'ğŸ“Œ ' + timeFrame + ' ì•¡ì…˜ ì•„ì´í…œ:\n';
        
        if(timeFrame == '90ì¼ ì „') {
            description += 'â–¡ ê³ ê° ë§Œì¡±ë„ ì¡°ì‚¬ ì‹¤ì‹œ\n';
            description += 'â–¡ ì‚¬ìš© í˜„í™© ë¶„ì„ ë° ROI ê³„ì‚°\n';
            description += 'â–¡ ê°±ì‹  ì œì•ˆì„œ ì´ˆì•ˆ ì‘ì„±\n';
            description += 'â–¡ ê²½ìŸì‚¬ ë™í–¥ íŒŒì•…';
        } else if(timeFrame == '60ì¼ ì „') {
            description += 'â–¡ ì •ì‹ ê°±ì‹  ì œì•ˆì„œ ì œì¶œ\n';
            description += 'â–¡ ì—…ê·¸ë ˆì´ë“œ ì˜µì…˜ ì œì•ˆ\n';
            description += 'â–¡ ì˜ì‚¬ê²°ì •ì ë¯¸íŒ… ì¼ì • ì¡°ìœ¨\n';
            description += 'â–¡ ê³„ì•½ ì¡°ê±´ í˜‘ìƒ ì‹œì‘';
        } else if(timeFrame == '30ì¼ ì „') {
            description += 'â–¡ ìµœì¢… ê³„ì•½ ì¡°ê±´ í™•ì •\n';
            description += 'â–¡ ì„œëª… ì¼ì • ì¡°ìœ¨\n';
            description += 'â–¡ ê°±ì‹  í˜œíƒ ìµœì¢… í™•ì¸\n';
            description += 'â–¡ í›„ì† ì„œë¹„ìŠ¤ ê³„íš ìˆ˜ë¦½';
        }
        
        return description;
    }
    
    /**
     * ë§Œë£Œëœ Assetì— ëŒ€í•œ í›„ì† ì¡°ì¹˜ Task ìƒì„±
     */
    private static void createExpirationTasks(List<Asset> expiredAssets) {
        List<Task> expirationTasks = new List<Task>();
        
        for(Asset asset : expiredAssets) {
            Task expirationTask = new Task();
            expirationTask.Subject = '[Asset ë§Œë£Œ] ' + asset.Name + ' - í›„ì† ì¡°ì¹˜ í•„ìš”';
            expirationTask.Description = 'âš ï¸ Assetì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n';
            expirationTask.Description += 'ğŸ“‹ Asset: ' + asset.Name + '\n';
            expirationTask.Description += 'ğŸ¢ ê³ ê°: ' + asset.Account.Name + '\n';
            expirationTask.Description += 'ğŸ“… ë§Œë£Œì¼: ' + asset.UsageEndDate.format() + '\n\n';
            expirationTask.Description += 'ğŸ“Œ í›„ì† ì¡°ì¹˜:\n';
            expirationTask.Description += 'â–¡ ê³ ê° ì—°ë½í•˜ì—¬ ë§Œë£Œ í™•ì¸\n';
            expirationTask.Description += 'â–¡ ê°±ì‹  ì˜í–¥ ì¬í™•ì¸\n';
            expirationTask.Description += 'â–¡ ë§Œë£Œ ì‚¬ìœ  ë¶„ì„\n';
            expirationTask.Description += 'â–¡ í–¥í›„ ì˜ì—… ì „ëµ ìˆ˜ë¦½';
            
            expirationTask.Priority = 'High';
            expirationTask.Status = 'Not Started';
            expirationTask.ActivityDate = Date.today().addDays(1);
            
            // Account Ownerì—ê²Œ í• ë‹¹
            List<Account> accounts = [SELECT OwnerId FROM Account WHERE Id = :asset.AccountId LIMIT 1];
            if(!accounts.isEmpty()) {
                expirationTask.OwnerId = accounts[0].OwnerId;
            }
            expirationTask.WhatId = asset.Id;
            
            expirationTasks.add(expirationTask);
        }
        
        if(!expirationTasks.isEmpty()) {
            insert expirationTasks;
        }
    }
    
    /**
     * Asset ìƒíƒœ ë³€ê²½ ë¡œê·¸ ìƒì„±
     */
    private static void logAssetStatusChanges() {
        // ìµœê·¼ 24ì‹œê°„ ë™ì•ˆ ë³€ê²½ëœ Asset ìƒíƒœ ë¡œê·¸
        DateTime yesterday = DateTime.now().addDays(-1);
        
        List<Asset> recentChanges = [
            SELECT Id, Name, Status, Account.Name, LastModifiedDate, LastModifiedBy.Name
            FROM Asset 
            WHERE LastModifiedDate >= :yesterday
            ORDER BY LastModifiedDate DESC
        ];
        
        if(!recentChanges.isEmpty()) {
            String logMessage = 'ğŸ“Š Asset ìƒíƒœ ë³€ê²½ ë¡œê·¸ (ìµœê·¼ 24ì‹œê°„)\n\n';
            
            for(Asset asset : recentChanges) {
                logMessage += 'â€¢ ' + asset.Name + ' (' + asset.Account.Name + ')\n';
                logMessage += '  ìƒíƒœ: ' + asset.Status + ' | ìˆ˜ì •ì: ' + asset.LastModifiedBy.Name + '\n';
                logMessage += '  ìˆ˜ì •ì¼: ' + asset.LastModifiedDate.format() + '\n\n';
            }
            
            System.debug(logMessage);
        }
    }
    
    /**
     * ìŠ¤ì¼€ì¤„ë§ì„ ìœ„í•œ ë°°ì¹˜ ì‹¤í–‰ ë©”ì„œë“œ
     */
    public static void scheduleStatusUpdate() {
        // ë§¤ì¼ ì˜¤ì „ 9ì‹œì— ì‹¤í–‰ë˜ë„ë¡ ìŠ¤ì¼€ì¤„ë§
        String cronExp = '0 0 9 * * ?';
        AssetStatusUpdateBatch batch = new AssetStatusUpdateBatch();
        System.schedule('Asset Status Daily Update', cronExp, batch);
    }
}
