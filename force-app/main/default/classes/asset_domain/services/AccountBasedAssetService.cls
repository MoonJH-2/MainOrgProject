/**
 * @description Account í•„ë“œ ê¸°ë°˜ Asset ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì„œë¹„ìŠ¤
 * @author Copilot
 * @date 2024
 */
public with sharing class AccountBasedAssetService {
    
    /**
     * @description Account ì •ë³´ë¥¼ í¬í•¨í•œ Asset ìƒì„± (OrderAssetCreationService í™•ì¥)
     * @param orderId Order ID
     * @return Asset ìƒì„±ëœ Asset ë ˆì½”ë“œ
     */
    public static Asset createAssetWithAccountAnalysis(Id orderId) {
        try {
            // Orderì™€ Account ìƒì„¸ ì •ë³´ ì¡°íšŒ
            Order orderInfo = [
                SELECT Id, OrderNumber, AccountId, TotalAmount, Status,
                       EffectiveDate, EndDate, CreatedDate, OwnerId,
                       Contact__c, Account.Name, Account.AccountNumber, Account.Industry,
                       Account.AnnualRevenue, Account.NumberOfEmployees,
                       Account.CustomerPriority__c, Account.Key_Account__c, Account.Active__c,
                       Account.AccountSource, Account.Ownership, Account.Site,
                       Account.Manager__c, Account.Manager__r.Name, Owner.Name
                FROM Order 
                WHERE Id = :orderId 
                LIMIT 1
            ];
            
            // ì´ë¯¸ Assetì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
            List<Asset> existingAssets = [
                SELECT Id FROM Asset 
                WHERE SerialNumber = :orderInfo.OrderNumber
                LIMIT 1
            ];
            
            if (!existingAssets.isEmpty()) {
                System.debug('AccountBasedAssetService: Assetì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. OrderNumber: ' + orderInfo.OrderNumber);
                return existingAssets[0];
            }
            
            // Asset ìƒì„±
            Asset newAsset = new Asset();
            
            // ê¸°ë³¸ Asset ì •ë³´
            newAsset.Name = buildAssetName(orderInfo);
            newAsset.AccountId = orderInfo.AccountId;
            newAsset.ContactId = orderInfo.Contact__c;
            newAsset.SerialNumber = orderInfo.OrderNumber;
            newAsset.PurchaseDate = orderInfo.EffectiveDate;
            newAsset.InstallDate = Date.today();
            newAsset.Status = 'Purchased';
            newAsset.Price = orderInfo.TotalAmount;
            newAsset.Quantity = 1;
            
            // Account ì •ë³´ ê¸°ë°˜ Asset ë¶„ë¥˜ ë° Lifecycle ì„¤ì •
            setAssetCategoryAndLifecycle(newAsset, orderInfo);
            
            // Asset Description with Account Analysis
            newAsset.Description = buildAccountBasedDescription(orderInfo);
            
            insert newAsset;
            
            System.debug('AccountBasedAssetService: Asset ìƒì„± ì™„ë£Œ. AssetId: ' + newAsset.Id);
            
            // Account ê¸°ë°˜ í›„ì† ì•¡ì…˜ ìˆ˜í–‰
            performAccountBasedActions(orderInfo, newAsset);
            
            return newAsset;
            
        } catch (Exception e) {
            System.debug('AccountBasedAssetService.createAssetWithAccountAnalysis Error: ' + e.getMessage());
            throw new AccountBasedAssetException('Account ê¸°ë°˜ Asset ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    /**
     * @description Account ì •ë³´ ê¸°ë°˜ Asset ì´ë¦„ ìƒì„±
     * @param orderInfo Order ì •ë³´
     * @return String Asset ì´ë¦„
     */
    private static String buildAssetName(Order orderInfo) {
        List<String> nameParts = new List<String>();
        
        nameParts.add(orderInfo.Account.Name);
        
        // Key Account í‘œì‹œ
        if (orderInfo.Account.Key_Account__c) {
            nameParts.add('(Key Account)');
        }
        
        // Einstein Tier í‘œì‹œ (í•„ë“œ ì¡´ì¬ ì‹œ)
        // if (String.isNotBlank(orderInfo.Account.Tier__c)) {
        //     nameParts.add('Tier:' + orderInfo.Account.Tier__c);
        // }
        
        // Industry í‘œì‹œ
        if (String.isNotBlank(orderInfo.Account.Industry)) {
            nameParts.add('[' + orderInfo.Account.Industry + ']');
        }
        
        nameParts.add('Order ' + orderInfo.OrderNumber);
        
        return String.join(nameParts, ' ');
    }
    
    /**
     * @description Account ì •ë³´ ê¸°ë°˜ Asset ì¹´í…Œê³ ë¦¬ ë° Lifecycle ì„¤ì •
     * @param newAsset Asset ë ˆì½”ë“œ
     * @param orderInfo Order ì •ë³´
     */
    private static void setAssetCategoryAndLifecycle(Asset newAsset, Order orderInfo) {
        // Account Size ê¸°ë°˜ Lifecycle ê¸°ê°„ ì„¤ì •
        Integer lifecycleMonths = 12; // ê¸°ë³¸ 12ê°œì›”
        
        if (orderInfo.Account.NumberOfEmployees != null) {
            if (orderInfo.Account.NumberOfEmployees >= 1000) {
                lifecycleMonths = 36; // ëŒ€ê¸°ì—…: 3ë…„
            } else if (orderInfo.Account.NumberOfEmployees >= 100) {
                lifecycleMonths = 24; // ì¤‘ê²¬ê¸°ì—…: 2ë…„
            } else {
                lifecycleMonths = 12; // ì¤‘ì†Œê¸°ì—…: 1ë…„
            }
        }
        
        // Key AccountëŠ” ì¶”ê°€ ì—°ì¥
        if (orderInfo.Account.Key_Account__c) {
            lifecycleMonths += 12;
        }
        
        // Annual Revenue ê¸°ë°˜ ì¡°ì •
        if (orderInfo.Account.AnnualRevenue != null) {
            if (orderInfo.Account.AnnualRevenue >= 100000000) { // 1ì–µ ì´ìƒ
                lifecycleMonths += 6;
            }
        }
        
        // InstallDate ì„¤ì • (Asset ì„¤ì¹˜ì¼ë¡œ ì‚¬ìš©)
        newAsset.InstallDate = Date.today();
        
        // PurchaseDate ì„¤ì • (Order EffectiveDate ë˜ëŠ” ì˜¤ëŠ˜ ë‚ ì§œ)
        if (orderInfo.EffectiveDate != null) {
            newAsset.PurchaseDate = orderInfo.EffectiveDate;
        } else {
            newAsset.PurchaseDate = Date.today();
        }
    }
    
    /**
     * @description Account ë¶„ì„ì´ í¬í•¨ëœ Asset Description ìƒì„±
     * @param orderInfo Order ì •ë³´
     * @return String Asset Description
     */
    private static String buildAccountBasedDescription(Order orderInfo) {
        List<String> descriptionParts = new List<String>();
        
        descriptionParts.add('=== Account ê¸°ë°˜ Asset ì •ë³´ ===');
        descriptionParts.add('Order Number: ' + orderInfo.OrderNumber);
        descriptionParts.add('ê³ ê°ëª…: ' + orderInfo.Account.Name);
        descriptionParts.add('ê³„ì •ë²ˆí˜¸: ' + (orderInfo.Account.AccountNumber ?? 'ë¯¸ì„¤ì •'));
        descriptionParts.add('ì´ ê¸ˆì•¡: ' + (orderInfo.TotalAmount != null ? orderInfo.TotalAmount.format() : '0') + 'ì›');
        descriptionParts.add('');
        
        // Account ìƒì„¸ ë¶„ì„
        descriptionParts.add('=== Account ë¶„ì„ ===');
        descriptionParts.add('ì‚°ì—…êµ°: ' + (orderInfo.Account.Industry ?? 'ë¯¸ë¶„ë¥˜'));
        descriptionParts.add('ì§ì›ìˆ˜: ' + (orderInfo.Account.NumberOfEmployees != null ? orderInfo.Account.NumberOfEmployees.format() : 'ë¯¸í™•ì¸') + 'ëª…');
        descriptionParts.add('ì—°ë§¤ì¶œ: ' + (orderInfo.Account.AnnualRevenue != null ? orderInfo.Account.AnnualRevenue.format() : 'ë¯¸í™•ì¸') + 'ì›');
        // descriptionParts.add('Einstein Tier: ' + (orderInfo.Account.Tier__c ?? 'ë¯¸ë¶„ë¥˜'));
        descriptionParts.add('ê³ ê° ìš°ì„ ìˆœìœ„: ' + (orderInfo.Account.CustomerPriority__c ?? 'ì¼ë°˜'));
        descriptionParts.add('Key Account: ' + (orderInfo.Account.Key_Account__c ? 'Yes' : 'No'));
        descriptionParts.add('Account í™œì„± ìƒíƒœ: ' + (orderInfo.Account.Active__c ?? 'ë¯¸í™•ì¸'));
        descriptionParts.add('Account Source: ' + (orderInfo.Account.AccountSource ?? 'ë¯¸í™•ì¸'));
        descriptionParts.add('ì†Œìœ  í˜•íƒœ: ' + (orderInfo.Account.Ownership ?? 'ë¯¸í™•ì¸'));
        
        if (orderInfo.Account.Manager__r?.Name != null) {
            descriptionParts.add('Account Manager: ' + orderInfo.Account.Manager__r.Name);
        }
        
        descriptionParts.add('');
        
        // PaymentStatus ìš”ì•½ ì •ë³´
        try {
            List<PaymentStatus__c> paymentSummary = [
                SELECT Installment_Number__c, Amount__c, DueDate__c, PaidDate__c, Status__c
                FROM PaymentStatus__c 
                WHERE Order__c = :orderInfo.Id
                ORDER BY Installment_Number__c
                LIMIT 10
            ];
            
            if (!paymentSummary.isEmpty()) {
                descriptionParts.add('=== ë‚©ë¶€ ë‚´ì—­ ===');
                Decimal totalPaid = 0;
                Integer completedCount = 0;
                
                for (PaymentStatus__c ps : paymentSummary) {
                    String installmentInfo = ps.Installment_Number__c + 'ì°¨: ';
                    installmentInfo += (ps.Amount__c != null ? ps.Amount__c.format() : '0') + 'ì›';
                    installmentInfo += ' (' + ps.Status__c + ')';
                    if (ps.PaidDate__c != null) {
                        installmentInfo += ' - ë‚©ë¶€ì¼: ' + ps.PaidDate__c.format();
                    }
                    descriptionParts.add(installmentInfo);
                    
                    if (ps.Status__c == 'ì™„ë‚©' && ps.Amount__c != null) {
                        totalPaid += ps.Amount__c;
                        completedCount++;
                    }
                }
                
                descriptionParts.add('');
                descriptionParts.add('ë‚©ë¶€ ì™„ë£Œ: ' + completedCount + '/' + paymentSummary.size() + 'ì°¨');
                descriptionParts.add('ì™„ë‚© ê¸ˆì•¡: ' + totalPaid.format() + 'ì›');
                descriptionParts.add('');
            }
        } catch (Exception e) {
            System.debug('PaymentStatus ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage());
        }
        
        // Account ê¸°ë°˜ ë¹„ì¦ˆë‹ˆìŠ¤ ì¸ì‚¬ì´íŠ¸
        descriptionParts.add('=== Account ê¸°ë°˜ ë¹„ì¦ˆë‹ˆìŠ¤ ì¸ì‚¬ì´íŠ¸ ===');
        descriptionParts.addAll(generateAccountInsights(orderInfo));
        
        descriptionParts.add('');
        descriptionParts.add('ğŸ“ˆ ì´ Assetì€ Account ë¶„ì„ ê¸°ë°˜ìœ¼ë¡œ ì™„ë‚© ì™„ë£Œëœ Orderì—ì„œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
        descriptionParts.add('Account íŠ¹ì„±ì„ ê³ ë ¤í•œ ë§ì¶¤í˜• ê³ ê° ê´€ë¦¬ ë° ê°±ì‹  ì˜ì—…ì„ ì§„í–‰í•˜ì„¸ìš”.');
        
        return String.join(descriptionParts, '\n');
    }
    
    /**
     * @description Account ì •ë³´ ê¸°ë°˜ ë¹„ì¦ˆë‹ˆìŠ¤ ì¸ì‚¬ì´íŠ¸ ìƒì„±
     * @param orderInfo Order ì •ë³´
     * @return List<String> ì¸ì‚¬ì´íŠ¸ ëª©ë¡
     */
    private static List<String> generateAccountInsights(Order orderInfo) {
        List<String> insights = new List<String>();
        
        // ê¸°ì—… ê·œëª¨ ë¶„ì„
        if (orderInfo.Account.NumberOfEmployees != null) {
            if (orderInfo.Account.NumberOfEmployees >= 1000) {
                insights.add('â€¢ ëŒ€ê¸°ì—… ê³ ê°: ì¥ê¸° íŒŒíŠ¸ë„ˆì‹­ ë° í™•ì¥ ê¸°íšŒ ê²€í†  í•„ìš”');
                insights.add('â€¢ ì¡°ì§ ë‚´ ì¶”ê°€ ë¶€ì„œ í™•ì‚° ê°€ëŠ¥ì„± ë†’ìŒ');
            } else if (orderInfo.Account.NumberOfEmployees >= 100) {
                insights.add('â€¢ ì¤‘ê²¬ê¸°ì—… ê³ ê°: ì„±ì¥ ë‹¨ê³„ë³„ ì†”ë£¨ì…˜ í™•ì¥ ì œì•ˆ');
                insights.add('â€¢ ê²½ì˜ì§„ ì§ì ‘ ì ‘ì´‰ì„ í†µí•œ ì˜ì‚¬ê²°ì • ê°€ì†í™”');
            } else {
                insights.add('â€¢ ì¤‘ì†Œê¸°ì—… ê³ ê°: íš¨ìœ¨ì„± ë° ROI ì¤‘ì‹¬ì˜ ì œì•ˆ í•„ìš”');
                insights.add('â€¢ ê°„ë‹¨í•˜ê³  ëª…í™•í•œ ê°±ì‹  í”„ë¡œì„¸ìŠ¤ ì œê³µ');
            }
        }
        
        // ë§¤ì¶œ ê·œëª¨ ë¶„ì„
        if (orderInfo.Account.AnnualRevenue != null) {
            if (orderInfo.Account.AnnualRevenue >= 100000000) { // 1ì–µ ì´ìƒ
                insights.add('â€¢ ê³ ë§¤ì¶œ ê¸°ì—…: Premium ì„œë¹„ìŠ¤ ë° ì»¨ì„¤íŒ… ì œì•ˆ ê°€ëŠ¥');
                insights.add('â€¢ íˆ¬ì ì—¬ë ¥ ì¶©ë¶„, ì¶”ê°€ ì†”ë£¨ì…˜ í™•ëŒ€ ê¸°íšŒ');
            }
        }
        
        // Industry ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸
        if (String.isNotBlank(orderInfo.Account.Industry)) {
            switch on orderInfo.Account.Industry.toLowerCase() {
                when 'technology' {
                    insights.add('â€¢ IT ê¸°ì—…: ìµœì‹  ê¸°ìˆ  íŠ¸ë Œë“œ ë° í˜ì‹  ì†”ë£¨ì…˜ ì œì•ˆ');
                    insights.add('â€¢ ë¹ ë¥¸ ê¸°ìˆ  ë„ì… ì„±í–¥, ì¡°ê¸° ê°±ì‹  ê°€ëŠ¥ì„±');
                }
                when 'manufacturing' {
                    insights.add('â€¢ ì œì¡°ì—…: ìƒì‚°ì„± í–¥ìƒ ë° ë¹„ìš© ì ˆê° íš¨ê³¼ ê°•ì¡°');
                    insights.add('â€¢ ì¥ê¸° ê³„ì•½ ì„ í˜¸, ì•ˆì •ì ì¸ ê°±ì‹  íŒ¨í„´');
                }
                when 'healthcare' {
                    insights.add('â€¢ ì˜ë£Œì—…: ê·œì œ ì¤€ìˆ˜ ë° ë³´ì•ˆ ê°•í™” ì†”ë£¨ì…˜ í•„ìš”');
                    insights.add('â€¢ ì‹ ë¢°ì„±ê³¼ ì•ˆì •ì„± ì¤‘ì‹œ, ì¥ê¸° íŒŒíŠ¸ë„ˆì‹­ êµ¬ì¶•');
                }
                when 'financial services' {
                    insights.add('â€¢ ê¸ˆìœµì—…: ë³´ì•ˆ, ê·œì œ, ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì†”ë£¨ì…˜ ìš°ì„ ');
                    insights.add('â€¢ ì—„ê²©í•œ ê²€ì¦ ê³¼ì •, ê³ ê°€ì¹˜ ì¥ê¸° ê³„ì•½ ê°€ëŠ¥');
                }
                when else {
                    insights.add('â€¢ ' + orderInfo.Account.Industry + ' ì—…ê³„ íŠ¹ì„± ê³ ë ¤í•œ ë§ì¶¤ ì†”ë£¨ì…˜ ì œì•ˆ');
                }
            }
        }
        
        // Key Account ì¸ì‚¬ì´íŠ¸
        if (orderInfo.Account.Key_Account__c) {
            insights.add('â€¢ Key Account: ìµœìš°ì„  ê´€ë¦¬ ëŒ€ìƒ, ì „ë‹´ íŒ€ ë°°ì • ê³ ë ¤');
            insights.add('â€¢ ë ˆí¼ëŸ°ìŠ¤ ê³ ê° í™œìš© ë° ì„±ê³µ ì‚¬ë¡€ ê°œë°œ ê¸°íšŒ');
            insights.add('â€¢ ê²½ì˜ì§„ ë ˆë²¨ ê´€ê³„ êµ¬ì¶• ë° ì „ëµì  íŒŒíŠ¸ë„ˆì‹­ ì¶”ì§„');
        }
        
        // Customer Priority ì¸ì‚¬ì´íŠ¸
        if (String.isNotBlank(orderInfo.Account.CustomerPriority__c)) {
            switch on orderInfo.Account.CustomerPriority__c.toLowerCase() {
                when 'high' {
                    insights.add('â€¢ ê³ ìš°ì„ ìˆœìœ„ ê³ ê°: ì‹ ì†í•œ ëŒ€ì‘ ë° í”„ë¦¬ë¯¸ì—„ ì„œë¹„ìŠ¤ ì œê³µ');
                    insights.add('â€¢ ê°±ì‹  6ê°œì›” ì „ ì‚¬ì „ ì ‘ì´‰ ë° ë§ì¶¤ ì œì•ˆì„œ ì¤€ë¹„');
                }
                when 'medium' {
                    insights.add('â€¢ ì¤‘ìš°ì„ ìˆœìœ„ ê³ ê°: ì •ê¸°ì  ê´€ê³„ ìœ ì§€ ë° ê°€ì¹˜ ì œì•ˆ');
                }
                when 'low' {
                    insights.add('â€¢ ì¼ë°˜ ê³ ê°: íš¨ìœ¨ì  ê´€ë¦¬ ë° ìë™í™”ëœ ê°±ì‹  í”„ë¡œì„¸ìŠ¤');
                }
            }
        }
        
        // Einstein Tier ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸ (í•„ë“œ ì¡´ì¬ ì‹œ)
        // if (String.isNotBlank(orderInfo.Account.Tier__c)) {
        //     insights.add('â€¢ Einstein AI Tier ' + orderInfo.Account.Tier__c + ': AI ê¸°ë°˜ ê³ ê° í–‰ë™ ì˜ˆì¸¡ í™œìš©');
        //     insights.add('â€¢ ë°ì´í„° ê¸°ë°˜ ê°œì¸í™”ëœ ê°±ì‹  ì „ëµ ìˆ˜ë¦½ ê°€ëŠ¥');
        // }
        
        return insights;
    }
    
    /**
     * @description Account ê¸°ë°˜ í›„ì† ì•¡ì…˜ ìˆ˜í–‰
     * @param orderInfo Order ì •ë³´
     * @param createdAsset ìƒì„±ëœ Asset
     */
    private static void performAccountBasedActions(Order orderInfo, Asset createdAsset) {
        // Account Managerê°€ ìˆëŠ” ê²½ìš° ë³„ë„ ì•Œë¦¼
        if (orderInfo.Account.Manager__c != null) {
            createAccountManagerTask(orderInfo, createdAsset);
        }
        
        // Key Accountì¸ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
        if (orderInfo.Account.Key_Account__c) {
            createKeyAccountNotification(orderInfo, createdAsset);
        }
        
        // ê³ ìš°ì„ ìˆœìœ„ ê³ ê°ì¸ ê²½ìš° ì¦‰ì‹œ ì•Œë¦¼
        if (orderInfo.Account.CustomerPriority__c == 'High') {
            createHighPriorityCustomerAlert(orderInfo, createdAsset);
        }
    }
    
    /**
     * @description Account Managerìš© Task ìƒì„±
     * @param orderInfo Order ì •ë³´
     * @param createdAsset ìƒì„±ëœ Asset
     */
    private static void createAccountManagerTask(Order orderInfo, Asset createdAsset) {
        try {
            Task managerTask = new Task();
            managerTask.Subject = '[Account Manager] Asset ìƒì„± ì•Œë¦¼ - ' + orderInfo.Account.Name;
            managerTask.Description = 'Account Managerë‹˜ê»˜ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.\n\n';
            managerTask.Description += 'ê³ ê°: ' + orderInfo.Account.Name + '\n';
            managerTask.Description += 'Order: ' + orderInfo.OrderNumber + '\n';
            managerTask.Description += 'Asset: ' + createdAsset.Name + '\n';
            managerTask.Description += 'ì™„ë‚© ê¸ˆì•¡: ' + (orderInfo.TotalAmount != null ? orderInfo.TotalAmount.format() : '0') + 'ì›\n\n';
            managerTask.Description += 'Account íŠ¹ì„±:\n';
            managerTask.Description += '- ì‚°ì—…êµ°: ' + (orderInfo.Account.Industry ?? 'ë¯¸ë¶„ë¥˜') + '\n';
            managerTask.Description += '- ì§ì›ìˆ˜: ' + (orderInfo.Account.NumberOfEmployees != null ? orderInfo.Account.NumberOfEmployees.format() : 'ë¯¸í™•ì¸') + 'ëª…\n';
            managerTask.Description += '- Key Account: ' + (orderInfo.Account.Key_Account__c ? 'Yes' : 'No') + '\n\n';
            managerTask.Description += 'Account ì „ëµ ìˆ˜ë¦½ ë° ì¶”ê°€ ê¸°íšŒ ë°œêµ´ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.';
            
            managerTask.Priority = 'Normal';
            managerTask.Status = 'Not Started';
            managerTask.ActivityDate = Date.today().addDays(3);
            managerTask.OwnerId = orderInfo.Account.Manager__c;
            managerTask.WhatId = createdAsset.Id;
            
            insert managerTask;
            
        } catch (Exception e) {
            System.debug('AccountBasedAssetService.createAccountManagerTask Error: ' + e.getMessage());
        }
    }
    
    /**
     * @description Key Account ì•Œë¦¼ ìƒì„±
     * @param orderInfo Order ì •ë³´
     * @param createdAsset ìƒì„±ëœ Asset
     */
    private static void createKeyAccountNotification(Order orderInfo, Asset createdAsset) {
        try {
            Task keyAccountTask = new Task();
            keyAccountTask.Subject = '[Key Account] ì „ëµì  Asset ìƒì„± ì™„ë£Œ - ' + orderInfo.Account.Name;
            keyAccountTask.Description = 'ğŸŒŸ Key Account Asset ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n';
            keyAccountTask.Description += 'ê³ ê°: ' + orderInfo.Account.Name + '\n';
            keyAccountTask.Description += 'Asset ê°€ì¹˜: ' + (orderInfo.TotalAmount != null ? orderInfo.TotalAmount.format() : '0') + 'ì›\n\n';
            keyAccountTask.Description += 'ê¶Œì¥ ì•¡ì…˜:\n';
            keyAccountTask.Description += 'â–¡ ê²½ì˜ì§„ ë ˆë²¨ ê°ì‚¬ ì¸ì‚¬\n';
            keyAccountTask.Description += 'â–¡ ì„±ê³µ ì‚¬ë¡€ ì¸í„°ë·° ìš”ì²­\n';
            keyAccountTask.Description += 'â–¡ ì¶”ê°€ ì‚¬ì—… ê¸°íšŒ ë…¼ì˜ ì¼ì • ìˆ˜ë¦½\n';
            keyAccountTask.Description += 'â–¡ ë ˆí¼ëŸ°ìŠ¤ ê³ ê° ë“±ë¡ ê²€í† \n';
            keyAccountTask.Description += 'â–¡ ì „ëµì  íŒŒíŠ¸ë„ˆì‹­ í™•ëŒ€ ë°©ì•ˆ ìˆ˜ë¦½';
            
            keyAccountTask.Priority = 'High';
            keyAccountTask.Status = 'Not Started';
            keyAccountTask.ActivityDate = Date.today().addDays(1);
            keyAccountTask.OwnerId = orderInfo.OwnerId;
            keyAccountTask.WhatId = createdAsset.Id;
            
            insert keyAccountTask;
            
        } catch (Exception e) {
            System.debug('AccountBasedAssetService.createKeyAccountNotification Error: ' + e.getMessage());
        }
    }
    
    /**
     * @description ê³ ìš°ì„ ìˆœìœ„ ê³ ê° ì•Œë¦¼ ìƒì„±
     * @param orderInfo Order ì •ë³´
     * @param createdAsset ìƒì„±ëœ Asset
     */
    private static void createHighPriorityCustomerAlert(Order orderInfo, Asset createdAsset) {
        try {
            Task priorityTask = new Task();
            priorityTask.Subject = '[ìš°ì„ ìˆœìœ„ é«˜] Asset ìƒì„± ì¦‰ì‹œ ëŒ€ì‘ í•„ìš” - ' + orderInfo.Account.Name;
            priorityTask.Description = 'âš¡ ê³ ìš°ì„ ìˆœìœ„ ê³ ê°ì˜ Assetì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ ëŒ€ì‘ì´ í•„ìš”í•©ë‹ˆë‹¤.\n\n';
            priorityTask.Description += 'ê³ ê°: ' + orderInfo.Account.Name + '\n';
            priorityTask.Description += 'Priority Level: ' + orderInfo.Account.CustomerPriority__c + '\n';
            priorityTask.Description += 'Asset ê°€ì¹˜: ' + (orderInfo.TotalAmount != null ? orderInfo.TotalAmount.format() : '0') + 'ì›\n\n';
            priorityTask.Description += 'ì¦‰ì‹œ ì•¡ì…˜:\n';
            priorityTask.Description += 'â–¡ 24ì‹œê°„ ë‚´ ì™„ë‚© ê°ì‚¬ ì—°ë½\n';
            priorityTask.Description += 'â–¡ ì„œë¹„ìŠ¤ ë§Œì¡±ë„ í™•ì¸\n';
            priorityTask.Description += 'â–¡ ì¶”ê°€ ìš”êµ¬ì‚¬í•­ íŒŒì•…\n';
            priorityTask.Description += 'â–¡ ê°±ì‹  ì¼ì • ì‚¬ì „ í˜‘ì˜';
            
            priorityTask.Priority = 'High';
            priorityTask.Status = 'Not Started';
            priorityTask.ActivityDate = Date.today();
            priorityTask.OwnerId = orderInfo.OwnerId;
            priorityTask.WhatId = createdAsset.Id;
            
            insert priorityTask;
            
        } catch (Exception e) {
            System.debug('AccountBasedAssetService.createHighPriorityCustomerAlert Error: ' + e.getMessage());
        }
    }
    
    /**
     * @description ì»¤ìŠ¤í…€ ì˜ˆì™¸ í´ë˜ìŠ¤
     */
    public class AccountBasedAssetException extends Exception {}
}
