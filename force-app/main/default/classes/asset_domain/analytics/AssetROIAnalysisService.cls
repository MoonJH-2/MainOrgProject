/**
 * @description Asset ROI ë¶„ì„ ë° ì„±ê³¼ ì¸¡ì • ì„œë¹„ìŠ¤
 * @author AI Assistant  
 * @created 2025-07-24
 */
public with sharing class AssetROIAnalysisService {
    
    /**
     * Assetì˜ ROI ë¶„ì„ ê²°ê³¼ë¥¼ ë°˜í™˜
     */
    @AuraEnabled(cacheable=true)
    public static AssetROIResult calculateAssetROI(Id assetId) {
        try {
            // Asset ì •ë³´ ì¡°íšŒ
            Asset asset = [
                SELECT Id, Name, Price, PurchaseDate, UsageEndDate, Status,
                       Account.Name, Account.Industry, Account.NumberOfEmployees,
                       Account.Key_Account__c, Account.AnnualRevenue,
                       Contact.Name, Contact.Email
                FROM Asset 
                WHERE Id = :assetId 
                LIMIT 1
            ];
            
            AssetROIResult result = new AssetROIResult();
            result.assetId = asset.Id;
            result.assetName = asset.Name;
            result.accountName = asset.Account.Name;
            result.assetValue = asset.Price;
            result.purchaseDate = asset.PurchaseDate;
            result.usageEndDate = asset.UsageEndDate;
            
            // ROI ê³„ì‚°
            result.roiMetrics = calculateROIMetrics(asset);
            
            // ì‚¬ìš© í˜„í™© ë¶„ì„
            result.usageAnalysis = analyzeAssetUsage(asset);
            
            // ê°±ì‹  ì¶”ì²œ ì‚¬í•­
            result.renewalRecommendations = generateRenewalRecommendations(asset);
            
            // ìœ„í—˜ ìš”ì†Œ ë¶„ì„
            result.riskFactors = analyzeRiskFactors(asset);
            
            return result;
            
        } catch(Exception e) {
            throw new AuraHandledException('Asset ROI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    /**
     * ROI ì§€í‘œ ê³„ì‚°
     */
    private static ROIMetrics calculateROIMetrics(Asset asset) {
        ROIMetrics metrics = new ROIMetrics();
        
        // ê¸°ë³¸ ROI ê³„ì‚° (ê°€ì • ê¸°ë°˜)
        Decimal assetValue = asset.Price != null ? asset.Price : 0;
        
        // SOCAR ëª¨ë¹Œë¦¬í‹° ì„œë¹„ìŠ¤ ê¸°ì¤€ ROI ê³„ì‚°
        if(asset.Account.Industry == 'Transportation') {
            // ìš´ì†¡ì—…: ì—°ê°„ 20% ë¹„ìš© ì ˆê° íš¨ê³¼ ê°€ì •
            metrics.costSavingPercentage = 20;
            metrics.annualCostSaving = assetValue * 0.20;
        } else if(asset.Account.Industry == 'Technology') {
            // ê¸°ìˆ ì—…: ì—°ê°„ 15% íš¨ìœ¨ì„± í–¥ìƒ
            metrics.costSavingPercentage = 15;
            metrics.annualCostSaving = assetValue * 0.15;
        } else {
            // ì¼ë°˜ì—…: ì—°ê°„ 12% ë¹„ìš© ì ˆê°
            metrics.costSavingPercentage = 12;
            metrics.annualCostSaving = assetValue * 0.12;
        }
        
        // íšŒì‚¬ ê·œëª¨ë³„ ì¶”ê°€ í˜œíƒ
        if(asset.Account.NumberOfEmployees != null) {
            if(asset.Account.NumberOfEmployees >= 1000) {
                // ëŒ€ê¸°ì—…: ì¶”ê°€ 5% í˜œíƒ
                metrics.annualCostSaving *= 1.05;
                metrics.costSavingPercentage += 5;
            } else if(asset.Account.NumberOfEmployees >= 100) {
                // ì¤‘ê²¬ê¸°ì—…: ì¶”ê°€ 3% í˜œíƒ
                metrics.annualCostSaving *= 1.03;
                metrics.costSavingPercentage += 3;
            }
        }
        
        // Key Account í”„ë¦¬ë¯¸ì—„ í˜œíƒ
        if(asset.Account.Key_Account__c) {
            metrics.annualCostSaving *= 1.10; // 10% ì¶”ê°€ í˜œíƒ
            metrics.keyAccountBonus = assetValue * 0.10;
        }
        
        // ROI ë°±ë¶„ìœ¨ ê³„ì‚°
        if(assetValue > 0) {
            metrics.roiPercentage = (metrics.annualCostSaving / assetValue) * 100;
        }
        
        // íˆ¬ì íšŒìˆ˜ ê¸°ê°„ ê³„ì‚° (ê°œì›”)
        if(metrics.annualCostSaving > 0) {
            metrics.paybackPeriodMonths = Integer.valueOf((assetValue / metrics.annualCostSaving) * 12);
        }
        
        return metrics;
    }
    
    /**
     * Asset ì‚¬ìš© í˜„í™© ë¶„ì„
     */
    private static UsageAnalysis analyzeAssetUsage(Asset asset) {
        UsageAnalysis analysis = new UsageAnalysis();
        
        // ì‚¬ìš© ê¸°ê°„ ê³„ì‚°
        if(asset.PurchaseDate != null) {
            analysis.usageDays = asset.PurchaseDate.daysBetween(Date.today());
            analysis.usageMonths = Integer.valueOf(analysis.usageDays / 30);
        }
        
        // ë‚¨ì€ ì‚¬ìš© ê¸°ê°„
        if(asset.UsageEndDate != null) {
            analysis.remainingDays = Date.today().daysBetween(asset.UsageEndDate);
            analysis.remainingMonths = Integer.valueOf(analysis.remainingDays / 30);
        }
        
        // ì‚¬ìš©ë¥  ë¶„ì„ (ê°€ì • ê¸°ë°˜)
        analysis.utilizationRate = calculateUtilizationRate(asset);
        analysis.usageScore = calculateUsageScore(analysis.utilizationRate);
        
        // ì‚¬ìš© íŒ¨í„´ ë¶„ì„
        analysis.usagePattern = analyzeUsagePattern(asset);
        
        return analysis;
    }
    
    /**
     * ì‚¬ìš©ë¥  ê³„ì‚° (ì—…ì¢…ë³„ ê¸°ì¤€)
     */
    private static Decimal calculateUtilizationRate(Asset asset) {
        // ê¸°ë³¸ ì‚¬ìš©ë¥  70%ì—ì„œ ì‹œì‘
        Decimal baseRate = 70;
        
        // Key AccountëŠ” ë†’ì€ ì‚¬ìš©ë¥  ê°€ì •
        if(asset.Account.Key_Account__c) {
            baseRate += 15; // 85%
        }
        
        // ì—…ì¢…ë³„ ì¡°ì •
        if(asset.Account.Industry == 'Transportation') {
            baseRate += 10; // ìš´ì†¡ì—…ì€ ë†’ì€ ì‚¬ìš©ë¥ 
        } else if(asset.Account.Industry == 'Financial Services') {
            baseRate += 5;  // ê¸ˆìœµì—…ì€ ì¤‘ê°„ ì‚¬ìš©ë¥ 
        }
        
        // íšŒì‚¬ ê·œëª¨ë³„ ì¡°ì •
        if(asset.Account.NumberOfEmployees != null) {
            if(asset.Account.NumberOfEmployees >= 1000) {
                baseRate += 8; // ëŒ€ê¸°ì—…
            } else if(asset.Account.NumberOfEmployees >= 100) {
                baseRate += 5; // ì¤‘ê²¬ê¸°ì—…
            }
        }
        
        // ìµœëŒ€ 95%ë¡œ ì œí•œ
        return Math.min(baseRate, 95);
    }
    
    /**
     * ì‚¬ìš© ì ìˆ˜ ê³„ì‚°
     */
    private static String calculateUsageScore(Decimal utilizationRate) {
        if(utilizationRate >= 85) return 'ë§¤ìš° ìš°ìˆ˜';
        else if(utilizationRate >= 75) return 'ìš°ìˆ˜';
        else if(utilizationRate >= 65) return 'ì–‘í˜¸';
        else if(utilizationRate >= 50) return 'ë³´í†µ';
        else return 'ê°œì„  í•„ìš”';
    }
    
    /**
     * ì‚¬ìš© íŒ¨í„´ ë¶„ì„
     */
    private static String analyzeUsagePattern(Asset asset) {
        List<String> patterns = new List<String>();
        
        if(asset.Account.Key_Account__c) {
            patterns.add('ì§‘ì¤‘ì  ì‚¬ìš©');
        }
        
        if(asset.Account.Industry == 'Transportation') {
            patterns.add('ì—…ë¬´ ì¤‘ì‹¬ í™œìš©');
        } else if(asset.Account.Industry == 'Financial Services') {
            patterns.add('ì •ê¸°ì  ì—…ë¬´ í™œìš©');
        } else {
            patterns.add('ì¼ë°˜ì  í™œìš©');
        }
        
        if(asset.Account.NumberOfEmployees != null && asset.Account.NumberOfEmployees >= 100) {
            patterns.add('ë‹¤ë¶€ì„œ í™œìš©');
        }
        
        return String.join(patterns, ', ');
    }
    
    /**
     * ê°±ì‹  ì¶”ì²œ ì‚¬í•­ ìƒì„±
     */
    private static List<String> generateRenewalRecommendations(Asset asset) {
        List<String> recommendations = new List<String>();
        
        // ê¸°ë³¸ ê°±ì‹  ì¶”ì²œ
        recommendations.add('í˜„ì¬ ì„œë¹„ìŠ¤ ì—°ì¥ (ë™ì¼ ì¡°ê±´)');
        
        // Key Account íŠ¹ë³„ ì œì•ˆ
        if(asset.Account.Key_Account__c) {
            recommendations.add('VIP ê³ ê° í• ì¸ í˜œíƒ ì ìš©');
            recommendations.add('ì „ë‹´ ë§¤ë‹ˆì € ì„œë¹„ìŠ¤ ì œê³µ');
            recommendations.add('ìš°ì„  ì§€ì› ì„œë¹„ìŠ¤ í¬í•¨');
        }
        
        // ì—…ì¢…ë³„ ì¶”ì²œ
        if(asset.Account.Industry == 'Transportation') {
            recommendations.add('í”„ë¦¬ë¯¸ì—„ ì°¨ëŸ‰ ì˜µì…˜ ì—…ê·¸ë ˆì´ë“œ');
            recommendations.add('ìš´í–‰ ê´€ë¦¬ ì„œë¹„ìŠ¤ ì¶”ê°€');
        } else if(asset.Account.Industry == 'Technology') {
            recommendations.add('ìµœì‹  ê¸°ìˆ  ì ìš© ì„œë¹„ìŠ¤ ì œê³µ');
            recommendations.add('API ì—°ë™ ì„œë¹„ìŠ¤ í™•ì¥');
        }
        
        // íšŒì‚¬ ê·œëª¨ë³„ ì¶”ì²œ
        if(asset.Account.NumberOfEmployees != null) {
            if(asset.Account.NumberOfEmployees >= 1000) {
                recommendations.add('ëŒ€ê¸°ì—… ì „ìš© íŒ¨í‚¤ì§€ ì œì•ˆ');
                recommendations.add('ë³µìˆ˜ ì§€ì—­ ì„œë¹„ìŠ¤ í™•ì¥');
            } else if(asset.Account.NumberOfEmployees >= 100) {
                recommendations.add('ì¤‘ê²¬ê¸°ì—… ì„±ì¥ ì§€ì› íŒ¨í‚¤ì§€');
                recommendations.add('ë‹¨ê³„ì  í™•ì¥ ì˜µì…˜');
            }
        }
        
        // ì¥ê¸° ê³„ì•½ í˜œíƒ
        recommendations.add('2ë…„ ê³„ì•½ ì‹œ 10% í• ì¸');
        recommendations.add('3ë…„ ê³„ì•½ ì‹œ 15% í• ì¸ + ì¶”ê°€ í˜œíƒ');
        
        return recommendations;
    }
    
    /**
     * ìœ„í—˜ ìš”ì†Œ ë¶„ì„
     */
    private static List<String> analyzeRiskFactors(Asset asset) {
        List<String> risks = new List<String>();
        
        // ë§Œë£Œ ì„ë°• ìœ„í—˜
        if(asset.UsageEndDate != null) {
            Integer daysUntilExpiry = Date.today().daysBetween(asset.UsageEndDate);
            if(daysUntilExpiry <= 30) {
                risks.add('âš ï¸ ë§Œë£Œ ì„ë°• (30ì¼ ì´ë‚´) - ì¦‰ì‹œ ê°±ì‹  ë…¼ì˜ í•„ìš”');
            } else if(daysUntilExpiry <= 60) {
                risks.add('ğŸ“… ê°±ì‹  ì¤€ë¹„ ì‹œê¸° - ì œì•ˆì„œ ì¤€ë¹„ ì‹œì‘');
            } else if(daysUntilExpiry <= 90) {
                risks.add('ğŸ“‹ ê°±ì‹  ê³„íš ìˆ˜ë¦½ - ê³ ê° ë‹ˆì¦ˆ íŒŒì•…');
            }
        }
        
        // ì—…ì¢…ë³„ ìœ„í—˜ ìš”ì†Œ
        if(asset.Account.Industry == 'Financial Services') {
            risks.add('ê·œì œ ë³€í™”ì— ë”°ë¥¸ ì„œë¹„ìŠ¤ ìš”êµ¬ì‚¬í•­ ë³€ê²½ ê°€ëŠ¥');
        } else if(asset.Account.Industry == 'Healthcare') {
            risks.add('ì˜ë£Œ ê·œì • ë³€í™” ëª¨ë‹ˆí„°ë§ í•„ìš”');
        }
        
        // ê²½ìŸ ìœ„í—˜
        if(!asset.Account.Key_Account__c) {
            risks.add('ê²½ìŸì‚¬ ì ‘ì´‰ ê°€ëŠ¥ì„± - ê´€ê³„ ê°•í™” í•„ìš”');
        }
        
        // ê¸°ë³¸ ìœ„í—˜ì´ ì—†ìœ¼ë©´ ê¸ì •ì  ë©”ì‹œì§€
        if(risks.isEmpty()) {
            risks.add('âœ… ì•ˆì •ì ì¸ ê³ ê° ê´€ê³„ - ê°±ì‹  ì„±ê³µ ê°€ëŠ¥ì„± ë†’ìŒ');
        }
        
        return risks;
    }
    
    // Wrapper Classes
    public class AssetROIResult {
        @AuraEnabled public Id assetId { get; set; }
        @AuraEnabled public String assetName { get; set; }
        @AuraEnabled public String accountName { get; set; }
        @AuraEnabled public Decimal assetValue { get; set; }
        @AuraEnabled public Date purchaseDate { get; set; }
        @AuraEnabled public Date usageEndDate { get; set; }
        @AuraEnabled public ROIMetrics roiMetrics { get; set; }
        @AuraEnabled public UsageAnalysis usageAnalysis { get; set; }
        @AuraEnabled public List<String> renewalRecommendations { get; set; }
        @AuraEnabled public List<String> riskFactors { get; set; }
    }
    
    public class ROIMetrics {
        @AuraEnabled public Decimal roiPercentage { get; set; }
        @AuraEnabled public Decimal annualCostSaving { get; set; }
        @AuraEnabled public Decimal costSavingPercentage { get; set; }
        @AuraEnabled public Integer paybackPeriodMonths { get; set; }
        @AuraEnabled public Decimal keyAccountBonus { get; set; }
    }
    
    public class UsageAnalysis {
        @AuraEnabled public Integer usageDays { get; set; }
        @AuraEnabled public Integer usageMonths { get; set; }
        @AuraEnabled public Integer remainingDays { get; set; }
        @AuraEnabled public Integer remainingMonths { get; set; }
        @AuraEnabled public Decimal utilizationRate { get; set; }
        @AuraEnabled public String usageScore { get; set; }
        @AuraEnabled public String usagePattern { get; set; }
    }
}
