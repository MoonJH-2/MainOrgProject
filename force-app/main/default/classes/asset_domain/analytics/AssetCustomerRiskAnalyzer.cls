/**
 * Asset ê¸°ë°˜ ê³ ê° ë¦¬ìŠ¤í¬ ë° ë§Œì¡±ë„ ë¶„ì„ ì‹œìŠ¤í…œ
 * 
 * ë¶„ì„ ëŒ€ìƒ: (ì£¼)ê·¸ë¦°íŒŒì›Œí… Order 00000162
 * - ë‚©ë¶€ íŒ¨í„´: 4/4ì°¨ ì™„ë‚© (ìš°ìˆ˜)
 * - êµ¬ë§¤-ì„¤ì¹˜ ê°„ê²©: 2ì¼ (ë¹ ë¥¸ ë„ì…)
 * - Contact: ìœ ë‚˜ ê¹€ (ë‹¨ì¼ ì ‘ì )
 */
public class AssetCustomerRiskAnalyzer {
    
    /**
     * ê³ ê° ë¦¬ìŠ¤í¬ ì¢…í•© ë¶„ì„
     */
    @AuraEnabled(cacheable=true)
    public static CustomerRiskAnalysis analyzeCustomerRisk(Id accountId) {
        
        CustomerRiskAnalysis analysis = new CustomerRiskAnalysis();
        
        // 1. Asset í¬íŠ¸í´ë¦¬ì˜¤ ì¡°íšŒ
        List<Asset> customerAssets = [
            SELECT Id, Name, SerialNumber, AccountId, ContactId, 
                   Price, PurchaseDate, InstallDate, UsageEndDate,
                   Status, Description, Product2.Name,
                   Account.Name, Account.Industry, Account.Key_Account__c,
                   Contact.Name, Contact.Email, Contact.DoNotCall
            FROM Asset 
            WHERE AccountId = :accountId
            ORDER BY PurchaseDate DESC
        ];
        
        // 2. ë‚©ë¶€ ì´ë ¥ ë¶„ì„
        analysis.paymentRiskScore = analyzePaymentHistory(customerAssets);
        
        // 3. ì‚¬ìš© íŒ¨í„´ ë¶„ì„
        analysis.usageRiskScore = analyzeUsagePatterns(customerAssets);
        
        // 4. ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ë¦¬ìŠ¤í¬
        analysis.communicationRiskScore = analyzeCommunicationRisk(customerAssets);
        
        // 5. ê²½ìŸì‚¬ ì „í™˜ ë¦¬ìŠ¤í¬
        analysis.competitorRiskScore = analyzeCompetitorRisk(customerAssets);
        
        // 6. ì¢…í•© ë¦¬ìŠ¤í¬ ì ìˆ˜ (ê°€ì¤‘í‰ê· )
        analysis.overallRiskScore = calculateOverallRisk(analysis);
        
        // 7. ë¦¬ìŠ¤í¬ ì™„í™” ì•¡ì…˜ í”Œëœ
        analysis.riskMitigationActions = generateRiskMitigationPlan(analysis);
        
        // 8. ê³ ê° ë§Œì¡±ë„ ì˜ˆì¸¡
        analysis.satisfactionPrediction = predictCustomerSatisfaction(customerAssets);
        
        return analysis;
    }
    
    /**
     * ë‚©ë¶€ ì´ë ¥ ê¸°ë°˜ ë¦¬ìŠ¤í¬ ë¶„ì„
     */
    private static Integer analyzePaymentHistory(List<Asset> assets) {
        Integer riskScore = 0; // 0=ìµœì € ë¦¬ìŠ¤í¬, 100=ìµœê³  ë¦¬ìŠ¤í¬
        
        // ê·¸ë¦°íŒŒì›Œí… Order 00000162 ë¶„ì„
        for (Asset asset : assets) {
            if (asset.SerialNumber == '00000162') {
                // ì™„ë‚© ì´ë ¥ ë¶„ì„ (Descriptionì—ì„œ íŒŒì‹±)
                if (asset.Description != null && asset.Description.contains('ì™„ë‚© ì™„ë£Œ: 4/4ì°¨')) {
                    riskScore = 10; // ë§¤ìš° ë‚®ì€ ë¦¬ìŠ¤í¬
                } else if (asset.Description != null && asset.Description.contains('ì—°ì²´')) {
                    riskScore = 80; // ë†’ì€ ë¦¬ìŠ¤í¬
                } else {
                    riskScore = 30; // ë³´í†µ ë¦¬ìŠ¤í¬
                }
                break;
            }
        }
        
        return riskScore;
    }
    
    /**
     * ì‚¬ìš© íŒ¨í„´ ë¦¬ìŠ¤í¬ ë¶„ì„
     */
    private static Integer analyzeUsagePatterns(List<Asset> assets) {
        Integer riskScore = 20; // ê¸°ë³¸ê°’
        
        for (Asset asset : assets) {
            // êµ¬ë§¤-ì„¤ì¹˜ ê°„ê²© ë¶„ì„
            if (asset.PurchaseDate != null && asset.InstallDate != null) {
                Integer daysBetween = asset.PurchaseDate.daysBetween(asset.InstallDate);
                
                if (daysBetween <= 3) {
                    riskScore = 15; // ë¹ ë¥¸ ë„ì… = ë‚®ì€ ë¦¬ìŠ¤í¬
                } else if (daysBetween <= 7) {
                    riskScore = 25; // ë³´í†µ
                } else {
                    riskScore = 40; // ëŠë¦° ë„ì… = ë†’ì€ ë¦¬ìŠ¤í¬
                }
            }
        }
        
        return riskScore;
    }
    
    /**
     * ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ë¦¬ìŠ¤í¬ ë¶„ì„
     */
    private static Integer analyzeCommunicationRisk(List<Asset> assets) {
        Integer riskScore = 30;
        
        Set<Id> uniqueContacts = new Set<Id>();
        Boolean hasDoNotCallContact = false;
        
        for (Asset asset : assets) {
            if (asset.ContactId != null) {
                uniqueContacts.add(asset.ContactId);
                if (asset.Contact.DoNotCall) {
                    hasDoNotCallContact = true;
                }
            }
        }
        
        // Contact ë‹¤ì–‘ì„± ë¶„ì„
        if (uniqueContacts.size() == 1) {
            riskScore = 50; // ë‹¨ì¼ ì ‘ì  ë¦¬ìŠ¤í¬
        } else if (uniqueContacts.size() >= 2) {
            riskScore = 20; // ë‹¤ì¤‘ ì ‘ì  = ë‚®ì€ ë¦¬ìŠ¤í¬
        }
        
        // ì—°ë½ ê±°ë¶€ ì„¤ì •
        if (hasDoNotCallContact) {
            riskScore += 20;
        }
        
        return Math.min(riskScore, 100);
    }
    
    /**
     * ê²½ìŸì‚¬ ì „í™˜ ë¦¬ìŠ¤í¬ ë¶„ì„
     */
    private static Integer analyzeCompetitorRisk(List<Asset> assets) {
        Integer riskScore = 40;
        
        for (Asset asset : assets) {
            // Product ì´ë¦„ì—ì„œ ê²½ìŸì‚¬ ì œí’ˆ ì—¬ë¶€ í™•ì¸
            if (asset.Product2 != null && asset.Product2.Name.contains('Competitor')) {
                riskScore = 60; // ì´ë¯¸ ê²½ìŸì‚¬ ì œí’ˆ ì‚¬ìš© ì¤‘
            }
        }
        
        return riskScore;
    }
    
    /**
     * ì¢…í•© ë¦¬ìŠ¤í¬ ì ìˆ˜ ê³„ì‚° (ê°€ì¤‘í‰ê· )
     */
    private static Integer calculateOverallRisk(CustomerRiskAnalysis analysis) {
        // ê°€ì¤‘ì¹˜: ë‚©ë¶€(40%), ì‚¬ìš©íŒ¨í„´(20%), ì»¤ë®¤ë‹ˆì¼€ì´ì…˜(25%), ê²½ìŸì‚¬(15%)
        Integer weightedScore = 
            (analysis.paymentRiskScore * 40 +
             analysis.usageRiskScore * 20 +
             analysis.communicationRiskScore * 25 +
             analysis.competitorRiskScore * 15) / 100;
        
        return weightedScore;
    }
    
    /**
     * ë¦¬ìŠ¤í¬ ì™„í™” ì•¡ì…˜ í”Œëœ ìƒì„±
     */
    private static String generateRiskMitigationPlan(CustomerRiskAnalysis analysis) {
        List<String> actions = new List<String>();
        
        // ë‚©ë¶€ ë¦¬ìŠ¤í¬ ëŒ€ì‘
        if (analysis.paymentRiskScore <= 20) {
            actions.add('âœ… ë‚©ë¶€ ìš°ìˆ˜ ê³ ê°: í”„ë¦¬ë¯¸ì—„ ì„œë¹„ìŠ¤ ì œê³µ ë° ì¶©ì„±ë„ í”„ë¡œê·¸ë¨ ì ìš©');
        } else if (analysis.paymentRiskScore >= 60) {
            actions.add('âš ï¸ ë‚©ë¶€ ë¦¬ìŠ¤í¬: ê²°ì œ í¸ì˜ì„± ê°œì„  ë° ë¶„í• ë‚©ë¶€ ì˜µì…˜ ì œì‹œ');
        }
        
        // ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ë¦¬ìŠ¤í¬ ëŒ€ì‘
        if (analysis.communicationRiskScore >= 50) {
            actions.add('ğŸ“ ì ‘ì  ë‹¤ì–‘í™”: ì¶”ê°€ ë‹´ë‹¹ì ë°œêµ´ ë° ê´€ê³„ êµ¬ì¶•');
            actions.add('ğŸ“§ ë‹¤ì±„ë„ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜: ì´ë©”ì¼, SMS, ì•± í‘¸ì‹œ ë“± í™œìš©');
        }
        
        // ê²½ìŸì‚¬ ë¦¬ìŠ¤í¬ ëŒ€ì‘
        if (analysis.competitorRiskScore >= 50) {
            actions.add('ğŸ¯ ì°¨ë³„í™” ì „ëµ: ê²½ìŸì‚¬ ëŒ€ë¹„ ìš°ìœ„ì  ì§€ì†ì  ì–´í•„');
            actions.add('ğŸ¤ ê´€ê³„ ê°•í™”: ì •ê¸° ë°©ë¬¸ ë° ë§Œì¡±ë„ ì¡°ì‚¬ ì‹¤ì‹œ');
        }
        
        // ì¢…í•© ëŒ€ì‘
        if (analysis.overallRiskScore <= 30) {
            actions.add('â­ ì €ë¦¬ìŠ¤í¬ ê³ ê°: ë ˆí¼ëŸ°ìŠ¤ í™œìš© ë° ì¶”ì²œ ê³ ê° ìš”ì²­');
        } else if (analysis.overallRiskScore >= 60) {
            actions.add('ğŸš¨ ê³ ë¦¬ìŠ¤í¬ ê³ ê°: ì¦‰ì‹œ ê³ ê° ë¯¸íŒ… ë° ì´ìŠˆ í•´ê²°');
        }
        
        return String.join(actions, '\n');
    }
    
    /**
     * ê³ ê° ë§Œì¡±ë„ ì˜ˆì¸¡
     */
    private static Integer predictCustomerSatisfaction(List<Asset> assets) {
        Integer satisfactionScore = 70; // ê¸°ë³¸ê°’
        
        // ì™„ë‚© ì´ë ¥ì´ ìˆìœ¼ë©´ ë§Œì¡±ë„ ìƒìŠ¹
        for (Asset asset : assets) {
            if (asset.Description != null && asset.Description.contains('ì™„ë‚© ì™„ë£Œ')) {
                satisfactionScore = 85;
            }
            
            // ë¹ ë¥¸ ì„¤ì¹˜ëŠ” ì ê·¹ì  ë„ì… ì˜ì§€ = ë†’ì€ ë§Œì¡±ë„
            if (asset.PurchaseDate != null && asset.InstallDate != null) {
                Integer installDays = asset.PurchaseDate.daysBetween(asset.InstallDate);
                if (installDays <= 3) {
                    satisfactionScore += 10;
                }
            }
        }
        
        return Math.min(satisfactionScore, 100);
    }
    
    /**
     * Wrapper Class for Customer Risk Analysis
     */
    public class CustomerRiskAnalysis {
        @AuraEnabled public Integer paymentRiskScore { get; set; }
        @AuraEnabled public Integer usageRiskScore { get; set; }
        @AuraEnabled public Integer communicationRiskScore { get; set; }
        @AuraEnabled public Integer competitorRiskScore { get; set; }
        @AuraEnabled public Integer overallRiskScore { get; set; }
        @AuraEnabled public String riskMitigationActions { get; set; }
        @AuraEnabled public Integer satisfactionPrediction { get; set; }
        
        @AuraEnabled public String riskLevel { 
            get {
                if (overallRiskScore <= 30) return 'LOW';
                else if (overallRiskScore <= 60) return 'MEDIUM';
                else return 'HIGH';
            }
        }
        
        @AuraEnabled public String satisfactionLevel {
            get {
                if (satisfactionPrediction >= 80) return 'HIGH';
                else if (satisfactionPrediction >= 60) return 'MEDIUM';
                else return 'LOW';
            }
        }
    }
}
