/**
 * ë¡œì§ 1: Assets ìš°ì„ ìˆœìœ„ ê³„ì‚° ì‹œìŠ¤í…œ
 * ì˜ì—…ì‚¬ì›ì„ ìœ„í•œ ìŠ¤ë§ˆíŠ¸í•œ ê³ ê° ìš°ì„ ìˆœìœ„ ìë™ ë¶„ë¥˜
 * 
 * ëª©ì : "ì˜¤ëŠ˜ ëˆ„êµ¬ì—ê²Œ ë¨¼ì € ì—°ë½í• ê¹Œ?" â†’ 5ì´ˆ ë‚´ ë‹µë³€
 * ë°©ì‹: 3ê°œ í•µì‹¬ ìš”ì†Œë¡œ ë‹¨ìˆœí•œ ì ìˆ˜ í•©ì‚° (ì´ 100ì )
 */

public class AssetPriorityCalculator {
    
    // ìš°ì„ ìˆœìœ„ ë˜í¼ í´ë˜ìŠ¤
    public class AssetPriority implements Comparable {
        @AuraEnabled public Asset asset { get; set; }
        @AuraEnabled public Decimal score { get; set; }
        @AuraEnabled public String urgencyLevel { get; set; }
        @AuraEnabled public String urgencyColor { get; set; }
        @AuraEnabled public String actionRecommendation { get; set; }
        @AuraEnabled public Decimal expectedRevenue { get; set; }
        @AuraEnabled public Integer daysFromInstall { get; set; }
        @AuraEnabled public String renewalStatus { get; set; }
        
        public AssetPriority() {
            this.score = 0;
        }
        
        // ì •ë ¬ì„ ìœ„í•œ compareTo êµ¬í˜„ (ë†’ì€ ì ìˆ˜ ìš°ì„ )
        public Integer compareTo(Object compareTo) {
            AssetPriority other = (AssetPriority) compareTo;
            if (this.score > other.score) return -1;
            if (this.score < other.score) return 1;
            return 0;
        }
    }
    
    // ê²°ê³¼ ë˜í¼ í´ë˜ìŠ¤
    public class PriorityResult {
        @AuraEnabled public List<AssetPriority> priorities { get; set; }
        @AuraEnabled public Decimal totalExpectedRevenue { get; set; }
        @AuraEnabled public Integer urgentCount { get; set; }
        @AuraEnabled public Integer importantCount { get; set; }
        @AuraEnabled public Integer normalCount { get; set; }
        @AuraEnabled public String summary { get; set; }
        
        public PriorityResult() {
            this.priorities = new List<AssetPriority>();
            this.totalExpectedRevenue = 0;
            this.urgentCount = 0;
            this.importantCount = 0;
            this.normalCount = 0;
        }
    }
    
    /**
     * ë©”ì¸ ë©”ì„œë“œ: ì˜ì—…ì‚¬ì›ë³„ ìš°ì„ ìˆœìœ„ ê³„ì‚°
     * @param salesRepId ì˜ì—…ì‚¬ì› ID (nullì´ë©´ í˜„ì¬ ì‚¬ìš©ì)
     * @param topN ìƒìœ„ Nê°œ ê²°ê³¼ (ê¸°ë³¸ê°’: 10)
     * @return PriorityResult ìš°ì„ ìˆœìœ„ ê²°ê³¼
     */
    @AuraEnabled(cacheable=true)
    public static PriorityResult calculatePriorities(Id salesRepId, Integer topN) {
        try {
            // ê¸°ë³¸ê°’ ì„¤ì •
            if (salesRepId == null) {
                salesRepId = UserInfo.getUserId();
            }
            if (topN == null || topN <= 0) {
                topN = 10;
            }
            
            System.debug('=== Assets ìš°ì„ ìˆœìœ„ ê³„ì‚° ì‹œì‘ ===');
            System.debug('ì˜ì—…ì‚¬ì› ID: ' + salesRepId);
            System.debug('ìƒìœ„ ' + topN + 'ê°œ ê²°ê³¼ ìš”ì²­');
            
            PriorityResult result = new PriorityResult();
            
            // 1. ê¸°ë³¸ Assets ë°ì´í„° ì¡°íšŒ (í•„ìˆ˜ ì •ë³´ë§Œ)
            List<Asset> assets = getEligibleAssets(salesRepId);
            System.debug('ë¶„ì„ ëŒ€ìƒ Assets: ' + assets.size() + 'ê°œ');
            
            if (assets.isEmpty()) {
                result.summary = 'ë¶„ì„ ê°€ëŠ¥í•œ Assetsì´ ì—†ìŠµë‹ˆë‹¤.';
                return result;
            }
            
            // 2. ê° Assetë³„ ìš°ì„ ìˆœìœ„ ê³„ì‚°
            List<AssetPriority> priorities = new List<AssetPriority>();
            for (Asset asset : assets) {
                AssetPriority priority = calculateAssetPriority(asset);
                priorities.add(priority);
                
                // ì „ì²´ í†µê³„ ì§‘ê³„
                result.totalExpectedRevenue += priority.expectedRevenue;
                
                if (priority.score >= 80) {
                    result.urgentCount++;
                } else if (priority.score >= 60) {
                    result.importantCount++;
                } else {
                    result.normalCount++;
                }
            }
            
            // 3. ì ìˆ˜ë³„ ì •ë ¬ ë° ìƒìœ„ Nê°œ ì„ íƒ
            priorities.sort();
            
            // ìƒìœ„ Nê°œë§Œ ì„ íƒ
            List<AssetPriority> topPriorities = new List<AssetPriority>();
            for (Integer i = 0; i < Math.min(topN, priorities.size()); i++) {
                topPriorities.add(priorities[i]);
            }
            
            result.priorities = topPriorities;
            
            // 4. ìš”ì•½ ë©”ì‹œì§€ ìƒì„±
            result.summary = generateSummary(result);
            
            System.debug('=== ìš°ì„ ìˆœìœ„ ê³„ì‚° ì™„ë£Œ ===');
            System.debug('ê¸´ê¸‰: ' + result.urgentCount + 'ê±´, ì¤‘ìš”: ' + result.importantCount + 'ê±´, ì¼ë°˜: ' + result.normalCount + 'ê±´');
            System.debug('ì´ ì˜ˆìƒ ë§¤ì¶œ: â‚©' + result.totalExpectedRevenue?.format());
            
            return result;
            
        } catch (Exception e) {
            System.debug('ìš°ì„ ìˆœìœ„ ê³„ì‚° ì˜¤ë¥˜: ' + e.getMessage());
            System.debug('Stack Trace: ' + e.getStackTraceString());
            
            PriorityResult errorResult = new PriorityResult();
            errorResult.summary = 'ìš°ì„ ìˆœìœ„ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage();
            return errorResult;
        }
    }
    
    /**
     * ë¶„ì„ ëŒ€ìƒ Assets ì¡°íšŒ
     * @param salesRepId ì˜ì—…ì‚¬ì› ID
     * @return List<Asset> ë¶„ì„ ê°€ëŠ¥í•œ Assets
     */
    private static List<Asset> getEligibleAssets(Id salesRepId) {
        try {
            return [
                SELECT Id, Name, AccountId, Account.Name, Account.Phone, Account.Industry,
                       Status, InstallDate, PurchaseDate, Price, SerialNumber, 
                       Product2Id, Product2.Name, Product2.Family,
                       ContactId, Contact.Name, Contact.Email
                FROM Asset 
                WHERE Account.OwnerId = :salesRepId
                AND Status IN ('Installed', 'Registered', 'Shipped')
                AND InstallDate != null
                ORDER BY InstallDate DESC
                LIMIT 200 // Governor Limit ê³ ë ¤
            ];
        } catch (Exception e) {
            System.debug('Assets ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage());
            return new List<Asset>();
        }
    }
    
    /**
     * ê°œë³„ Asset ìš°ì„ ìˆœìœ„ ê³„ì‚°
     * @param asset Asset ë ˆì½”ë“œ
     * @return AssetPriority ìš°ì„ ìˆœìœ„ ì •ë³´
     */
    private static AssetPriority calculateAssetPriority(Asset asset) {
        AssetPriority priority = new AssetPriority();
        priority.asset = asset;
        
        Decimal score = 0;
        
        // 1. ê°±ì‹  ì„ë°•ë„ ê³„ì‚° (50ì ) - ê°€ì¥ ì¤‘ìš”í•œ ìš”ì†Œ
        Integer daysFromInstall = asset.InstallDate.daysBetween(Date.today());
        priority.daysFromInstall = daysFromInstall;
        
        if (daysFromInstall >= 1 && daysFromInstall <= 365) {
            // ê°±ì‹  ì ê¸° (1ì¼ ì´ìƒ)
            score += 50;
            priority.renewalStatus = 'ê°±ì‹  ì ê¸°';
            priority.actionRecommendation = 'ğŸ”¥ ì¦‰ì‹œ ê°±ì‹  ë…¼ì˜ ì‹œì‘';
        } else if (daysFromInstall >= 1 && daysFromInstall < 30) {
            // ê°±ì‹  ì˜ˆì • (1ì¼-1ê°œì›”)
            score += 30;
            priority.renewalStatus = 'ê°±ì‹  ì˜ˆì •';
            priority.actionRecommendation = 'â° 2ì£¼ ë‚´ ê°±ì‹  ì¤€ë¹„';
        } else if (daysFromInstall >= 1 && daysFromInstall < 7) {
            // ê°±ì‹  ëŒ€ê¸° (1ì¼-1ì£¼)
            score += 15;
            priority.renewalStatus = 'ê°±ì‹  ëŒ€ê¸°';
            priority.actionRecommendation = 'ğŸ“… ê´€ê³„ ê°•í™” í•„ìš”';
        } else {
            priority.renewalStatus = 'ê°±ì‹  ì‹œê¸° ì•„ë‹˜';
            priority.actionRecommendation = 'ğŸ“‹ ì •ê¸° ì ê²€';
        }
        
        // 2. ë§¤ì¶œ ê·œëª¨ ê³„ì‚° (30ì ) - ìˆ˜ìµì„± ê³ ë ¤
        if (asset.Price != null) {
            if (asset.Price >= 5000000) {
                // ê³ ì•¡ (500ë§Œì› ì´ìƒ)
                score += 30;
            } else if (asset.Price >= 1000000) {
                // ì¤‘ì•¡ (100ë§Œì› ì´ìƒ)
                score += 15;
            }
            // ì†Œì•¡ì€ 0ì 
        }
        
        // 3. ê³ ê° ì•ˆì •ì„± ê³„ì‚° (20ì ) - ê´€ê³„ ê±´ê°•ë„
        Integer caseCount = getCaseCount(asset.AccountId);
        
        if (caseCount == 0) {
            // ë¬¸ì œ ì—†ìŒ
            score += 20;
        } else if (caseCount <= 2) {
            // ê²½ë¯¸í•œ ë¬¸ì œ
            score += 10;
        }
        // ë§ì€ ë¬¸ì œëŠ” 0ì 
        
        // ìµœì¢… ì ìˆ˜ ë° ë“±ê¸‰ ì„¤ì •
        priority.score = score;
        priority.urgencyLevel = getUrgencyLevel(score);
        priority.urgencyColor = getUrgencyColor(score);
        
        // ì˜ˆìƒ ë§¤ì¶œ ê³„ì‚° (ê°±ì‹  í™•ë¥  ì ìš©)
        if (asset.Price != null) {
            Decimal renewalProbability = calculateRenewalProbability(score);
            priority.expectedRevenue = asset.Price * (renewalProbability / 100);
        } else {
            priority.expectedRevenue = 0;
        }
        
        return priority;
    }
    
    /**
     * ê¸´ê¸‰ë„ ë ˆë²¨ ê³„ì‚°
     * @param score ìš°ì„ ìˆœìœ„ ì ìˆ˜
     * @return String ê¸´ê¸‰ë„ ë ˆë²¨
     */
    private static String getUrgencyLevel(Decimal score) {
        if (score >= 80) {
            return 'ê¸´ê¸‰';
        } else if (score >= 60) {
            return 'ì¤‘ìš”';
        } else if (score >= 40) {
            return 'ì¼ë°˜';
        } else {
            return 'ë‚®ìŒ';
        }
    }
    
    /**
     * ê¸´ê¸‰ë„ ìƒ‰ìƒ ê³„ì‚°
     * @param score ìš°ì„ ìˆœìœ„ ì ìˆ˜
     * @return String ìƒ‰ìƒ ì½”ë“œ
     */
    private static String getUrgencyColor(Decimal score) {
        if (score >= 80) {
            return 'slds-theme_error'; // ë¹¨ê°„ìƒ‰
        } else if (score >= 60) {
            return 'slds-theme_warning'; // ì£¼í™©ìƒ‰
        } else if (score >= 40) {
            return 'slds-theme_success'; // ë…¹ìƒ‰
        } else {
            return 'slds-theme_neutral'; // íšŒìƒ‰
        }
    }
    
    /**
     * ê°±ì‹  í™•ë¥  ê³„ì‚°
     * @param score ìš°ì„ ìˆœìœ„ ì ìˆ˜
     * @return Decimal ê°±ì‹  í™•ë¥  (0-100)
     */
    private static Decimal calculateRenewalProbability(Decimal score) {
        if (score >= 90) {
            return 90; // ë§¤ìš° ë†’ìŒ
        } else if (score >= 80) {
            return 80; // ë†’ìŒ
        } else if (score >= 60) {
            return 65; // ë³´í†µ
        } else if (score >= 40) {
            return 45; // ë‚®ìŒ
        } else {
            return 25; // ë§¤ìš° ë‚®ìŒ
        }
    }
    
    /**
     * ìš”ì•½ ë©”ì‹œì§€ ìƒì„±
     * @param result ìš°ì„ ìˆœìœ„ ê²°ê³¼
     * @return String ìš”ì•½ ë©”ì‹œì§€
     */
    private static String generateSummary(PriorityResult result) {
        String summary = '';
        
        if (result.urgentCount > 0) {
            summary += 'ğŸ”¥ ê¸´ê¸‰: ' + result.urgentCount + 'ê±´ ';
        }
        if (result.importantCount > 0) {
            summary += 'âš ï¸ ì¤‘ìš”: ' + result.importantCount + 'ê±´ ';
        }
        if (result.normalCount > 0) {
            summary += 'ğŸ“‹ ì¼ë°˜: ' + result.normalCount + 'ê±´';
        }
        
        if (result.totalExpectedRevenue > 0) {
            summary += ' | ì˜ˆìƒ ë§¤ì¶œ: â‚©' + result.totalExpectedRevenue.format();
        }
        
        if (String.isBlank(summary)) {
            summary = 'ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
        }
        
        return summary.trim();
    }
    
    /**
     * ë¹ ë¥¸ TOP 5 ì¡°íšŒ (ìºì‹œ ê°€ëŠ¥)
     * @return PriorityResult TOP 5 ìš°ì„ ìˆœìœ„
     */
    @AuraEnabled(cacheable=true)
    public static PriorityResult getTop5Priorities() {
        return calculatePriorities(null, 5);
    }
    
    /**
     * íŠ¹ì • Accountì˜ Assets ìš°ì„ ìˆœìœ„ ì¡°íšŒ
     * @param accountId Account ID
     * @return PriorityResult Account Assets ìš°ì„ ìˆœìœ„
     */
    @AuraEnabled(cacheable=true)
    public static PriorityResult getAccountAssetPriorities(Id accountId) {
        try {
            List<Asset> assets = [
                SELECT Id, Name, AccountId, Account.Name, Account.Phone,
                       Status, InstallDate, Price, SerialNumber, 
                       Product2.Name, Contact.Name
                FROM Asset 
                WHERE AccountId = :accountId
                AND Status IN ('Installed', 'Registered')
                AND InstallDate != null
                ORDER BY InstallDate DESC
            ];
            
            PriorityResult result = new PriorityResult();
            
            for (Asset asset : assets) {
                AssetPriority priority = calculateAssetPriority(asset);
                result.priorities.add(priority);
                result.totalExpectedRevenue += priority.expectedRevenue;
            }
            
            result.priorities.sort();
            result.summary = 'Account Assets: ' + assets.size() + 'ê°œ';
            
            return result;
            
        } catch (Exception e) {
            PriorityResult errorResult = new PriorityResult();
            errorResult.summary = 'Account Assets ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage();
            return errorResult;
        }
    }
    
    /**
     * Accountì˜ ìµœê·¼ 90ì¼ Case ìˆ˜ ì¡°íšŒ
     * @param accountId Account ID
     * @return Integer Case ìˆ˜
     */
    private static Integer getCaseCount(Id accountId) {
        try {
            if (accountId == null) return 0;
            
            List<AggregateResult> results = [
                SELECT COUNT(Id) caseCount
                FROM Case 
                WHERE AccountId = :accountId 
                AND CreatedDate = LAST_N_DAYS:90
            ];
            
            if (results.isEmpty()) return 0;
            return (Integer) results[0].get('caseCount');
            
        } catch (Exception e) {
            System.debug('Case ìˆ˜ ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage());
            return 0; // ì˜¤ë¥˜ ì‹œ ì•ˆì „í•œ ê¸°ë³¸ê°’
        }
    }
}
