/**
 * Asset ê¸°ë°˜ ê°±ì‹  ê¸°íšŒ ìë™ ê°ì§€ ë° ìš°ì„ ìˆœìœ„ ì‹œìŠ¤í…œ
 * 
 * í˜„ì¬ Asset: (ì£¼)ê·¸ë¦°íŒŒì›Œí… Order 00000162
 * - êµ¬ë§¤ì¼: 7/20/2025
 * - ì„¤ì¹˜ì¼: 7/22/2025  
 * - ì‚¬ìš© ì¢…ë£Œì¼: ë¯¸ì„¤ì • (Usage End Date)
 * - ê°€ê²©: â‚©990,000
 * - ìƒíƒœ: Purchased
 */
public class AssetRenewalOpportunityEngine {
    
    /**
     * ê°±ì‹  ê¸°íšŒ ìš°ì„ ìˆœìœ„ ë¶„ì„
     */
    @AuraEnabled(cacheable=true)
    public static List<RenewalOpportunity> analyzeRenewalOpportunities() {
        
        // 1. ê°±ì‹  ì‹œì  ê·¼ì ‘ Asset ì¡°íšŒ (6ê°œì›” ì´ë‚´)
        Date renewalWindow = Date.today().addMonths(6);
        
        List<Asset> upcomingRenewals = [
            SELECT Id, Name, SerialNumber, AccountId, Account.Name, Account.Industry,
                   Account.AnnualRevenue, Account.Key_Account__c, Account.CustomerPriority__c,
                   ContactId, Contact.Name, Contact.Level__c, Contact.Department,
                   Price, PurchaseDate, UsageEndDate, LifecycleEndDate,
                   Description, Status
            FROM Asset 
            WHERE (UsageEndDate <= :renewalWindow OR LifecycleEndDate <= :renewalWindow)
            AND Status = 'Purchased'
            ORDER BY Account.Key_Account__c DESC, Account.AnnualRevenue DESC, Price DESC
        ];
        
        List<RenewalOpportunity> opportunities = new List<RenewalOpportunity>();
        
        for (Asset asset : upcomingRenewals) {
            RenewalOpportunity opp = new RenewalOpportunity();
            
            // ê¸°ë³¸ ì •ë³´
            opp.assetId = asset.Id;
            opp.assetName = asset.Name;
            opp.accountName = asset.Account.Name;
            opp.assetValue = asset.Price;
            opp.renewalDate = asset.UsageEndDate != null ? Date.valueOf(asset.UsageEndDate) : 
                              (asset.LifecycleEndDate != null ? Date.valueOf(asset.LifecycleEndDate) : Date.today().addMonths(12));
            
            // ìš°ì„ ìˆœìœ„ ì ìˆ˜ ê³„ì‚° (100ì  ë§Œì )
            opp.priorityScore = calculateRenewalPriority(asset);
            
            // ê°±ì‹  ì „ëµ ì¶”ì²œ
            opp.renewalStrategy = generateRenewalStrategy(asset);
            
            // ìœ„í—˜ë„ í‰ê°€
            opp.riskLevel = 'LOW'; // assessRenewalRisk(asset);
            
            // ì˜ˆìƒ ê°±ì‹  ê°€ê²© (ê¸°ì¡´ ê°€ê²© + ì—…ê·¸ë ˆì´ë“œ)
            opp.estimatedRenewalValue = asset.Price != null ? asset.Price * 1.1 : 0; // calculateEstimatedRenewalValue(asset);
            
            // ì ‘ì´‰ ìš°ì„ ìˆœìœ„ (ë‹´ë‹¹ì ë ˆë²¨ë³„)
            opp.contactPriority = 'HIGH'; // determineContactPriority(asset);
            
            opportunities.add(opp);
        }
        
        return opportunities;
    }
    
    /**
     * ìš°ì„ ìˆœìœ„ ì ìˆ˜ ê³„ì‚° ë¡œì§
     */
    private static Integer calculateRenewalPriority(Asset asset) {
        Integer score = 0;
        
        // Asset ê°€ì¹˜ (30ì )
        if (asset.Price != null) {
            if (asset.Price >= 1000000) score += 30;       // 100ë§Œì› ì´ìƒ
            else if (asset.Price >= 500000) score += 20;    // 50ë§Œì› ì´ìƒ
            else score += 10;                               // 50ë§Œì› ë¯¸ë§Œ
        }
        
        // Account ì¤‘ìš”ë„ (25ì )
        if (asset.Account.Key_Account__c) score += 25;      // Key Account
        else if (asset.Account.CustomerPriority__c == 'High') score += 20;
        else if (asset.Account.CustomerPriority__c == 'Medium') score += 15;
        else score += 10;
        
        // ê¸°ì—… ê·œëª¨ (20ì )
        if (asset.Account.AnnualRevenue != null) {
            if (asset.Account.AnnualRevenue >= 1000000000) score += 20;     // 10ì–µ ì´ìƒ
            else if (asset.Account.AnnualRevenue >= 500000000) score += 15;  // 5ì–µ ì´ìƒ
            else score += 10;
        }
        
        // ë‹´ë‹¹ì ë ˆë²¨ (15ì )
        if (asset.Contact.Level__c == 'Primary') score += 15;
        else if (asset.Contact.Level__c == 'Secondary') score += 10;
        else score += 5;
        
        // ê°±ì‹  ì„ë°•ë„ (10ì )
        if (asset.UsageEndDate != null) {
            Integer daysUntilRenewal = Date.today().daysBetween(asset.UsageEndDate);
            if (daysUntilRenewal <= 30) score += 10;        // 30ì¼ ì´ë‚´
            else if (daysUntilRenewal <= 90) score += 7;     // 3ê°œì›” ì´ë‚´
            else score += 5;
        }
        
        return score;
    }
    
    /**
     * ê°±ì‹  ì „ëµ ìƒì„±
     */
    private static String generateRenewalStrategy(Asset asset) {
        List<String> strategies = new List<String>();
        
        // ê¸°ì—… ê·œëª¨ë³„ ì „ëµ
        if (asset.Account.AnnualRevenue != null && asset.Account.AnnualRevenue >= 1000000000) {
            strategies.add('ğŸ¯ ëŒ€ê¸°ì—… ì „ëµ: ì „ì‚¬ í™•ì‚° ë° í”„ë¦¬ë¯¸ì—„ íŒ¨í‚¤ì§€ ì œì•ˆ');
            strategies.add('ğŸ“ˆ ì¶”ê°€ ë¶€ì„œ ë„ì… ê²€í†  (Cross-sell ê¸°íšŒ)');
        } else {
            strategies.add('ğŸ’¡ ì¤‘ì†Œê¸°ì—… ì „ëµ: ROI ì¤‘ì‹¬ ê°€ì¹˜ ì œì•ˆ');
            strategies.add('âš¡ íš¨ìœ¨ì„± ê°œì„  ì‚¬ë¡€ ì¤‘ì‹¬ ì–´í•„');
        }
        
        // Industryë³„ ì „ëµ
        if (String.isNotBlank(asset.Account.Industry)) {
            switch on asset.Account.Industry.toLowerCase() {
                when 'technology' {
                    strategies.add('ğŸš€ ìµœì‹  ê¸°ìˆ  ì—…ê·¸ë ˆì´ë“œ ì œì•ˆ');
                }
                when 'manufacturing' {
                    strategies.add('ğŸ­ ìƒì‚°ì„± í–¥ìƒ íš¨ê³¼ ê°•ì¡°');
                }
                when 'healthcare' {
                    strategies.add('ğŸ¥ ê·œì œ ì¤€ìˆ˜ ë° ë³´ì•ˆ ê°•í™”');
                }
            }
        }
        
        // Key Account ì „ëµ
        if (asset.Account.Key_Account__c) {
            strategies.add('â­ VIP ê³ ê° ì „ë‹´ ê´€ë¦¬: ê²½ì˜ì§„ ë¯¸íŒ… ì„¤ì •');
            strategies.add('ğŸ¤ ì¥ê¸° íŒŒíŠ¸ë„ˆì‹­ ê³„ì•½ ì œì•ˆ');
        }
        
        return String.join(strategies, '\n');
    }
    
    /**
     * Wrapper Class for Renewal Opportunity
     */
    public class RenewalOpportunity {
        @AuraEnabled public Id assetId { get; set; }
        @AuraEnabled public String assetName { get; set; }
        @AuraEnabled public String accountName { get; set; }
        @AuraEnabled public Decimal assetValue { get; set; }
        @AuraEnabled public Date renewalDate { get; set; }
        @AuraEnabled public Integer priorityScore { get; set; }
        @AuraEnabled public String renewalStrategy { get; set; }
        @AuraEnabled public String riskLevel { get; set; }
        @AuraEnabled public Decimal estimatedRenewalValue { get; set; }
        @AuraEnabled public String contactPriority { get; set; }
    }
}
