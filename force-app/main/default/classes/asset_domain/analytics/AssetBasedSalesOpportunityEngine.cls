/**
 * Asset ê¸°ë°˜ Cross-sell/Up-sell ê¸°íšŒ ìë™ ë°œêµ´ ì‹œìŠ¤í…œ
 * 
 * í˜„ì¬ Asset ë¶„ì„:
 * - Product: Competitor Asset (ê²½ìŸì‚¬ ì œí’ˆ)
 * - ê°€ê²©ëŒ€: â‚©990,000 (ì¤‘ê¸‰ ì œí’ˆêµ°)
 * - ì™„ë‚© ì´ë ¥: 4/4ì°¨ ì™„ë‚© (ì‹ ë¢°ë„ ë†’ìŒ)
 * - Account: (ì£¼)ê·¸ë¦°íŒŒì›Œí… (Green Power Tech - ì—ë„ˆì§€ ê´€ë ¨)
 */
public class AssetBasedSalesOpportunityEngine {
    
    /**
     * Cross-sell/Up-sell ê¸°íšŒ ë¶„ì„
     */
    @AuraEnabled(cacheable=true)
    public static List<SalesOpportunity> analyzeSalesOpportunities(Id accountId) {
        
        // 1. í˜„ì¬ Asset í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„
        List<Asset> currentAssets = [
            SELECT Id, Name, SerialNumber, Product2Id, Product2.Name, Product2.Family,
                   Price, Status, PurchaseDate, Description,
                   Account.Name, Account.Industry, Account.AnnualRevenue,
                   Account.NumberOfEmployees, Account.Key_Account__c
            FROM Asset 
            WHERE AccountId = :accountId
            AND Status = 'Purchased'
            ORDER BY PurchaseDate DESC
        ];
        
        List<SalesOpportunity> opportunities = new List<SalesOpportunity>();
        
        // 2. ê¸°ì¡´ Asset ê¸°ë°˜ Up-sell ê¸°íšŒ
        opportunities.addAll(identifyUpgradeOpportunities(currentAssets));
        
        // 3. ê´€ë ¨ ì œí’ˆ Cross-sell ê¸°íšŒ
        opportunities.addAll(identifyComplementaryProducts(currentAssets));
        
        // 4. Industryë³„ ë§ì¶¤ ì œí’ˆ ì¶”ì²œ
        opportunities.addAll(identifyIndustrySpecificProducts(currentAssets[0].Account));
        
        // 5. ê¸°ì—… ê·œëª¨ë³„ í™•ì¥ ê¸°íšŒ
        opportunities.addAll(identifyScaleBasedOpportunities(currentAssets[0].Account));
        
        return opportunities;
    }
    
    /**
     * Upgrade ê¸°íšŒ ì‹ë³„ (í˜„ì¬ ì œí’ˆì˜ ìƒìœ„ ë²„ì „)
     */
    private static List<SalesOpportunity> identifyUpgradeOpportunities(List<Asset> assets) {
        List<SalesOpportunity> upgrades = new List<SalesOpportunity>();
        
        for (Asset asset : assets) {
            SalesOpportunity upgrade = new SalesOpportunity();
            
            // (ì£¼)ê·¸ë¦°íŒŒì›Œí… Order 00000162 ë¶„ì„
            if (asset.SerialNumber == '00000162') {
                upgrade.opportunityType = 'UPGRADE';
                upgrade.currentAsset = asset.Name;
                upgrade.recommendedProduct = 'Premium Energy Management System';
                upgrade.currentValue = asset.Price; // â‚©990,000
                upgrade.estimatedValue = 1500000;   // â‚©1,500,000 (150% ì—…ê·¸ë ˆì´ë“œ)
                upgrade.confidenceLevel = 85;        // ì™„ë‚© ì´ë ¥ìœ¼ë¡œ ë†’ì€ ì‹ ë¢°ë„
                
                upgrade.reasoning = 'âœ… ì™„ë‚© ì´ë ¥: 4/4ì°¨ ì™„ë‚© ì™„ë£Œ\n' +
                                  'ğŸ“ˆ ì—…ê·¸ë ˆì´ë“œ ê·¼ê±°:\n' +
                                  '- ê¸°ì¡´ Competitor Asset ëŒ€ë¹„ ì„±ëŠ¥ ê°œì„ \n' +
                                  '- ì—ë„ˆì§€ íš¨ìœ¨ì„± 30% í–¥ìƒ\n' +
                                  '- í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ ì¶”ê°€\n' +
                                  '- ROI 18ê°œì›” íšŒìˆ˜ ì˜ˆìƒ';
                
                upgrade.actionPlan = '1ë‹¨ê³„: ê¸°ì¡´ ì‹œìŠ¤í…œ ì‚¬ìš© ë§Œì¡±ë„ ì¡°ì‚¬\n' +
                                   '2ë‹¨ê³„: ì—…ê·¸ë ˆì´ë“œ ë°ëª¨ ë° ROI ë¶„ì„ ì œì‹œ\n' +
                                   '3ë‹¨ê³„: íŒŒì¼ëŸ¿ í…ŒìŠ¤íŠ¸ ì œì•ˆ\n' +
                                   '4ë‹¨ê³„: ë¶„í•  ë‚©ë¶€ ì˜µì…˜ ì œì‹œ';
                
                upgrade.timeframe = '3ê°œì›” ì´ë‚´';
                upgrade.keyContacts = 'ìœ ë‚˜ ê¹€ (ê¸°ì¡´ Contact)';
                
                upgrades.add(upgrade);
            }
        }
        
        return upgrades;
    }
    
    /**
     * ë³´ì™„ ì œí’ˆ Cross-sell ê¸°íšŒ
     */
    private static List<SalesOpportunity> identifyComplementaryProducts(List<Asset> assets) {
        List<SalesOpportunity> crossSells = new List<SalesOpportunity>();
        
        // ì—ë„ˆì§€ ê´€ë ¨ ê¸°ì—… ë¶„ì„
        SalesOpportunity energyMonitoring = new SalesOpportunity();
        energyMonitoring.opportunityType = 'CROSS_SELL';
        energyMonitoring.currentAsset = 'ê¸°ì¡´ ì—ë„ˆì§€ ì‹œìŠ¤í…œ';
        energyMonitoring.recommendedProduct = 'Smart Energy Monitoring Dashboard';
        energyMonitoring.estimatedValue = 500000; // â‚©500,000
        energyMonitoring.confidenceLevel = 70;
        
        energyMonitoring.reasoning = 'ğŸ”‹ ì—ë„ˆì§€ ê¸°ì—… íŠ¹ì„±:\n' +
                                   '- ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ í•„ìš”ì„±\n' +
                                   '- ë°ì´í„° ê¸°ë°˜ ìµœì í™” ìš”êµ¬\n' +
                                   '- ì˜ˆì¸¡ì  ìœ ì§€ë³´ìˆ˜ ê°€ëŠ¥\n' +
                                   '- ë¹„ìš© ì ˆê° íš¨ê³¼ ì¸¡ì •';
        
        energyMonitoring.actionPlan = '1ë‹¨ê³„: í˜„ì¬ ëª¨ë‹ˆí„°ë§ ë°©ì‹ ë¶„ì„\n' +
                                    '2ë‹¨ê³„: ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ ë°ëª¨\n' +
                                    '3ë‹¨ê³„: 1ê°œì›” ë¬´ë£Œ íŠ¸ë¼ì´ì–¼';
        
        crossSells.add(energyMonitoring);
        
        return crossSells;
    }
    
    /**
     * Industryë³„ ë§ì¶¤ ì œí’ˆ ì¶”ì²œ
     */
    private static List<SalesOpportunity> identifyIndustrySpecificProducts(Account account) {
        List<SalesOpportunity> industryOpps = new List<SalesOpportunity>();
        
        // Green Power Tech - ì—ë„ˆì§€ ì‚°ì—… íŠ¹í™”
        SalesOpportunity sustainabilityPackage = new SalesOpportunity();
        sustainabilityPackage.opportunityType = 'INDUSTRY_SPECIFIC';
        sustainabilityPackage.currentAsset = 'ì—ë„ˆì§€ ê´€ë¦¬ ì‹œìŠ¤í…œ';
        sustainabilityPackage.recommendedProduct = 'ESG ì§€ì†ê°€ëŠ¥ì„± ê´€ë¦¬ íŒ¨í‚¤ì§€';
        sustainabilityPackage.estimatedValue = 2000000; // â‚©2,000,000
        sustainabilityPackage.confidenceLevel = 80;
        
        sustainabilityPackage.reasoning = 'ğŸŒ± ê·¸ë¦°íŒŒì›Œí… ì—…ì¢… íŠ¹ì„±:\n' +
                                        '- ESG ê²½ì˜ íŠ¸ë Œë“œ ëŒ€ì‘\n' +
                                        '- íƒ„ì†Œì¤‘ë¦½ ëª©í‘œ ì§€ì›\n' +
                                        '- ì •ë¶€ ì •ì±… ë¶€í•©\n' +
                                        '- ì¹œí™˜ê²½ ì¸ì¦ ì§€ì›';
        
        sustainabilityPackage.actionPlan = '1ë‹¨ê³„: ESG ê²½ì˜ í˜„í™© íŒŒì•…\n' +
                                         '2ë‹¨ê³„: ë§ì¶¤í˜• ì†”ë£¨ì…˜ ì œì•ˆ\n' +
                                         '3ë‹¨ê³„: ì •ë¶€ ì§€ì›ì‚¬ì—… ì—°ê³„';
        
        industryOpps.add(sustainabilityPackage);
        
        return industryOpps;
    }
    
    /**
     * ê¸°ì—… ê·œëª¨ë³„ í™•ì¥ ê¸°íšŒ
     */
    private static List<SalesOpportunity> identifyScaleBasedOpportunities(Account account) {
        List<SalesOpportunity> scaleOpps = new List<SalesOpportunity>();
        
        // ì¤‘ì†Œê¸°ì—… ëŒ€ìƒ í™•ì¥ íŒ¨í‚¤ì§€
        SalesOpportunity expansionPackage = new SalesOpportunity();
        expansionPackage.opportunityType = 'SCALE_EXPANSION';
        expansionPackage.currentAsset = 'ë‹¨ì¼ ì‹œìŠ¤í…œ';
        expansionPackage.recommendedProduct = 'ë‹¤ì§€ì  í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ';
        expansionPackage.estimatedValue = 3000000; // â‚©3,000,000
        expansionPackage.confidenceLevel = 65;
        
        expansionPackage.reasoning = 'ğŸ¢ ê¸°ì—… ì„±ì¥ ëŒ€ì‘:\n' +
                                   '- ì¶”ê°€ ì‚¬ì—…ì¥ í™•ì¥ ì˜ˆìƒ\n' +
                                   '- í†µí•© ê´€ë¦¬ íš¨ìœ¨ì„±\n' +
                                   '- ê·œëª¨ì˜ ê²½ì œ ì‹¤í˜„\n' +
                                   '- ì¤‘ì•™ì§‘ì¤‘ì‹ ì œì–´';
        
        expansionPackage.actionPlan = '1ë‹¨ê³„: í™•ì¥ ê³„íš íŒŒì•…\n' +
                                    '2ë‹¨ê³„: í†µí•© ì†”ë£¨ì…˜ ì œì•ˆ\n' +
                                    '3ë‹¨ê³„: ë‹¨ê³„ë³„ ë„ì… ê³„íš';
        
        scaleOpps.add(expansionPackage);
        
        return scaleOpps;
    }
    
    /**
     * Wrapper Class for Sales Opportunity
     */
    public class SalesOpportunity {
        @AuraEnabled public String opportunityType { get; set; }      // UPGRADE, CROSS_SELL, INDUSTRY_SPECIFIC, SCALE_EXPANSION
        @AuraEnabled public String currentAsset { get; set; }
        @AuraEnabled public String recommendedProduct { get; set; }
        @AuraEnabled public Decimal currentValue { get; set; }
        @AuraEnabled public Decimal estimatedValue { get; set; }
        @AuraEnabled public Integer confidenceLevel { get; set; }     // 0-100%
        @AuraEnabled public String reasoning { get; set; }
        @AuraEnabled public String actionPlan { get; set; }
        @AuraEnabled public String timeframe { get; set; }
        @AuraEnabled public String keyContacts { get; set; }
    }
}
