/**
 * ë¡œì§ 2: ì›í´ë¦­ ê°±ì‹  ì›Œí¬í”Œë¡œìš° ì„œë¹„ìŠ¤
 * ì˜ì—…ì‚¬ì›ì´ ë²„íŠ¼ í•˜ë‚˜ë¡œ ê°±ì‹  í”„ë¡œì„¸ìŠ¤ë¥¼ ì™„ë£Œí•  ìˆ˜ ìˆë„ë¡ ì§€ì›
 * 
 * ëª©ì : "ë³µì¡í•œ ê°±ì‹  ì—…ë¬´ë¥¼ 5ì´ˆ ë§Œì—" â†’ 20ë¶„ â†’ 5ì´ˆë¡œ ë‹¨ì¶•
 * ë°©ì‹: Asset ê¸°ë°˜ Opportunity + Task ìë™ ìƒì„±
 */

public class OneClickRenewalService {
    
    // ê°±ì‹  ê²°ê³¼ ë˜í¼ í´ë˜ìŠ¤
    public class RenewalResult {
        @AuraEnabled public Boolean success { get; set; }
        @AuraEnabled public String message { get; set; }
        @AuraEnabled public Id opportunityId { get; set; }
        @AuraEnabled public Id taskId { get; set; }
        @AuraEnabled public String opportunityName { get; set; }
        @AuraEnabled public Decimal expectedRevenue { get; set; }
        @AuraEnabled public Date closeDate { get; set; }
        
        public RenewalResult() {
            this.success = false;
        }
    }
    
    /**
     * ë©”ì¸ ë©”ì„œë“œ: ì›í´ë¦­ ê°±ì‹  í”„ë¡œì„¸ìŠ¤ ì‹œì‘
     * @param assetId Asset ID
     * @return RenewalResult ê°±ì‹  ì²˜ë¦¬ ê²°ê³¼
     */
    @AuraEnabled
    public static RenewalResult startRenewalProcess(Id assetId) {
        RenewalResult result = new RenewalResult();
        
        try {
            System.debug('=== ì›í´ë¦­ ê°±ì‹  í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ===');
            System.debug('Asset ID: ' + assetId);
            
            // 1. Asset ì •ë³´ ê²€ì¦ ë° ì¡°íšŒ
            Asset assetInfo = validateAndGetAsset(assetId);
            if (assetInfo == null) {
                result.message = 'Asset ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                return result;
            }
            
            // 2. ì¤‘ë³µ ê°±ì‹  Opportunity í™•ì¸
            if (hasDuplicateRenewalOpportunity(assetInfo)) {
                result.message = 'ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ê°±ì‹  ê¸°íšŒê°€ ìˆìŠµë‹ˆë‹¤.';
                return result;
            }
            
            // 3. Opportunity ìë™ ìƒì„±
            Opportunity renewalOpp = createRenewalOpportunity(assetInfo);
            if (renewalOpp == null) {
                result.message = 'Opportunity ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                return result;
            }
            
            // 4. Follow-up Task ìë™ ìƒì„±
            Task followupTask = createFollowupTask(assetInfo, renewalOpp);
            if (followupTask == null) {
                result.message = 'Task ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                return result;
            }
            
            // 5. ì„±ê³µ ê²°ê³¼ ì„¤ì •
            result.success = true;
            result.message = 'ê°±ì‹  í”„ë¡œì„¸ìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.';
            result.opportunityId = renewalOpp.Id;
            result.taskId = followupTask.Id;
            result.opportunityName = renewalOpp.Name;
            result.expectedRevenue = renewalOpp.Amount;
            result.closeDate = renewalOpp.CloseDate;
            
            System.debug('âœ… ì›í´ë¦­ ê°±ì‹  ì™„ë£Œ');
            System.debug('ìƒì„±ëœ Opportunity: ' + renewalOpp.Name);
            System.debug('ìƒì„±ëœ Task: ' + followupTask.Subject);
            
            return result;
            
        } catch (Exception e) {
            System.debug('âŒ ì›í´ë¦­ ê°±ì‹  ì˜¤ë¥˜: ' + e.getMessage());
            System.debug('Stack Trace: ' + e.getStackTraceString());
            
            result.message = 'ê°±ì‹  í”„ë¡œì„¸ìŠ¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage();
            return result;
        }
    }
    
    /**
     * Asset ì •ë³´ ê²€ì¦ ë° ì¡°íšŒ
     * @param assetId Asset ID
     * @return Asset Asset ì •ë³´ (nullì´ë©´ ì˜¤ë¥˜)
     */
    private static Asset validateAndGetAsset(Id assetId) {
        try {
            List<Asset> assets = [
                SELECT Id, Name, AccountId, Account.Name, Account.Phone, Account.OwnerId,
                       ContactId, Contact.Name, Contact.Email, 
                       Product2Id, Product2.Name, Product2.Family,
                       SerialNumber, Status, PurchaseDate, InstallDate, Price,
                       LifecycleStartDate, LifecycleEndDate
                FROM Asset 
                WHERE Id = :assetId 
                AND Status IN ('Installed', 'Registered', 'Purchased')
                LIMIT 1
            ];
            
            if (assets.isEmpty()) {
                System.debug('Asset not found or invalid status: ' + assetId);
                return null;
            }
            
            Asset asset = assets[0];
            System.debug('Asset ê²€ì¦ ì™„ë£Œ: ' + asset.Name);
            
            // í•„ìˆ˜ ì •ë³´ í™•ì¸
            if (asset.AccountId == null) {
                System.debug('Asset has no Account: ' + assetId);
                return null;
            }
            
            if (asset.Price == null || asset.Price <= 0) {
                System.debug('Asset has no valid price: ' + assetId);
                return null;
            }
            
            return asset;
            
        } catch (Exception e) {
            System.debug('Asset ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage());
            return null;
        }
    }
    
    /**
     * ì¤‘ë³µ ê°±ì‹  Opportunity í™•ì¸
     * @param assetInfo Asset ì •ë³´
     * @return Boolean ì¤‘ë³µ ì—¬ë¶€ (trueì´ë©´ ì¤‘ë³µ ì¡´ì¬)
     */
    private static Boolean hasDuplicateRenewalOpportunity(Asset assetInfo) {
        try {
            // ìµœê·¼ 6ê°œì›” ë‚´ ê°™ì€ Assetì— ëŒ€í•œ ê°±ì‹  Opportunity í™•ì¸
            String renewalName = '%ê°±ì‹ %';
            Date sixMonthsAgo = Date.today().addMonths(-6);
            
            List<Opportunity> existingRenewals = [
                SELECT Id, Name, StageName, CloseDate
                FROM Opportunity 
                WHERE AccountId = :assetInfo.AccountId
                AND (Name LIKE :renewalName OR Name LIKE '%Renewal%')
                AND (Name LIKE :('%' + assetInfo.Name + '%') OR 
                     Name LIKE :('%' + assetInfo.SerialNumber + '%'))
                AND StageName NOT IN ('Closed Won', 'Closed Lost')
                AND CreatedDate >= :sixMonthsAgo
                LIMIT 5
            ];
            
            if (!existingRenewals.isEmpty()) {
                System.debug('ì¤‘ë³µ ê°±ì‹  Opportunity ë°œê²¬: ' + existingRenewals.size() + 'ê°œ');
                for (Opportunity opp : existingRenewals) {
                    System.debug('- ' + opp.Name + ' (' + opp.StageName + ')');
                }
                return true;
            }
            
            return false;
            
        } catch (Exception e) {
            System.debug('ì¤‘ë³µ í™•ì¸ ì˜¤ë¥˜: ' + e.getMessage());
            return false; // ì˜¤ë¥˜ ì‹œ ì§„í–‰ í—ˆìš©
        }
    }
    
    /**
     * ê°±ì‹  Opportunity ìë™ ìƒì„±
     * @param assetInfo Asset ì •ë³´
     * @return Opportunity ìƒì„±ëœ Opportunity
     */
    private static Opportunity createRenewalOpportunity(Asset assetInfo) {
        try {
            Opportunity renewalOpp = new Opportunity();
            
            // ê¸°ë³¸ ì •ë³´ ì„¤ì •
            renewalOpp.Name = assetInfo.Account.Name + ' - ' + assetInfo.Name + ' ê°±ì‹ ';
            renewalOpp.AccountId = assetInfo.AccountId;
            renewalOpp.Amount = assetInfo.Price; // Asset ê°€ê²©ê³¼ ë™ì¼
            renewalOpp.CloseDate = Date.today().addDays(90); // 90ì¼ í›„ ë§ˆê°
            renewalOpp.StageName = 'Prospecting'; // ì´ˆê¸° ë‹¨ê³„
            renewalOpp.Type = 'Existing Customer - Renewal';
            
            // ì¶”ê°€ ì •ë³´ ì„¤ì •
            if (assetInfo.ContactId != null) {
                // Primary ContactëŠ” í‘œì¤€ í•„ë“œê°€ ì•„ë‹ˆë¯€ë¡œ ì£¼ì„ ì²˜ë¦¬
                // renewalOpp.Primary_Contact__c = assetInfo.ContactId;
            }
            
            // Description ì„¤ì •
            List<String> descParts = new List<String>();
            descParts.add('ğŸ”„ ìë™ ìƒì„±ëœ ê°±ì‹  ê¸°íšŒ');
            descParts.add('');
            descParts.add('ğŸ“‹ Asset ì •ë³´:');
            descParts.add('- Assetëª…: ' + assetInfo.Name);
            descParts.add('- Serial Number: ' + assetInfo.SerialNumber);
            descParts.add('- í˜„ì¬ ê°€ê²©: â‚©' + String.valueOf(assetInfo.Price));
            descParts.add('- ì„¤ì¹˜ì¼: ' + (assetInfo.InstallDate != null ? assetInfo.InstallDate.format() : 'ë¯¸í™•ì¸'));
            
            if (assetInfo.Contact.Name != null) {
                descParts.add('- ë‹´ë‹¹ì: ' + assetInfo.Contact.Name);
            }
            
            descParts.add('');
            descParts.add('ğŸ¯ ê°±ì‹  ëª©í‘œ:');
            descParts.add('- ê¸°ì¡´ ì„œë¹„ìŠ¤ ì—°ì¥');
            descParts.add('- ê³ ê° ë§Œì¡±ë„ ìœ ì§€');
            descParts.add('- ì¥ê¸° íŒŒíŠ¸ë„ˆì‹­ ê°•í™”');
            
            renewalOpp.Description = String.join(descParts, '\n');
            
            // Opportunity ì €ì¥
            insert renewalOpp;
            
            System.debug('âœ… Opportunity ìƒì„± ì™„ë£Œ: ' + renewalOpp.Name);
            
            // ìƒì„±ëœ Opportunity ì •ë³´ ë°˜í™˜ (ID í¬í•¨)
            return [SELECT Id, Name, Amount, CloseDate, StageName FROM Opportunity WHERE Id = :renewalOpp.Id];
            
        } catch (Exception e) {
            System.debug('âŒ Opportunity ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
            return null;
        }
    }
    
    /**
     * Follow-up Task ìë™ ìƒì„±
     * @param assetInfo Asset ì •ë³´
     * @param opportunity ìƒì„±ëœ Opportunity
     * @return Task ìƒì„±ëœ Task
     */
    private static Task createFollowupTask(Asset assetInfo, Opportunity opportunity) {
        try {
            Task followupTask = new Task();
            
            // ê¸°ë³¸ ì •ë³´ ì„¤ì •
            followupTask.Subject = 'ğŸ”„ ê°±ì‹  ë…¼ì˜: ' + assetInfo.Account.Name;
            followupTask.Status = 'Not Started';
            followupTask.Priority = 'High';
            followupTask.ActivityDate = Date.today().addDays(1); // ë‚´ì¼
            followupTask.OwnerId = UserInfo.getUserId(); // í˜„ì¬ ì‚¬ìš©ì
            
            // ì—°ê²° ì •ë³´ ì„¤ì •
            followupTask.WhatId = opportunity.Id; // Opportunityì™€ ì—°ê²°
            followupTask.WhoId = assetInfo.ContactId; // Contactì™€ ì—°ê²° (ìˆëŠ” ê²½ìš°)
            
            // Description ì„¤ì •
            List<String> taskDescParts = new List<String>();
            taskDescParts.add('ğŸ¯ ê°±ì‹  ë…¼ì˜ ì§„í–‰');
            taskDescParts.add('');
            taskDescParts.add('ğŸ“ ì—°ë½ ì •ë³´:');
            taskDescParts.add('- ê³ ê°: ' + assetInfo.Account.Name);
            
            if (assetInfo.Contact.Name != null) {
                taskDescParts.add('- ë‹´ë‹¹ì: ' + assetInfo.Contact.Name);
            }
            
            if (assetInfo.Account.Phone != null) {
                taskDescParts.add('- ì „í™”: ' + assetInfo.Account.Phone);
            }
            
            if (assetInfo.Contact.Email != null) {
                taskDescParts.add('- ì´ë©”ì¼: ' + assetInfo.Contact.Email);
            }
            
            taskDescParts.add('');
            taskDescParts.add('ğŸ’¼ ë…¼ì˜ ë‚´ìš©:');
            taskDescParts.add('1. í˜„ì¬ ì„œë¹„ìŠ¤ ë§Œì¡±ë„ í™•ì¸');
            taskDescParts.add('2. ê°±ì‹  ì¡°ê±´ ë° ê°€ê²© í˜‘ì˜');
            taskDescParts.add('3. ì¶”ê°€ ì„œë¹„ìŠ¤ í•„ìš”ì„± ë…¼ì˜');
            taskDescParts.add('4. ê³„ì•½ ì¼ì • ì¡°ìœ¨');
            
            taskDescParts.add('');
            taskDescParts.add('ğŸ”— ê´€ë ¨ Opportunity: ' + opportunity.Name);
            taskDescParts.add('ğŸ’° ì˜ˆìƒ ê¸ˆì•¡: â‚©' + String.valueOf(opportunity.Amount));
            
            followupTask.Description = String.join(taskDescParts, '\n');
            
            // Task ì €ì¥
            insert followupTask;
            
            System.debug('âœ… Task ìƒì„± ì™„ë£Œ: ' + followupTask.Subject);
            
            // ìƒì„±ëœ Task ì •ë³´ ë°˜í™˜ (ID í¬í•¨)
            return [SELECT Id, Subject, Status, Priority, ActivityDate FROM Task WHERE Id = :followupTask.Id];
            
        } catch (Exception e) {
            System.debug('âŒ Task ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
            return null;
        }
    }
    
    /**
     * ëŒ€ëŸ‰ ê°±ì‹  ì²˜ë¦¬ (ë°°ì¹˜ìš©)
     * @param assetIds Asset ID ëª©ë¡
     * @return List<RenewalResult> ì²˜ë¦¬ ê²°ê³¼ ëª©ë¡
     */
    @AuraEnabled
    public static List<RenewalResult> processBulkRenewals(List<Id> assetIds) {
        List<RenewalResult> results = new List<RenewalResult>();
        
        System.debug('=== ëŒ€ëŸ‰ ê°±ì‹  ì²˜ë¦¬ ì‹œì‘ ===');
        System.debug('ëŒ€ìƒ Asset ìˆ˜: ' + assetIds.size());
        
        for (Id assetId : assetIds) {
            try {
                RenewalResult result = startRenewalProcess(assetId);
                results.add(result);
                
                // Governor Limit ê³ ë ¤í•˜ì—¬ ì ì‹œ ëŒ€ê¸°
                if (Math.mod(results.size(), 50) == 0) {
                    System.debug('ì¤‘ê°„ ì²´í¬í¬ì¸íŠ¸: ' + results.size() + 'ê°œ ì²˜ë¦¬ ì™„ë£Œ');
                }
                
            } catch (Exception e) {
                RenewalResult errorResult = new RenewalResult();
                errorResult.success = false;
                errorResult.message = 'Asset ' + assetId + ' ì²˜ë¦¬ ì˜¤ë¥˜: ' + e.getMessage();
                results.add(errorResult);
            }
        }
        
        System.debug('=== ëŒ€ëŸ‰ ê°±ì‹  ì²˜ë¦¬ ì™„ë£Œ ===');
        System.debug('ì´ ì²˜ë¦¬: ' + results.size() + 'ê°œ');
        
        return results;
    }
    
    /**
     * ê°±ì‹  ê°€ëŠ¥í•œ Asset ëª©ë¡ ì¡°íšŒ
     * @param ownerId ì†Œìœ ì ID (nullì´ë©´ í˜„ì¬ ì‚¬ìš©ì)
     * @return List<Asset> ê°±ì‹  ê°€ëŠ¥í•œ Asset ëª©ë¡
     */
    @AuraEnabled(cacheable=true)
    public static List<Asset> getRenewableAssets(Id ownerId) {
        try {
            if (ownerId == null) {
                ownerId = UserInfo.getUserId();
            }
            
            // ê°±ì‹  ê°€ëŠ¥í•œ ì¡°ê±´: ì„¤ì¹˜ í›„ 1ì¼ ì´ìƒ, í™œì„± ìƒíƒœ (ì¦‰ì‹œ ê°±ì‹  ê°€ëŠ¥)
            Date renewalThreshold = Date.today().addDays(-1);
            
            return [
                SELECT Id, Name, AccountId, Account.Name, Account.Phone,
                       ContactId, Contact.Name, Contact.Email,
                       SerialNumber, Status, PurchaseDate, InstallDate, Price,
                       LifecycleEndDate
                FROM Asset 
                WHERE Account.OwnerId = :ownerId
                AND Status IN ('Installed', 'Registered', 'Purchased')
                AND InstallDate <= :renewalThreshold
                AND Price > 0
                ORDER BY InstallDate ASC, Price DESC
                LIMIT 100
            ];
            
        } catch (Exception e) {
            System.debug('ê°±ì‹  ê°€ëŠ¥ Asset ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage());
            return new List<Asset>();
        }
    }
}
