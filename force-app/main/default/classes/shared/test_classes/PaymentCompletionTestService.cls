/**
 * @description ì™„ë‚© ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ì„œë¹„ìŠ¤
 * @author JH Moon
 * @created 2025-07-27
 */
public with sharing class PaymentCompletionTestService {
    
    /**
     * ì™„ë‚© ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
     */
    @AuraEnabled
    public static String executePaymentCompletionTest(Id orderId) {
        try {
            System.debug('ğŸ¯ =====ì™„ë‚© ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ì‹œì‘=====');
            System.debug('Order ID: ' + orderId);
            
            // 1. í…ŒìŠ¤íŠ¸ ì „ í˜„ì¬ ìƒíƒœ í™•ì¸
            PaymentTestResult beforeState = analyzePaymentState(orderId, 'BEFORE');
            
            // 2. ì™„ë‚© ì²˜ë¦¬ ì‹¤í–‰
            String completionResult = PaymentStatusTimelineController.markAllPaymentsAsCompleted(orderId);
            System.debug('ì™„ë‚© ì²˜ë¦¬ ê²°ê³¼: ' + completionResult);
            
            // 3. í…ŒìŠ¤íŠ¸ í›„ ìƒíƒœ í™•ì¸
            PaymentTestResult afterState = analyzePaymentState(orderId, 'AFTER');
            
            // 4. ê²°ê³¼ ë¹„êµ ë° ê²€ì¦
            String validationResult = validatePaymentCompletion(beforeState, afterState);
            
            // 5. PDF ìƒì„± í…ŒìŠ¤íŠ¸
            String pdfGenerationResult = testPDFGeneration(orderId);
            
            // 6. ìµœì¢… ê²°ê³¼ ë¦¬í¬íŠ¸
            String finalReport = generateTestReport(beforeState, afterState, validationResult, pdfGenerationResult);
            
            System.debug('ğŸ¯ =====ì™„ë‚© ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ì™„ë£Œ=====');
            
            return finalReport;
            
        } catch (Exception e) {
            String errorMessage = 'ì™„ë‚© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage();
            System.debug('âŒ ' + errorMessage);
            throw new AuraHandledException(errorMessage);
        }
    }
    
    /**
     * ë‚©ë¶€ ìƒíƒœ ë¶„ì„
     */
    private static PaymentTestResult analyzePaymentState(Id orderId, String phase) {
        PaymentTestResult result = new PaymentTestResult();
        result.phase = phase;
        result.timestamp = System.now();
        
        // Order ì •ë³´ ì¡°íšŒ
        List<Order> orders = [
            SELECT Id, OrderNumber, TotalAmount, Account.Name,
                   (SELECT Id, Product2.Name, Quantity, UnitPrice, TotalPrice FROM OrderItems)
            FROM Order 
            WHERE Id = :orderId 
            LIMIT 1
        ];
        
        if (!orders.isEmpty()) {
            result.orderInfo = orders[0];
        }
        
        // PaymentStatus ì¡°íšŒ
        result.paymentStatuses = [
            SELECT Id, Status__c, Amount__c, DueDate__c, Installment_Number__c, PaidDate__c
            FROM PaymentStatus__c
            WHERE Order__c = :orderId
            ORDER BY Installment_Number__c ASC
        ];
        
        // í†µê³„ ê³„ì‚°
        result.totalPayments = result.paymentStatuses.size();
        result.completedPayments = 0;
        result.pendingPayments = 0;
        
        for (PaymentStatus__c payment : result.paymentStatuses) {
            if (payment.Status__c == 'ì™„ë‚©') {
                result.completedPayments++;
            } else {
                result.pendingPayments++;
            }
        }
        
        result.completionRate = result.totalPayments > 0 ? 
            (Decimal.valueOf(result.completedPayments) / result.totalPayments * 100).setScale(1) : 0;
        
        System.debug('ğŸ“Š ' + phase + ' ìƒíƒœ ë¶„ì„:');
        System.debug('   ì´ ë‚©ë¶€ í•­ëª©: ' + result.totalPayments);
        System.debug('   ì™„ë‚©: ' + result.completedPayments);
        System.debug('   ë¯¸ë‚©: ' + result.pendingPayments);
        System.debug('   ì™„ë‚©ë¥ : ' + result.completionRate + '%');
        
        return result;
    }
    
    /**
     * ì™„ë‚© ì²˜ë¦¬ ê²€ì¦
     */
    private static String validatePaymentCompletion(PaymentTestResult before, PaymentTestResult after) {
        List<String> validationResults = new List<String>();
        
        // 1. ì™„ë‚© ìƒíƒœ ë³€ê²½ ê²€ì¦
        if (after.completedPayments > before.completedPayments) {
            validationResults.add('âœ… ì™„ë‚© ìƒíƒœ ë³€ê²½: ' + before.completedPayments + ' â†’ ' + after.completedPayments);
        } else {
            validationResults.add('âŒ ì™„ë‚© ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
        }
        
        // 2. ì™„ë‚©ë¥  ê²€ì¦
        if (after.completionRate == 100) {
            validationResults.add('âœ… ì™„ë‚©ë¥  100% ë‹¬ì„±');
        } else {
            validationResults.add('âš ï¸ ì™„ë‚©ë¥ : ' + after.completionRate + '%');
        }
        
        // 3. ë¯¸ë‚© í•­ëª© ê²€ì¦
        if (after.pendingPayments == 0) {
            validationResults.add('âœ… ëª¨ë“  ë¯¸ë‚© í•­ëª© í•´ê²°');
        } else {
            validationResults.add('âŒ ì—¬ì „íˆ ' + after.pendingPayments + 'ê°œ ë¯¸ë‚© í•­ëª© ì¡´ì¬');
        }
        
        return String.join(validationResults, '\n');
    }
    
    /**
     * PDF ìƒì„± í…ŒìŠ¤íŠ¸
     */
    private static String testPDFGeneration(Id orderId) {
        try {
            String pdfId = PaymentStatusTimelineController.generatePaymentSchedulePDF(orderId);
            
            // ìƒì„±ëœ PDF íŒŒì¼ í™•ì¸
            List<ContentVersion> generatedPDFs = [
                SELECT Id, Title, ContentSize, CreatedDate
                FROM ContentVersion
                WHERE FirstPublishLocationId = :orderId
                AND CreatedDate = TODAY
                ORDER BY CreatedDate DESC
                LIMIT 10
            ];
            
            List<String> pdfResults = new List<String>();
            pdfResults.add('âœ… PDF ìƒì„± ì„±ê³µ: ' + generatedPDFs.size() + 'ê°œ íŒŒì¼');
            
            for (ContentVersion pdf : generatedPDFs) {
                String fileType = '';
                if (pdf.Title.contains('ë‚©ë¶€í™•ì¸ì„œ')) {
                    fileType = '[ë‚©ë¶€í™•ì¸ì„œ]';
                } else if (pdf.Title.contains('ì„¸ê¸ˆê³„ì‚°ì„œ')) {
                    fileType = '[ì„¸ê¸ˆê³„ì‚°ì„œ]';
                }
                pdfResults.add('  â€¢ ' + pdf.Title + ' ' + fileType + ' (' + (pdf.ContentSize/1024) + 'KB)');
            }
            
            return String.join(pdfResults, '\n');
            
        } catch (Exception e) {
            return 'âŒ PDF ìƒì„± í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + e.getMessage();
        }
    }
    
    /**
     * í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ìƒì„±
     */
    private static String generateTestReport(PaymentTestResult before, PaymentTestResult after, 
                                           String validation, String pdfTest) {
        List<String> report = new List<String>();
        
        report.add('ğŸ¯ ì™„ë‚© ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¦¬í¬íŠ¸');
        report.add('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        report.add('');
        report.add('ğŸ“‹ Order ì •ë³´:');
        if (before.orderInfo != null) {
            report.add('  â€¢ Order Number: ' + before.orderInfo.OrderNumber);
            report.add('  â€¢ Customer: ' + before.orderInfo.Account.Name);
            report.add('  â€¢ Total Amount: â‚©' + before.orderInfo.TotalAmount?.format());
        }
        report.add('');
        
        report.add('ğŸ“Š ë‚©ë¶€ ìƒíƒœ ë³€í™”:');
        report.add('  BEFORE â†’ AFTER');
        report.add('  â€¢ ì´ ë‚©ë¶€ í•­ëª©: ' + before.totalPayments + ' â†’ ' + after.totalPayments);
        report.add('  â€¢ ì™„ë‚©: ' + before.completedPayments + ' â†’ ' + after.completedPayments);
        report.add('  â€¢ ë¯¸ë‚©: ' + before.pendingPayments + ' â†’ ' + after.pendingPayments);
        report.add('  â€¢ ì™„ë‚©ë¥ : ' + before.completionRate + '% â†’ ' + after.completionRate + '%');
        report.add('');
        
        report.add('âœ… ê²€ì¦ ê²°ê³¼:');
        report.add(validation);
        report.add('');
        
        report.add('ğŸ“„ PDF ìƒì„± í…ŒìŠ¤íŠ¸:');
        report.add(pdfTest);
        report.add('');
        
        report.add('â° í…ŒìŠ¤íŠ¸ ì™„ë£Œ ì‹œê°„: ' + System.now().format('yyyy-MM-dd HH:mm:ss'));
        report.add('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        
        return String.join(report, '\n');
    }
    
    /**
     * í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë˜í¼ í´ë˜ìŠ¤
     */
    public class PaymentTestResult {
        public String phase;
        public DateTime timestamp;
        public Order orderInfo;
        public List<PaymentStatus__c> paymentStatuses;
        public Integer totalPayments;
        public Integer completedPayments;
        public Integer pendingPayments;
        public Decimal completionRate;
    }
}
