/**
 * Logic 3: Performance Tracking Dashboard Service (ë°°í¬ìš© ê°„ì†Œí™” ë²„ì „)
 * ëª©ì : ì˜ì—…ì‚¬ì›ì˜ ì‹¤ì‹œê°„ ì„±ê³¼ ì¶”ì  ë° ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì œê³µ
 */
public with sharing class PerformanceTrackingServiceSimple {
    
    /**
     * ëŒ€ì‹œë³´ë“œ ë©”ì¸ ë°ì´í„° ë˜í¼ í´ë˜ìŠ¤
     */
    public class DashboardData {
        @AuraEnabled public TodayRevenue todayRevenue;
        @AuraEnabled public MonthlyRenewal monthlyRenewal;
        @AuraEnabled public CustomerHealth customerHealth;
        @AuraEnabled public EfficiencyMetrics efficiency;
        @AuraEnabled public GameificationData gamification;
        @AuraEnabled public List<SmartNotification> notifications;
        @AuraEnabled public DateTime lastUpdated;
    }
    
    /**
     * 1. ì˜¤ëŠ˜ì˜ ì˜ˆìƒ ë§¤ì¶œ ë°ì´í„°
     */
    public class TodayRevenue {
        @AuraEnabled public Decimal expectedAmount;
        @AuraEnabled public Decimal targetAmount;
        @AuraEnabled public Decimal achievementRate;
        @AuraEnabled public Integer priorityCustomers;
        @AuraEnabled public String status; // 'on-track', 'behind', 'ahead'
    }
    
    /**
     * 2. ì´ë²ˆ ë‹¬ ê°±ì‹  í˜„í™© ë°ì´í„°
     */  
    public class MonthlyRenewal {
        @AuraEnabled public Integer completedCount;
        @AuraEnabled public Decimal completedAmount;
        @AuraEnabled public Integer inProgressCount;
        @AuraEnabled public Decimal inProgressAmount;
        @AuraEnabled public Decimal totalExpectedAmount;
        @AuraEnabled public Decimal monthlyTarget;
    }
    
    /**
     * 3. ê³ ê° ê±´ê°•ë„ ë¶„í¬ ë°ì´í„°
     */
    public class CustomerHealth {
        @AuraEnabled public Integer healthyCount;
        @AuraEnabled public Integer warningCount;
        @AuraEnabled public Integer riskCount;
        @AuraEnabled public Decimal healthyPercentage;
        @AuraEnabled public Decimal warningPercentage;
        @AuraEnabled public Decimal riskPercentage;
    }
    
    /**
     * 4. ì—…ë¬´ íš¨ìœ¨ì„± ì§€í‘œ ë°ì´í„°
     */
    public class EfficiencyMetrics {
        @AuraEnabled public Decimal avgProcessingTime; // ì´ˆ ë‹¨ìœ„
        @AuraEnabled public Decimal successRate; // í¼ì„¼íŠ¸
        @AuraEnabled public Integer monthlyProcessCount;
        @AuraEnabled public Decimal timeReduction; // Logic 2ë¡œ ì¸í•œ ì‹œê°„ ì ˆì•½
    }
    
    /**
     * ê²Œì„í™” ë°ì´í„° (ë™ê¸°ë¶€ì—¬)
     */
    public class GameificationData {
        @AuraEnabled public String currentLevel;
        @AuraEnabled public Decimal currentAmount;
        @AuraEnabled public Decimal nextLevelAmount;
        @AuraEnabled public Decimal progressPercentage;
        @AuraEnabled public String levelIcon;
        @AuraEnabled public String encouragementMessage;
    }
    
    /**
     * ìŠ¤ë§ˆíŠ¸ ì•Œë¦¼ ë°ì´í„°
     */
    public class SmartNotification {
        @AuraEnabled public String id;
        @AuraEnabled public String type; // 'renewal', 'target', 'opportunity'
        @AuraEnabled public String title;
        @AuraEnabled public String message;
        @AuraEnabled public String priority; // 'high', 'medium', 'low'
        @AuraEnabled public String icon;
        @AuraEnabled public DateTime createdDate;
    }
    
    /**
     * ë©”ì¸ ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì¡°íšŒ ë©”ì†Œë“œ (ê°„ì†Œí™” ë²„ì „)
     */
    @AuraEnabled(cacheable=true)
    public static DashboardData getDashboardData() {
        try {
            DashboardData dashboard = new DashboardData();
            
            dashboard.todayRevenue = calculateTodayRevenue();
            dashboard.monthlyRenewal = calculateMonthlyRenewal();
            dashboard.customerHealth = calculateCustomerHealth();
            dashboard.efficiency = calculateEfficiencyMetrics();
            dashboard.gamification = calculateGameificationData(dashboard.monthlyRenewal.completedAmount);
            dashboard.notifications = generateSmartNotifications();
            dashboard.lastUpdated = DateTime.now();
            
            return dashboard;
            
        } catch (Exception e) {
            System.debug('Performance Dashboard Error: ' + e.getMessage());
            throw new AuraHandledException('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    /**
     * 1. ì˜¤ëŠ˜ì˜ ì˜ˆìƒ ë§¤ì¶œ ê³„ì‚° (í‘œì¤€ í•„ë“œë§Œ ì‚¬ìš©)
     */
    private static TodayRevenue calculateTodayRevenue() {
        TodayRevenue today = new TodayRevenue();
        
        // ê³ ì•¡ ìì‚° ìš°ì„ ìœ¼ë¡œ ì˜ˆìƒ ë§¤ì¶œ ê³„ì‚°
        List<Asset> priorityAssets = [
            SELECT Id, Name, Price, Quantity, UsageEndDate, 
                   AccountId, Account.Name, Status
            FROM Asset 
            WHERE Price >= 1000000 
            AND UsageEndDate <= :Date.today().addDays(90)
            AND Status = 'Installed'
            ORDER BY Price DESC
            LIMIT 10
        ];
        
        Decimal totalExpected = 0;
        for(Asset asset : priorityAssets) {
            Decimal renewalProb = 0.8; // ê¸°ë³¸ 80% ê°±ì‹  í™•ë¥ 
            Decimal assetValue = (asset.Price != null) ? asset.Price * asset.Quantity : 0;
            totalExpected += assetValue * renewalProb;
        }
        
        today.expectedAmount = totalExpected;
        today.targetAmount = 50000000; // ì¼ì¼ ëª©í‘œ 5ì²œë§Œì›
        today.achievementRate = (today.targetAmount > 0) ? 
            (today.expectedAmount / today.targetAmount * 100) : 0;
        today.priorityCustomers = priorityAssets.size();
        
        // ìƒíƒœ ê²°ì •
        if(today.achievementRate >= 100) {
            today.status = 'ahead';
        } else if(today.achievementRate >= 80) {
            today.status = 'on-track';
        } else {
            today.status = 'behind';
        }
        
        return today;
    }
    
    /**
     * 2. ì´ë²ˆ ë‹¬ ê°±ì‹  í˜„í™© ê³„ì‚°
     */
    private static MonthlyRenewal calculateMonthlyRenewal() {
        MonthlyRenewal monthly = new MonthlyRenewal();
        
        Date monthStart = Date.today().toStartOfMonth();
        Date monthEnd = monthStart.addMonths(1).addDays(-1);
        
        // ì™„ë£Œëœ ê°±ì‹  (Won Opportunities)
        List<Opportunity> completedOpps = [
            SELECT Id, Amount, StageName, CloseDate
            FROM Opportunity 
            WHERE StageName = 'Closed Won'
            AND CloseDate >= :monthStart 
            AND CloseDate <= :monthEnd
            LIMIT 1000
        ];
        
        monthly.completedCount = completedOpps.size();
        monthly.completedAmount = 0;
        for(Opportunity opp : completedOpps) {
            monthly.completedAmount += (opp.Amount != null) ? opp.Amount : 0;
        }
        
        // ì§„í–‰ ì¤‘ì¸ ê°±ì‹ 
        List<Opportunity> inProgressOpps = [
            SELECT Id, Amount, StageName, CloseDate
            FROM Opportunity 
            WHERE StageName NOT IN ('Closed Won', 'Closed Lost')
            AND CloseDate >= :monthStart 
            AND CloseDate <= :monthEnd
            LIMIT 1000
        ];
        
        monthly.inProgressCount = inProgressOpps.size();
        monthly.inProgressAmount = 0;
        for(Opportunity opp : inProgressOpps) {
            monthly.inProgressAmount += (opp.Amount != null) ? opp.Amount : 0;
        }
        
        monthly.totalExpectedAmount = monthly.completedAmount + monthly.inProgressAmount;
        monthly.monthlyTarget = 300000000; // ì›” ëª©í‘œ 3ì–µì›
        
        return monthly;
    }
    
    /**
     * 3. ê³ ê° ê±´ê°•ë„ ë¶„í¬ ê³„ì‚° (ê°„ì†Œí™”)
     */
    private static CustomerHealth calculateCustomerHealth() {
        CustomerHealth health = new CustomerHealth();
        
        // Case ìˆ˜ë¡œ ê³ ê° ê±´ê°•ë„ ë¶„ë¥˜
        List<Account> allAccounts = [
            SELECT Id, Name, 
                   (SELECT Id FROM Cases WHERE Status != 'Closed')
            FROM Account 
            WHERE Id IN (
                SELECT AccountId FROM Asset WHERE Status = 'Installed'
            )
            LIMIT 1000
        ];
        
        Integer healthyCount = 0;
        Integer warningCount = 0;
        Integer riskCount = 0;
        
        for(Account acc : allAccounts) {
            Integer caseCount = acc.Cases.size();
            
            if(caseCount == 0) {
                healthyCount++;
            } else if(caseCount <= 2) {
                warningCount++;
            } else {
                riskCount++;
            }
        }
        
        Integer totalCustomers = allAccounts.size();
        
        health.healthyCount = healthyCount;
        health.warningCount = warningCount;
        health.riskCount = riskCount;
        
        if(totalCustomers > 0) {
            health.healthyPercentage = (Decimal)healthyCount / totalCustomers * 100;
            health.warningPercentage = (Decimal)warningCount / totalCustomers * 100;
            health.riskPercentage = (Decimal)riskCount / totalCustomers * 100;
        } else {
            health.healthyPercentage = 0;
            health.warningPercentage = 0;
            health.riskPercentage = 0;
        }
        
        return health;
    }
    
    /**
     * 4. ì—…ë¬´ íš¨ìœ¨ì„± ì§€í‘œ ê³„ì‚° (ê°„ì†Œí™”)
     */
    private static EfficiencyMetrics calculateEfficiencyMetrics() {
        EfficiencyMetrics metrics = new EfficiencyMetrics();
        
        Date monthStart = Date.today().toStartOfMonth();
        
        // ì´ë²ˆ ë‹¬ ìƒì„±ëœ Opportunity ì¡°íšŒ
        List<Opportunity> monthlyOpps = [
            SELECT Id, Amount, StageName, CreatedDate, LastModifiedDate
            FROM Opportunity 
            WHERE CreatedDate >= :monthStart
            LIMIT 1000
        ];
        
        metrics.monthlyProcessCount = monthlyOpps.size();
        
        // ì„±ê³µë¥  ê³„ì‚°
        Integer successCount = 0;
        Long totalProcessingTime = 0;
        
        for(Opportunity opp : monthlyOpps) {
            if(opp.StageName == 'Closed Won') {
                successCount++;
            }
            
            // ì²˜ë¦¬ ì‹œê°„ ê³„ì‚° (ìƒì„± ~ ìµœì¢… ìˆ˜ì •)
            Long processingTime = opp.LastModifiedDate.getTime() - opp.CreatedDate.getTime();
            totalProcessingTime += processingTime;
        }
        
        if(monthlyOpps.size() > 0) {
            metrics.successRate = (Decimal)successCount / monthlyOpps.size() * 100;
            metrics.avgProcessingTime = totalProcessingTime / monthlyOpps.size() / 1000; // ì´ˆ ë‹¨ìœ„
        } else {
            metrics.successRate = 0;
            metrics.avgProcessingTime = 0;
        }
        
        // Logic 2ë¡œ ì¸í•œ ì‹œê°„ ì ˆì•½ (ê¸°ì¡´ 20ë¶„ â†’ 5ì´ˆ)
        metrics.timeReduction = (20 * 60 - 5) * monthlyOpps.size(); // ì´ˆ ë‹¨ìœ„
        
        return metrics;
    }
    
    /**
     * ê²Œì„í™” ë°ì´í„° ê³„ì‚°
     */
    private static GameificationData calculateGameificationData(Decimal currentAmount) {
        GameificationData game = new GameificationData();
        
        game.currentAmount = (currentAmount != null) ? currentAmount : 0;
        
        // í˜„ì¬ ë ˆë²¨ ë° ë‹¤ìŒ ëª©í‘œ ê³„ì‚°
        if(game.currentAmount >= 100000000) { // 1ì–µì›
            game.currentLevel = 'PLATINUM';
            game.nextLevelAmount = 100000000;
            game.progressPercentage = 100;
            game.encouragementMessage = 'ì „ì„¤ê¸‰ ì„±ê³¼! ìµœê³  ë ˆë²¨ ë‹¬ì„±!';
            game.levelIcon = 'ğŸ’';
        } else if(game.currentAmount >= 50000000) { // 5ì²œë§Œì›
            game.currentLevel = 'GOLD';
            game.nextLevelAmount = 100000000;
            game.progressPercentage = (game.currentAmount - 50000000) / 50000000 * 100;
            game.encouragementMessage = 'ê³¨ë“œ ë ˆë²¨! í”Œë˜í‹°ë„˜ê¹Œì§€ ì¡°ê¸ˆ ë‚¨ì•˜ìŠµë‹ˆë‹¤!';
            game.levelIcon = 'ğŸ¥‡';
        } else if(game.currentAmount >= 30000000) { // 3ì²œë§Œì›
            game.currentLevel = 'SILVER';
            game.nextLevelAmount = 50000000;
            game.progressPercentage = (game.currentAmount - 30000000) / 20000000 * 100;
            game.encouragementMessage = 'ì‹¤ë²„ ë ˆë²¨! ê³¨ë“œê¹Œì§€ í˜ë‚´ì„¸ìš”!';
            game.levelIcon = 'ğŸ¥ˆ';
        } else {
            game.currentLevel = 'BRONZE';
            game.nextLevelAmount = 30000000;
            game.progressPercentage = game.currentAmount / 30000000 * 100;
            game.encouragementMessage = 'ì‹œì‘ì´ ì¢‹ìŠµë‹ˆë‹¤! ì‹¤ë²„ê¹Œì§€ í™”ì´íŒ…!';
            game.levelIcon = 'ğŸ¥‰';
        }
        
        return game;
    }
    
    /**
     * ìŠ¤ë§ˆíŠ¸ ì•Œë¦¼ ìƒì„± (ê°„ì†Œí™”)
     */
    private static List<SmartNotification> generateSmartNotifications() {
        List<SmartNotification> notifications = new List<SmartNotification>();
        
        // ê°±ì‹  ì„ë°• ì•Œë¦¼
        List<Asset> upcomingRenewals = [
            SELECT Id, Name, AccountId, Account.Name, UsageEndDate, Price
            FROM Asset 
            WHERE UsageEndDate <= :Date.today().addDays(14)
            AND UsageEndDate >= :Date.today()
            AND Status = 'Installed'
            ORDER BY UsageEndDate ASC
            LIMIT 3
        ];
        
        for(Asset asset : upcomingRenewals) {
            SmartNotification notification = new SmartNotification();
            notification.id = 'renewal_' + asset.Id;
            notification.type = 'renewal';
            notification.title = 'ê°±ì‹  ì„ë°• ì•Œë¦¼';
            notification.message = asset.Account.Name + ' - ' + asset.Name + ' ê°±ì‹ ì´ ' + 
                                 asset.UsageEndDate.daysBetween(Date.today()) + 'ì¼ ë‚¨ì•˜ìŠµë‹ˆë‹¤';
            notification.priority = 'high';
            notification.icon = 'â°';
            notification.createdDate = DateTime.now();
            notifications.add(notification);
        }
        
        // ê³ ì•¡ ê¸°íšŒ ë°œê²¬ ì•Œë¦¼
        List<Asset> highValueOpportunities = [
            SELECT Id, Name, AccountId, Account.Name, Price, Quantity
            FROM Asset 
            WHERE Price >= 5000000
            AND Status = 'Installed'
            AND UsageEndDate <= :Date.today().addDays(180)
            ORDER BY Price DESC
            LIMIT 2
        ];
        
        for(Asset asset : highValueOpportunities) {
            SmartNotification oppNotification = new SmartNotification();
            oppNotification.id = 'opportunity_' + asset.Id;
            oppNotification.type = 'opportunity';
            oppNotification.title = 'ê³ ì•¡ ê°±ì‹  ê¸°íšŒ';
            oppNotification.message = 'ê³ ê° ' + asset.Account.Name + 'ì˜ ' + 
                String.valueOf((asset.Price * asset.Quantity)/10000) + 'ë§Œì› ê°±ì‹  ê¸°íšŒê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤';
            oppNotification.priority = 'high';
            oppNotification.icon = 'ğŸ’°';
            oppNotification.createdDate = DateTime.now();
            notifications.add(oppNotification);
        }
        
        return notifications;
    }
    
    /**
     * ì‹¤ì‹œê°„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
     */
    @AuraEnabled
    public static String refreshDashboard() {
        try {
            DateTime refreshTime = DateTime.now();
            return 'Dashboard refreshed at: ' + refreshTime.format('yyyy-MM-dd HH:mm:ss');
        } catch (Exception e) {
            throw new AuraHandledException('ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
}
