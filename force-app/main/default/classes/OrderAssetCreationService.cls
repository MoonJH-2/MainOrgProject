/**
 * @description Order ì™„ë‚© ì‹œ Asset ìë™ ìƒì„± ì„œë¹„ìŠ¤
 * @author Copilot  
 * @date 2024
 */
public class OrderAssetCreationService {
    
    /**
     * @description Orderì˜ ëª¨ë“  PaymentStatusê°€ ì™„ë‚© ìƒíƒœì¸ì§€ í™•ì¸
     * @param orderId Order ID
     * @return Boolean ì™„ë‚© ì—¬ë¶€
     */
    public static Boolean isOrderFullyPaid(Id orderId) {
        try {
            // ì „ì²´ PaymentStatus ê°œìˆ˜ ì¡°íšŒ
            Integer totalPayments = [
                SELECT COUNT() 
                FROM PaymentStatus__c 
                WHERE Order__c = :orderId
            ];
            
            if (totalPayments == 0) {
                System.debug('OrderAssetCreationService: í•´ë‹¹ Orderì— PaymentStatus ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. OrderId: ' + orderId);
                return false;
            }
            
            // ì™„ë‚© ìƒíƒœ PaymentStatus ê°œìˆ˜ ì¡°íšŒ
            Integer completedPayments = [
                SELECT COUNT() 
                FROM PaymentStatus__c 
                WHERE Order__c = :orderId 
                AND Status__c = 'ì™„ë‚©'
            ];
            
            System.debug('OrderAssetCreationService: ë‚©ë¶€ í˜„í™© - ì „ì²´: ' + totalPayments + ', ì™„ë‚©: ' + completedPayments);
            
            return totalPayments > 0 && totalPayments == completedPayments;
            
        } catch (Exception e) {
            System.debug('OrderAssetCreationService.isOrderFullyPaid Error: ' + e.getMessage());
            return false;
        }
    }
    
    /**
     * @description ì™„ë‚©ëœ Orderì—ì„œ Asset ìƒì„±
     * @param orderId Order ID
     * @return Asset ìƒì„±ëœ Asset ë ˆì½”ë“œ
     */
    public static Asset createAssetFromCompletedOrder(Id orderId) {
        try {
            // Order ì •ë³´ ì¡°íšŒ
            Order orderInfo = [
                SELECT Id, OrderNumber, AccountId, TotalAmount, Status,
                       EffectiveDate, EndDate, CreatedDate, OwnerId,
                       Contact__c, Account.Name, Owner.Name
                FROM Order 
                WHERE Id = :orderId 
                LIMIT 1
            ];
            
            // ì´ë¯¸ Assetì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
            List<Asset> existingAssets = [
                SELECT Id FROM Asset 
                WHERE SerialNumber = :orderInfo.OrderNumber
                LIMIT 1
            ];
            
            if (!existingAssets.isEmpty()) {
                System.debug('OrderAssetCreationService: Assetì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. OrderNumber: ' + orderInfo.OrderNumber);
                return existingAssets[0];
            }
            
            // Asset ìƒì„±
            Asset newAsset = new Asset();
            
            // í‘œì¤€ í•„ë“œ ë§¤í•‘
            newAsset.Name = orderInfo.Account.Name + ' - Order ' + orderInfo.OrderNumber;
            newAsset.AccountId = orderInfo.AccountId;
            newAsset.ContactId = orderInfo.Contact__c; // Orderì˜ Contact ì—°ê²°
            newAsset.SerialNumber = orderInfo.OrderNumber; // ì—­ì¶”ì ìš©
            newAsset.PurchaseDate = orderInfo.EffectiveDate; // Order Start Date
            newAsset.InstallDate = Date.today(); // ì™„ë‚© ì™„ë£Œì¼
            newAsset.Status = 'Purchased';
            newAsset.Price = orderInfo.TotalAmount;
            newAsset.Quantity = 1;
            
            // Lifecycle ê´€ë¦¬ (Order End Dateê°€ ìˆëŠ” ê²½ìš°)
            if (orderInfo.EndDate != null) {
                newAsset.LifecycleEndDate = DateTime.newInstance(orderInfo.EndDate, Time.newInstance(23, 59, 59, 0));
            }
            
            // Descriptionì— ìƒì„¸ ì •ë³´ í¬í•¨
            newAsset.Description = buildAssetDescription(orderInfo);
            
            insert newAsset;
            
            System.debug('OrderAssetCreationService: Asset ìƒì„± ì™„ë£Œ. AssetId: ' + newAsset.Id);
            
            // Salesforce Channelì— Asset ìƒì„± ì•Œë¦¼
            postAssetCreationNotification(orderInfo, newAsset);
            
            return newAsset;
            
        } catch (Exception e) {
            System.debug('OrderAssetCreationService.createAssetFromCompletedOrder Error: ' + e.getMessage());
            throw new OrderAssetCreationException('Asset ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    /**
     * @description Asset Description êµ¬ì„±
     * @param orderInfo Order ì •ë³´
     * @return String Asset Description
     */
    private static String buildAssetDescription(Order orderInfo) {
        List<String> descriptionParts = new List<String>();
        
        descriptionParts.add('=== Order Asset ì •ë³´ ===');
        descriptionParts.add('Order Number: ' + orderInfo.OrderNumber);
        descriptionParts.add('ê³ ê°: ' + orderInfo.Account.Name);
        descriptionParts.add('ì´ ê¸ˆì•¡: ' + (orderInfo.TotalAmount != null ? orderInfo.TotalAmount.format() : '0') + 'ì›');
        descriptionParts.add('ì£¼ë¬¸ ì‹œì‘ì¼: ' + (orderInfo.EffectiveDate != null ? orderInfo.EffectiveDate.format() : 'ë¯¸í™•ì¸'));
        descriptionParts.add('ì£¼ë¬¸ ì¢…ë£Œì¼: ' + (orderInfo.EndDate != null ? orderInfo.EndDate.format() : 'ë¬´ê¸°í•œ'));
        descriptionParts.add('ì™„ë‚© ì™„ë£Œì¼: ' + Date.today().format());
        descriptionParts.add('ë‹´ë‹¹ì: ' + orderInfo.Owner.Name);
        descriptionParts.add('');
        
        // PaymentStatus ìš”ì•½ ì •ë³´ ì¶”ê°€
        try {
            List<PaymentStatus__c> paymentSummary = [
                SELECT InstallmentNumber__c, Amount__c, DueDate__c, PaidDate__c, Status__c
                FROM PaymentStatus__c 
                WHERE Order__c = :orderInfo.Id
                ORDER BY InstallmentNumber__c
                LIMIT 10
            ];
            
            if (!paymentSummary.isEmpty()) {
                descriptionParts.add('=== ë‚©ë¶€ ë‚´ì—­ ===');
                for (PaymentStatus__c ps : paymentSummary) {
                    String installmentInfo = ps.InstallmentNumber__c + 'ì°¨: ';
                    installmentInfo += (ps.Amount__c != null ? ps.Amount__c.format() : '0') + 'ì›';
                    installmentInfo += ' (' + ps.Status__c + ')';
                    if (ps.PaidDate__c != null) {
                        installmentInfo += ' - ë‚©ë¶€ì¼: ' + ps.PaidDate__c.format();
                    }
                    descriptionParts.add(installmentInfo);
                }
                descriptionParts.add('');
            }
        } catch (Exception e) {
            System.debug('PaymentStatus ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage());
        }
        
        descriptionParts.add('ğŸ“ˆ ì´ Assetì€ ì™„ë‚© ì™„ë£Œëœ Orderì—ì„œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
        descriptionParts.add('ê³ ê° ê´€ë¦¬ ë° ê°±ì‹  ì˜ì—…ì„ ìœ„í•´ í™œìš©í•˜ì„¸ìš”.');
        
        return String.join(descriptionParts, '\n');
    }
    
    /**
     * @description Asset ìƒì„± ì•Œë¦¼ì„ Salesforce Channelì— ê²Œì‹œ
     * @param orderInfo Order ì •ë³´
     * @param createdAsset ìƒì„±ëœ Asset
     */
    private static void postAssetCreationNotification(Order orderInfo, Asset createdAsset) {
        try {
            // SimpleSalesforceChannelServiceë¥¼ ì‚¬ìš©í•˜ì—¬ ì•Œë¦¼ ê²Œì‹œ
            String message = 'ğŸ‰ **Asset ìë™ ìƒì„± ì™„ë£Œ**\n\n';
            message += '**ê³ ê°:** ' + orderInfo.Account.Name + '\n';
            message += '**Order:** ' + orderInfo.OrderNumber + '\n';
            message += '**Asset:** ' + createdAsset.Name + '\n';
            message += '**ì™„ë‚© ê¸ˆì•¡:** ' + (orderInfo.TotalAmount != null ? orderInfo.TotalAmount.format() : '0') + 'ì›\n\n';
            message += 'ì™„ë‚©ì´ ì™„ë£Œë˜ì–´ ê³ ê° Assetì´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ';
            message += 'ì´ì œ ê³ ê° ê´€ë¦¬ ë° ê°±ì‹  ì˜ì—… ê¸°íšŒë¡œ í™œìš©í•˜ì„¸ìš”!';
            
            // Order Channelì— ì•Œë¦¼ ê²Œì‹œ (ì±„ë„ì´ ìˆëŠ” ê²½ìš°)
            SimpleSalesforceChannelService.postMessageToOrderChannel(orderInfo.Id, message);
            
            // ë‹´ë‹¹ìì—ê²Œ Task ìƒì„±
            createAssetCreationTask(orderInfo, createdAsset);
            
        } catch (Exception e) {
            System.debug('OrderAssetCreationService.postAssetCreationNotification Error: ' + e.getMessage());
            // ì•Œë¦¼ ì‹¤íŒ¨í•´ë„ Asset ìƒì„±ì€ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
        }
    }
    
    /**
     * @description Asset ìƒì„± ì™„ë£Œ Task ìƒì„±
     * @param orderInfo Order ì •ë³´
     * @param createdAsset ìƒì„±ëœ Asset
     */
    private static void createAssetCreationTask(Order orderInfo, Asset createdAsset) {
        try {
            Task assetTask = new Task();
            assetTask.Subject = '[Asset ìƒì„± ì™„ë£Œ] ' + orderInfo.Account.Name + ' - Order ' + orderInfo.OrderNumber;
            assetTask.Description = 'ì™„ë‚© ì™„ë£Œë¡œ ì¸í•œ Asset ìë™ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n';
            assetTask.Description += 'ê³ ê°: ' + orderInfo.Account.Name + '\n';
            assetTask.Description += 'Order: ' + orderInfo.OrderNumber + '\n';
            assetTask.Description += 'Asset: ' + createdAsset.Name + '\n';
            assetTask.Description += 'ì™„ë‚© ê¸ˆì•¡: ' + (orderInfo.TotalAmount != null ? orderInfo.TotalAmount.format() : '0') + 'ì›\n\n';
            assetTask.Description += 'ë‹¤ìŒ ì•¡ì…˜:\n';
            assetTask.Description += 'â–¡ ê³ ê° ë§Œì¡±ë„ ì¡°ì‚¬\n';
            assetTask.Description += 'â–¡ ì¶”ê°€ ì„œë¹„ìŠ¤ ì œì•ˆ\n';
            assetTask.Description += 'â–¡ ê°±ì‹  ì¼ì • í™•ì¸\n';
            assetTask.Description += 'â–¡ ë ˆí¼ëŸ°ìŠ¤ ê³ ê° ë“±ë¡ ê²€í† ';
            
            assetTask.Priority = 'Normal';
            assetTask.Status = 'Not Started';
            assetTask.ActivityDate = Date.today().addDays(7); // 1ì£¼ì¼ í›„
            assetTask.OwnerId = orderInfo.OwnerId;
            assetTask.WhatId = createdAsset.Id; // Assetê³¼ ì—°ê²°
            
            insert assetTask;
            
        } catch (Exception e) {
            System.debug('OrderAssetCreationService.createAssetCreationTask Error: ' + e.getMessage());
        }
    }
    
    /**
     * @description ì—¬ëŸ¬ Orderì˜ ì™„ë‚© ìƒíƒœ ì¼ê´„ í™•ì¸ ë° Asset ìƒì„±
     * @param orderIds Order ID ëª©ë¡
     * @return Map<Id, Asset> Order IDì™€ ìƒì„±ëœ Asset ë§¤í•‘
     */
    public static Map<Id, Asset> processMultipleOrdersForAssetCreation(List<Id> orderIds) {
        Map<Id, Asset> createdAssets = new Map<Id, Asset>();
        
        for (Id orderId : orderIds) {
            try {
                if (isOrderFullyPaid(orderId)) {
                    Asset newAsset = createAssetFromCompletedOrder(orderId);
                    if (newAsset != null) {
                        createdAssets.put(orderId, newAsset);
                    }
                }
            } catch (Exception e) {
                System.debug('OrderAssetCreationService.processMultipleOrdersForAssetCreation Error for OrderId ' + orderId + ': ' + e.getMessage());
                continue; // ê°œë³„ Order ì˜¤ë¥˜ ì‹œ ë‹¤ìŒ Order ê³„ì† ì²˜ë¦¬
            }
        }
        
        return createdAssets;
    }
    
    /**
     * @description ì»¤ìŠ¤í…€ ì˜ˆì™¸ í´ë˜ìŠ¤
     */
    public class OrderAssetCreationException extends Exception {}
}
