/**
 * @description VIBA Payment Monitor - ê²°ì œ ëª¨ë‹ˆí„°ë§
 * @author VIBA AI Assistant
 * @date 2025-01-27
 */
public with sharing class VIBAPaymentMonitor {
    
    public static void handleOverdueRisk(List<PaymentStatus__c> newPayments, Map<Id, PaymentStatus__c> oldMap) {
        for (PaymentStatus__c payment : newPayments) {
            PaymentStatus__c oldPayment = oldMap?.get(payment.Id);
            
            // ìƒíƒœ ë³€ê²½ ê°ì§€
            if (oldPayment != null && payment.Status__c != oldPayment.Status__c) {
                if (payment.Status__c == 'ì—°ì²´') {
                    System.debug('ğŸš¨ ì—°ì²´ ìœ„í—˜ ê°ì§€: ' + payment.Id);
                    VIBANotificationService.sendOverdueAlert(payment);
                } else if (payment.Status__c == 'ì™„ë‚©') {
                    System.debug('ğŸ‰ ì™„ë‚© ì™„ë£Œ: ' + payment.Id);
                    VIBANotificationService.sendPaymentCompletionAlert(payment.Id);
                }
            }
        }
    }
    
    public static void analyzeAndRecommend(List<PaymentStatus__c> paymentStatuses) {
        for (PaymentStatus__c payment : paymentStatuses) {
            // AI ìœ„í—˜ë„ ë¶„ì„
            Decimal riskScore = VIBARiskAnalyzer.calculatePaymentRisk(payment);
            payment.AI_Risk_Score__c = riskScore;
            
            // ê¶Œì¥ ì•¡ì…˜ ìƒì„±
            if (riskScore > 70) {
                payment.AI_Recommended_Action__c = VIBAActionGenerator.generateOverdueAction(payment);
            } else if (payment.Status__c == 'ì™„ë‚©') {
                payment.AI_Recommended_Action__c = VIBAActionGenerator.generateCompletionAction(payment);
            }
        }
    }
}
