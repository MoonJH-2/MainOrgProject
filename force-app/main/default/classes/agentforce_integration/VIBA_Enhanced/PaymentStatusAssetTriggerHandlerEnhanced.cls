/**
 * @description Enhanced PaymentStatus Asset Trigger Handler with VIBA Integration
 * @author VIBA AI Assistant
 * @date 2025-01-27
 * @version 2.0 - AI í†µí•© ë²„ì „
 */
public class PaymentStatusAssetTriggerHandlerEnhanced {
    
    // VIBA ë¡œê¹… ìƒìˆ˜
    private static final String VIBA_LOG_PREFIX = 'ğŸ¤– VIBA-Enhanced: ';
    
    /**
     * @description PaymentStatus ì—…ë°ì´íŠ¸ í›„ AI ê¸°ë°˜ í†µí•© ì²˜ë¦¬
     * @param updatedPaymentStatuses ì—…ë°ì´íŠ¸ëœ PaymentStatus ëª©ë¡
     * @param oldPaymentStatusMap ì´ì „ PaymentStatus ë§µ
     */
    public static void handleAfterUpdateWithVIBA(List<PaymentStatus__c> updatedPaymentStatuses, Map<Id, PaymentStatus__c> oldPaymentStatusMap) {
        System.debug(VIBA_LOG_PREFIX + 'ì—…ë°ì´íŠ¸ í›„ ì²˜ë¦¬ ì‹œì‘. ë ˆì½”ë“œ ìˆ˜: ' + updatedPaymentStatuses.size());
        
        // 1. ì™„ë‚© ê°ì§€ ë° Asset ìƒì„±
        Set<Id> orderIdsForAssetCreation = detectPaymentCompletions(updatedPaymentStatuses, oldPaymentStatusMap);
        
        // 2. ìœ„í—˜ë„ ë³€í™” ê°ì§€
        Set<Id> accountIdsForRiskAnalysis = detectRiskChanges(updatedPaymentStatuses, oldPaymentStatusMap);
        
        // 3. ê¸°íšŒ ë°œêµ´ ëŒ€ìƒ ê°ì§€
        Set<Id> accountIdsForOpportunityAnalysis = detectOpportunityChanges(updatedPaymentStatuses, oldPaymentStatusMap);
        
        // 4. ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ ì„±ëŠ¥ ìµœì í™”
        if (!orderIdsForAssetCreation.isEmpty()) {
            processAssetCreationWithVIBA(orderIdsForAssetCreation);
        }
        
        if (!accountIdsForRiskAnalysis.isEmpty()) {
            processRiskAnalysisWithVIBA(accountIdsForRiskAnalysis);
        }
        
        if (!accountIdsForOpportunityAnalysis.isEmpty()) {
            processOpportunityAnalysisWithVIBA(accountIdsForOpportunityAnalysis);
        }
        
        System.debug(VIBA_LOG_PREFIX + 'ì—…ë°ì´íŠ¸ í›„ ì²˜ë¦¬ ì™„ë£Œ');
    }
    
    /**
     * @description PaymentStatus ì‚½ì… í›„ AI ê¸°ë°˜ í†µí•© ì²˜ë¦¬
     */
    public static void handleAfterInsertWithVIBA(List<PaymentStatus__c> newPaymentStatuses) {
        System.debug(VIBA_LOG_PREFIX + 'ì‚½ì… í›„ ì²˜ë¦¬ ì‹œì‘. ë ˆì½”ë“œ ìˆ˜: ' + newPaymentStatuses.size());
        
        // ì‹ ê·œ ìƒì„±ëœ ì™„ë‚© ìƒíƒœ ì²˜ë¦¬
        Set<Id> orderIdsToCheck = new Set<Id>();
        Set<Id> accountIdsForWelcomeAnalysis = new Set<Id>();
        
        for (PaymentStatus__c paymentStatus : newPaymentStatuses) {
            if (paymentStatus.Status__c == 'ì™„ë‚©') {
                orderIdsToCheck.add(paymentStatus.Order__c);
                
                // ì‹ ê·œ ê³ ê° í™˜ì˜ ë¶„ì„ ì¤€ë¹„
                accountIdsForWelcomeAnalysis.add(getAccountIdFromOrder(paymentStatus.Order__c));
                
                System.debug(VIBA_LOG_PREFIX + 'ì™„ë‚© ìƒíƒœë¡œ ìƒì„± ê°ì§€. PaymentStatusId: ' + paymentStatus.Id);
            }
        }
        
        if (!orderIdsToCheck.isEmpty()) {
            processAssetCreationWithVIBA(orderIdsToCheck);
        }
        
        if (!accountIdsForWelcomeAnalysis.isEmpty()) {
            processWelcomeAnalysisWithVIBA(accountIdsForWelcomeAnalysis);
        }
        
        System.debug(VIBA_LOG_PREFIX + 'ì‚½ì… í›„ ì²˜ë¦¬ ì™„ë£Œ');
    }
    
    /**
     * @description PaymentStatus ì—…ë°ì´íŠ¸ ì „ AI ê¸°ë°˜ ì „ì²˜ë¦¬
     */
    public static void handleBeforeUpdateWithVIBA(List<PaymentStatus__c> updatedPaymentStatuses, Map<Id, PaymentStatus__c> oldPaymentStatusMap) {
        System.debug(VIBA_LOG_PREFIX + 'ì—…ë°ì´íŠ¸ ì „ ì²˜ë¦¬ ì‹œì‘');
        
        for (PaymentStatus__c paymentStatus : updatedPaymentStatuses) {
            PaymentStatus__c oldPaymentStatus = oldPaymentStatusMap.get(paymentStatus.Id);
            
            // AI ê¸°ë°˜ ìœ„í—˜ë„ ì ìˆ˜ ê³„ì‚°
            if (paymentStatus.Status__c != oldPaymentStatus.Status__c) {
                paymentStatus.AI_Risk_Score__c = VIBARiskCalculator.calculatePaymentRisk(paymentStatus);
                paymentStatus.Next_Contact_Date__c = VIBAScheduler.calculateOptimalContactTime(paymentStatus);
            }
            
            // VIBA ê¶Œì¥ ì•¡ì…˜ ì„¤ì •
            if (paymentStatus.Status__c == 'ì—°ì²´') {
                paymentStatus.Recommended_Action__c = VIBAActionGenerator.generateOverdueAction(paymentStatus);
            } else if (paymentStatus.Status__c == 'ì™„ë‚©') {
                paymentStatus.Recommended_Action__c = 'Asset ìƒì„± ë° ê³ ê° ê°ì‚¬ ì—°ë½';
            }
        }
        
        System.debug(VIBA_LOG_PREFIX + 'ì—…ë°ì´íŠ¸ ì „ ì²˜ë¦¬ ì™„ë£Œ');
    }
    
    // ============================================================================
    // Private Helper Methods - Enhanced with VIBA
    // ============================================================================
    
    /**
     * @description ì™„ë‚© ì™„ë£Œ ê°ì§€ (VIBA í–¥ìƒ)
     */
    private static Set<Id> detectPaymentCompletions(List<PaymentStatus__c> updatedPayments, Map<Id, PaymentStatus__c> oldMap) {
        Set<Id> orderIdsToCheck = new Set<Id>();
        
        for (PaymentStatus__c payment : updatedPayments) {
            PaymentStatus__c oldPayment = oldMap.get(payment.Id);
            
            // ì™„ë‚©ìœ¼ë¡œ ë³€ê²½ëœ ê²½ìš°
            if (payment.Status__c == 'ì™„ë‚©' && oldPayment.Status__c != 'ì™„ë‚©') {
                orderIdsToCheck.add(payment.Order__c);
                
                // VIBA ë¡œê·¸
                System.debug(VIBA_LOG_PREFIX + 'ì™„ë‚© ê°ì§€ - PaymentStatusId: ' + payment.Id + ', OrderId: ' + payment.Order__c);
                
                // ì‹¤ì‹œê°„ ì•Œë¦¼ ë°œì†¡
                VIBANotificationService.sendPaymentCompletionAlert(payment.Id);
            }
        }
        
        return orderIdsToCheck;
    }
    
    /**
     * @description ìœ„í—˜ë„ ë³€í™” ê°ì§€ (VIBA ì‹ ê·œ)
     */
    private static Set<Id> detectRiskChanges(List<PaymentStatus__c> updatedPayments, Map<Id, PaymentStatus__c> oldMap) {
        Set<Id> accountIdsForAnalysis = new Set<Id>();
        
        for (PaymentStatus__c payment : updatedPayments) {
            PaymentStatus__c oldPayment = oldMap.get(payment.Id);
            
            // ìœ„í—˜ ìƒíƒœë¡œ ë³€ê²½ ê°ì§€
            if (isRiskStatusChange(payment, oldPayment)) {
                Id accountId = getAccountIdFromOrder(payment.Order__c);
                if (accountId != null) {
                    accountIdsForAnalysis.add(accountId);
                    System.debug(VIBA_LOG_PREFIX + 'ìœ„í—˜ë„ ë³€í™” ê°ì§€ - AccountId: ' + accountId);
                }
            }
        }
        
        return accountIdsForAnalysis;
    }
    
    /**
     * @description ê¸°íšŒ ë³€í™” ê°ì§€ (VIBA ì‹ ê·œ)
     */
    private static Set<Id> detectOpportunityChanges(List<PaymentStatus__c> updatedPayments, Map<Id, PaymentStatus__c> oldMap) {
        Set<Id> accountIdsForAnalysis = new Set<Id>();
        
        for (PaymentStatus__c payment : updatedPayments) {
            PaymentStatus__c oldPayment = oldMap.get(payment.Id);
            
            // ê¸ì •ì  ë³€í™” ê°ì§€ (ì—°ì²´ â†’ ì™„ë‚©, ë¯¸ë‚© â†’ ì™„ë‚©)
            if (isPositiveStatusChange(payment, oldPayment)) {
                Id accountId = getAccountIdFromOrder(payment.Order__c);
                if (accountId != null) {
                    accountIdsForAnalysis.add(accountId);
                    System.debug(VIBA_LOG_PREFIX + 'ê¸°íšŒ ë°œêµ´ ëŒ€ìƒ ê°ì§€ - AccountId: ' + accountId);
                }
            }
        }
        
        return accountIdsForAnalysis;
    }
    
    /**
     * @description VIBA ê¸°ë°˜ Asset ìƒì„± ì²˜ë¦¬
     */
    private static void processAssetCreationWithVIBA(Set<Id> orderIds) {
        System.debug(VIBA_LOG_PREFIX + 'Asset ìƒì„± í”„ë¡œì„¸ìŠ¤ ì‹œì‘. Order ìˆ˜: ' + orderIds.size());
        
        for (Id orderId : orderIds) {
            try {
                // 1. ê¸°ì¡´ ì™„ë‚© í™•ì¸ ë¡œì§
                if (OrderAssetCreationService.isOrderFullyPaid(orderId)) {
                    
                    // 2. VIBA ë¶„ì„ ìˆ˜í–‰
                    VIBARequest request = new VIBARequest();
                    request.requestId = 'ASSET_CREATION_' + orderId;
                    request.type = 'Order';
                    request.recordId = orderId;
                    
                    List<VIBAResponse> responses = VIBAFrameworkController.performComprehensiveAnalysis(new List<VIBARequest>{request});
                    
                    // 3. Asset ìƒì„± (ê¸°ì¡´ ë¡œì§ í™œìš©)
                    Asset newAsset = AccountBasedAssetService.createAssetWithAccountAnalysis(orderId);
                    
                    if (newAsset != null) {
                        // 4. VIBA ê¸°ë°˜ í›„ì† ì•¡ì…˜
                        processPostAssetCreationWithVIBA(newAsset, responses[0]);
                        
                        System.debug(VIBA_LOG_PREFIX + 'Asset ìƒì„± ì„±ê³µ - AssetId: ' + newAsset.Id);
                    }
                }
                
            } catch (Exception e) {
                System.debug(VIBA_LOG_PREFIX + 'Asset ìƒì„± ì˜¤ë¥˜ - OrderId: ' + orderId + ', Error: ' + e.getMessage());
                createVIBAErrorTask(orderId, e.getMessage());
            }
        }
    }
    
    /**
     * @description VIBA ê¸°ë°˜ ìœ„í—˜ë„ ë¶„ì„ ì²˜ë¦¬
     */
    private static void processRiskAnalysisWithVIBA(Set<Id> accountIds) {
        System.debug(VIBA_LOG_PREFIX + 'ìœ„í—˜ë„ ë¶„ì„ ì‹œì‘. Account ìˆ˜: ' + accountIds.size());
        
        List<Id> accountIdsList = new List<Id>(accountIds);
        
        // ë¹„ë™ê¸° ìœ„í—˜ë„ ë¶„ì„
        if (!System.isBatch() && !System.isFuture()) {
            processRiskAnalysisAsync(accountIdsList);
        } else {
            // ë™ê¸° ì²˜ë¦¬ (ë°°ì¹˜ë‚˜ Future ì»¨í…ìŠ¤íŠ¸ì—ì„œ)
            List<VIBARiskPrediction> predictions = VIBAFrameworkController.predictCustomerRisk(accountIdsList);
            
            for (VIBARiskPrediction prediction : predictions) {
                if (prediction.success && prediction.riskLevel == 'High') {
                    createUrgentRiskTask(prediction);
                }
            }
        }
    }
    
    /**
     * @description VIBA ê¸°ë°˜ ê¸°íšŒ ë¶„ì„ ì²˜ë¦¬
     */
    private static void processOpportunityAnalysisWithVIBA(Set<Id> accountIds) {
        System.debug(VIBA_LOG_PREFIX + 'ê¸°íšŒ ë¶„ì„ ì‹œì‘. Account ìˆ˜: ' + accountIds.size());
        
        for (Id accountId : accountIds) {
            try {
                // í•´ë‹¹ Accountì˜ Assets ì¡°íšŒ
                List<Asset> assets = [SELECT Id FROM Asset WHERE AccountId = :accountId LIMIT 5];
                
                if (!assets.isEmpty()) {
                    List<Id> assetIds = new List<Id>();
                    for (Asset asset : assets) {
                        assetIds.add(asset.Id);
                    }
                    
                    // VIBA ê¸°íšŒ ë¶„ì„
                    List<VIBAOpportunityInsight> opportunities = VIBAFrameworkController.identifyOpportunities(assetIds);
                    
                    for (VIBAOpportunityInsight opportunity : opportunities) {
                        if (opportunity.success && opportunity.opportunityScore > 70) {
                            createOpportunityTask(opportunity);
                        }
                    }
                }
                
            } catch (Exception e) {
                System.debug(VIBA_LOG_PREFIX + 'ê¸°íšŒ ë¶„ì„ ì˜¤ë¥˜ - AccountId: ' + accountId + ', Error: ' + e.getMessage());
            }
        }
    }
    
    /**
     * @description ì‹ ê·œ ê³ ê° í™˜ì˜ ë¶„ì„
     */
    private static void processWelcomeAnalysisWithVIBA(Set<Id> accountIds) {
        System.debug(VIBA_LOG_PREFIX + 'ì‹ ê·œ ê³ ê° í™˜ì˜ ë¶„ì„ ì‹œì‘. Account ìˆ˜: ' + accountIds.size());
        
        for (Id accountId : accountIds) {
            // ì²« ì™„ë‚© ê³ ê°ì¸ì§€ í™•ì¸
            if (isFirstTimeCompletedCustomer(accountId)) {
                createWelcomeTask(accountId);
            }
        }
    }
    
    /**
     * @description Asset ìƒì„± í›„ VIBA ê¸°ë°˜ í›„ì† ì²˜ë¦¬
     */
    private static void processPostAssetCreationWithVIBA(Asset newAsset, VIBAResponse vibaResponse) {
        try {
            // 1. VIBA ì¶•í•˜ ë©”ì‹œì§€ ë°œì†¡
            VIBANotificationService.sendAssetCreationCelebration(newAsset, vibaResponse);
            
            // 2. ê³ ê° ë§Œì¡±ë„ ì¡°ì‚¬ ìŠ¤ì¼€ì¤„ë§
            VIBAScheduler.scheduleCustomerSatisfactionSurvey(newAsset);
            
            // 3. ê°±ì‹  ê¸°íšŒ ë¶„ì„ ë° ì˜ˆì•½
            VIBAScheduler.scheduleRenewalAnalysis(newAsset);
            
            System.debug(VIBA_LOG_PREFIX + 'Asset ìƒì„± í›„ ì²˜ë¦¬ ì™„ë£Œ - AssetId: ' + newAsset.Id);
            
        } catch (Exception e) {
            System.debug(VIBA_LOG_PREFIX + 'Asset ìƒì„± í›„ ì²˜ë¦¬ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    // ============================================================================
    // Utility Methods
    // ============================================================================
    
    /**
     * @description Orderë¡œë¶€í„° Account ID ì¡°íšŒ
     */
    private static Id getAccountIdFromOrder(Id orderId) {
        try {
            List<Order> orders = [SELECT AccountId FROM Order WHERE Id = :orderId LIMIT 1];
            return orders.isEmpty() ? null : orders[0].AccountId;
        } catch (Exception e) {
            System.debug(VIBA_LOG_PREFIX + 'Account ID ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage());
            return null;
        }
    }
    
    /**
     * @description ìœ„í—˜ ìƒíƒœ ë³€í™” í™•ì¸
     */
    private static Boolean isRiskStatusChange(PaymentStatus__c newPayment, PaymentStatus__c oldPayment) {
        return (newPayment.Status__c == 'ì—°ì²´' && oldPayment.Status__c != 'ì—°ì²´') ||
               (newPayment.Status__c == 'ë¯¸ë‚©' && oldPayment.Status__c == 'ì™„ë‚©');
    }
    
    /**
     * @description ê¸ì •ì  ìƒíƒœ ë³€í™” í™•ì¸
     */
    private static Boolean isPositiveStatusChange(PaymentStatus__c newPayment, PaymentStatus__c oldPayment) {
        return (newPayment.Status__c == 'ì™„ë‚©' && 
                (oldPayment.Status__c == 'ì—°ì²´' || oldPayment.Status__c == 'ë¯¸ë‚©'));
    }
    
    /**
     * @description ì²« ì™„ë‚© ê³ ê° í™•ì¸
     */
    private static Boolean isFirstTimeCompletedCustomer(Id accountId) {
        Integer completedPaymentCount = [
            SELECT COUNT() 
            FROM PaymentStatus__c 
            WHERE Order__r.AccountId = :accountId 
            AND Status__c = 'ì™„ë‚©'
        ];
        
        return completedPaymentCount == 1; // ì²« ë²ˆì§¸ ì™„ë‚©
    }
    
    /**
     * @description VIBA ì˜¤ë¥˜ Task ìƒì„±
     */
    private static void createVIBAErrorTask(Id orderId, String errorMessage) {
        try {
            Task errorTask = new Task(
                Subject = 'ğŸ¤– VIBA Asset ìƒì„± ì˜¤ë¥˜ ì²˜ë¦¬ í•„ìš”',
                Description = 'OrderId: ' + orderId + '\nì˜¤ë¥˜ ë‚´ìš©: ' + errorMessage + '\n\nìˆ˜ë™ Asset ìƒì„±ì„ ê²€í† í•´ì£¼ì„¸ìš”.',
                Priority = 'High',
                Status = 'Not Started',
                WhatId = orderId,
                ActivityDate = Date.today()
            );
            
            insert errorTask;
            
        } catch (Exception e) {
            System.debug(VIBA_LOG_PREFIX + 'ì˜¤ë¥˜ Task ìƒì„± ì‹¤íŒ¨: ' + e.getMessage());
        }
    }
    
    /**
     * @description ê¸´ê¸‰ ìœ„í—˜ Task ìƒì„±
     */
    private static void createUrgentRiskTask(VIBARiskPrediction prediction) {
        try {
            Task riskTask = new Task(
                Subject = 'ğŸš¨ VIBA ê³ ìœ„í—˜ ê³ ê° ì¦‰ì‹œ ëŒ€ì‘ í•„ìš”',
                Description = prediction.message + '\n\nì¦‰ì‹œ ê³ ê° ì ‘ì´‰ ë° ë¦¬ìŠ¤í¬ ê´€ë¦¬ í•„ìš”',
                Priority = 'High',
                Status = 'Not Started',
                ActivityDate = Date.today()
            );
            
            // Account Ownerì—ê²Œ í• ë‹¹
            List<Account> accounts = [SELECT OwnerId FROM Account WHERE Id = :prediction.accountId LIMIT 1];
            if (!accounts.isEmpty()) {
                riskTask.OwnerId = accounts[0].OwnerId;
            }
            
            insert riskTask;
            
        } catch (Exception e) {
            System.debug(VIBA_LOG_PREFIX + 'ìœ„í—˜ Task ìƒì„± ì‹¤íŒ¨: ' + e.getMessage());
        }
    }
    
    /**
     * @description ê¸°íšŒ Task ìƒì„±
     */
    private static void createOpportunityTask(VIBAOpportunityInsight opportunity) {
        try {
            Task opportunityTask = new Task(
                Subject = 'ğŸš€ VIBA ê¸°íšŒ ë°œêµ´ - ì¦‰ì‹œ ì•¡ì…˜',
                Description = opportunity.message + '\n\nì˜ˆìƒ ë§¤ì¶œ: ' + opportunity.estimatedRevenue + 'ì›',
                Priority = 'Normal',
                Status = 'Not Started',
                WhatId = opportunity.assetId,
                ActivityDate = Date.today().addDays(1)
            );
            
            insert opportunityTask;
            
        } catch (Exception e) {
            System.debug(VIBA_LOG_PREFIX + 'ê¸°íšŒ Task ìƒì„± ì‹¤íŒ¨: ' + e.getMessage());
        }
    }
    
    /**
     * @description í™˜ì˜ Task ìƒì„±
     */
    private static void createWelcomeTask(Id accountId) {
        try {
            Task welcomeTask = new Task(
                Subject = 'ğŸ‰ VIBA ì‹ ê·œ ì™„ë‚© ê³ ê° í™˜ì˜ ì•ˆë‚´',
                Description = 'ì²« ì™„ë‚©ì„ ë‹¬ì„±í•œ ì†Œì¤‘í•œ ê³ ê°ì…ë‹ˆë‹¤!\n\n' +
                            '1. ì™„ë‚© ì¶•í•˜ ì—°ë½\n' +
                            '2. ì„œë¹„ìŠ¤ ë§Œì¡±ë„ í™•ì¸\n' +
                            '3. ì¶”ê°€ ì„œë¹„ìŠ¤ ë‹ˆì¦ˆ íŒŒì•…\n' +
                            '4. ì¥ê¸° ê´€ê³„ êµ¬ì¶• ê³„íš ìˆ˜ë¦½',
                Priority = 'Normal',
                Status = 'Not Started',
                ActivityDate = Date.today().addDays(1)
            );
            
            // Account Ownerì—ê²Œ í• ë‹¹
            List<Account> accounts = [SELECT OwnerId FROM Account WHERE Id = :accountId LIMIT 1];
            if (!accounts.isEmpty()) {
                welcomeTask.OwnerId = accounts[0].OwnerId;
            }
            
            insert welcomeTask;
            
        } catch (Exception e) {
            System.debug(VIBA_LOG_PREFIX + 'í™˜ì˜ Task ìƒì„± ì‹¤íŒ¨: ' + e.getMessage());
        }
    }
    
    // ============================================================================
    // Async Processing Methods
    // ============================================================================
    
    /**
     * @description ë¹„ë™ê¸° ìœ„í—˜ë„ ë¶„ì„
     */
    @future
    private static void processRiskAnalysisAsync(List<Id> accountIds) {
        try {
            List<VIBARiskPrediction> predictions = VIBAFrameworkController.predictCustomerRisk(accountIds);
            
            for (VIBARiskPrediction prediction : predictions) {
                if (prediction.success && prediction.riskLevel == 'High') {
                    createUrgentRiskTask(prediction);
                }
            }
            
            System.debug(VIBA_LOG_PREFIX + 'ë¹„ë™ê¸° ìœ„í—˜ë„ ë¶„ì„ ì™„ë£Œ. ì²˜ë¦¬ëœ Account ìˆ˜: ' + accountIds.size());
            
        } catch (Exception e) {
            System.debug(VIBA_LOG_PREFIX + 'ë¹„ë™ê¸° ìœ„í—˜ë„ ë¶„ì„ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
}
