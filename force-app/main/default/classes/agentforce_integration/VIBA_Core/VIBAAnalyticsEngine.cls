/**
 * @description VIBA Analytics Engine - AI ê¸°ë°˜ ì¢…í•© ë¶„ì„ ì—”ì§„
 * @author VIBA AI Assistant
 * @date 2025-01-27
 */
public with sharing class VIBAAnalyticsEngine {
    
    // AI ë¶„ì„ ìƒìˆ˜
    private static final Decimal BASE_CONFIDENCE = 75.0;
    private static final Decimal HIGH_QUALITY_THRESHOLD = 90.0;
    private static final Decimal MEDIUM_QUALITY_THRESHOLD = 70.0;
    
    /**
     * @description ì¢…í•© AI ë¶„ì„ ìˆ˜í–‰
     * @param context ë¶„ì„ ì»¨í…ìŠ¤íŠ¸
     * @return VIBAInsight ë¶„ì„ ê²°ê³¼
     */
    public static VIBAInsight analyze(VIBAContext context) {
        VIBAInsight insight = new VIBAInsight();
        
        try {
            // 1. ë°ì´í„° í’ˆì§ˆ í‰ê°€
            insight.dataQuality = assessDataQuality(context);
            
            // 2. ê³ ê° ë“±ê¸‰ ë¶„ì„
            insight.customerTier = determineCustomerTier(context);
            
            // 3. ìœ„í—˜ë„ ë¶„ì„
            insight.riskLevel = analyzeRiskLevel(context);
            
            // 4. ê¸°íšŒ ì ìˆ˜ ê³„ì‚°
            insight.opportunityScore = calculateOpportunityScore(context);
            
            // 5. ë¶„ì„ ë³µì¡ë„ ê³„ì‚°
            insight.analysisComplexity = calculateAnalysisComplexity(context);
            
            // 6. VIBA ì ìˆ˜ ì‚°ì •
            insight.vibaScore = calculateVIBAScore(insight);
            
            // 7. ê°œì¸í™” ë©”ì‹œì§€ ìƒì„±
            insight.personalizedMessage = generatePersonalizedInsight(context, insight);
            
            System.debug('VIBAAnalyticsEngine: ë¶„ì„ ì™„ë£Œ. VIBA Score: ' + insight.vibaScore + '%, ê³ ê°ë“±ê¸‰: ' + insight.customerTier);
            
        } catch (Exception e) {
            System.debug('VIBAAnalyticsEngine ì˜¤ë¥˜: ' + e.getMessage());
            insight = createFallbackInsight();
        }
        
        return insight;
    }
    
    /**
     * @description ë°ì´í„° í’ˆì§ˆ í‰ê°€
     */
    private static Decimal assessDataQuality(VIBAContext context) {
        Decimal qualityScore = 50.0; // ê¸°ë³¸ ì ìˆ˜
        
        try {
            if (context.recordId != null) {
                qualityScore += 20.0; // ë ˆì½”ë“œ ID ì¡´ì¬
                
                // Order ì»¨í…ìŠ¤íŠ¸ í’ˆì§ˆ í‰ê°€
                if (context.orderContext != null) {
                    if (context.orderContext.hasCompleteData) qualityScore += 15.0;
                    if (context.orderContext.hasPaymentHistory) qualityScore += 10.0;
                    if (context.orderContext.hasCustomerHistory) qualityScore += 5.0;
                }
                
                // PaymentStatus ì»¨í…ìŠ¤íŠ¸ í’ˆì§ˆ í‰ê°€
                if (context.paymentContext != null) {
                    if (context.paymentContext.hasTimelineData) qualityScore += 10.0;
                    if (context.paymentContext.hasCompletionData) qualityScore += 10.0;
                }
                
                // Asset ì»¨í…ìŠ¤íŠ¸ í’ˆì§ˆ í‰ê°€
                if (context.assetContext != null) {
                    if (context.assetContext.hasUsageData) qualityScore += 10.0;
                    if (context.assetContext.hasPerformanceData) qualityScore += 5.0;
                }
            }
            
        } catch (Exception e) {
            System.debug('ë°ì´í„° í’ˆì§ˆ í‰ê°€ ì˜¤ë¥˜: ' + e.getMessage());
            qualityScore = 60.0; // ì•ˆì „í•œ ê¸°ë³¸ê°’
        }
        
        return Math.min(qualityScore, 100.0);
    }
    
    /**
     * @description ê³ ê° ë“±ê¸‰ ê²°ì •
     */
    private static String determineCustomerTier(VIBAContext context) {
        try {
            if (context.recordId == null) return 'New';
            
            // Account ì •ë³´ ì¡°íšŒ
            List<Account> accounts = getAccountInfo(context.recordId, context.requestType);
            
            if (accounts.isEmpty()) return 'Standard';
            
            Account account = accounts[0];
            
            // í”„ë¦¬ë¯¸ì—„ ê³ ê° ì¡°ê±´
            if (account.Key_Account__c == true || 
                account.CustomerPriority__c == 'High' ||
                account.AnnualRevenue > 1000000) {
                return 'Premium';
            }
            
            // VIP ê³ ê° ì¡°ê±´ (ì¶”ê°€ ë¶„ì„)
            if (hasMultipleOrders(account.Id) && hasExcellentPaymentHistory(account.Id)) {
                return 'VIP';
            }
            
            return 'Standard';
            
        } catch (Exception e) {
            System.debug('ê³ ê° ë“±ê¸‰ ê²°ì • ì˜¤ë¥˜: ' + e.getMessage());
            return 'Standard';
        }
    }
    
    /**
     * @description ìœ„í—˜ë„ ë ˆë²¨ ë¶„ì„
     */
    private static String analyzeRiskLevel(VIBAContext context) {
        try {
            Decimal riskScore = 0.0;
            
            // PaymentStatus ê¸°ë°˜ ìœ„í—˜ë„ ë¶„ì„
            if (context.paymentContext != null) {
                riskScore += analyzePaymentRisk(context.paymentContext);
            }
            
            // Order ê¸°ë°˜ ìœ„í—˜ë„ ë¶„ì„
            if (context.orderContext != null) {
                riskScore += analyzeOrderRisk(context.orderContext);
            }
            
            // Asset ê¸°ë°˜ ìœ„í—˜ë„ ë¶„ì„
            if (context.assetContext != null) {
                riskScore += analyzeAssetRisk(context.assetContext);
            }
            
            // ìœ„í—˜ë„ ë ˆë²¨ ê²°ì •
            if (riskScore > 70) return 'High';
            else if (riskScore > 40) return 'Medium';
            else return 'Low';
            
        } catch (Exception e) {
            System.debug('ìœ„í—˜ë„ ë¶„ì„ ì˜¤ë¥˜: ' + e.getMessage());
            return 'Medium';
        }
    }
    
    /**
     * @description ê¸°íšŒ ì ìˆ˜ ê³„ì‚°
     */
    private static Decimal calculateOpportunityScore(VIBAContext context) {
        Decimal opportunityScore = 50.0; // ê¸°ë³¸ ì ìˆ˜
        
        try {
            // ê³ ê° ë“±ê¸‰ë³„ ê¸°íšŒ ì ìˆ˜ ì¡°ì •
            String customerTier = determineCustomerTier(context);
            if (customerTier == 'Premium') opportunityScore += 20.0;
            else if (customerTier == 'VIP') opportunityScore += 30.0;
            
            // ì™„ë‚© ì´ë ¥ ê¸°ë°˜ ê¸°íšŒ ì ìˆ˜
            if (context.paymentContext != null && context.paymentContext.hasExcellentHistory) {
                opportunityScore += 15.0;
            }
            
            // Asset ì‚¬ìš© íŒ¨í„´ ê¸°ë°˜ ê¸°íšŒ ì ìˆ˜
            if (context.assetContext != null && context.assetContext.hasHighUsage) {
                opportunityScore += 10.0;
            }
            
            // ìµœê·¼ ì†Œí†µ ì´ë ¥ ê¸°ë°˜ ì ìˆ˜
            if (hasRecentPositiveEngagement(context.recordId)) {
                opportunityScore += 5.0;
            }
            
        } catch (Exception e) {
            System.debug('ê¸°íšŒ ì ìˆ˜ ê³„ì‚° ì˜¤ë¥˜: ' + e.getMessage());
            opportunityScore = 60.0;
        }
        
        return Math.min(opportunityScore, 100.0);
    }
    
    /**
     * @description ë¶„ì„ ë³µì¡ë„ ê³„ì‚°
     */
    private static Decimal calculateAnalysisComplexity(VIBAContext context) {
        Decimal complexity = 30.0; // ê¸°ë³¸ ë³µì¡ë„
        
        // ì»¨í…ìŠ¤íŠ¸ ìœ í˜•ë³„ ë³µì¡ë„ ì¶”ê°€
        if (context.orderContext != null) complexity += 20.0;
        if (context.paymentContext != null) complexity += 25.0;
        if (context.assetContext != null) complexity += 15.0;
        
        // ë°ì´í„° ì–‘ì— ë”°ë¥¸ ë³µì¡ë„ ì¡°ì •
        if (context.recordId != null) {
            Integer relatedRecordsCount = getRelatedRecordsCount(context.recordId, context.requestType);
            complexity += Math.min(relatedRecordsCount * 2.0, 20.0);
        }
        
        return Math.min(complexity, 100.0);
    }
    
    /**
     * @description VIBA ì ìˆ˜ ê³„ì‚°
     */
    private static Decimal calculateVIBAScore(VIBAInsight insight) {
        Decimal score = BASE_CONFIDENCE;
        
        // ë°ì´í„° í’ˆì§ˆì— ë”°ë¥¸ ì ìˆ˜ ì¡°ì •
        if (insight.dataQuality >= HIGH_QUALITY_THRESHOLD) {
            score += 20.0;
        } else if (insight.dataQuality >= MEDIUM_QUALITY_THRESHOLD) {
            score += 10.0;
        }
        
        // ë¶„ì„ ë³µì¡ë„ì— ë”°ë¥¸ ì‹ ë¢°ë„ ì¡°ì •
        if (insight.analysisComplexity > 80.0) {
            score += 5.0; // ë³µì¡í•œ ë¶„ì„ì¼ìˆ˜ë¡ ë” ì •í™•
        }
        
        // ìµœëŒ€ 95% (ê²¸ì†í•œ VIBA)
        return Math.min(score, 95.0);
    }
    
    /**
     * @description ê°œì¸í™”ëœ ì¸ì‚¬ì´íŠ¸ ìƒì„±
     */
    private static String generatePersonalizedInsight(VIBAContext context, VIBAInsight insight) {
        String message = '';
        
        try {
            // ê³ ê° ë“±ê¸‰ë³„ ë§ì¶¤ ë©”ì‹œì§€
            if (insight.customerTier == 'VIP') {
                message = 'ğŸ’ VIP ê³ ê°ìœ¼ë¡œì„œ ìµœìš°ì„  ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤. ';
            } else if (insight.customerTier == 'Premium') {
                message = 'â­ í”„ë¦¬ë¯¸ì—„ ê³ ê°ìœ¼ë¡œì„œ íŠ¹ë³„í•œ ê´€ì‹¬ì´ í•„ìš”í•©ë‹ˆë‹¤. ';
            } else {
                message = 'ğŸ‘¥ ì†Œì¤‘í•œ ê³ ê°ìœ¼ë¡œì„œ ì§€ì†ì ì¸ ê´€ê³„ ë°œì „ì´ ì¤‘ìš”í•©ë‹ˆë‹¤. ';
            }
            
            // ìœ„í—˜ë„ë³„ ë©”ì‹œì§€ ì¶”ê°€
            if (insight.riskLevel == 'High') {
                message += 'í˜„ì¬ ë†’ì€ ìœ„í—˜ ìƒí™©ì´ ê°ì§€ë˜ì–´ ì¦‰ì‹œ ì•¡ì…˜ì´ í•„ìš”í•©ë‹ˆë‹¤.';
            } else if (insight.riskLevel == 'Medium') {
                message += 'ì£¼ì˜ ê¹Šì€ ëª¨ë‹ˆí„°ë§ê³¼ ì„ ì œì  ëŒ€ì‘ì´ ê¶Œì¥ë©ë‹ˆë‹¤.';
            } else {
                message += 'ì•ˆì •ì ì¸ ìƒíƒœì´ë©° ê¸°íšŒ ë°œêµ´ì— ì§‘ì¤‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            }
            
            // ê¸°íšŒ ì ìˆ˜ë³„ ë©”ì‹œì§€ ì¶”ê°€
            if (insight.opportunityScore > 80) {
                message += ' ğŸš€ ë†’ì€ ì„±ê³µ ê°€ëŠ¥ì„±ì˜ ê¸°íšŒê°€ ìˆìŠµë‹ˆë‹¤!';
            } else if (insight.opportunityScore > 60) {
                message += ' ğŸ’¡ ì¢‹ì€ ê¸°íšŒê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.';
            }
            
        } catch (Exception e) {
            System.debug('ê°œì¸í™” ë©”ì‹œì§€ ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
            message = 'ğŸ“Š ì¢…í•© ë¶„ì„ì„ í†µí•´ ìµœì ì˜ ì „ëµì„ ìˆ˜ë¦½í–ˆìŠµë‹ˆë‹¤.';
        }
        
        return message;
    }
    
    // ============================================================================
    // Helper Methods
    // ============================================================================
    
    /**
     * @description Account ì •ë³´ ì¡°íšŒ
     */
    private static List<Account> getAccountInfo(Id recordId, String requestType) {
        String accountId = '';
        
        if (requestType == 'Order') {
            List<Order> orders = [SELECT AccountId FROM Order WHERE Id = :recordId LIMIT 1];
            if (!orders.isEmpty()) accountId = orders[0].AccountId;
        } else if (requestType == 'PaymentStatus') {
            List<PaymentStatus__c> payments = [SELECT Order__r.AccountId FROM PaymentStatus__c WHERE Id = :recordId LIMIT 1];
            if (!payments.isEmpty()) accountId = payments[0].Order__r.AccountId;
        } else if (requestType == 'Asset') {
            List<Asset> assets = [SELECT AccountId FROM Asset WHERE Id = :recordId LIMIT 1];
            if (!assets.isEmpty()) accountId = assets[0].AccountId;
        }
        
        if (String.isBlank(accountId)) return new List<Account>();
        
        return [
            SELECT Id, Name, Key_Account__c, CustomerPriority__c, AnnualRevenue,
                   Industry, NumberOfEmployees, Active__c
            FROM Account 
            WHERE Id = :accountId 
            LIMIT 1
        ];
    }
    
    /**
     * @description ë‹¤ìˆ˜ ì£¼ë¬¸ ì´ë ¥ í™•ì¸
     */
    private static Boolean hasMultipleOrders(Id accountId) {
        Integer orderCount = [SELECT COUNT() FROM Order WHERE AccountId = :accountId];
        return orderCount > 1;
    }
    
    /**
     * @description ìš°ìˆ˜í•œ ê²°ì œ ì´ë ¥ í™•ì¸
     */
    private static Boolean hasExcellentPaymentHistory(Id accountId) {
        // ì „ì²´ PaymentStatus ì¡°íšŒ
        Integer totalPayments = [
            SELECT COUNT() 
            FROM PaymentStatus__c 
            WHERE Order__r.AccountId = :accountId
        ];
        
        if (totalPayments == 0) return false;
        
        // ì™„ë‚©ëœ PaymentStatus ì¡°íšŒ
        Integer completedPayments = [
            SELECT COUNT() 
            FROM PaymentStatus__c 
            WHERE Order__r.AccountId = :accountId 
            AND Status__c = 'ì™„ë‚©'
        ];
        
        // 90% ì´ìƒ ì™„ë‚©ë¥ 
        return (completedPayments * 100 / totalPayments) >= 90;
    }
    
    /**
     * @description ê²°ì œ ìœ„í—˜ë„ ë¶„ì„
     */
    private static Decimal analyzePaymentRisk(VIBAPaymentContext paymentContext) {
        Decimal riskScore = 0.0;
        
        if (paymentContext.hasOverduePayments) riskScore += 30.0;
        if (paymentContext.hasRepeatedDelays) riskScore += 20.0;
        if (!paymentContext.hasRecentCommunication) riskScore += 15.0;
        
        return riskScore;
    }
    
    /**
     * @description Order ìœ„í—˜ë„ ë¶„ì„
     */
    private static Decimal analyzeOrderRisk(VIBAOrderContext orderContext) {
        Decimal riskScore = 0.0;
        
        if (!orderContext.hasCompleteData) riskScore += 10.0;
        if (orderContext.hasComplexPaymentTerms) riskScore += 15.0;
        
        return riskScore;
    }
    
    /**
     * @description Asset ìœ„í—˜ë„ ë¶„ì„
     */
    private static Decimal analyzeAssetRisk(VIBAAssetContext assetContext) {
        Decimal riskScore = 0.0;
        
        if (assetContext.hasLowUsage) riskScore += 20.0;
        if (assetContext.isNearingExpiry) riskScore += 25.0;
        
        return riskScore;
    }
    
    /**
     * @description ìµœê·¼ ê¸ì •ì  ì†Œí†µ í™•ì¸
     */
    private static Boolean hasRecentPositiveEngagement(Id recordId) {
        // ìµœê·¼ 30ì¼ ë‚´ ê¸ì •ì  Task/Event í™•ì¸
        Date recentDate = Date.today().addDays(-30);
        
        Integer positiveActivities = [
            SELECT COUNT() 
            FROM Task 
            WHERE WhatId = :recordId 
            AND CreatedDate >= :recentDate
            AND (Subject LIKE '%ì™„ë‚©%' OR Subject LIKE '%ì„±ê³µ%' OR Subject LIKE '%ë§Œì¡±%')
        ];
        
        return positiveActivities > 0;
    }
    
    /**
     * @description ê´€ë ¨ ë ˆì½”ë“œ ê°œìˆ˜ ì¡°íšŒ
     */
    private static Integer getRelatedRecordsCount(Id recordId, String requestType) {
        Integer count = 0;
        
        try {
            if (requestType == 'Order') {
                count = [SELECT COUNT() FROM PaymentStatus__c WHERE Order__c = :recordId];
            } else if (requestType == 'Asset') {
                // Assetê³¼ ê´€ë ¨ëœ Order ì°¾ê¸°
                List<Asset> assets = [SELECT SerialNumber FROM Asset WHERE Id = :recordId LIMIT 1];
                if (!assets.isEmpty()) {
                    count = [SELECT COUNT() FROM PaymentStatus__c WHERE Order__r.OrderNumber = :assets[0].SerialNumber];
                }
            }
        } catch (Exception e) {
            System.debug('ê´€ë ¨ ë ˆì½”ë“œ ê°œìˆ˜ ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage());
            count = 0;
        }
        
        return count;
    }
    
    /**
     * @description ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì¸ì‚¬ì´íŠ¸ ìƒì„±
     */
    private static VIBAInsight createFallbackInsight() {
        VIBAInsight insight = new VIBAInsight();
        insight.vibaScore = 70.0;
        insight.dataQuality = 60.0;
        insight.analysisComplexity = 50.0;
        insight.customerTier = 'Standard';
        insight.riskLevel = 'Medium';
        insight.opportunityScore = 60.0;
        insight.personalizedMessage = 'ğŸ“Š ê¸°ë³¸ ë¶„ì„ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ì¶”ê°€ ì •ë³´ê°€ í™•ë³´ë˜ë©´ ë” ì •í™•í•œ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•´ë“œë¦´ê²Œìš”.';
        
        return insight;
    }
}
