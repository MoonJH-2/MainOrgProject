/**
 * @description VIBA (Vibe-driven Intelligence Business Assistant) ì½”ì–´ í”„ë ˆì„ì›Œí¬
 * @author VIBA AI Assistant
 * @date 2025-01-27
 * @version 2.0
 */
public with sharing class VIBAFrameworkController {
    
    // VIBA ì„±ê²© ìƒìˆ˜
    private static final String VIBA_GREETING = 'ğŸ¯ ì•ˆë…•í•˜ì„¸ìš”! VIBAê°€ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤';
    private static final String VIBA_SUCCESS = 'ğŸ‰ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤';
    private static final String VIBA_THINKING = 'ğŸ¤” ìµœì ì˜ ë°©ë²•ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤';
    private static final String VIBA_ENCOURAGING = 'ğŸ’ª í•¨ê»˜ë¼ë©´ ê°€ëŠ¥í•©ë‹ˆë‹¤';
    
    /**
     * @description Order-PaymentStatus-Asset í†µí•© ë¶„ì„
     * @param requests VIBA ìš”ì²­ ëª©ë¡
     * @return List<VIBAResponse> VIBA ì‘ë‹µ ëª©ë¡
     */
    @InvocableMethod(label='VIBA ì¢…í•© ë¶„ì„' description='Order-Payment-Asset í†µí•© AI ë¶„ì„')
    public static List<VIBAResponse> performComprehensiveAnalysis(List<VIBARequest> requests) {
        List<VIBAResponse> responses = new List<VIBAResponse>();
        
        for (VIBARequest request : requests) {
            try {
                VIBAResponse response = new VIBAResponse();
                response.requestId = request.requestId;
                response.success = true;
                
                // 1. ì»¨í…ìŠ¤íŠ¸ ë¶„ì„
                VIBAContext context = analyzeContext(request);
                
                // 2. AI ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸ ìƒì„±
                VIBAInsight insight = generateInsight(context);
                
                // 3. ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ ì œì•ˆ
                List<VIBAAction> actions = generateActions(insight);
                
                // 4. VIBA ìŠ¤íƒ€ì¼ ì‘ë‹µ ìƒì„±
                response.message = generateVIBAMessage(insight, actions);
                response.insights = insight;
                response.recommendedActions = actions;
                response.confidence = calculateConfidence(insight);
                
                responses.add(response);
                
            } catch (Exception e) {
                responses.add(createErrorResponse(request.requestId, e.getMessage()));
            }
        }
        
        return responses;
    }
    
    /**
     * @description ìœ„í—˜ë„ ì˜ˆì¸¡ ë¶„ì„
     */
    @InvocableMethod(label='VIBA ìœ„í—˜ë„ ì˜ˆì¸¡' description='ê²°ì œ ì§€ì—° ë° ì´íƒˆ ìœ„í—˜ ì˜ˆì¸¡')
    public static List<VIBARiskPrediction> predictCustomerRisk(List<Id> accountIds) {
        List<VIBARiskPrediction> predictions = new List<VIBARiskPrediction>();
        
        for (Id accountId : accountIds) {
            try {
                VIBARiskPrediction prediction = VIBARiskAnalyzer.analyzeAccount(accountId);
                prediction.message = generateRiskMessage(prediction);
                predictions.add(prediction);
                
            } catch (Exception e) {
                VIBARiskPrediction errorPrediction = new VIBARiskPrediction();
                errorPrediction.accountId = accountId;
                errorPrediction.success = false;
                errorPrediction.message = VIBA_ENCOURAGING + ' ë¶„ì„ ì¤‘ ì¼ì‹œì  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                predictions.add(errorPrediction);
            }
        }
        
        return predictions;
    }
    
    /**
     * @description ê¸°íšŒ ë°œêµ´ ë¶„ì„
     */
    @InvocableMethod(label='VIBA ê¸°íšŒ ë°œêµ´' description='Up-selling ë° ê°±ì‹  ê¸°íšŒ ì‹ë³„')
    public static List<VIBAOpportunityInsight> identifyOpportunities(List<Id> assetIds) {
        List<VIBAOpportunityInsight> opportunities = new List<VIBAOpportunityInsight>();
        
        for (Id assetId : assetIds) {
            try {
                VIBAOpportunityInsight opportunity = VIBAOpportunityEngine.analyzeAsset(assetId);
                opportunity.message = generateOpportunityMessage(opportunity);
                opportunities.add(opportunity);
                
            } catch (Exception e) {
                VIBAOpportunityInsight errorOpportunity = new VIBAOpportunityInsight();
                errorOpportunity.assetId = assetId;
                errorOpportunity.success = false;
                errorOpportunity.message = VIBA_THINKING + ' ê¸°íšŒë¥¼ ì°¾ëŠ” ì¤‘ì…ë‹ˆë‹¤. ê³§ ë” ë‚˜ì€ ì œì•ˆì„ ë“œë¦´ê²Œìš”!';
                opportunities.add(errorOpportunity);
            }
        }
        
        return opportunities;
    }
    
    // ============================================================================
    // Private Helper Methods
    // ============================================================================
    
    /**
     * @description ì»¨í…ìŠ¤íŠ¸ ë¶„ì„
     */
    private static VIBAContext analyzeContext(VIBARequest request) {
        VIBAContext context = new VIBAContext();
        context.requestType = request.type;
        context.recordId = request.recordId;
        context.timestamp = DateTime.now();
        
        // ë ˆì½”ë“œ íƒ€ì…ì— ë”°ë¥¸ ì»¨í…ìŠ¤íŠ¸ ìˆ˜ì§‘
        if (request.type == 'Order') {
            context.orderContext = VIBAOrderAnalyzer.gatherOrderContext(request.recordId);
        } else if (request.type == 'PaymentStatus') {
            context.paymentContext = VIBAPaymentAnalyzer.gatherPaymentContext(request.recordId);
        } else if (request.type == 'Asset') {
            context.assetContext = VIBAAssetAnalyzer.gatherAssetContext(request.recordId);
        }
        
        return context;
    }
    
    /**
     * @description AI ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸ ìƒì„±
     */
    private static VIBAInsight generateInsight(VIBAContext context) {
        VIBAInsight insight = new VIBAInsight();
        
        // AI ë¶„ì„ ì—”ì§„ í˜¸ì¶œ
        insight = VIBAAnalyticsEngine.analyze(context);
        
        // VIBA ê°œì„± ì ìš©
        insight.vibaScore = calculateVIBAScore(insight);
        insight.personalizedMessage = generatePersonalizedMessage(insight);
        
        return insight;
    }
    
    /**
     * @description ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ ìƒì„±
     */
    private static List<VIBAAction> generateActions(VIBAInsight insight) {
        List<VIBAAction> actions = new List<VIBAAction>();
        
        // ì¸ì‚¬ì´íŠ¸ ê¸°ë°˜ ì•¡ì…˜ ìƒì„±
        actions.addAll(VIBAActionEngine.generateSmartActions(insight));
        
        // VIBA ìŠ¤íƒ€ì¼ ì•¡ì…˜ ë©”ì‹œì§€ ì ìš©
        for (VIBAAction action : actions) {
            action.description = enhanceActionWithVIBAStyle(action.description);
        }
        
        return actions;
    }
    
    /**
     * @description VIBA ìŠ¤íƒ€ì¼ ë©”ì‹œì§€ ìƒì„±
     */
    private static String generateVIBAMessage(VIBAInsight insight, List<VIBAAction> actions) {
        String message = VIBA_GREETING + '\n\n';
        
        // ì¸ì‚¬ì´íŠ¸ ìš”ì•½
        message += 'ğŸ“Š ë¶„ì„ ê²°ê³¼:\n';
        message += insight.personalizedMessage + '\n\n';
        
        // ì¶”ì²œ ì•¡ì…˜
        if (!actions.isEmpty()) {
            message += 'ğŸ’¡ ê¶Œì¥ ì•¡ì…˜:\n';
            for (Integer i = 0; i < Math.min(actions.size(), 3); i++) {
                VIBAAction action = actions[i];
                message += 'â€¢ ' + action.title + '\n';
            }
            message += '\n';
        }
        
        // VIBA ë§ˆë¬´ë¦¬ ë©˜íŠ¸
        message += generateVIBAClosing(insight.vibaScore);
        
        return message;
    }
    
    /**
     * @description ìœ„í—˜ë„ ë©”ì‹œì§€ ìƒì„±
     */
    private static String generateRiskMessage(VIBARiskPrediction prediction) {
        String message = '';
        
        if (prediction.riskLevel == 'Low') {
            message = 'âœ… ì•ˆì •ì ì¸ ê³ ê°ì…ë‹ˆë‹¤! í˜„ì¬ ìƒíƒœë¥¼ ìœ ì§€í•˜ì‹œë©´ ë©ë‹ˆë‹¤.';
        } else if (prediction.riskLevel == 'Medium') {
            message = 'âš ï¸ ì£¼ì˜ê°€ í•„ìš”í•œ ìƒí™©ì…ë‹ˆë‹¤. ì œê°€ ê¶Œì¥ ì¡°ì¹˜ë¥¼ ì¤€ë¹„í–ˆìŠµë‹ˆë‹¤.';
        } else if (prediction.riskLevel == 'High') {
            message = 'ğŸš¨ ì¦‰ì‹œ ì•¡ì…˜ì´ í•„ìš”í•©ë‹ˆë‹¤! í•¨ê»˜ í•´ê²°ì±…ì„ ì°¾ì•„ë³´ê² ìŠµë‹ˆë‹¤.';
        }
        
        return message + '\nì‹ ë¢°ë„: ' + prediction.confidence + '%';
    }
    
    /**
     * @description ê¸°íšŒ ë©”ì‹œì§€ ìƒì„±
     */
    private static String generateOpportunityMessage(VIBAOpportunityInsight opportunity) {
        String message = '';
        
        if (opportunity.opportunityScore > 80) {
            message = 'ğŸ¯ ë†“ì¹  ìˆ˜ ì—†ëŠ” ê¸°íšŒì…ë‹ˆë‹¤! ì§€ê¸ˆì´ ìµœì ì˜ íƒ€ì´ë°ì´ì—ìš”.';
        } else if (opportunity.opportunityScore > 60) {
            message = 'ğŸ’¡ ì¢‹ì€ ê¸°íšŒê°€ ìˆìŠµë‹ˆë‹¤. ì‹ ì¤‘í•˜ê²Œ ì ‘ê·¼í•´ë³´ì„¸ìš”.';
        } else {
            message = 'ğŸ“ˆ ì ì¬ì  ê¸°íšŒë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. ì¥ê¸°ì  ê´€ì ì—ì„œ ê²€í† í•´ë³´ì„¸ìš”.';
        }
        
        return message + '\nì„±ê³µ í™•ë¥ : ' + opportunity.opportunityScore + '%';
    }
    
    /**
     * @description VIBA ì ìˆ˜ ê³„ì‚°
     */
    private static Decimal calculateVIBAScore(VIBAInsight insight) {
        Decimal score = 75; // ê¸°ë³¸ ì‹ ë¢°ë„
        
        // ë°ì´í„° í’ˆì§ˆì— ë”°ë¥¸ ì¡°ì •
        if (insight.dataQuality > 90) score += 15;
        else if (insight.dataQuality > 70) score += 10;
        
        // ë¶„ì„ ë³µì¡ë„ì— ë”°ë¥¸ ì¡°ì •
        if (insight.analysisComplexity > 80) score += 10;
        
        return Math.min(score, 99); // ìµœëŒ€ 99% (ê²¸ì†í•œ VIBA)
    }
    
    /**
     * @description ê°œì¸í™”ëœ ë©”ì‹œì§€ ìƒì„±
     */
    private static String generatePersonalizedMessage(VIBAInsight insight) {
        String message = '';
        
        // ê³ ê°ë³„ ë§ì¶¤ ë©”ì‹œì§€
        if (insight.customerTier == 'Premium') {
            message = 'í”„ë¦¬ë¯¸ì—„ ê³ ê°ìœ¼ë¡œì„œ ìµœê³ ì˜ ì„œë¹„ìŠ¤ë¥¼ ë°›ìœ¼ì‹¤ ìê²©ì´ ìˆìŠµë‹ˆë‹¤.';
        } else if (insight.customerTier == 'Standard') {
            message = 'ì•ˆì •ì ì¸ ê´€ê³„ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë” ë‚˜ì€ ê¸°íšŒë¥¼ ë§Œë“¤ì–´ê°€ê² ìŠµë‹ˆë‹¤.';
        } else {
            message = 'ìƒˆë¡œìš´ ì‹œì‘ê³¼ í•¨ê»˜ ë©‹ì§„ ì„±ê³µì„ ë§Œë“¤ì–´ê°€ì„¸ìš”.';
        }
        
        return message;
    }
    
    /**
     * @description VIBA ìŠ¤íƒ€ì¼ ì•¡ì…˜ ê°•í™”
     */
    private static String enhanceActionWithVIBAStyle(String originalDescription) {
        // VIBA ê°œì„± ì ìš©
        if (originalDescription.contains('ìœ„í—˜')) {
            return 'ğŸ’ª ' + originalDescription + ' (í•¨ê»˜ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!)';
        } else if (originalDescription.contains('ê¸°íšŒ')) {
            return 'ğŸš€ ' + originalDescription + ' (ë†“ì¹˜ì§€ ë§ˆì„¸ìš”!)';
        } else {
            return 'âœ¨ ' + originalDescription + ' (ìµœì ì˜ ê²°ê³¼ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤!)';
        }
    }
    
    /**
     * @description VIBA ë§ˆë¬´ë¦¬ ë©˜íŠ¸
     */
    private static String generateVIBAClosing(Decimal confidence) {
        if (confidence > 90) {
            return 'ğŸ‰ ì™„ë²½í•œ ë¶„ì„ì…ë‹ˆë‹¤! ìì‹ ìˆê²Œ ì§„í–‰í•˜ì„¸ìš”.';
        } else if (confidence > 80) {
            return 'ğŸ‘ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.';
        } else {
            return 'ğŸ’¡ ì¶”ê°€ ë°ì´í„°ê°€ í™•ë³´ë˜ë©´ ë” ì •í™•í•œ ë¶„ì„ì„ ì œê³µí•´ë“œë¦´ê²Œìš”.';
        }
    }
    
    /**
     * @description ì‹ ë¢°ë„ ê³„ì‚°
     */
    private static Decimal calculateConfidence(VIBAInsight insight) {
        return insight.vibaScore;
    }
    
    /**
     * @description ì˜¤ë¥˜ ì‘ë‹µ ìƒì„±
     */
    private static VIBAResponse createErrorResponse(String requestId, String errorMessage) {
        VIBAResponse response = new VIBAResponse();
        response.requestId = requestId;
        response.success = false;
        response.message = VIBA_ENCOURAGING + ' ì¼ì‹œì  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\n\nê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­: ' + errorMessage;
        response.confidence = 70;
        return response;
    }
}
