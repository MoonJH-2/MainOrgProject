/**
 * @description Agentforceì™€ Slack í†µí•©ì„ ìœ„í•œ ì„œë¹„ìŠ¤ (Phase 2)
 * @author AI Assistant
 * @created 2025-07-24
 */
public with sharing class AgentforceSlackIntegrationService {
    
    /**
     * Order í™œì„±í™” ì‹œ ìë™ìœ¼ë¡œ Slack ì±„ë„ ìƒì„± ë° íŒ€ ì´ˆëŒ€
     */
    @InvocableMethod(label='Create Order Slack Channel' description='Orderë³„ Slack ì±„ë„ ìë™ ìƒì„± ë° ì´ˆê¸°í™”')
    public static List<SlackChannelResult> createOrderSlackChannel(List<SlackChannelRequest> requests) {
        List<SlackChannelResult> results = new List<SlackChannelResult>();
        
        for (SlackChannelRequest request : requests) {
            try {
                SlackChannelResult result = processSlackChannelCreation(request);
                results.add(result);
            } catch (Exception e) {
                SlackChannelResult errorResult = new SlackChannelResult();
                errorResult.success = false;
                errorResult.errorMessage = e.getMessage();
                results.add(errorResult);
            }
        }
        
        return results;
    }
    
    private static SlackChannelResult processSlackChannelCreation(SlackChannelRequest request) {
        SlackChannelResult result = new SlackChannelResult();
        
        // 1. Order ì •ë³´ ì¡°íšŒ
        Order orderInfo = getOrderInfo(request.orderId);
        
        // 2. ì±„ë„ëª… ìƒì„±
        String channelName = generateChannelName(orderInfo);
        
        // 3. ê¸°ì¡´ Salesforce ì±„ë„ ì‹œìŠ¤í…œ í™œìš© (SalesforceChannelService ì—°ë™)
        String channelId = createSalesforceChannel(orderInfo, channelName);
        
        // 4. ì´ˆê¸° ë©”ì‹œì§€ ë° ìº”ë²„ìŠ¤ ìƒì„±
        if (String.isNotBlank(channelId)) {
            createInitialChannelContent(orderInfo, channelId);
            result.success = true;
            result.channelId = channelId;
            result.channelName = channelName;
            result.orderNumber = orderInfo.OrderNumber;
        }
        
        return result;
    }
    
    /**
     * ê²°ì œ ì™„ë£Œ/ì—°ì²´ ì‹œ Slack ì•Œë¦¼ ë°œì†¡
     */
    @InvocableMethod(label='Send Payment Notification' description='ê²°ì œ ìƒíƒœ ë³€ê²½ ì‹œ Slack ì•Œë¦¼')
    public static List<PaymentNotificationResult> sendPaymentNotification(List<PaymentNotificationRequest> requests) {
        List<PaymentNotificationResult> results = new List<PaymentNotificationResult>();
        
        for (PaymentNotificationRequest request : requests) {
            try {
                PaymentNotificationResult result = processPaymentNotification(request);
                results.add(result);
            } catch (Exception e) {
                PaymentNotificationResult errorResult = new PaymentNotificationResult();
                errorResult.success = false;
                errorResult.errorMessage = e.getMessage();
                results.add(errorResult);
            }
        }
        
        return results;
    }
    
    private static PaymentNotificationResult processPaymentNotification(PaymentNotificationRequest request) {
        PaymentNotificationResult result = new PaymentNotificationResult();
        
        // 1. PaymentStatus ì •ë³´ ì¡°íšŒ
        PaymentStatus__c payment = getPaymentInfo(request.paymentId);
        
        // 2. ê´€ë ¨ Order ì •ë³´ ì¡°íšŒ
        Order orderInfo = [SELECT Id, OrderNumber, AccountId, Account.Name FROM Order WHERE Id = :payment.Order__c LIMIT 1];
        
        // 3. í•´ë‹¹ Orderì˜ Slack ì±„ë„ ì°¾ê¸°
        String channelId = findOrderChannel(orderInfo.OrderNumber);
        
        // 4. ê²°ì œ ìƒíƒœì— ë”°ë¥¸ ë©”ì‹œì§€ ìƒì„± ë° ë°œì†¡
        if (String.isNotBlank(channelId)) {
            String message = generatePaymentMessage(payment, orderInfo, request.notificationType);
            Boolean sent = sendChannelMessage(channelId, message);
            
            result.success = sent;
            result.channelId = channelId;
            result.message = message;
        }
        
        return result;
    }
    
    /**
     * ì˜ì—… í™œë™ í›„ íŒ€ ì•Œë¦¼
     */
    @AuraEnabled
    public static SlackNotificationResult notifyTeamActivity(String orderId, String activityType, String message) {
        try {
            SlackNotificationResult result = new SlackNotificationResult();
            
            // Order ì •ë³´ ì¡°íšŒ
            Order orderInfo = [SELECT Id, OrderNumber, Account.Name FROM Order WHERE Id = :orderId LIMIT 1];
            
            // ì±„ë„ ì°¾ê¸°
            String channelId = findOrderChannel(orderInfo.OrderNumber);
            
            if (String.isNotBlank(channelId)) {
                String formattedMessage = formatActivityMessage(orderInfo, activityType, message);
                Boolean sent = sendChannelMessage(channelId, formattedMessage);
                
                result.success = sent;
                result.channelId = channelId;
                result.message = formattedMessage;
            } else {
                result.success = false;
                result.errorMessage = 'í•´ë‹¹ Orderì˜ Slack ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
            
            return result;
            
        } catch (Exception e) {
            throw new AuraHandledException('íŒ€ ì•Œë¦¼ ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    // Private Helper Methods
    
    private static Order getOrderInfo(String orderId) {
        return [
            SELECT Id, OrderNumber, Status, TotalAmount, EffectiveDate, EndDate,
                   AccountId, Account.Name, Contact.Name, Contact.Email,
                   OwnerId, Owner.Name, Payment_Method__c
            FROM Order 
            WHERE Id = :orderId 
            LIMIT 1
        ];
    }
    
    private static String generateChannelName(Order orderInfo) {
        // "Order-00000167-íš¨ì›" í˜•íƒœë¡œ ìƒì„±
        String accountName = orderInfo.Account.Name.replaceAll('[^a-zA-Z0-9ê°€-í£]', '');
        return 'Order-' + orderInfo.OrderNumber + '-' + accountName;
    }
    
    private static String createSalesforceChannel(Order orderInfo, String channelName) {
        try {
            // ê¸°ì¡´ SalesforceChannelService í™œìš©
            // CollaborationGroup ìƒì„±
            CollaborationGroup channel = new CollaborationGroup();
            channel.Name = channelName;
            channel.CollaborationType = 'Private';
            channel.Description = String.format(
                'Order {0} ({1}) ì§„í–‰ê´€ë¦¬ ì±„ë„\nìƒì„±ì¼: {2}\në‹´ë‹¹ì: {3}',
                new List<Object>{
                    orderInfo.OrderNumber,
                    orderInfo.Account.Name,
                    Date.today().format(),
                    orderInfo.Owner.Name
                }
            );
            
            insert channel;
            
            // Order Ownerë¥¼ Adminìœ¼ë¡œ ì¶”ê°€
            CollaborationGroupMember ownerMember = new CollaborationGroupMember();
            ownerMember.CollaborationGroupId = channel.Id;
            ownerMember.MemberId = orderInfo.OwnerId;
            ownerMember.CollaborationRole = 'Admin';
            
            insert ownerMember;
            
            return channel.Id;
            
        } catch (Exception e) {
            System.debug('Slack ì±„ë„ ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
            return null;
        }
    }
    
    private static void createInitialChannelContent(Order orderInfo, String channelId) {
        try {
            // í™˜ì˜ ë©”ì‹œì§€ ìƒì„±
            String welcomeMessage = String.format(
                'ğŸ‰ **Order {0} í™œì„±í™” ì™„ë£Œ!**\n\n' +
                'ğŸ“‹ **ì£¼ë¬¸ ì •ë³´**\n' +
                'â€¢ ê³ ê°: {1}\n' +
                'â€¢ ë‹´ë‹¹ì: {2}\n' +
                'â€¢ ì˜ì—…ë‹´ë‹¹: {3}\n\n' +
                'ğŸ’° **ê²°ì œ ì •ë³´**\n' +
                'â€¢ ì´ ê¸ˆì•¡: {4}\n' +
                'â€¢ ê²°ì œ ë°©ì‹: {5}\n' +
                'â€¢ ì‹œì‘ì¼: {6}\n\n' +
                'ğŸ“… **ë‹¤ìŒ ì•¡ì…˜**\n' +
                'â€¢ [ ] ê³ ê° ì˜¨ë³´ë”© ë¯¸íŒ… ì¼ì • ì¡°ìœ¨\n' +
                'â€¢ [ ] ì²« ë²ˆì§¸ ë‚©ë¶€ ì•ˆë‚´ ì´ë©”ì¼ ë°œì†¡\n' +
                'â€¢ [ ] Asset ì¤€ë¹„ ìƒíƒœ í™•ì¸\n\n' +
                'ğŸ”” **ìë™ ì•Œë¦¼ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤**',
                new List<Object>{
                    orderInfo.OrderNumber,
                    orderInfo.Account.Name,
                    orderInfo.Contact.Name,
                    orderInfo.Owner.Name,
                    String.valueOf(orderInfo.TotalAmount),
                    orderInfo.Payment_Method__c,
                    orderInfo.EffectiveDate?.format()
                }
            );
            
            // FeedItemìœ¼ë¡œ ë©”ì‹œì§€ ê²Œì‹œ
            FeedItem welcomePost = new FeedItem();
            welcomePost.ParentId = channelId;
            welcomePost.Body = welcomeMessage;
            welcomePost.Type = 'TextPost';
            
            insert welcomePost;
            
        } catch (Exception e) {
            System.debug('ì´ˆê¸° ì±„ë„ ì½˜í…ì¸  ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    private static PaymentStatus__c getPaymentInfo(String paymentId) {
        return [
            SELECT Id, Order__c, Amount__c, Due_Date__c, Status__c, Payment_Number__c
            FROM PaymentStatus__c 
            WHERE Id = :paymentId 
            LIMIT 1
        ];
    }
    
    private static String findOrderChannel(String orderNumber) {
        try {
            List<CollaborationGroup> channels = [
                SELECT Id 
                FROM CollaborationGroup 
                WHERE Name LIKE :('Order-' + orderNumber + '%')
                LIMIT 1
            ];
            
            return channels.isEmpty() ? null : channels[0].Id;
            
        } catch (Exception e) {
            System.debug('Order ì±„ë„ ì°¾ê¸° ì˜¤ë¥˜: ' + e.getMessage());
            return null;
        }
    }
    
    private static String generatePaymentMessage(PaymentStatus__c payment, Order orderInfo, String notificationType) {
        switch on notificationType {
            when 'PAYMENT_COMPLETED' {
                return String.format(
                    'âœ… **{0}ì°¨ ê²°ì œ ì™„ë£Œ!**\n' +
                    'ğŸ’° ê¸ˆì•¡: {1}\n' +
                    'ğŸ“… ì™„ë£Œì¼: {2}\n' +
                    'ğŸ“Š Order {3} ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ë¨',
                    new List<Object>{
                        payment.Payment_Number__c,
                        String.valueOf(payment.Amount__c),
                        payment.Due_Date__c?.format(),
                        orderInfo.OrderNumber
                    }
                );
            }
            when 'PAYMENT_OVERDUE' {
                return String.format(
                    'âš ï¸ **ì—°ì²´ ì•Œë¦¼: Order {0}**\n' +
                    'ğŸ“… ì˜ˆì •ì¼: {1}\n' +
                    'ğŸ’° ê¸ˆì•¡: {2}\n' +
                    'ğŸ”” {3}ì°¨ ê²°ì œ ì—°ì²´\n' +
                    'ğŸ‘¤ ë‹´ë‹¹ì: @{4} ì¦‰ì‹œ ì—°ë½ í•„ìš”',
                    new List<Object>{
                        orderInfo.OrderNumber,
                        payment.Due_Date__c?.format(),
                        String.valueOf(payment.Amount__c),
                        payment.Payment_Number__c,
                        orderInfo.Account.Name
                    }
                );
            }
            when 'PAYMENT_REMINDER' {
                return String.format(
                    'ğŸ“… **ë‚©ë¶€ ì˜ˆì • ì•Œë¦¼: Order {0}**\n' +
                    'ğŸ’° ê¸ˆì•¡: {1}\n' +
                    'ğŸ“… ì˜ˆì •ì¼: {2} (3ì¼ í›„)\n' +
                    'ğŸ‘¤ ë‹´ë‹¹ì: ê³ ê° ì•ˆë‚´ í•„ìš”',
                    new List<Object>{
                        orderInfo.OrderNumber,
                        String.valueOf(payment.Amount__c),
                        payment.Due_Date__c?.format()
                    }
                );
            }
            when else {
                return 'ğŸ“‹ ê²°ì œ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.';
            }
        }
    }    private static Boolean sendChannelMessage(String channelId, String message) {
        try {
            FeedItem post = new FeedItem();
            post.ParentId = channelId;
            post.Body = message;
            post.Type = 'TextPost';
            
            insert post;
            return true;
            
        } catch (Exception e) {
            System.debug('Slack ë©”ì‹œì§€ ë°œì†¡ ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
    }
    
    private static String formatActivityMessage(Order orderInfo, String activityType, String message) {
        String icon = getActivityIcon(activityType);
        return String.format(
            '{0} **{1}**\n' +
            'ğŸ“‹ Order: {2} ({3})\n' +
            'ğŸ’¬ {4}\n' +
            'ğŸ‘¤ ì‘ì„±ì: {5}',
            new List<Object>{
                icon,
                activityType,
                orderInfo.OrderNumber,
                orderInfo.Account.Name,
                message,
                UserInfo.getName()
            }
        );
    }
    
    private static String getActivityIcon(String activityType) {
        switch on activityType {
            when 'MEETING' { return 'ğŸ¤'; }
            when 'CALL' { return 'ğŸ“'; }
            when 'EMAIL' { return 'ğŸ“§'; }
            when 'TASK' { return 'âœ…'; }
            when 'PROPOSAL' { return 'ğŸ“‹'; }
            when else { return 'ğŸ“'; }
        }
    }
    
    // Wrapper Classes
    
    public class SlackChannelRequest {
        @InvocableVariable(label='Order ID' required=true)
        public String orderId;
        
        @InvocableVariable(label='Include Team Members')
        public Boolean includeTeamMembers;
    }
    
    public class SlackChannelResult {
        @InvocableVariable
        public Boolean success;
        
        @InvocableVariable
        public String channelId;
        
        @InvocableVariable
        public String channelName;
        
        @InvocableVariable
        public String orderNumber;
        
        @InvocableVariable
        public String errorMessage;
        
        public SlackChannelResult() {
            this.success = false;
            this.includeTeamMembers = true;
        }
    }
    
    public class PaymentNotificationRequest {
        @InvocableVariable(label='Payment ID' required=true)
        public String paymentId;
        
        @InvocableVariable(label='Notification Type' required=true)
        public String notificationType; // PAYMENT_COMPLETED, PAYMENT_OVERDUE, PAYMENT_REMINDER
    }
    
    public class PaymentNotificationResult {
        @InvocableVariable
        public Boolean success;
        
        @InvocableVariable
        public String channelId;
        
        @InvocableVariable
        public String message;
        
        @InvocableVariable
        public String errorMessage;
        
        public PaymentNotificationResult() {
            this.success = false;
        }
    }
    
    public class SlackNotificationResult {
        @AuraEnabled public Boolean success { get; set; }
        @AuraEnabled public String channelId { get; set; }
        @AuraEnabled public String message { get; set; }
        @AuraEnabled public String errorMessage { get; set; }
        
        public SlackNotificationResult() {
            this.success = false;
        }
    }
}
