/**
 * @description Agentforce ë§ˆìŠ¤í„° ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ì„œë¹„ìŠ¤ - ê°„ë‹¨í•œ ë²„ì „
 * @author AI Assistant
 * @created 2025-07-24
 */
public with sharing class AgentforceSimpleMasterService {
    
    /**
     * Agentforce Agentê°€ í˜¸ì¶œí•˜ëŠ” ë©”ì¸ ì—”íŠ¸ë¦¬í¬ì¸íŠ¸
     */
    @InvocableMethod(label='Process Agentforce Request' description='Agentforce ìš”ì²­ì„ ë¶„ì„í•˜ê³  ì²˜ë¦¬í•˜ëŠ” ë§ˆìŠ¤í„° ì„œë¹„ìŠ¤')
    public static List<AgentforceResponse> processAgentforceRequest(List<AgentforceRequest> requests) {
        List<AgentforceResponse> responses = new List<AgentforceResponse>();
        
        for (AgentforceRequest request : requests) {
            try {
                AgentforceResponse response = routeAndProcessRequest(request);
                responses.add(response);
            } catch (Exception e) {
                AgentforceResponse errorResponse = new AgentforceResponse();
                errorResponse.success = false;
                errorResponse.errorMessage = e.getMessage();
                errorResponse.responseType = 'ERROR';
                responses.add(errorResponse);
            }
        }
        
        return responses;
    }
    
    // ì¼ì¼ ìë™í™” ì‹¤í–‰ (AuraEnabled ë©”ì†Œë“œ)
    @AuraEnabled
    public static DailyAutomationResult executeDailyAutomation(Id userId) {
        try {
            DailyAutomationResult result = new DailyAutomationResult();
            
            // 1. ì¼ì¼ ë¸Œë¦¬í•‘ ìƒì„±
            result.dailyBriefing = AgentforceSalesAssistantService.getDailyBriefing(userId);
            
            // 2. ê³ ìœ„í—˜ ê³ ê° ë¶„ì„
            result.churnRiskCustomers = analyzeHighRiskCustomers(userId);
            
            // 3. ê°±ì‹  ê¸°íšŒ ì‹ë³„
            result.renewalOpportunities = identifyRenewalOpportunities(userId);
            
            // 4. ì¶”ì²œ ì•¡ì…˜ ìƒì„±
            result.recommendedActions = generateDailyRecommendations(result);
            
            result.success = true;
            result.executionTime = System.now();
            
            return result;
            
        } catch (Exception e) {
            throw new AuraHandledException('ì¼ì¼ ìë™í™” ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    // ê³ ê° 360ë„ ë·° ì œê³µ
    @AuraEnabled(cacheable=true)
    public static Customer360View getCustomer360View(Id customerId) {
        try {
            Customer360View result = new Customer360View();
            
            // 1. ê¸°ë³¸ ê³ ê° ì •ë³´
            result.customerInfo = getCustomerBasicInfo(customerId);
            
            // 2. ì´íƒˆ ìœ„í—˜ë„ ë¶„ì„
            AgentforceSimpleAnalyticsService.ChurnPredictionRequest churnRequest = 
                new AgentforceSimpleAnalyticsService.ChurnPredictionRequest();
            churnRequest.customerId = customerId;
            
            List<AgentforceSimpleAnalyticsService.ChurnPredictionResult> churnResults = 
                AgentforceSimpleAnalyticsService.predictCustomerChurnRisk(
                    new List<AgentforceSimpleAnalyticsService.ChurnPredictionRequest>{churnRequest}
                );
            
            result.churnRisk = churnResults[0];
            
            // 3. ìµœì  ì—°ë½ ì‹œì 
            result.contactTiming = AgentforceSimpleAnalyticsService.getOptimalContactTiming(customerId);
            
            // 4. ê°±ì‹  ê¸°íšŒ ë¶„ì„
            result.renewalAnalysis = AgentforceSimpleAnalyticsService.analyzeRenewalOpportunity(customerId);
            
            // 5. ìµœê·¼ í™œë™ ì´ë ¥
            result.recentActivities = getRecentCustomerActivities(customerId);
            
            result.success = true;
            return result;
            
        } catch (Exception e) {
            throw new AuraHandledException('ê³ ê° 360ë„ ë·° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    // Private Helper Methods
    
    private static AgentforceResponse routeAndProcessRequest(AgentforceRequest request) {
        AgentforceResponse response = new AgentforceResponse();
        
        // Intent ë¶„ì„ ë° ë¼ìš°íŒ…
        String intent = analyzeUserIntent(request.userMessage);
        
        switch on intent {
            when 'DAILY_BRIEFING' {
                response = handleDailyBriefingRequest(request);
            }
            when 'EMAIL_GENERATION' {
                response = handleEmailGenerationRequest(request);
            }
            when 'CUSTOMER_ANALYSIS' {
                response = handleCustomerAnalysisRequest(request);
            }
            when 'SLACK_NOTIFICATION' {
                response = handleSlackNotificationRequest(request);
            }
            when else {
                response = handleGeneralRequest(request);
            }
        }
        
        return response;
    }
    
    private static String analyzeUserIntent(String userMessage) {
        String message = userMessage.toLowerCase();
        
        if (message.contains('ì˜¤ëŠ˜') && (message.contains('í• ì¼') || message.contains('ë¸Œë¦¬í•‘'))) {
            return 'DAILY_BRIEFING';
        } else if (message.contains('ì´ë©”ì¼') && (message.contains('ë³´ë‚´') || message.contains('ì‘ì„±'))) {
            return 'EMAIL_GENERATION';
        } else if (message.contains('ê³ ê°') && (message.contains('ë¶„ì„') || message.contains('ìœ„í—˜'))) {
            return 'CUSTOMER_ANALYSIS';
        } else if (message.contains('íŒ€') && (message.contains('ì•Œë¦¼') || message.contains('ê³µìœ '))) {
            return 'SLACK_NOTIFICATION';
        } else {
            return 'GENERAL';
        }
    }
    
    private static AgentforceResponse handleDailyBriefingRequest(AgentforceRequest request) {
        AgentforceResponse response = new AgentforceResponse();
        
        try {
            // Phase 1 ì„œë¹„ìŠ¤ í˜¸ì¶œ
            AgentforceSalesAssistantService.DailyBriefingResult briefing = 
                AgentforceSalesAssistantService.getDailyBriefing(request.userId);
            
            // ì‘ë‹µ êµ¬ì„±
            response.responseType = 'DAILY_BRIEFING';
            response.title = 'ì˜¤ëŠ˜ì˜ ì˜ì—… ë¸Œë¦¬í•‘';
            response.content = formatDailyBriefingResponse(briefing);
            response.success = true;
        } catch (Exception e) {
            response.success = false;
            response.errorMessage = e.getMessage();
        }
        
        return response;
    }
    
    private static AgentforceResponse handleEmailGenerationRequest(AgentforceRequest request) {
        AgentforceResponse response = new AgentforceResponse();
        
        try {
            // ì´ë©”ì¼ ìƒì„± ì„œë¹„ìŠ¤ í˜¸ì¶œ
            AgentforceSimpleEmailActions.EmailRequest emailRequest = 
                new AgentforceSimpleEmailActions.EmailRequest();
            emailRequest.recordId = request.recordId;
            emailRequest.emailType = determineEmailType(request.userMessage);
            emailRequest.additionalContext = request.additionalContext;
            
            List<AgentforceSimpleEmailActions.EmailResult> emailResults = 
                AgentforceSimpleEmailActions.generateEmailDraft(
                    new List<AgentforceSimpleEmailActions.EmailRequest>{emailRequest}
                );
            
            response.responseType = 'EMAIL_DRAFT';
            response.title = 'ì´ë©”ì¼ ì´ˆì•ˆì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤';
            response.content = formatEmailResponse(emailResults[0]);
            response.success = emailResults[0].success;
        } catch (Exception e) {
            response.success = false;
            response.errorMessage = e.getMessage();
        }
        
        return response;
    }
    
    private static AgentforceResponse handleCustomerAnalysisRequest(AgentforceRequest request) {
        AgentforceResponse response = new AgentforceResponse();
        
        try {
            // Phase 3 ê³ ê¸‰ ë¶„ì„ ì„œë¹„ìŠ¤ í˜¸ì¶œ
            AgentforceSimpleAnalyticsService.ChurnPredictionRequest churnRequest = 
                new AgentforceSimpleAnalyticsService.ChurnPredictionRequest();
            churnRequest.customerId = request.recordId;
            
            List<AgentforceSimpleAnalyticsService.ChurnPredictionResult> churnResults = 
                AgentforceSimpleAnalyticsService.predictCustomerChurnRisk(
                    new List<AgentforceSimpleAnalyticsService.ChurnPredictionRequest>{churnRequest}
                );
            
            response.responseType = 'CUSTOMER_ANALYSIS';
            response.title = 'ê³ ê° ì´íƒˆ ìœ„í—˜ë„ ë¶„ì„';
            response.content = formatChurnAnalysisResponse(churnResults[0]);
            response.success = churnResults[0].success;
        } catch (Exception e) {
            response.success = false;
            response.errorMessage = e.getMessage();
        }
        
        return response;
    }
    
    private static AgentforceResponse handleSlackNotificationRequest(AgentforceRequest request) {
        AgentforceResponse response = new AgentforceResponse();
        
        try {
            // Phase 2 Slack í†µí•© ì„œë¹„ìŠ¤ í˜¸ì¶œ
            AgentforceSimpleSlackService.SlackNotificationRequest slackRequest = 
                new AgentforceSimpleSlackService.SlackNotificationRequest();
            slackRequest.recordId = request.recordId;
            slackRequest.notificationType = 'GENERAL';
            slackRequest.message = request.additionalContext;
            
            List<AgentforceSimpleSlackService.SlackNotificationResult> slackResults = 
                AgentforceSimpleSlackService.sendTeamNotification(
                    new List<AgentforceSimpleSlackService.SlackNotificationRequest>{slackRequest}
                );
            
            response.responseType = 'SLACK_NOTIFICATION';
            response.title = 'Slack ì•Œë¦¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤';
            response.content = slackResults[0].success ? 
                'íŒ€ ì±„ë„ì— ì•Œë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.' : 
                'ì•Œë¦¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + slackResults[0].errorMessage;
            response.success = slackResults[0].success;
        } catch (Exception e) {
            response.success = false;
            response.errorMessage = e.getMessage();
        }
        
        return response;
    }
    
    private static AgentforceResponse handleGeneralRequest(AgentforceRequest request) {
        AgentforceResponse response = new AgentforceResponse();
        
        response.responseType = 'GENERAL';
        response.title = 'SOCAR Sales Assistant';
        response.content = 'ì•ˆë…•í•˜ì„¸ìš”! ì–´ë–¤ ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?\n\n' +
            'ë‹¤ìŒê³¼ ê°™ì€ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:\n' +
            'â€¢ "ì˜¤ëŠ˜ í•  ì¼ ì •ë¦¬í•´ì¤˜" - ì¼ì¼ ë¸Œë¦¬í•‘\n' +
            'â€¢ "ê³ ê°ì—ê²Œ ì´ë©”ì¼ ë³´ë‚´ì¤˜" - ì´ë©”ì¼ ì‘ì„±\n' +
            'â€¢ "ê³ ê° ì´íƒˆ ìœ„í—˜ë„ ë¶„ì„í•´ì¤˜" - ê³ ê° ë¶„ì„\n' +
            'â€¢ "íŒ€ì— ì•Œë¦¼ ë³´ë‚´ì¤˜" - Slack ì•Œë¦¼';
        response.success = true;
        
        return response;
    }
    
    // Helper Methods for Data Processing
    
    private static List<AgentforceSimpleAnalyticsService.ChurnPredictionResult> analyzeHighRiskCustomers(Id userId) {
        // ì˜ì—…ë‹´ë‹¹ìì˜ ê³ ìœ„í—˜ ê³ ê° ë¶„ì„
        List<Account> userAccounts = [
            SELECT Id 
            FROM Account 
            WHERE OwnerId = :userId 
            AND LastActivityDate < LAST_N_DAYS:30
            LIMIT 5
        ];
        
        List<AgentforceSimpleAnalyticsService.ChurnPredictionRequest> churnRequests = 
            new List<AgentforceSimpleAnalyticsService.ChurnPredictionRequest>();
        
        for (Account acc : userAccounts) {
            AgentforceSimpleAnalyticsService.ChurnPredictionRequest req = 
                new AgentforceSimpleAnalyticsService.ChurnPredictionRequest();
            req.customerId = acc.Id;
            churnRequests.add(req);
        }
        
        return churnRequests.isEmpty() ? 
            new List<AgentforceSimpleAnalyticsService.ChurnPredictionResult>() :
            AgentforceSimpleAnalyticsService.predictCustomerChurnRisk(churnRequests);
    }
    
    private static List<AgentforceSimpleAnalyticsService.AssetRenewalAnalysis> identifyRenewalOpportunities(Id userId) {
        // ì˜ì—…ë‹´ë‹¹ìì˜ ê°±ì‹  ê¸°íšŒ ì‹ë³„
        List<Account> userAccounts = [
            SELECT Id 
            FROM Account 
            WHERE OwnerId = :userId 
            LIMIT 3
        ];
        
        List<AgentforceSimpleAnalyticsService.AssetRenewalAnalysis> allOpportunities = 
            new List<AgentforceSimpleAnalyticsService.AssetRenewalAnalysis>();
        
        for (Account acc : userAccounts) {
            AgentforceSimpleAnalyticsService.RenewalOpportunityResult result = 
                AgentforceSimpleAnalyticsService.analyzeRenewalOpportunity(acc.Id);
            
            if (result.success) {
                allOpportunities.addAll(result.renewalOpportunities);
            }
        }
        
        return allOpportunities;
    }
    
    private static List<DailyRecommendation> generateDailyRecommendations(DailyAutomationResult dailyResult) {
        List<DailyRecommendation> recommendations = new List<DailyRecommendation>();
        
        // ê¸´ê¸‰ ì²˜ë¦¬ ì¶”ì²œ
        if (dailyResult.dailyBriefing != null && !dailyResult.dailyBriefing.urgentItems.isEmpty()) {
            DailyRecommendation urgent = new DailyRecommendation();
            urgent.type = 'URGENT';
            urgent.title = 'ê¸´ê¸‰ ì²˜ë¦¬ í•„ìš”';
            urgent.description = dailyResult.dailyBriefing.urgentItems.size() + 'ê±´ì˜ ê¸´ê¸‰ ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤.';
            urgent.priority = 'HIGH';
            recommendations.add(urgent);
        }
        
        // ê³ ìœ„í—˜ ê³ ê° ì¶”ì²œ
        for (AgentforceSimpleAnalyticsService.ChurnPredictionResult churn : dailyResult.churnRiskCustomers) {
            if (churn.riskLevel == 'HIGH') {
                DailyRecommendation churnRec = new DailyRecommendation();
                churnRec.type = 'CHURN_PREVENTION';
                churnRec.title = 'ê³ ìœ„í—˜ ê³ ê° ê´€ë¦¬';
                churnRec.description = churn.customerName + ' ê³ ê°ì˜ ì´íƒˆ ìœ„í—˜ë„ê°€ ë†’ìŠµë‹ˆë‹¤.';
                churnRec.priority = 'HIGH';
                recommendations.add(churnRec);
            }
        }
        
        return recommendations;
    }
    
    private static Account getCustomerBasicInfo(Id customerId) {
        return [
            SELECT Id, Name, Type, Industry, Phone, 
                   AnnualRevenue, NumberOfEmployees, CreatedDate, LastActivityDate
            FROM Account 
            WHERE Id = :customerId 
            LIMIT 1
        ];
    }
    
    private static List<Task> getRecentCustomerActivities(Id customerId) {
        return [
            SELECT Id, Subject, ActivityDate, Status, CreatedDate, Owner.Name
            FROM Task 
            WHERE WhatId = :customerId 
            ORDER BY CreatedDate DESC 
            LIMIT 10
        ];
    }
    
    // Response Formatting Methods
    
    private static String formatDailyBriefingResponse(AgentforceSalesAssistantService.DailyBriefingResult briefing) {
        String response = 'ğŸ“‹ **ì˜¤ëŠ˜ì˜ ì˜ì—… ë¸Œë¦¬í•‘**\n\n';
        
        response += 'ğŸ“… **ì˜¤ëŠ˜ ë¯¸íŒ… ì¼ì •** (' + briefing.todayMeetings.size() + 'ê±´)\n';
        for (Event meeting : briefing.todayMeetings) {
            response += 'â€¢ ' + meeting.StartDateTime.format('HH:mm') + ' - ' + meeting.Subject + '\n';
        }
        
        response += '\nğŸ”” **íŒ”ë¡œì—… í•„ìš” ê³ ê°** (' + briefing.followUpNeeded.size() + 'ê±´)\n';
        for (Account customer : briefing.followUpNeeded) {
            response += 'â€¢ ' + customer.Name + ' (ë§ˆì§€ë§‰ í™œë™: ' + customer.LastActivityDate?.format() + ')\n';
        }
        
        response += '\nâš ï¸ **ê¸´ê¸‰ ì²˜ë¦¬ ì‚¬í•­** (' + briefing.urgentItems.size() + 'ê±´)\n';
        for (Task urgent : briefing.urgentItems) {
            response += 'â€¢ ' + urgent.Subject + ' (ì˜ˆì •: ' + urgent.ActivityDate?.format() + ')\n';
        }
        
        return response;
    }
    
    private static String formatEmailResponse(AgentforceSimpleEmailActions.EmailResult emailResult) {
        return 'ğŸ“§ **ì œëª©**: ' + emailResult.emailSubject + '\n\n' +
               'ğŸ“ **ë³¸ë¬¸**:\n' + emailResult.emailBody + '\n\n' +
               'ğŸ“® **ìˆ˜ì‹ ì**: ' + emailResult.recipientEmail;
    }
    
    private static String formatChurnAnalysisResponse(AgentforceSimpleAnalyticsService.ChurnPredictionResult churnResult) {
        String response = 'ğŸ¯ **ê³ ê° ì´íƒˆ ìœ„í—˜ë„ ë¶„ì„**\n\n';
        response += 'ğŸ“Š **ìœ„í—˜ë„**: ' + churnResult.riskLevel + ' (' + churnResult.riskPercentage + '%)\n\n';
        
        if (!churnResult.riskFactors.isEmpty()) {
            response += 'âš ï¸ **ìœ„í—˜ ìš”ì†Œ**:\n';
            for (String factor : churnResult.riskFactors) {
                response += 'â€¢ ' + factor + '\n';
            }
        }
        
        if (!churnResult.recommendedActions.isEmpty()) {
            response += '\nğŸ’¡ **ì¶”ì²œ ì•¡ì…˜**:\n';
            for (String action : churnResult.recommendedActions) {
                response += 'â€¢ ' + action + '\n';
            }
        }
        
        return response;
    }
    
    private static String determineEmailType(String userMessage) {
        String message = userMessage.toLowerCase();
        
        if (message.contains('ì£¼ë¬¸') || message.contains('order')) {
            return 'order';
        } else if (message.contains('ê²°ì œ') || message.contains('payment')) {
            return 'payment';
        } else if (message.contains('ê°±ì‹ ') || message.contains('asset')) {
            return 'asset_renewal';
        } else {
            return 'general';
        }
    }
    
    // Wrapper Classes
    
    public class AgentforceRequest {
        @InvocableVariable(label='User ID' required=true)
        public String userId;
        
        @InvocableVariable(label='User Message' required=true)
        public String userMessage;
        
        @InvocableVariable(label='Record ID')
        public String recordId;
        
        @InvocableVariable(label='Additional Context')
        public String additionalContext;
    }
    
    public class AgentforceResponse {
        @InvocableVariable
        public Boolean success;
        
        @InvocableVariable
        public String responseType;
        
        @InvocableVariable
        public String title;
        
        @InvocableVariable
        public String content;
        
        @InvocableVariable
        public String errorMessage;
        
        @InvocableVariable
        public DateTime timestamp;
        
        public AgentforceResponse() {
            this.success = false;
            this.timestamp = System.now();
        }
    }
    
    public class DailyAutomationResult {
        @AuraEnabled public Boolean success { get; set; }
        @AuraEnabled public DateTime executionTime { get; set; }
        @AuraEnabled public AgentforceSalesAssistantService.DailyBriefingResult dailyBriefing { get; set; }
        @AuraEnabled public List<AgentforceSimpleAnalyticsService.ChurnPredictionResult> churnRiskCustomers { get; set; }
        @AuraEnabled public List<AgentforceSimpleAnalyticsService.AssetRenewalAnalysis> renewalOpportunities { get; set; }
        @AuraEnabled public List<DailyRecommendation> recommendedActions { get; set; }
        
        public DailyAutomationResult() {
            this.success = false;
            this.churnRiskCustomers = new List<AgentforceSimpleAnalyticsService.ChurnPredictionResult>();
            this.renewalOpportunities = new List<AgentforceSimpleAnalyticsService.AssetRenewalAnalysis>();
            this.recommendedActions = new List<DailyRecommendation>();
        }
    }
    
    public class DailyRecommendation {
        @AuraEnabled public String type { get; set; }
        @AuraEnabled public String title { get; set; }
        @AuraEnabled public String description { get; set; }
        @AuraEnabled public String priority { get; set; } // HIGH, MEDIUM, LOW
    }
    
    public class Customer360View {
        @AuraEnabled public Boolean success { get; set; }
        @AuraEnabled public Account customerInfo { get; set; }
        @AuraEnabled public AgentforceSimpleAnalyticsService.ChurnPredictionResult churnRisk { get; set; }
        @AuraEnabled public AgentforceSimpleAnalyticsService.ContactTimingRecommendation contactTiming { get; set; }
        @AuraEnabled public AgentforceSimpleAnalyticsService.RenewalOpportunityResult renewalAnalysis { get; set; }
        @AuraEnabled public List<Task> recentActivities { get; set; }
        
        public Customer360View() {
            this.success = false;
            this.recentActivities = new List<Task>();
        }
    }
}
