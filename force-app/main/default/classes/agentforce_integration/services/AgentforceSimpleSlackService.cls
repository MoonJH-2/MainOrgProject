/**
 * @description Agentforce Slack í†µí•© ì„œë¹„ìŠ¤ - ê°„ë‹¨í•œ ë²„ì „
 * @author AI Assistant
 * @created 2025-07-24
 */
public with sharing class AgentforceSimpleSlackService {
    
    /**
     * íŒ€ ì•Œë¦¼ ë°œì†¡ - ë‹¨ì¼ InvocableMethod
     */
    @InvocableMethod(label='Send Team Notification' description='íŒ€ì— ì•Œë¦¼ì„ ë°œì†¡í•©ë‹ˆë‹¤')
    public static List<SlackNotificationResult> sendTeamNotification(List<SlackNotificationRequest> requests) {
        List<SlackNotificationResult> results = new List<SlackNotificationResult>();
        
        for(SlackNotificationRequest request : requests) {
            SlackNotificationResult result = new SlackNotificationResult();
            
            try {
                switch on request.notificationType {
                    when 'ORDER_UPDATE' {
                        result = handleOrderNotification(request);
                    }
                    when 'PAYMENT_ALERT' {
                        result = handlePaymentNotification(request);
                    }
                    when 'GENERAL' {
                        result = handleGeneralNotification(request);
                    }
                    when else {
                        result = handleGeneralNotification(request);
                    }
                }
            } catch (Exception e) {
                result.success = false;
                result.errorMessage = e.getMessage();
            }
            
            results.add(result);
        }
        
        return results;
    }
    
    // Order ì•Œë¦¼ ì²˜ë¦¬
    private static SlackNotificationResult handleOrderNotification(SlackNotificationRequest request) {
        SlackNotificationResult result = new SlackNotificationResult();
        
        try {
            // Salesforce Chatterë¥¼ í™œìš©í•œ ë‚´ë¶€ ì•Œë¦¼
            FeedItem feedItem = new FeedItem();
            feedItem.ParentId = request.recordId;
            feedItem.Body = 'ğŸ“‹ ì£¼ë¬¸ ì—…ë°ì´íŠ¸ ì•Œë¦¼\n\n' + 
                           (String.isNotBlank(request.message) ? request.message : 'ì£¼ë¬¸ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
            feedItem.Type = 'TextPost';
            
            insert feedItem;
            
            result.success = true;
            result.notificationId = feedItem.Id;
            result.message = 'ì£¼ë¬¸ ì•Œë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.';
            
        } catch (Exception e) {
            result.success = false;
            result.errorMessage = 'ì£¼ë¬¸ ì•Œë¦¼ ë°œì†¡ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage();
        }
        
        return result;
    }
    
    // Payment ì•Œë¦¼ ì²˜ë¦¬
    private static SlackNotificationResult handlePaymentNotification(SlackNotificationRequest request) {
        SlackNotificationResult result = new SlackNotificationResult();
        
        try {
            // Chatter ì•Œë¦¼
            FeedItem feedItem = new FeedItem();
            feedItem.ParentId = request.recordId;
            feedItem.Body = 'ğŸ’° ê²°ì œ ìƒíƒœ ì•Œë¦¼\n\n' + 
                           (String.isNotBlank(request.message) ? request.message : 'ê²°ì œ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
            feedItem.Type = 'TextPost';
            
            insert feedItem;
            
            result.success = true;
            result.notificationId = feedItem.Id;
            result.message = 'ê²°ì œ ì•Œë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.';
            
        } catch (Exception e) {
            result.success = false;
            result.errorMessage = 'ê²°ì œ ì•Œë¦¼ ë°œì†¡ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage();
        }
        
        return result;
    }
    
    // ì¼ë°˜ ì•Œë¦¼ ì²˜ë¦¬
    private static SlackNotificationResult handleGeneralNotification(SlackNotificationRequest request) {
        SlackNotificationResult result = new SlackNotificationResult();
        
        try {
            // Chatter ì•Œë¦¼
            FeedItem feedItem = new FeedItem();
            feedItem.ParentId = String.isNotBlank(request.recordId) ? request.recordId : UserInfo.getUserId();
            feedItem.Body = 'ğŸ“¢ íŒ€ ì•Œë¦¼\n\n' + 
                           (String.isNotBlank(request.message) ? request.message : 'ìƒˆë¡œìš´ ì•Œë¦¼ì´ ìˆìŠµë‹ˆë‹¤.');
            feedItem.Type = 'TextPost';
            
            insert feedItem;
            
            result.success = true;
            result.notificationId = feedItem.Id;
            result.message = 'íŒ€ ì•Œë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.';
            
        } catch (Exception e) {
            result.success = false;
            result.errorMessage = 'íŒ€ ì•Œë¦¼ ë°œì†¡ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage();
        }
        
        return result;
    }
    
    // Wrapper Classes
    public class SlackNotificationRequest {
        @InvocableVariable(label='Record ID')
        public String recordId;
        
        @InvocableVariable(label='Notification Type' required=true)
        public String notificationType; // ORDER_UPDATE, PAYMENT_ALERT, GENERAL
        
        @InvocableVariable(label='Message' required=true)
        public String message;
        
        @InvocableVariable(label='Priority')
        public String priority; // HIGH, MEDIUM, LOW
    }
    
    public class SlackNotificationResult {
        @InvocableVariable
        public Boolean success;
        
        @InvocableVariable
        public String message;
        
        @InvocableVariable
        public String notificationId;
        
        @InvocableVariable
        public String errorMessage;
        
        public SlackNotificationResult() {
            this.success = false;
        }
    }
    
    // ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ í´ë˜ìŠ¤ë“¤
    public class SlackChannelRequest {
        @InvocableVariable
        public String orderId;
        @InvocableVariable
        public Boolean includeTeamMembers;
    }
    
    public class SlackChannelResult {
        @InvocableVariable
        public Boolean success;
        @InvocableVariable
        public String channelName;
        @InvocableVariable
        public String channelId;
        @InvocableVariable
        public String errorMessage;
    }
    
    public class PaymentNotificationRequest {
        @InvocableVariable
        public String paymentId;
        @InvocableVariable
        public String notificationType;
    }
    
    public class PaymentNotificationResult {
        @InvocableVariable
        public Boolean success;
        @InvocableVariable
        public String message;
        @InvocableVariable
        public String errorMessage;
    }
}
