/**
 * @description Agentforce Sales Assistant ë§ˆìŠ¤í„° ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ì„œë¹„ìŠ¤
 * ëª¨ë“  Phaseì˜ ê¸°ëŠ¥ì„ í†µí•©í•˜ê³  ì—°ê²°í•˜ëŠ” ì¤‘ì•™ ì œì–´ ì„œë¹„ìŠ¤
 * @author AI Assistant
 * @created 2025-07-24
 */
public with sharing class AgentforceMasterOrchestrationService {
    
    /**
     * Agentforce Agentê°€ í˜¸ì¶œí•˜ëŠ” ë©”ì¸ ì—”íŠ¸ë¦¬í¬ì¸íŠ¸
     * ì‚¬ìš©ì ìš”ì²­ì„ ë¶„ì„í•˜ê³  ì ì ˆí•œ ì„œë¹„ìŠ¤ë¡œ ë¼ìš°íŒ…
     */
    @InvocableMethod(label='Process Agentforce Request' description='Agentforce ìš”ì²­ì„ ë¶„ì„í•˜ê³  ì²˜ë¦¬í•˜ëŠ” ë§ˆìŠ¤í„° ì„œë¹„ìŠ¤')
    public static List<AgentforceResponse> processAgentforceRequest(List<AgentforceRequest> requests) {
        List<AgentforceResponse> responses = new List<AgentforceResponse>();
        
        for (AgentforceRequest request : requests) {
            try {
                AgentforceResponse response = routeAndProcessRequest(request);
                responses.add(response);
            } catch (Exception e) {
                AgentforceResponse errorResponse = new AgentforceResponse();
                errorResponse.success = false;
                errorResponse.errorMessage = e.getMessage();
                errorResponse.responseType = 'ERROR';
                responses.add(errorResponse);
            }
        }
        
        return responses;
    }
    
    /**
     * ì™„ì „ ìë™í™”ëœ Order Lifecycle ê´€ë¦¬
     */
    @InvocableMethod(label='Manage Order Lifecycle' description='Order ì „ì²´ ë¼ì´í”„ì‚¬ì´í´ ìë™ ê´€ë¦¬')
    public static List<OrderLifecycleResult> manageOrderLifecycle(List<OrderLifecycleRequest> requests) {
        List<OrderLifecycleResult> results = new List<OrderLifecycleResult>();
        
        for (OrderLifecycleRequest request : requests) {
            try {
                OrderLifecycleResult result = processOrderLifecycle(request);
                results.add(result);
            } catch (Exception e) {
                OrderLifecycleResult errorResult = new OrderLifecycleResult();
                errorResult.success = false;
                errorResult.errorMessage = e.getMessage();
                results.add(errorResult);
            }
        }
        
        return results;
    }
    
    /**
     * ì¼ì¼ ì˜ì—… í™œë™ ì™„ì „ ìë™í™”
     */
    @AuraEnabled
    public static DailyAutomationResult executeDailyAutomation(Id userId) {
        try {
            DailyAutomationResult result = new DailyAutomationResult();
            
            // 1. ì¼ì¼ ë¸Œë¦¬í•‘ ìƒì„± (Phase 1)
            AgentforceSalesAssistantService.DailyBriefingResult briefing = 
                AgentforceSalesAssistantService.getDailyBriefing(userId);
            result.dailyBriefing = briefing;
            
            // 2. ì‹¤ì‹œê°„ ì˜ì—… ì¸ì‚¬ì´íŠ¸ (Phase 3)
            AgentforceAdvancedAnalyticsService.SalesInsightResult insights = 
                AgentforceAdvancedAnalyticsService.getRealTimeSalesInsights(userId);
            result.salesInsights = insights;
            
            // 3. ê¸´ê¸‰ ì²˜ë¦¬ í•„ìš” ê³ ê° ë¶„ì„ (Phase 3)
            result.churnRiskCustomers = analyzeHighRiskCustomers(userId);
            
            // 4. ê°±ì‹  ê¸°íšŒ ì‹ë³„ (Phase 3)
            result.renewalOpportunities = identifyRenewalOpportunities(userId);
            
            // 5. ì¶”ì²œ ì•¡ì…˜ ìƒì„±
            result.recommendedActions = generateDailyRecommendations(result);
            
            // 6. Slack ì•Œë¦¼ ë°œì†¡ (Phase 2)
            if (result.recommendedActions.size() > 0) {
                sendDailySummaryToSlack(userId, result);
            }
            
            result.success = true;
            result.executionTime = System.now();
            
            return result;
            
        } catch (Exception e) {
            throw new AuraHandledException('ì¼ì¼ ìë™í™” ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    /**
     * ê³ ê°ë³„ 360ë„ ë·° ì œê³µ
     */
    @AuraEnabled(cacheable=true)
    public static Customer360View getCustomer360View(Id customerId) {
        try {
            Customer360View result = new Customer360View();
            
            // 1. ê¸°ë³¸ ê³ ê° ì •ë³´
            result.customerInfo = getCustomerBasicInfo(customerId);
            
            // 2. ì´íƒˆ ìœ„í—˜ë„ ë¶„ì„ (Phase 3)
            AgentforceAdvancedAnalyticsService.ChurnPredictionRequest churnRequest = 
                new AgentforceAdvancedAnalyticsService.ChurnPredictionRequest();
            churnRequest.customerId = customerId;
            
            List<AgentforceAdvancedAnalyticsService.ChurnPredictionRequest> churnRequests = 
                new List<AgentforceAdvancedAnalyticsService.ChurnPredictionRequest>{churnRequest};
            
            List<AgentforceAdvancedAnalyticsService.ChurnPredictionResult> churnResults = 
                AgentforceAdvancedAnalyticsService.predictCustomerChurnRisk(churnRequests);
            
            result.churnRisk = churnResults[0];
            
            // 3. ìµœì  ì—°ë½ ì‹œì  (Phase 3)
            result.contactTiming = AgentforceAdvancedAnalyticsService.getOptimalContactTiming(customerId);
            
            // 4. ê°±ì‹  ê¸°íšŒ ë¶„ì„ (Phase 3)
            result.renewalAnalysis = AgentforceAdvancedAnalyticsService.analyzeRenewalOpportunity(customerId);
            
            // 5. ìµœê·¼ ì´ë©”ì¼ ë¶„ì„ (Phase 1)
            result.emailRecommendations = getEmailRecommendations(customerId);
            
            // 6. ìµœê·¼ í™œë™ ì´ë ¥
            result.recentActivities = getRecentCustomerActivities(customerId);
            
            // 7. ROI ë¶„ì„ (ê¸°ì¡´ AssetROIAnalysisService ì—°ë™)
            result.roiAnalysis = getCustomerROIAnalysis(customerId);
            
            result.success = true;
            return result;
            
        } catch (Exception e) {
            throw new AuraHandledException('ê³ ê° 360ë„ ë·° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
    
    // Private Helper Methods
    
    private static AgentforceResponse routeAndProcessRequest(AgentforceRequest request) {
        AgentforceResponse response = new AgentforceResponse();
        
        // Intent ë¶„ì„ ë° ë¼ìš°íŒ…
        String intent = analyzeUserIntent(request.userMessage);
        
        switch on intent {
            when 'DAILY_BRIEFING' {
                response = handleDailyBriefingRequest(request);
            }
            when 'EMAIL_GENERATION' {
                response = handleEmailGenerationRequest(request);
            }
            when 'CUSTOMER_ANALYSIS' {
                response = handleCustomerAnalysisRequest(request);
            }
            when 'SLACK_NOTIFICATION' {
                response = handleSlackNotificationRequest(request);
            }
            when 'MEETING_FOLLOWUP' {
                response = handleMeetingFollowupRequest(request);
            }
            when 'RENEWAL_ANALYSIS' {
                response = handleRenewalAnalysisRequest(request);
            }
            when else {
                response = handleGeneralRequest(request);
            }
        }
        
        // ì‘ë‹µ ë¡œê¹…
        logAgentforceInteraction(request, response);
        
        return response;
    }
    
    private static String analyzeUserIntent(String userMessage) {
        String message = userMessage.toLowerCase();
        
        if (message.contains('ì˜¤ëŠ˜') && (message.contains('í• ì¼') || message.contains('ë¸Œë¦¬í•‘'))) {
            return 'DAILY_BRIEFING';
        } else if (message.contains('ì´ë©”ì¼') && (message.contains('ë³´ë‚´') || message.contains('ì‘ì„±'))) {
            return 'EMAIL_GENERATION';
        } else if (message.contains('ê³ ê°') && (message.contains('ë¶„ì„') || message.contains('ìœ„í—˜'))) {
            return 'CUSTOMER_ANALYSIS';
        } else if (message.contains('íŒ€') && (message.contains('ì•Œë¦¼') || message.contains('ê³µìœ '))) {
            return 'SLACK_NOTIFICATION';
        } else if (message.contains('ë¯¸íŒ…') && message.contains('í›„')) {
            return 'MEETING_FOLLOWUP';
        } else if (message.contains('ê°±ì‹ ') || message.contains('renewal')) {
            return 'RENEWAL_ANALYSIS';
        } else {
            return 'GENERAL';
        }
    }
    
    private static AgentforceResponse handleDailyBriefingRequest(AgentforceRequest request) {
        AgentforceResponse response = new AgentforceResponse();
        
        // Phase 1 ì„œë¹„ìŠ¤ í˜¸ì¶œ
        AgentforceSalesAssistantService.DailyBriefingResult briefing = 
            AgentforceSalesAssistantService.getDailyBriefing(request.userId);
        
        // ì‘ë‹µ êµ¬ì„±
        response.responseType = 'DAILY_BRIEFING';
        response.title = 'ì˜¤ëŠ˜ì˜ ì˜ì—… ë¸Œë¦¬í•‘';
        response.content = formatDailyBriefingResponse(briefing);
        response.success = true;
        
        return response;
    }
    
    private static AgentforceResponse handleEmailGenerationRequest(AgentforceRequest request) {
        AgentforceResponse response = new AgentforceResponse();
        
        // Phase 1 ì´ë©”ì¼ í†µí•© ì„œë¹„ìŠ¤ í˜¸ì¶œ
        AgentforceEmailIntegrationService.EmailGenerationRequest emailRequest = 
            new AgentforceEmailIntegrationService.EmailGenerationRequest();
        emailRequest.recordId = request.recordId;
        emailRequest.emailType = determineEmailType(request.userMessage);
        emailRequest.agentforceRecommendations = request.additionalContext;
        
        List<AgentforceEmailIntegrationService.EmailGenerationRequest> emailRequests = 
            new List<AgentforceEmailIntegrationService.EmailGenerationRequest>{emailRequest};
        
        List<AgentforceEmailIntegrationService.EmailGenerationResult> emailResults = 
            AgentforceEmailIntegrationService.generateSmartEmail(emailRequests);
        
        response.responseType = 'EMAIL_DRAFT';
        response.title = 'ì´ë©”ì¼ ì´ˆì•ˆì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤';
        response.content = formatEmailResponse(emailResults[0]);
        response.success = emailResults[0].success;
        
        return response;
    }
    
    private static AgentforceResponse handleCustomerAnalysisRequest(AgentforceRequest request) {
        AgentforceResponse response = new AgentforceResponse();
        
        // Phase 3 ê³ ê¸‰ ë¶„ì„ ì„œë¹„ìŠ¤ í˜¸ì¶œ
        AgentforceAdvancedAnalyticsService.ChurnPredictionRequest churnRequest = 
            new AgentforceAdvancedAnalyticsService.ChurnPredictionRequest();
        churnRequest.customerId = request.recordId;
        
        List<AgentforceAdvancedAnalyticsService.ChurnPredictionRequest> churnRequests = 
            new List<AgentforceAdvancedAnalyticsService.ChurnPredictionRequest>{churnRequest};
        
        List<AgentforceAdvancedAnalyticsService.ChurnPredictionResult> churnResults = 
            AgentforceAdvancedAnalyticsService.predictCustomerChurnRisk(churnRequests);
        
        response.responseType = 'CUSTOMER_ANALYSIS';
        response.title = 'ê³ ê° ì´íƒˆ ìœ„í—˜ë„ ë¶„ì„';
        response.content = formatChurnAnalysisResponse(churnResults[0]);
        response.success = churnResults[0].success;
        
        return response;
    }
    
    private static AgentforceResponse handleSlackNotificationRequest(AgentforceRequest request) {
        AgentforceResponse response = new AgentforceResponse();
        
        // Phase 2 Slack í†µí•© ì„œë¹„ìŠ¤ í˜¸ì¶œ
        AgentforceSlackIntegrationService.SlackNotificationResult slackResult = 
            AgentforceSlackIntegrationService.notifyTeamActivity(
                request.recordId, 
                'GENERAL', 
                request.additionalContext
            );
        
        response.responseType = 'SLACK_NOTIFICATION';
        response.title = 'Slack ì•Œë¦¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤';
        response.content = slackResult.success ? 
            'íŒ€ ì±„ë„ì— ì•Œë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.' : 
            'ì•Œë¦¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + slackResult.errorMessage;
        response.success = slackResult.success;
        
        return response;
    }
    
    private static AgentforceResponse handleMeetingFollowupRequest(AgentforceRequest request) {
        AgentforceResponse response = new AgentforceResponse();
        
        // Phase 1 ë¯¸íŒ… í›„ì† ì²˜ë¦¬ ì„œë¹„ìŠ¤ í˜¸ì¶œ
        AgentforceSalesAssistantService.PostMeetingRequest meetingRequest = 
            new AgentforceSalesAssistantService.PostMeetingRequest();
        meetingRequest.customerId = request.recordId;
        meetingRequest.customerName = extractCustomerName(request.additionalContext);
        meetingRequest.meetingNotes = request.additionalContext;
        meetingRequest.needsProposal = request.additionalContext.contains('ì œì•ˆì„œ');
        meetingRequest.followUpDays = extractFollowUpDays(request.additionalContext);
        
        AgentforceSalesAssistantService.PostMeetingResult meetingResult = 
            AgentforceSalesAssistantService.processMeetingFollowUp(
                new List<AgentforceSalesAssistantService.PostMeetingRequest>{meetingRequest}
            )[0];
        
        response.responseType = 'MEETING_FOLLOWUP';
        response.title = 'ë¯¸íŒ… í›„ì† ì²˜ë¦¬ ì™„ë£Œ';
        response.content = formatMeetingFollowupResponse(meetingResult);
        response.success = meetingResult.success;
        
        return response;
    }
    
    private static AgentforceResponse handleRenewalAnalysisRequest(AgentforceRequest request) {
        AgentforceResponse response = new AgentforceResponse();
        
        // Phase 3 ê°±ì‹  ë¶„ì„ ì„œë¹„ìŠ¤ í˜¸ì¶œ
        AgentforceAdvancedAnalyticsService.RenewalOpportunityResult renewalResult = 
            AgentforceAdvancedAnalyticsService.analyzeRenewalOpportunity(request.recordId);
        
        response.responseType = 'RENEWAL_ANALYSIS';
        response.title = 'ê°±ì‹  ê¸°íšŒ ë¶„ì„';
        response.content = formatRenewalAnalysisResponse(renewalResult);
        response.success = renewalResult.success;
        
        return response;
    }
    
    private static AgentforceResponse handleGeneralRequest(AgentforceRequest request) {
        AgentforceResponse response = new AgentforceResponse();
        
        response.responseType = 'GENERAL';
        response.title = 'SOCAR Sales Assistant';
        response.content = 'ì•ˆë…•í•˜ì„¸ìš”! ì–´ë–¤ ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?\n\n' +
            'ë‹¤ìŒê³¼ ê°™ì€ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:\n' +
            'â€¢ "ì˜¤ëŠ˜ í•  ì¼ ì •ë¦¬í•´ì¤˜" - ì¼ì¼ ë¸Œë¦¬í•‘\n' +
            'â€¢ "ê³ ê°ì—ê²Œ ì´ë©”ì¼ ë³´ë‚´ì¤˜" - ì´ë©”ì¼ ì‘ì„±\n' +
            'â€¢ "ê³ ê° ì´íƒˆ ìœ„í—˜ë„ ë¶„ì„í•´ì¤˜" - ê³ ê° ë¶„ì„\n' +
            'â€¢ "íŒ€ì— ì•Œë¦¼ ë³´ë‚´ì¤˜" - Slack ì•Œë¦¼\n' +
            'â€¢ "ë¯¸íŒ… í›„ì† ì²˜ë¦¬í•´ì¤˜" - ë¯¸íŒ… ê´€ë¦¬\n' +
            'â€¢ "ê°±ì‹  ê¸°íšŒ ë¶„ì„í•´ì¤˜" - ê°±ì‹  ë¶„ì„';
        response.success = true;
        
        return response;
    }
    
    private static OrderLifecycleResult processOrderLifecycle(OrderLifecycleRequest request) {
        OrderLifecycleResult result = new OrderLifecycleResult();
        
        // 1. Order ì •ë³´ ì¡°íšŒ
        Order orderInfo = [SELECT Id, OrderNumber, Status, AccountId FROM Order WHERE Id = :request.orderId LIMIT 1];
        
        switch on request.lifecycleEvent {
            when 'ORDER_ACTIVATED' {
                result = handleOrderActivation(orderInfo);
            }
            when 'PAYMENT_COMPLETED' {
                result = handlePaymentCompletion(orderInfo, request.paymentId);
            }
            when 'PAYMENT_OVERDUE' {
                result = handlePaymentOverdue(orderInfo, request.paymentId);
            }
            when 'ORDER_COMPLETED' {
                result = handleOrderCompletion(orderInfo);
            }
            when else {
                result.success = false;
                result.errorMessage = 'ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¼ì´í”„ì‚¬ì´í´ ì´ë²¤íŠ¸ì…ë‹ˆë‹¤.';
            }
        }
        
        return result;
    }
    
    private static OrderLifecycleResult handleOrderActivation(Order orderInfo) {
        OrderLifecycleResult result = new OrderLifecycleResult();
        List<String> completedActions = new List<String>();
        
        try {
            // 1. Slack ì±„ë„ ìƒì„± (Phase 2)
            AgentforceSlackIntegrationService.SlackChannelRequest channelRequest = 
                new AgentforceSlackIntegrationService.SlackChannelRequest();
            channelRequest.orderId = orderInfo.Id;
            channelRequest.includeTeamMembers = true;
            
            List<AgentforceSlackIntegrationService.SlackChannelResult> channelResults = 
                AgentforceSlackIntegrationService.createOrderSlackChannel(
                    new List<AgentforceSlackIntegrationService.SlackChannelRequest>{channelRequest}
                );
            
            if (channelResults[0].success) {
                completedActions.add('Slack ì±„ë„ ìƒì„±: ' + channelResults[0].channelName);
            }
            
            // 2. ì´ˆê¸° í™˜ì˜ ì´ë©”ì¼ ìƒì„± (Phase 1)
            AgentforceEmailIntegrationService.EmailGenerationRequest emailRequest = 
                new AgentforceEmailIntegrationService.EmailGenerationRequest();
            emailRequest.recordId = orderInfo.Id;
            emailRequest.emailType = 'order';
            emailRequest.subType = 'Order_Confirmation';
            
            List<AgentforceEmailIntegrationService.EmailGenerationResult> emailResults = 
                AgentforceEmailIntegrationService.generateSmartEmail(
                    new List<AgentforceEmailIntegrationService.EmailGenerationRequest>{emailRequest}
                );
            
            if (emailResults[0].success) {
                completedActions.add('í™˜ì˜ ì´ë©”ì¼ ìƒì„± ì™„ë£Œ');
            }
            
            // 3. ì´ˆê¸° Task ìƒì„±
            createInitialOrderTasks(orderInfo.Id);
            completedActions.add('ì´ˆê¸° Task ìƒì„± ì™„ë£Œ');
            
            result.success = true;
            result.completedActions = completedActions;
            result.message = 'Order ' + orderInfo.OrderNumber + ' í™œì„±í™” ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            
        } catch (Exception e) {
            result.success = false;
            result.errorMessage = e.getMessage();
        }
        
        return result;
    }
    
    private static OrderLifecycleResult handlePaymentCompletion(Order orderInfo, String paymentId) {
        OrderLifecycleResult result = new OrderLifecycleResult();
        List<String> completedActions = new List<String>();
        
        try {
            // 1. Slack ì•Œë¦¼ ë°œì†¡ (Phase 2)
            AgentforceSlackIntegrationService.PaymentNotificationRequest notificationRequest = 
                new AgentforceSlackIntegrationService.PaymentNotificationRequest();
            notificationRequest.paymentId = paymentId;
            notificationRequest.notificationType = 'PAYMENT_COMPLETED';
            
            List<AgentforceSlackIntegrationService.PaymentNotificationResult> notificationResults = 
                AgentforceSlackIntegrationService.sendPaymentNotification(
                    new List<AgentforceSlackIntegrationService.PaymentNotificationRequest>{notificationRequest}
                );
            
            if (notificationResults[0].success) {
                completedActions.add('Slack ê²°ì œ ì™„ë£Œ ì•Œë¦¼ ë°œì†¡');
            }
            
            // 2. ë‹¤ìŒ ê²°ì œ ì•ˆë‚´ ì´ë©”ì¼ ì˜ˆì•½
            createNextPaymentReminderTask(orderInfo.Id, paymentId);
            completedActions.add('ë‹¤ìŒ ê²°ì œ ì•ˆë‚´ Task ìƒì„±');
            
            // 3. ì™„ë‚© ì—¬ë¶€ í™•ì¸ ë° Asset ìƒì„± ì²´í¬
            if (isOrderFullyPaid(orderInfo.Id)) {
                completedActions.add('ì™„ë‚© ê°ì§€ - Asset ìƒì„± í”„ë¡œì„¸ìŠ¤ ì‹œì‘');
            }
            
            result.success = true;
            result.completedActions = completedActions;
            result.message = 'Payment ì™„ë£Œ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            
        } catch (Exception e) {
            result.success = false;
            result.errorMessage = e.getMessage();
        }
        
        return result;
    }
    
    private static OrderLifecycleResult handlePaymentOverdue(Order orderInfo, String paymentId) {
        OrderLifecycleResult result = new OrderLifecycleResult();
        List<String> completedActions = new List<String>();
        
        try {
            // 1. ê¸´ê¸‰ Slack ì•Œë¦¼ (Phase 2)
            AgentforceSlackIntegrationService.PaymentNotificationRequest notificationRequest = 
                new AgentforceSlackIntegrationService.PaymentNotificationRequest();
            notificationRequest.paymentId = paymentId;
            notificationRequest.notificationType = 'PAYMENT_OVERDUE';
            
            List<AgentforceSlackIntegrationService.PaymentNotificationResult> notificationResults = 
                AgentforceSlackIntegrationService.sendPaymentNotification(
                    new List<AgentforceSlackIntegrationService.PaymentNotificationRequest>{notificationRequest}
                );
            
            if (notificationResults[0].success) {
                completedActions.add('ê¸´ê¸‰ ì—°ì²´ ì•Œë¦¼ ë°œì†¡');
            }
            
            // 2. ì—°ì²´ ì²˜ë¦¬ Task ìƒì„±
            createOverdueHandlingTask(orderInfo.Id, paymentId);
            completedActions.add('ì—°ì²´ ì²˜ë¦¬ Task ìƒì„±');
            
            // 3. ê³ ê° ì´íƒˆ ìœ„í—˜ë„ ì¬ê³„ì‚° (Phase 3)
            AgentforceAdvancedAnalyticsService.ChurnPredictionRequest churnRequest = 
                new AgentforceAdvancedAnalyticsService.ChurnPredictionRequest();
            churnRequest.customerId = orderInfo.AccountId;
            
            List<AgentforceAdvancedAnalyticsService.ChurnPredictionResult> churnResults = 
                AgentforceAdvancedAnalyticsService.predictCustomerChurnRisk(
                    new List<AgentforceAdvancedAnalyticsService.ChurnPredictionRequest>{churnRequest}
                );
            
            if (churnResults[0].success) {
                completedActions.add('ê³ ê° ì´íƒˆ ìœ„í—˜ë„ ì¬ê³„ì‚° ì™„ë£Œ: ' + churnResults[0].riskLevel);
            }
            
            result.success = true;
            result.completedActions = completedActions;
            result.message = 'Payment ì—°ì²´ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            
        } catch (Exception e) {
            result.success = false;
            result.errorMessage = e.getMessage();
        }
        
        return result;
    }
    
    private static OrderLifecycleResult handleOrderCompletion(Order orderInfo) {
        OrderLifecycleResult result = new OrderLifecycleResult();
        List<String> completedActions = new List<String>();
        
        try {
            // 1. ì™„ë£Œ ì¶•í•˜ ë©”ì‹œì§€ ë°œì†¡
            completedActions.add('Order ì™„ë£Œ ì¶•í•˜ ë©”ì‹œì§€ ì¤€ë¹„');
            
            // 2. ê°±ì‹  ê¸°íšŒ ë¶„ì„ ì‹œì‘ (Phase 3)
            AgentforceAdvancedAnalyticsService.RenewalOpportunityResult renewalResult = 
                AgentforceAdvancedAnalyticsService.analyzeRenewalOpportunity(orderInfo.AccountId);
            
            if (renewalResult.success) {
                completedActions.add('ê°±ì‹  ê¸°íšŒ ë¶„ì„ ì™„ë£Œ');
            }
            
            // 3. ê³ ê° ë§Œì¡±ë„ ì¡°ì‚¬ Task ìƒì„±
            createCustomerSatisfactionTask(orderInfo.Id);
            completedActions.add('ê³ ê° ë§Œì¡±ë„ ì¡°ì‚¬ Task ìƒì„±');
            
            result.success = true;
            result.completedActions = completedActions;
            result.message = 'Order ì™„ë£Œ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            
        } catch (Exception e) {
            result.success = false;
            result.errorMessage = e.getMessage();
        }
        
        return result;
    }
    
    // Additional Helper Methods
    
    private static String formatDailyBriefingResponse(AgentforceSalesAssistantService.DailyBriefingResult briefing) {
        String response = 'ğŸ“‹ **ì˜¤ëŠ˜ì˜ ì˜ì—… ë¸Œë¦¬í•‘**\n\n';
        
        response += 'ğŸ“… **ì˜¤ëŠ˜ ë¯¸íŒ… ì¼ì •** (' + briefing.todayMeetings.size() + 'ê±´)\n';
        for (Event meeting : briefing.todayMeetings) {
            response += 'â€¢ ' + meeting.StartDateTime.format('HH:mm') + ' - ' + meeting.Subject + '\n';
        }
        
        response += '\nğŸ”” **íŒ”ë¡œì—… í•„ìš” ê³ ê°** (' + briefing.followUpNeeded.size() + 'ê±´)\n';
        for (Account customer : briefing.followUpNeeded) {
            response += 'â€¢ ' + customer.Name + ' (ë§ˆì§€ë§‰ í™œë™: ' + customer.LastActivityDate?.format() + ')\n';
        }
        
        response += '\nâš ï¸ **ê¸´ê¸‰ ì²˜ë¦¬ ì‚¬í•­** (' + briefing.urgentItems.size() + 'ê±´)\n';
        for (Task urgent : briefing.urgentItems) {
            response += 'â€¢ ' + urgent.Subject + ' (ì˜ˆì •: ' + urgent.ActivityDate?.format() + ')\n';
        }
        
        return response;
    }
    
    private static String formatEmailResponse(AgentforceEmailIntegrationService.EmailGenerationResult emailResult) {
        return 'ğŸ“§ **ì œëª©**: ' + emailResult.emailSubject + '\n\n' +
               'ğŸ“ **ë³¸ë¬¸**:\n' + emailResult.emailBody + '\n\n' +
               'ğŸ“® **ìˆ˜ì‹ ì**: ' + emailResult.recipientEmail;
    }
    
    private static String formatChurnAnalysisResponse(AgentforceAdvancedAnalyticsService.ChurnPredictionResult churnResult) {
        String response = 'ğŸ¯ **ê³ ê° ì´íƒˆ ìœ„í—˜ë„ ë¶„ì„**\n\n';
        response += 'ğŸ“Š **ìœ„í—˜ë„**: ' + churnResult.riskLevel + ' (' + churnResult.riskPercentage + '%)\n\n';
        
        if (!churnResult.riskFactors.isEmpty()) {
            response += 'âš ï¸ **ìœ„í—˜ ìš”ì†Œ**:\n';
            for (String factor : churnResult.riskFactors) {
                response += 'â€¢ ' + factor + '\n';
            }
        }
        
        if (!churnResult.recommendedActions.isEmpty()) {
            response += '\nğŸ’¡ **ì¶”ì²œ ì•¡ì…˜**:\n';
            for (String action : churnResult.recommendedActions) {
                response += 'â€¢ ' + action + '\n';
            }
        }
        
        return response;
    }
    
    private static String formatMeetingFollowupResponse(AgentforceSalesAssistantService.PostMeetingResult meetingResult) {
        String response = 'ğŸ¤ **ë¯¸íŒ… í›„ì† ì²˜ë¦¬ ì™„ë£Œ**\n\n';
        response += 'ğŸ“ ì½œ ë¡œê·¸ ìƒì„±: ' + meetingResult.callLogId + '\n';
        
        if (!meetingResult.followUpTaskIds.isEmpty()) {
            response += 'âœ… í›„ì† Task ìƒì„±: ' + meetingResult.followUpTaskIds.size() + 'ê±´\n';
        }
        
        return response;
    }
    
    private static String formatRenewalAnalysisResponse(AgentforceAdvancedAnalyticsService.RenewalOpportunityResult renewalResult) {
        String response = 'ğŸ”„ **ê°±ì‹  ê¸°íšŒ ë¶„ì„**\n\n';
        response += 'ğŸ“ˆ **ì „ì²´ ì „ëµ**: ' + renewalResult.overallRenewalStrategy + '\n\n';
        
        if (!renewalResult.renewalOpportunities.isEmpty()) {
            response += 'ğŸ¯ **ê°±ì‹  ê¸°íšŒ** (' + renewalResult.renewalOpportunities.size() + 'ê±´):\n';
            for (AgentforceAdvancedAnalyticsService.AssetRenewalAnalysis opp : renewalResult.renewalOpportunities) {
                response += 'â€¢ ' + opp.assetName + ' (' + opp.renewalProbability + '% í™•ë¥ , ' + 
                           opp.urgencyLevel + ' ìš°ì„ ìˆœìœ„)\n';
            }
        }
        
        return response;
    }
    
    private static String determineEmailType(String userMessage) {
        String message = userMessage.toLowerCase();
        
        if (message.contains('ì£¼ë¬¸') || message.contains('order')) {
            return 'order';
        } else if (message.contains('ê²°ì œ') || message.contains('payment')) {
            return 'payment';
        } else if (message.contains('ê°±ì‹ ') || message.contains('asset')) {
            return 'asset_renewal';
        } else {
            return 'general';
        }
    }
    
    private static String extractCustomerName(String context) {
        // ê°„ë‹¨í•œ ê³ ê°ëª… ì¶”ì¶œ ë¡œì§ (ì‹¤ì œë¡œëŠ” ë” ì •êµí•œ NLP í•„ìš”)
        if (String.isNotBlank(context) && context.contains('ê³ ê°')) {
            return context.substringBefore(' ').substringAfter('ê³ ê°');
        }
        return 'ê³ ê°';
    }
    
    private static Integer extractFollowUpDays(String context) {
        // í›„ì† ì—°ë½ ì¼ìˆ˜ ì¶”ì¶œ ë¡œì§
        if (context.contains('ë‹¤ìŒì£¼')) {
            return 7;
        } else if (context.contains('ë‚´ì¼')) {
            return 1;
        } else {
            return 3; // ê¸°ë³¸ê°’
        }
    }
    
    private static void logAgentforceInteraction(AgentforceRequest request, AgentforceResponse response) {
        // ìƒí˜¸ì‘ìš© ë¡œê¹… (í–¥í›„ ML í•™ìŠµ ë°ì´í„°ë¡œ í™œìš©)
        System.debug('Agentforce Interaction - User: ' + request.userMessage + 
                     ', Response Type: ' + response.responseType + 
                     ', Success: ' + response.success);
    }
    
    private static List<AgentforceAdvancedAnalyticsService.ChurnPredictionResult> analyzeHighRiskCustomers(Id userId) {
        // ì˜ì—…ë‹´ë‹¹ìì˜ ê³ ìœ„í—˜ ê³ ê° ë¶„ì„
        List<Account> userAccounts = [
            SELECT Id 
            FROM Account 
            WHERE OwnerId = :userId 
            AND LastActivityDate < LAST_N_DAYS:30
            LIMIT 5
        ];
        
        List<AgentforceAdvancedAnalyticsService.ChurnPredictionRequest> churnRequests = 
            new List<AgentforceAdvancedAnalyticsService.ChurnPredictionRequest>();
        
        for (Account acc : userAccounts) {
            AgentforceAdvancedAnalyticsService.ChurnPredictionRequest req = 
                new AgentforceAdvancedAnalyticsService.ChurnPredictionRequest();
            req.customerId = acc.Id;
            churnRequests.add(req);
        }
        
        return churnRequests.isEmpty() ? 
            new List<AgentforceAdvancedAnalyticsService.ChurnPredictionResult>() :
            AgentforceAdvancedAnalyticsService.predictCustomerChurnRisk(churnRequests);
    }
    
    private static List<AgentforceAdvancedAnalyticsService.AssetRenewalAnalysis> identifyRenewalOpportunities(Id userId) {
        // ì˜ì—…ë‹´ë‹¹ìì˜ ê°±ì‹  ê¸°íšŒ ì‹ë³„
        List<Account> userAccounts = [
            SELECT Id 
            FROM Account 
            WHERE OwnerId = :userId 
            LIMIT 3
        ];
        
        List<AgentforceAdvancedAnalyticsService.AssetRenewalAnalysis> allOpportunities = 
            new List<AgentforceAdvancedAnalyticsService.AssetRenewalAnalysis>();
        
        for (Account acc : userAccounts) {
            AgentforceAdvancedAnalyticsService.RenewalOpportunityResult result = 
                AgentforceAdvancedAnalyticsService.analyzeRenewalOpportunity(acc.Id);
            
            if (result.success) {
                allOpportunities.addAll(result.renewalOpportunities);
            }
        }
        
        return allOpportunities;
    }
    
    private static List<DailyRecommendation> generateDailyRecommendations(DailyAutomationResult dailyResult) {
        List<DailyRecommendation> recommendations = new List<DailyRecommendation>();
        
        // ê¸´ê¸‰ ì²˜ë¦¬ ì¶”ì²œ
        if (!dailyResult.dailyBriefing.urgentItems.isEmpty()) {
            DailyRecommendation urgent = new DailyRecommendation();
            urgent.type = 'URGENT';
            urgent.title = 'ê¸´ê¸‰ ì²˜ë¦¬ í•„ìš”';
            urgent.description = dailyResult.dailyBriefing.urgentItems.size() + 'ê±´ì˜ ê¸´ê¸‰ ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤.';
            urgent.priority = 'HIGH';
            recommendations.add(urgent);
        }
        
        // ê³ ìœ„í—˜ ê³ ê° ì¶”ì²œ
        for (AgentforceAdvancedAnalyticsService.ChurnPredictionResult churn : dailyResult.churnRiskCustomers) {
            if (churn.riskLevel == 'HIGH') {
                DailyRecommendation churnRec = new DailyRecommendation();
                churnRec.type = 'CHURN_PREVENTION';
                churnRec.title = 'ê³ ìœ„í—˜ ê³ ê° ê´€ë¦¬';
                churnRec.description = churn.customerName + ' ê³ ê°ì˜ ì´íƒˆ ìœ„í—˜ë„ê°€ ë†’ìŠµë‹ˆë‹¤.';
                churnRec.priority = 'HIGH';
                recommendations.add(churnRec);
            }
        }
        
        // ê°±ì‹  ê¸°íšŒ ì¶”ì²œ
        for (AgentforceAdvancedAnalyticsService.AssetRenewalAnalysis renewal : dailyResult.renewalOpportunities) {
            if (renewal.urgencyLevel == 'HIGH') {
                DailyRecommendation renewalRec = new DailyRecommendation();
                renewalRec.type = 'RENEWAL_OPPORTUNITY';
                renewalRec.title = 'ê°±ì‹  ê¸°íšŒ';
                renewalRec.description = renewal.assetName + ' ê°±ì‹  ê¸°íšŒë¥¼ ë†“ì¹˜ì§€ ë§ˆì„¸ìš”.';
                renewalRec.priority = 'MEDIUM';
                recommendations.add(renewalRec);
            }
        }
        
        return recommendations;
    }
    
    private static void sendDailySummaryToSlack(Id userId, DailyAutomationResult dailyResult) {
        // ì¼ì¼ ìš”ì•½ì„ Slackìœ¼ë¡œ ë°œì†¡
        String summary = 'ğŸ“Š **ì¼ì¼ ì˜ì—… ìš”ì•½**\n\n';
        summary += 'â€¢ ê¸´ê¸‰ ì‚¬í•­: ' + dailyResult.dailyBriefing.urgentItems.size() + 'ê±´\n';
        summary += 'â€¢ ê³ ìœ„í—˜ ê³ ê°: ' + dailyResult.churnRiskCustomers.size() + 'ê±´\n';
        summary += 'â€¢ ê°±ì‹  ê¸°íšŒ: ' + dailyResult.renewalOpportunities.size() + 'ê±´\n';
        
        // ê°œì¸ DM ë°œì†¡ ë¡œì§ (ì‹¤ì œ êµ¬í˜„ ì‹œ Slack API ì—°ë™ í•„ìš”)
        System.debug('Daily Summary for User ' + userId + ': ' + summary);
    }
    
    // ê¸°íƒ€ Helper Methods
    private static void createInitialOrderTasks(Id orderId) {
        List<Task> tasks = new List<Task>();
        
        Task onboardingTask = new Task();
        onboardingTask.Subject = 'ê³ ê° ì˜¨ë³´ë”© ë¯¸íŒ… ì¼ì • ì¡°ìœ¨';
        onboardingTask.WhatId = orderId;
        onboardingTask.ActivityDate = Date.today().addDays(1);
        onboardingTask.Priority = 'High';
        onboardingTask.Status = 'Not Started';
        tasks.add(onboardingTask);
        
        Task emailTask = new Task();
        emailTask.Subject = 'ì²« ë²ˆì§¸ ë‚©ë¶€ ì•ˆë‚´ ì´ë©”ì¼ ë°œì†¡';
        emailTask.WhatId = orderId;
        emailTask.ActivityDate = Date.today().addDays(2);
        emailTask.Priority = 'Normal';
        emailTask.Status = 'Not Started';
        tasks.add(emailTask);
        
        insert tasks;
    }
    
    private static void createNextPaymentReminderTask(Id orderId, String paymentId) {
        Task reminderTask = new Task();
        reminderTask.Subject = 'ë‹¤ìŒ ê²°ì œ ì•ˆë‚´ ì´ë©”ì¼ ë°œì†¡';
        reminderTask.WhatId = orderId;
        reminderTask.ActivityDate = Date.today().addDays(30); // ë‹¤ìŒ ë¶„ê¸° ì „
        reminderTask.Priority = 'Normal';
        reminderTask.Status = 'Not Started';
        reminderTask.Description = 'Payment ID: ' + paymentId;
        
        insert reminderTask;
    }
    
    private static Boolean isOrderFullyPaid(Id orderId) {
        List<PaymentStatus__c> payments = [
            SELECT Status__c 
            FROM PaymentStatus__c 
            WHERE Order__c = :orderId
        ];
        
        for (PaymentStatus__c payment : payments) {
            if (payment.Status__c != 'ì™„ë‚©') {
                return false;
            }
        }
        
        return !payments.isEmpty();
    }
    
    private static void createOverdueHandlingTask(Id orderId, String paymentId) {
        Task overdueTask = new Task();
        overdueTask.Subject = 'ì—°ì²´ ê³ ê° ì¦‰ì‹œ ì—°ë½';
        overdueTask.WhatId = orderId;
        overdueTask.ActivityDate = Date.today();
        overdueTask.Priority = 'High';
        overdueTask.Status = 'Not Started';
        overdueTask.Description = 'Payment ID: ' + paymentId + ' - ì¦‰ì‹œ ê³ ê° ì—°ë½ í•„ìš”';
        
        insert overdueTask;
    }
    
    private static void createCustomerSatisfactionTask(Id orderId) {
        Task satisfactionTask = new Task();
        satisfactionTask.Subject = 'ê³ ê° ë§Œì¡±ë„ ì¡°ì‚¬ ì‹¤ì‹œ';
        satisfactionTask.WhatId = orderId;
        satisfactionTask.ActivityDate = Date.today().addDays(7);
        satisfactionTask.Priority = 'Normal';
        satisfactionTask.Status = 'Not Started';
        
        insert satisfactionTask;
    }
    
    private static Account getCustomerBasicInfo(Id customerId) {
        return [
            SELECT Id, Name, Type, Industry, Phone, BillingAddress, 
                   AnnualRevenue, NumberOfEmployees, CreatedDate, LastActivityDate
            FROM Account 
            WHERE Id = :customerId 
            LIMIT 1
        ];
    }
    
    private static List<AgentforceEmailIntegrationService.EmailGenerationResult> getEmailRecommendations(Id customerId) {
        // ê³ ê°ë³„ ìµœì  ì´ë©”ì¼ ì¶”ì²œ
        AgentforceEmailIntegrationService.EmailGenerationRequest request = 
            new AgentforceEmailIntegrationService.EmailGenerationRequest();
        request.recordId = customerId;
        request.emailType = 'general';
        
        return AgentforceEmailIntegrationService.generateSmartEmail(
            new List<AgentforceEmailIntegrationService.EmailGenerationRequest>{request}
        );
    }
    
    private static List<Task> getRecentCustomerActivities(Id customerId) {
        return [
            SELECT Id, Subject, ActivityDate, Status, CreatedDate, Owner.Name
            FROM Task 
            WHERE WhatId = :customerId 
            ORDER BY CreatedDate DESC 
            LIMIT 10
        ];
    }
    
    private static AssetROIAnalysisService.AssetROIResult getCustomerROIAnalysis(Id customerId) {
        // ê³ ê°ì˜ ì£¼ìš” Asset ROI ë¶„ì„
        List<Asset> customerAssets = [
            SELECT Id 
            FROM Asset 
            WHERE AccountId = :customerId 
            ORDER BY CreatedDate DESC 
            LIMIT 1
        ];
        
        if (!customerAssets.isEmpty()) {
            return AssetROIAnalysisService.calculateAssetROI(customerAssets[0].Id);
        }
        
        return null;
    }
    
    // Wrapper Classes
    
    public class AgentforceRequest {
        @InvocableVariable(label='User ID' required=true)
        public String userId;
        
        @InvocableVariable(label='User Message' required=true)
        public String userMessage;
        
        @InvocableVariable(label='Record ID')
        public String recordId;
        
        @InvocableVariable(label='Additional Context')
        public String additionalContext;
    }
    
    public class AgentforceResponse {
        @InvocableVariable
        public Boolean success;
        
        @InvocableVariable
        public String responseType;
        
        @InvocableVariable
        public String title;
        
        @InvocableVariable
        public String content;
        
        @InvocableVariable
        public String errorMessage;
        
        @InvocableVariable
        public DateTime timestamp;
        
        public AgentforceResponse() {
            this.success = false;
            this.timestamp = System.now();
        }
    }
    
    public class OrderLifecycleRequest {
        @InvocableVariable(label='Order ID' required=true)
        public String orderId;
        
        @InvocableVariable(label='Lifecycle Event' required=true)
        public String lifecycleEvent; // ORDER_ACTIVATED, PAYMENT_COMPLETED, PAYMENT_OVERDUE, ORDER_COMPLETED
        
        @InvocableVariable(label='Payment ID')
        public String paymentId;
    }
    
    public class OrderLifecycleResult {
        @InvocableVariable
        public Boolean success;
        
        @InvocableVariable
        public String message;
        
        @InvocableVariable
        public List<String> completedActions;
        
        @InvocableVariable
        public String errorMessage;
        
        public OrderLifecycleResult() {
            this.success = false;
            this.completedActions = new List<String>();
        }
    }
    
    public class DailyAutomationResult {
        @AuraEnabled public Boolean success { get; set; }
        @AuraEnabled public DateTime executionTime { get; set; }
        @AuraEnabled public AgentforceSalesAssistantService.DailyBriefingResult dailyBriefing { get; set; }
        @AuraEnabled public AgentforceAdvancedAnalyticsService.SalesInsightResult salesInsights { get; set; }
        @AuraEnabled public List<AgentforceAdvancedAnalyticsService.ChurnPredictionResult> churnRiskCustomers { get; set; }
        @AuraEnabled public List<AgentforceAdvancedAnalyticsService.AssetRenewalAnalysis> renewalOpportunities { get; set; }
        @AuraEnabled public List<DailyRecommendation> recommendedActions { get; set; }
        
        public DailyAutomationResult() {
            this.success = false;
            this.churnRiskCustomers = new List<AgentforceAdvancedAnalyticsService.ChurnPredictionResult>();
            this.renewalOpportunities = new List<AgentforceAdvancedAnalyticsService.AssetRenewalAnalysis>();
            this.recommendedActions = new List<DailyRecommendation>();
        }
    }
    
    public class DailyRecommendation {
        @AuraEnabled public String type { get; set; }
        @AuraEnabled public String title { get; set; }
        @AuraEnabled public String description { get; set; }
        @AuraEnabled public String priority { get; set; } // HIGH, MEDIUM, LOW
    }
    
    public class Customer360View {
        @AuraEnabled public Boolean success { get; set; }
        @AuraEnabled public Account customerInfo { get; set; }
        @AuraEnabled public AgentforceAdvancedAnalyticsService.ChurnPredictionResult churnRisk { get; set; }
        @AuraEnabled public AgentforceAdvancedAnalyticsService.ContactTimingRecommendation contactTiming { get; set; }
        @AuraEnabled public AgentforceAdvancedAnalyticsService.RenewalOpportunityResult renewalAnalysis { get; set; }
        @AuraEnabled public List<AgentforceEmailIntegrationService.EmailGenerationResult> emailRecommendations { get; set; }
        @AuraEnabled public List<Task> recentActivities { get; set; }
        @AuraEnabled public AssetROIAnalysisService.AssetROIResult roiAnalysis { get; set; }
        
        public Customer360View() {
            this.success = false;
            this.emailRecommendations = new List<AgentforceEmailIntegrationService.EmailGenerationResult>();
            this.recentActivities = new List<Task>();
        }
    }
}
