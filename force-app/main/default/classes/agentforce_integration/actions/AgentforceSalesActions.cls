/**
 * @description Agentforce Sales Agentìš© Custom Apex Actions
 * @author AI Assistant
 * @created 2025-07-24
 */
public with sharing class AgentforceSalesActions {
    
    /**
     * ì˜ì—…ì‚¬ì› ì„±ê³¼ ìš”ì•½ ì¡°íšŒ
     */
    @InvocableMethod(label='Get Sales Performance Summary' description='ì˜ì—…ì‚¬ì›ì˜ ì¢…í•© ì„±ê³¼ ì§€í‘œë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤')
    public static List<SalesPerformanceResult> getSalesPerformanceSummary(List<SalesPerformanceRequest> requests) {
        List<SalesPerformanceResult> results = new List<SalesPerformanceResult>();
        
        for(SalesPerformanceRequest request : requests) {
            SalesPerformanceResult result = new SalesPerformanceResult();
            
            try {
                // ì˜ì—…ì‚¬ì›ì˜ Order ì„±ê³¼ ë¶„ì„
                List<Order> userOrders = [
                    SELECT Id, Status, TotalAmount, EffectiveDate, AccountId, Account.Name
                    FROM Order 
                    WHERE OwnerId = :request.userId
                    AND EffectiveDate >= LAST_N_DAYS:90
                ];
                
                result.totalOrders = userOrders.size();
                result.successfulOrders = 0;
                result.totalAmount = 0;
                
                for(Order ord : userOrders) {
                    if(ord.Status == 'Activated') {
                        result.successfulOrders++;
                    }
                    if(ord.TotalAmount != null) {
                        result.totalAmount += ord.TotalAmount;
                    }
                }
                
                // ì„±ê³µë¥  ê³„ì‚°
                if(result.totalOrders > 0) {
                    result.successRate = (result.successfulOrders * 100) / result.totalOrders;
                } else {
                    result.successRate = 0;
                }
                
                // Asset ê°±ì‹  ì„±ê³¼
                List<Asset> userAssets = [
                    SELECT Id, Status, Account.OwnerId
                    FROM Asset 
                    WHERE Account.OwnerId = :request.userId
                    AND Status = 'Installed'
                ];
                
                result.activeAssets = userAssets.size();
                
                // ì„±ê³¼ ë©”ì‹œì§€ ìƒì„±
                result.performanceSummary = generatePerformanceSummary(result);
                result.success = true;
                
            } catch(Exception e) {
                result.success = false;
                result.errorMessage = 'ì„±ê³¼ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage();
            }
            
            results.add(result);
        }
        
        return results;
    }
    
    /**
     * Asset ê°±ì‹  í™•ë¥  ì˜ˆì¸¡
     */
    @InvocableMethod(label='Predict Asset Renewal' description='Einstein AI ê¸°ë°˜ Asset ê°±ì‹  í™•ë¥ ì„ ì˜ˆì¸¡í•©ë‹ˆë‹¤')
    public static List<AssetRenewalResult> predictAssetRenewal(List<AssetRenewalRequest> requests) {
        List<AssetRenewalResult> results = new List<AssetRenewalResult>();
        
        for(AssetRenewalRequest request : requests) {
            AssetRenewalResult result = new AssetRenewalResult();
            
            try {
                // Asset ì •ë³´ ì¡°íšŒ
                Asset asset = [
                    SELECT Id, Name, Status, InstallDate, UsageEndDate, 
                           Account.Id, Account.Name, Account.Industry
                    FROM Asset 
                    WHERE Id = :request.assetId 
                    LIMIT 1
                ];
                
                // ê°±ì‹  í™•ë¥  ê³„ì‚° (ê°„ë‹¨í•œ ë£° ê¸°ë°˜)
                Integer daysSinceInstall = asset.InstallDate != null ? 
                    Date.today().daysBetween(asset.InstallDate) : 0;
                Integer daysToExpiry = asset.UsageEndDate != null ? 
                    Date.today().daysBetween(asset.UsageEndDate) : 365;
                
                // ì—…ì¢…ë³„ ê°€ì¤‘ì¹˜
                Decimal industryWeight = getIndustryWeight(asset.Account.Industry);
                
                // ê°±ì‹  í™•ë¥  ê³„ì‚°
                if(daysToExpiry <= 30) {
                    result.renewalProbability = 85 + industryWeight;
                } else if(daysToExpiry <= 90) {
                    result.renewalProbability = 70 + industryWeight;
                } else {
                    result.renewalProbability = 60 + industryWeight;
                }
                
                // ìµœëŒ€ 95%ë¡œ ì œí•œ
                if(result.renewalProbability > 95) {
                    result.renewalProbability = 95;
                }
                
                result.assetName = asset.Name;
                result.accountName = asset.Account.Name;
                result.daysToExpiry = daysToExpiry;
                result.recommendedActions = generateRenewalActions(result.renewalProbability, daysToExpiry);
                result.success = true;
                
            } catch(Exception e) {
                result.success = false;
                result.errorMessage = 'Asset ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage();
            }
            
            results.add(result);
        }
        
        return results;
    }
    
    /**
     * ê³ ê° ì¸ì‚¬ì´íŠ¸ ìƒì„±
     */
    @InvocableMethod(label='Generate Customer Insights' description='ê³ ê°ë³„ ìƒì„¸ ë¶„ì„ ë° ì•¡ì…˜ ì¶”ì²œì„ ì œê³µí•©ë‹ˆë‹¤')
    public static List<CustomerInsightResult> generateCustomerInsights(List<CustomerInsightRequest> requests) {
        List<CustomerInsightResult> results = new List<CustomerInsightResult>();
        
        for(CustomerInsightRequest request : requests) {
            CustomerInsightResult result = new CustomerInsightResult();
            
            try {
                // Account ì •ë³´ ì¡°íšŒ
                Account account = [
                    SELECT Id, Name, Industry, Type, AnnualRevenue, 
                           NumberOfEmployees, OwnerId, Owner.Name
                    FROM Account 
                    WHERE Id = :request.accountId 
                    LIMIT 1
                ];
                
                // Order ì´ë ¥ ì¡°íšŒ
                List<Order> accountOrders = [
                    SELECT Id, Status, TotalAmount, EffectiveDate
                    FROM Order 
                    WHERE AccountId = :request.accountId
                    ORDER BY EffectiveDate DESC
                    LIMIT 10
                ];
                
                // Asset í˜„í™© ì¡°íšŒ
                List<Asset> accountAssets = [
                    SELECT Id, Name, Status, InstallDate, UsageEndDate
                    FROM Asset 
                    WHERE AccountId = :request.accountId
                    AND Status = 'Installed'
                ];
                
                result.accountName = account.Name;
                result.industry = account.Industry;
                result.totalOrders = accountOrders.size();
                result.activeAssets = accountAssets.size();
                result.accountOwner = account.Owner.Name;
                
                // ê³ ê° ì ìˆ˜ ê³„ì‚°
                result.customerScore = calculateCustomerScore(account, accountOrders, accountAssets);
                
                // ì¸ì‚¬ì´íŠ¸ ë° ì¶”ì²œ ì•¡ì…˜ ìƒì„±
                result.insights = generateCustomerInsights(account, accountOrders, accountAssets);
                result.recommendedActions = generateCustomerActions(result.customerScore, accountAssets);
                result.success = true;
                
            } catch(Exception e) {
                result.success = false;
                result.errorMessage = 'ê³ ê° ë¶„ì„ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage();
            }
            
            results.add(result);
        }
        
        return results;
    }
    
    // Helper Methods
    private static String generatePerformanceSummary(SalesPerformanceResult result) {
        String summary = 'ğŸ“Š ì„±ê³¼ ìš”ì•½\n';
        summary += 'â€¢ ì´ ì£¼ë¬¸: ' + result.totalOrders + 'ê°œ\n';
        summary += 'â€¢ ì„±ê³µë¥ : ' + result.successRate + '%\n';
        summary += 'â€¢ ì´ ê¸ˆì•¡: â‚©' + String.valueOf(result.totalAmount.setScale(0)) + '\n';
        summary += 'â€¢ í™œì„± Asset: ' + result.activeAssets + 'ê°œ\n';
        
        if(result.successRate >= 90) {
            summary += 'ğŸ† ìš°ìˆ˜í•œ ì„±ê³¼ì…ë‹ˆë‹¤!';
        } else if(result.successRate >= 70) {
            summary += 'ğŸ‘ ì–‘í˜¸í•œ ì„±ê³¼ì…ë‹ˆë‹¤.';
        } else {
            summary += 'ğŸ’ª ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.';
        }
        
        return summary;
    }
    
    private static Decimal getIndustryWeight(String industry) {
        Map<String, Decimal> industryWeights = new Map<String, Decimal>{
            'Technology' => 10,
            'Manufacturing' => 8,
            'Financial Services' => 12,
            'Healthcare' => 9,
            'Education' => 7
        };
        
        return industryWeights.get(industry) != null ? industryWeights.get(industry) : 5;
    }
    
    private static String generateRenewalActions(Decimal probability, Integer daysToExpiry) {
        String actions = 'ğŸ¯ ì¶”ì²œ ì•¡ì…˜:\n';
        
        if(probability >= 80) {
            actions += 'â€¢ ê°±ì‹  ê³„ì•½ì„œ ì¤€ë¹„\n';
            actions += 'â€¢ ê³ ê° ë¯¸íŒ… ìŠ¤ì¼€ì¤„ë§\n';
            actions += 'â€¢ ì—…ê·¸ë ˆì´ë“œ ì˜µì…˜ ì œì•ˆ';
        } else if(probability >= 60) {
            actions += 'â€¢ ê³ ê° ë§Œì¡±ë„ ì¡°ì‚¬\n';
            actions += 'â€¢ ì¶”ê°€ ê°€ì¹˜ ì œì•ˆ ì¤€ë¹„\n';
            actions += 'â€¢ ê²½ìŸì‚¬ ë¶„ì„ ì‹¤ì‹œ';
        } else {
            actions += 'â€¢ ê´€ê³„ ê°œì„  ì „ëµ ìˆ˜ë¦½\n';
            actions += 'â€¢ í• ì¸ í˜œíƒ ê²€í† \n';
            actions += 'â€¢ ëŒ€ì•ˆ ì†”ë£¨ì…˜ íƒìƒ‰';
        }
        
        return actions;
    }
    
    private static Integer calculateCustomerScore(Account account, List<Order> orders, List<Asset> assets) {
        Integer score = 50; // Base score
        
        // Order ì´ë ¥ ì ìˆ˜
        score += orders.size() * 5;
        
        // Asset ë³´ìœ  ì ìˆ˜
        score += assets.size() * 8;
        
        // ì—…ì¢…ë³„ ê°€ì¤‘ì¹˜
        if(account.Industry == 'Technology') score += 10;
        if(account.Industry == 'Manufacturing') score += 8;
        
        // ì—°ë§¤ì¶œ ê°€ì¤‘ì¹˜
        if(account.AnnualRevenue != null && account.AnnualRevenue > 1000000) {
            score += 15;
        }
        
        return Math.min(score, 100); // ìµœëŒ€ 100ì 
    }
    
    private static String generateCustomerInsights(Account account, List<Order> orders, List<Asset> assets) {
        String insights = 'ğŸ” ê³ ê° ì¸ì‚¬ì´íŠ¸\n';
        insights += 'â€¢ ì—…ì¢…: ' + account.Industry + '\n';
        insights += 'â€¢ ì£¼ë¬¸ ì´ë ¥: ' + orders.size() + 'ê±´\n';
        insights += 'â€¢ ë³´ìœ  Asset: ' + assets.size() + 'ê°œ\n';
        
        if(orders.size() > 5) {
            insights += 'â€¢ ì¶©ì„± ê³ ê° (ë†’ì€ ì¬êµ¬ë§¤ìœ¨)\n';
        }
        
        if(assets.size() > 3) {
            insights += 'â€¢ ë‹¤ìˆ˜ ì†”ë£¨ì…˜ ë³´ìœ  (í™•ì¥ ê°€ëŠ¥ì„± ë†’ìŒ)\n';
        }
        
        return insights;
    }
    
    private static String generateCustomerActions(Integer score, List<Asset> assets) {
        String actions = 'ğŸ’¡ ì¶”ì²œ ì•¡ì…˜\n';
        
        if(score >= 80) {
            actions += 'â€¢ VIP ê³ ê° ê´€ë¦¬ í”„ë¡œê·¸ë¨ ì ìš©\n';
            actions += 'â€¢ í”„ë¦¬ë¯¸ì—„ ì„œë¹„ìŠ¤ ì œì•ˆ\n';
            actions += 'â€¢ ë ˆí¼ëŸ°ìŠ¤ ê³ ê° ìš”ì²­';
        } else if(score >= 60) {
            actions += 'â€¢ ì •ê¸° ì²´í¬ì¸ ë¯¸íŒ…\n';
            actions += 'â€¢ êµìœ¡ í”„ë¡œê·¸ë¨ ì œê³µ\n';
            actions += 'â€¢ ì‚¬ìš© í˜„í™© ëª¨ë‹ˆí„°ë§';
        } else {
            actions += 'â€¢ ê´€ê³„ ê°œì„  ì§‘ì¤‘\n';
            actions += 'â€¢ ê¸°ë³¸ ì„œë¹„ìŠ¤ ê°•í™”\n';
            actions += 'â€¢ í”¼ë“œë°± ìˆ˜ì§‘ ë° ê°œì„ ';
        }
        
        return actions;
    }
    
    // Input/Output Classes
    public class SalesPerformanceRequest {
        @InvocableVariable(required=true)
        public String userId;
    }
    
    public class SalesPerformanceResult {
        @InvocableVariable
        public Boolean success;
        @InvocableVariable
        public String errorMessage;
        @InvocableVariable
        public Integer totalOrders;
        @InvocableVariable
        public Integer successfulOrders;
        @InvocableVariable
        public Integer successRate;
        @InvocableVariable
        public Decimal totalAmount;
        @InvocableVariable
        public Integer activeAssets;
        @InvocableVariable
        public String performanceSummary;
    }
    
    public class AssetRenewalRequest {
        @InvocableVariable(required=true)
        public String assetId;
    }
    
    public class AssetRenewalResult {
        @InvocableVariable
        public Boolean success;
        @InvocableVariable
        public String errorMessage;
        @InvocableVariable
        public String assetName;
        @InvocableVariable
        public String accountName;
        @InvocableVariable
        public Decimal renewalProbability;
        @InvocableVariable
        public Integer daysToExpiry;
        @InvocableVariable
        public String recommendedActions;
    }
    
    public class CustomerInsightRequest {
        @InvocableVariable(required=true)
        public String accountId;
    }
    
    public class CustomerInsightResult {
        @InvocableVariable
        public Boolean success;
        @InvocableVariable
        public String errorMessage;
        @InvocableVariable
        public String accountName;
        @InvocableVariable
        public String industry;
        @InvocableVariable
        public String accountOwner;
        @InvocableVariable
        public Integer totalOrders;
        @InvocableVariable
        public Integer activeAssets;
        @InvocableVariable
        public Integer customerScore;
        @InvocableVariable
        public String insights;
        @InvocableVariable
        public String recommendedActions;
    }
}
