/**
 * @description Agentforce Order Email Draft Action
 * @author AI Assistant
 * @created 2025-07-24
 */
public with sharing class AgentforceOrderEmailAction {
    
    /**
     * Order ê´€ë ¨ ì´ë©”ì¼ ì´ˆì•ˆ ìƒì„±
     */
    @InvocableMethod(label='Draft Order Email' description='Order ìƒíƒœì— ë”°ë¥¸ ì´ë©”ì¼ ì´ˆì•ˆì„ ìƒì„±í•©ë‹ˆë‹¤')
    public static List<EmailDraftResult> draftOrderEmail(List<OrderEmailRequest> requests) {
        List<EmailDraftResult> results = new List<EmailDraftResult>();
        
        for(OrderEmailRequest request : requests) {
            EmailDraftResult result = new EmailDraftResult();
            
            try {
                // Order ì •ë³´ ì¡°íšŒ - OrderNumber ë˜ëŠ” Order IDë¡œ ê²€ìƒ‰
                List<Order> orders = new List<Order>();
                
                // ë¨¼ì € Order IDë¡œ ì‹œë„
                if(request.orderId.length() >= 15) {
                    orders = [
                        SELECT Id, OrderNumber, TotalAmount, EffectiveDate, Status,
                               Account.Name, Account.Id, Owner.Name, Owner.Email, Owner.Phone
                        FROM Order 
                        WHERE Id = :request.orderId 
                        LIMIT 1
                    ];
                }
                
                // Order IDë¡œ ì°¾ì§€ ëª»í–ˆìœ¼ë©´ OrderNumberë¡œ ê²€ìƒ‰
                if(orders.isEmpty()) {
                    orders = [
                        SELECT Id, OrderNumber, TotalAmount, EffectiveDate, Status,
                               Account.Name, Account.Id, Owner.Name, Owner.Email, Owner.Phone
                        FROM Order 
                        WHERE OrderNumber = :request.orderId 
                        LIMIT 1
                    ];
                }
                
                if(orders.isEmpty()) {
                    result.success = false;
                    result.errorMessage = 'Orderë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    results.add(result);
                    continue;
                }
                
                Order orderRecord = orders[0];
                
                // ì´ë©”ì¼ í…œí”Œë¦¿ ìƒì„±
                String emailSubject = generateOrderEmailSubject(orderRecord, request.emailType);
                String emailBody = generateOrderEmailBody(orderRecord, request.emailType);
                
                result.emailSubject = emailSubject;
                result.emailBody = emailBody;
                result.recipientEmail = getOrderRecipientEmail(orderRecord);
                result.emailType = request.emailType;
                result.orderNumber = orderRecord.OrderNumber;
                result.success = true;
                
            } catch(Exception e) {
                result.success = false;
                result.errorMessage = 'Order ì´ë©”ì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + e.getMessage();
            }
            
            results.add(result);
        }
        
        return results;
    }
    
    // Helper Methods
    private static String generateOrderEmailSubject(Order orderRecord, String emailType) {
        String subject = '';
        
        switch on emailType {
            when 'Order_Confirmation' {
                subject = '[ì£¼ë¬¸ í™•ì¸] Order ' + orderRecord.OrderNumber + ' - ' + orderRecord.Account.Name;
            }
            when 'Order_Activation' {
                subject = '[ì„œë¹„ìŠ¤ í™œì„±í™”] Order ' + orderRecord.OrderNumber + ' ì„œë¹„ìŠ¤ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤';
            }
            when 'Order_Status_Update' {
                subject = '[ì§„í–‰ ìƒí™©] Order ' + orderRecord.OrderNumber + ' ìƒíƒœ ì—…ë°ì´íŠ¸';
            }
            when 'Order_Completion' {
                subject = '[ì™„ë£Œ ì•Œë¦¼] Order ' + orderRecord.OrderNumber + ' ì„œë¹„ìŠ¤ ì™„ë£Œ';
            }
            when else {
                subject = '[ì•Œë¦¼] Order ' + orderRecord.OrderNumber + ' ê´€ë ¨ ì•ˆë‚´';
            }
        }
        
        return subject;
    }
    
    private static String generateOrderEmailBody(Order orderRecord, String emailType) {
        String body = '';
        
        body += 'ì•ˆë…•í•˜ì„¸ìš”, ' + orderRecord.Account.Name + ' ë‹´ë‹¹ìë‹˜\n\n';
        body += 'ë‹´ë‹¹ ì˜ì—…ì‚¬ì› ' + orderRecord.Owner.Name + 'ì…ë‹ˆë‹¤.\n\n';
        
        switch on emailType {
            when 'Order_Confirmation' {
                body += 'ğŸ“‹ ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n';
                body += 'ì£¼ë¬¸ ì •ë³´:\n';
                body += 'â€¢ ì£¼ë¬¸ë²ˆí˜¸: ' + orderRecord.OrderNumber + '\n';
                body += 'â€¢ ì£¼ë¬¸ê¸ˆì•¡: â‚©' + String.valueOf(orderRecord.TotalAmount) + '\n';
                body += 'â€¢ ì‹œì‘ì¼: ' + orderRecord.EffectiveDate.format() + '\n\n';
                body += 'ì¶”ê°€ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ì—°ë½ì£¼ì„¸ìš”.\n';
            }
            when 'Order_Activation' {
                body += 'ğŸš€ ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n';
                body += 'ì´ì œ ì£¼ë¬¸í•˜ì‹  ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n';
                body += 'ì„œë¹„ìŠ¤ ì´ìš© ì¤‘ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ë‹´ë‹¹ìì—ê²Œ ì—°ë½ì£¼ì„¸ìš”.\n';
            }
            when 'Order_Status_Update' {
                body += 'ğŸ“Š ì£¼ë¬¸ ì§„í–‰ ìƒí™©ì„ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.\n\n';
                body += 'í˜„ì¬ ìƒíƒœ: ' + orderRecord.Status + '\n';
                body += 'ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰ ì‹œ ë³„ë„ ì•ˆë‚´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.\n';
            }
            when 'Order_Completion' {
                body += 'ğŸ‰ ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n';
                body += 'ì„œë¹„ìŠ¤ ì´ìš©í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.\n';
                body += 'ì¶”ê°€ ì„œë¹„ìŠ¤ë‚˜ ì—°ì¥ì´ í•„ìš”í•˜ì‹œë©´ ì–¸ì œë“  ë¬¸ì˜ì£¼ì„¸ìš”.\n';
            }
        }
        
        body += '\nê°ì‚¬í•©ë‹ˆë‹¤.\n';
        body += orderRecord.Owner.Name + '\n';
        body += 'ì „í™”: ' + orderRecord.Owner.Phone + '\n';
        body += 'ì´ë©”ì¼: ' + orderRecord.Owner.Email;
        
        return body;
    }
    
    private static String getOrderRecipientEmail(Order orderRecord) {
        // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” Contact ë˜ëŠ” Accountì—ì„œ ì´ë©”ì¼ ì¡°íšŒ
        return 'customer@example.com'; // placeholder
    }
    
    // Input/Output Classes
    public class OrderEmailRequest {
        @InvocableVariable(required=true)
        public String orderId;
        @InvocableVariable(required=true)
        public String emailType; // Order_Confirmation, Order_Activation, Order_Status_Update, Order_Completion
    }
    
    public class EmailDraftResult {
        @InvocableVariable
        public Boolean success;
        @InvocableVariable
        public String errorMessage;
        @InvocableVariable
        public String emailSubject;
        @InvocableVariable
        public String emailBody;
        @InvocableVariable
        public String recipientEmail;
        @InvocableVariable
        public String emailType;
        @InvocableVariable
        public String orderNumber;
    }
}
