/**
 * @description Agentforce Email Revision Action
 * @author AI Assistant
 * @created 2025-07-24
 */
public with sharing class AgentforceEmailRevisionAction {
    
    /**
     * ì´ë©”ì¼ ì´ˆì•ˆ ìˆ˜ì • ë° ê°œì„ 
     */
    @InvocableMethod(label='Revise Email Draft' description='ê¸°ì¡´ ì´ë©”ì¼ ì´ˆì•ˆì„ ìˆ˜ì •í•˜ê³  ê°œì„ í•©ë‹ˆë‹¤')
    public static List<EmailRevisionResult> reviseEmailDraft(List<EmailRevisionRequest> requests) {
        List<EmailRevisionResult> results = new List<EmailRevisionResult>();
        
        for(EmailRevisionRequest request : requests) {
            EmailRevisionResult result = new EmailRevisionResult();
            
            try {
                // ìˆ˜ì • ìš”ì²­ì— ë”°ë¥¸ ì´ë©”ì¼ ê°œì„ 
                String revisedSubject = reviseEmailSubject(request);
                String revisedBody = reviseEmailBody(request);
                
                result.revisedSubject = revisedSubject;
                result.revisedBody = revisedBody;
                result.revisionType = request.revisionType;
                result.originalSubject = request.originalSubject;
                result.originalBody = request.originalBody;
                result.success = true;
                
            } catch(Exception e) {
                result.success = false;
                result.errorMessage = 'ì´ë©”ì¼ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜: ' + e.getMessage();
            }
            
            results.add(result);
        }
        
        return results;
    }
    
    // Helper Methods
    private static String reviseEmailSubject(EmailRevisionRequest request) {
        String revisedSubject = request.originalSubject;
        
        switch on request.revisionType {
            when 'Make_Urgent' {
                if(!revisedSubject.contains('[ê¸´ê¸‰]')) {
                    revisedSubject = '[ê¸´ê¸‰] ' + revisedSubject;
                }
            }
            when 'Make_Formal' {
                revisedSubject = revisedSubject.replace('[ì•ˆë‚´]', '[ê³µì‹ ì•ˆë‚´]');
                if(!revisedSubject.contains('ê·€í•˜')) {
                    revisedSubject = revisedSubject.replace('ë‹˜', 'ê·€í•˜');
                }
            }
            when 'Make_Friendly' {
                revisedSubject = revisedSubject.replace('[ê³µì‹ ì•ˆë‚´]', '[ì•ˆë‚´]');
                revisedSubject = revisedSubject.replace('ê·€í•˜', 'ë‹˜');
                if(!revisedSubject.contains('ğŸ˜Š')) {
                    revisedSubject = revisedSubject + ' ğŸ˜Š';
                }
            }
            when 'Add_Action_Required' {
                if(!revisedSubject.contains('[ì¡°ì¹˜ í•„ìš”]')) {
                    revisedSubject = '[ì¡°ì¹˜ í•„ìš”] ' + revisedSubject;
                }
            }
            when 'Shorten' {
                // ì œëª© ê°„ì†Œí™”
                revisedSubject = revisedSubject.replace('ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤', 'ì•ˆë‚´');
                revisedSubject = revisedSubject.replace('ì•Œë ¤ë“œë¦½ë‹ˆë‹¤', 'ì•Œë¦¼');
            }
        }
        
        return revisedSubject;
    }
    
    private static String reviseEmailBody(EmailRevisionRequest request) {
        String revisedBody = request.originalBody;
        
        switch on request.revisionType {
            when 'Make_Urgent' {
                revisedBody = addUrgentTone(revisedBody, request.revisionInstructions);
            }
            when 'Make_Formal' {
                revisedBody = makeFormalTone(revisedBody, request.revisionInstructions);
            }
            when 'Make_Friendly' {
                revisedBody = makeFriendlyTone(revisedBody, request.revisionInstructions);
            }
            when 'Add_Details' {
                revisedBody = addMoreDetails(revisedBody, request.revisionInstructions);
            }
            when 'Shorten' {
                revisedBody = shortenContent(revisedBody, request.revisionInstructions);
            }
            when 'Add_Action_Required' {
                revisedBody = addActionItems(revisedBody, request.revisionInstructions);
            }
            when 'Custom' {
                revisedBody = applyCustomRevisions(revisedBody, request.revisionInstructions);
            }
        }
        
        return revisedBody;
    }
    
    private static String addUrgentTone(String originalBody, String instructions) {
        String urgentBody = originalBody;
        
        // ê¸´ê¸‰ì„± í‘œí˜„ ì¶”ê°€
        urgentBody = urgentBody.replace('ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤', 'ê¸´ê¸‰íˆ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤');
        urgentBody = urgentBody.replace('ì—°ë½ì£¼ì„¸ìš”', 'ì¦‰ì‹œ ì—°ë½ì£¼ì„¸ìš”');
        
        // ê¸´ê¸‰ ì•„ì´ì½˜ ì¶”ê°€
        if(!urgentBody.contains('ğŸš¨')) {
            urgentBody = 'ğŸš¨ ê¸´ê¸‰ ì•ˆë‚´ ğŸš¨\n\n' + urgentBody;
        }
        
        // ë§ˆê°ì¼ ê°•ì¡°
        if(instructions != null && instructions.contains('ë§ˆê°ì¼')) {
            urgentBody = urgentBody + '\n\nâ° ë§ˆê°ì¼ì´ ì„ë°•í–ˆìŠµë‹ˆë‹¤. ë¹ ë¥¸ ì¡°ì¹˜ ë¶€íƒë“œë¦½ë‹ˆë‹¤.';
        }
        
        return urgentBody;
    }
    
    private static String makeFormalTone(String originalBody, String instructions) {
        String formalBody = originalBody;
        
        // ì •ì¤‘í•œ í‘œí˜„ìœ¼ë¡œ ë³€ê²½
        formalBody = formalBody.replace('ì•ˆë…•í•˜ì„¸ìš”', 'ì•ˆë…•í•˜ì‹­ë‹ˆê¹Œ');
        formalBody = formalBody.replace('ê°ì‚¬í•©ë‹ˆë‹¤', 'ê°ì‚¬ë“œë¦½ë‹ˆë‹¤');
        formalBody = formalBody.replace('ì—°ë½ì£¼ì„¸ìš”', 'ì—°ë½ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤');
        formalBody = formalBody.replace('ë¶€íƒë“œë¦½ë‹ˆë‹¤', 'ë¶€íƒë“œë¦¬ê² ìŠµë‹ˆë‹¤');
        
        // ì¡´ëŒ“ë§ ê°•í™”
        formalBody = formalBody.replace('í•´ ì£¼ì„¸ìš”', 'í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤');
        formalBody = formalBody.replace('í™•ì¸í•´', 'í™•ì¸í•˜ì—¬ ì£¼ì‹œê¸°');
        
        return formalBody;
    }
    
    private static String makeFriendlyTone(String originalBody, String instructions) {
        String friendlyBody = originalBody;
        
        // ì¹œê·¼í•œ í‘œí˜„ ì¶”ê°€
        if(!friendlyBody.contains('ğŸ˜Š')) {
            friendlyBody = friendlyBody.replace('ì•ˆë…•í•˜ì„¸ìš”', 'ì•ˆë…•í•˜ì„¸ìš” ğŸ˜Š');
        }
        
        // ê°ì • í‘œí˜„ ì¶”ê°€
        friendlyBody = friendlyBody.replace('ê°ì‚¬í•©ë‹ˆë‹¤', 'ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ™');
        friendlyBody = friendlyBody.replace('ì—°ë½ì£¼ì„¸ìš”', 'ì–¸ì œë“  í¸í•˜ê²Œ ì—°ë½ì£¼ì„¸ìš”');
        
        // ì´ëª¨ì§€ ì ì ˆíˆ ì¶”ê°€
        if(friendlyBody.contains('ì™„ë£Œ')) {
            friendlyBody = friendlyBody.replace('ì™„ë£Œ', 'ì™„ë£Œ âœ…');
        }
        
        return friendlyBody;
    }
    
    private static String addMoreDetails(String originalBody, String instructions) {
        String detailedBody = originalBody;
        
        // ìƒì„¸ ì •ë³´ ì„¹ì…˜ ì¶”ê°€
        if(instructions != null) {
            String additionalInfo = '\n\nğŸ“‹ ì¶”ê°€ ìƒì„¸ ì •ë³´:\n';
            additionalInfo += 'â€¢ ' + instructions + '\n';
            additionalInfo += 'â€¢ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ì—°ë½ì£¼ì„¸ìš”\n';
            additionalInfo += 'â€¢ ê´€ë ¨ ë¬¸ì„œë‚˜ ìë£Œê°€ í•„ìš”í•˜ì‹œë©´ ì œê³µí•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤\n';
            
            detailedBody = detailedBody + additionalInfo;
        }
        
        return detailedBody;
    }
    
    private static String shortenContent(String originalBody, String instructions) {
        String shortenedBody = originalBody;
        
        // ë¶ˆí•„ìš”í•œ ë¬¸êµ¬ ì œê±°
        shortenedBody = shortenedBody.replace('ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.', 'ì•ˆë‚´.');
        shortenedBody = shortenedBody.replace('ë¶€íƒë“œë¦½ë‹ˆë‹¤.', 'ë¶€íƒë“œë¦¼.');
        shortenedBody = shortenedBody.replace('ê°ì‚¬í•©ë‹ˆë‹¤.', 'ê°ì‚¬.');
        
        // ì¤‘ë³µ í‘œí˜„ ì œê±°
        shortenedBody = shortenedBody.replaceAll('\\n\\n\\n+', '\n\n');
        
        return shortenedBody;
    }
    
    private static String addActionItems(String originalBody, String instructions) {
        String actionBody = originalBody;
        
        // ì•¡ì…˜ ì•„ì´í…œ ì„¹ì…˜ ì¶”ê°€
        String actionSection = '\n\nâœ… í•„ìš”í•œ ì¡°ì¹˜ì‚¬í•­:\n';
        
        if(instructions != null && instructions.length() > 0) {
            actionSection += 'â€¢ ' + instructions + '\n';
        }
        
        actionSection += 'â€¢ íšŒì‹  ê¸°í•œ: ì˜ì—…ì¼ ê¸°ì¤€ 2ì¼ ì´ë‚´\n';
        actionSection += 'â€¢ ë‹´ë‹¹ì ì—°ë½ì²˜ë¡œ ì§„í–‰ìƒí™© ê³µìœ  ë¶€íƒë“œë¦½ë‹ˆë‹¤\n';
        
        actionBody = actionBody + actionSection;
        
        return actionBody;
    }
    
    private static String applyCustomRevisions(String originalBody, String instructions) {
        String customBody = originalBody;
        
        if(instructions != null && instructions.length() > 0) {
            // ë§ì¶¤ ìˆ˜ì • ì§€ì‹œì‚¬í•­ ì ìš©
            customBody = customBody + '\n\nğŸ“ ë§ì¶¤ ìˆ˜ì •ì‚¬í•­:\n';
            customBody = customBody + instructions + '\n';
        }
        
        return customBody;
    }
    
    // Input/Output Classes
    public class EmailRevisionRequest {
        @InvocableVariable(required=true)
        public String originalSubject;
        @InvocableVariable(required=true)
        public String originalBody;
        @InvocableVariable(required=true)
        public String revisionType; // Make_Urgent, Make_Formal, Make_Friendly, Add_Details, Shorten, Add_Action_Required, Custom
        @InvocableVariable
        public String revisionInstructions; // êµ¬ì²´ì ì¸ ìˆ˜ì • ì§€ì‹œì‚¬í•­
    }
    
    public class EmailRevisionResult {
        @InvocableVariable
        public Boolean success;
        @InvocableVariable
        public String errorMessage;
        @InvocableVariable
        public String revisedSubject;
        @InvocableVariable
        public String revisedBody;
        @InvocableVariable
        public String revisionType;
        @InvocableVariable
        public String originalSubject;
        @InvocableVariable
        public String originalBody;
    }
}
