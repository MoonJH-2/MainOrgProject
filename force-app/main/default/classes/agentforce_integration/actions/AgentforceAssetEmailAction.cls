/**
 * @description Agentforce Asset Renewal Email Action
 * @author AI Assistant
 * @created 2025-07-24
 */
public with sharing class AgentforceAssetEmailAction {
    
    /**
     * Asset ê°±ì‹  ì´ë©”ì¼ ì´ˆì•ˆ ìƒì„±
     */
    @InvocableMethod(label='Draft Asset Renewal Email' description='Asset ê°±ì‹  ë° ê´€ë ¨ ì´ë©”ì¼ ì´ˆì•ˆì„ ìƒì„±í•©ë‹ˆë‹¤')
    public static List<EmailDraftResult> draftAssetRenewalEmail(List<AssetEmailRequest> requests) {
        List<EmailDraftResult> results = new List<EmailDraftResult>();
        
        for(AssetEmailRequest request : requests) {
            EmailDraftResult result = new EmailDraftResult();
            
            try {
                // Asset ì •ë³´ ì¡°íšŒ
                List<Asset> assets = [
                    SELECT Id, Name, Account.Name, Account.Id, Product2.Name,
                           SerialNumber, InstallDate, UsageEndDate, Status,
                           ContactId, Contact.Email, Contact.Name,
                           AccountId, CreatedBy.Name, CreatedBy.Email
                    FROM Asset 
                    WHERE Id = :request.assetId 
                    LIMIT 1
                ];
                
                if(assets.isEmpty()) {
                    result.success = false;
                    result.errorMessage = 'Assetì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    results.add(result);
                    continue;
                }
                
                Asset assetRecord = assets[0];
                
                // ì´ë©”ì¼ í…œí”Œë¦¿ ìƒì„±
                String emailSubject = generateAssetEmailSubject(assetRecord, request.emailType);
                String emailBody = generateAssetEmailBody(assetRecord, request.emailType);
                
                result.emailSubject = emailSubject;
                result.emailBody = emailBody;
                result.recipientEmail = getAssetRecipientEmail(assetRecord);
                result.emailType = request.emailType;
                result.assetName = assetRecord.Name;
                result.success = true;
                
            } catch(Exception e) {
                result.success = false;
                result.errorMessage = 'Asset ì´ë©”ì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + e.getMessage();
            }
            
            results.add(result);
        }
        
        return results;
    }
    
    // Helper Methods
    private static String generateAssetEmailSubject(Asset assetRecord, String emailType) {
        String assetName = assetRecord.Name;
        String productName = assetRecord.Product2.Name;
        String subject = '';
        
        switch on emailType {
            when 'Renewal_Reminder' {
                subject = '[ê°±ì‹  ì•ˆë‚´] ' + productName + ' (' + assetName + ') ê°±ì‹  ì‹œê¸° ì•ˆë‚´';
            }
            when 'Maintenance_Schedule' {
                subject = '[ì •ë¹„ ì¼ì •] ' + productName + ' (' + assetName + ') ì •ê¸° ì •ë¹„ ì•ˆë‚´';
            }
            when 'Usage_Report' {
                subject = '[ì‚¬ìš© í˜„í™©] ' + productName + ' (' + assetName + ') ì›”ê°„ ì‚¬ìš© ë¦¬í¬íŠ¸';
            }
            when 'Contract_Expiry' {
                subject = '[ê³„ì•½ ë§Œë£Œ] ' + productName + ' (' + assetName + ') ê³„ì•½ ë§Œë£Œ ì„ë°• ì•ˆë‚´';
            }
            when else {
                subject = '[Asset ì•ˆë‚´] ' + productName + ' (' + assetName + ') ê´€ë ¨ ì•ˆë‚´';
            }
        }
        
        return subject;
    }
    
    private static String generateAssetEmailBody(Asset assetRecord, String emailType) {
        String body = '';
        String accountName = assetRecord.Account.Name;
        String assetName = assetRecord.Name;
        String productName = assetRecord.Product2.Name;
        String ownerName = assetRecord.CreatedBy.Name;
        
        body += 'ì•ˆë…•í•˜ì„¸ìš”, ' + accountName + ' ë‹´ë‹¹ìë‹˜\n\n';
        body += 'ë‹´ë‹¹ ì˜ì—…ì‚¬ì› ' + ownerName + 'ì…ë‹ˆë‹¤.\n\n';
        
        switch on emailType {
            when 'Renewal_Reminder' {
                Date expiryDate = assetRecord.UsageEndDate;
                
                body += 'ğŸ”„ Asset ê°±ì‹  ì‹œê¸°ê°€ ë‹¤ê°€ì™€ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.\n\n';
                body += 'Asset ì •ë³´:\n';
                body += 'â€¢ ì œí’ˆëª…: ' + productName + '\n';
                body += 'â€¢ Assetëª…: ' + assetName + '\n';
                body += 'â€¢ ì‹œë¦¬ì–¼: ' + assetRecord.SerialNumber + '\n';
                if(expiryDate != null) {
                    body += 'â€¢ ë§Œë£Œì˜ˆì •ì¼: ' + expiryDate.format() + '\n';
                }
                body += '\nê°±ì‹  ì ˆì°¨ ë° ì¡°ê±´ì— ëŒ€í•´ ìƒë‹´ì„ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.\n';
                body += 'í¸ë¦¬í•œ ì‹œê°„ì— ì—°ë½ ë¶€íƒë“œë¦½ë‹ˆë‹¤.\n';
            }
            when 'Maintenance_Schedule' {
                Date installDate = assetRecord.InstallDate;
                
                body += 'ğŸ”§ ì •ê¸° ì •ë¹„ ì¼ì •ì„ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.\n\n';
                body += 'ì •ë¹„ ëŒ€ìƒ:\n';
                body += 'â€¢ ì œí’ˆëª…: ' + productName + '\n';
                body += 'â€¢ Assetëª…: ' + assetName + '\n';
                if(installDate != null) {
                    body += 'â€¢ ì„¤ì¹˜ì¼: ' + installDate.format() + '\n';
                }
                body += '\nìµœì ì˜ ì„±ëŠ¥ ìœ ì§€ë¥¼ ìœ„í•´ ì •ê¸° ì •ë¹„ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n';
                body += 'ì •ë¹„ ì¼ì • ì¡°ìœ¨ì„ ìœ„í•´ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.\n';
            }
            when 'Usage_Report' {
                body += 'ğŸ“Š ì›”ê°„ ì‚¬ìš© í˜„í™©ì„ ë¦¬í¬íŠ¸í•´ ë“œë¦½ë‹ˆë‹¤.\n\n';
                body += 'ì‚¬ìš© í˜„í™©:\n';
                body += 'â€¢ ì œí’ˆëª…: ' + productName + '\n';
                body += 'â€¢ Assetëª…: ' + assetName + '\n';
                body += 'â€¢ ìƒíƒœ: ' + assetRecord.Status + '\n';
                body += '\nìì„¸í•œ ì‚¬ìš© ë°ì´í„°ëŠ” ì²¨ë¶€ íŒŒì¼ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.\n';
                body += 'ì¶”ê°€ ë¶„ì„ì´ë‚˜ ìµœì í™” ìƒë‹´ì´ í•„ìš”í•˜ì‹œë©´ ì—°ë½ì£¼ì„¸ìš”.\n';
            }
            when 'Contract_Expiry' {
                body += 'âš ï¸ ê³„ì•½ ë§Œë£Œê°€ ì„ë°•í•˜ì—¬ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.\n\n';
                body += 'ë§Œë£Œ ì˜ˆì • Asset:\n';
                body += 'â€¢ ì œí’ˆëª…: ' + productName + '\n';
                body += 'â€¢ Assetëª…: ' + assetName + '\n';
                body += '\nì„œë¹„ìŠ¤ ì—°ì†ì„±ì„ ìœ„í•´ ê³„ì•½ ì—°ì¥ ë˜ëŠ” ì‹ ê·œ ë„ì…ì„ ê²€í† í•´ ì£¼ì„¸ìš”.\n';
                body += 'ë§ì¶¤í˜• ì œì•ˆì„ ì¤€ë¹„í•˜ì—¬ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.\n';
            }
        }
        
        body += '\nê°ì‚¬í•©ë‹ˆë‹¤.\n';
        body += ownerName + '\n';
        body += 'ë¬¸ì˜: ' + assetRecord.CreatedBy.Email;
        
        return body;
    }
    
    private static String getAssetRecipientEmail(Asset assetRecord) {
        if(assetRecord.Contact != null && assetRecord.Contact.Email != null) {
            return assetRecord.Contact.Email;
        }
        // Fallback to Account ë‹´ë‹¹ì ì´ë©”ì¼ (ì‹¤ì œë¡œëŠ” Contactì—ì„œ ì¡°íšŒ)
        return 'assets@example.com'; // placeholder
    }
    
    // Input/Output Classes
    public class AssetEmailRequest {
        @InvocableVariable(required=true)
        public String assetId;
        @InvocableVariable(required=true)
        public String emailType; // Renewal_Reminder, Maintenance_Schedule, Usage_Report, Contract_Expiry
    }
    
    public class EmailDraftResult {
        @InvocableVariable
        public Boolean success;
        @InvocableVariable
        public String errorMessage;
        @InvocableVariable
        public String emailSubject;
        @InvocableVariable
        public String emailBody;
        @InvocableVariable
        public String recipientEmail;
        @InvocableVariable
        public String emailType;
        @InvocableVariable
        public String assetName;
    }
}
