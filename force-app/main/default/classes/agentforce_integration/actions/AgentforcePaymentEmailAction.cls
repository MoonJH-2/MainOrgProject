/**
 * @description Agentforce Payment Email Draft Action
 * @author AI Assistant
 * @created 2025-07-24
 */
public with sharing class AgentforcePaymentEmailAction {
    
    /**
     * Payment ì•Œë¦¼ ì´ë©”ì¼ ì´ˆì•ˆ ìƒì„±
     */
    @InvocableMethod(label='Draft Payment Email' description='Payment ìƒíƒœì— ë”°ë¥¸ ì•Œë¦¼ ì´ë©”ì¼ ì´ˆì•ˆì„ ìƒì„±í•©ë‹ˆë‹¤')
    public static List<EmailDraftResult> draftPaymentEmail(List<PaymentEmailRequest> requests) {
        List<EmailDraftResult> results = new List<EmailDraftResult>();
        
        for(PaymentEmailRequest request : requests) {
            EmailDraftResult result = new EmailDraftResult();
            
            try {
                // PaymentStatus ì •ë³´ ì¡°íšŒ - PaymentStatus ID ë˜ëŠ” Nameìœ¼ë¡œ ê²€ìƒ‰
                List<SObject> paymentRecords = new List<SObject>();
                
                // ë¨¼ì € PaymentStatus IDë¡œ ì‹œë„
                if(request.paymentId.length() >= 15) {
                    paymentRecords = Database.query(
                        'SELECT Id, Name, Order__c, Order__r.OrderNumber, Order__r.Account.Name, ' +
                        'Amount__c, DueDate__c, Status__c, Installment_Number__c, ' +
                        'Order__r.Owner.Name, Order__r.Owner.Email ' +
                        'FROM PaymentStatus__c WHERE Id = :request.paymentId LIMIT 1'
                    );
                }
                
                // PaymentStatus IDë¡œ ì°¾ì§€ ëª»í–ˆìœ¼ë©´ Nameìœ¼ë¡œ ê²€ìƒ‰
                if(paymentRecords.isEmpty()) {
                    paymentRecords = Database.query(
                        'SELECT Id, Name, Order__c, Order__r.OrderNumber, Order__r.Account.Name, ' +
                        'Amount__c, DueDate__c, Status__c, Installment_Number__c, ' +
                        'Order__r.Owner.Name, Order__r.Owner.Email ' +
                        'FROM PaymentStatus__c WHERE Name = :request.paymentId LIMIT 1'
                    );
                }
                
                if(paymentRecords.isEmpty()) {
                    result.success = false;
                    result.errorMessage = 'PaymentStatusë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    results.add(result);
                    continue;
                }
                
                SObject paymentRecord = paymentRecords[0];
                
                // ì´ë©”ì¼ í…œí”Œë¦¿ ìƒì„±
                String emailSubject = generatePaymentEmailSubject(paymentRecord, request.emailType);
                String emailBody = generatePaymentEmailBody(paymentRecord, request.emailType);
                
                result.emailSubject = emailSubject;
                result.emailBody = emailBody;
                result.recipientEmail = getPaymentRecipientEmail(paymentRecord);
                result.emailType = request.emailType;
                result.orderNumber = (String)paymentRecord.get('Order__r.OrderNumber');
                result.success = true;
                
            } catch(Exception e) {
                result.success = false;
                result.errorMessage = 'Payment ì´ë©”ì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + e.getMessage();
            }
            
            results.add(result);
        }
        
        return results;
    }
    
    // Helper Methods
    private static String generatePaymentEmailSubject(SObject paymentRecord, String emailType) {
        String orderNumber = (String)paymentRecord.get('Order__r.OrderNumber');
        String subject = '';
        
        switch on emailType {
            when 'Payment_Reminder' {
                subject = '[ê²°ì œ ì•ˆë‚´] Order ' + orderNumber + ' - ' + paymentRecord.get('Installment_Number__c') + 'íšŒì°¨ ê²°ì œ ì•ˆë‚´';
            }
            when 'Payment_Overdue' {
                subject = '[ì—°ì²´ ì•Œë¦¼] Order ' + orderNumber + ' - ê²°ì œ ì§€ì—° ì•ˆë‚´';
            }
            when 'Payment_Confirmation' {
                subject = '[ê²°ì œ ì™„ë£Œ] Order ' + orderNumber + ' - ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤';
            }
            when else {
                subject = '[ê²°ì œ ì•Œë¦¼] Order ' + orderNumber + ' ê²°ì œ ê´€ë ¨ ì•ˆë‚´';
            }
        }
        
        return subject;
    }
    
    private static String generatePaymentEmailBody(SObject paymentRecord, String emailType) {
        String body = '';
        String accountName = (String)paymentRecord.get('Order__r.Account.Name');
        String orderNumber = (String)paymentRecord.get('Order__r.OrderNumber');
        String ownerName = (String)paymentRecord.get('Order__r.Owner.Name');
        
        body += 'ì•ˆë…•í•˜ì„¸ìš”, ' + accountName + ' ë‹´ë‹¹ìë‹˜\n\n';
        body += 'ë‹´ë‹¹ ì˜ì—…ì‚¬ì› ' + ownerName + 'ì…ë‹ˆë‹¤.\n\n';
        
        switch on emailType {
            when 'Payment_Reminder' {
                Date dueDate = (Date)paymentRecord.get('DueDate__c');
                Decimal amount = (Decimal)paymentRecord.get('Amount__c');
                
                body += 'ğŸ’° ê²°ì œ ì˜ˆì • ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.\n\n';
                body += 'ê²°ì œ ì •ë³´:\n';
                body += 'â€¢ ì£¼ë¬¸ë²ˆí˜¸: ' + orderNumber + '\n';
                body += 'â€¢ íšŒì°¨: ' + paymentRecord.get('Installment_Number__c') + 'íšŒì°¨\n';
                body += 'â€¢ ê²°ì œê¸ˆì•¡: â‚©' + String.valueOf(amount) + '\n';
                body += 'â€¢ ê²°ì œì˜ˆì •ì¼: ' + dueDate.format() + '\n\n';
                body += 'ê²°ì œì¼ 3ì¼ ì „ ì•ˆë‚´ë“œë¦¬ë©°, ì¤€ë¹„í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.\n';
            }
            when 'Payment_Overdue' {
                body += 'âš ï¸ ê²°ì œê°€ ì§€ì—°ë˜ì–´ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.\n\n';
                body += 'ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ê²°ì œë¥¼ ì™„ë£Œí•´ ì£¼ì‹œê¸° ë°”ë¼ë©°,\n';
                body += 'ê²°ì œ ê´€ë ¨ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ë‹´ë‹¹ìì—ê²Œ ì—°ë½ì£¼ì„¸ìš”.\n';
            }
            when 'Payment_Confirmation' {
                body += 'âœ… ê²°ì œê°€ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n';
                body += 'ê²°ì œí•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.\n';
                body += 'ë‹¤ìŒ íšŒì°¨ ê²°ì œì¼ì´ ë‹¤ê°€ì˜¤ë©´ ë¯¸ë¦¬ ì•ˆë‚´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.\n';
            }
        }
        
        body += '\nê°ì‚¬í•©ë‹ˆë‹¤.\n';
        body += ownerName + '\n';
        body += 'ë¬¸ì˜: ' + paymentRecord.get('Order__r.Owner.Email');
        
        return body;
    }
    
    private static String getPaymentRecipientEmail(SObject paymentRecord) {
        // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” Account Contactì—ì„œ ì´ë©”ì¼ ì¡°íšŒ
        return 'finance@example.com'; // placeholder
    }
    
    // Input/Output Classes
    public class PaymentEmailRequest {
        @InvocableVariable(required=true)
        public String paymentId;
        @InvocableVariable(required=true)
        public String emailType; // Payment_Reminder, Payment_Overdue, Payment_Confirmation
    }
    
    public class EmailDraftResult {
        @InvocableVariable
        public Boolean success;
        @InvocableVariable
        public String errorMessage;
        @InvocableVariable
        public String emailSubject;
        @InvocableVariable
        public String emailBody;
        @InvocableVariable
        public String recipientEmail;
        @InvocableVariable
        public String emailType;
        @InvocableVariable
        public String orderNumber;
    }
}
