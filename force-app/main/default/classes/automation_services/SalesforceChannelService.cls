/**
 * @description Salesforce Channels ê°„ì†Œí™” ë²„ì „
 * @author JH Moon
 * @created 2025-07-22
 */
public with sharing class SalesforceChannelService {
    
    /**
     * Orderìš© Chatter Group ì±„ë„ ìƒì„±
     */
    public static Boolean createOrderChannel(Order orderInfo) {
        try {
            System.debug('ğŸ“¢ Order Channel ìƒì„± ì‹œì‘: ' + orderInfo.OrderNumber);
            
            // 1. Chatter Group ìƒì„±
            CollaborationGroup channelGroup = new CollaborationGroup();
            channelGroup.Name = 'Order-' + orderInfo.OrderNumber;
            channelGroup.Description = 'Order ' + orderInfo.OrderNumber + ' ì „ìš© ì±„ë„';
            channelGroup.CollaborationType = 'Private';
            channelGroup.IsArchived = false;
            channelGroup.CanHaveGuests = false;
            
            insert channelGroup;
            
            // 2. ë©¤ë²„ ì¶”ê°€
            addGroupMembers(channelGroup.Id, orderInfo);
            
            // 3. í™˜ì˜ ë©”ì‹œì§€
            postWelcomeMessage(channelGroup.Id, orderInfo);
            
            System.debug('âœ… Order Channel ìƒì„± ì™„ë£Œ: ' + channelGroup.Id);
            return true;
            
        } catch (Exception e) {
            System.debug('âŒ Order Channel ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
    }
    
    /**
     * ê·¸ë£¹ ë©¤ë²„ ì¶”ê°€
     */
    private static void addGroupMembers(String groupId, Order orderInfo) {
        try {
            List<CollaborationGroupMember> members = new List<CollaborationGroupMember>();
            
            // Order Owner ì¶”ê°€
            CollaborationGroupMember ownerMember = new CollaborationGroupMember();
            ownerMember.CollaborationGroupId = groupId;
            ownerMember.MemberId = orderInfo.OwnerId;
            ownerMember.CollaborationRole = 'Admin';
            members.add(ownerMember);
            
            // Account Owner ì¶”ê°€ (ë‹¤ë¥¸ ê²½ìš°)
            if (orderInfo.Account.OwnerId != orderInfo.OwnerId) {
                CollaborationGroupMember accountMember = new CollaborationGroupMember();
                accountMember.CollaborationGroupId = groupId;
                accountMember.MemberId = orderInfo.Account.OwnerId;
                accountMember.CollaborationRole = 'Standard';
                members.add(accountMember);
            }
            
            insert members;
            System.debug('âœ… ê·¸ë£¹ ë©¤ë²„ ì¶”ê°€ ì™„ë£Œ: ' + members.size() + 'ëª…');
            
        } catch (Exception e) {
            System.debug('âŒ ê·¸ë£¹ ë©¤ë²„ ì¶”ê°€ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * í™˜ì˜ ë©”ì‹œì§€ í¬ìŠ¤íŠ¸
     */
    private static void postWelcomeMessage(String groupId, Order orderInfo) {
        try {
            String message = 'ğŸ‰ Order ' + orderInfo.OrderNumber + ' ì±„ë„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!\n\n';
            message += 'ğŸ“‹ ì£¼ë¬¸ ì •ë³´:\n';
            message += 'â€¢ ê³ ê°: ' + orderInfo.Account.Name + '\n';
            message += 'â€¢ ì´ì•¡: â‚©' + orderInfo.TotalAmount.format() + '\n';
            message += 'â€¢ ìƒíƒœ: ' + orderInfo.Status + '\n';
            message += 'â€¢ ë‹´ë‹¹ì: ' + orderInfo.Owner.Name + '\n\n';
            message += 'ğŸ’¬ ì´ ì±„ë„ì—ì„œ ì£¼ë¬¸ ê´€ë ¨ ëª¨ë“  ì†Œí†µì„ ì§„í–‰í•˜ì„¸ìš”!';
            
            FeedItem post = new FeedItem();
            post.ParentId = groupId;
            post.Body = message;
            post.Type = 'TextPost';
            
            insert post;
            
            System.debug('âœ… í™˜ì˜ ë©”ì‹œì§€ í¬ìŠ¤íŠ¸ ì™„ë£Œ');
            
        } catch (Exception e) {
            System.debug('âŒ í™˜ì˜ ë©”ì‹œì§€ í¬ìŠ¤íŠ¸ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * ì±„ë„ì— ë©”ì‹œì§€ ë°œì†¡
     */
    public static Boolean sendChannelMessage(String channelId, String message) {
        try {
            FeedItem post = new FeedItem();
            post.ParentId = channelId;
            post.Body = message;
            post.Type = 'TextPost';
            
            insert post;
            return true;
            
        } catch (Exception e) {
            System.debug('âŒ ì±„ë„ ë©”ì‹œì§€ ë°œì†¡ ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
    }
    
    /**
     * Order Product ìë™í™” ì•Œë¦¼
     */
    public static void notifyOrderProductAutomation(List<Order> orders) {
        try {
            for (Order order : orders) {
                List<CollaborationGroup> groups = [
                    SELECT Id 
                    FROM CollaborationGroup 
                    WHERE Name = :('Order-' + order.OrderNumber)
                    LIMIT 1
                ];
                
                if (!groups.isEmpty()) {
                    String message = 'ğŸ¤– Order Product ìë™í™” ì™„ë£Œ!\n\n';
                    message += 'â€¢ Order: ' + order.OrderNumber + '\n';
                    message += 'â€¢ OrderProduct ìƒì„± ì™„ë£Œ\n';
                    message += 'â€¢ PDF ë¬¸ì„œ ìƒì„± ì™„ë£Œ\n';
                    message += 'â€¢ ì±„ë„ í™œì„±í™” ì™„ë£Œ\n\n';
                    message += 'ğŸ“ ê´€ë ¨ ë¬¸ì„œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
                    
                    sendChannelMessage(groups[0].Id, message);
                }
            }
        } catch (Exception e) {
            System.debug('âŒ Order Product ìë™í™” ì•Œë¦¼ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
}
