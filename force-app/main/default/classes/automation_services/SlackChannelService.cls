/**
 * @description Slack ì±„ë„ ìƒì„± ë° ê´€ë¦¬ ì„œë¹„ìŠ¤
 * @author JH Moon
 * @last modified on 07-21-2025
 * @last modified by JH Moon
 */
public with sharing class SlackChannelService {
    
    // Slack API ì„¤ì • (ì‹¤ì œ êµ¬í˜„ ì‹œ Custom Settingì—ì„œ ê´€ë¦¬)
    private static final String SLACK_API_BASE_URL = 'https://slack.com/api/';
    private static final String CHANNEL_CREATE_ENDPOINT = 'conversations.create';
    private static final String MESSAGE_POST_ENDPOINT = 'chat.postMessage';
    
    /**
     * Orderìš© Slack ì±„ë„ ìƒì„±
     */
    public static Boolean createOrderChannel(Order orderInfo) {
        try {
            System.debug('ğŸ’¬ Slack ì±„ë„ ìƒì„± ì‹œì‘: Order ' + orderInfo.OrderNumber);
            
            // 1. Slack Bot Token ì¡°íšŒ
            String botToken = getSlackBotToken();
            if (String.isBlank(botToken)) {
                System.debug('âŒ Slack Bot Tokenì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            // 2. ì±„ë„ ì´ë¦„ ìƒì„± (Order Number ê¸°ë°˜)
            String channelName = generateChannelName(orderInfo.OrderNumber);
            
            // 3. Slack API í˜¸ì¶œ - ì±„ë„ ìƒì„±
            String channelId = createSlackChannel(channelName, orderInfo, botToken);
            
            if (String.isNotBlank(channelId)) {
                // 4. Orderì— Slack ì •ë³´ ì—…ë°ì´íŠ¸
                updateOrderSlackInfo(orderInfo.Id, channelId, channelName);
                
                // 5. í™˜ì˜ ë©”ì‹œì§€ ë°œì†¡
                sendWelcomeMessage(channelId, orderInfo, botToken);
                
                System.debug('âœ… Slack ì±„ë„ ìƒì„± ì™„ë£Œ: #' + channelName + ' (ID: ' + channelId + ')');
                return true;
            } else {
                System.debug('âŒ Slack ì±„ë„ ìƒì„± ì‹¤íŒ¨: Order ' + orderInfo.OrderNumber);
                return false;
            }
            
        } catch (Exception e) {
            System.debug('âŒ Slack ì±„ë„ ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
            System.debug('Stack Trace: ' + e.getStackTraceString());
            return false;
        }
    }
    
    /**
     * Slack APIë¥¼ í†µí•œ ì±„ë„ ìƒì„±
     */
    private static String createSlackChannel(String channelName, Order orderInfo, String botToken) {
        try {
            Http http = new Http();
            HttpRequest request = new HttpRequest();
            request.setEndpoint(SLACK_API_BASE_URL + CHANNEL_CREATE_ENDPOINT);
            request.setMethod('POST');
            request.setHeader('Authorization', 'Bearer ' + botToken);
            request.setHeader('Content-Type', 'application/json');
            request.setTimeout(10000); // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
            
            // ìš”ì²­ í˜ì´ë¡œë“œ ìƒì„±
            Map<String, Object> payload = new Map<String, Object>{
                'name' => channelName,
                'is_private' => false,
                'is_channel' => true
            };
            
            request.setBody(JSON.serialize(payload));
            
            HttpResponse response = http.send(request);
            
            if (response.getStatusCode() == 200) {
                Map<String, Object> responseBody = (Map<String, Object>)JSON.deserializeUntyped(response.getBody());
                Boolean ok = (Boolean)responseBody.get('ok');
                
                if (ok) {
                    Map<String, Object> channel = (Map<String, Object>)responseBody.get('channel');
                    String channelId = (String)channel.get('id');
                    
                    System.debug('âœ… Slack ì±„ë„ ìƒì„± API ì„±ê³µ: ' + channelId);
                    return channelId;
                } else {
                    String error = (String)responseBody.get('error');
                    System.debug('âŒ Slack API ì˜¤ë¥˜: ' + error);
                    
                    // ì±„ë„ì´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš° ê¸°ì¡´ ì±„ë„ ID ë°˜í™˜
                    if (error == 'name_taken') {
                        System.debug('âš ï¸ ì±„ë„ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ê¸°ì¡´ ì±„ë„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                        return getExistingChannelId(channelName, botToken);
                    }
                    return null;
                }
            } else {
                System.debug('âŒ Slack API HTTP ì˜¤ë¥˜: ' + response.getStatusCode() + ' - ' + response.getBody());
                return null;
            }
            
        } catch (Exception e) {
            System.debug('âŒ Slack ì±„ë„ ìƒì„± API í˜¸ì¶œ ì˜¤ë¥˜: ' + e.getMessage());
            return null;
        }
    }
    
    /**
     * ê¸°ì¡´ ì±„ë„ ID ì¡°íšŒ (ì±„ë„ëª…ì´ ì¤‘ë³µì¸ ê²½ìš°)
     */
    private static String getExistingChannelId(String channelName, String botToken) {
        try {
            // conversations.list APIë¥¼ í†µí•´ ê¸°ì¡´ ì±„ë„ ì¡°íšŒ
            Http http = new Http();
            HttpRequest request = new HttpRequest();
            request.setEndpoint(SLACK_API_BASE_URL + 'conversations.list?types=public_channel&limit=1000');
            request.setMethod('GET');
            request.setHeader('Authorization', 'Bearer ' + botToken);
            request.setTimeout(10000);
            
            HttpResponse response = http.send(request);
            
            if (response.getStatusCode() == 200) {
                Map<String, Object> responseBody = (Map<String, Object>)JSON.deserializeUntyped(response.getBody());
                Boolean ok = (Boolean)responseBody.get('ok');
                
                if (ok) {
                    List<Object> channels = (List<Object>)responseBody.get('channels');
                    for (Object channelObj : channels) {
                        Map<String, Object> channel = (Map<String, Object>)channelObj;
                        if (channelName.equals((String)channel.get('name'))) {
                            return (String)channel.get('id');
                        }
                    }
                }
            }
            
            return null;
            
        } catch (Exception e) {
            System.debug('âŒ ê¸°ì¡´ ì±„ë„ ID ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage());
            return null;
        }
    }
    
    /**
     * ì±„ë„ëª… ìƒì„± (Order Number ê¸°ë°˜)
     */
    private static String generateChannelName(String orderNumber) {
        // Slack ì±„ë„ëª… ê·œì¹™: ì†Œë¬¸ì, ìˆ«ì, í•˜ì´í”ˆ, ì–¸ë”ìŠ¤ì½”ì–´ë§Œ í—ˆìš©
        return orderNumber.toLowerCase().replaceAll('[^a-z0-9\\-_]', '');
    }
    
    /**
     * Orderì— Slack ì •ë³´ ì—…ë°ì´íŠ¸
     */
    private static void updateOrderSlackInfo(Id orderId, String channelId, String channelName) {
        try {
            Order orderToUpdate = new Order();
            orderToUpdate.Id = orderId;
            orderToUpdate.Slack_Channel_ID__c = channelId;
            orderToUpdate.Slack_Channel_Name__c = channelName;
            orderToUpdate.Slack_Notification_Status__c = 'Created';
            
            update orderToUpdate;
            
            System.debug('âœ… Order Slack ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ' + channelName);
            
        } catch (Exception e) {
            System.debug('âŒ Order Slack ì •ë³´ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * í™˜ì˜ ë©”ì‹œì§€ ë°œì†¡
     */
    private static void sendWelcomeMessage(String channelId, Order orderInfo, String botToken) {
        try {
            Http http = new Http();
            HttpRequest request = new HttpRequest();
            request.setEndpoint(SLACK_API_BASE_URL + MESSAGE_POST_ENDPOINT);
            request.setMethod('POST');
            request.setHeader('Authorization', 'Bearer ' + botToken);
            request.setHeader('Content-Type', 'application/json');
            request.setTimeout(10000);
            
            // í™˜ì˜ ë©”ì‹œì§€ ìƒì„±
            String welcomeMessage = createWelcomeMessage(orderInfo);
            
            Map<String, Object> payload = new Map<String, Object>{
                'channel' => channelId,
                'text' => welcomeMessage,
                'username' => 'Salesforce Bot',
                'icon_emoji' => ':robot_face:'
            };
            
            request.setBody(JSON.serialize(payload));
            
            HttpResponse response = http.send(request);
            
            if (response.getStatusCode() == 200) {
                Map<String, Object> responseBody = (Map<String, Object>)JSON.deserializeUntyped(response.getBody());
                Boolean ok = (Boolean)responseBody.get('ok');
                
                if (ok) {
                    System.debug('âœ… í™˜ì˜ ë©”ì‹œì§€ ë°œì†¡ ì™„ë£Œ');
                } else {
                    System.debug('âŒ í™˜ì˜ ë©”ì‹œì§€ ë°œì†¡ ì‹¤íŒ¨: ' + responseBody.get('error'));
                }
            } else {
                System.debug('âŒ í™˜ì˜ ë©”ì‹œì§€ HTTP ì˜¤ë¥˜: ' + response.getStatusCode());
            }
            
        } catch (Exception e) {
            System.debug('âŒ í™˜ì˜ ë©”ì‹œì§€ ë°œì†¡ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * í™˜ì˜ ë©”ì‹œì§€ ë‚´ìš© ìƒì„±
     */
    private static String createWelcomeMessage(Order orderInfo) {
        String message = 'ğŸ‰ *Order ' + orderInfo.OrderNumber + ' ì±„ë„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!*\n\n';
        message += 'ğŸ“‹ *Order ì •ë³´*\n';
        message += 'â€¢ Customer: ' + orderInfo.Account.Name + '\n';
        message += 'â€¢ Amount: â‚©' + orderInfo.TotalAmount.format() + '\n';
        message += 'â€¢ Payment Method: ' + orderInfo.Payment_Method__c + '\n';
        message += 'â€¢ Status: ' + orderInfo.Status + '\n\n';
        
        // Order Items ì •ë³´ ì¶”ê°€
        if (!orderInfo.OrderItems.isEmpty()) {
            message += 'ğŸ›’ *Products*\n';
            for (OrderItem item : orderInfo.OrderItems) {
                message += 'â€¢ ' + item.Product2.Name + ' (Qty: ' + item.Quantity + ')\n';
            }
            message += '\n';
        }
        
        message += 'ğŸ“ *ê´€ë ¨ ë¬¸ì„œ*\n';
        message += 'â€¢ Order Product ìƒì„¸ì„œ.pdf\n';
        message += 'â€¢ ë‚©ë¶€ ì¼ì •ì„œ.pdf\n\n';
        message += 'ğŸ’¬ ì´ ì±„ë„ì—ì„œ ì£¼ë¬¸ê³¼ ê´€ë ¨ëœ ëª¨ë“  ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ì„ ì§„í–‰í•˜ì„¸ìš”!\n';
        message += 'ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë©”ì‹œì§€ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”. ğŸ“';
        
        return message;
    }
    
    /**
     * Slack Bot Token ì¡°íšŒ (Custom Settingì—ì„œ ê´€ë¦¬)
     */
    private static String getSlackBotToken() {
        try {
            // ì‹¤ì œ êµ¬í˜„ ì‹œ Custom Setting ë˜ëŠ” Custom Metadataì—ì„œ í† í° ì¡°íšŒ
            // í˜„ì¬ëŠ” ë”ë¯¸ í† í° ë°˜í™˜ (í…ŒìŠ¤íŠ¸ìš©)
            
            // Custom Setting ì˜ˆì‹œ:
            // Slack_Settings__c settings = Slack_Settings__c.getInstance();
            // return settings.Bot_Token__c;
            
            // í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ í† í° (ì‹¤ì œ êµ¬í˜„ ì‹œ ì‹¤ì œ í† í°ìœ¼ë¡œ êµì²´ í•„ìš”)
            System.debug('âš ï¸ í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ë”ë¯¸ Slack Bot Token ì‚¬ìš©');
            return 'xoxb-test-token-for-development';
            
        } catch (Exception e) {
            System.debug('âŒ Slack Bot Token ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage());
            return null;
        }
    }
    
    /**
     * ì±„ë„ì— ë©”ì‹œì§€ ë°œì†¡ (ê³µí†µ ë©”ì„œë“œ)
     */
    public static Boolean sendChannelMessage(String channelId, String message) {
        try {
            String botToken = getSlackBotToken();
            if (String.isBlank(botToken)) {
                return false;
            }
            
            Http http = new Http();
            HttpRequest request = new HttpRequest();
            request.setEndpoint(SLACK_API_BASE_URL + MESSAGE_POST_ENDPOINT);
            request.setMethod('POST');
            request.setHeader('Authorization', 'Bearer ' + botToken);
            request.setHeader('Content-Type', 'application/json');
            request.setTimeout(10000);
            
            Map<String, Object> payload = new Map<String, Object>{
                'channel' => channelId,
                'text' => message,
                'username' => 'Salesforce Bot',
                'icon_emoji' => ':robot_face:'
            };
            
            request.setBody(JSON.serialize(payload));
            
            HttpResponse response = http.send(request);
            return response.getStatusCode() == 200;
            
        } catch (Exception e) {
            System.debug('âŒ Slack ë©”ì‹œì§€ ë°œì†¡ ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
    }
}
