/**
 * @description Order ì™„ë‚© ì‹œ Asset ìë™ ìƒì„± ì„œë¹„ìŠ¤
 * @author JH Moon
 * @created 2025-07-22
 */
public with sharing class OrderAssetCreationService {
    
    /**
     * Order ì™„ë‚© ì‹œ Asset ìƒì„± (ë©”ì¸ ë©”ì„œë“œ)
     */
    public static List<Asset> createAssetsForCompletedOrders(List<Id> orderIds) {
        List<Asset> createdAssets = new List<Asset>();
        
        try {
            // 1. Order ì •ë³´ ì¡°íšŒ (Payment Schedule í¬í•¨)
            List<Order> ordersWithDetails = getOrdersWithPaymentDetails(orderIds);
            
            for (Order order : ordersWithDetails) {
                // 2. ì™„ë‚© ì—¬ë¶€ í™•ì¸
                if (isOrderFullyPaid(order)) {
                    // 3. ê¸°ì¡´ Asset ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                    if (!hasExistingAsset(order.Id)) {
                        // 4. Asset ìƒì„±
                        Asset newAsset = createAssetFromOrder(order);
                        if (newAsset != null) {
                            createdAssets.add(newAsset);
                        }
                    } else {
                        System.debug('â„¹ï¸ Order ' + order.OrderNumber + 'ì— ëŒ€í•œ Assetì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.');
                    }
                }
            }
            
            // 5. Asset ì¼ê´„ ìƒì„±
            if (!createdAssets.isEmpty()) {
                insert createdAssets;
                System.debug('âœ… Asset ìƒì„± ì™„ë£Œ: ' + createdAssets.size() + 'ê°œ');
                
                // 6. Asset ìƒì„± í›„ í›„ì† ì‘ì—…
                processPostAssetCreation(createdAssets);
            }
            
        } catch (Exception e) {
            System.debug('âŒ Asset ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
            System.debug('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
        }
        
        return createdAssets;
    }
    
    /**
     * Order ìƒì„¸ ì •ë³´ ì¡°íšŒ (Payment Schedule í¬í•¨)
     */
    private static List<Order> getOrdersWithPaymentDetails(List<Id> orderIds) {
        return [
            SELECT Id, OrderNumber, AccountId, Contact__c, OwnerId, Owner.Name,
                   ActivatedDate, OrderStartDate, OrderEndDate, TotalAmount, Status,
                   Payment_Method__c, Account.Name,
                   (SELECT Id, Payment_Status__c, Amount__c, Due_Date__c 
                    FROM Payment_Schedules__r),
                   (SELECT Id, Product2Id, Product2.Name, Quantity, UnitPrice, TotalPrice
                    FROM OrderItems)
            FROM Order 
            WHERE Id IN :orderIds
        ];
    }
    
    /**
     * Order ì™„ë‚© ì—¬ë¶€ í™•ì¸
     */
    private static Boolean isOrderFullyPaid(Order order) {
        if (order.Payment_Schedules__r.isEmpty()) {
            return false;
        }
        
        Integer totalSchedules = order.Payment_Schedules__r.size();
        Integer completedSchedules = 0;
        
        for (Payment_Schedule__c schedule : order.Payment_Schedules__r) {
            if (schedule.Payment_Status__c == 'ì™„ë‚©') {
                completedSchedules++;
            }
        }
        
        Boolean isFullyPaid = (completedSchedules == totalSchedules);
        System.debug('Order ' + order.OrderNumber + ' ì™„ë‚© ìƒíƒœ: ' + completedSchedules + '/' + totalSchedules + ' = ' + isFullyPaid);
        
        return isFullyPaid;
    }
    
    /**
     * ê¸°ì¡´ Asset ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (SerialNumber ê¸°ë°˜)
     */
    private static Boolean hasExistingAsset(Id orderId) {
        // Order Numberë¡œ ê¸°ì¡´ Asset í™•ì¸
        List<Order> orders = [SELECT OrderNumber FROM Order WHERE Id = :orderId LIMIT 1];
        if (orders.isEmpty()) {
            return false;
        }
        
        List<Asset> existingAssets = [
            SELECT Id FROM Asset 
            WHERE SerialNumber = :orders[0].OrderNumber
            LIMIT 1
        ];
        
        return !existingAssets.isEmpty();
    }
    
    /**
     * Orderë¡œë¶€í„° Asset ìƒì„±
     */
    private static Asset createAssetFromOrder(Order order) {
        try {
            Asset newAsset = new Asset();
            
            // ê¸°ë³¸ ì •ë³´
            newAsset.Name = 'Order ' + order.OrderNumber + ' Asset';
            newAsset.AccountId = order.AccountId;
            newAsset.ContactId = order.Contact__c;
            
            // Order ì—°ê²° (ì»¤ìŠ¤í…€ í•„ë“œ Order__cê°€ ì—†ëŠ” ê²½ìš° ëŒ€ì•ˆ)
            newAsset.SerialNumber = order.OrderNumber; // Order Numberë¡œ ì—°ê²°
            
            // ë‚ ì§œ ì •ë³´
            newAsset.PurchaseDate = order.ActivatedDate != null ? order.ActivatedDate.date() : Date.today();
            newAsset.InstallDate = order.OrderStartDate;
            newAsset.UsageEndDate = order.OrderEndDate;
            
            // ê°€ê²© ì •ë³´
            newAsset.Price = order.TotalAmount;
            
            // ìƒíƒœ ì •ë³´
            newAsset.Status = 'Purchased';
            
            // ì œí’ˆ ì •ë³´ (OrderItemì—ì„œ ì²« ë²ˆì§¸ ì œí’ˆ ì‚¬ìš©)
            if (!order.OrderItems.isEmpty()) {
                OrderItem firstItem = order.OrderItems[0];
                newAsset.Product2Id = firstItem.Product2Id;
                newAsset.Quantity = Integer.valueOf(firstItem.Quantity);
                
                // Asset Nameì— ì œí’ˆëª… í¬í•¨
                if (firstItem.Product2 != null) {
                    newAsset.Name = order.Account.Name + ' - ' + firstItem.Product2.Name;
                }
            }
            
            // ì„¤ëª… ì¶”ê°€ (Order IDë„ í¬í•¨í•˜ì—¬ ì—­ì¶”ì  ê°€ëŠ¥)
            newAsset.Description = 'Order ' + order.OrderNumber + ' ì™„ë‚©ìœ¼ë¡œ ìƒì„±ëœ ê³ ê° ìì‚°\n' +
                                 'Order ID: ' + order.Id + '\n' +
                                 'ë‚©ë¶€ ë°©ì‹: ' + order.Payment_Method__c + '\n' +
                                 'ì™„ë‚©ì¼: ' + Date.today().format() + '\n' +
                                 'ë‹´ë‹¹ì: ' + order.Owner.Name;
            
            System.debug('âœ… Asset ìƒì„± ì¤€ë¹„ ì™„ë£Œ: ' + newAsset.Name);
            return newAsset;
            
        } catch (Exception e) {
            System.debug('âŒ Asset ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
            return null;
        }
    }
    
    /**
     * Asset ìƒì„± í›„ í›„ì† ì‘ì—…
     */
    private static void processPostAssetCreation(List<Asset> createdAssets) {
        try {
            // 1. ì˜ì—…ì‚¬ì›ì—ê²Œ Asset ìƒì„± ì•Œë¦¼ Task ìƒì„±
            List<Task> notificationTasks = new List<Task>();
            
            for (Asset asset : createdAssets) {
                Task assetNotificationTask = new Task();
                assetNotificationTask.Subject = 'ê³ ê° Asset ìƒì„± ì™„ë£Œ - ' + asset.Name;
                assetNotificationTask.Description = 'ì™„ë‚© ì™„ë£Œë¡œ ì¸í•œ ê³ ê° Assetì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n' +
                                                  'ğŸ“‹ Asset: ' + asset.Name + '\n' +
                                                  'ğŸ’° ê°€ê²©: â‚©' + String.valueOf(asset.Price) + '\n' +
                                                  'ğŸ“… êµ¬ë§¤ì¼: ' + asset.PurchaseDate + '\n' +
                                                  'ğŸ“… ì¢…ë£Œì¼: ' + asset.UsageEndDate + '\n\n' +
                                                  'ğŸ’¡ ê°±ì‹  ì˜ì—… ê¸°íšŒë¥¼ ê²€í† í•˜ì„¸ìš”!';
                assetNotificationTask.ActivityDate = Date.today().addDays(7); // 1ì£¼ì¼ í›„
                assetNotificationTask.Priority = 'Normal';
                assetNotificationTask.Status = 'Not Started';
                assetNotificationTask.WhatId = asset.Id; // Asset ì—°ê²°
                
                // Assetì˜ Account Ownerì—ê²Œ í• ë‹¹
                List<Account> accounts = [SELECT OwnerId FROM Account WHERE Id = :asset.AccountId LIMIT 1];
                if (!accounts.isEmpty()) {
                    assetNotificationTask.OwnerId = accounts[0].OwnerId;
                }
                
                notificationTasks.add(assetNotificationTask);
            }
            
            if (!notificationTasks.isEmpty()) {
                insert notificationTasks;
                System.debug('âœ… Asset ìƒì„± ì•Œë¦¼ Task ìƒì„± ì™„ë£Œ: ' + notificationTasks.size() + 'ê°œ');
            }
            
            // 2. Salesforce ì±„ë„ì— Asset ìƒì„± ì•Œë¦¼
            notifyAssetCreationToChannels(createdAssets);
            
            // 3. ê°±ì‹  ì•Œë¦¼ ìŠ¤ì¼€ì¤„ë§ (6ê°œì›” ì „)
            scheduleRenewalReminders(createdAssets);
            
        } catch (Exception e) {
            System.debug('âŒ Asset í›„ì† ì‘ì—… ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * Salesforce ì±„ë„ì— Asset ìƒì„± ì•Œë¦¼
     */
    private static void notifyAssetCreationToChannels(List<Asset> createdAssets) {
        try {
            for (Asset asset : createdAssets) {
                // Orderì— ì—°ê²°ëœ Salesforce ì±„ë„ ì°¾ê¸°
                List<Order> orders = [SELECT OrderNumber FROM Order WHERE Id = :asset.Order__c LIMIT 1];
                if (!orders.isEmpty()) {
                    String orderNumber = orders[0].OrderNumber;
                    
                    List<CollaborationGroup> channels = [
                        SELECT Id FROM CollaborationGroup 
                        WHERE Name LIKE :('%' + orderNumber + '%')
                        LIMIT 1
                    ];
                    
                    if (!channels.isEmpty()) {
                        String message = 'ğŸ‰ ê³ ê° Asset ìƒì„± ì™„ë£Œ!\n\n' +
                                       'ğŸ“‹ Asset: ' + asset.Name + '\n' +
                                       'ğŸ’° ê°€ê²©: â‚©' + String.valueOf(asset.Price) + '\n' +
                                       'ğŸ“… êµ¬ë§¤ì¼: ' + asset.PurchaseDate + '\n' +
                                       'ğŸ“… ì‚¬ìš© ì¢…ë£Œì¼: ' + asset.UsageEndDate + '\n\n' +
                                       'âœ… ì™„ë‚©ì´ ì™„ë£Œë˜ì–´ ê³ ê° ìì‚°ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\n' +
                                       'ğŸ’¡ ê°±ì‹  ì˜ì—… ê¸°íšŒë¥¼ ë†“ì¹˜ì§€ ë§ˆì„¸ìš”!\n\n' +
                                       '#AssetManagement #ê³ ê°ê´€ë¦¬ #ê°±ì‹ ì˜ì—…';
                        
                        SimpleSalesforceChannelService.sendChannelMessage(channels[0].Id, message);
                    }
                }
            }
        } catch (Exception e) {
            System.debug('âŒ ì±„ë„ ì•Œë¦¼ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * ê°±ì‹  ì•Œë¦¼ ìŠ¤ì¼€ì¤„ë§
     */
    private static void scheduleRenewalReminders(List<Asset> createdAssets) {
        try {
            List<Task> renewalTasks = new List<Task>();
            
            for (Asset asset : createdAssets) {
                if (asset.UsageEndDate != null) {
                    // ì¢…ë£Œì¼ 6ê°œì›” ì „ì— ê°±ì‹  ì•Œë¦¼ Task ìƒì„±
                    Date reminderDate = asset.UsageEndDate.addMonths(-6);
                    
                    if (reminderDate > Date.today()) {
                        Task renewalTask = new Task();
                        renewalTask.Subject = 'ê°±ì‹  ì˜ì—… ê¸°íšŒ - ' + asset.Name;
                        renewalTask.Description = 'ê³ ê° Asset ê°±ì‹  ì‹œì ì´ ë‹¤ê°€ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.\n\n' +
                                                'ğŸ“‹ Asset: ' + asset.Name + '\n' +
                                                'ğŸ“… ì¢…ë£Œì¼: ' + asset.UsageEndDate + '\n' +
                                                'ğŸ’° ê¸°ì¡´ ê°€ê²©: â‚©' + String.valueOf(asset.Price) + '\n\n' +
                                                'ğŸ’¡ ê°±ì‹  ì œì•ˆì„ ì¤€ë¹„í•˜ì„¸ìš”!';
                        renewalTask.ActivityDate = reminderDate;
                        renewalTask.Priority = 'High';
                        renewalTask.Status = 'Not Started';
                        renewalTask.WhatId = asset.Id;
                        
                        // Assetì˜ Account Ownerì—ê²Œ í• ë‹¹
                        List<Account> accounts = [SELECT OwnerId FROM Account WHERE Id = :asset.AccountId LIMIT 1];
                        if (!accounts.isEmpty()) {
                            renewalTask.OwnerId = accounts[0].OwnerId;
                        }
                        
                        renewalTasks.add(renewalTask);
                    }
                }
            }
            
            if (!renewalTasks.isEmpty()) {
                insert renewalTasks;
                System.debug('âœ… ê°±ì‹  ì•Œë¦¼ Task ìŠ¤ì¼€ì¤„ë§ ì™„ë£Œ: ' + renewalTasks.size() + 'ê°œ');
            }
            
        } catch (Exception e) {
            System.debug('âŒ ê°±ì‹  ì•Œë¦¼ ìŠ¤ì¼€ì¤„ë§ ì¤‘ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * íŠ¹ì • Orderì˜ Asset ìƒì„± (ë‹¨ì¼)
     */
    public static Asset createAssetForOrder(Id orderId) {
        List<Asset> assets = createAssetsForCompletedOrders(new List<Id>{orderId});
        return assets.isEmpty() ? null : assets[0];
    }
}
