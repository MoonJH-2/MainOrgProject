/**
 * @description Order ê´€ë ¨ Sales ì•± ì•Œë¦¼ ì„œë¹„ìŠ¤
 * AccountTriggerHandler.cls íŒ¨í„´ ì°¸ì¡°í•˜ì—¬ êµ¬í˜„
 * @author JH Moon
 * @last modified on 07-21-2025
 * @last modified by JH Moon
 */
public with sharing class OrderNotificationService {
    
    /**
     * Order ìƒì„± ì‹œ Sales ì•± ì•Œë¦¼ ë°œì†¡
     */
    public static void notifyOrderCreated(List<Order> orders) {
        try {
            if (orders == null || orders.isEmpty()) {
                System.debug('âš ï¸ notifyOrderCreated: ì „ë‹¬ëœ Order ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            System.debug('ğŸ‰ Order ìƒì„± ì•Œë¦¼ ë°œì†¡ ì‹œì‘: ' + orders.size() + 'ê°œ');
            
            // CustomNotificationType í™•ì¸
            List<CustomNotificationType> salesNotificationTypes = [
                SELECT Id, DeveloperName
                FROM CustomNotificationType
                WHERE DeveloperName = 'Sales_Order_Notification'
                LIMIT 1
            ];
            
            if (salesNotificationTypes.isEmpty()) {
                System.debug('âŒ Sales_Order_Notification CustomNotificationTypeì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                System.debug('   Setup > Custom Notification Typesì—ì„œ ìƒì„±ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            for (Order ord : orders) {
                if (ord.Account == null || String.isBlank(ord.Account.Name)) {
                    System.debug('âš ï¸ Order ' + ord.OrderNumber + ': Account ì •ë³´ê°€ ì—†ì–´ ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
                    continue;
                }
                
                String title = 'ğŸ‰ ìƒˆ ì£¼ë¬¸ ìƒì„±';
                String body = ord.Account.Name + ' - Order ' + ord.OrderNumber + 
                             ' (â‚©' + ord.TotalAmount.format() + ')';
                
                System.debug('ğŸ“¤ ì•Œë¦¼ ë°œì†¡: ' + title + ' - ' + body);
                sendSalesNotification(title, body, ord.Id, 'Order_Created');
            }
            
            System.debug('âœ… Order ìƒì„± ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ');
            
        } catch (Exception e) {
            System.debug('âŒ Order ìƒì„± ì•Œë¦¼ ì˜¤ë¥˜: ' + e.getMessage());
            System.debug('âŒ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
        }
    }
    
    /**
     * ì—°ì²´ ìƒíƒœ ë°œìƒ ì‹œ Sales ì•± ì•Œë¦¼ ë°œì†¡
     */
    public static void notifyOverduePayments(List<PaymentStatus__c> overduePayments) {
        try {
            if (overduePayments.isEmpty()) return;
            
            System.debug('ğŸš¨ ì—°ì²´ ì•Œë¦¼ ë°œì†¡ ì‹œì‘: ' + overduePayments.size() + 'ê°œ');
            
            for (PaymentStatus__c payment : overduePayments) {
                // ì—°ì²´ ì¼ìˆ˜ ê³„ì‚°
                Integer overdueDays = Date.today().daysBetween(payment.DueDate__c);
                
                String title = 'ğŸš¨ ë‚©ë¶€ ì—°ì²´ ë°œìƒ';
                String body = payment.Order__r.Account.Name + ' - ' + 
                             payment.InstallmentNumber__c + 'ì°¨ ë‚©ë¶€ ì—°ì²´ (' + 
                             Math.abs(overdueDays) + 'ì¼)';
                
                sendSalesNotification(title, body, payment.Order__c, 'Payment_Overdue');
            }
            
            System.debug('âœ… ì—°ì²´ ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ');
            
        } catch (Exception e) {
            System.debug('âŒ ì—°ì²´ ì•Œë¦¼ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * Slack ì±„ë„ ìƒì„± ì‹œ Sales ì•± ì•Œë¦¼ ë°œì†¡
     */
    public static void notifySlackChannelCreated(List<Order> orders) {
        try {
            List<Order> ordersWithSlack = new List<Order>();
            
            for (Order ord : orders) {
                if (String.isNotBlank(ord.Slack_Channel_Name__c) && 
                    ord.Slack_Notification_Status__c == 'Created') {
                    ordersWithSlack.add(ord);
                }
            }
            
            if (ordersWithSlack.isEmpty()) return;
            
            System.debug('ğŸ“¢ Slack ì±„ë„ ìƒì„± ì•Œë¦¼ ë°œì†¡ ì‹œì‘: ' + ordersWithSlack.size() + 'ê°œ');
            
            for (Order ord : ordersWithSlack) {
                String title = 'ğŸ“¢ Slack ì±„ë„ ìƒì„± ì™„ë£Œ';
                String body = 'Order ' + ord.OrderNumber + ' Salesforce ì—°ë™ ì±„ë„ ìƒì„± (#' + 
                             ord.Slack_Channel_Name__c + ')';
                
                sendSalesNotification(title, body, ord.Id, 'Slack_Channel_Created');
            }
            
            System.debug('âœ… Slack ì±„ë„ ìƒì„± ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ');
            
        } catch (Exception e) {
            System.debug('âŒ Slack ì±„ë„ ìƒì„± ì•Œë¦¼ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * PaymentStatusê°€ ì—°ì²´ë¡œ ë³€ê²½ëœ í•­ëª© í•„í„°ë§
     */
    public static List<PaymentStatus__c> getOverduePayments(List<PaymentStatus__c> newPayments, List<PaymentStatus__c> oldPayments) {
        List<PaymentStatus__c> overduePayments = new List<PaymentStatus__c>();
        Map<Id, PaymentStatus__c> oldPaymentMap = new Map<Id, PaymentStatus__c>();
        
        if (oldPayments != null) {
            for (PaymentStatus__c oldPayment : oldPayments) {
                oldPaymentMap.put(oldPayment.Id, oldPayment);
            }
        }
        
        for (PaymentStatus__c newPayment : newPayments) {
            PaymentStatus__c oldPayment = oldPaymentMap.get(newPayment.Id);
            
            // ìƒíƒœê°€ ë¯¸ë‚©ì—ì„œ ì—°ì²´ë¡œ ë³€ê²½ë˜ì—ˆê±°ë‚˜, ìƒˆë¡œ ì—°ì²´ê°€ ëœ ê²½ìš°
            if (newPayment.Status__c == 'ì—°ì²´' && 
                (oldPayment == null || oldPayment.Status__c != 'ì—°ì²´')) {
                overduePayments.add(newPayment);
            }
        }
        
        return overduePayments;
    }
    
    /**
     * ê³µí†µ Sales ì•± ì•Œë¦¼ ë°œì†¡ ë¡œì§ (AccountTriggerHandler íŒ¨í„´)
     */
    private static void sendSalesNotification(String title, String body, Id targetId, String notificationType) {
        try {
            System.debug('ğŸ“¡ sendSalesNotification ì‹œì‘: ' + title);
            
            // CustomNotificationType ì¡°íšŒ
            List<CustomNotificationType> salesNotificationTypes = [
                SELECT Id, DeveloperName
                FROM CustomNotificationType
                WHERE DeveloperName = 'Sales_Order_Notification'
                LIMIT 1
            ];
            
            if (salesNotificationTypes.isEmpty()) {
                System.debug('âŒ Sales_Order_Notification CustomNotificationTypeì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                System.debug('   Setupì—ì„œ ìƒì„±ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                
                // ì‚¬ìš© ê°€ëŠ¥í•œ ë‹¤ë¥¸ CustomNotificationType ì°¾ê¸°
                List<CustomNotificationType> alternativeTypes = [
                    SELECT Id, DeveloperName, MasterLabel
                    FROM CustomNotificationType
                    LIMIT 1
                ];
                
                if (!alternativeTypes.isEmpty()) {
                    System.debug('âš ï¸ ëŒ€ì•ˆìœ¼ë¡œ ' + alternativeTypes[0].MasterLabel + ' ì‚¬ìš© ì‹œë„');
                    CustomNotificationType altType = alternativeTypes[0];
                    
                    Set<String> recipients = getNotificationRecipients(targetId, notificationType);
                    if (!recipients.isEmpty()) {
                        Messaging.CustomNotification notification = new Messaging.CustomNotification();
                        notification.setTitle(title + ' (ì„ì‹œ)');
                        notification.setBody(body);
                        notification.setNotificationTypeId(altType.Id);
                        notification.setTargetId(targetId);
                        notification.send(recipients);
                        
                        System.debug('âœ… ëŒ€ì•ˆ ì•Œë¦¼ ë°œì†¡ ì„±ê³µ (ìˆ˜ì‹ ì: ' + recipients.size() + 'ëª…)');
                    }
                }
                return;
            }
            
            CustomNotificationType salesNotificationType = salesNotificationTypes[0];
            
            // ìˆ˜ì‹ ì ê²°ì • (AccountTriggerHandler íŒ¨í„´ ì°¸ì¡°)
            Set<String> recipients = getNotificationRecipients(targetId, notificationType);
            
            if (recipients.isEmpty()) {
                System.debug('âš ï¸ ì•Œë¦¼ ìˆ˜ì‹ ìê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            System.debug('ğŸ‘¥ ìˆ˜ì‹ ì ìˆ˜: ' + recipients.size() + 'ëª…');
            
            // Messaging.CustomNotification ìƒì„± ë° ë°œì†¡
            Messaging.CustomNotification notification = new Messaging.CustomNotification();
            notification.setTitle(title);
            notification.setBody(body);
            notification.setNotificationTypeId(salesNotificationType.Id);
            notification.setTargetId(targetId);
            notification.send(recipients);
            
            System.debug('âœ… Sales ì•± ì•Œë¦¼ ë°œì†¡: ' + title + ' (ìˆ˜ì‹ ì: ' + recipients.size() + 'ëª…)');
            
        } catch (Exception e) {
            System.debug('âŒ Sales ì•± ì•Œë¦¼ ë°œì†¡ ì˜¤ë¥˜: ' + e.getMessage());
            System.debug('âŒ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
            
            // ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨ ì‹œì—ë„ ë¡œê·¸ëŠ” ë‚¨ê¸°ë˜ ì „ì²´ í”„ë¡œì„¸ìŠ¤ëŠ” ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ
        }
    }
    
    /**
     * ì•Œë¦¼ ìˆ˜ì‹ ì ê²°ì • (AccountTriggerHandler íŒ¨í„´ ì°¸ì¡°)
     */
    private static Set<String> getNotificationRecipients(Id targetId, String notificationType) {
        Set<String> recipients = new Set<String>();
        
        try {
            // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ (AccountTriggerHandler íŒ¨í„´)
            User currentUser = [
                SELECT Id, ManagerId, Manager.Email
                FROM User
                WHERE Id = :UserInfo.getUserId()
                LIMIT 1
            ];
            
            // Order ì •ë³´ ì¡°íšŒ
            List<Order> orders = [
                SELECT Id, OwnerId, Owner.Email
                FROM Order 
                WHERE Id = :targetId
                LIMIT 1
            ];
            
            if (!orders.isEmpty()) {
                Order targetOrder = orders[0];
                
                // Order Owner ìƒì„¸ ì •ë³´ ì¡°íšŒ
                List<User> ownerUsers = [
                    SELECT Id, ManagerId
                    FROM User
                    WHERE Id = :targetOrder.OwnerId
                    LIMIT 1
                ];
                
                // 1. Order Owner
                recipients.add(targetOrder.OwnerId);
                
                // 2. Order Ownerì˜ Manager (ìˆëŠ” ê²½ìš°)
                if (!ownerUsers.isEmpty() && ownerUsers[0].ManagerId != null) {
                    recipients.add(ownerUsers[0].ManagerId);
                }
                
                // 3. í˜„ì¬ ì‚¬ìš©ìì˜ Manager (AccountTriggerHandler íŒ¨í„´)
                if (currentUser.ManagerId != null) {
                    recipients.add(currentUser.ManagerId);
                }
                
                // 4. í˜„ì¬ ì‚¬ìš©ì (ìƒì„±ì)
                recipients.add(UserInfo.getUserId());
            }
            
            // 5. ì•Œë¦¼ ìœ í˜•ë³„ ì¶”ê°€ ìˆ˜ì‹ ì
            switch on notificationType {
                when 'Payment_Overdue' {
                    // ì—°ì²´ ì•Œë¦¼ì˜ ê²½ìš° ì‹œìŠ¤í…œ ê´€ë¦¬ìë„ í¬í•¨
                    List<User> adminUsers = [
                        SELECT Id
                        FROM User 
                        WHERE Profile.Name IN ('ì‹œìŠ¤í…œ ê´€ë¦¬ì', 'System Administrator') 
                        AND IsActive = true
                        LIMIT 3
                    ];
                    
                    for (User admin : adminUsers) {
                        recipients.add(admin.Id);
                    }
                }
                when 'Slack_Channel_Created' {
                    // Slack ì±„ë„ ìƒì„± ì•Œë¦¼ì˜ ê²½ìš° íŒ€ì›ë“¤ë„ í¬í•¨ ê°€ëŠ¥
                    // í•„ìš”ì‹œ ì¶”ê°€ ë¡œì§ êµ¬í˜„
                }
            }
            
        } catch (Exception e) {
            System.debug('ì•Œë¦¼ ìˆ˜ì‹ ì ì¡°íšŒ ì˜¤ë¥˜: ' + e.getMessage());
        }
        
        return recipients;
    }
    
    /**
     * Orderì˜ ì—°ì²´ ìƒíƒœ í™•ì¸ ë° ì•Œë¦¼
     */
    public static void checkAndNotifyOverdueOrders(Set<Id> orderIds) {
        try {
            // ì—°ì²´ëœ PaymentStatus ì¡°íšŒ
            List<PaymentStatus__c> overduePayments = [
                SELECT Id, Order__c, Order__r.Account.Name, Order__r.OrderNumber,
                       InstallmentNumber__c, Amount__c, DueDate__c, Status__c
                FROM PaymentStatus__c 
                WHERE Order__c IN :orderIds
                AND Status__c = 'ì—°ì²´'
                AND DueDate__c < TODAY
            ];
            
            if (!overduePayments.isEmpty()) {
                notifyOverduePayments(overduePayments);
            }
            
        } catch (Exception e) {
            System.debug('âŒ ì—°ì²´ Order í™•ì¸ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * ì´ë©”ì¼ ì•Œë¦¼ë„ í•¨ê»˜ ë°œì†¡ (ì„ íƒì‚¬í•­)
     */
    public static void sendEmailNotificationForOrder(Order orderInfo, String notificationType) {
        try {
            // AccountTriggerHandlerì˜ ì´ë©”ì¼ ë°œì†¡ íŒ¨í„´ ì°¸ì¡°
            List<EmailTemplate> emailTemplates = [
                SELECT Id, DeveloperName, Subject, HtmlValue, Body
                FROM EmailTemplate
                WHERE DeveloperName = 'Order_Notification_Email_Alert'
                LIMIT 1
            ];
            
            if (emailTemplates.isEmpty()) {
                System.debug('âš ï¸ Order_Notification_Email_Alert í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            EmailTemplate emailTemplate = emailTemplates[0];
            
            User currentUser = [
                SELECT Id, Email, Name, ManagerId, Manager.Email
                FROM User
                WHERE Id = :UserInfo.getUserId()
                LIMIT 1
            ];
            
            List<Messaging.SingleEmailMessage> emails = new List<Messaging.SingleEmailMessage>();
            
            // Managerì—ê²Œ ì´ë©”ì¼ ë°œì†¡ (AccountTriggerHandler íŒ¨í„´)
            if (currentUser.Manager != null && String.isNotBlank(currentUser.Manager.Email)) {
                Messaging.SingleEmailMessage email = new Messaging.SingleEmailMessage();
                email.setToAddresses(new String[]{currentUser.Manager.Email});
                email.setTemplateId(emailTemplate.Id);
                email.setTargetObjectId(currentUser.ManagerId);
                email.setWhatId(orderInfo.Id);
                email.setSaveAsActivity(false);
                
                emails.add(email);
            }
            
            if (!emails.isEmpty()) {
                Messaging.sendEmail(emails);
                System.debug('âœ… Order ê´€ë ¨ ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ');
            }
            
        } catch (Exception e) {
            System.debug('âŒ Order ì´ë©”ì¼ ì•Œë¦¼ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
}
