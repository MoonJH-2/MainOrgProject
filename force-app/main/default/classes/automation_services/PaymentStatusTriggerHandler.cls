/**
 * @description PaymentStatus__c ê°ì²´ì˜ Trigger Handler
 * ì—°ì²´ ìƒíƒœ ë³€ê²½ ì‹œ Sales ì•± ì•Œë¦¼ ë°œì†¡
 * @author JH Moon
 * @last modified on 07-21-2025
 * @last modified by JH Moon
 */
public with sharing class PaymentStatusTriggerHandler {
    
    /**
     * After Update ì²˜ë¦¬
     * ì—°ì²´ ìƒíƒœë¡œ ë³€ê²½ëœ PaymentStatusì— ëŒ€í•´ ì•Œë¦¼ ë°œì†¡
     */
    public static void afterUpdate(List<PaymentStatus__c> newPayments, List<PaymentStatus__c> oldPayments) {
        try {
            System.debug('ğŸš¨ PaymentStatus afterUpdate ì‹œì‘: ' + newPayments.size() + 'ê°œ');
            
            // ì—°ì²´ë¡œ ë³€ê²½ëœ PaymentStatus í•„í„°ë§
            List<PaymentStatus__c> overduePayments = OrderNotificationService.getOverduePayments(newPayments, oldPayments);
            
            if (!overduePayments.isEmpty()) {
                System.debug('ğŸ“‹ ì—°ì²´ ìƒíƒœë¡œ ë³€ê²½ëœ PaymentStatus: ' + overduePayments.size() + 'ê°œ');
                
                // PaymentStatus ìƒì„¸ ì •ë³´ ì¡°íšŒ (ì•Œë¦¼ì„ ìœ„í•œ ì¶”ê°€ ì •ë³´)
                Set<Id> paymentIds = new Set<Id>();
                for (PaymentStatus__c payment : overduePayments) {
                    paymentIds.add(payment.Id);
                }
                
                List<PaymentStatus__c> overduePaymentsWithDetails = [
                    SELECT Id, Order__c, Order__r.Account.Name, Order__r.OrderNumber,
                           InstallmentNumber__c, Amount__c, DueDate__c, Status__c,
                           Order__r.Owner.Name, Order__r.Owner.Email
                    FROM PaymentStatus__c 
                    WHERE Id IN :paymentIds
                ];
                
                // Sales ì•± ì—°ì²´ ì•Œë¦¼ ë°œì†¡
                OrderNotificationService.notifyOverduePayments(overduePaymentsWithDetails);
                
                System.debug('âœ… PaymentStatus ì—°ì²´ ì•Œë¦¼ ì²˜ë¦¬ ì™„ë£Œ');
            } else {
                System.debug('â„¹ï¸ ì—°ì²´ë¡œ ë³€ê²½ëœ PaymentStatusê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
            
        } catch (Exception e) {
            System.debug('âŒ PaymentStatus afterUpdate ì˜¤ë¥˜: ' + e.getMessage());
            System.debug('âŒ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
        }
    }
    
    /**
     * After Insert ì²˜ë¦¬
     * ìƒˆë¡œ ìƒì„±ëœ PaymentStatusê°€ ì´ë¯¸ ì—°ì²´ì¸ ê²½ìš° ì•Œë¦¼ ë°œì†¡
     */
    public static void afterInsert(List<PaymentStatus__c> newPayments) {
        try {
            System.debug('ğŸ†• PaymentStatus afterInsert ì‹œì‘: ' + newPayments.size() + 'ê°œ');
            
            // ìƒˆë¡œ ìƒì„±ë˜ì—ˆì§€ë§Œ ì´ë¯¸ ì—°ì²´ì¸ PaymentStatus í•„í„°ë§
            List<PaymentStatus__c> overduePayments = new List<PaymentStatus__c>();
            
            for (PaymentStatus__c payment : newPayments) {
                if (payment.Status__c == 'ì—°ì²´' && payment.DueDate__c < Date.today()) {
                    overduePayments.add(payment);
                }
            }
            
            if (!overduePayments.isEmpty()) {
                System.debug('ğŸ“‹ ìƒˆë¡œ ìƒì„±ëœ ì—°ì²´ PaymentStatus: ' + overduePayments.size() + 'ê°œ');
                
                // PaymentStatus ìƒì„¸ ì •ë³´ ì¡°íšŒ
                Set<Id> paymentIds = new Set<Id>();
                for (PaymentStatus__c payment : overduePayments) {
                    paymentIds.add(payment.Id);
                }
                
                List<PaymentStatus__c> overduePaymentsWithDetails = [
                    SELECT Id, Order__c, Order__r.Account.Name, Order__r.OrderNumber,
                           InstallmentNumber__c, Amount__c, DueDate__c, Status__c,
                           Order__r.Owner.Name, Order__r.Owner.Email
                    FROM PaymentStatus__c 
                    WHERE Id IN :paymentIds
                ];
                
                // Sales ì•± ì—°ì²´ ì•Œë¦¼ ë°œì†¡
                OrderNotificationService.notifyOverduePayments(overduePaymentsWithDetails);
                
                System.debug('âœ… PaymentStatus ì‹ ê·œ ì—°ì²´ ì•Œë¦¼ ì²˜ë¦¬ ì™„ë£Œ');
            } else {
                System.debug('â„¹ï¸ ìƒˆë¡œ ìƒì„±ëœ ì—°ì²´ PaymentStatusê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
            
        } catch (Exception e) {
            System.debug('âŒ PaymentStatus afterInsert ì˜¤ë¥˜: ' + e.getMessage());
            System.debug('âŒ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ' + e.getStackTraceString());
        }
    }
    
    /**
     * ì—°ì²´ ìƒíƒœ ì²´í¬ ë° ëŒ€ëŸ‰ ì•Œë¦¼ ì²˜ë¦¬ (Batchì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
     */
    public static void processOverduePaymentsBatch(List<PaymentStatus__c> paymentsToCheck) {
        try {
            System.debug('ğŸ”„ PaymentStatus ë°°ì¹˜ ì—°ì²´ ì²˜ë¦¬ ì‹œì‘: ' + paymentsToCheck.size() + 'ê°œ');
            
            List<PaymentStatus__c> currentOverduePayments = new List<PaymentStatus__c>();
            
            for (PaymentStatus__c payment : paymentsToCheck) {
                // ì—°ì²´ ì¡°ê±´ í™•ì¸: ìƒíƒœê°€ 'ì—°ì²´'ì´ê³  ë§ˆê°ì¼ì´ ì§€ë‚¬ìŒ
                if (payment.Status__c == 'ì—°ì²´' && payment.DueDate__c < Date.today()) {
                    currentOverduePayments.add(payment);
                }
            }
            
            if (!currentOverduePayments.isEmpty()) {
                // Sales ì•± ì—°ì²´ ì•Œë¦¼ ë°œì†¡
                OrderNotificationService.notifyOverduePayments(currentOverduePayments);
                
                System.debug('âœ… ë°°ì¹˜ ì—°ì²´ ì•Œë¦¼ ì²˜ë¦¬ ì™„ë£Œ: ' + currentOverduePayments.size() + 'ê°œ');
            } else {
                System.debug('â„¹ï¸ ë°°ì¹˜ì—ì„œ ì²˜ë¦¬í•  ì—°ì²´ PaymentStatusê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
            
        } catch (Exception e) {
            System.debug('âŒ PaymentStatus ë°°ì¹˜ ì²˜ë¦¬ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * ì—°ì²´ ìƒíƒœ ìë™ ì—…ë°ì´íŠ¸ (ìŠ¤ì¼€ì¤„ëŸ¬ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
     */
    public static void updateOverdueStatus() {
        try {
            System.debug('ğŸ• PaymentStatus ì—°ì²´ ìƒíƒœ ìë™ ì—…ë°ì´íŠ¸ ì‹œì‘');
            
            // ë§ˆê°ì¼ì´ ì§€ë‚¬ì§€ë§Œ ì•„ì§ ì—°ì²´ ìƒíƒœê°€ ì•„ë‹Œ PaymentStatus ì¡°íšŒ
            List<PaymentStatus__c> paymentsToUpdate = [
                SELECT Id, Status__c, DueDate__c, Order__c,
                       Order__r.Account.Name, Order__r.OrderNumber,
                       InstallmentNumber__c, Amount__c
                FROM PaymentStatus__c 
                WHERE DueDate__c < TODAY
                AND Status__c != 'ì—°ì²´'
                AND Status__c != 'ì™„ë‚©'
                LIMIT 200
            ];
            
            if (!paymentsToUpdate.isEmpty()) {
                // ìƒíƒœë¥¼ ì—°ì²´ë¡œ ì—…ë°ì´íŠ¸
                for (PaymentStatus__c payment : paymentsToUpdate) {
                    payment.Status__c = 'ì—°ì²´';
                }
                
                update paymentsToUpdate;
                
                System.debug('âœ… ì—°ì²´ ìƒíƒœ ìë™ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ' + paymentsToUpdate.size() + 'ê°œ');
                
                // ì•Œë¦¼ ë°œì†¡
                OrderNotificationService.notifyOverduePayments(paymentsToUpdate);
                
            } else {
                System.debug('â„¹ï¸ ì—…ë°ì´íŠ¸í•  ì—°ì²´ PaymentStatusê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
            
        } catch (Exception e) {
            System.debug('âŒ ì—°ì²´ ìƒíƒœ ìë™ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
}
