/**
 * Slack ì±„ë„ì—ì„œ Salesforce ì±„ë„ë¡œ ì™„ì „ ì „í™˜ ì„œë¹„ìŠ¤
 * ëª©ì : ê¸°ì¡´ Slack ì±„ë„ì„ Salesforce ì±„ë„ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ê³  ë°ì´í„° ë™ê¸°í™”
 */
public class SlackToSalesforceChannelMigrationService {
    
    /**
     * ì „ì²´ ë§ˆì´ê·¸ë ˆì´ì…˜ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
     */
    public static void executeFullMigration() {
        System.debug('=== ğŸš€ Slack â†’ Salesforce ì±„ë„ ì™„ì „ ì „í™˜ ì‹œì‘ ===');
        
        try {
            // 1. Slack ì±„ë„ì´ ìˆëŠ” ëª¨ë“  Order ì¡°íšŒ
            List<Order> ordersWithSlack = getOrdersWithSlackChannels();
            System.debug('Slack ì±„ë„ì´ ìˆëŠ” Order ìˆ˜: ' + ordersWithSlack.size());
            
            // 2. ê° Orderì— ëŒ€í•´ Salesforce ì±„ë„ ìƒì„±
            Integer successCount = 0;
            Integer failCount = 0;
            
            for(Order order : ordersWithSlack) {
                try {
                    boolean migrationSuccess = migrateOrderToSalesforceChannel(order);
                    if(migrationSuccess) {
                        successCount++;
                        System.debug('âœ… Order ' + order.OrderNumber + ' ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µ');
                    } else {
                        failCount++;
                        System.debug('âŒ Order ' + order.OrderNumber + ' ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨');
                    }
                } catch(Exception e) {
                    failCount++;
                    System.debug('âŒ Order ' + order.OrderNumber + ' ì˜¤ë¥˜: ' + e.getMessage());
                }
            }
            
            // 3. ë§ˆì´ê·¸ë ˆì´ì…˜ ê²°ê³¼ ë³´ê³ 
            System.debug('=== ğŸ“Š ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ ê²°ê³¼ ===');
            System.debug('ì„±ê³µ: ' + successCount + 'ê±´');
            System.debug('ì‹¤íŒ¨: ' + failCount + 'ê±´');
            System.debug('ì´ ì²˜ë¦¬: ' + ordersWithSlack.size() + 'ê±´');
            
        } catch(Exception e) {
            System.debug('âŒ ì „ì²´ ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * Slack ì±„ë„ì´ ìˆëŠ” Orderë“¤ ì¡°íšŒ
     */
    private static List<Order> getOrdersWithSlackChannels() {
        return [
            SELECT Id, Name, OrderNumber, Status, AccountId,
                   Slack_Channel_ID__c, Slack_Channel_Name__c, 
                   Slack_Webhook_URL__c, Slack_Notification_Status__c
            FROM Order 
            WHERE Slack_Channel_ID__c != null 
               OR Slack_Channel_Name__c != null
               OR Slack_Notification_Status__c = 'Channel Created'
            ORDER BY CreatedDate DESC
        ];
    }
    
    /**
     * ê°œë³„ Orderì˜ Slack â†’ Salesforce ì±„ë„ ë§ˆì´ê·¸ë ˆì´ì…˜
     */
    private static Boolean migrateOrderToSalesforceChannel(Order order) {
        try {
            // 1. ê¸°ì¡´ Salesforce ì±„ë„ í™•ì¸
            List<CollaborationGroup> existingChannels = [
                SELECT Id, Name 
                FROM CollaborationGroup 
                WHERE Name LIKE :('%' + order.OrderNumber + '%')
                LIMIT 1
            ];
            
            String salesforceChannelId;
            
            if(existingChannels.isEmpty()) {
                // 2. ìƒˆ Salesforce ì±„ë„ ìƒì„± (SimpleSalesforceChannelService ì‚¬ìš©)
                salesforceChannelId = SimpleSalesforceChannelService.createOrderChannel(order.Id);
                
                if(salesforceChannelId == null) {
                    return false;
                }
                
                // 3. ê¸°ë³¸ ë©¤ë²„ ì¶”ê°€ (Order Owner, Account ê´€ë ¨ìë“¤)
                addDefaultMembersToChannel(salesforceChannelId, order);
                
                // 4. ë§ˆì´ê·¸ë ˆì´ì…˜ í™˜ì˜ ë©”ì‹œì§€
                postMigrationWelcomeMessage(salesforceChannelId, order);
                
            } else {
                salesforceChannelId = existingChannels[0].Id;
                System.debug('ê¸°ì¡´ Salesforce ì±„ë„ ì‚¬ìš©: ' + existingChannels[0].Name);
            }
            
            // 5. Order ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ (Salesforce ì±„ë„ ì •ë³´ ì¶”ê°€)
            updateOrderWithSalesforceChannel(order, salesforceChannelId);
            
            // 6. Slack ì±„ë„ ë¹„í™œì„±í™” ì²˜ë¦¬
            deactivateSlackChannel(order);
            
            // 7. ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ ì•Œë¦¼
            notifyMigrationCompletion(order, salesforceChannelId);
            
            return true;
            
        } catch(Exception e) {
            System.debug('ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜ (Order: ' + order.OrderNumber + '): ' + e.getMessage());
            return false;
        }
    }
    
    /**
     * ì±„ë„ì— ê¸°ë³¸ ë©¤ë²„ë“¤ ì¶”ê°€
     */
    private static void addDefaultMembersToChannel(String channelId, Order order) {
        try {
            // Order Owner ì¶”ê°€ (SimpleSalesforceChannelService ì‚¬ìš©)
            if(order.OwnerId != null) {
                SimpleSalesforceChannelService.addUserToChannel(channelId, order.OwnerId);
            }
            
            // Account Ownerë§Œ ì¶”ê°€ (ë‹¨ìˆœí™”)
            Set<Id> accountUserIds = new Set<Id>();
            
            // Account Owner ì¶”ê°€
            List<Account> accounts = [SELECT OwnerId FROM Account WHERE Id = :order.AccountId LIMIT 1];
            if(!accounts.isEmpty()) {
                accountUserIds.add(accounts[0].OwnerId);
            }
            
            List<User> accountUsers = [SELECT Id FROM User WHERE Id IN :accountUserIds LIMIT 10];
            
            for(User user : accountUsers) {
                SimpleSalesforceChannelService.addUserToChannel(channelId, user.Id);
            }
            
        } catch(Exception e) {
            System.debug('ë©¤ë²„ ì¶”ê°€ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * ë§ˆì´ê·¸ë ˆì´ì…˜ í™˜ì˜ ë©”ì‹œì§€ ê²Œì‹œ
     */
    private static void postMigrationWelcomeMessage(String channelId, Order order) {
        try {
            String message = 'ğŸ‰ Slack ì±„ë„ì—ì„œ Salesforce ì±„ë„ë¡œ ì„±ê³µì ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n';
            message += 'ğŸ“‹ Order: ' + order.OrderNumber + '\n';
            message += 'ğŸ“… ë§ˆì´ê·¸ë ˆì´ì…˜ ë‚ ì§œ: ' + System.now().format('yyyy-MM-dd HH:mm:ss') + '\n';
            message += 'âœ¨ ì´ì œ Salesforce ë‚´ì—ì„œ ëª¨ë“  í˜‘ì—…ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n';
            message += 'ğŸ’¡ ì£¼ìš” ê¸°ëŠ¥:\n';
            message += 'â€¢ ì‹¤ì‹œê°„ ì•Œë¦¼ ë° ë©˜ì…˜\n';
            message += 'â€¢ íŒŒì¼ ê³µìœ  ë° ë¬¸ì„œ í˜‘ì—…\n';
            message += 'â€¢ Order ì§„í–‰ ìƒí™© ìë™ ì—…ë°ì´íŠ¸\n';
            message += 'â€¢ ëª¨ë°”ì¼ ì•±ì—ì„œë„ ë™ì¼í•œ ê²½í—˜\n\n';
            message += '#ë§ˆì´ê·¸ë ˆì´ì…˜ì™„ë£Œ #SalesforceChannels';
            
            FeedItem welcomePost = new FeedItem(
                ParentId = channelId,
                Body = message,
                Type = 'TextPost'
            );
            insert welcomePost;
            
        } catch(Exception e) {
            System.debug('í™˜ì˜ ë©”ì‹œì§€ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * Order ë ˆì½”ë“œì— Salesforce ì±„ë„ ì •ë³´ ì—…ë°ì´íŠ¸
     */
    private static void updateOrderWithSalesforceChannel(Order order, String salesforceChannelId) {
        try {
            // ìƒˆë¡œìš´ Salesforce ì±„ë„ í•„ë“œë“¤ (ë¯¸ë˜ì— ì¶”ê°€ë  ì˜ˆì •)
            Order updateOrder = new Order(Id = order.Id);
            
            // ê¸°ì¡´ Slack ê´€ë ¨ í•„ë“œë“¤ì„ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœë¡œ ë³€ê²½
            updateOrder.Slack_Notification_Status__c = 'Migrated to Salesforce';
            
            // ë§ˆì´ê·¸ë ˆì´ì…˜ ë‚ ì§œ ê¸°ë¡ (Description í•„ë“œ í™œìš©)
            String migrationNote = 'ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ: ' + System.now().format('yyyy-MM-dd HH:mm:ss') + 
                                 ' | Salesforce Channel ID: ' + salesforceChannelId;
            updateOrder.Description = (order.Description != null ? order.Description + '\n' : '') + migrationNote;
            
            update updateOrder;
            
        } catch(Exception e) {
            System.debug('Order ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * Slack ì±„ë„ ë¹„í™œì„±í™” ì²˜ë¦¬
     */
    private static void deactivateSlackChannel(Order order) {
        try {
            // Slack ì±„ë„ ìƒíƒœë¥¼ 'ë¹„í™œì„±í™”'ë¡œ ë³€ê²½
            Order updateOrder = new Order(Id = order.Id);
            updateOrder.Slack_Notification_Status__c = 'Deactivated - Migrated';
            
            // Slack Webhookì„ ë¹„í™œì„±í™” (URL ì•ì— DISABLED_ ì ‘ë‘ì‚¬ ì¶”ê°€)
            if(order.Slack_Webhook_URL__c != null && !order.Slack_Webhook_URL__c.startsWith('DISABLED_')) {
                updateOrder.Slack_Webhook_URL__c = 'DISABLED_' + order.Slack_Webhook_URL__c;
            }
            
            update updateOrder;
            
            System.debug('Slack ì±„ë„ ë¹„í™œì„±í™” ì™„ë£Œ: ' + order.OrderNumber);
            
        } catch(Exception e) {
            System.debug('Slack ë¹„í™œì„±í™” ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ ì•Œë¦¼
     */
    private static void notifyMigrationCompletion(Order order, String salesforceChannelId) {
        try {
            // ì‹œìŠ¤í…œ ê´€ë¦¬ìì—ê²Œ Chatter ì•Œë¦¼
            String adminMessage = order.OrderNumber + 'ì˜ ì±„ë„ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ' +
                                'Salesforce Channel ID: ' + salesforceChannelId;
            
            // í˜„ì¬ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ (ì‹¤ì œë¡œëŠ” ì‹œìŠ¤í…œ ê´€ë¦¬ì ID ì‚¬ìš©)
            FeedItem notification = new FeedItem(
                ParentId = UserInfo.getUserId(),
                Body = adminMessage,
                Type = 'TextPost'
            );
            insert notification;
            
        } catch(Exception e) {
            System.debug('ì™„ë£Œ ì•Œë¦¼ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
    
    /**
     * íŠ¹ì • Orderì˜ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸
     */
    public static void checkMigrationStatus(String orderNumber) {
        try {
            List<Order> orders = [
                SELECT Id, OrderNumber, Slack_Channel_ID__c, Slack_Notification_Status__c, Description
                FROM Order 
                WHERE OrderNumber = :orderNumber
                LIMIT 1
            ];
            
            if(orders.isEmpty()) {
                System.debug('âŒ Orderë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + orderNumber);
                return;
            }
            
            Order order = orders[0];
            
            // Salesforce ì±„ë„ í™•ì¸
            List<CollaborationGroup> salesforceChannels = [
                SELECT Id, Name, MemberCount
                FROM CollaborationGroup 
                WHERE Name LIKE :('%' + orderNumber + '%')
            ];
            
            System.debug('=== ğŸ“Š ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ: ' + orderNumber + ' ===');
            System.debug('Slack ìƒíƒœ: ' + order.Slack_Notification_Status__c);
            System.debug('Slack Channel ID: ' + order.Slack_Channel_ID__c);
            System.debug('Salesforce ì±„ë„ ìˆ˜: ' + salesforceChannels.size());
            
            if(!salesforceChannels.isEmpty()) {
                for(CollaborationGroup channel : salesforceChannels) {
                    System.debug('âœ… Salesforce ì±„ë„: ' + channel.Name + ' (ë©¤ë²„: ' + channel.MemberCount + ')');
                }
            }
            
            // ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ íŒë‹¨
            if(order.Slack_Notification_Status__c?.contains('Migrated') && !salesforceChannels.isEmpty()) {
                System.debug('ğŸ‰ ì™„ì „ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!');
            } else if(!salesforceChannels.isEmpty()) {
                System.debug('âš ï¸ ë¶€ë¶„ ë§ˆì´ê·¸ë ˆì´ì…˜ (Salesforce ì±„ë„ ì¡´ì¬, Slack ìƒíƒœ ë¯¸ë³€ê²½)');
            } else {
                System.debug('âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš” (Salesforce ì±„ë„ ì—†ìŒ)');
            }
            
        } catch(Exception e) {
            System.debug('âŒ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜: ' + e.getMessage());
        }
    }
}
