/**
 * @description ì™„ì „ ë…ë¦½ì ì¸ Salesforce ì±„ë„ ì„œë¹„ìŠ¤ (ë°°í¬ ì˜¤ë¥˜ ì—†ìŒ)
 * @author JH Moon
 * @created 2025-07-22
 */
public with sharing class SimpleSalesforceChannelService {
    
    /**
     * Order IDë¡œ ì±„ë„ ìƒì„±
     */
    public static String createOrderChannel(String orderId) {
        try {
            Order orderInfo = [SELECT Id, Name, OrderNumber, OwnerId, AccountId 
                              FROM Order WHERE Id = :orderId LIMIT 1];
            
            System.debug('ğŸ“¢ Order Channel ìƒì„± ì‹œì‘: ' + orderInfo.OrderNumber);
            
            // ê¸°ì¡´ ì±„ë„ í™•ì¸
            List<CollaborationGroup> existingGroups = [
                SELECT Id, Name FROM CollaborationGroup 
                WHERE Name = :('Order-' + orderInfo.OrderNumber) LIMIT 1
            ];
            
            if(!existingGroups.isEmpty()) {
                System.debug('âœ… ê¸°ì¡´ ì±„ë„ ì‚¬ìš©: ' + existingGroups[0].Id);
                return existingGroups[0].Id;
            }
            
            // ìƒˆ Chatter Group ìƒì„±
            CollaborationGroup channelGroup = new CollaborationGroup();
            channelGroup.Name = 'Order-' + orderInfo.OrderNumber;
            channelGroup.Description = 'Order ' + orderInfo.OrderNumber + ' ì „ìš© í˜‘ì—… ì±„ë„\n' +
                                     'ìƒì„±ì¼: ' + System.now().format('yyyy-MM-dd HH:mm') + '\n' +
                                     'Account: ' + orderInfo.AccountId;
            channelGroup.CollaborationType = 'Private';
            channelGroup.IsArchived = false;
            channelGroup.CanHaveGuests = false;
            
            insert channelGroup;
            
            System.debug('âœ… Order Channel ìƒì„± ì™„ë£Œ: ' + channelGroup.Id);
            return channelGroup.Id;
            
        } catch (Exception e) {
            System.debug('âŒ Order Channel ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
            return null;
        }
    }
    
    /**
     * ì±„ë„ì— ì‚¬ìš©ì ì¶”ê°€
     */
    public static Boolean addUserToChannel(String channelId, String userId) {
        try {
            // ê¸°ì¡´ ë©¤ë²„ í™•ì¸
            List<CollaborationGroupMember> existingMembers = [
                SELECT Id FROM CollaborationGroupMember 
                WHERE CollaborationGroupId = :channelId AND MemberId = :userId
            ];
            
            if(!existingMembers.isEmpty()) {
                System.debug('ì´ë¯¸ ì±„ë„ ë©¤ë²„ì…ë‹ˆë‹¤: ' + userId);
                return true;
            }
            
            CollaborationGroupMember member = new CollaborationGroupMember();
            member.CollaborationGroupId = channelId;
            member.MemberId = userId;
            member.CollaborationRole = 'Standard';
            
            insert member;
            
            System.debug('âœ… ì±„ë„ ë©¤ë²„ ì¶”ê°€ ì™„ë£Œ: ' + userId);
            return true;
            
        } catch (Exception e) {
            System.debug('âŒ ë©¤ë²„ ì¶”ê°€ ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
    }
    
    /**
     * í™˜ì˜ ë©”ì‹œì§€ ê²Œì‹œ
     */
    public static Boolean postWelcomeMessage(String channelId, String orderId, String orderNumber) {
        try {
            String welcomeMessage = 'ğŸ‰ Order ' + orderNumber + ' ì±„ë„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!\n\n';
            welcomeMessage += 'ğŸ“‹ ì´ ì±„ë„ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ í™œë™ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:\n';
            welcomeMessage += 'â€¢ ğŸ“ Order ê´€ë ¨ ì‹¤ì‹œê°„ ì†Œí†µ\n';
            welcomeMessage += 'â€¢ ğŸ“„ ë¬¸ì„œ ë° íŒŒì¼ ê³µìœ \n';
            welcomeMessage += 'â€¢ ğŸ”” Payment ì•Œë¦¼ ë° ì—…ë°ì´íŠ¸\n';
            welcomeMessage += 'â€¢ ğŸ‘¥ íŒ€ì›ë“¤ê³¼ì˜ í˜‘ì—…\n\n';
            welcomeMessage += 'ğŸ’¡ @ë©˜ì…˜ì„ ì‚¬ìš©í•˜ì—¬ íŠ¹ì • ë©¤ë²„ì—ê²Œ ì•Œë¦¼ì„ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n';
            welcomeMessage += 'ğŸš€ Order URL: ' + System.URL.getOrgDomainUrl().toExternalForm() + 
                            '/lightning/r/Order/' + orderId + '/view\n\n';
            welcomeMessage += '#OrderChannel #íŒ€ì›Œí¬ #í˜‘ì—…';
            
            FeedItem welcomePost = new FeedItem();
            welcomePost.ParentId = channelId;
            welcomePost.Body = welcomeMessage;
            welcomePost.Type = 'TextPost';
            
            insert welcomePost;
            
            System.debug('âœ… í™˜ì˜ ë©”ì‹œì§€ ê²Œì‹œ ì™„ë£Œ');
            return true;
            
        } catch (Exception e) {
            System.debug('âŒ í™˜ì˜ ë©”ì‹œì§€ ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
    }
    
    /**
     * ì±„ë„ì— ì¼ë°˜ ë©”ì‹œì§€ ê²Œì‹œ
     */
    public static Boolean sendChannelMessage(String channelId, String message) {
        try {
            FeedItem messagePost = new FeedItem();
            messagePost.ParentId = channelId;
            messagePost.Body = message;
            messagePost.Type = 'TextPost';
            
            insert messagePost;
            
            System.debug('âœ… ì±„ë„ ë©”ì‹œì§€ ë°œì†¡ ì™„ë£Œ');
            return true;
            
        } catch (Exception e) {
            System.debug('âŒ ë©”ì‹œì§€ ë°œì†¡ ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
    }
    
    /**
     * Order Product ìë™í™” ì™„ë£Œ ì•Œë¦¼
     */
    public static Boolean notifyOrderProductAutomation(String channelId, String orderId, String status) {
        try {
            String automationMessage = 'ğŸ¤– Order Product ìë™í™” ì—…ë°ì´íŠ¸\n\n';
            automationMessage += 'ğŸ“‹ Order: ' + orderId + '\n';
            automationMessage += 'âš¡ ìƒíƒœ: ' + status + '\n';
            automationMessage += 'ğŸ•’ ì‹œê°„: ' + System.now().format('yyyy-MM-dd HH:mm:ss') + '\n\n';
            
            if(status == 'Completed') {
                automationMessage += 'âœ… ëª¨ë“  Order Productê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n';
                automationMessage += 'ğŸ“„ PDF ë¬¸ì„œê°€ ìƒì„±ë˜ì–´ ì´ë©”ì¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.\n';
            } else if(status == 'In Progress') {
                automationMessage += 'â³ Order Product ìƒì„±ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤...\n';
            } else if(status == 'Failed') {
                automationMessage += 'âŒ Order Product ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n';
                automationMessage += 'ğŸ”§ ì‹œìŠ¤í…œ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.\n';
            }
            
            automationMessage += '\n#OrderAutomation #ì‹œìŠ¤í…œì•Œë¦¼';
            
            return sendChannelMessage(channelId, automationMessage);
            
        } catch (Exception e) {
            System.debug('âŒ ìë™í™” ì•Œë¦¼ ì˜¤ë¥˜: ' + e.getMessage());
            return false;
        }
    }
}
